[{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\eslint.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\migrate-storage.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\postcss.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\push-to-supabase.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\run-migrations.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\App.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\NavLink.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\dashboard\\DashboardFilters.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\dashboard\\OnboardingWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\integrations\\PortalConnectDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\layout\\AnimatedOutlet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\layout\\AppLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\layout\\AppSidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\layout\\CRMLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\layout\\CRMSidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\layout\\MobileHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\layout\\MobileNav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\layout\\PageContent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\layout\\PageTransition.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\layout\\ScrollToTop.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\layout\\TopBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\lead-assignment\\AdvancedLogicTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\lead-assignment\\AgentLoadTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\lead-assignment\\AutoReassignTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\lead-assignment\\CampaignRulesTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\lead-assignment\\GlobalSettingsTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\lead-assignment\\LeadPoolsTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\lead-assignment\\NotificationsTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\lead-assignment\\RoundRobinTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\ActivityTimeline.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\AddLeadDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\ChangeStageDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\ContactsImportDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\DeleteLeadsDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\ExcelImportDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\ExportLeadsDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":67,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2384,2387],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2384,2387],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":111,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4456,4459],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4456,4459],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from \"react\";\r\nimport {\r\n    ResponsiveDialog,\r\n    ResponsiveDialogContent,\r\n    ResponsiveDialogHeader,\r\n    ResponsiveDialogTitle,\r\n    ResponsiveDialogFooter,\r\n    ResponsiveDialogBody,\r\n} from \"@/components/ui/responsive-dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { FileDown, ShieldCheck, Mail, Loader2, Info } from \"lucide-react\";\r\nimport { useStages } from \"@/contexts/StagesContext\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { toast } from \"sonner\";\r\nimport { Lead } from \"@/hooks/useLeads\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\ninterface ExportLeadsDialogProps {\r\n    open: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n    leads: Lead[];\r\n    availableAgents: { id: string; name: string }[];\r\n}\r\n\r\nexport function ExportLeadsDialog({\r\n    open,\r\n    onOpenChange,\r\n    leads,\r\n    availableAgents,\r\n}: ExportLeadsDialogProps) {\r\n    const { stages } = useStages();\r\n    const [isExporting, setIsExporting] = useState(false);\r\n\r\n    // Local Filter States\r\n    const [filterAgentId, setFilterAgentId] = useState<string>(\"all\");\r\n    const [filterStage, setFilterStage] = useState<string>(\"all\");\r\n    const [dateFrom, setDateFrom] = useState(\"\");\r\n    const [dateTo, setDateTo] = useState(\"\");\r\n    const [budgetMin, setBudgetMin] = useState(\"\");\r\n    const [budgetMax, setBudgetMax] = useState(\"\");\r\n    const [country, setCountry] = useState(\"\");\r\n\r\n    // Calculate preview count based on current local leads\r\n    const previewCount = useMemo(() => {\r\n        return leads.filter(lead => {\r\n            if (filterAgentId !== \"all\" && lead.assigned_agent_id !== filterAgentId) return false;\r\n            if (filterStage !== \"all\" && lead.stage !== filterStage) return false;\r\n\r\n            if (dateFrom) {\r\n                const leadDate = new Date(lead.created_at);\r\n                if (leadDate < new Date(dateFrom)) return false;\r\n            }\r\n            if (dateTo) {\r\n                const leadDate = new Date(lead.created_at);\r\n                if (leadDate > new Date(dateTo)) return false;\r\n            }\r\n\r\n            const parseBudget = (val: any) => {\r\n                if (!val) return null;\r\n                const num = parseFloat(val.toString().replace(/[^0-9.]/g, \"\"));\r\n                return isNaN(num) ? null : num;\r\n            };\r\n\r\n            const leadBudget = parseBudget(lead.budget);\r\n            if (budgetMin && leadBudget !== null && leadBudget < parseFloat(budgetMin)) return false;\r\n            if (budgetMax && leadBudget !== null && leadBudget > parseFloat(budgetMax)) return false;\r\n\r\n            if (country) {\r\n                const matchesLocation = lead.location?.toLowerCase().includes(country.toLowerCase());\r\n                const matchesNationality = lead.nationality?.toLowerCase().includes(country.toLowerCase());\r\n                if (!matchesLocation && !matchesNationality) return false;\r\n            }\r\n\r\n            return true;\r\n        }).length;\r\n    }, [leads, filterAgentId, filterStage, dateFrom, dateTo, budgetMin, budgetMax, country]);\r\n\r\n    const handleExport = async () => {\r\n        setIsExporting(true);\r\n        try {\r\n            const { data, error } = await supabase.functions.invoke(\"export-leads\", {\r\n                body: {\r\n                    filters: {\r\n                        agent_id: filterAgentId === 'all' ? undefined : filterAgentId,\r\n                        stage: filterStage === 'all' ? undefined : filterStage,\r\n                        date_from: dateFrom || undefined,\r\n                        date_to: dateTo || undefined,\r\n                        budget_min: budgetMin ? parseFloat(budgetMin) : undefined,\r\n                        budget_max: budgetMax ? parseFloat(budgetMax) : undefined,\r\n                        country: country || undefined,\r\n                    },\r\n                },\r\n            });\r\n\r\n            if (error) throw error;\r\n\r\n            toast.success(\"Export Initialized\", {\r\n                description: \"Your filtered lead export is being generated and will be sent to your companyâ€™s main email shortly.\",\r\n                duration: 8000,\r\n            });\r\n            onOpenChange(false);\r\n        } catch (error: any) {\r\n            console.error(\"Export error:\", error);\r\n            toast.error(\"Export Failed\", {\r\n                description: error.message || \"Failed to trigger lead export.\",\r\n            });\r\n        } finally {\r\n            setIsExporting(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <ResponsiveDialog open={open} onOpenChange={onOpenChange}>\r\n            <ResponsiveDialogContent className=\"sm:max-w-[420px] p-0 overflow-hidden\">\r\n                <ResponsiveDialogHeader className=\"px-4 py-3 border-b\">\r\n                    <ResponsiveDialogTitle className=\"flex items-center gap-2 text-base\">\r\n                        <FileDown className=\"h-4 w-4 text-primary\" />\r\n                        Secure Lead Export\r\n                    </ResponsiveDialogTitle>\r\n                </ResponsiveDialogHeader>\r\n\r\n                <ResponsiveDialogBody className=\"p-4 space-y-4 max-h-[70vh] overflow-y-auto\">\r\n                    <div className=\"bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-900/30 p-3 rounded-lg flex gap-2\">\r\n                        <ShieldCheck className=\"h-4 w-4 text-blue-600 dark:text-blue-400 shrink-0 mt-0.5\" />\r\n                        <div className=\"space-y-0.5\">\r\n                            <p className=\"text-xs font-semibold text-blue-900 dark:text-blue-100\">Compliance & Security Policy</p>\r\n                            <p className=\"text-[11px] text-blue-800/80 dark:text-blue-200/80 leading-snug\">\r\n                                Exports are sent exclusively to the company's verified main email address. Personal downloads are disabled to protect data integrity.\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-2 gap-3\">\r\n                        <div className=\"space-y-1.5\">\r\n                            <Label className=\"text-xs\">Assigned Agent</Label>\r\n                            <Select value={filterAgentId} onValueChange={setFilterAgentId}>\r\n                                <SelectTrigger className=\"h-8 text-xs\">\r\n                                    <SelectValue placeholder=\"All Agents\" />\r\n                                </SelectTrigger>\r\n                                <SelectContent className=\"bg-popover\">\r\n                                    <SelectItem value=\"all\">All Agents</SelectItem>\r\n                                    {availableAgents.map((agent) => (\r\n                                        <SelectItem key={agent.id} value={agent.id}>{agent.name}</SelectItem>\r\n                                    ))}\r\n                                </SelectContent>\r\n                            </Select>\r\n                        </div>\r\n                        <div className=\"space-y-1.5\">\r\n                            <Label className=\"text-xs\">Lead Stage</Label>\r\n                            <Select value={filterStage} onValueChange={setFilterStage}>\r\n                                <SelectTrigger className=\"h-8 text-xs\">\r\n                                    <SelectValue placeholder=\"All Stages\" />\r\n                                </SelectTrigger>\r\n                                <SelectContent className=\"bg-popover\">\r\n                                    <SelectItem value=\"all\">All Stages</SelectItem>\r\n                                    {stages.map((stage) => (\r\n                                        <SelectItem key={stage.id} value={stage.name}>{stage.name}</SelectItem>\r\n                                    ))}\r\n                                </SelectContent>\r\n                            </Select>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-1.5\">\r\n                            <Label className=\"text-xs\">Created From</Label>\r\n                            <Input\r\n                                type=\"date\"\r\n                                value={dateFrom}\r\n                                onChange={(e) => setDateFrom(e.target.value)}\r\n                                className=\"h-8 text-xs\"\r\n                            />\r\n                        </div>\r\n                        <div className=\"space-y-1.5\">\r\n                            <Label className=\"text-xs\">Created To</Label>\r\n                            <Input\r\n                                type=\"date\"\r\n                                value={dateTo}\r\n                                onChange={(e) => setDateTo(e.target.value)}\r\n                                className=\"h-8 text-xs\"\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"space-y-1.5\">\r\n                            <Label className=\"text-xs\">Min Budget</Label>\r\n                            <Input\r\n                                type=\"number\"\r\n                                placeholder=\"0\"\r\n                                value={budgetMin}\r\n                                onChange={(e) => setBudgetMin(e.target.value)}\r\n                                className=\"h-8 text-xs\"\r\n                            />\r\n                        </div>\r\n                        <div className=\"space-y-1.5\">\r\n                            <Label className=\"text-xs\">Max Budget</Label>\r\n                            <Input\r\n                                type=\"number\"\r\n                                placeholder=\"Any\"\r\n                                value={budgetMax}\r\n                                onChange={(e) => setBudgetMax(e.target.value)}\r\n                                className=\"h-8 text-xs\"\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"space-y-1.5 col-span-2\">\r\n                            <Label className=\"text-xs\">Country / Location</Label>\r\n                            <Input\r\n                                placeholder=\"e.g. UAE, Dubai\"\r\n                                value={country}\r\n                                onChange={(e) => setCountry(e.target.value)}\r\n                                className=\"h-8 text-xs\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"pt-2 border-t flex items-center justify-between gap-2\">\r\n                        <div className=\"flex items-center gap-1.5 text-xs text-muted-foreground\">\r\n                            <Info className=\"h-3.5 w-3.5\" />\r\n                            <span>Exporting {previewCount} leads...</span>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-muted text-[10px] font-medium border\">\r\n                            <Mail className=\"h-3 w-3\" />\r\n                            <span className=\"hidden sm:inline\">Recipient: Company Main Email</span>\r\n                            <span className=\"sm:hidden\">Company Email</span>\r\n                        </div>\r\n                    </div>\r\n                </ResponsiveDialogBody>\r\n\r\n                <ResponsiveDialogFooter className=\"p-3 border-t bg-muted/20 gap-2\">\r\n                    <Button\r\n                        variant=\"ghost\"\r\n                        onClick={() => onOpenChange(false)}\r\n                        disabled={isExporting}\r\n                        className=\"h-9 text-sm\"\r\n                    >\r\n                        Cancel\r\n                    </Button>\r\n                    <Button\r\n                        onClick={handleExport}\r\n                        disabled={isExporting || previewCount === 0}\r\n                        className=\"min-w-[120px] h-9 text-sm\"\r\n                    >\r\n                        {isExporting ? (\r\n                            <>\r\n                                <Loader2 className=\"h-3.5 w-3.5 mr-1.5 animate-spin\" />\r\n                                Processing...\r\n                            </>\r\n                        ) : (\r\n                            <>\r\n                                <FileDown className=\"h-3.5 w-3.5 mr-1.5\" />\r\n                                Confirm Export\r\n                            </>\r\n                        )}\r\n                    </Button>\r\n                </ResponsiveDialogFooter>\r\n            </ResponsiveDialogContent>\r\n        </ResponsiveDialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\GlobalAddLeadFAB.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\GroupManager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\InlineEditableLeadRow.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\LeadAssignedSelector.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\LeadDetailFAB.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\LeadGroupSelector.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\LeadsFilterDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\MobileLeadCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\NewLeadRow.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\ReassignLeadsDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\leads\\StageManager.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":424,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":424,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13693,13696],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13693,13696],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":485,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":485,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16260,16263],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16260,16263],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport {\r\n  DndContext,\r\n  closestCenter,\r\n  KeyboardSensor,\r\n  PointerSensor,\r\n  useSensor,\r\n  useSensors,\r\n  DragEndEvent,\r\n} from \"@dnd-kit/core\";\r\nimport {\r\n  arrayMove,\r\n  SortableContext,\r\n  sortableKeyboardCoordinates,\r\n  horizontalListSortingStrategy,\r\n  useSortable,\r\n} from \"@dnd-kit/sortable\";\r\nimport { CSS } from \"@dnd-kit/utilities\";\r\nimport {\r\n  Plus,\r\n  Settings,\r\n  GripVertical,\r\n  Pencil,\r\n  Trash2,\r\n  Copy,\r\n  X,\r\n} from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n} from \"@/components/ui/alert-dialog\";\r\nimport {\r\n  Tooltip,\r\n  TooltipContent,\r\n  TooltipProvider,\r\n  TooltipTrigger,\r\n} from \"@/components/ui/tooltip\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { toast } from \"sonner\";\r\n\r\nexport interface LeadStage {\r\n  id: string;\r\n  name: string;\r\n  color: string;\r\n  category?: \"initial\" | \"intermediate\" | \"final\";\r\n  leadCount?: number;\r\n}\r\n\r\nconst stageColors = [\r\n  { name: \"Blue\", value: \"#3B82F6\" },\r\n  { name: \"Purple\", value: \"#8B5CF6\" },\r\n  { name: \"Amber\", value: \"#F59E0B\" },\r\n  { name: \"Cyan\", value: \"#06B6D4\" },\r\n  { name: \"Green\", value: \"#10B981\" },\r\n  { name: \"Red\", value: \"#EF4444\" },\r\n  { name: \"Pink\", value: \"#EC4899\" },\r\n  { name: \"Indigo\", value: \"#6366F1\" },\r\n  { name: \"Teal\", value: \"#14B8A6\" },\r\n  { name: \"Orange\", value: \"#F97316\" },\r\n];\r\n\r\nconst categoryLabels = {\r\n  initial: \"Initial\",\r\n  intermediate: \"Intermediate\",\r\n  final: \"Final\",\r\n};\r\n\r\ninterface SortableStageItemProps {\r\n  stage: LeadStage;\r\n  onEdit: (stage: LeadStage) => void;\r\n  onDelete: (stage: LeadStage) => void;\r\n  onDuplicate: (stage: LeadStage) => void;\r\n  onStageClick?: (stageName: string) => void;\r\n  isAdmin: boolean;\r\n  isActive?: boolean;\r\n}\r\n\r\nfunction SortableStageItem({ stage, onEdit, onDelete, onDuplicate, onStageClick, isAdmin, isActive }: SortableStageItemProps) {\r\n  const {\r\n    attributes,\r\n    listeners,\r\n    setNodeRef,\r\n    transform,\r\n    transition,\r\n    isDragging,\r\n  } = useSortable({ id: stage.id, disabled: !isAdmin });\r\n\r\n  const style = {\r\n    transform: CSS.Transform.toString(transform),\r\n    transition,\r\n  };\r\n\r\n  const handleClick = (e: React.MouseEvent) => {\r\n    // Don't trigger filter if clicking on settings dropdown\r\n    if ((e.target as HTMLElement).closest('button[data-settings]')) return;\r\n    onStageClick?.(stage.name);\r\n  };\r\n\r\n  return (\r\n    <TooltipProvider>\r\n      <Tooltip>\r\n        <TooltipTrigger asChild>\r\n          <div\r\n            ref={setNodeRef}\r\n            style={style}\r\n            onClick={handleClick}\r\n            className={cn(\r\n              \"flex items-center gap-1.5 px-3 py-1.5 rounded-full border transition-all cursor-pointer hover:bg-muted/50\",\r\n              isDragging && \"opacity-50 shadow-lg z-50\",\r\n              isAdmin && \"active:cursor-grabbing\",\r\n              isActive && \"bg-primary/10 border-primary ring-1 ring-primary/30\"\r\n            )}\r\n          >\r\n            {isAdmin && (\r\n              <GripVertical\r\n                className=\"h-3 w-3 text-muted-foreground/50 flex-shrink-0\"\r\n                {...attributes}\r\n                {...listeners}\r\n              />\r\n            )}\r\n            <span\r\n              className=\"w-2.5 h-2.5 rounded-full flex-shrink-0\"\r\n              style={{ backgroundColor: stage.color }}\r\n            />\r\n            <span className=\"text-sm font-medium whitespace-nowrap\">{stage.name}</span>\r\n            <Badge variant=\"secondary\" className=\"h-5 min-w-[20px] text-xs px-1.5\">\r\n              {stage.leadCount}\r\n            </Badge>\r\n            {isAdmin && (\r\n              <DropdownMenu>\r\n                <DropdownMenuTrigger asChild>\r\n                  <Button\r\n                    variant=\"ghost\"\r\n                    size=\"icon\"\r\n                    className=\"h-5 w-5 ml-0.5 hover:bg-muted\"\r\n                    data-settings\r\n                    onClick={(e) => e.stopPropagation()}\r\n                  >\r\n                    <Settings className=\"h-3 w-3\" />\r\n                  </Button>\r\n                </DropdownMenuTrigger>\r\n                <DropdownMenuContent align=\"end\" className=\"bg-popover\">\r\n                  <DropdownMenuItem onClick={() => onEdit(stage)}>\r\n                    <Pencil className=\"h-3.5 w-3.5 mr-2\" />\r\n                    Edit Stage\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuItem onClick={() => onDuplicate(stage)}>\r\n                    <Copy className=\"h-3.5 w-3.5 mr-2\" />\r\n                    Duplicate\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuSeparator />\r\n                  <DropdownMenuItem\r\n                    className=\"text-destructive focus:text-destructive\"\r\n                    onClick={() => onDelete(stage)}\r\n                  >\r\n                    <Trash2 className=\"h-3.5 w-3.5 mr-2\" />\r\n                    Delete\r\n                  </DropdownMenuItem>\r\n                </DropdownMenuContent>\r\n              </DropdownMenu>\r\n            )}\r\n          </div>\r\n        </TooltipTrigger>\r\n        <TooltipContent>\r\n          <p>{stage.leadCount} leads in {stage.name}</p>\r\n          <p className=\"text-xs text-muted-foreground\">{categoryLabels[stage.category]} stage</p>\r\n        </TooltipContent>\r\n      </Tooltip>\r\n    </TooltipProvider>\r\n  );\r\n}\r\n\r\ninterface StageManagerProps {\r\n  stages: LeadStage[];\r\n  onStagesChange: (stages: LeadStage[]) => void;\r\n  onStageFilter?: (stageName: string) => void;\r\n  activeStage?: string;\r\n  isAdmin?: boolean;\r\n}\r\n\r\nexport function StageManager({ stages, onStagesChange, onStageFilter, activeStage, isAdmin = true }: StageManagerProps) {\r\n  const [isAddDialogOpen, setIsAddDialogOpen] = useState(false);\r\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\r\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\r\n  const [editingStage, setEditingStage] = useState<LeadStage | null>(null);\r\n  const [deletingStage, setDeletingStage] = useState<LeadStage | null>(null);\r\n  const [moveToStageId, setMoveToStageId] = useState<string>(\"\");\r\n\r\n  // Form state\r\n  const [stageName, setStageName] = useState(\"\");\r\n  const [stageColor, setStageColor] = useState(stageColors[0].value);\r\n  const [stageCategory, setStageCategory] = useState<\"initial\" | \"intermediate\" | \"final\">(\"intermediate\");\r\n\r\n  const sensors = useSensors(\r\n    useSensor(PointerSensor, { activationConstraint: { distance: 5 } }),\r\n    useSensor(KeyboardSensor, { coordinateGetter: sortableKeyboardCoordinates })\r\n  );\r\n\r\n  const handleDragEnd = (event: DragEndEvent) => {\r\n    const { active, over } = event;\r\n    if (over && active.id !== over.id) {\r\n      const oldIndex = stages.findIndex((s) => s.id === active.id);\r\n      const newIndex = stages.findIndex((s) => s.id === over.id);\r\n      const newStages = arrayMove(stages, oldIndex, newIndex);\r\n      onStagesChange(newStages);\r\n      toast.success(\"Stage order updated\");\r\n    }\r\n  };\r\n\r\n  const MAX_STAGES = 12;\r\n\r\n  const openAddDialog = () => {\r\n    if (stages.length >= MAX_STAGES) {\r\n      toast.error(`Maximum ${MAX_STAGES} stages allowed`);\r\n      return;\r\n    }\r\n    setStageName(\"\");\r\n    setStageColor(stageColors[0].value);\r\n    setStageCategory(\"intermediate\");\r\n    setIsAddDialogOpen(true);\r\n  };\r\n\r\n  const openEditDialog = (stage: LeadStage) => {\r\n    setEditingStage(stage);\r\n    setStageName(stage.name);\r\n    setStageColor(stage.color);\r\n    setStageCategory(stage.category);\r\n    setIsEditDialogOpen(true);\r\n  };\r\n\r\n  const openDeleteDialog = (stage: LeadStage) => {\r\n    setDeletingStage(stage);\r\n    setMoveToStageId(stages.find((s) => s.id !== stage.id)?.id || \"\");\r\n    setIsDeleteDialogOpen(true);\r\n  };\r\n\r\n  const handleDuplicate = (stage: LeadStage) => {\r\n    if (stages.length >= MAX_STAGES) {\r\n      toast.error(`Maximum ${MAX_STAGES} stages allowed`);\r\n      return;\r\n    }\r\n    const newStage: LeadStage = {\r\n      id: `stage-${Date.now()}`,\r\n      name: `${stage.name} (Copy)`,\r\n      color: stage.color,\r\n      category: stage.category,\r\n      leadCount: 0,\r\n    };\r\n    onStagesChange([...stages, newStage]);\r\n    toast.success(`Stage \"${stage.name}\" duplicated`);\r\n  };\r\n\r\n  const handleAddStage = () => {\r\n    if (!stageName.trim()) {\r\n      toast.error(\"Stage name is required\");\r\n      return;\r\n    }\r\n    const newStage: LeadStage = {\r\n      id: `stage-${Date.now()}`,\r\n      name: stageName.trim(),\r\n      color: stageColor,\r\n      category: stageCategory,\r\n      leadCount: 0,\r\n    };\r\n    onStagesChange([...stages, newStage]);\r\n    setIsAddDialogOpen(false);\r\n    toast.success(`Stage \"${stageName}\" created`);\r\n  };\r\n\r\n  const handleEditStage = () => {\r\n    if (!editingStage || !stageName.trim()) {\r\n      toast.error(\"Stage name is required\");\r\n      return;\r\n    }\r\n    const updatedStages = stages.map((s) =>\r\n      s.id === editingStage.id\r\n        ? { ...s, name: stageName.trim(), color: stageColor, category: stageCategory }\r\n        : s\r\n    );\r\n    onStagesChange(updatedStages);\r\n    setIsEditDialogOpen(false);\r\n    setEditingStage(null);\r\n    toast.success(`Stage \"${stageName}\" updated`);\r\n  };\r\n\r\n  const handleDeleteStage = () => {\r\n    if (!deletingStage) return;\r\n    \r\n    if (deletingStage.leadCount > 0 && !moveToStageId) {\r\n      toast.error(\"Please select a stage to move leads to\");\r\n      return;\r\n    }\r\n\r\n    // In a real app, this would move leads to the selected stage\r\n    const updatedStages = stages.filter((s) => s.id !== deletingStage.id);\r\n    \r\n    if (deletingStage.leadCount > 0 && moveToStageId) {\r\n      // Update lead counts\r\n      const targetIndex = updatedStages.findIndex((s) => s.id === moveToStageId);\r\n      if (targetIndex !== -1) {\r\n        updatedStages[targetIndex] = {\r\n          ...updatedStages[targetIndex],\r\n          leadCount: updatedStages[targetIndex].leadCount + deletingStage.leadCount,\r\n        };\r\n      }\r\n    }\r\n\r\n    onStagesChange(updatedStages);\r\n    setIsDeleteDialogOpen(false);\r\n    setDeletingStage(null);\r\n    toast.success(`Stage \"${deletingStage.name}\" deleted`);\r\n  };\r\n\r\n  return (\r\n    <div className=\"flex items-center gap-2 overflow-x-auto pb-2\">\r\n      <DndContext\r\n        sensors={sensors}\r\n        collisionDetection={closestCenter}\r\n        onDragEnd={handleDragEnd}\r\n      >\r\n        <SortableContext items={stages.map((s) => s.id)} strategy={horizontalListSortingStrategy}>\r\n          <div className=\"flex items-center gap-2\">\r\n            {stages.map((stage) => (\r\n              <SortableStageItem\r\n                key={stage.id}\r\n                stage={stage}\r\n                onEdit={openEditDialog}\r\n                onDelete={openDeleteDialog}\r\n                onDuplicate={handleDuplicate}\r\n                onStageClick={onStageFilter}\r\n                isAdmin={isAdmin}\r\n                isActive={activeStage === stage.name}\r\n              />\r\n            ))}\r\n          </div>\r\n        </SortableContext>\r\n      </DndContext>\r\n\r\n      {isAdmin && (\r\n        <Button\r\n          variant=\"outline\"\r\n          size=\"sm\"\r\n          className=\"gap-1.5 whitespace-nowrap\"\r\n          onClick={openAddDialog}\r\n        >\r\n          <Plus className=\"h-4 w-4\" />\r\n          Add Stage\r\n        </Button>\r\n      )}\r\n\r\n      {/* Add Stage Dialog */}\r\n      <Dialog open={isAddDialogOpen} onOpenChange={setIsAddDialogOpen}>\r\n        <DialogContent className=\"sm:max-w-md\">\r\n          <DialogHeader>\r\n            <DialogTitle>Add New Stage</DialogTitle>\r\n            <DialogDescription>\r\n              Create a new lead stage for your pipeline\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <div className=\"space-y-4 py-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"stage-name\">Stage Name</Label>\r\n              <Input\r\n                id=\"stage-name\"\r\n                placeholder=\"e.g., Qualified, Proposal Sent\"\r\n                value={stageName}\r\n                onChange={(e) => setStageName(e.target.value)}\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Stage Color</Label>\r\n              <div className=\"flex flex-wrap gap-2\">\r\n                {stageColors.map((color) => (\r\n                  <button\r\n                    key={color.value}\r\n                    type=\"button\"\r\n                    className={cn(\r\n                      \"w-8 h-8 rounded-full border-2 transition-all\",\r\n                      stageColor === color.value\r\n                        ? \"border-foreground scale-110\"\r\n                        : \"border-transparent hover:scale-105\"\r\n                    )}\r\n                    style={{ backgroundColor: color.value }}\r\n                    onClick={() => setStageColor(color.value)}\r\n                    title={color.name}\r\n                  />\r\n                ))}\r\n              </div>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Stage Category</Label>\r\n              <Select value={stageCategory} onValueChange={(v: any) => setStageCategory(v)}>\r\n                <SelectTrigger>\r\n                  <SelectValue />\r\n                </SelectTrigger>\r\n                <SelectContent className=\"bg-popover\">\r\n                  <SelectItem value=\"initial\">Initial (Entry stages)</SelectItem>\r\n                  <SelectItem value=\"intermediate\">Intermediate (In progress)</SelectItem>\r\n                  <SelectItem value=\"final\">Final (Closed/Lost)</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n          </div>\r\n          <DialogFooter>\r\n            <Button variant=\"outline\" onClick={() => setIsAddDialogOpen(false)}>\r\n              Cancel\r\n            </Button>\r\n            <Button onClick={handleAddStage}>Create Stage</Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Edit Stage Dialog */}\r\n      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\r\n        <DialogContent className=\"sm:max-w-md\">\r\n          <DialogHeader>\r\n            <DialogTitle>Edit Stage</DialogTitle>\r\n            <DialogDescription>\r\n              Modify stage settings. Changes will apply to all leads.\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <div className=\"space-y-4 py-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"edit-stage-name\">Stage Name</Label>\r\n              <Input\r\n                id=\"edit-stage-name\"\r\n                value={stageName}\r\n                onChange={(e) => setStageName(e.target.value)}\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Stage Color</Label>\r\n              <div className=\"flex flex-wrap gap-2\">\r\n                {stageColors.map((color) => (\r\n                  <button\r\n                    key={color.value}\r\n                    type=\"button\"\r\n                    className={cn(\r\n                      \"w-8 h-8 rounded-full border-2 transition-all\",\r\n                      stageColor === color.value\r\n                        ? \"border-foreground scale-110\"\r\n                        : \"border-transparent hover:scale-105\"\r\n                    )}\r\n                    style={{ backgroundColor: color.value }}\r\n                    onClick={() => setStageColor(color.value)}\r\n                    title={color.name}\r\n                  />\r\n                ))}\r\n              </div>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Stage Category</Label>\r\n              <Select value={stageCategory} onValueChange={(v: any) => setStageCategory(v)}>\r\n                <SelectTrigger>\r\n                  <SelectValue />\r\n                </SelectTrigger>\r\n                <SelectContent className=\"bg-popover\">\r\n                  <SelectItem value=\"initial\">Initial (Entry stages)</SelectItem>\r\n                  <SelectItem value=\"intermediate\">Intermediate (In progress)</SelectItem>\r\n                  <SelectItem value=\"final\">Final (Closed/Lost)</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n          </div>\r\n          <DialogFooter>\r\n            <Button variant=\"outline\" onClick={() => setIsEditDialogOpen(false)}>\r\n              Cancel\r\n            </Button>\r\n            <Button onClick={handleEditStage}>Save Changes</Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Delete Stage Dialog */}\r\n      <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>\r\n        <AlertDialogContent>\r\n          <AlertDialogHeader>\r\n            <AlertDialogTitle>Delete Stage \"{deletingStage?.name}\"?</AlertDialogTitle>\r\n            <AlertDialogDescription>\r\n              {deletingStage?.leadCount && deletingStage.leadCount > 0 ? (\r\n                <>\r\n                  This stage has <strong>{deletingStage.leadCount} leads</strong>. \r\n                  Please select a stage to move them to before deleting.\r\n                </>\r\n              ) : (\r\n                \"This action cannot be undone. The stage will be permanently removed.\"\r\n              )}\r\n            </AlertDialogDescription>\r\n          </AlertDialogHeader>\r\n          \r\n          {deletingStage?.leadCount && deletingStage.leadCount > 0 && (\r\n            <div className=\"py-4\">\r\n              <Label>Move leads to</Label>\r\n              <Select value={moveToStageId} onValueChange={setMoveToStageId}>\r\n                <SelectTrigger className=\"mt-2\">\r\n                  <SelectValue placeholder=\"Select a stage\" />\r\n                </SelectTrigger>\r\n                <SelectContent className=\"bg-popover\">\r\n                  {stages\r\n                    .filter((s) => s.id !== deletingStage?.id)\r\n                    .map((s) => (\r\n                      <SelectItem key={s.id} value={s.id}>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <span\r\n                            className=\"w-2.5 h-2.5 rounded-full\"\r\n                            style={{ backgroundColor: s.color }}\r\n                          />\r\n                          {s.name}\r\n                        </div>\r\n                      </SelectItem>\r\n                    ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n          )}\r\n\r\n          <AlertDialogFooter>\r\n            <AlertDialogCancel>Cancel</AlertDialogCancel>\r\n            <AlertDialogAction\r\n              onClick={handleDeleteStage}\r\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\r\n            >\r\n              Delete Stage\r\n            </AlertDialogAction>\r\n          </AlertDialogFooter>\r\n        </AlertDialogContent>\r\n      </AlertDialog>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\listings\\AddEditListingForm.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":927,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":927,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29671,29674],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29671,29674],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, forwardRef, useRef, useEffect } from \"react\";\r\nimport {\r\n  DndContext,\r\n  closestCenter,\r\n  KeyboardSensor,\r\n  PointerSensor,\r\n  useSensor,\r\n  useSensors,\r\n  DragEndEvent,\r\n} from \"@dnd-kit/core\";\r\nimport {\r\n  arrayMove,\r\n  SortableContext,\r\n  sortableKeyboardCoordinates,\r\n  useSortable,\r\n  rectSortingStrategy,\r\n} from \"@dnd-kit/sortable\";\r\nimport { CSS } from \"@dnd-kit/utilities\";\r\nimport {\r\n  X,\r\n  Upload,\r\n  Plus,\r\n  Trash2,\r\n  GripVertical,\r\n  Image as ImageIcon,\r\n  MapPin,\r\n  DollarSign,\r\n  Home,\r\n  Bed,\r\n  Bath,\r\n  Ruler,\r\n  FileText,\r\n  Globe,\r\n  Check,\r\n  Star,\r\n  Building2,\r\n  ChevronLeft,\r\n  ChevronRight,\r\n} from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Checkbox } from \"@/components/ui/checkbox\";\r\nimport { Switch } from \"@/components/ui/switch\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport {\r\n  ResponsiveDialog,\r\n  ResponsiveDialogContent,\r\n  ResponsiveDialogHeader,\r\n  ResponsiveDialogTitle,\r\n  ResponsiveDialogBody,\r\n  ResponsiveDialogFooter,\r\n} from \"@/components/ui/responsive-dialog\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport { useLocalization } from \"@/contexts/LocalizationContext\";\r\nimport { useAutoSave } from \"@/hooks/useAutoSave\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { toast } from \"sonner\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { useCompany } from \"@/hooks/useCompany\";\r\nimport { LocationSearchInput } from \"./LocationSearchInput\";\r\n\r\n// Sortable Image Item Component\r\ninterface SortableImageProps {\r\n  id: string;\r\n  image: string;\r\n  index: number;\r\n  isCover: boolean;\r\n  onSetCover: () => void;\r\n  onRemove: () => void;\r\n}\r\n\r\nconst SortableImageItem = forwardRef<HTMLDivElement, SortableImageProps>(\r\n  function SortableImageItem({ id, image, index, isCover, onSetCover, onRemove }, _ref) {\r\n    const {\r\n      attributes,\r\n      listeners,\r\n      setNodeRef,\r\n      transform,\r\n      transition,\r\n      isDragging,\r\n    } = useSortable({ id });\r\n\r\n    const style = {\r\n      transform: CSS.Transform.toString(transform),\r\n      transition,\r\n      zIndex: isDragging ? 50 : undefined,\r\n    };\r\n\r\n    return (\r\n      <div\r\n        ref={setNodeRef}\r\n        style={style}\r\n        className={cn(\r\n          \"relative group aspect-[4/3] rounded-lg overflow-hidden border-2 transition-all\",\r\n          isDragging ? \"opacity-50 scale-105 border-primary shadow-lg\" : \"border-transparent\",\r\n          isCover && \"ring-2 ring-primary ring-offset-2\"\r\n        )}\r\n      >\r\n        <img\r\n          src={image}\r\n          alt={`Property ${index + 1}`}\r\n          className=\"w-full h-full object-cover\"\r\n        />\r\n        {isCover && (\r\n          <Badge className=\"absolute top-2 left-2 bg-primary gap-1\">\r\n            <Star className=\"h-3 w-3\" />\r\n            Cover\r\n          </Badge>\r\n        )}\r\n        <div className=\"absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-2\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <Button\r\n              variant=\"secondary\"\r\n              size=\"icon\"\r\n              className=\"h-8 w-8 cursor-grab active:cursor-grabbing\"\r\n              {...attributes}\r\n              {...listeners}\r\n            >\r\n              <GripVertical className=\"h-4 w-4\" />\r\n            </Button>\r\n            {!isCover && (\r\n              <Button\r\n                variant=\"secondary\"\r\n                size=\"icon\"\r\n                className=\"h-8 w-8\"\r\n                onClick={(e) => {\r\n                  e.stopPropagation();\r\n                  onSetCover();\r\n                }}\r\n                title=\"Set as cover\"\r\n              >\r\n                <Star className=\"h-4 w-4\" />\r\n              </Button>\r\n            )}\r\n            <Button\r\n              variant=\"destructive\"\r\n              size=\"icon\"\r\n              className=\"h-8 w-8\"\r\n              onClick={(e) => {\r\n                e.stopPropagation();\r\n                onRemove();\r\n              }}\r\n            >\r\n              <Trash2 className=\"h-4 w-4\" />\r\n            </Button>\r\n          </div>\r\n          <span className=\"text-xs text-white/80\">Drag to reorder</span>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n);\r\n\r\ninterface ListingFormData {\r\n  title: string;\r\n  titleAr: string;\r\n  description: string;\r\n  descriptionAr: string;\r\n  price: string;\r\n  currency: string;\r\n  priceType: string;\r\n  location: string;\r\n  area: string;\r\n  city: string;\r\n  bedrooms: string;\r\n  bathrooms: string;\r\n  size: string;\r\n  sizeUnit: string;\r\n  propertyType: string;\r\n  listingType: string;\r\n  status: string;\r\n  furnishing: string;\r\n  completionStatus: string;\r\n  permitNumber: string;\r\n  refNumber: string;\r\n  amenities: string[];\r\n  features: string[];\r\n  images: string[];\r\n  portals: { name: string; enabled: boolean; autoPublish: boolean }[];\r\n  latitude: string;\r\n  longitude: string;\r\n  plotSize: string;\r\n  view: string;\r\n  occupancy: string;\r\n  serviceCharges: string;\r\n  cheques: string;\r\n  videoUrl: string;\r\n  tourUrl: string;\r\n  ownershipType: string;\r\n  developer: string;\r\n  projectName: string;\r\n  buildingName: string;\r\n  floorNumber: string;\r\n  parkingSpaces: string;\r\n}\r\n\r\nconst currencies = [\r\n  { value: \"AED\", label: \"AED\", symbol: \"Ø¯.Ø¥\" },\r\n  { value: \"USD\", label: \"USD\", symbol: \"$\" },\r\n  { value: \"QAR\", label: \"QAR\", symbol: \"Ø±.Ù‚\" },\r\n  { value: \"SAR\", label: \"SAR\", symbol: \"Ø±.Ø³\" },\r\n  { value: \"EUR\", label: \"EUR\", symbol: \"â‚¬\" },\r\n  { value: \"GBP\", label: \"GBP\", symbol: \"Â£\" },\r\n];\r\n\r\nconst sizeUnits = [\r\n  { value: \"sqft\", label: \"sq ft\" },\r\n  { value: \"sqm\", label: \"sq m\" },\r\n];\r\n\r\nconst listingStatuses = [\r\n  { value: \"active\", label: \"Active\" },\r\n  { value: \"pending\", label: \"Pending\" },\r\n  { value: \"sold\", label: \"Sold\" },\r\n  { value: \"rented\", label: \"Rented\" },\r\n  { value: \"reserved\", label: \"Reserved\" },\r\n  { value: \"off_market\", label: \"Off Market\" },\r\n  { value: \"draft\", label: \"Draft\" },\r\n];\r\n\r\nconst getDefaultFormData = (): ListingFormData => {\r\n  const savedCurrency = localStorage.getItem('listing_preferred_currency') || 'AED';\r\n  const savedSizeUnit = localStorage.getItem('listing_preferred_size_unit') || 'sqft';\r\n\r\n  return {\r\n    title: \"\",\r\n    titleAr: \"\",\r\n    description: \"\",\r\n    descriptionAr: \"\",\r\n    price: \"\",\r\n    currency: savedCurrency,\r\n    // Backend expects price_frequency: total|yearly|monthly|weekly|daily\r\n    // For sale listings we default to total; for rent we will derive it at save-time if needed.\r\n    priceType: \"total\",\r\n    location: \"\",\r\n    area: \"\",\r\n    city: \"Dubai\",\r\n    bedrooms: \"\",\r\n    bathrooms: \"\",\r\n    size: \"\",\r\n    sizeUnit: savedSizeUnit,\r\n    propertyType: \"apartment\",\r\n    listingType: \"sale\",\r\n    status: \"active\",\r\n    furnishing: \"unfurnished\",\r\n    completionStatus: \"ready\",\r\n    permitNumber: \"\",\r\n    refNumber: \"\",\r\n    amenities: [],\r\n    features: [],\r\n    images: [],\r\n    portals: [\r\n      { name: \"Property Finder\", enabled: false, autoPublish: false },\r\n      { name: \"Bayut\", enabled: false, autoPublish: false },\r\n      { name: \"Dubizzle\", enabled: false, autoPublish: false },\r\n      { name: \"Website\", enabled: true, autoPublish: true },\r\n    ],\r\n    latitude: \"\",\r\n    longitude: \"\",\r\n    plotSize: \"\",\r\n    view: \"\",\r\n    occupancy: \"\",\r\n    serviceCharges: \"\",\r\n    cheques: \"1\",\r\n    videoUrl: \"\",\r\n    tourUrl: \"\",\r\n    ownershipType: \"freehold\",\r\n    developer: \"\",\r\n    projectName: \"\",\r\n    buildingName: \"\",\r\n    floorNumber: \"\",\r\n    parkingSpaces: \"\",\r\n  };\r\n};\r\n\r\nconst amenitiesList = [\r\n  \"Swimming Pool\",\r\n  \"Gym\",\r\n  \"24/7 Security\",\r\n  \"Covered Parking\",\r\n  \"Children's Play Area\",\r\n  \"BBQ Area\",\r\n  \"Concierge Service\",\r\n  \"Beach Access\",\r\n  \"Spa\",\r\n  \"Tennis Court\",\r\n  \"Sauna\",\r\n  \"Jacuzzi\",\r\n  \"Garden\",\r\n  \"Balcony\",\r\n  \"Terrace\",\r\n  \"Rooftop Access\",\r\n];\r\n\r\nconst featuresList = [\r\n  \"Sea View\",\r\n  \"City View\",\r\n  \"Garden View\",\r\n  \"Pool View\",\r\n  \"Balcony\",\r\n  \"Built-in Wardrobes\",\r\n  \"Central A/C\",\r\n  \"Kitchen Appliances\",\r\n  \"Pets Allowed\",\r\n  \"Maid's Room\",\r\n  \"Driver's Room\",\r\n  \"Private Pool\",\r\n  \"Private Garden\",\r\n  \"Smart Home\",\r\n  \"Study Room\",\r\n  \"Storage Room\",\r\n];\r\n\r\nconst propertyTypes = [\r\n  { value: \"apartment\", label: \"Apartment\" },\r\n  { value: \"villa\", label: \"Villa\" },\r\n  { value: \"townhouse\", label: \"Townhouse\" },\r\n  { value: \"penthouse\", label: \"Penthouse\" },\r\n  { value: \"duplex\", label: \"Duplex\" },\r\n  { value: \"studio\", label: \"Studio\" },\r\n  { value: \"land\", label: \"Land\" },\r\n  { value: \"office\", label: \"Office\" },\r\n  { value: \"retail\", label: \"Retail\" },\r\n  { value: \"warehouse\", label: \"Warehouse\" },\r\n];\r\n\r\n// Cities list removed - now using searchable location input\r\n\r\ninterface AddEditListingFormProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  editData?: Partial<ListingFormData>;\r\n  mode?: \"add\" | \"edit\";\r\n  listingId?: string;\r\n  onSave?: (data: ListingFormData) => void;\r\n}\r\n\r\nexport function AddEditListingForm({\r\n  open,\r\n  onOpenChange,\r\n  editData,\r\n  mode = \"add\",\r\n  listingId,\r\n  onSave,\r\n}: AddEditListingFormProps) {\r\n  const { user } = useAuth();\r\n  const [formData, setFormData] = useState<ListingFormData>(() => ({\r\n    ...getDefaultFormData(),\r\n    ...editData,\r\n  }));\r\n  const [activeTab, setActiveTab] = useState(\"details\");\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n  const [errors, setErrors] = useState<Record<string, string>>({});\r\n  const [touched, setTouched] = useState<Record<string, boolean>>({});\r\n  const [draftId, setDraftId] = useState<string | null>(listingId || null);\r\n  const [autoSaveStatus, setAutoSaveStatus] = useState<'idle' | 'saving' | 'saved' | 'error'>('idle');\r\n\r\n  // Auto-save draft function\r\n  const saveDraft = async (data: ListingFormData) => {\r\n    // Only auto-save for new listings (mode === \"add\")\r\n    if (mode !== \"add\") return;\r\n\r\n    // Don't save if title is empty (minimum requirement for draft)\r\n    if (!data.title || data.title.trim().length === 0) return;\r\n\r\n    try {\r\n      const { data: agent } = await supabase\r\n        .from('agents')\r\n        .select('id, company_id')\r\n        .eq('user_id', user?.id)\r\n        .maybeSingle();\r\n\r\n      const draftData = {\r\n        title: data.title,\r\n        title_ar: data.titleAr || null,\r\n        description: data.description || null,\r\n        description_ar: data.descriptionAr || null,\r\n        price: data.price ? parseFloat(data.price) : null,\r\n        currency: data.currency,\r\n        rent_frequency: data.listingType === \"rent\" && data.priceType ? data.priceType : null,\r\n        address: data.location || null,\r\n        city: data.city || null,\r\n        country: \"UAE\",\r\n        number_of_bedrooms: data.bedrooms ? (data.bedrooms === \"Studio\" ? 0 : parseInt(data.bedrooms)) : null,\r\n        number_of_bathrooms: data.bathrooms ? parseInt(data.bathrooms) : null,\r\n        area_size: data.size ? parseFloat(data.size) : null,\r\n        area_unit: data.sizeUnit,\r\n        property_type: data.propertyType === \"land\" ? \"land\" : [\"warehouse\"].includes(data.propertyType) ? \"industrial\" : [\"office\", \"retail\"].includes(data.propertyType) ? \"commercial\" : \"residential\",\r\n        listing_type: data.listingType,\r\n        status: \"draft\", // Always save as draft\r\n        furnished: data.furnishing || null,\r\n        completion_status: data.completionStatus || null,\r\n        permit_number: data.permitNumber || null,\r\n        reference_number: data.refNumber || null,\r\n        amenities: data.amenities,\r\n        images: data.images,\r\n        tags: data.features || [],\r\n        company_id: agent?.company_id || null,\r\n        created_by: agent?.id || null,\r\n        assigned_agent_id: agent?.id || null,\r\n      };\r\n\r\n      if (draftId) {\r\n        // Update existing draft\r\n        const { error } = await supabase\r\n          .from('listings')\r\n          .update({\r\n            ...draftData,\r\n            updated_at: new Date().toISOString(),\r\n          })\r\n          .eq('id', draftId);\r\n\r\n        if (error) throw error;\r\n      } else {\r\n        // Create new draft\r\n        const { data: newDraft, error } = await supabase\r\n          .from('listings')\r\n          .insert(draftData)\r\n          .select('id')\r\n          .single();\r\n\r\n        if (error) throw error;\r\n        if (newDraft) {\r\n          setDraftId(newDraft.id);\r\n\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Error saving draft:', error);\r\n      throw error;\r\n    }\r\n  };\r\n\r\n  // Auto-save hook\r\n  const { isSaving: isAutoSaving, lastSaved } = useAutoSave(\r\n    formData,\r\n    saveDraft,\r\n    {\r\n      enabled: open && mode === \"add\", // Only enable for new listings\r\n      debounceMs: 3000, // Save after 3 seconds of inactivity\r\n      intervalMs: 30000, // Also save every 30 seconds\r\n      onSaveStart: () => {\r\n\r\n        setAutoSaveStatus('saving');\r\n      },\r\n      onSaveSuccess: () => {\r\n\r\n        setAutoSaveStatus('saved');\r\n        toast.success('Draft saved', {\r\n          description: 'Your listing has been auto-saved',\r\n          duration: 2000,\r\n        });\r\n        setTimeout(() => {\r\n\r\n          setAutoSaveStatus('idle');\r\n        }, 3000); // Show \"Saved as draft\" for 3 seconds\r\n      },\r\n      onSaveError: (error) => {\r\n        console.error('[AutoSave] Save failed:', error);\r\n        setAutoSaveStatus('error');\r\n      },\r\n    }\r\n  );\r\n\r\n  // Track previous open state to detect when dialog just opened\r\n  const prevOpenRef = useRef(open);\r\n\r\n  // Sync form data only when dialog opens\r\n  useEffect(() => {\r\n    const justOpened = open && !prevOpenRef.current;\r\n\r\n    if (justOpened) {\r\n      if (mode === \"edit\" && editData) {\r\n        setFormData({\r\n          ...getDefaultFormData(),\r\n          ...editData,\r\n          // Ensure arrays are handled correctly if partial data is provided\r\n          amenities: editData.amenities || [],\r\n          features: editData.features || [],\r\n          images: editData.images || [],\r\n          portals: editData.portals || getDefaultFormData().portals,\r\n          // Handle Studio (0) to \"Studio\" conversion\r\n          bedrooms: editData.bedrooms === \"0\" ? \"Studio\" : editData.bedrooms,\r\n        } as ListingFormData);\r\n      } else if (mode === \"add\") {\r\n        setFormData(getDefaultFormData());\r\n        setErrors({});\r\n        setTouched({});\r\n        setActiveTab(\"details\");\r\n        setDraftId(null); // Reset draft ID for new listings\r\n        setAutoSaveStatus('idle');\r\n      }\r\n    }\r\n\r\n    prevOpenRef.current = open;\r\n  }, [open, mode, editData]);\r\n\r\n  // Debug: Log autoSaveStatus changes\r\n  useEffect(() => {\r\n\r\n  }, [autoSaveStatus]);\r\n\r\n  // DnD sensors\r\n  const sensors = useSensors(\r\n    useSensor(PointerSensor, {\r\n      activationConstraint: {\r\n        distance: 8,\r\n      },\r\n    }),\r\n    useSensor(KeyboardSensor, {\r\n      coordinateGetter: sortableKeyboardCoordinates,\r\n    })\r\n  );\r\n\r\n  const validateField = (field: string, value: string): string => {\r\n    switch (field) {\r\n      case \"title\":\r\n        if (!value.trim()) return \"Property title is required\";\r\n        if (value.trim().length < 5) return \"Title must be at least 5 characters\";\r\n        if (value.trim().length > 150) return \"Title must be less than 150 characters\";\r\n        return \"\";\r\n      case \"price\":\r\n        if (!value.trim()) return \"Price is required\";\r\n        if (isNaN(Number(value)) || Number(value) <= 0) return \"Please enter a valid price\";\r\n        return \"\";\r\n      case \"location\":\r\n        if (!value.trim()) return \"Location is required\";\r\n        if (value.trim().length < 3) return \"Location must be at least 3 characters\";\r\n        return \"\";\r\n      case \"refNumber\":\r\n        if (!value.trim()) return \"Reference number is required\";\r\n        return \"\";\r\n      case \"status\":\r\n        if (!value) return \"Status is required\";\r\n        return \"\";\r\n      default:\r\n        return \"\";\r\n    }\r\n  };\r\n\r\n  const handleBlur = (field: string) => {\r\n    setTouched((prev) => ({ ...prev, [field]: true }));\r\n    const error = validateField(field, formData[field as keyof ListingFormData] as string);\r\n    setErrors((prev) => ({ ...prev, [field]: error }));\r\n  };\r\n\r\n  const updateField = <K extends keyof ListingFormData>(\r\n    field: K,\r\n    value: ListingFormData[K]\r\n  ) => {\r\n    setFormData((prev) => ({ ...prev, [field]: value }));\r\n    // Clear error when user starts typing\r\n    if (touched[field as string]) {\r\n      const error = validateField(field as string, value as string);\r\n      setErrors((prev) => ({ ...prev, [field]: error }));\r\n    }\r\n  };\r\n\r\n  const toggleAmenity = (amenity: string) => {\r\n    setFormData((prev) => ({\r\n      ...prev,\r\n      amenities: prev.amenities.includes(amenity)\r\n        ? prev.amenities.filter((a) => a !== amenity)\r\n        : [...prev.amenities, amenity],\r\n    }));\r\n  };\r\n\r\n  const toggleFeature = (feature: string) => {\r\n    setFormData((prev) => ({\r\n      ...prev,\r\n      features: prev.features.includes(feature)\r\n        ? prev.features.filter((f) => f !== feature)\r\n        : [...prev.features, feature],\r\n    }));\r\n  };\r\n\r\n  const togglePortal = (portalName: string, field: \"enabled\" | \"autoPublish\") => {\r\n    setFormData((prev) => ({\r\n      ...prev,\r\n      portals: prev.portals.map((p) =>\r\n        p.name === portalName ? { ...p, [field]: !p[field] } : p\r\n      ),\r\n    }));\r\n  };\r\n\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n  const [isUploading, setIsUploading] = useState(false);\r\n\r\n  const handleImageUpload = () => {\r\n    fileInputRef.current?.click();\r\n  };\r\n\r\n  const handleFileSelect = async (event: React.ChangeEvent<HTMLInputElement>) => {\r\n    const files = event.target.files;\r\n    if (!files || files.length === 0) return;\r\n\r\n    setIsUploading(true);\r\n    const uploadPromises: Promise<string | null>[] = [];\r\n\r\n    // Supported image formats\r\n    const supportedFormats = [\r\n      'image/jpeg',\r\n      'image/jpg',\r\n      'image/png',\r\n      'image/webp',\r\n      'image/heic',\r\n      'image/heif',\r\n      'image/gif',\r\n      'image/bmp',\r\n      'image/tiff'\r\n    ];\r\n\r\n    const supportedExtensions = ['jpg', 'jpeg', 'png', 'webp', 'heic', 'heif', 'gif', 'bmp', 'tiff', 'tif'];\r\n\r\n    for (let i = 0; i < files.length; i++) {\r\n      const file = files[i];\r\n      const fileExt = file.name.split('.').pop()?.toLowerCase() || '';\r\n\r\n      // Validate file type - check both MIME type and extension\r\n      const isSupportedMimeType = supportedFormats.includes(file.type.toLowerCase());\r\n      const isSupportedExtension = supportedExtensions.includes(fileExt);\r\n\r\n      if (!isSupportedMimeType && !isSupportedExtension) {\r\n        toast.error(`${file.name} is not a supported image format`);\r\n        console.warn(`Rejected file: ${file.name}, type: ${file.type}, extension: ${fileExt}`);\r\n        continue;\r\n      }\r\n\r\n      // Validate file size (50MB max for high-quality images)\r\n      const maxSize = 50 * 1024 * 1024; // 50MB\r\n      if (file.size > maxSize) {\r\n        toast.error(`${file.name} is too large (max 50MB)`);\r\n        console.warn(`File too large: ${file.name}, size: ${(file.size / 1024 / 1024).toFixed(2)}MB`);\r\n        continue;\r\n      }\r\n\r\n      const uploadPromise = (async () => {\r\n        try {\r\n          const fileName = `${Date.now()}-${Math.random().toString(36).substring(2)}.${fileExt}`;\r\n          const filePath = `listings/${fileName}`;\r\n\r\n\r\n\r\n          const { error: uploadError, data: uploadData } = await supabase.storage\r\n            .from('property-media')\r\n            .upload(filePath, file, {\r\n              cacheControl: '3600',\r\n              upsert: false\r\n            });\r\n\r\n          if (uploadError) {\r\n            console.error('Upload error for', file.name, ':', uploadError);\r\n            toast.error(`Failed to upload ${file.name}: ${uploadError.message}`);\r\n            return null;\r\n          }\r\n\r\n          const { data: { publicUrl } } = supabase.storage\r\n            .from('property-media')\r\n            .getPublicUrl(filePath);\r\n\r\n\r\n          return publicUrl;\r\n        } catch (err) {\r\n          console.error('Unexpected error uploading', file.name, ':', err);\r\n          toast.error(`Unexpected error uploading ${file.name}`);\r\n          return null;\r\n        }\r\n      })();\r\n\r\n      uploadPromises.push(uploadPromise);\r\n    }\r\n\r\n    try {\r\n      const results = await Promise.all(uploadPromises);\r\n      const successfulUploads = results.filter((url): url is string => url !== null);\r\n\r\n      if (successfulUploads.length > 0) {\r\n        setFormData((prev) => ({\r\n          ...prev,\r\n          images: [...prev.images, ...successfulUploads],\r\n        }));\r\n        toast.success(`${successfulUploads.length} image(s) uploaded successfully`);\r\n      } else if (files.length > 0) {\r\n        toast.error('No images were uploaded successfully');\r\n      }\r\n    } catch (error) {\r\n      console.error('Upload error:', error);\r\n      toast.error('Failed to upload images');\r\n    } finally {\r\n      setIsUploading(false);\r\n      // Reset file input\r\n      if (fileInputRef.current) {\r\n        fileInputRef.current.value = '';\r\n      }\r\n    }\r\n  };\r\n\r\n  const removeImage = (index: number) => {\r\n    setFormData((prev) => ({\r\n      ...prev,\r\n      images: prev.images.filter((_, i) => i !== index),\r\n    }));\r\n    toast.success(\"Image removed\");\r\n  };\r\n\r\n  const handleDragEnd = (event: DragEndEvent) => {\r\n    const { active, over } = event;\r\n\r\n    if (over && active.id !== over.id) {\r\n      setFormData((prev) => {\r\n        const oldIndex = prev.images.findIndex((img) => img === active.id);\r\n        const newIndex = prev.images.findIndex((img) => img === over.id);\r\n        const newImages = arrayMove(prev.images, oldIndex, newIndex);\r\n        return { ...prev, images: newImages };\r\n      });\r\n      toast.success(\"Image order updated\");\r\n    }\r\n  };\r\n\r\n  const setCoverImage = (index: number) => {\r\n    setFormData((prev) => {\r\n      const newImages = [...prev.images];\r\n      const [selected] = newImages.splice(index, 1);\r\n      newImages.unshift(selected);\r\n      return { ...prev, images: newImages };\r\n    });\r\n    toast.success(\"Cover image updated\");\r\n  };\r\n\r\n  const handleSubmit = async () => {\r\n    // Validate all required fields\r\n    const titleError = validateField(\"title\", formData.title);\r\n    const priceError = validateField(\"price\", formData.price);\r\n    const locationError = validateField(\"location\", formData.location);\r\n    const statusError = validateField(\"status\", formData.status);\r\n\r\n    const newErrors = {\r\n      title: titleError,\r\n      price: priceError,\r\n      location: locationError,\r\n      status: statusError,\r\n    };\r\n\r\n    setErrors(newErrors);\r\n    setTouched({ title: true, price: true, location: true, status: true });\r\n\r\n    const hasErrors = Object.values(newErrors).some((error) => error !== \"\");\r\n\r\n    if (hasErrors) {\r\n      // Switch to details tab if there are errors there\r\n      if (titleError || priceError || locationError || statusError) {\r\n        setActiveTab(\"details\");\r\n      }\r\n      toast.error(\"Please fix the errors before saving\");\r\n      return;\r\n    }\r\n\r\n    setIsSubmitting(true);\r\n\r\n    // Save preferences for future listings\r\n    localStorage.setItem('listing_preferred_currency', formData.currency);\r\n    localStorage.setItem('listing_preferred_size_unit', formData.sizeUnit);\r\n\r\n    try {\r\n      // Get user's agent record for company_id\r\n      const { data: agent } = await supabase\r\n        .from('agents')\r\n        .select('id, company_id')\r\n        .eq('user_id', user?.id)\r\n        .maybeSingle();\r\n\r\n      const statusToDb = (status: string) => {\r\n        if (status === \"available\") return \"active\";\r\n        if (status === \"off-market\") return \"off_market\";\r\n        return status;\r\n      };\r\n\r\n      const propertyTypeToDb = (type: string) => {\r\n        if (type === \"land\") return \"land\";\r\n        if ([\"warehouse\"].includes(type)) return \"industrial\";\r\n        if ([\"office\", \"retail\"].includes(type)) return \"commercial\";\r\n        // apartment / villa / townhouse / penthouse / duplex / studio\r\n        return \"residential\";\r\n      };\r\n\r\n      const priceFrequencyToDb = (): string | null => {\r\n        // rent_frequency is only valid for rental listings in the DB\r\n        if (formData.listingType === \"sale\") return null;\r\n        const allowed = new Set([\"yearly\", \"monthly\", \"weekly\", \"daily\"]);\r\n        return allowed.has(formData.priceType) ? formData.priceType : \"monthly\";\r\n      };\r\n\r\n      const baseListingData = {\r\n        title: formData.title,\r\n        title_ar: formData.titleAr || null,\r\n        description: formData.description || null,\r\n        description_ar: formData.descriptionAr || null,\r\n        price: formData.price ? parseFloat(formData.price) : null,\r\n        currency: formData.currency,\r\n        rent_frequency: priceFrequencyToDb(),\r\n        address: formData.location || null,\r\n        city: formData.city || null,\r\n        country: \"UAE\",\r\n        number_of_bedrooms: formData.bedrooms ? (formData.bedrooms === \"Studio\" ? 0 : parseInt(formData.bedrooms)) : null,\r\n        number_of_bathrooms: formData.bathrooms ? parseInt(formData.bathrooms) : null,\r\n        area_size: formData.size ? parseFloat(formData.size) : null,\r\n        area_unit: formData.sizeUnit,\r\n        property_type: propertyTypeToDb(formData.propertyType),\r\n        listing_type: formData.listingType,\r\n        status: statusToDb(formData.status),\r\n        furnished: formData.furnishing || null,\r\n        completion_status: formData.completionStatus || null,\r\n        permit_number: formData.permitNumber || null,\r\n        reference_number: formData.refNumber || null,\r\n        amenities: formData.amenities,\r\n        images: formData.images,\r\n        tags: formData.features || [],\r\n        latitude: formData.latitude ? parseFloat(formData.latitude) : null,\r\n        longitude: formData.longitude ? parseFloat(formData.longitude) : null,\r\n        plot_size: formData.plotSize ? parseFloat(formData.plotSize) : null,\r\n        view_type: formData.view || null,\r\n        service_charge: formData.serviceCharges ? parseFloat(formData.serviceCharges) : null,\r\n        ownership_type: formData.ownershipType || null,\r\n        developer: formData.developer || null,\r\n        project_name: formData.projectName || null,\r\n        building_name: formData.buildingName || null,\r\n        floor_number: formData.floorNumber ? parseInt(formData.floorNumber) : null,\r\n        parking_spaces: formData.parkingSpaces ? parseInt(formData.parkingSpaces) : null,\r\n        virtual_tour_url: formData.tourUrl || null,\r\n        videos: formData.videoUrl ? [formData.videoUrl] : [],\r\n      };\r\n\r\n      let savedId = listingId || draftId; // Use draft ID if available\r\n      let error;\r\n\r\n      if (mode === \"edit\" || (mode === \"add\" && draftId)) {\r\n        // Update existing listing or draft\r\n        const idToUpdate = listingId || draftId;\r\n        if (!idToUpdate) {\r\n          toast.error(\"Error: Missing listing ID for update\");\r\n          setIsSubmitting(false);\r\n          return;\r\n        }\r\n\r\n        const { error: updateError } = await supabase\r\n          .from('listings')\r\n          .update({\r\n            ...baseListingData,\r\n            updated_at: new Date().toISOString(),\r\n          })\r\n          .eq('id', idToUpdate);\r\n\r\n        error = updateError;\r\n        savedId = idToUpdate;\r\n      } else {\r\n        // Create new listing (no draft exists)\r\n        const { data: insertData, error: insertError } = await supabase\r\n          .from('listings')\r\n          .insert({\r\n            ...baseListingData,\r\n            company_id: agent?.company_id || null,\r\n            created_by: agent?.id || null,\r\n            assigned_agent_id: agent?.id || null,\r\n          })\r\n          .select('id')\r\n          .single();\r\n\r\n        error = insertError;\r\n        if (insertData) savedId = insertData.id;\r\n      }\r\n\r\n      if (error) throw error;\r\n\r\n      // Handle Portal Publications\r\n      if (savedId) {\r\n        const enabledPortals = formData.portals.filter(p => p.enabled && p.name !== \"Website\");\r\n\r\n        if (enabledPortals.length > 0) {\r\n\r\n\r\n          // Get portal IDs for the enabled portals\r\n          const { data: portalsList } = await supabase\r\n            .from('portals')\r\n            .select('id, name');\r\n\r\n          for (const p of enabledPortals) {\r\n            const portalDb = portalsList?.find(pl => pl.name.toLowerCase().includes(p.name.toLowerCase()));\r\n            if (portalDb) {\r\n              // Trigger publication\r\n              await supabase.functions.invoke(\"portal-publish\", {\r\n                body: {\r\n                  action: \"publish\",\r\n                  listing_id: savedId,\r\n                  portal_id: portalDb.id,\r\n                  agent_id: agent?.id || \"\",\r\n                  company_id: agent?.company_id || \"\",\r\n                },\r\n              });\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      toast.success(\r\n        mode === \"add\" ? \"Listing created successfully!\" : \"Listing updated successfully!\",\r\n        {\r\n          description: formData.title,\r\n        }\r\n      );\r\n\r\n      onSave?.(formData);\r\n      onOpenChange(false);\r\n    } catch (error: any) {\r\n      console.error('Error saving listing:', error);\r\n      toast.error(\"Failed to save listing\", {\r\n        description: error.message || \"Please try again\",\r\n      });\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  const isMobile = useIsMobile();\r\n  const { language, isRTL, t } = useLocalization();\r\n  const [contentLang, setContentLang] = useState<'en' | 'ar'>('en');\r\n\r\n  // Step completion checks\r\n  const isDetailsComplete = formData.title.trim().length >= 5 && formData.price && formData.location.trim().length >= 3;\r\n  const isMediaComplete = formData.images.length >= 1;\r\n  const isAmenitiesComplete = formData.amenities.length >= 1 || formData.features.length >= 1;\r\n  // Portals is complete only if user manually enabled a portal (not counting default Website)\r\n  const isPortalsComplete = formData.portals.filter(p => p.name !== \"Website\").some(p => p.enabled);\r\n\r\n  const steps = [\r\n    { id: 'details', label: 'Details', icon: FileText, complete: isDetailsComplete },\r\n    { id: 'media', label: 'Media', icon: ImageIcon, complete: isMediaComplete },\r\n    { id: 'amenities', label: 'Amenities', icon: Home, complete: isAmenitiesComplete },\r\n    { id: 'portals', label: 'Portals', icon: Globe, complete: isPortalsComplete },\r\n  ];\r\n\r\n  const currentStepIndex = steps.findIndex(s => s.id === activeTab);\r\n\r\n  const handleNextStep = () => {\r\n    const tabs = [\"details\", \"media\", \"amenities\", \"portals\"];\r\n    const currentIndex = tabs.indexOf(activeTab);\r\n    if (currentIndex < tabs.length - 1) {\r\n      setActiveTab(tabs[currentIndex + 1]);\r\n    }\r\n  };\r\n\r\n  const handlePrevStep = () => {\r\n    const tabs = [\"details\", \"media\", \"amenities\", \"portals\"];\r\n    const currentIndex = tabs.indexOf(activeTab);\r\n    if (currentIndex > 0) {\r\n      setActiveTab(tabs[currentIndex - 1]);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <ResponsiveDialog open={open} onOpenChange={onOpenChange}>\r\n      <ResponsiveDialogContent\r\n        className=\"max-w-4xl max-h-[95vh] sm:max-h-[90vh] p-0 overflow-hidden\"\r\n        onClick={(e) => e.stopPropagation()}\r\n      >\r\n        {/* Header with navigation icons on mobile */}\r\n        <ResponsiveDialogHeader className=\"px-3 py-1.5 border-b sticky top-0 bg-background z-10\">\r\n          <div className=\"flex items-center justify-between\">\r\n            {/* Close/Back button */}\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              className=\"h-8 w-8 lg:hidden\"\r\n              onClick={() => {\r\n                if (currentStepIndex > 0) {\r\n                  handlePrevStep();\r\n                } else {\r\n                  onOpenChange(false);\r\n                }\r\n              }}\r\n            >\r\n              {currentStepIndex > 0 ? (\r\n                <ChevronLeft className=\"h-5 w-5\" />\r\n              ) : (\r\n                <X className=\"h-5 w-5\" />\r\n              )}\r\n            </Button>\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              className=\"hidden lg:flex text-muted-foreground\"\r\n              onClick={() => onOpenChange(false)}\r\n            >\r\n              Cancel\r\n            </Button>\r\n\r\n            {/* Title */}\r\n            <div className=\"flex flex-col items-center gap-0.5\">\r\n              <ResponsiveDialogTitle className=\"text-sm sm:text-base font-semibold\">\r\n                {mode === \"add\" ? \"Add Listing\" : \"Edit Listing\"}\r\n              </ResponsiveDialogTitle>\r\n              {/* Auto-save indicator */}\r\n              {mode === \"add\" && formData.title && (\r\n                <div className=\"flex items-center gap-1 text-[10px] sm:text-xs\">\r\n                  {autoSaveStatus === 'saving' && (\r\n                    <>\r\n                      <div className=\"h-1.5 w-1.5 rounded-full bg-blue-500 animate-pulse\" />\r\n                      <span className=\"text-muted-foreground\">Saving...</span>\r\n                    </>\r\n                  )}\r\n                  {autoSaveStatus === 'saved' && (\r\n                    <>\r\n                      <Check className=\"h-3 w-3 text-green-500\" />\r\n                      <span className=\"text-green-600\">Saved as draft</span>\r\n                    </>\r\n                  )}\r\n                  {autoSaveStatus === 'error' && (\r\n                    <>\r\n                      <X className=\"h-3 w-3 text-destructive\" />\r\n                      <span className=\"text-destructive\">Save failed</span>\r\n                    </>\r\n                  )}\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* Next/Create button */}\r\n            {activeTab !== \"portals\" ? (\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"icon\"\r\n                className=\"h-8 w-8 text-primary lg:w-auto lg:px-4\"\r\n                onClick={handleNextStep}\r\n              >\r\n                <ChevronRight className=\"h-5 w-5 lg:mr-1\" />\r\n                <span className=\"hidden lg:inline\">Next</span>\r\n              </Button>\r\n            ) : (\r\n              <Button\r\n                size=\"sm\"\r\n                className=\"h-8\"\r\n                onClick={handleSubmit}\r\n                disabled={isSubmitting}\r\n              >\r\n                {isSubmitting ? \"Saving...\" : mode === \"add\" ? \"Create\" : \"Update\"}\r\n              </Button>\r\n            )}\r\n          </div>\r\n          {/* Mini Progress Bar */}\r\n          <div className=\"h-1 bg-muted\">\r\n            <div\r\n              className=\"h-full bg-primary transition-all duration-300 ease-out\"\r\n              style={{ width: `${((steps.filter(s => s.complete).length) / steps.length) * 100}%` }}\r\n            />\r\n          </div>\r\n        </ResponsiveDialogHeader>\r\n\r\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"flex-1 flex flex-col\">\r\n          {/* Step Progress Indicator */}\r\n          <div className=\"px-3 sm:px-4 py-1.5 border-b bg-muted/30 sticky top-[40px] z-10\">\r\n            <div className=\"flex items-center justify-between max-w-sm mx-auto\">\r\n              {steps.map((step, index) => {\r\n                const StepIcon = step.icon;\r\n                const isActive = step.id === activeTab;\r\n                const isPast = index < currentStepIndex;\r\n\r\n                return (\r\n                  <div key={step.id} className=\"flex items-center\">\r\n                    <button\r\n                      onClick={() => setActiveTab(step.id)}\r\n                      className={cn(\r\n                        \"flex flex-col items-center gap-1 transition-all\",\r\n                        isActive && \"scale-105\"\r\n                      )}\r\n                    >\r\n                      <div className={cn(\r\n                        \"relative w-8 h-8 sm:w-9 sm:h-9 rounded-full flex items-center justify-center transition-all border-2\",\r\n                        step.complete\r\n                          ? \"bg-green-500 border-green-500 text-white\"\r\n                          : isActive\r\n                            ? \"bg-primary border-primary text-primary-foreground\"\r\n                            : \"bg-muted border-border text-muted-foreground\"\r\n                      )}>\r\n                        {step.complete ? (\r\n                          <Check className=\"h-3.5 w-3.5\" />\r\n                        ) : (\r\n                          <StepIcon className=\"h-3 w-3\" />\r\n                        )}\r\n                      </div>\r\n                      <span className={cn(\r\n                        \"text-[9px] sm:text-[10px] font-medium\",\r\n                        isActive ? \"text-foreground\" : \"text-muted-foreground\"\r\n                      )}>\r\n                        {step.label}\r\n                      </span>\r\n                    </button>\r\n                    {index < steps.length - 1 && (\r\n                      <div className={cn(\r\n                        \"w-6 sm:w-10 h-0.5 mx-1 sm:mx-2 rounded-full transition-colors\",\r\n                        step.complete ? \"bg-green-500\" : \"bg-border\"\r\n                      )} />\r\n                    )}\r\n                  </div>\r\n                );\r\n              })}\r\n            </div>\r\n          </div>\r\n\r\n          <ResponsiveDialogBody className={isMobile ? \"flex-1 overflow-y-auto\" : \"\"}>\r\n            <ScrollArea className={isMobile ? \"h-full\" : \"h-[calc(90vh-180px)]\"}>\r\n              {/* Details Tab */}\r\n              <TabsContent value=\"details\" className=\"p-2 sm:p-3 m-0 space-y-2\">\r\n                {/* Basic Information */}\r\n                <Card className=\"shadow-none border\">\r\n                  <CardHeader className=\"pb-2 px-3\">\r\n                    <CardTitle className=\"text-sm flex items-center justify-between\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <div className=\"h-7 w-7 rounded-lg bg-primary/10 flex items-center justify-center\">\r\n                          <FileText className=\"h-3.5 w-3.5 text-primary\" />\r\n                        </div>\r\n                        <span className=\"font-medium\">{isRTL ? \"Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©\" : \"Basic Information\"}</span>\r\n                      </div>\r\n                      {/* Language Toggle for Content */}\r\n                      <div className=\"flex items-center bg-muted rounded-md p-0.5\">\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={() => setContentLang('en')}\r\n                          className={cn(\r\n                            \"px-2.5 py-1 text-[11px] font-medium rounded transition-all\",\r\n                            contentLang === 'en'\r\n                              ? \"bg-background text-foreground shadow-sm\"\r\n                              : \"text-muted-foreground hover:text-foreground\"\r\n                          )}\r\n                        >\r\n                          EN\r\n                        </button>\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={() => setContentLang('ar')}\r\n                          className={cn(\r\n                            \"px-2.5 py-1 text-[11px] font-medium rounded transition-all\",\r\n                            contentLang === 'ar'\r\n                              ? \"bg-background text-foreground shadow-sm\"\r\n                              : \"text-muted-foreground hover:text-foreground\"\r\n                          )}\r\n                        >\r\n                          Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©\r\n                        </button>\r\n                      </div>\r\n                    </CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent className=\"space-y-2 px-3 pt-0\">\r\n                    <div className=\"grid gap-4\">\r\n                      {/* English Content */}\r\n                      {contentLang === 'en' && (\r\n                        <>\r\n                          <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"title\" className={cn(\"text-sm font-medium flex items-center gap-2\", errors.title && touched.title ? \"text-destructive\" : \"\")}>\r\n                              Property Title (English) *\r\n                              <Badge variant=\"outline\" className=\"text-[10px] px-1.5 py-0\">EN</Badge>\r\n                            </Label>\r\n                            <Input\r\n                              id=\"title\"\r\n                              placeholder=\"e.g., Luxury 3BR Apartment in Marina Gate\"\r\n                              value={formData.title}\r\n                              onChange={(e) => updateField(\"title\", e.target.value)}\r\n                              onBlur={() => handleBlur(\"title\")}\r\n                              className={cn(\r\n                                \"h-9 sm:h-10 text-sm\",\r\n                                errors.title && touched.title ? \"border-destructive focus-visible:ring-destructive\" : \"\"\r\n                              )}\r\n                            />\r\n                            {errors.title && touched.title && (\r\n                              <p className=\"text-xs sm:text-sm text-destructive\">{errors.title}</p>\r\n                            )}\r\n                          </div>\r\n\r\n                          <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"description\" className=\"text-sm font-medium flex items-center gap-2\">\r\n                              Description (English) (Optional)\r\n                              <Badge variant=\"outline\" className=\"text-[10px] px-1.5 py-0\">EN</Badge>\r\n                            </Label>\r\n                            <Textarea\r\n                              id=\"description\"\r\n                              placeholder=\"Describe the property in English...\"\r\n                              rows={4}\r\n                              value={formData.description}\r\n                              onChange={(e) => updateField(\"description\", e.target.value)}\r\n                              className=\"text-sm resize-none\"\r\n                            />\r\n                          </div>\r\n                        </>\r\n                      )}\r\n\r\n                      {/* Arabic Content */}\r\n                      {contentLang === 'ar' && (\r\n                        <>\r\n                          <div className=\"space-y-2\" dir=\"rtl\">\r\n                            <Label htmlFor=\"titleAr\" className=\"text-sm font-medium flex items-center gap-2 justify-end\">\r\n                              <Badge variant=\"outline\" className=\"text-[10px] px-1.5 py-0 bg-amber-500/10 border-amber-500/30 text-amber-600\">AR</Badge>\r\n                              Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)\r\n                            </Label>\r\n                            <Input\r\n                              id=\"titleAr\"\r\n                              placeholder=\"Ù…Ø«Ø§Ù„: Ø´Ù‚Ø© ÙØ§Ø®Ø±Ø© 3 ØºØ±Ù Ù†ÙˆÙ… ÙÙŠ Ù…Ø§Ø±ÙŠÙ†Ø§ Ø¬ÙŠØª\"\r\n                              value={formData.titleAr}\r\n                              onChange={(e) => updateField(\"titleAr\", e.target.value)}\r\n                              className=\"h-9 sm:h-10 text-sm text-right\"\r\n                              dir=\"rtl\"\r\n                            />\r\n                          </div>\r\n\r\n                          <div className=\"space-y-2\" dir=\"rtl\">\r\n                            <Label htmlFor=\"descriptionAr\" className=\"text-sm font-medium flex items-center gap-2 justify-end\">\r\n                              <Badge variant=\"outline\" className=\"text-[10px] px-1.5 py-0 bg-amber-500/10 border-amber-500/30 text-amber-600\">AR</Badge>\r\n                              Ø§Ù„ÙˆØµÙ (Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)\r\n                            </Label>\r\n                            <Textarea\r\n                              id=\"descriptionAr\"\r\n                              placeholder=\"ÙˆØµÙ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©...\"\r\n                              rows={4}\r\n                              value={formData.descriptionAr}\r\n                              onChange={(e) => updateField(\"descriptionAr\", e.target.value)}\r\n                              className=\"text-sm resize-none text-right\"\r\n                              dir=\"rtl\"\r\n                            />\r\n                          </div>\r\n                        </>\r\n                      )}\r\n\r\n                      {/* Language completion indicator */}\r\n                      <div className=\"flex items-center gap-4 p-3 rounded-lg bg-muted/50 border border-border/50\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <div className={cn(\r\n                            \"h-2 w-2 rounded-full\",\r\n                            formData.title ? \"bg-green-500\" : \"bg-muted-foreground/30\"\r\n                          )} />\r\n                          <span className=\"text-xs text-muted-foreground\">English {formData.title ? \"âœ“\" : \"\"}</span>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <div className={cn(\r\n                            \"h-2 w-2 rounded-full\",\r\n                            formData.titleAr ? \"bg-green-500\" : \"bg-amber-500/50\"\r\n                          )} />\r\n                          <span className=\"text-xs text-muted-foreground\">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© {formData.titleAr ? \"âœ“\" : \"(optional)\"}</span>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-2 gap-3 sm:gap-4\">\r\n                      <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"propertyType\" className=\"text-sm font-medium\">Property Type *</Label>\r\n                        <Select\r\n                          value={formData.propertyType}\r\n                          onValueChange={(value) => updateField(\"propertyType\", value)}\r\n                        >\r\n                          <SelectTrigger className=\"h-9 sm:h-10 text-sm\">\r\n                            <SelectValue />\r\n                          </SelectTrigger>\r\n                          <SelectContent>\r\n                            {propertyTypes.map((type) => (\r\n                              <SelectItem key={type.value} value={type.value}>\r\n                                {type.label}\r\n                              </SelectItem>\r\n                            ))}\r\n                          </SelectContent>\r\n                        </Select>\r\n                      </div>\r\n\r\n                      <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"listingType\" className=\"text-sm font-medium\">Listing Type *</Label>\r\n                        <Select\r\n                          value={formData.listingType}\r\n                          onValueChange={(value) => updateField(\"listingType\", value)}\r\n                        >\r\n                          <SelectTrigger className=\"h-10 sm:h-11 text-sm\">\r\n                            <SelectValue />\r\n                          </SelectTrigger>\r\n                          <SelectContent>\r\n                            <SelectItem value=\"sale\">For Sale</SelectItem>\r\n                            <SelectItem value=\"rent\">For Rent</SelectItem>\r\n                          </SelectContent>\r\n                        </Select>\r\n                      </div>\r\n\r\n                      <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"refNumber\" className={cn(\"text-sm font-medium\", errors.refNumber && touched.refNumber ? \"text-destructive\" : \"\")}>\r\n                          Ref Number *\r\n                        </Label>\r\n                        <Input\r\n                          id=\"refNumber\"\r\n                          placeholder=\"e.g. JB-1002\"\r\n                          value={formData.refNumber}\r\n                          onChange={(e) => updateField(\"refNumber\", e.target.value)}\r\n                          onBlur={() => handleBlur(\"refNumber\")}\r\n                          className={cn(\"h-10 sm:h-11 text-sm\", errors.refNumber && touched.refNumber ? \"border-destructive focus-visible:ring-destructive\" : \"\")}\r\n                        />\r\n                        {errors.refNumber && touched.refNumber && (\r\n                          <p className=\"text-xs sm:text-sm text-destructive\">{errors.refNumber}</p>\r\n                        )}\r\n                      </div>\r\n\r\n                      <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"status\" className={cn(\"text-sm font-medium\", errors.status && touched.status ? \"text-destructive\" : \"\")}>\r\n                          Status *\r\n                        </Label>\r\n                        <Select\r\n                          value={formData.status}\r\n                          onValueChange={(value) => {\r\n                            updateField(\"status\", value);\r\n                            setTouched((prev) => ({ ...prev, status: true }));\r\n                          }}\r\n                        >\r\n                          <SelectTrigger className={cn(\"h-10 sm:h-11 text-sm\", errors.status && touched.status ? \"border-destructive focus:ring-destructive\" : \"\")}>\r\n                            <SelectValue />\r\n                          </SelectTrigger>\r\n                          <SelectContent>\r\n                            {listingStatuses.map((status) => (\r\n                              <SelectItem key={status.value} value={status.value}>\r\n                                {status.label}\r\n                              </SelectItem>\r\n                            ))}\r\n                          </SelectContent>\r\n                        </Select>\r\n                        {errors.status && touched.status && (\r\n                          <p className=\"text-xs sm:text-sm text-destructive\">{errors.status}</p>\r\n                        )}\r\n                      </div>\r\n\r\n                      <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"completionStatus\" className=\"text-sm font-medium\">Completion Status</Label>\r\n                        <Select\r\n                          value={formData.completionStatus || \"ready\"}\r\n                          onValueChange={(value) => updateField(\"completionStatus\", value)}\r\n                        >\r\n                          <SelectTrigger className=\"h-10 sm:h-11 text-sm\">\r\n                            <SelectValue />\r\n                          </SelectTrigger>\r\n                          <SelectContent>\r\n                            <SelectItem value=\"ready\">Ready (Secondary)</SelectItem>\r\n                            <SelectItem value=\"off_plan\">Off-plan (Primary)</SelectItem>\r\n                          </SelectContent>\r\n                        </Select>\r\n                      </div>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n\r\n                {/* Location & Pricing Card */}\r\n                <Card className=\"shadow-none border\">\r\n                  <CardHeader className=\"pb-3 px-3 sm:px-4\">\r\n                    <CardTitle className=\"text-sm flex items-center gap-2\">\r\n                      <div className=\"h-7 w-7 rounded-lg bg-emerald-500/10 flex items-center justify-center\">\r\n                        <MapPin className=\"h-3.5 w-3.5 text-emerald-600\" />\r\n                      </div>\r\n                      <span className=\"font-medium\">Location & Pricing</span>\r\n                    </CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent className=\"space-y-2 px-3 pt-0\">\r\n                    <div className=\"space-y-2\">\r\n                      <LocationSearchInput\r\n                        value={formData.location}\r\n                        onChange={(value) => updateField(\"location\", value)}\r\n                        onBlur={() => handleBlur(\"location\")}\r\n                        placeholder=\"City, community or building\"\r\n                        label=\"Property Location\"\r\n                        required\r\n                        error={errors.location && touched.location ? errors.location : undefined}\r\n                      />\r\n\r\n                    </div>\r\n                    <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4\">\r\n                      {/* Price with Currency Selector */}\r\n                      <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"price\" className={cn(\"text-sm font-medium\", errors.price && touched.price ? \"text-destructive\" : \"\")}>\r\n                          Price *\r\n                        </Label>\r\n                        <div className=\"flex gap-2\">\r\n                          <Select\r\n                            value={formData.currency}\r\n                            onValueChange={(value) => updateField(\"currency\", value)}\r\n                          >\r\n                            <SelectTrigger className=\"h-10 sm:h-11 w-[90px] text-sm flex-shrink-0\">\r\n                              <SelectValue />\r\n                            </SelectTrigger>\r\n                            <SelectContent className=\"bg-popover\">\r\n                              {currencies.map((curr) => (\r\n                                <SelectItem key={curr.value} value={curr.value}>\r\n                                  {curr.value}\r\n                                </SelectItem>\r\n                              ))}\r\n                            </SelectContent>\r\n                          </Select>\r\n                          <div className=\"relative flex-1\">\r\n                            <Input\r\n                              id=\"price\"\r\n                              type=\"number\"\r\n                              placeholder=\"2,500,000\"\r\n                              value={formData.price}\r\n                              onChange={(e) => updateField(\"price\", e.target.value)}\r\n                              onBlur={() => handleBlur(\"price\")}\r\n                              className={cn(\"h-10 sm:h-11 text-sm\", errors.price && touched.price ? \"border-destructive\" : \"\")}\r\n                            />\r\n                          </div>\r\n                        </div>\r\n                        {errors.price && touched.price && (\r\n                          <p className=\"text-xs sm:text-sm text-destructive\">{errors.price}</p>\r\n                        )}\r\n                      </div>\r\n\r\n                      {/* Size with Unit Selector */}\r\n                      <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"size\" className=\"text-sm font-medium\">Size</Label>\r\n                        <div className=\"flex gap-2\">\r\n                          <div className=\"relative flex-1\">\r\n                            <Ruler className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n                            <Input\r\n                              id=\"size\"\r\n                              type=\"number\"\r\n                              placeholder=\"2,100\"\r\n                              value={formData.size}\r\n                              onChange={(e) => updateField(\"size\", e.target.value)}\r\n                              className=\"h-10 sm:h-11 text-sm pl-9\"\r\n                            />\r\n                          </div>\r\n                          <Select\r\n                            value={formData.sizeUnit}\r\n                            onValueChange={(value) => updateField(\"sizeUnit\", value)}\r\n                          >\r\n                            <SelectTrigger className=\"h-10 sm:h-11 w-[80px] text-sm flex-shrink-0\">\r\n                              <SelectValue />\r\n                            </SelectTrigger>\r\n                            <SelectContent className=\"bg-popover\">\r\n                              {sizeUnits.map((unit) => (\r\n                                <SelectItem key={unit.value} value={unit.value}>\r\n                                  {unit.label}\r\n                                </SelectItem>\r\n                              ))}\r\n                            </SelectContent>\r\n                          </Select>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n\r\n                {/* Property Details Card */}\r\n                <Card className=\"shadow-none border\">\r\n                  <CardHeader className=\"pb-3 px-3 sm:px-4\">\r\n                    <CardTitle className=\"text-sm flex items-center gap-2\">\r\n                      <div className=\"h-7 w-7 rounded-lg bg-blue-500/10 flex items-center justify-center\">\r\n                        <Bed className=\"h-3.5 w-3.5 text-blue-600\" />\r\n                      </div>\r\n                      <span className=\"font-medium\">Property Details</span>\r\n                    </CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent className=\"px-3 sm:px-4 pt-0\">\r\n                    <div className=\"grid grid-cols-3 gap-2 sm:gap-3\">\r\n                      <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"bedrooms\" className=\"text-sm font-medium\">Beds</Label>\r\n                        <Select\r\n                          value={formData.bedrooms}\r\n                          onValueChange={(value) => updateField(\"bedrooms\", value)}\r\n                        >\r\n                          <SelectTrigger className=\"h-10 sm:h-11 text-sm\">\r\n                            <SelectValue placeholder=\"0\" />\r\n                          </SelectTrigger>\r\n                          <SelectContent>\r\n                            {[\"Studio\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7+\"].map((n) => (\r\n                              <SelectItem key={n} value={n}>{n}</SelectItem>\r\n                            ))}\r\n                          </SelectContent>\r\n                        </Select>\r\n                      </div>\r\n                      <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"bathrooms\" className=\"text-sm font-medium\">Baths</Label>\r\n                        <Select\r\n                          value={formData.bathrooms}\r\n                          onValueChange={(value) => updateField(\"bathrooms\", value)}\r\n                        >\r\n                          <SelectTrigger className=\"h-10 sm:h-11 text-sm\">\r\n                            <SelectValue placeholder=\"0\" />\r\n                          </SelectTrigger>\r\n                          <SelectContent>\r\n                            {[\"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7+\"].map((n) => (\r\n                              <SelectItem key={n} value={n}>{n}</SelectItem>\r\n                            ))}\r\n                          </SelectContent>\r\n                        </Select>\r\n                      </div>\r\n                      <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"furnishing\" className=\"text-sm font-medium\">Furnishing</Label>\r\n                        <Select\r\n                          value={formData.furnishing}\r\n                          onValueChange={(value) => updateField(\"furnishing\", value)}\r\n                        >\r\n                          <SelectTrigger className=\"h-10 sm:h-11 text-sm\">\r\n                            <SelectValue />\r\n                          </SelectTrigger>\r\n                          <SelectContent>\r\n                            <SelectItem value=\"furnished\">Furnished</SelectItem>\r\n                            <SelectItem value=\"semi-furnished\">Semi</SelectItem>\r\n                            <SelectItem value=\"unfurnished\">Unfurnished</SelectItem>\r\n                          </SelectContent>\r\n                        </Select>\r\n                      </div>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n\r\n                {/* Building Details Card */}\r\n                <Card className=\"shadow-none border\">\r\n                  <CardHeader className=\"pb-3 px-3 sm:px-4\">\r\n                    <CardTitle className=\"text-sm flex items-center gap-2\">\r\n                      <div className=\"h-7 w-7 rounded-lg bg-indigo-500/10 flex items-center justify-center\">\r\n                        <Building2 className=\"h-3.5 w-3.5 text-indigo-600\" />\r\n                      </div>\r\n                      <span className=\"font-medium\">Building & Project</span>\r\n                    </CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent className=\"space-y-3 px-3 sm:px-4 pt-0\">\r\n                    <div className=\"grid grid-cols-2 gap-3\">\r\n                      <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"developer\" className=\"text-sm font-medium\">Developer (Optional)</Label>\r\n                        <Input\r\n                          id=\"developer\"\r\n                          placeholder=\"e.g. Emaar\"\r\n                          value={formData.developer}\r\n                          onChange={(e) => updateField(\"developer\", e.target.value)}\r\n                          className=\"h-10 text-sm\"\r\n                        />\r\n                      </div>\r\n                      <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"projectName\" className=\"text-sm font-medium\">Project Name (Optional)</Label>\r\n                        <Input\r\n                          id=\"projectName\"\r\n                          placeholder=\"e.g. Dubai Marina\"\r\n                          value={formData.projectName}\r\n                          onChange={(e) => updateField(\"projectName\", e.target.value)}\r\n                          className=\"h-10 text-sm\"\r\n                        />\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"grid grid-cols-2 gap-3\">\r\n                      <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"buildingName\" className=\"text-sm font-medium\">Building Name (Optional)</Label>\r\n                        <Input\r\n                          id=\"buildingName\"\r\n                          placeholder=\"e.g. Marina Gate 1\"\r\n                          value={formData.buildingName}\r\n                          onChange={(e) => updateField(\"buildingName\", e.target.value)}\r\n                          className=\"h-10 text-sm\"\r\n                        />\r\n                      </div>\r\n                      <div className=\"grid grid-cols-2 gap-2\">\r\n                        <div className=\"space-y-2\">\r\n                          <Label htmlFor=\"floorNumber\" className=\"text-sm font-medium\">Floor (Optional)</Label>\r\n                          <Input\r\n                            id=\"floorNumber\"\r\n                            type=\"number\"\r\n                            placeholder=\"15\"\r\n                            value={formData.floorNumber}\r\n                            onChange={(e) => updateField(\"floorNumber\", e.target.value)}\r\n                            className=\"h-10 text-sm\"\r\n                          />\r\n                        </div>\r\n                        <div className=\"space-y-2\">\r\n                          <Label htmlFor=\"parkingSpaces\" className=\"text-sm font-medium\">Parking (Optional)</Label>\r\n                          <Input\r\n                            id=\"parkingSpaces\"\r\n                            type=\"number\"\r\n                            placeholder=\"1\"\r\n                            value={formData.parkingSpaces}\r\n                            onChange={(e) => updateField(\"parkingSpaces\", e.target.value)}\r\n                            className=\"h-10 text-sm\"\r\n                          />\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n\r\n\r\n              </TabsContent>\r\n\r\n              {/* Media Tab */}\r\n              <TabsContent value=\"media\" className=\"p-2.5 sm:p-4 m-0 space-y-3\">\r\n                <Card className=\"shadow-none border\">\r\n                  <CardHeader className=\"pb-2 px-3 sm:px-4\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <CardTitle className=\"text-sm font-medium\">Property Images</CardTitle>\r\n                      <Badge variant=\"secondary\" className=\"text-xs\">{formData.images.length} images</Badge>\r\n                    </div>\r\n                  </CardHeader>\r\n                  <CardContent className=\"space-y-2 px-3 pt-0\">\r\n                    {/* Hidden File Input */}\r\n                    <input\r\n                      ref={fileInputRef}\r\n                      type=\"file\"\r\n                      accept=\"image/jpeg,image/jpg,image/png,image/webp,image/heic,image/heif,image/gif,image/bmp,image/tiff,.jpg,.jpeg,.png,.webp,.heic,.heif,.gif,.bmp,.tiff,.tif\"\r\n                      multiple\r\n                      className=\"hidden\"\r\n                      onChange={handleFileSelect}\r\n                    />\r\n\r\n                    {/* Upload Area */}\r\n                    <div\r\n                      onClick={handleImageUpload}\r\n                      className={cn(\r\n                        \"border-2 border-dashed border-muted-foreground/25 rounded-lg p-4 sm:p-6 text-center cursor-pointer hover:border-primary/50 hover:bg-muted/30 transition-colors\",\r\n                        isUploading && \"pointer-events-none opacity-50\"\r\n                      )}\r\n                    >\r\n                      {isUploading ? (\r\n                        <>\r\n                          <div className=\"h-8 w-8 mx-auto mb-2 border-2 border-primary border-t-transparent rounded-full animate-spin\" />\r\n                          <p className=\"text-xs sm:text-sm font-medium\">Uploading...</p>\r\n                        </>\r\n                      ) : (\r\n                        <>\r\n                          <Upload className=\"h-8 w-8 mx-auto mb-2 text-muted-foreground\" />\r\n                          <p className=\"text-xs sm:text-sm font-medium\">Tap to upload</p>\r\n                          <p className=\"text-[10px] sm:text-xs text-muted-foreground mt-1\">\r\n                            JPG, PNG, WEBP, HEIC up to 50MB\r\n                          </p>\r\n                        </>\r\n                      )}\r\n                    </div>\r\n\r\n                    {/* Sortable Image Grid */}\r\n                    {formData.images.length > 0 && (\r\n                      <DndContext\r\n                        sensors={sensors}\r\n                        collisionDetection={closestCenter}\r\n                        onDragEnd={handleDragEnd}\r\n                      >\r\n                        <SortableContext\r\n                          items={formData.images}\r\n                          strategy={rectSortingStrategy}\r\n                        >\r\n                          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\r\n                            {formData.images.map((image, index) => (\r\n                              <SortableImageItem\r\n                                key={image}\r\n                                id={image}\r\n                                image={image}\r\n                                index={index}\r\n                                isCover={index === 0}\r\n                                onSetCover={() => setCoverImage(index)}\r\n                                onRemove={() => removeImage(index)}\r\n                              />\r\n                            ))}\r\n                          </div>\r\n                        </SortableContext>\r\n                      </DndContext>\r\n                    )}\r\n\r\n                    {formData.images.length === 0 && (\r\n                      <div className=\"text-center py-8 text-muted-foreground\">\r\n                        <ImageIcon className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\r\n                        <p className=\"text-sm\">No images uploaded yet</p>\r\n                      </div>\r\n                    )}\r\n\r\n                    {/* Tips */}\r\n                    {formData.images.length > 0 && (\r\n                      <div className=\"p-4 bg-muted/30 rounded-lg\">\r\n                        <div className=\"flex items-start gap-3\">\r\n                          <ImageIcon className=\"h-5 w-5 text-primary mt-0.5\" />\r\n                          <div>\r\n                            <p className=\"font-medium text-sm\">Image Tips</p>\r\n                            <ul className=\"text-xs text-muted-foreground mt-1 space-y-1\">\r\n                              <li>â€¢ Drag images to reorder them</li>\r\n                              <li>â€¢ Click the star icon to set a new cover image</li>\r\n                              <li>â€¢ The first image will be displayed as the main cover</li>\r\n                              <li>â€¢ Upload at least 5 images for better engagement</li>\r\n                            </ul>\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    )}\r\n                  </CardContent>\r\n                </Card>\r\n\r\n                {/* Video & Virtual Tour Card */}\r\n                <Card className=\"shadow-none border\">\r\n                  <CardHeader className=\"pb-3 px-3 sm:px-4\">\r\n                    <CardTitle className=\"text-sm flex items-center gap-2\">\r\n                      <span className=\"font-medium\">Video & Virtual Tour</span>\r\n                    </CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent className=\"space-y-3 px-3 sm:px-4 pt-0\">\r\n                    <div className=\"space-y-2\">\r\n                      <Label htmlFor=\"videoUrl\" className=\"text-sm font-medium\">Video URL (Optional)</Label>\r\n                      <Input\r\n                        id=\"videoUrl\"\r\n                        placeholder=\"https://youtu.be/...\"\r\n                        value={formData.videoUrl}\r\n                        onChange={(e) => updateField(\"videoUrl\", e.target.value)}\r\n                        className=\"h-10 text-sm\"\r\n                      />\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                      <Label htmlFor=\"tourUrl\" className=\"text-sm font-medium\">Virtual Tour URL (Optional)</Label>\r\n                      <Input\r\n                        id=\"tourUrl\"\r\n                        placeholder=\"https://my.matterport.com/...\"\r\n                        value={formData.tourUrl}\r\n                        onChange={(e) => updateField(\"tourUrl\", e.target.value)}\r\n                        className=\"h-10 text-sm\"\r\n                      />\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              </TabsContent>\r\n\r\n              {/* Amenities Tab */}\r\n              <TabsContent value=\"amenities\" className=\"p-2.5 sm:p-4 m-0 space-y-3\">\r\n                <Card className=\"shadow-none border\">\r\n                  <CardHeader className=\"pb-2 px-3 sm:px-4\">\r\n                    <CardTitle className=\"text-sm font-medium\">Amenities</CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent className=\"px-3 sm:px-4 pt-0\">\r\n                    <div className=\"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-1.5\">\r\n                      {amenitiesList.map((amenity) => (\r\n                        <label\r\n                          key={amenity}\r\n                          className={cn(\r\n                            \"flex items-center gap-1.5 p-2 rounded-md border cursor-pointer transition-all\",\r\n                            formData.amenities.includes(amenity)\r\n                              ? \"bg-primary/10 border-primary\"\r\n                              : \"hover:bg-muted/50\"\r\n                          )}\r\n                        >\r\n                          <Checkbox\r\n                            checked={formData.amenities.includes(amenity)}\r\n                            onCheckedChange={() => toggleAmenity(amenity)}\r\n                            className=\"h-3.5 w-3.5\"\r\n                          />\r\n                          <span className=\"text-[11px] sm:text-xs\">{amenity}</span>\r\n                        </label>\r\n                      ))}\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n\r\n                <Card className=\"shadow-none border\">\r\n                  <CardHeader className=\"pb-2 px-3 sm:px-4\">\r\n                    <CardTitle className=\"text-sm font-medium\">Features</CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent className=\"px-3 sm:px-4 pt-0\">\r\n                    <div className=\"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-1.5\">\r\n                      {featuresList.map((feature) => (\r\n                        <label\r\n                          key={feature}\r\n                          className={cn(\r\n                            \"flex items-center gap-1.5 p-2 rounded-md border cursor-pointer transition-all\",\r\n                            formData.features.includes(feature)\r\n                              ? \"bg-primary/10 border-primary\"\r\n                              : \"hover:bg-muted/50\"\r\n                          )}\r\n                        >\r\n                          <Checkbox\r\n                            checked={formData.features.includes(feature)}\r\n                            onCheckedChange={() => toggleFeature(feature)}\r\n                            className=\"h-3.5 w-3.5\"\r\n                          />\r\n                          <span className=\"text-[11px] sm:text-xs\">{feature}</span>\r\n                        </label>\r\n                      ))}\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              </TabsContent>\r\n\r\n              {/* Portals Tab */}\r\n              <TabsContent value=\"portals\" className=\"p-2.5 sm:p-4 m-0 space-y-3\">\r\n                <Card className=\"shadow-none border\">\r\n                  <CardHeader className=\"pb-2 px-3 sm:px-4\">\r\n                    <CardTitle className=\"text-sm font-medium\">Publish to Portals</CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent className=\"space-y-1.5 px-3 sm:px-4 pt-0\">\r\n                    {formData.portals.map((portal) => (\r\n                      <div\r\n                        key={portal.name}\r\n                        className={cn(\r\n                          \"flex items-center justify-between p-2.5 rounded-md border transition-all\",\r\n                          portal.enabled ? \"bg-primary/5 border-primary/30\" : \"\"\r\n                        )}\r\n                      >\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <div className=\"w-7 h-7 rounded-md bg-muted flex items-center justify-center\">\r\n                            <Globe className=\"h-3.5 w-3.5 text-muted-foreground\" />\r\n                          </div>\r\n                          <div>\r\n                            <p className=\"font-medium text-xs sm:text-sm\">{portal.name}</p>\r\n                            <p className=\"text-[10px] text-muted-foreground\">\r\n                              {portal.enabled ? \"Will publish\" : \"Off\"}\r\n                            </p>\r\n                          </div>\r\n                        </div>\r\n                        <Switch\r\n                          checked={portal.enabled}\r\n                          onCheckedChange={() => togglePortal(portal.name, \"enabled\")}\r\n                          className=\"scale-90\"\r\n                        />\r\n                      </div>\r\n                    ))}\r\n                  </CardContent>\r\n                </Card>\r\n              </TabsContent>\r\n            </ScrollArea>\r\n          </ResponsiveDialogBody>\r\n        </Tabs>\r\n\r\n      </ResponsiveDialogContent>\r\n    </ResponsiveDialog>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\listings\\AssignAgentDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\listings\\BulkEditListingsDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\listings\\CompanyListingsFiltersDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\listings\\ListingCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\listings\\ListingsFiltersDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\listings\\ListingsImportDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":63,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2926,2929],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2926,2929],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":70,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3296,3299],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3296,3299],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":80,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":80,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3683,3686],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3683,3686],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":86,"column":88,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":86,"endColumn":91,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4105,4108],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4105,4108],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":106,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5132,5135],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5132,5135],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":145,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":145,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6455,6458],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6455,6458],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":220,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":220,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10374,10377],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10374,10377],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useCallback } from \"react\";\r\nimport * as XLSX from \"xlsx\";\r\nimport {\r\n    ResponsiveDialog,\r\n    ResponsiveDialogContent,\r\n    ResponsiveDialogHeader,\r\n    ResponsiveDialogTitle,\r\n    ResponsiveDialogBody,\r\n} from \"@/components/ui/responsive-dialog\";\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { Progress } from \"@/components/ui/progress\";\r\nimport { Upload, FileSpreadsheet, ArrowRight, Check, Loader2, X, AlertCircle } from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\n\r\ninterface ListingsImportDialogProps {\r\n    open: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n    onImportComplete?: () => void;\r\n}\r\n\r\ntype ImportStep = \"upload\" | \"mapping\" | \"importing\" | \"complete\";\r\n\r\nconst listingFields = [\r\n    { key: \"title\", label: \"Title\", required: true },\r\n    { key: \"title_ar\", label: \"Title (Arabic)\", required: false },\r\n    { key: \"description\", label: \"Description\", required: false },\r\n    { key: \"description_ar\", label: \"Description (Arabic)\", required: false },\r\n    { key: \"price\", label: \"Price\", required: false },\r\n    { key: \"currency\", label: \"Currency\", required: false },\r\n    { key: \"address\", label: \"Address\", required: false },\r\n    { key: \"city\", label: \"City\", required: false },\r\n    { key: \"number_of_bedrooms\", label: \"Bedrooms\", required: false },\r\n    { key: \"number_of_bathrooms\", label: \"Bathrooms\", required: false },\r\n    { key: \"area_size\", label: \"Area Size\", required: false },\r\n    { key: \"property_type\", label: \"Property Type\", required: false },\r\n    { key: \"listing_type\", label: \"Listing Type (sale/rent)\", required: false },\r\n    { key: \"developer\", label: \"Developer\", required: false },\r\n    { key: \"project_name\", label: \"Project Name\", required: false },\r\n    { key: \"building_name\", label: \"Building Name\", required: false },\r\n    { key: \"handover_date\", label: \"Handover Date\", required: false },\r\n    { key: \"floor_number\", label: \"Floor Number\", required: false },\r\n    { key: \"parking_spaces\", label: \"Parking Spaces\", required: false },\r\n    { key: \"rent_frequency\", label: \"Rent Frequency\", required: false },\r\n    { key: \"completion_status\", label: \"Completion Status\", required: false },\r\n    { key: \"tags\", label: \"Tags (comma separated)\", required: false },\r\n];\r\n\r\nexport function ListingsImportDialog({ open, onOpenChange, onImportComplete }: ListingsImportDialogProps) {\r\n    const [step, setStep] = useState<ImportStep>(\"upload\");\r\n    const [file, setFile] = useState<File | null>(null);\r\n    const [excelData, setExcelData] = useState<any[]>([]);\r\n    const [excelHeaders, setExcelHeaders] = useState<string[]>([]);\r\n    const [columnMapping, setColumnMapping] = useState<Record<string, string>>({});\r\n    const [isDragging, setIsDragging] = useState(false);\r\n    const [isImporting, setIsImporting] = useState(false);\r\n    const [progress, setProgress] = useState(0);\r\n\r\n    const handleFileUpload = (e: any) => {\r\n        let uploadedFile: File | null = null;\r\n        if (e.target && e.target.files) {\r\n            uploadedFile = e.target.files[0];\r\n        } else if (e.dataTransfer && e.dataTransfer.files) {\r\n            uploadedFile = e.dataTransfer.files[0];\r\n        }\r\n\r\n        if (uploadedFile) {\r\n            const reader = new FileReader();\r\n            reader.onload = (event: any) => {\r\n                try {\r\n                    const data = new Uint8Array(event.target?.result as ArrayBuffer);\r\n                    const workbook = XLSX.read(data, { type: \"array\" });\r\n                    const firstSheetName = workbook.SheetNames[0];\r\n                    const worksheet = workbook.Sheets[firstSheetName];\r\n                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 }) as any[][];\r\n\r\n                    if (json.length > 0) {\r\n                        const headers = (json[0] as string[]).map(h => String(h || '').trim());\r\n                        setExcelHeaders(headers);\r\n                        setExcelData(json.slice(1));\r\n                        setFile(uploadedFile);\r\n\r\n                        // Auto-mapping\r\n                        const initialMapping: Record<string, string> = {};\r\n                        listingFields.forEach(field => {\r\n                            const match = headers.find(h =>\r\n                                h.toLowerCase().includes(field.label.toLowerCase()) ||\r\n                                h.toLowerCase().includes(field.key.toLowerCase().replace(/_/g, ' '))\r\n                            );\r\n                            if (match) initialMapping[field.key] = match;\r\n                        });\r\n                        setColumnMapping(initialMapping);\r\n                        setStep(\"mapping\");\r\n                    }\r\n                } catch (err: any) {\r\n                    toast.error(\"Failed to read file: \" + err.message);\r\n                }\r\n            };\r\n            reader.readAsArrayBuffer(uploadedFile);\r\n        }\r\n    };\r\n\r\n    const startImport = async () => {\r\n        setIsImporting(true);\r\n        setStep(\"importing\");\r\n        setProgress(0);\r\n\r\n        try {\r\n            const { data: { user } } = await supabase.auth.getUser();\r\n            if (!user) throw new Error(\"Not authenticated\");\r\n\r\n            // Use a more reliable way to get agent and company_id\r\n            const { data: profile } = await supabase\r\n                .from(\"profiles\")\r\n                .select(\"company_id\")\r\n                .eq(\"id\", user.id)\r\n                .single();\r\n\r\n            const { data: agent } = await supabase\r\n                .from(\"agents\")\r\n                .select(\"id, company_id\")\r\n                .eq(\"user_id\", user.id)\r\n                .single();\r\n\r\n            if (!agent) throw new Error(\"Agent profile not found\");\r\n\r\n            const total = excelData.length;\r\n            let imported = 0;\r\n\r\n            const batchSize = 10;\r\n            for (let i = 0; i < total; i += batchSize) {\r\n                const batch = excelData.slice(i, i + batchSize);\r\n                const records = batch.map(row => {\r\n                    const record: any = {\r\n                        company_id: agent.company_id,\r\n                        created_by: agent.id,\r\n                        assigned_agent_id: agent.id,\r\n                        currency: 'AED',\r\n                        status: 'draft',\r\n                        property_type: 'residential',\r\n                        listing_type: 'sale',\r\n                        area_unit: 'sqft'\r\n                    };\r\n\r\n                    listingFields.forEach(field => {\r\n                        const excelHeader = columnMapping[field.key];\r\n                        if (excelHeader) {\r\n                            const headerIndex = excelHeaders.indexOf(excelHeader);\r\n                            let val = row[headerIndex];\r\n\r\n                            if (val !== undefined && val !== null) {\r\n                                // Conversions\r\n                                if (field.key === 'price' || field.key === 'area_size') {\r\n                                    val = typeof val === 'string' ? parseFloat(val.replace(/[^0-9.]/g, '')) : parseFloat(val);\r\n                                } else if (['number_of_bedrooms', 'number_of_bathrooms', 'floor_number', 'parking_spaces'].includes(field.key)) {\r\n                                    val = parseInt(String(val)) || 0;\r\n                                } else if (field.key === 'tags' && typeof val === 'string') {\r\n                                    val = val.split(',').map(t => t.trim()).filter(Boolean);\r\n                                }\r\n\r\n                                if (val !== undefined && val !== null && !Number.isNaN(val)) {\r\n                                    record[field.key] = val;\r\n                                }\r\n                            }\r\n                        }\r\n                    });\r\n\r\n                    // Data cleaning for constraints\r\n                    if (record.rent_frequency) {\r\n                        const rf = String(record.rent_frequency).toLowerCase();\r\n                        if (rf.includes('year')) record.rent_frequency = 'Yearly';\r\n                        else if (rf.includes('month')) record.rent_frequency = 'Monthly';\r\n                        else if (rf.includes('week')) record.rent_frequency = 'Weekly';\r\n                        else if (rf.includes('day')) record.rent_frequency = 'Daily';\r\n                        else record.rent_frequency = 'Yearly';\r\n                    }\r\n\r\n                    if (record.completion_status) {\r\n                        const cs = String(record.completion_status).toLowerCase();\r\n                        if (cs.includes('off') || cs.includes('plan')) record.completion_status = 'Off-plan';\r\n                        else record.completion_status = 'Ready';\r\n                    }\r\n                    if (record.property_type) {\r\n                        const pt = record.property_type.toLowerCase();\r\n                        const allowedPT = ['residential', 'commercial', 'land', 'industrial', 'mixed_use', 'other'];\r\n                        if (!allowedPT.includes(pt)) record.property_type = 'residential';\r\n                    }\r\n\r\n                    if (record.listing_type) {\r\n                        const lt = record.listing_type.toLowerCase();\r\n                        const allowedLT = ['sale', 'rent', 'both'];\r\n                        if (!allowedLT.includes(lt)) record.listing_type = 'sale';\r\n                    }\r\n\r\n                    if (!record.title || record.title === \"null\") record.title = \"Untitled Listing\";\r\n\r\n                    return record;\r\n                });\r\n\r\n                const { error } = await supabase.from(\"listings\").insert(records);\r\n                if (error) throw error;\r\n\r\n                imported += records.length;\r\n                setProgress(Math.round((imported / total) * 100));\r\n            }\r\n\r\n            setStep(\"complete\");\r\n            onImportComplete?.();\r\n        } catch (error: any) {\r\n            console.error(\"Import error:\", error);\r\n            toast.error(\"Import failed: \" + error.message);\r\n            setStep(\"mapping\");\r\n            setIsImporting(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <ResponsiveDialog open={open} onOpenChange={onOpenChange}>\r\n            <ResponsiveDialogContent className=\"sm:max-w-[600px] p-0 overflow-hidden\">\r\n                <ResponsiveDialogHeader className=\"px-6 py-3 border-b\">\r\n                    <ResponsiveDialogTitle className=\"text-lg font-bold flex items-center gap-2\">\r\n                        <Upload className=\"h-5 w-5 text-primary\" />\r\n                        Import Listings\r\n                    </ResponsiveDialogTitle>\r\n                </ResponsiveDialogHeader>\r\n                <ResponsiveDialogBody className=\"p-0\">\r\n                    <ScrollArea className=\"max-h-[75vh]\">\r\n                        <div className=\"p-5\">\r\n                            {step === \"upload\" && (\r\n                                <div\r\n                                    className={cn(\r\n                                        \"border-2 border-dashed rounded-xl p-8 text-center transition-all cursor-pointer\",\r\n                                        isDragging ? \"border-primary bg-primary/5 scale-[0.99]\" : \"border-muted-foreground/20 hover:border-primary/50\"\r\n                                    )}\r\n                                    onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}\r\n                                    onDragLeave={() => setIsDragging(false)}\r\n                                    onDrop={(e) => { e.preventDefault(); setIsDragging(false); handleFileUpload(e); }}\r\n                                    onClick={() => document.getElementById(\"listing-file-upload\")?.click()}\r\n                                >\r\n                                    <input\r\n                                        id=\"listing-file-upload\"\r\n                                        type=\"file\"\r\n                                        className=\"hidden\"\r\n                                        accept=\".xlsx,.xls,.csv\"\r\n                                        onChange={handleFileUpload}\r\n                                    />\r\n                                    <div className=\"bg-primary/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n                                        <FileSpreadsheet className=\"h-8 w-8 text-primary\" />\r\n                                    </div>\r\n                                    <h3 className=\"text-lg font-semibold mb-2\">Upload your listings file</h3>\r\n                                    <p className=\"text-muted-foreground text-sm mb-6 max-w-xs mx-auto\">\r\n                                        Drag and drop your Excel or CSV file here, or click to browse\r\n                                    </p>\r\n                                    <Button variant=\"outline\" className=\"gap-2\">\r\n                                        <Upload className=\"h-4 w-4\" />\r\n                                        Select File\r\n                                    </Button>\r\n                                </div>\r\n                            )}\r\n\r\n                            {step === \"mapping\" && (\r\n                                <div className=\"space-y-6\">\r\n                                    <div className=\"flex items-center justify-between text-sm\">\r\n                                        <span className=\"text-muted-foreground\">Mapping columns for <strong>{file?.name}</strong></span>\r\n                                        <Badge variant=\"outline\">{excelData.length} rows found</Badge>\r\n                                    </div>\r\n\r\n                                    <div className=\"grid gap-2\">\r\n                                        {listingFields.map((field) => (\r\n                                            <div key={field.key} className=\"flex items-center gap-4 bg-muted/30 p-2 rounded-lg border border-border/50\">\r\n                                                <div className=\"flex-1\">\r\n                                                    <p className=\"text-sm font-medium flex items-center gap-1\">\r\n                                                        {field.label}\r\n                                                        {field.required && <span className=\"text-destructive\">*</span>}\r\n                                                    </p>\r\n                                                </div>\r\n                                                <ArrowRight className=\"h-4 w-4 text-muted-foreground\" />\r\n                                                <div className=\"flex-1\">\r\n                                                    <Select\r\n                                                        value={columnMapping[field.key] || \"skip\"}\r\n                                                        onValueChange={(val) => setColumnMapping(prev => ({ ...prev, [field.key]: val }))}\r\n                                                    >\r\n                                                        <SelectTrigger className=\"h-9\">\r\n                                                            <SelectValue placeholder=\"Select column...\" />\r\n                                                        </SelectTrigger>\r\n                                                        <SelectContent>\r\n                                                            <SelectItem value=\"skip\">Skip field</SelectItem>\r\n                                                            {excelHeaders.map(header => (\r\n                                                                <SelectItem key={header} value={header}>{header}</SelectItem>\r\n                                                            ))}\r\n                                                        </SelectContent>\r\n                                                    </Select>\r\n                                                </div>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n\r\n                                    <div className=\"flex gap-3 pt-4\">\r\n                                        <Button variant=\"outline\" className=\"flex-1\" onClick={() => setStep(\"upload\")}>Back</Button>\r\n                                        <Button className=\"flex-1 gap-2\" onClick={startImport}>\r\n                                            Start Import\r\n                                            <ArrowRight className=\"h-4 w-4\" />\r\n                                        </Button>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n\r\n                            {step === \"importing\" && (\r\n                                <div className=\"text-center py-12 space-y-4\">\r\n                                    <Loader2 className=\"h-12 w-12 animate-spin text-primary mx-auto\" />\r\n                                    <h3 className=\"text-lg font-semibold\">Importing Listings...</h3>\r\n                                    <p className=\"text-muted-foreground\">Please wait while we process your data.</p>\r\n                                    <div className=\"max-w-xs mx-auto pt-4\">\r\n                                        <Progress value={progress} className=\"h-2\" />\r\n                                        <p className=\"text-xs text-muted-foreground mt-2\">{progress}% complete</p>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n\r\n                            {step === \"complete\" && (\r\n                                <div className=\"text-center py-12 space-y-6\">\r\n                                    <div className=\"bg-success/10 w-20 h-20 rounded-full flex items-center justify-center mx-auto\">\r\n                                        <Check className=\"h-10 w-10 text-success\" />\r\n                                    </div>\r\n                                    <div>\r\n                                        <h3 className=\"text-xl font-bold\">Import Complete!</h3>\r\n                                        <p className=\"text-muted-foreground mt-2\">\r\n                                            Successfully imported {excelData.length} listings to your company portfolio.\r\n                                        </p>\r\n                                    </div>\r\n                                    <Button className=\"w-full\" onClick={() => onOpenChange(false)}>Done</Button>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </ScrollArea>\r\n                </ResponsiveDialogBody>\r\n            </ResponsiveDialogContent>\r\n        </ResponsiveDialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\listings\\LocationSearchInput.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\listings\\PortalConnectionModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\listings\\PublishToPFDialog.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchExistingPublication'. Either include it or remove the dependency array.","line":91,"column":6,"nodeType":"ArrayExpression","endLine":91,"endColumn":24,"suggestions":[{"desc":"Update the dependencies array to be: [open, listing.id, fetchExistingPublication]","fix":{"range":[2608,2626],"text":"[open, listing.id, fetchExistingPublication]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":168,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":168,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4888,4891],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4888,4891],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":221,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":221,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6417,6420],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6417,6420],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":256,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":256,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7434,7437],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7434,7437],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport {\r\n  AlertCircle,\r\n  CheckCircle2,\r\n  Loader2,\r\n  ExternalLink,\r\n  Globe,\r\n  AlertTriangle,\r\n  RefreshCw,\r\n} from \"lucide-react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { toast } from \"sonner\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\ninterface PublishToPFDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  listing: {\r\n    id: string;\r\n    title: string;\r\n    reference_number?: string;\r\n    company_id?: string;\r\n  };\r\n  onSuccess?: () => void;\r\n}\r\n\r\ninterface PortalAccount {\r\n  id: string;\r\n  account_name: string;\r\n  status: string;\r\n  portal_type: string;\r\n}\r\n\r\ninterface PublicationStatus {\r\n  id: string;\r\n  status: string;\r\n  pf_listing_id: string | null;\r\n  portal_url: string | null;\r\n  published_at: string | null;\r\n  last_error_message: string | null;\r\n}\r\n\r\ninterface ValidationResult {\r\n  valid: boolean;\r\n  errors: string[];\r\n  warnings: string[];\r\n}\r\n\r\nexport function PublishToPFDialog({ open, onOpenChange, listing, onSuccess }: PublishToPFDialogProps) {\r\n  const [step, setStep] = useState<\"select\" | \"validate\" | \"publishing\" | \"result\">(\"select\");\r\n  const [portalAccounts, setPortalAccounts] = useState<PortalAccount[]>([]);\r\n  const [selectedAccount, setSelectedAccount] = useState<string>(\"\");\r\n  const [publication, setPublication] = useState<PublicationStatus | null>(null);\r\n  const [validation, setValidation] = useState<ValidationResult | null>(null);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [publishResult, setPublishResult] = useState<{ success: boolean; message: string; pf_listing_id?: string } | null>(null);\r\n  const [companyId, setCompanyId] = useState<string | null>(null);\r\n\r\n  // Fetch portal accounts on open\r\n  useEffect(() => {\r\n    if (open) {\r\n      fetchPortalAccounts();\r\n      fetchExistingPublication();\r\n    } else {\r\n      // Reset state when closed\r\n      setStep(\"select\");\r\n      setValidation(null);\r\n      setPublishResult(null);\r\n    }\r\n  }, [open, listing.id]);\r\n\r\n  const fetchPortalAccounts = async () => {\r\n    try {\r\n      // Get current user's company\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) return;\r\n\r\n      const { data: agent } = await supabase\r\n        .from(\"agents\")\r\n        .select(\"company_id\")\r\n        .eq(\"user_id\", user.id)\r\n        .single();\r\n\r\n      if (!agent?.company_id) return;\r\n      setCompanyId(agent.company_id);\r\n\r\n      // Fetch Property Finder portal accounts\r\n      const { data: accounts } = await supabase\r\n        .from(\"portal_accounts\")\r\n        .select(\"id, account_name, status, portal_type\")\r\n        .eq(\"company_id\", agent.company_id)\r\n        .eq(\"status\", \"connected\")\r\n        .or(\"portal_type.eq.property_finder,account_name.ilike.%property%finder%\");\r\n\r\n      setPortalAccounts(accounts || []);\r\n      if (accounts?.length === 1) {\r\n        setSelectedAccount(accounts[0].id);\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Error fetching portal accounts:\", err);\r\n    }\r\n  };\r\n\r\n  const fetchExistingPublication = async () => {\r\n    try {\r\n      const { data } = await supabase\r\n        .from(\"portal_listing_publications\")\r\n        .select(\"id, status, pf_listing_id, portal_url, published_at, last_error_message\")\r\n        .eq(\"listing_id\", listing.id)\r\n        .not(\"pf_listing_id\", \"is\", null)\r\n        .single();\r\n\r\n      setPublication(data);\r\n    } catch {\r\n      // No existing publication\r\n      setPublication(null);\r\n    }\r\n  };\r\n\r\n  const handleValidate = async () => {\r\n    if (!selectedAccount || !companyId) return;\r\n\r\n    setIsLoading(true);\r\n    try {\r\n      const { data: { session } } = await supabase.auth.getSession();\r\n      if (!session) {\r\n        toast.error(\"Please log in to continue\");\r\n        return;\r\n      }\r\n\r\n      const response = await supabase.functions.invoke(\"pf-publish\", {\r\n        body: {\r\n          action: \"validate\",\r\n          listing_id: listing.id,\r\n          portal_account_id: selectedAccount,\r\n          company_id: companyId,\r\n        },\r\n      });\r\n\r\n      if (response.error) {\r\n        toast.error(response.error.message || \"Validation failed\");\r\n        return;\r\n      }\r\n\r\n      setValidation(response.data.validation);\r\n      setStep(\"validate\");\r\n    } catch (err: any) {\r\n      toast.error(err.message || \"Failed to validate listing\");\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const handlePublish = async () => {\r\n    if (!selectedAccount || !companyId) return;\r\n\r\n    setStep(\"publishing\");\r\n    setIsLoading(true);\r\n    \r\n    try {\r\n      const { data: { session } } = await supabase.auth.getSession();\r\n      if (!session) {\r\n        toast.error(\"Please log in to continue\");\r\n        setStep(\"validate\");\r\n        return;\r\n      }\r\n\r\n      const action = publication?.pf_listing_id ? \"update\" : \"publish\";\r\n\r\n      const response = await supabase.functions.invoke(\"pf-publish\", {\r\n        body: {\r\n          action,\r\n          listing_id: listing.id,\r\n          portal_account_id: selectedAccount,\r\n          company_id: companyId,\r\n        },\r\n      });\r\n\r\n      if (response.error) {\r\n        setPublishResult({\r\n          success: false,\r\n          message: response.error.message || \"Publishing failed\",\r\n        });\r\n      } else if (response.data?.success) {\r\n        setPublishResult({\r\n          success: true,\r\n          message: response.data.message || \"Listing published successfully!\",\r\n          pf_listing_id: response.data.pf_listing_id,\r\n        });\r\n        toast.success(\"Listing published to Property Finder!\");\r\n        onSuccess?.();\r\n      } else {\r\n        setPublishResult({\r\n          success: false,\r\n          message: response.data?.error || \"Publishing failed\",\r\n        });\r\n      }\r\n      \r\n      setStep(\"result\");\r\n    } catch (err: any) {\r\n      setPublishResult({\r\n        success: false,\r\n        message: err.message || \"Failed to publish listing\",\r\n      });\r\n      setStep(\"result\");\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleUnpublish = async () => {\r\n    if (!selectedAccount || !companyId) return;\r\n\r\n    setIsLoading(true);\r\n    try {\r\n      const response = await supabase.functions.invoke(\"pf-publish\", {\r\n        body: {\r\n          action: \"unpublish\",\r\n          listing_id: listing.id,\r\n          portal_account_id: selectedAccount,\r\n          company_id: companyId,\r\n        },\r\n      });\r\n\r\n      if (response.error) {\r\n        toast.error(response.error.message || \"Failed to unpublish\");\r\n      } else if (response.data?.success) {\r\n        toast.success(\"Listing unpublished from Property Finder\");\r\n        setPublication(null);\r\n        onSuccess?.();\r\n        onOpenChange(false);\r\n      } else {\r\n        toast.error(response.data?.error || \"Failed to unpublish\");\r\n      }\r\n    } catch (err: any) {\r\n      toast.error(err.message || \"Failed to unpublish listing\");\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const renderSelectStep = () => (\r\n    <>\r\n      <DialogHeader>\r\n        <DialogTitle className=\"flex items-center gap-2\">\r\n          <Globe className=\"h-5 w-5 text-primary\" />\r\n          Publish to Property Finder\r\n        </DialogTitle>\r\n        <DialogDescription>\r\n          Publish \"{listing.title}\" to Property Finder portal\r\n        </DialogDescription>\r\n      </DialogHeader>\r\n\r\n      <div className=\"space-y-4 py-4\">\r\n        {publication && (\r\n          <Alert className={cn(\r\n            publication.status === \"live\" ? \"border-emerald-500 bg-emerald-50 dark:bg-emerald-950\" : \r\n            publication.status === \"rejected\" ? \"border-red-500 bg-red-50 dark:bg-red-950\" : \"\"\r\n          )}>\r\n            <CheckCircle2 className={cn(\r\n              \"h-4 w-4\",\r\n              publication.status === \"live\" ? \"text-emerald-600\" : \r\n              publication.status === \"rejected\" ? \"text-red-600\" : \"text-muted-foreground\"\r\n            )} />\r\n            <AlertDescription className=\"flex items-center justify-between\">\r\n              <div>\r\n                <span className=\"font-medium\">\r\n                  {publication.status === \"live\" ? \"Published on Property Finder\" : \r\n                   publication.status === \"rejected\" ? \"Rejected by Property Finder\" :\r\n                   `Status: ${publication.status}`}\r\n                </span>\r\n                {publication.pf_listing_id && (\r\n                  <span className=\"text-sm text-muted-foreground ml-2\">\r\n                    (ID: {publication.pf_listing_id})\r\n                  </span>\r\n                )}\r\n                {publication.last_error_message && (\r\n                  <p className=\"text-sm text-red-600 mt-1\">{publication.last_error_message}</p>\r\n                )}\r\n              </div>\r\n              {publication.portal_url && (\r\n                <Button variant=\"outline\" size=\"sm\" asChild>\r\n                  <a href={publication.portal_url} target=\"_blank\" rel=\"noopener noreferrer\">\r\n                    <ExternalLink className=\"h-4 w-4 mr-1\" />\r\n                    View\r\n                  </a>\r\n                </Button>\r\n              )}\r\n            </AlertDescription>\r\n          </Alert>\r\n        )}\r\n\r\n        {portalAccounts.length === 0 ? (\r\n          <Alert variant=\"destructive\">\r\n            <AlertCircle className=\"h-4 w-4\" />\r\n            <AlertDescription>\r\n              No Property Finder account connected. Please configure your Property Finder API credentials in Portal Settings first.\r\n            </AlertDescription>\r\n          </Alert>\r\n        ) : (\r\n          <div className=\"space-y-3\">\r\n            <Label>Property Finder Account</Label>\r\n            <Select value={selectedAccount} onValueChange={setSelectedAccount}>\r\n              <SelectTrigger>\r\n                <SelectValue placeholder=\"Select account\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                {portalAccounts.map((account) => (\r\n                  <SelectItem key={account.id} value={account.id}>\r\n                    {account.account_name}\r\n                    <Badge variant=\"outline\" className=\"ml-2 text-xs\">\r\n                      {account.status}\r\n                    </Badge>\r\n                  </SelectItem>\r\n                ))}\r\n              </SelectContent>\r\n            </Select>\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"bg-muted/50 rounded-lg p-4 text-sm space-y-2\">\r\n          <p className=\"font-medium\">Before publishing, ensure:</p>\r\n          <ul className=\"list-disc list-inside text-muted-foreground space-y-1\">\r\n            <li>Listing has at least 1 image (5+ recommended)</li>\r\n            <li>Description is at least 100 characters</li>\r\n            <li>RERA/Permit number is set (required for Dubai)</li>\r\n            <li>Assigned agent is mapped to Property Finder</li>\r\n          </ul>\r\n        </div>\r\n      </div>\r\n\r\n      <DialogFooter className=\"flex-col sm:flex-row gap-2\">\r\n        {publication?.status === \"live\" && (\r\n          <Button \r\n            variant=\"destructive\" \r\n            onClick={handleUnpublish}\r\n            disabled={isLoading || !selectedAccount}\r\n          >\r\n            {isLoading && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\r\n            Unpublish\r\n          </Button>\r\n        )}\r\n        <Button variant=\"outline\" onClick={() => onOpenChange(false)}>\r\n          Cancel\r\n        </Button>\r\n        <Button \r\n          onClick={handleValidate} \r\n          disabled={isLoading || !selectedAccount || portalAccounts.length === 0}\r\n        >\r\n          {isLoading && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\r\n          {publication?.pf_listing_id ? \"Validate & Update\" : \"Validate & Publish\"}\r\n        </Button>\r\n      </DialogFooter>\r\n    </>\r\n  );\r\n\r\n  const renderValidateStep = () => (\r\n    <>\r\n      <DialogHeader>\r\n        <DialogTitle>Validation Results</DialogTitle>\r\n        <DialogDescription>\r\n          Review the validation results before publishing\r\n        </DialogDescription>\r\n      </DialogHeader>\r\n\r\n      <div className=\"space-y-4 py-4\">\r\n        {validation?.errors && validation.errors.length > 0 && (\r\n          <Alert variant=\"destructive\">\r\n            <AlertCircle className=\"h-4 w-4\" />\r\n            <AlertDescription>\r\n              <p className=\"font-medium mb-2\">Errors (must fix):</p>\r\n              <ul className=\"list-disc list-inside space-y-1\">\r\n                {validation.errors.map((error, i) => (\r\n                  <li key={i}>{error}</li>\r\n                ))}\r\n              </ul>\r\n            </AlertDescription>\r\n          </Alert>\r\n        )}\r\n\r\n        {validation?.warnings && validation.warnings.length > 0 && (\r\n          <Alert className=\"border-amber-500 bg-amber-50 dark:bg-amber-950\">\r\n            <AlertTriangle className=\"h-4 w-4 text-amber-600\" />\r\n            <AlertDescription>\r\n              <p className=\"font-medium mb-2 text-amber-800 dark:text-amber-200\">Warnings (recommended to fix):</p>\r\n              <ul className=\"list-disc list-inside space-y-1 text-amber-700 dark:text-amber-300\">\r\n                {validation.warnings.map((warning, i) => (\r\n                  <li key={i}>{warning}</li>\r\n                ))}\r\n              </ul>\r\n            </AlertDescription>\r\n          </Alert>\r\n        )}\r\n\r\n        {validation?.valid && (\r\n          <Alert className=\"border-emerald-500 bg-emerald-50 dark:bg-emerald-950\">\r\n            <CheckCircle2 className=\"h-4 w-4 text-emerald-600\" />\r\n            <AlertDescription className=\"text-emerald-800 dark:text-emerald-200\">\r\n              Listing is ready to be published to Property Finder!\r\n            </AlertDescription>\r\n          </Alert>\r\n        )}\r\n      </div>\r\n\r\n      <DialogFooter className=\"flex-col sm:flex-row gap-2\">\r\n        <Button variant=\"outline\" onClick={() => setStep(\"select\")}>\r\n          Back\r\n        </Button>\r\n        <Button \r\n          onClick={handlePublish} \r\n          disabled={!validation?.valid}\r\n        >\r\n          {publication?.pf_listing_id ? \"Update on Property Finder\" : \"Publish to Property Finder\"}\r\n        </Button>\r\n      </DialogFooter>\r\n    </>\r\n  );\r\n\r\n  const renderPublishingStep = () => (\r\n    <>\r\n      <DialogHeader>\r\n        <DialogTitle>Publishing to Property Finder</DialogTitle>\r\n      </DialogHeader>\r\n\r\n      <div className=\"flex flex-col items-center justify-center py-8 space-y-4\">\r\n        <Loader2 className=\"h-12 w-12 animate-spin text-primary\" />\r\n        <p className=\"text-muted-foreground\">\r\n          {publication?.pf_listing_id ? \"Updating listing...\" : \"Creating and publishing listing...\"}\r\n        </p>\r\n        <p className=\"text-xs text-muted-foreground\">\r\n          This may take a few seconds\r\n        </p>\r\n      </div>\r\n    </>\r\n  );\r\n\r\n  const renderResultStep = () => (\r\n    <>\r\n      <DialogHeader>\r\n        <DialogTitle>\r\n          {publishResult?.success ? \"Published Successfully\" : \"Publishing Failed\"}\r\n        </DialogTitle>\r\n      </DialogHeader>\r\n\r\n      <div className=\"py-6\">\r\n        {publishResult?.success ? (\r\n          <Alert className=\"border-emerald-500 bg-emerald-50 dark:bg-emerald-950\">\r\n            <CheckCircle2 className=\"h-4 w-4 text-emerald-600\" />\r\n            <AlertDescription className=\"text-emerald-800 dark:text-emerald-200\">\r\n              <p className=\"font-medium\">{publishResult.message}</p>\r\n              {publishResult.pf_listing_id && (\r\n                <p className=\"text-sm mt-1\">Property Finder ID: {publishResult.pf_listing_id}</p>\r\n              )}\r\n            </AlertDescription>\r\n          </Alert>\r\n        ) : (\r\n          <Alert variant=\"destructive\">\r\n            <AlertCircle className=\"h-4 w-4\" />\r\n            <AlertDescription>\r\n              {publishResult?.message || \"An error occurred while publishing\"}\r\n            </AlertDescription>\r\n          </Alert>\r\n        )}\r\n      </div>\r\n\r\n      <DialogFooter>\r\n        <Button onClick={() => onOpenChange(false)}>\r\n          Close\r\n        </Button>\r\n        {!publishResult?.success && (\r\n          <Button variant=\"outline\" onClick={() => setStep(\"select\")}>\r\n            <RefreshCw className=\"h-4 w-4 mr-2\" />\r\n            Try Again\r\n          </Button>\r\n        )}\r\n      </DialogFooter>\r\n    </>\r\n  );\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"max-w-lg\">\r\n        {step === \"select\" && renderSelectStep()}\r\n        {step === \"validate\" && renderValidateStep()}\r\n        {step === \"publishing\" && renderPublishingStep()}\r\n        {step === \"result\" && renderResultStep()}\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\listings\\PublishToPortalsDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing-hub\\CampaignStepIndicator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing-hub\\steps\\AudienceStep.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing-hub\\steps\\CampaignTypeStep.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing-hub\\steps\\ChannelStep.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing-hub\\steps\\ConnectionStep.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'onSelect' and 'selectedConnectionId'. Either include them or remove the dependency array. If 'onSelect' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":150,"column":6,"nodeType":"ArrayExpression","endLine":150,"endColumn":34,"suggestions":[{"desc":"Update the dependencies array to be: [session.user.id, channel, selectedConnectionId, onSelect]","fix":{"range":[5210,5238],"text":"[session.user.id, channel, selectedConnectionId, onSelect]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":235,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":235,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8198,8201],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8198,8201],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":291,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":291,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9898,9901],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9898,9901],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":336,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":336,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11499,11502],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11499,11502],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":477,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":477,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17634,17637],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17634,17637],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport {\r\n  Plus, CheckCircle2, XCircle, AlertCircle, RefreshCw,\r\n  ExternalLink, Phone, Mail, MessageSquare, Loader2\r\n} from 'lucide-react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card, CardContent } from '@/components/ui/card';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { cn } from '@/lib/utils';\r\nimport { CampaignChannel } from '../types';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogDescription,\r\n} from '@/components/ui/dialog';\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { toast } from 'sonner';\r\n\r\ninterface ConnectionStepProps {\r\n  channel: CampaignChannel;\r\n  selectedConnectionId?: string;\r\n  onSelect: (connectionId: string) => void;\r\n  isRTL?: boolean;\r\n}\r\n\r\ninterface MarketingConnection {\r\n  id: string;\r\n  channel: string;\r\n  provider: string;\r\n  display_name: string;\r\n  identifier: string;\r\n  status: string;\r\n  verified: boolean;\r\n  health_status: string;\r\n  last_sync: string;\r\n}\r\n\r\nconst PROVIDER_CONFIGS: Record<string, { fields: { key: string; label: string; type: string; placeholder: string }[] }> = {\r\n  meta: {\r\n    fields: [\r\n      { key: 'phoneNumberId', label: 'Phone Number ID', type: 'text', placeholder: '123456789012345' },\r\n      { key: 'accessToken', label: 'Access Token', type: 'password', placeholder: 'EAAxxxxxxx...' },\r\n      { key: 'businessId', label: 'Business ID', type: 'text', placeholder: '123456789012345' },\r\n      { key: 'phoneNumber', label: 'Phone Number', type: 'tel', placeholder: '+971501234567' },\r\n    ]\r\n  },\r\n  twilio: {\r\n    fields: [\r\n      { key: 'accountSid', label: 'Account SID', type: 'text', placeholder: 'ACxxxxxxx...' },\r\n      { key: 'authToken', label: 'Auth Token', type: 'password', placeholder: 'xxxxxxx...' },\r\n      { key: 'phoneNumber', label: 'Phone Number', type: 'tel', placeholder: '+14155238886' },\r\n    ]\r\n  },\r\n  resend: {\r\n    fields: [\r\n      { key: 'apiKey', label: 'API Key', type: 'password', placeholder: 're_xxxxxxx...' },\r\n      { key: 'email', label: 'Sender Email', type: 'email', placeholder: 'campaigns@yourcompany.com' },\r\n      { key: 'domain', label: 'Verified Domain', type: 'text', placeholder: 'yourcompany.com' },\r\n    ]\r\n  },\r\n  sendgrid: {\r\n    fields: [\r\n      { key: 'apiKey', label: 'API Key', type: 'password', placeholder: 'SG.xxxxxxx...' },\r\n      { key: 'email', label: 'Sender Email', type: 'email', placeholder: 'campaigns@yourcompany.com' },\r\n    ]\r\n  },\r\n  messagebird: {\r\n    fields: [\r\n      { key: 'apiKey', label: 'API Key', type: 'password', placeholder: 'xxxxxxx...' },\r\n      { key: 'phoneNumber', label: 'Phone Number', type: 'tel', placeholder: '+31612345678' },\r\n    ]\r\n  },\r\n  vonage: {\r\n    fields: [\r\n      { key: 'apiKey', label: 'API Key', type: 'text', placeholder: 'xxxxxxx' },\r\n      { key: 'apiSecret', label: 'API Secret', type: 'password', placeholder: 'xxxxxxx...' },\r\n      { key: 'phoneNumber', label: 'Phone Number', type: 'tel', placeholder: '+14155238886' },\r\n    ]\r\n  },\r\n};\r\n\r\nexport function ConnectionStep({\r\n  channel,\r\n  selectedConnectionId,\r\n  onSelect,\r\n  isRTL = false\r\n}: ConnectionStepProps) {\r\n  const { session } = useAuth();\r\n  const [connections, setConnections] = useState<MarketingConnection[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [companyId, setCompanyId] = useState<string | null>(null);\r\n\r\n  const [showConnectDialog, setShowConnectDialog] = useState(false);\r\n  const [connecting, setConnecting] = useState(false);\r\n  const [selectedProvider, setSelectedProvider] = useState<string>('');\r\n  const [formData, setFormData] = useState<Record<string, string>>({});\r\n  const [testing, setTesting] = useState<string | null>(null);\r\n\r\n  // Fetch company ID and connections\r\n  useEffect(() => {\r\n    const fetchData = async () => {\r\n      if (!session?.user?.id) return;\r\n\r\n      setIsLoading(true);\r\n\r\n      // Get company ID\r\n      const { data: agent } = await supabase\r\n        .from('agents')\r\n        .select('company_id')\r\n        .eq('user_id', session.user.id)\r\n        .single();\r\n\r\n      if (agent?.company_id) {\r\n        setCompanyId(agent.company_id);\r\n\r\n        // Fetch connections for this channel\r\n        const { data: conns, error } = await supabase\r\n          .from('marketing_connections')\r\n          .select('id, channel, provider, display_name, identifier, status, verified, health_status, last_sync')\r\n          .eq('company_id', agent.company_id)\r\n          .eq('channel', channel)\r\n          .order('created_at', { ascending: false });\r\n\r\n        if (!error && conns) {\r\n          setConnections(conns as MarketingConnection[]);\r\n\r\n          // Auto-select first connection if none selected\r\n          if (!selectedConnectionId && conns.length > 0) {\r\n            onSelect(conns[0].id);\r\n          }\r\n        }\r\n      }\r\n\r\n      setIsLoading(false);\r\n    };\r\n\r\n    fetchData();\r\n  }, [session?.user?.id, channel]);\r\n\r\n  const getStatusIcon = (status: string) => {\r\n    switch (status) {\r\n      case 'connected':\r\n        return <CheckCircle2 className=\"h-4 w-4 text-green-500\" />;\r\n      case 'error':\r\n        return <XCircle className=\"h-4 w-4 text-destructive\" />;\r\n      default:\r\n        return <AlertCircle className=\"h-4 w-4 text-amber-500\" />;\r\n    }\r\n  };\r\n\r\n  const getStatusBadge = (status: string) => {\r\n    const styles = {\r\n      connected: 'bg-green-500/10 text-green-600 border-green-500/20',\r\n      disconnected: 'bg-muted text-muted-foreground border-muted',\r\n      error: 'bg-destructive/10 text-destructive border-destructive/20',\r\n    };\r\n    return styles[status as keyof typeof styles] || styles.disconnected;\r\n  };\r\n\r\n  const getChannelIcon = () => {\r\n    switch (channel) {\r\n      case 'whatsapp': return <Phone className=\"h-6 w-6 text-green-600\" />;\r\n      case 'email': return <Mail className=\"h-6 w-6 text-blue-600\" />;\r\n      case 'sms': return <MessageSquare className=\"h-6 w-6 text-purple-600\" />;\r\n    }\r\n  };\r\n\r\n  const getProviderOptions = () => {\r\n    switch (channel) {\r\n      case 'whatsapp':\r\n        return [\r\n          { value: 'meta', label: 'WhatsApp Business (Official)', icon: 'ðŸ“±', hasEmbeddedSignup: true },\r\n          { value: 'twilio', label: 'Twilio', icon: 'ðŸ”´' },\r\n          { value: '360dialog', label: '360dialog', icon: 'ðŸ”µ' },\r\n          { value: 'vonage', label: 'Vonage', icon: 'ðŸŸ£' },\r\n        ];\r\n      case 'email':\r\n        return [\r\n          { value: 'resend', label: 'Resend', icon: 'ðŸ“§' },\r\n          { value: 'sendgrid', label: 'SendGrid', icon: 'ðŸ’™' },\r\n          { value: 'mailgun', label: 'Mailgun', icon: 'ðŸ“¬' },\r\n          { value: 'ses', label: 'Amazon SES', icon: 'â˜ï¸' },\r\n        ];\r\n      case 'sms':\r\n        return [\r\n          { value: 'twilio', label: 'Twilio', icon: 'ðŸ”´' },\r\n          { value: 'messagebird', label: 'MessageBird', icon: 'ðŸ¦' },\r\n          { value: 'vonage', label: 'Vonage', icon: 'ðŸŸ£' },\r\n          { value: 'plivo', label: 'Plivo', icon: 'ðŸŸ¢' },\r\n        ];\r\n    }\r\n  };\r\n\r\n  const handleMetaEmbeddedSignup = async () => {\r\n    if (!companyId) {\r\n      toast.error(isRTL ? 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ©' : 'Company not found');\r\n      return;\r\n    }\r\n\r\n    setConnecting(true);\r\n\r\n    try {\r\n      const redirectUri = window.location.origin + '/connections?source=whatsapp';\r\n\r\n      const { data, error } = await supabase.functions.invoke('whatsapp-embedded-signup', {\r\n        body: {\r\n          action: 'init',\r\n          company_id: companyId,\r\n          redirect_uri: redirectUri,\r\n        },\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      if (data?.authUrl) {\r\n        // Open Meta OAuth in a new window\r\n        window.open(data.authUrl, '_blank', 'width=600,height=700');\r\n        toast.info(isRTL\r\n          ? 'ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±Ø¨Ø· ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©'\r\n          : 'Please complete the connection in the popup window'\r\n        );\r\n      }\r\n    } catch (err: any) {\r\n      console.error('Embedded signup error:', err);\r\n      toast.error(isRTL ? 'ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±Ø¨Ø·' : 'Failed to start connection process');\r\n    } finally {\r\n      setConnecting(false);\r\n      setShowConnectDialog(false);\r\n    }\r\n  };\r\n\r\n  const handleManualConnect = async () => {\r\n    if (!companyId) {\r\n      toast.error(isRTL ? 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ©' : 'Company not found');\r\n      return;\r\n    }\r\n\r\n    setConnecting(true);\r\n\r\n    try {\r\n      const identifier = formData.phoneNumber || formData.email || 'New Connection';\r\n      const displayName = formData.displayName || identifier;\r\n\r\n      const credentials: Record<string, string> = {};\r\n      const config = PROVIDER_CONFIGS[selectedProvider];\r\n      if (config) {\r\n        for (const field of config.fields) {\r\n          if (formData[field.key]) {\r\n            credentials[field.key] = formData[field.key];\r\n          }\r\n        }\r\n      }\r\n\r\n      const { data: newConn, error } = await supabase\r\n        .from('marketing_connections')\r\n        .insert({\r\n          company_id: companyId,\r\n          channel,\r\n          provider: selectedProvider,\r\n          display_name: displayName,\r\n          identifier,\r\n          status: 'connected',\r\n          credentials,\r\n          verified: false,\r\n          health_status: 'unknown',\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      setConnections(prev => [newConn as MarketingConnection, ...prev]);\r\n      onSelect(newConn.id);\r\n\r\n      toast.success(isRTL ? 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­' : 'Connection added successfully');\r\n      setShowConnectDialog(false);\r\n      setFormData({});\r\n      setSelectedProvider('');\r\n    } catch (err: any) {\r\n      console.error('Connect error:', err);\r\n      toast.error(isRTL ? 'ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§ØªØµØ§Ù„' : 'Failed to add connection');\r\n    } finally {\r\n      setConnecting(false);\r\n    }\r\n  };\r\n\r\n  const handleTestConnection = async (connectionId: string) => {\r\n    setTesting(connectionId);\r\n\r\n    try {\r\n      const connection = connections.find(c => c.id === connectionId);\r\n      if (!connection) return;\r\n\r\n      if (connection.provider === 'meta' && channel === 'whatsapp') {\r\n        const { data, error } = await supabase.functions.invoke('whatsapp-embedded-signup', {\r\n          body: { action: 'test', connection_id: connectionId },\r\n        });\r\n\r\n        if (error || !data?.success) {\r\n          toast.error(data?.error || (isRTL ? 'ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 'Test failed'));\r\n          return;\r\n        }\r\n\r\n        toast.success(isRTL\r\n          ? `Ø§Ù„Ø§ØªØµØ§Ù„ ÙŠØ¹Ù…Ù„: ${data.verified_name || data.phone_number}`\r\n          : `Connection working: ${data.verified_name || data.phone_number}`\r\n        );\r\n\r\n        // Refresh connections\r\n        const { data: updated } = await supabase\r\n          .from('marketing_connections')\r\n          .select('*')\r\n          .eq('id', connectionId)\r\n          .single();\r\n\r\n        if (updated) {\r\n          setConnections(prev => prev.map(c => c.id === connectionId ? updated as MarketingConnection : c));\r\n        }\r\n      } else {\r\n        // Simulate test for other providers\r\n        await new Promise(resolve => setTimeout(resolve, 1500));\r\n        toast.success(isRTL ? 'Ø§Ù„Ø§ØªØµØ§Ù„ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­' : 'Connection is working properly');\r\n      }\r\n    } catch (err: any) {\r\n      toast.error(isRTL ? 'ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„' : 'Connection test failed');\r\n    } finally {\r\n      setTesting(null);\r\n    }\r\n  };\r\n\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center py-12\">\r\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className={cn(\"text-center\", isRTL && \"font-arabic\")}>\r\n        <h2 className=\"text-xl font-bold text-foreground mb-2\">\r\n          {isRTL ? 'Ø§Ø®ØªØ± Ø§Ù„Ø§ØªØµØ§Ù„' : 'Select Connection'}\r\n        </h2>\r\n        <p className=\"text-muted-foreground\">\r\n          {isRTL\r\n            ? 'Ø§Ø®ØªØ± Ø£Ùˆ Ø£Ø¶Ù Ø§ØªØµØ§Ù„Ø§Ù‹ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø­Ù…Ù„ØªÙƒ'\r\n            : 'Choose or add a connection to send your campaign'}\r\n        </p>\r\n      </div>\r\n\r\n      {connections.length > 0 ? (\r\n        <div className=\"grid gap-4\">\r\n          {connections.map((connection) => {\r\n            const isSelected = selectedConnectionId === connection.id;\r\n\r\n            return (\r\n              <Card\r\n                key={connection.id}\r\n                onClick={() => onSelect(connection.id)}\r\n                className={cn(\r\n                  \"cursor-pointer transition-all border-2\",\r\n                  isSelected\r\n                    ? \"ring-2 ring-primary ring-offset-2 border-primary shadow-lg\"\r\n                    : \"border-border/50 hover:border-primary/50 hover:shadow-md\"\r\n                )}\r\n              >\r\n                <CardContent className=\"p-4\">\r\n                  <div className={cn(\"flex items-center justify-between gap-4\", isRTL && \"flex-row-reverse\")}>\r\n                    <div className={cn(\"flex items-center gap-3\", isRTL && \"flex-row-reverse\")}>\r\n                      <div className=\"w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center\">\r\n                        {getChannelIcon()}\r\n                      </div>\r\n                      <div className={isRTL ? \"text-right\" : \"\"}>\r\n                        <div className={cn(\"flex items-center gap-2\", isRTL && \"flex-row-reverse\")}>\r\n                          <span className=\"font-semibold\">{connection.display_name || connection.identifier}</span>\r\n                          {getStatusIcon(connection.status)}\r\n                        </div>\r\n                        <div className={cn(\"flex items-center gap-2 mt-1\", isRTL && \"flex-row-reverse\")}>\r\n                          <Badge variant=\"outline\" className=\"text-xs\">\r\n                            {connection.provider.toUpperCase()}\r\n                          </Badge>\r\n                          <Badge variant=\"outline\" className={cn(\"text-xs\", getStatusBadge(connection.status))}>\r\n                            {connection.status}\r\n                          </Badge>\r\n                          {connection.verified && (\r\n                            <Badge variant=\"outline\" className=\"text-xs bg-blue-500/10 text-blue-600 border-blue-500/20\">\r\n                              {isRTL ? 'Ù…ÙˆØ«Ù‚' : 'Verified'}\r\n                            </Badge>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                    <Button\r\n                      variant=\"ghost\"\r\n                      size=\"sm\"\r\n                      onClick={(e) => {\r\n                        e.stopPropagation();\r\n                        handleTestConnection(connection.id);\r\n                      }}\r\n                      disabled={testing === connection.id}\r\n                    >\r\n                      {testing === connection.id ? (\r\n                        <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n                      ) : (\r\n                        <RefreshCw className=\"h-4 w-4\" />\r\n                      )}\r\n                    </Button>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n            );\r\n          })}\r\n        </div>\r\n      ) : (\r\n        <Card className=\"border-dashed\">\r\n          <CardContent className=\"flex flex-col items-center justify-center py-12 text-center\">\r\n            {getChannelIcon()}\r\n            <h3 className=\"font-semibold mt-4\">\r\n              {isRTL ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„Ø§Øª' : 'No connections'}\r\n            </h3>\r\n            <p className=\"text-sm text-muted-foreground mt-1\">\r\n              {isRTL ? 'Ø£Ø¶Ù Ø§ØªØµØ§Ù„Ø§Ù‹ Ù„Ø¨Ø¯Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ù…Ù„Ø§Øª' : 'Add a connection to start sending campaigns'}\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      <Button\r\n        variant=\"outline\"\r\n        className=\"w-full\"\r\n        onClick={() => setShowConnectDialog(true)}\r\n      >\r\n        <Plus className=\"h-4 w-4 mr-2\" />\r\n        {isRTL ? 'Ø¥Ø¶Ø§ÙØ© Ø§ØªØµØ§Ù„ Ø¬Ø¯ÙŠØ¯' : 'Add New Connection'}\r\n      </Button>\r\n\r\n      {/* Add Connection Dialog */}\r\n      <Dialog open={showConnectDialog} onOpenChange={setShowConnectDialog}>\r\n        <DialogContent className=\"max-w-md\">\r\n          <DialogHeader>\r\n            <DialogTitle className={isRTL ? \"text-right\" : \"\"}>\r\n              {isRTL ? 'Ø¥Ø¶Ø§ÙØ© Ø§ØªØµØ§Ù„ Ø¬Ø¯ÙŠØ¯' : 'Add New Connection'}\r\n            </DialogTitle>\r\n            <DialogDescription className={isRTL ? \"text-right\" : \"\"}>\r\n              {isRTL\r\n                ? 'Ø§Ø®ØªØ± Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø© ÙˆØ£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯'\r\n                : 'Select a provider and enter your credentials'}\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n\r\n          <div className=\"space-y-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label>{isRTL ? 'Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©' : 'Provider'}</Label>\r\n              <Select value={selectedProvider} onValueChange={setSelectedProvider}>\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder={isRTL ? 'Ø§Ø®ØªØ± Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©' : 'Select provider'} />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {getProviderOptions()?.map((provider) => (\r\n                    <SelectItem key={provider.value} value={provider.value}>\r\n                      <span className=\"flex items-center gap-2\">\r\n                        <span>{provider.icon}</span>\r\n                        <span>{provider.label}</span>\r\n                        {(provider as any).hasEmbeddedSignup && (\r\n                          <Badge variant=\"secondary\" className=\"text-xs ml-2\">Recommended</Badge>\r\n                        )}\r\n                      </span>\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n\r\n            {selectedProvider === 'meta' && channel === 'whatsapp' ? (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"p-4 bg-muted/50 rounded-lg text-sm text-muted-foreground\">\r\n                  {isRTL\r\n                    ? 'Ø§Ù†Ù‚Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ø±Ø¨Ø· Ø±Ù‚Ù… WhatsApp Business Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¹Ø¨Ø± Meta. Ø³ÙŠØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.'\r\n                    : 'Click below to connect your WhatsApp Business number via Meta. A new window will open to complete the process.'}\r\n                </div>\r\n                <Button\r\n                  className=\"w-full\"\r\n                  onClick={handleMetaEmbeddedSignup}\r\n                  disabled={connecting}\r\n                >\r\n                  {connecting ? (\r\n                    <><Loader2 className=\"h-4 w-4 animate-spin mr-2\" />{isRTL ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±Ø¨Ø·...' : 'Connecting...'}</>\r\n                  ) : (\r\n                    <><ExternalLink className=\"h-4 w-4 mr-2\" />{isRTL ? 'Ø±Ø¨Ø· Ø¹Ø¨Ø± Meta' : 'Connect with Meta'}</>\r\n                  )}\r\n                </Button>\r\n              </div>\r\n            ) : selectedProvider && PROVIDER_CONFIGS[selectedProvider] ? (\r\n              <div className=\"space-y-4\">\r\n                {PROVIDER_CONFIGS[selectedProvider].fields.map((field) => (\r\n                  <div key={field.key} className=\"space-y-2\">\r\n                    <Label>{field.label}</Label>\r\n                    <Input\r\n                      type={field.type}\r\n                      placeholder={field.placeholder}\r\n                      value={formData[field.key] || ''}\r\n                      onChange={(e) => setFormData({ ...formData, [field.key]: e.target.value })}\r\n                    />\r\n                  </div>\r\n                ))}\r\n                <Button\r\n                  className=\"w-full\"\r\n                  onClick={handleManualConnect}\r\n                  disabled={connecting}\r\n                >\r\n                  {connecting ? (\r\n                    <><Loader2 className=\"h-4 w-4 animate-spin mr-2\" />{isRTL ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±Ø¨Ø·...' : 'Connecting...'}</>\r\n                  ) : (\r\n                    isRTL ? 'Ø±Ø¨Ø·' : 'Connect'\r\n                  )}\r\n                </Button>\r\n              </div>\r\n            ) : null}\r\n          </div>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing-hub\\steps\\ReviewStep.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing-hub\\steps\\ScheduleStep.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing-hub\\steps\\TemplateStep.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing-hub\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing\\CampaignCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing\\CampaignDetailsDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing\\CampaignFilters.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing\\CampaignStats.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing\\CreateCampaignDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":292,"column":93,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":292,"endColumn":96,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11109,11112],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11109,11112],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport {\r\n  Mail,\r\n  MessageSquare,\r\n  Phone,\r\n  Layers,\r\n  Calendar,\r\n  Clock,\r\n  Users,\r\n  Upload,\r\n  Send,\r\n  Save,\r\n  Eye,\r\n  Smartphone,\r\n  Monitor,\r\n  ChevronRight,\r\n  Sparkles,\r\n  FileText,\r\n  X,\r\n  Link2,\r\n  Check,\r\n  AlertCircle,\r\n  Plus,\r\n  Trash2,\r\n} from \"lucide-react\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { Switch } from \"@/components/ui/switch\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { Calendar as CalendarComponent } from \"@/components/ui/calendar\";\r\nimport {\r\n  Popover,\r\n  PopoverContent,\r\n  PopoverTrigger,\r\n} from \"@/components/ui/popover\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { format } from \"date-fns\";\r\nimport { Campaign } from \"./CampaignCard\";\r\nimport { MetaConnectDialog, WhatsAppConnection } from \"./MetaConnectDialog\";\r\nimport { SMSProviderDialog, SMSConnection } from \"./SMSProviderDialog\";\r\nimport { EmailSenderDialog, EmailConnection } from \"./EmailSenderDialog\";\r\nimport { WhatsAppTemplateManager, WhatsAppTemplate } from \"./WhatsAppTemplateManager\";\r\n\r\ninterface CreateCampaignDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  campaign?: Campaign | null;\r\n  onSave: (campaign: Partial<Campaign>) => void;\r\n}\r\n\r\nconst campaignTypes = [\r\n  { value: \"email\", label: \"Email\", icon: Mail, description: \"Send rich HTML emails\" },\r\n  { value: \"sms\", label: \"SMS\", icon: MessageSquare, description: \"Short text messages\" },\r\n  { value: \"whatsapp\", label: \"WhatsApp\", icon: Phone, description: \"WhatsApp messages\" },\r\n  { value: \"multi-channel\", label: \"Multi-channel\", icon: Layers, description: \"Combine multiple channels\" },\r\n];\r\n\r\nconst segments = [\r\n  \"All Leads\",\r\n  \"New Leads (Last 7 days)\",\r\n  \"Hot Leads\",\r\n  \"Cold Leads\",\r\n  \"Property Finder Leads\",\r\n  \"Website Inquiries\",\r\n  \"Follow-up Required\",\r\n  \"Meeting Scheduled\",\r\n];\r\n\r\nconst dynamicFields = [\r\n  { label: \"Client Name\", value: \"{{client_name}}\" },\r\n  { label: \"Property Name\", value: \"{{property_name}}\" },\r\n  { label: \"Agent Name\", value: \"{{agent_name}}\" },\r\n  { label: \"Agent Phone\", value: \"{{agent_phone}}\" },\r\n  { label: \"Agent Email\", value: \"{{agent_email}}\" },\r\n  { label: \"Company Name\", value: \"{{company_name}}\" },\r\n];\r\n\r\nconst emailTemplates = [\r\n  { id: \"1\", name: \"Property Listing Announcement\", type: \"email\" },\r\n  { id: \"2\", name: \"Follow-up Template\", type: \"email\" },\r\n  { id: \"3\", name: \"Open House Invitation\", type: \"email\" },\r\n  { id: \"4\", name: \"Price Reduction Alert\", type: \"email\" },\r\n];\r\n\r\nexport function CreateCampaignDialog({\r\n  open,\r\n  onOpenChange,\r\n  campaign,\r\n  onSave,\r\n}: CreateCampaignDialogProps) {\r\n  const isEditing = !!campaign;\r\n  const [step, setStep] = useState(1);\r\n  const [previewMode, setPreviewMode] = useState<\"desktop\" | \"mobile\">(\"desktop\");\r\n  \r\n  // Connection dialogs\r\n  const [showMetaConnect, setShowMetaConnect] = useState(false);\r\n  const [showSMSConnect, setShowSMSConnect] = useState(false);\r\n  const [showEmailConnect, setShowEmailConnect] = useState(false);\r\n  const [showTemplateManager, setShowTemplateManager] = useState(false);\r\n  \r\n  // Selected WhatsApp template\r\n  const [selectedWhatsAppTemplate, setSelectedWhatsAppTemplate] = useState<WhatsAppTemplate | null>(null);\r\n  \r\n  // Connected accounts\r\n  const [whatsappConnections, setWhatsappConnections] = useState<WhatsAppConnection[]>([]);\r\n  const [smsConnections, setSmsConnections] = useState<SMSConnection[]>([]);\r\n  const [emailConnections, setEmailConnections] = useState<EmailConnection[]>([\r\n    // Sample pre-connected email\r\n    {\r\n      id: \"1\",\r\n      provider: \"Resend\",\r\n      email: \"marketing@yourcompany.com\",\r\n      domain: \"yourcompany.com\",\r\n      status: \"connected\",\r\n      connectedAt: new Date().toISOString(),\r\n    },\r\n  ]);\r\n  \r\n  // Selected senders\r\n  const [selectedWhatsapp, setSelectedWhatsapp] = useState<string | null>(null);\r\n  const [selectedSMS, setSelectedSMS] = useState<string | null>(null);\r\n  const [selectedEmail, setSelectedEmail] = useState<string>(\"1\");\r\n\r\n  const [formData, setFormData] = useState({\r\n    name: campaign?.name || \"\",\r\n    type: campaign?.type || \"email\",\r\n    targetAudience: campaign?.targetAudience || \"\",\r\n    schedule: \"now\" as \"now\" | \"later\" | \"recurring\",\r\n    scheduledDate: undefined as Date | undefined,\r\n    scheduledTime: \"09:00\",\r\n    recurringFrequency: \"weekly\",\r\n    emailSubject: \"\",\r\n    emailBody: \"\",\r\n    smsBody: \"\",\r\n    whatsappBody: \"\",\r\n    attachPdf: false,\r\n    selectedTemplate: \"\",\r\n  });\r\n\r\n  const handleSave = (isDraft: boolean) => {\r\n    onSave({\r\n      name: formData.name,\r\n      type: formData.type as Campaign[\"type\"],\r\n      targetAudience: formData.targetAudience,\r\n      status: isDraft ? \"draft\" : formData.schedule === \"now\" ? \"active\" : \"scheduled\",\r\n      startDate: formData.scheduledDate?.toISOString() || new Date().toISOString(),\r\n      leadsCount: Math.floor(Math.random() * 500) + 100,\r\n    });\r\n    onOpenChange(false);\r\n    setStep(1);\r\n  };\r\n\r\n  const insertDynamicField = (field: string) => {\r\n    if (formData.type === \"email\" || formData.type === \"multi-channel\") {\r\n      setFormData({ ...formData, emailBody: formData.emailBody + field });\r\n    } else if (formData.type === \"sms\") {\r\n      setFormData({ ...formData, smsBody: formData.smsBody + field });\r\n    } else if (formData.type === \"whatsapp\") {\r\n      setFormData({ ...formData, whatsappBody: formData.whatsappBody + field });\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"max-w-4xl max-h-[90vh] p-0 gap-0\">\r\n        <DialogHeader className=\"px-6 py-4 border-b border-border\">\r\n          <DialogTitle className=\"text-xl\">\r\n            {isEditing ? \"Edit Campaign\" : \"Create New Campaign\"}\r\n          </DialogTitle>\r\n        </DialogHeader>\r\n\r\n        <ScrollArea className=\"max-h-[calc(90vh-140px)]\">\r\n          <div className=\"p-6\">\r\n            {/* Step Indicator */}\r\n            <div className=\"flex items-center gap-2 mb-6 overflow-x-auto scrollbar-hide\">\r\n              {[1, 2, 3, 4].map((s) => (\r\n                <button\r\n                  key={s}\r\n                  onClick={() => setStep(s)}\r\n                  className={cn(\r\n                    \"flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium smooth shrink-0\",\r\n                    step === s\r\n                      ? \"bg-primary text-primary-foreground\"\r\n                      : step > s\r\n                      ? \"bg-success/10 text-success\"\r\n                      : \"bg-muted text-muted-foreground\"\r\n                  )}\r\n                >\r\n                  <span className=\"w-6 h-6 rounded-full bg-current/20 flex items-center justify-center text-xs\">\r\n                    {s}\r\n                  </span>\r\n                  {s === 1 && \"Details\"}\r\n                  {s === 2 && \"Message\"}\r\n                  {s === 3 && \"Sender\"}\r\n                  {s === 4 && \"Review\"}\r\n                </button>\r\n              ))}\r\n            </div>\r\n\r\n            {/* Step 1: Campaign Details */}\r\n            {step === 1 && (\r\n              <div className=\"space-y-6\">\r\n                {/* Campaign Name */}\r\n                <div className=\"space-y-2\">\r\n                  <Label>Campaign Name</Label>\r\n                  <Input\r\n                    placeholder=\"Enter campaign name...\"\r\n                    value={formData.name}\r\n                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}\r\n                  />\r\n                </div>\r\n\r\n                {/* Campaign Type */}\r\n                <div className=\"space-y-3\">\r\n                  <Label>Campaign Type</Label>\r\n                  <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3\">\r\n                    {campaignTypes.map((type) => (\r\n                      <button\r\n                        key={type.value}\r\n                        onClick={() => setFormData({ ...formData, type: type.value as \"email\" | \"sms\" | \"whatsapp\" | \"multi-channel\" })}\r\n                        className={cn(\r\n                          \"p-4 rounded-xl border-2 text-left smooth\",\r\n                          formData.type === type.value\r\n                            ? \"border-primary bg-primary/5\"\r\n                            : \"border-border hover:border-primary/50\"\r\n                        )}\r\n                      >\r\n                        <type.icon className={cn(\r\n                          \"h-6 w-6 mb-2\",\r\n                          formData.type === type.value ? \"text-primary\" : \"text-muted-foreground\"\r\n                        )} />\r\n                        <p className=\"font-medium text-foreground\">{type.label}</p>\r\n                        <p className=\"text-xs text-muted-foreground\">{type.description}</p>\r\n                      </button>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Target Audience */}\r\n                <div className=\"space-y-2\">\r\n                  <Label>Target Audience</Label>\r\n                  <Select\r\n                    value={formData.targetAudience}\r\n                    onValueChange={(value) => setFormData({ ...formData, targetAudience: value })}\r\n                  >\r\n                    <SelectTrigger>\r\n                      <SelectValue placeholder=\"Select target segment...\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      {segments.map((segment) => (\r\n                        <SelectItem key={segment} value={segment}>\r\n                          {segment}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                  <Button variant=\"outline\" size=\"sm\" className=\"mt-2\">\r\n                    <Upload className=\"h-4 w-4 mr-2\" />\r\n                    Import from CSV/Excel\r\n                  </Button>\r\n                </div>\r\n\r\n                {/* Schedule */}\r\n                <div className=\"space-y-3\">\r\n                  <Label>Schedule</Label>\r\n                  <div className=\"flex gap-3\">\r\n                    {[\r\n                      { value: \"now\", label: \"Send Now\", icon: Send },\r\n                      { value: \"later\", label: \"Schedule Later\", icon: Calendar },\r\n                      { value: \"recurring\", label: \"Recurring\", icon: Clock },\r\n                    ].map((option) => (\r\n                      <button\r\n                        key={option.value}\r\n                        onClick={() => setFormData({ ...formData, schedule: option.value as any })}\r\n                        className={cn(\r\n                          \"flex-1 p-3 rounded-lg border-2 flex items-center gap-2 smooth\",\r\n                          formData.schedule === option.value\r\n                            ? \"border-primary bg-primary/5\"\r\n                            : \"border-border hover:border-primary/50\"\r\n                        )}\r\n                      >\r\n                        <option.icon className={cn(\r\n                          \"h-4 w-4\",\r\n                          formData.schedule === option.value ? \"text-primary\" : \"text-muted-foreground\"\r\n                        )} />\r\n                        <span className=\"font-medium\">{option.label}</span>\r\n                      </button>\r\n                    ))}\r\n                  </div>\r\n\r\n                  {formData.schedule === \"later\" && (\r\n                    <div className=\"flex gap-3 mt-3\">\r\n                      <Popover>\r\n                        <PopoverTrigger asChild>\r\n                          <Button variant=\"outline\" className=\"flex-1 justify-start\">\r\n                            <Calendar className=\"h-4 w-4 mr-2\" />\r\n                            {formData.scheduledDate\r\n                              ? format(formData.scheduledDate, \"PPP\")\r\n                              : \"Pick a date\"}\r\n                          </Button>\r\n                        </PopoverTrigger>\r\n                        <PopoverContent className=\"w-auto p-0\">\r\n                          <CalendarComponent\r\n                            mode=\"single\"\r\n                            selected={formData.scheduledDate}\r\n                            onSelect={(date) => setFormData({ ...formData, scheduledDate: date })}\r\n                            initialFocus\r\n                          />\r\n                        </PopoverContent>\r\n                      </Popover>\r\n                      <Select\r\n                        value={formData.scheduledTime}\r\n                        onValueChange={(value) => setFormData({ ...formData, scheduledTime: value })}\r\n                      >\r\n                        <SelectTrigger className=\"w-32\">\r\n                          <SelectValue />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                          {Array.from({ length: 24 }, (_, i) => (\r\n                            <SelectItem key={i} value={`${i.toString().padStart(2, \"0\")}:00`}>\r\n                              {`${i.toString().padStart(2, \"0\")}:00`}\r\n                            </SelectItem>\r\n                          ))}\r\n                        </SelectContent>\r\n                      </Select>\r\n                    </div>\r\n                  )}\r\n\r\n                  {formData.schedule === \"recurring\" && (\r\n                    <Select\r\n                      value={formData.recurringFrequency}\r\n                      onValueChange={(value) => setFormData({ ...formData, recurringFrequency: value })}\r\n                    >\r\n                      <SelectTrigger className=\"mt-3\">\r\n                        <SelectValue />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"daily\">Daily</SelectItem>\r\n                        <SelectItem value=\"weekly\">Weekly</SelectItem>\r\n                        <SelectItem value=\"biweekly\">Bi-weekly</SelectItem>\r\n                        <SelectItem value=\"monthly\">Monthly</SelectItem>\r\n                      </SelectContent>\r\n                    </Select>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Step 2: Message Builder */}\r\n            {step === 2 && (\r\n              <div className=\"space-y-6\">\r\n                {/* Templates */}\r\n                <div className=\"space-y-2\">\r\n                  <Label>Use Template</Label>\r\n                  <Select\r\n                    value={formData.selectedTemplate}\r\n                    onValueChange={(value) => setFormData({ ...formData, selectedTemplate: value })}\r\n                  >\r\n                    <SelectTrigger>\r\n                      <SelectValue placeholder=\"Select a template (optional)\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      {emailTemplates.map((template) => (\r\n                        <SelectItem key={template.id} value={template.id}>\r\n                          <span className=\"flex items-center gap-2\">\r\n                            <FileText className=\"h-4 w-4\" />\r\n                            {template.name}\r\n                          </span>\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n\r\n                {/* Dynamic Fields */}\r\n                <div className=\"space-y-2\">\r\n                  <Label>Dynamic Fields</Label>\r\n                  <div className=\"flex flex-wrap gap-2\">\r\n                    {dynamicFields.map((field) => (\r\n                      <Badge\r\n                        key={field.value}\r\n                        variant=\"outline\"\r\n                        className=\"cursor-pointer hover:bg-primary/10 smooth\"\r\n                        onClick={() => insertDynamicField(field.value)}\r\n                      >\r\n                        <Sparkles className=\"h-3 w-3 mr-1\" />\r\n                        {field.label}\r\n                      </Badge>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n\r\n                <Separator />\r\n\r\n                {/* Email Builder */}\r\n                {(formData.type === \"email\" || formData.type === \"multi-channel\") && (\r\n                  <div className=\"space-y-4\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <Mail className=\"h-5 w-5 text-primary\" />\r\n                      <Label className=\"text-base\">Email Content</Label>\r\n                    </div>\r\n                    <Input\r\n                      placeholder=\"Email Subject\"\r\n                      value={formData.emailSubject}\r\n                      onChange={(e) => setFormData({ ...formData, emailSubject: e.target.value })}\r\n                    />\r\n                    <Textarea\r\n                      placeholder=\"Write your email content here... Use dynamic fields above to personalize.\"\r\n                      value={formData.emailBody}\r\n                      onChange={(e) => setFormData({ ...formData, emailBody: e.target.value })}\r\n                      className=\"min-h-[200px]\"\r\n                    />\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <Switch\r\n                        checked={formData.attachPdf}\r\n                        onCheckedChange={(checked) => setFormData({ ...formData, attachPdf: checked })}\r\n                      />\r\n                      <Label>Attach Property PDF/Brochure</Label>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {/* SMS Builder */}\r\n                {(formData.type === \"sms\" || formData.type === \"multi-channel\") && (\r\n                  <div className=\"space-y-4\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <MessageSquare className=\"h-5 w-5 text-info\" />\r\n                      <Label className=\"text-base\">SMS Content</Label>\r\n                    </div>\r\n                    <Textarea\r\n                      placeholder=\"Write your SMS message... (160 characters recommended)\"\r\n                      value={formData.smsBody}\r\n                      onChange={(e) => setFormData({ ...formData, smsBody: e.target.value })}\r\n                      className=\"min-h-[100px]\"\r\n                      maxLength={320}\r\n                    />\r\n                    <p className=\"text-xs text-muted-foreground\">\r\n                      {formData.smsBody.length}/320 characters\r\n                    </p>\r\n                  </div>\r\n                )}\r\n\r\n                {/* WhatsApp Builder */}\r\n                {(formData.type === \"whatsapp\" || formData.type === \"multi-channel\") && (\r\n                  <div className=\"space-y-4\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <Phone className=\"h-5 w-5 text-success\" />\r\n                        <Label className=\"text-base\">WhatsApp Content</Label>\r\n                      </div>\r\n                      <Button \r\n                        variant=\"outline\" \r\n                        size=\"sm\"\r\n                        onClick={() => setShowTemplateManager(true)}\r\n                      >\r\n                        <FileText className=\"h-4 w-4 mr-2\" />\r\n                        Use Template\r\n                      </Button>\r\n                    </div>\r\n\r\n                    {selectedWhatsAppTemplate ? (\r\n                      <div className=\"space-y-3\">\r\n                        <div className=\"bg-green-50 border border-green-200 rounded-xl p-4\">\r\n                          <div className=\"flex items-start justify-between\">\r\n                            <div>\r\n                              <div className=\"flex items-center gap-2 mb-1\">\r\n                                <Badge className=\"bg-green-100 text-green-700\">\r\n                                  <Check className=\"h-3 w-3 mr-1\" />\r\n                                  Approved Template\r\n                                </Badge>\r\n                                <span className=\"text-sm font-medium\">{selectedWhatsAppTemplate.name}</span>\r\n                              </div>\r\n                              <p className=\"text-sm text-muted-foreground mt-2 whitespace-pre-wrap\">\r\n                                {selectedWhatsAppTemplate.body}\r\n                              </p>\r\n                              {selectedWhatsAppTemplate.buttons && selectedWhatsAppTemplate.buttons.length > 0 && (\r\n                                <div className=\"flex flex-wrap gap-2 mt-3\">\r\n                                  {selectedWhatsAppTemplate.buttons.map((btn, i) => (\r\n                                    <Badge key={i} variant=\"secondary\" className=\"text-xs\">\r\n                                      {btn.text}\r\n                                    </Badge>\r\n                                  ))}\r\n                                </div>\r\n                              )}\r\n                            </div>\r\n                            <Button\r\n                              variant=\"ghost\"\r\n                              size=\"sm\"\r\n                              onClick={() => setSelectedWhatsAppTemplate(null)}\r\n                            >\r\n                              <X className=\"h-4 w-4\" />\r\n                            </Button>\r\n                          </div>\r\n                        </div>\r\n\r\n                        {/* Variable mapping */}\r\n                        {selectedWhatsAppTemplate.variables.length > 0 && (\r\n                          <div className=\"space-y-2\">\r\n                            <Label className=\"text-sm\">Map Variables</Label>\r\n                            <div className=\"grid gap-2\">\r\n                              {selectedWhatsAppTemplate.variables.map((v, i) => (\r\n                                <div key={i} className=\"flex items-center gap-2\">\r\n                                  <Badge variant=\"outline\" className=\"shrink-0\">{`{{${i + 1}}}`}</Badge>\r\n                                  <Select>\r\n                                    <SelectTrigger className=\"flex-1\">\r\n                                      <SelectValue placeholder={`Select value for ${v}`} />\r\n                                    </SelectTrigger>\r\n                                    <SelectContent>\r\n                                      <SelectItem value=\"client_name\">Client Name</SelectItem>\r\n                                      <SelectItem value=\"property_name\">Property Name</SelectItem>\r\n                                      <SelectItem value=\"agent_name\">Agent Name</SelectItem>\r\n                                      <SelectItem value=\"price\">Price</SelectItem>\r\n                                      <SelectItem value=\"location\">Location</SelectItem>\r\n                                      <SelectItem value=\"custom\">Custom Value</SelectItem>\r\n                                    </SelectContent>\r\n                                  </Select>\r\n                                </div>\r\n                              ))}\r\n                            </div>\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    ) : (\r\n                      <>\r\n                        <div className=\"bg-amber-50 border border-amber-200 rounded-xl p-4\">\r\n                          <div className=\"flex gap-3\">\r\n                            <AlertCircle className=\"h-5 w-5 text-amber-600 shrink-0\" />\r\n                            <div className=\"text-sm\">\r\n                              <p className=\"font-medium text-amber-800\">Template Required for Business API</p>\r\n                              <p className=\"text-amber-700 mt-1\">\r\n                                WhatsApp Business API requires pre-approved message templates. \r\n                                Select a template or create custom content for personal/business app.\r\n                              </p>\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                        <Textarea\r\n                          placeholder=\"Or write your custom WhatsApp message here (for personal/business app only)...\"\r\n                          value={formData.whatsappBody}\r\n                          onChange={(e) => setFormData({ ...formData, whatsappBody: e.target.value })}\r\n                          className=\"min-h-[150px]\"\r\n                        />\r\n                      </>\r\n                    )}\r\n                  </div>\r\n                )}\r\n\r\n                {/* Test Send */}\r\n                <div className=\"flex gap-3 pt-4 border-t border-border\">\r\n                  <Input placeholder=\"Test email or phone number\" className=\"flex-1\" />\r\n                  <Button variant=\"outline\">\r\n                    <Send className=\"h-4 w-4 mr-2\" />\r\n                    Send Test\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Step 3: Sender Selection */}\r\n            {step === 3 && (\r\n              <div className=\"space-y-6\">\r\n                <div className=\"space-y-2\">\r\n                  <Label className=\"text-base font-semibold\">\r\n                    {formData.type === \"whatsapp\" && \"WhatsApp Business Number\"}\r\n                    {formData.type === \"sms\" && \"SMS Sender\"}\r\n                    {formData.type === \"email\" && \"Email Sender\"}\r\n                    {formData.type === \"multi-channel\" && \"Sender Configuration\"}\r\n                  </Label>\r\n                  <p className=\"text-sm text-muted-foreground\">\r\n                    {formData.type === \"whatsapp\" && \"Select or connect your WhatsApp Business number to send messages\"}\r\n                    {formData.type === \"sms\" && \"Select or connect your SMS provider to send text messages\"}\r\n                    {formData.type === \"email\" && \"Select or connect your email sender address\"}\r\n                    {formData.type === \"multi-channel\" && \"Configure senders for each channel\"}\r\n                  </p>\r\n                </div>\r\n\r\n                {/* WhatsApp Sender */}\r\n                {(formData.type === \"whatsapp\" || formData.type === \"multi-channel\") && (\r\n                  <div className=\"space-y-3\">\r\n                    {formData.type === \"multi-channel\" && (\r\n                      <Label className=\"text-sm font-medium flex items-center gap-2\">\r\n                        <Phone className=\"h-4 w-4 text-green-600\" />\r\n                        WhatsApp\r\n                      </Label>\r\n                    )}\r\n                    <div className=\"grid gap-3\">\r\n                      {whatsappConnections.length === 0 ? (\r\n                        <div className=\"flex items-center justify-between p-4 border rounded-xl bg-muted/50 border-dashed\">\r\n                          <div className=\"flex items-center gap-3\">\r\n                            <div className=\"h-10 w-10 rounded-full bg-amber-100 flex items-center justify-center\">\r\n                              <AlertCircle className=\"h-5 w-5 text-amber-600\" />\r\n                            </div>\r\n                            <div>\r\n                              <p className=\"font-medium\">No WhatsApp number connected</p>\r\n                              <p className=\"text-xs text-muted-foreground\">Connect via Meta Business to send campaigns</p>\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      ) : (\r\n                        whatsappConnections.map((conn) => (\r\n                          <div \r\n                            key={conn.id}\r\n                            onClick={() => setSelectedWhatsapp(conn.id)}\r\n                            className={cn(\r\n                              \"flex items-center justify-between p-4 border rounded-xl bg-card hover:border-primary/50 transition-colors cursor-pointer\",\r\n                              selectedWhatsapp === conn.id && \"border-primary bg-primary/5\"\r\n                            )}\r\n                          >\r\n                            <div className=\"flex items-center gap-3\">\r\n                              <div className=\"h-10 w-10 rounded-full bg-green-100 flex items-center justify-center\">\r\n                                <Phone className=\"h-5 w-5 text-green-600\" />\r\n                              </div>\r\n                              <div>\r\n                                <p className=\"font-medium\">{conn.phoneNumber}</p>\r\n                                <p className=\"text-xs text-muted-foreground\">{conn.displayName} â€¢ Connected via Meta</p>\r\n                              </div>\r\n                            </div>\r\n                            <div className=\"flex items-center gap-2\">\r\n                              {selectedWhatsapp === conn.id ? (\r\n                                <Badge variant=\"secondary\" className=\"bg-green-100 text-green-700\">\r\n                                  <Check className=\"h-3 w-3 mr-1\" />\r\n                                  Selected\r\n                                </Badge>\r\n                              ) : (\r\n                                <Badge variant=\"secondary\" className=\"bg-green-100 text-green-700\">\r\n                                  <Check className=\"h-3 w-3 mr-1\" />\r\n                                  Connected\r\n                                </Badge>\r\n                              )}\r\n                            </div>\r\n                          </div>\r\n                        ))\r\n                      )}\r\n                      <Button \r\n                        variant=\"outline\" \r\n                        className=\"w-full justify-start gap-2\"\r\n                        onClick={() => setShowMetaConnect(true)}\r\n                      >\r\n                        <Plus className=\"h-4 w-4\" />\r\n                        {whatsappConnections.length === 0 ? \"Connect WhatsApp via Meta\" : \"Connect another WhatsApp number\"}\r\n                      </Button>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {/* SMS Sender */}\r\n                {(formData.type === \"sms\" || formData.type === \"multi-channel\") && (\r\n                  <div className=\"space-y-3\">\r\n                    {formData.type === \"multi-channel\" && (\r\n                      <Label className=\"text-sm font-medium flex items-center gap-2\">\r\n                        <MessageSquare className=\"h-4 w-4 text-blue-600\" />\r\n                        SMS\r\n                      </Label>\r\n                    )}\r\n                    <div className=\"grid gap-3\">\r\n                      {smsConnections.length === 0 ? (\r\n                        <div className=\"flex items-center justify-between p-4 border rounded-xl bg-muted/50 border-dashed\">\r\n                          <div className=\"flex items-center gap-3\">\r\n                            <div className=\"h-10 w-10 rounded-full bg-amber-100 flex items-center justify-center\">\r\n                              <AlertCircle className=\"h-5 w-5 text-amber-600\" />\r\n                            </div>\r\n                            <div>\r\n                              <p className=\"font-medium\">No SMS provider connected</p>\r\n                              <p className=\"text-xs text-muted-foreground\">Connect Twilio, MessageBird, or other providers</p>\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      ) : (\r\n                        smsConnections.map((conn) => (\r\n                          <div \r\n                            key={conn.id}\r\n                            onClick={() => setSelectedSMS(conn.id)}\r\n                            className={cn(\r\n                              \"flex items-center justify-between p-4 border rounded-xl bg-card hover:border-primary/50 transition-colors cursor-pointer\",\r\n                              selectedSMS === conn.id && \"border-primary bg-primary/5\"\r\n                            )}\r\n                          >\r\n                            <div className=\"flex items-center gap-3\">\r\n                              <div className=\"h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center\">\r\n                                <MessageSquare className=\"h-5 w-5 text-blue-600\" />\r\n                              </div>\r\n                              <div>\r\n                                <p className=\"font-medium\">{conn.phoneNumber}</p>\r\n                                <p className=\"text-xs text-muted-foreground\">{conn.provider}</p>\r\n                              </div>\r\n                            </div>\r\n                            <div className=\"flex items-center gap-2\">\r\n                              {selectedSMS === conn.id ? (\r\n                                <Badge variant=\"secondary\" className=\"bg-green-100 text-green-700\">\r\n                                  <Check className=\"h-3 w-3 mr-1\" />\r\n                                  Selected\r\n                                </Badge>\r\n                              ) : (\r\n                                <Badge variant=\"secondary\" className=\"bg-green-100 text-green-700\">\r\n                                  <Check className=\"h-3 w-3 mr-1\" />\r\n                                  Connected\r\n                                </Badge>\r\n                              )}\r\n                            </div>\r\n                          </div>\r\n                        ))\r\n                      )}\r\n                      <Button \r\n                        variant=\"outline\" \r\n                        className=\"w-full\"\r\n                        onClick={() => setShowSMSConnect(true)}\r\n                      >\r\n                        <Link2 className=\"h-4 w-4 mr-2\" />\r\n                        {smsConnections.length === 0 ? \"Connect SMS Provider\" : \"Connect another provider\"}\r\n                      </Button>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {/* Email Sender */}\r\n                {(formData.type === \"email\" || formData.type === \"multi-channel\") && (\r\n                  <div className=\"space-y-3\">\r\n                    {formData.type === \"multi-channel\" && (\r\n                      <Label className=\"text-sm font-medium flex items-center gap-2\">\r\n                        <Mail className=\"h-4 w-4 text-primary\" />\r\n                        Email\r\n                      </Label>\r\n                    )}\r\n                    <div className=\"grid gap-3\">\r\n                      {emailConnections.length === 0 ? (\r\n                        <div className=\"flex items-center justify-between p-4 border rounded-xl bg-muted/50 border-dashed\">\r\n                          <div className=\"flex items-center gap-3\">\r\n                            <div className=\"h-10 w-10 rounded-full bg-amber-100 flex items-center justify-center\">\r\n                              <AlertCircle className=\"h-5 w-5 text-amber-600\" />\r\n                            </div>\r\n                            <div>\r\n                              <p className=\"font-medium\">No email sender connected</p>\r\n                              <p className=\"text-xs text-muted-foreground\">Connect Resend, SendGrid, or other providers</p>\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      ) : (\r\n                        emailConnections.map((conn) => (\r\n                          <div \r\n                            key={conn.id}\r\n                            onClick={() => setSelectedEmail(conn.id)}\r\n                            className={cn(\r\n                              \"flex items-center justify-between p-4 border rounded-xl bg-card hover:border-primary/50 transition-colors cursor-pointer\",\r\n                              selectedEmail === conn.id && \"border-primary bg-primary/5\"\r\n                            )}\r\n                          >\r\n                            <div className=\"flex items-center gap-3\">\r\n                              <div className={cn(\r\n                                \"h-10 w-10 rounded-full flex items-center justify-center\",\r\n                                selectedEmail === conn.id ? \"bg-primary/10\" : \"bg-muted\"\r\n                              )}>\r\n                                <Mail className={cn(\r\n                                  \"h-5 w-5\",\r\n                                  selectedEmail === conn.id ? \"text-primary\" : \"text-muted-foreground\"\r\n                                )} />\r\n                              </div>\r\n                              <div>\r\n                                <p className=\"font-medium\">{conn.email}</p>\r\n                                <p className=\"text-xs text-muted-foreground\">{conn.provider} â€¢ {conn.domain ? \"Verified domain\" : \"Pending verification\"}</p>\r\n                              </div>\r\n                            </div>\r\n                            <div className=\"flex items-center gap-2\">\r\n                              {selectedEmail === conn.id ? (\r\n                                <Badge variant=\"secondary\" className=\"bg-green-100 text-green-700\">\r\n                                  <Check className=\"h-3 w-3 mr-1\" />\r\n                                  Selected\r\n                                </Badge>\r\n                              ) : (\r\n                                <Badge variant=\"outline\">Select</Badge>\r\n                              )}\r\n                            </div>\r\n                          </div>\r\n                        ))\r\n                      )}\r\n                      <Button \r\n                        variant=\"outline\" \r\n                        className=\"w-full justify-start gap-2\"\r\n                        onClick={() => setShowEmailConnect(true)}\r\n                      >\r\n                        <Plus className=\"h-4 w-4\" />\r\n                        {emailConnections.length === 0 ? \"Connect Email Provider\" : \"Add another email sender\"}\r\n                      </Button>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {/* Sender Info */}\r\n                <div className=\"bg-blue-50 border border-blue-200 rounded-xl p-4\">\r\n                  <div className=\"flex gap-3\">\r\n                    <AlertCircle className=\"h-5 w-5 text-blue-600 shrink-0 mt-0.5\" />\r\n                    <div className=\"text-sm\">\r\n                      <p className=\"font-medium text-blue-800\">Sender Configuration</p>\r\n                      <p className=\"text-blue-700 mt-1\">\r\n                        Make sure your sender is properly verified to ensure high deliverability rates. \r\n                        For WhatsApp, use approved message templates to avoid blocks.\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Step 4: Review */}\r\n            {step === 4 && (\r\n              <div className=\"space-y-6\">\r\n                {/* Preview Toggle */}\r\n                <div className=\"flex items-center justify-between\">\r\n                  <Label>Preview Mode</Label>\r\n                  <div className=\"flex gap-2\">\r\n                    <Button\r\n                      variant={previewMode === \"desktop\" ? \"default\" : \"outline\"}\r\n                      size=\"sm\"\r\n                      onClick={() => setPreviewMode(\"desktop\")}\r\n                    >\r\n                      <Monitor className=\"h-4 w-4 mr-2\" />\r\n                      Desktop\r\n                    </Button>\r\n                    <Button\r\n                      variant={previewMode === \"mobile\" ? \"default\" : \"outline\"}\r\n                      size=\"sm\"\r\n                      onClick={() => setPreviewMode(\"mobile\")}\r\n                    >\r\n                      <Smartphone className=\"h-4 w-4 mr-2\" />\r\n                      Mobile\r\n                    </Button>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Preview */}\r\n                <div className={cn(\r\n                  \"border border-border rounded-xl p-6 bg-muted/50 mx-auto smooth\",\r\n                  previewMode === \"mobile\" ? \"max-w-[375px]\" : \"w-full\"\r\n                )}>\r\n                  <div className=\"bg-card rounded-lg p-4 shadow-sm\">\r\n                    <p className=\"font-semibold text-foreground mb-2\">\r\n                      {formData.emailSubject || \"Email Subject Preview\"}\r\n                    </p>\r\n                    <p className=\"text-sm text-muted-foreground whitespace-pre-wrap\">\r\n                      {formData.emailBody || formData.smsBody || formData.whatsappBody || \"Your message content will appear here...\"}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Campaign Summary */}\r\n                <div className=\"bg-muted/50 rounded-xl p-4 space-y-3\">\r\n                  <h4 className=\"font-semibold text-foreground\">Campaign Summary</h4>\r\n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\r\n                    <div>\r\n                      <p className=\"text-muted-foreground\">Name</p>\r\n                      <p className=\"font-medium\">{formData.name || \"Untitled Campaign\"}</p>\r\n                    </div>\r\n                    <div>\r\n                      <p className=\"text-muted-foreground\">Type</p>\r\n                      <p className=\"font-medium capitalize\">{formData.type}</p>\r\n                    </div>\r\n                    <div>\r\n                      <p className=\"text-muted-foreground\">Target Audience</p>\r\n                      <p className=\"font-medium\">{formData.targetAudience || \"Not selected\"}</p>\r\n                    </div>\r\n                    <div>\r\n                      <p className=\"text-muted-foreground\">Schedule</p>\r\n                      <p className=\"font-medium capitalize\">{formData.schedule}</p>\r\n                    </div>\r\n                    <div>\r\n                      <p className=\"text-muted-foreground\">Sender</p>\r\n                      <p className=\"font-medium\">\r\n                        {formData.type === \"email\" && \"marketing@yourcompany.com\"}\r\n                        {formData.type === \"whatsapp\" && \"+971 50 123 4567\"}\r\n                        {formData.type === \"sms\" && \"Not connected\"}\r\n                        {formData.type === \"multi-channel\" && \"Multiple senders\"}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </ScrollArea>\r\n\r\n        {/* Footer Actions */}\r\n        <div className=\"px-6 py-4 border-t border-border flex items-center justify-between\">\r\n          <Button\r\n            variant=\"ghost\"\r\n            onClick={() => step > 1 ? setStep(step - 1) : onOpenChange(false)}\r\n          >\r\n            {step > 1 ? \"Back\" : \"Cancel\"}\r\n          </Button>\r\n          <div className=\"flex gap-2\">\r\n            <Button variant=\"outline\" onClick={() => handleSave(true)}>\r\n              <Save className=\"h-4 w-4 mr-2\" />\r\n              Save Draft\r\n            </Button>\r\n            {step < 4 ? (\r\n              <Button onClick={() => setStep(step + 1)}>\r\n                Next\r\n                <ChevronRight className=\"h-4 w-4 ml-2\" />\r\n              </Button>\r\n            ) : (\r\n              <Button onClick={() => handleSave(false)}>\r\n                <Send className=\"h-4 w-4 mr-2\" />\r\n                {formData.schedule === \"now\" ? \"Send Now\" : \"Schedule Campaign\"}\r\n              </Button>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </DialogContent>\r\n\r\n      {/* Connection Dialogs */}\r\n      <MetaConnectDialog\r\n        open={showMetaConnect}\r\n        onOpenChange={setShowMetaConnect}\r\n        onSuccess={(conn) => {\r\n          setWhatsappConnections([...whatsappConnections, conn]);\r\n          setSelectedWhatsapp(conn.id);\r\n        }}\r\n      />\r\n      <SMSProviderDialog\r\n        open={showSMSConnect}\r\n        onOpenChange={setShowSMSConnect}\r\n        onSuccess={(conn) => {\r\n          setSmsConnections([...smsConnections, conn]);\r\n          setSelectedSMS(conn.id);\r\n        }}\r\n      />\r\n      <EmailSenderDialog\r\n        open={showEmailConnect}\r\n        onOpenChange={setShowEmailConnect}\r\n        onSuccess={(conn) => {\r\n          setEmailConnections([...emailConnections, conn]);\r\n          setSelectedEmail(conn.id);\r\n        }}\r\n      />\r\n      <WhatsAppTemplateManager\r\n        open={showTemplateManager}\r\n        onOpenChange={setShowTemplateManager}\r\n        onSelectTemplate={(template) => {\r\n          setSelectedWhatsAppTemplate(template);\r\n          setFormData({ ...formData, whatsappBody: template.body });\r\n        }}\r\n      />\r\n    </Dialog>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing\\EmailSenderDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing\\MetaConnectDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing\\SMSProviderDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing\\WhatsAppTemplateManager.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":261,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":261,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8866,8869],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8866,8869],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":407,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":407,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14515,14518],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14515,14518],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":619,"column":96,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":619,"endColumn":99,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25107,25110],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25107,25110],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport {\r\n  X,\r\n  Plus,\r\n  Check,\r\n  Clock,\r\n  AlertCircle,\r\n  XCircle,\r\n  Phone,\r\n  Edit2,\r\n  Trash2,\r\n  Copy,\r\n  Eye,\r\n  FileText,\r\n  Sparkles,\r\n  ChevronRight,\r\n  MessageSquare,\r\n  Image,\r\n  Video,\r\n  File,\r\n  Link2,\r\n  ExternalLink,\r\n  RefreshCw,\r\n  CloudDownload,\r\n  Loader2,\r\n} from \"lucide-react\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { toast } from \"sonner\";\r\n\r\ninterface WhatsAppTemplateManagerProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  onSelectTemplate?: (template: WhatsAppTemplate) => void;\r\n}\r\n\r\nexport interface WhatsAppTemplate {\r\n  id: string;\r\n  name: string;\r\n  category: \"marketing\" | \"utility\" | \"authentication\";\r\n  language: string;\r\n  status: \"approved\" | \"pending\" | \"rejected\";\r\n  header?: {\r\n    type: \"text\" | \"image\" | \"video\" | \"document\";\r\n    content: string;\r\n  };\r\n  body: string;\r\n  footer?: string;\r\n  buttons?: {\r\n    type: \"quick_reply\" | \"url\" | \"phone\";\r\n    text: string;\r\n    value?: string;\r\n  }[];\r\n  variables: string[];\r\n  createdAt: string;\r\n  lastUsed?: string;\r\n}\r\n\r\nconst sampleTemplates: WhatsAppTemplate[] = [\r\n  {\r\n    id: \"1\",\r\n    name: \"property_inquiry_followup\",\r\n    category: \"marketing\",\r\n    language: \"English\",\r\n    status: \"approved\",\r\n    header: { type: \"text\", content: \"Property Update ðŸ \" },\r\n    body: \"Hi {{1}},\\n\\nThank you for your interest in {{2}}. I wanted to follow up and see if you have any questions about this property.\\n\\nThe asking price is {{3}} and it features {{4}}.\\n\\nWould you like to schedule a viewing?\",\r\n    footer: \"Reply STOP to unsubscribe\",\r\n    buttons: [\r\n      { type: \"quick_reply\", text: \"Schedule Viewing\" },\r\n      { type: \"quick_reply\", text: \"More Details\" },\r\n      { type: \"phone\", text: \"Call Agent\", value: \"+971501234567\" },\r\n    ],\r\n    variables: [\"client_name\", \"property_name\", \"price\", \"features\"],\r\n    createdAt: \"2024-01-15\",\r\n    lastUsed: \"2024-01-20\",\r\n  },\r\n  {\r\n    id: \"2\",\r\n    name: \"new_listing_alert\",\r\n    category: \"marketing\",\r\n    language: \"English\",\r\n    status: \"approved\",\r\n    header: { type: \"image\", content: \"property_image.jpg\" },\r\n    body: \"ðŸ”” New Listing Alert!\\n\\nHi {{1}},\\n\\nA new property matching your preferences is now available:\\n\\nðŸ“ {{2}}\\nðŸ’° {{3}}\\nðŸ›ï¸ {{4}} Bedrooms\\nðŸ“ {{5}} sqft\\n\\nDon't miss out!\",\r\n    footer: \"Powered by Your CRM\",\r\n    buttons: [\r\n      { type: \"url\", text: \"View Listing\", value: \"https://example.com/listing\" },\r\n      { type: \"quick_reply\", text: \"Not Interested\" },\r\n    ],\r\n    variables: [\"client_name\", \"location\", \"price\", \"bedrooms\", \"size\"],\r\n    createdAt: \"2024-01-10\",\r\n    lastUsed: \"2024-01-19\",\r\n  },\r\n  {\r\n    id: \"3\",\r\n    name: \"viewing_reminder\",\r\n    category: \"utility\",\r\n    language: \"English\",\r\n    status: \"approved\",\r\n    body: \"Hi {{1}},\\n\\nThis is a reminder for your property viewing tomorrow:\\n\\nðŸ“ {{2}}\\nðŸ“… {{3}}\\nâ° {{4}}\\n\\nPlease confirm your attendance by replying YES or NO.\",\r\n    buttons: [\r\n      { type: \"quick_reply\", text: \"YES, I'll be there\" },\r\n      { type: \"quick_reply\", text: \"NO, reschedule\" },\r\n    ],\r\n    variables: [\"client_name\", \"property_address\", \"date\", \"time\"],\r\n    createdAt: \"2024-01-08\",\r\n  },\r\n  {\r\n    id: \"4\",\r\n    name: \"price_reduction_alert\",\r\n    category: \"marketing\",\r\n    language: \"English\",\r\n    status: \"pending\",\r\n    header: { type: \"text\", content: \"ðŸ”¥ Price Drop Alert!\" },\r\n    body: \"Great news {{1}}!\\n\\nThe property you viewed at {{2}} has been reduced from {{3}} to {{4}}.\\n\\nThis is a {{5}} discount! Act fast before it's gone.\",\r\n    footer: \"Reply STOP to unsubscribe\",\r\n    buttons: [\r\n      { type: \"quick_reply\", text: \"I'm Interested!\" },\r\n      { type: \"url\", text: \"View Property\", value: \"https://example.com\" },\r\n    ],\r\n    variables: [\"client_name\", \"property_address\", \"old_price\", \"new_price\", \"discount_percentage\"],\r\n    createdAt: \"2024-01-18\",\r\n  },\r\n  {\r\n    id: \"5\",\r\n    name: \"document_request\",\r\n    category: \"utility\",\r\n    language: \"English\",\r\n    status: \"rejected\",\r\n    body: \"Hi {{1}},\\n\\nTo proceed with your property purchase, we require the following documents:\\n\\n{{2}}\\n\\nPlease upload them at your earliest convenience.\",\r\n    buttons: [\r\n      { type: \"url\", text: \"Upload Documents\", value: \"https://example.com/upload\" },\r\n    ],\r\n    variables: [\"client_name\", \"document_list\"],\r\n    createdAt: \"2024-01-12\",\r\n  },\r\n];\r\n\r\nconst categories = [\r\n  { value: \"marketing\", label: \"Marketing\", description: \"Promotional messages and offers\" },\r\n  { value: \"utility\", label: \"Utility\", description: \"Transactional and service messages\" },\r\n  { value: \"authentication\", label: \"Authentication\", description: \"OTP and verification codes\" },\r\n];\r\n\r\nconst headerTypes = [\r\n  { value: \"none\", label: \"None\", icon: X },\r\n  { value: \"text\", label: \"Text\", icon: FileText },\r\n  { value: \"image\", label: \"Image\", icon: Image },\r\n  { value: \"video\", label: \"Video\", icon: Video },\r\n  { value: \"document\", label: \"Document\", icon: File },\r\n];\r\n\r\nconst buttonTypes = [\r\n  { value: \"quick_reply\", label: \"Quick Reply\", icon: MessageSquare },\r\n  { value: \"url\", label: \"URL\", icon: Link2 },\r\n  { value: \"phone\", label: \"Phone\", icon: Phone },\r\n];\r\n\r\nexport function WhatsAppTemplateManager({\r\n  open,\r\n  onOpenChange,\r\n  onSelectTemplate,\r\n}: WhatsAppTemplateManagerProps) {\r\n  const [activeTab, setActiveTab] = useState<\"templates\" | \"create\">(\"templates\");\r\n  const [templates, setTemplates] = useState<WhatsAppTemplate[]>(sampleTemplates);\r\n  const [selectedTemplate, setSelectedTemplate] = useState<WhatsAppTemplate | null>(null);\r\n  const [filterStatus, setFilterStatus] = useState<string>(\"all\");\r\n  const [filterCategory, setFilterCategory] = useState<string>(\"all\");\r\n  const [searchQuery, setSearchQuery] = useState(\"\");\r\n  const [isSyncing, setIsSyncing] = useState(false);\r\n  const [lastSyncTime, setLastSyncTime] = useState<string | null>(null);\r\n\r\n  // Create form state\r\n  const [newTemplate, setNewTemplate] = useState({\r\n    name: \"\",\r\n    category: \"marketing\" as WhatsAppTemplate[\"category\"],\r\n    language: \"English\",\r\n    headerType: \"none\",\r\n    headerContent: \"\",\r\n    body: \"\",\r\n    footer: \"\",\r\n    buttons: [] as WhatsAppTemplate[\"buttons\"],\r\n  });\r\n\r\n  const getStatusBadge = (status: WhatsAppTemplate[\"status\"]) => {\r\n    switch (status) {\r\n      case \"approved\":\r\n        return (\r\n          <Badge className=\"bg-green-100 text-green-700 border-green-200\">\r\n            <Check className=\"h-3 w-3 mr-1\" />\r\n            Approved\r\n          </Badge>\r\n        );\r\n      case \"pending\":\r\n        return (\r\n          <Badge className=\"bg-amber-100 text-amber-700 border-amber-200\">\r\n            <Clock className=\"h-3 w-3 mr-1\" />\r\n            Pending\r\n          </Badge>\r\n        );\r\n      case \"rejected\":\r\n        return (\r\n          <Badge className=\"bg-red-100 text-red-700 border-red-200\">\r\n            <XCircle className=\"h-3 w-3 mr-1\" />\r\n            Rejected\r\n          </Badge>\r\n        );\r\n    }\r\n  };\r\n\r\n  const getCategoryBadge = (category: WhatsAppTemplate[\"category\"]) => {\r\n    switch (category) {\r\n      case \"marketing\":\r\n        return <Badge variant=\"outline\" className=\"text-primary border-primary\">Marketing</Badge>;\r\n      case \"utility\":\r\n        return <Badge variant=\"outline\" className=\"text-blue-600 border-blue-600\">Utility</Badge>;\r\n      case \"authentication\":\r\n        return <Badge variant=\"outline\" className=\"text-purple-600 border-purple-600\">Authentication</Badge>;\r\n    }\r\n  };\r\n\r\n  const extractVariables = (text: string): string[] => {\r\n    const matches = text.match(/\\{\\{(\\d+)\\}\\}/g);\r\n    return matches ? matches.map((m, i) => `variable_${i + 1}`) : [];\r\n  };\r\n\r\n  const handleCreateTemplate = () => {\r\n    if (!newTemplate.name || !newTemplate.body) {\r\n      toast.error(\"Please fill in required fields\");\r\n      return;\r\n    }\r\n\r\n    const template: WhatsAppTemplate = {\r\n      id: crypto.randomUUID(),\r\n      name: newTemplate.name.toLowerCase().replace(/\\s+/g, \"_\"),\r\n      category: newTemplate.category,\r\n      language: newTemplate.language,\r\n      status: \"pending\",\r\n      header: newTemplate.headerType !== \"none\" ? {\r\n        type: newTemplate.headerType as any,\r\n        content: newTemplate.headerContent,\r\n      } : undefined,\r\n      body: newTemplate.body,\r\n      footer: newTemplate.footer || undefined,\r\n      buttons: newTemplate.buttons,\r\n      variables: extractVariables(newTemplate.body),\r\n      createdAt: new Date().toISOString().split(\"T\")[0],\r\n    };\r\n\r\n    setTemplates([template, ...templates]);\r\n    toast.success(\"Template submitted for approval\");\r\n    setActiveTab(\"templates\");\r\n    setNewTemplate({\r\n      name: \"\",\r\n      category: \"marketing\",\r\n      language: \"English\",\r\n      headerType: \"none\",\r\n      headerContent: \"\",\r\n      body: \"\",\r\n      footer: \"\",\r\n      buttons: [],\r\n    });\r\n  };\r\n\r\n  const handleAddButton = () => {\r\n    if ((newTemplate.buttons?.length || 0) >= 3) {\r\n      toast.error(\"Maximum 3 buttons allowed\");\r\n      return;\r\n    }\r\n    setNewTemplate({\r\n      ...newTemplate,\r\n      buttons: [...(newTemplate.buttons || []), { type: \"quick_reply\", text: \"\" }],\r\n    });\r\n  };\r\n\r\n  const handleRemoveButton = (index: number) => {\r\n    setNewTemplate({\r\n      ...newTemplate,\r\n      buttons: newTemplate.buttons?.filter((_, i) => i !== index),\r\n    });\r\n  };\r\n\r\n  const handleUpdateButton = (index: number, field: string, value: string) => {\r\n    const updated = [...(newTemplate.buttons || [])];\r\n    updated[index] = { ...updated[index], [field]: value };\r\n    setNewTemplate({ ...newTemplate, buttons: updated });\r\n  };\r\n\r\n  const filteredTemplates = templates.filter((t) => {\r\n    if (filterStatus !== \"all\" && t.status !== filterStatus) return false;\r\n    if (filterCategory !== \"all\" && t.category !== filterCategory) return false;\r\n    if (searchQuery && !t.name.toLowerCase().includes(searchQuery.toLowerCase())) return false;\r\n    return true;\r\n  });\r\n\r\n  const handleSelectTemplate = (template: WhatsAppTemplate) => {\r\n    if (template.status !== \"approved\") {\r\n      toast.error(\"Only approved templates can be used\");\r\n      return;\r\n    }\r\n    onSelectTemplate?.(template);\r\n    onOpenChange(false);\r\n  };\r\n\r\n  const handleSyncFromMeta = async () => {\r\n    setIsSyncing(true);\r\n    \r\n    // Simulate API call to Meta Business Manager\r\n    await new Promise((resolve) => setTimeout(resolve, 2500));\r\n    \r\n    // Simulated synced templates from Meta\r\n    const syncedTemplates: WhatsAppTemplate[] = [\r\n      {\r\n        id: `meta-${crypto.randomUUID()}`,\r\n        name: \"welcome_message\",\r\n        category: \"marketing\",\r\n        language: \"English\",\r\n        status: \"approved\",\r\n        header: { type: \"text\", content: \"Welcome to Our Agency! ðŸ¡\" },\r\n        body: \"Hi {{1}},\\n\\nThank you for choosing us for your property search.\\n\\nOur team is ready to help you find your dream home in {{2}}.\\n\\nYour dedicated agent is {{3}}.\",\r\n        footer: \"Powered by Meta Business\",\r\n        buttons: [\r\n          { type: \"quick_reply\", text: \"Start Search\" },\r\n          { type: \"url\", text: \"View Listings\", value: \"https://example.com/listings\" },\r\n        ],\r\n        variables: [\"client_name\", \"city\", \"agent_name\"],\r\n        createdAt: new Date().toISOString().split(\"T\")[0],\r\n      },\r\n      {\r\n        id: `meta-${crypto.randomUUID()}`,\r\n        name: \"open_house_invitation\",\r\n        category: \"marketing\",\r\n        language: \"English\",\r\n        status: \"approved\",\r\n        header: { type: \"image\", content: \"open_house_banner.jpg\" },\r\n        body: \"ðŸ  Open House This Weekend!\\n\\nDear {{1}},\\n\\nYou're invited to an exclusive open house at:\\n\\nðŸ“ {{2}}\\nðŸ“… {{3}}\\nâ° {{4}}\\n\\nRefreshments will be served. RSVP now!\",\r\n        footer: \"Synced from Meta\",\r\n        buttons: [\r\n          { type: \"quick_reply\", text: \"I'll Be There!\" },\r\n          { type: \"quick_reply\", text: \"Send Details\" },\r\n        ],\r\n        variables: [\"client_name\", \"property_address\", \"date\", \"time\"],\r\n        createdAt: new Date().toISOString().split(\"T\")[0],\r\n      },\r\n      {\r\n        id: `meta-${crypto.randomUUID()}`,\r\n        name: \"mortgage_calculator\",\r\n        category: \"utility\",\r\n        language: \"English\",\r\n        status: \"approved\",\r\n        body: \"Hi {{1}},\\n\\nBased on your inquiry for {{2}}, here's a quick mortgage estimate:\\n\\nðŸ’° Property Price: {{3}}\\nðŸ“Š Monthly Payment: {{4}}\\nðŸ“ˆ Interest Rate: {{5}}\\n\\nWould you like to speak with our mortgage advisor?\",\r\n        buttons: [\r\n          { type: \"quick_reply\", text: \"Yes, Call Me\" },\r\n          { type: \"quick_reply\", text: \"More Options\" },\r\n        ],\r\n        variables: [\"client_name\", \"property_name\", \"price\", \"monthly_payment\", \"interest_rate\"],\r\n        createdAt: new Date().toISOString().split(\"T\")[0],\r\n      },\r\n    ];\r\n    \r\n    // Merge with existing, avoiding duplicates by name\r\n    const existingNames = new Set(templates.map((t) => t.name));\r\n    const newTemplates = syncedTemplates.filter((t) => !existingNames.has(t.name));\r\n    \r\n    if (newTemplates.length > 0) {\r\n      setTemplates([...newTemplates, ...templates]);\r\n      toast.success(`Synced ${newTemplates.length} new templates from Meta`);\r\n    } else {\r\n      toast.info(\"All templates are already synced\");\r\n    }\r\n    \r\n    setLastSyncTime(new Date().toLocaleTimeString());\r\n    setIsSyncing(false);\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"max-w-4xl max-h-[90vh] p-0 gap-0\">\r\n        <DialogHeader className=\"px-6 py-4 border-b border-border\">\r\n          <DialogTitle className=\"text-xl flex items-center gap-2\">\r\n            <Phone className=\"h-5 w-5 text-green-600\" />\r\n            WhatsApp Message Templates\r\n          </DialogTitle>\r\n        </DialogHeader>\r\n\r\n        <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as any)} className=\"flex-1\">\r\n          <div className=\"px-6 pt-4\">\r\n            <TabsList className=\"grid w-full grid-cols-2\">\r\n              <TabsTrigger value=\"templates\">Templates Library</TabsTrigger>\r\n              <TabsTrigger value=\"create\">Create New Template</TabsTrigger>\r\n            </TabsList>\r\n          </div>\r\n\r\n          <ScrollArea className=\"max-h-[calc(90vh-180px)]\">\r\n            {/* Templates Library */}\r\n            <TabsContent value=\"templates\" className=\"p-6 pt-4 m-0\">\r\n              {/* Sync from Meta Banner */}\r\n              <div className=\"bg-gradient-to-r from-blue-50 to-green-50 dark:from-blue-950/30 dark:to-green-950/30 border border-blue-200 dark:border-blue-800 rounded-xl p-4 mb-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <div className=\"h-10 w-10 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center\">\r\n                      <CloudDownload className=\"h-5 w-5 text-blue-600\" />\r\n                    </div>\r\n                    <div>\r\n                      <h4 className=\"font-medium text-foreground\">Sync from Meta Business Manager</h4>\r\n                      <p className=\"text-sm text-muted-foreground\">\r\n                        Import your approved WhatsApp templates directly from Meta\r\n                        {lastSyncTime && <span className=\"ml-2\">â€¢ Last synced: {lastSyncTime}</span>}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                  <Button\r\n                    onClick={handleSyncFromMeta}\r\n                    disabled={isSyncing}\r\n                    className=\"gap-2\"\r\n                  >\r\n                    {isSyncing ? (\r\n                      <>\r\n                        <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n                        Syncing...\r\n                      </>\r\n                    ) : (\r\n                      <>\r\n                        <RefreshCw className=\"h-4 w-4\" />\r\n                        Sync Templates\r\n                      </>\r\n                    )}\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Filters */}\r\n              <div className=\"flex flex-wrap gap-3 mb-4\">\r\n                <Input\r\n                  placeholder=\"Search templates...\"\r\n                  value={searchQuery}\r\n                  onChange={(e) => setSearchQuery(e.target.value)}\r\n                  className=\"w-64\"\r\n                />\r\n                <Select value={filterStatus} onValueChange={setFilterStatus}>\r\n                  <SelectTrigger className=\"w-40\">\r\n                    <SelectValue placeholder=\"Status\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"all\">All Status</SelectItem>\r\n                    <SelectItem value=\"approved\">Approved</SelectItem>\r\n                    <SelectItem value=\"pending\">Pending</SelectItem>\r\n                    <SelectItem value=\"rejected\">Rejected</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n                <Select value={filterCategory} onValueChange={setFilterCategory}>\r\n                  <SelectTrigger className=\"w-40\">\r\n                    <SelectValue placeholder=\"Category\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"all\">All Categories</SelectItem>\r\n                    <SelectItem value=\"marketing\">Marketing</SelectItem>\r\n                    <SelectItem value=\"utility\">Utility</SelectItem>\r\n                    <SelectItem value=\"authentication\">Authentication</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n\r\n              {/* Template Cards */}\r\n              <div className=\"grid gap-4\">\r\n                {filteredTemplates.map((template) => (\r\n                  <div\r\n                    key={template.id}\r\n                    className={cn(\r\n                      \"border rounded-xl p-4 hover:border-primary/50 transition-colors\",\r\n                      selectedTemplate?.id === template.id && \"border-primary bg-primary/5\"\r\n                    )}\r\n                  >\r\n                    <div className=\"flex items-start justify-between gap-4\">\r\n                      <div className=\"flex-1\">\r\n                        <div className=\"flex items-center gap-2 mb-2\">\r\n                          <h3 className=\"font-medium text-foreground\">{template.name}</h3>\r\n                          {getStatusBadge(template.status)}\r\n                          {getCategoryBadge(template.category)}\r\n                        </div>\r\n\r\n                        {/* Template Preview */}\r\n                        <div className=\"bg-muted/50 rounded-lg p-3 mb-3\">\r\n                          {template.header && (\r\n                            <p className=\"text-xs font-semibold text-muted-foreground mb-1\">\r\n                              {template.header.type === \"text\" ? template.header.content : `[${template.header.type.toUpperCase()}]`}\r\n                            </p>\r\n                          )}\r\n                          <p className=\"text-sm text-foreground whitespace-pre-wrap line-clamp-3\">\r\n                            {template.body}\r\n                          </p>\r\n                          {template.footer && (\r\n                            <p className=\"text-xs text-muted-foreground mt-2 italic\">{template.footer}</p>\r\n                          )}\r\n                          {template.buttons && template.buttons.length > 0 && (\r\n                            <div className=\"flex flex-wrap gap-2 mt-3\">\r\n                              {template.buttons.map((btn, i) => (\r\n                                <Badge key={i} variant=\"secondary\" className=\"text-xs\">\r\n                                  {btn.type === \"phone\" && <Phone className=\"h-3 w-3 mr-1\" />}\r\n                                  {btn.type === \"url\" && <ExternalLink className=\"h-3 w-3 mr-1\" />}\r\n                                  {btn.text}\r\n                                </Badge>\r\n                              ))}\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n\r\n                        <div className=\"flex items-center gap-4 text-xs text-muted-foreground\">\r\n                          <span>{template.language}</span>\r\n                          <span>â€¢</span>\r\n                          <span>{template.variables.length} variables</span>\r\n                          <span>â€¢</span>\r\n                          <span>Created: {template.createdAt}</span>\r\n                          {template.lastUsed && (\r\n                            <>\r\n                              <span>â€¢</span>\r\n                              <span>Last used: {template.lastUsed}</span>\r\n                            </>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n\r\n                      <div className=\"flex flex-col gap-2\">\r\n                        {onSelectTemplate && (\r\n                          <Button\r\n                            size=\"sm\"\r\n                            onClick={() => handleSelectTemplate(template)}\r\n                            disabled={template.status !== \"approved\"}\r\n                          >\r\n                            Use Template\r\n                          </Button>\r\n                        )}\r\n                        <div className=\"flex gap-1\">\r\n                          <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\r\n                            <Eye className=\"h-4 w-4\" />\r\n                          </Button>\r\n                          <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\r\n                            <Copy className=\"h-4 w-4\" />\r\n                          </Button>\r\n                          <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 text-destructive\">\r\n                            <Trash2 className=\"h-4 w-4\" />\r\n                          </Button>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n\r\n                {filteredTemplates.length === 0 && (\r\n                  <div className=\"text-center py-12 text-muted-foreground\">\r\n                    <FileText className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\r\n                    <p>No templates found</p>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </TabsContent>\r\n\r\n            {/* Create Template */}\r\n            <TabsContent value=\"create\" className=\"p-6 pt-4 m-0\">\r\n              <div className=\"space-y-6\">\r\n                {/* Template Info */}\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label>Template Name *</Label>\r\n                    <Input\r\n                      placeholder=\"e.g., property_inquiry_followup\"\r\n                      value={newTemplate.name}\r\n                      onChange={(e) => setNewTemplate({ ...newTemplate, name: e.target.value })}\r\n                    />\r\n                    <p className=\"text-xs text-muted-foreground\">Use lowercase with underscores</p>\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label>Language</Label>\r\n                    <Select\r\n                      value={newTemplate.language}\r\n                      onValueChange={(v) => setNewTemplate({ ...newTemplate, language: v })}\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"English\">English</SelectItem>\r\n                        <SelectItem value=\"Arabic\">Arabic</SelectItem>\r\n                        <SelectItem value=\"French\">French</SelectItem>\r\n                        <SelectItem value=\"Spanish\">Spanish</SelectItem>\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Category */}\r\n                <div className=\"space-y-3\">\r\n                  <Label>Category *</Label>\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-3\">\r\n                    {categories.map((cat) => (\r\n                      <button\r\n                        key={cat.value}\r\n                        onClick={() => setNewTemplate({ ...newTemplate, category: cat.value as any })}\r\n                        className={cn(\r\n                          \"p-4 rounded-xl border-2 text-left transition-all\",\r\n                          newTemplate.category === cat.value\r\n                            ? \"border-primary bg-primary/5\"\r\n                            : \"border-border hover:border-primary/50\"\r\n                        )}\r\n                      >\r\n                        <p className=\"font-medium text-foreground\">{cat.label}</p>\r\n                        <p className=\"text-xs text-muted-foreground\">{cat.description}</p>\r\n                      </button>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n\r\n                <Separator />\r\n\r\n                {/* Header */}\r\n                <div className=\"space-y-3\">\r\n                  <Label>Header (Optional)</Label>\r\n                  <div className=\"flex flex-wrap gap-2\">\r\n                    {headerTypes.map((type) => (\r\n                      <Button\r\n                        key={type.value}\r\n                        variant={newTemplate.headerType === type.value ? \"default\" : \"outline\"}\r\n                        size=\"sm\"\r\n                        onClick={() => setNewTemplate({ ...newTemplate, headerType: type.value })}\r\n                      >\r\n                        <type.icon className=\"h-4 w-4 mr-2\" />\r\n                        {type.label}\r\n                      </Button>\r\n                    ))}\r\n                  </div>\r\n                  {newTemplate.headerType === \"text\" && (\r\n                    <Input\r\n                      placeholder=\"Header text (e.g., 'Property Update ðŸ ')\"\r\n                      value={newTemplate.headerContent}\r\n                      onChange={(e) => setNewTemplate({ ...newTemplate, headerContent: e.target.value })}\r\n                    />\r\n                  )}\r\n                  {(newTemplate.headerType === \"image\" || newTemplate.headerType === \"video\" || newTemplate.headerType === \"document\") && (\r\n                    <div className=\"border-2 border-dashed rounded-xl p-6 text-center\">\r\n                      <p className=\"text-sm text-muted-foreground\">\r\n                        Upload {newTemplate.headerType} or provide URL at send time\r\n                      </p>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n\r\n                {/* Body */}\r\n                <div className=\"space-y-2\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <Label>Body Message *</Label>\r\n                    <Button variant=\"ghost\" size=\"sm\">\r\n                      <Sparkles className=\"h-4 w-4 mr-2\" />\r\n                      AI Generate\r\n                    </Button>\r\n                  </div>\r\n                  <Textarea\r\n                    placeholder=\"Write your message here. Use {{1}}, {{2}}, etc. for variables...\"\r\n                    value={newTemplate.body}\r\n                    onChange={(e) => setNewTemplate({ ...newTemplate, body: e.target.value })}\r\n                    className=\"min-h-[150px]\"\r\n                  />\r\n                  <p className=\"text-xs text-muted-foreground\">\r\n                    Use {\"{{1}}\"}, {\"{{2}}\"}, etc. for dynamic content. Max 1024 characters.\r\n                  </p>\r\n                </div>\r\n\r\n                {/* Footer */}\r\n                <div className=\"space-y-2\">\r\n                  <Label>Footer (Optional)</Label>\r\n                  <Input\r\n                    placeholder=\"e.g., 'Reply STOP to unsubscribe'\"\r\n                    value={newTemplate.footer}\r\n                    onChange={(e) => setNewTemplate({ ...newTemplate, footer: e.target.value })}\r\n                  />\r\n                </div>\r\n\r\n                {/* Buttons */}\r\n                <div className=\"space-y-3\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <Label>Buttons (Optional)</Label>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      onClick={handleAddButton}\r\n                      disabled={(newTemplate.buttons?.length || 0) >= 3}\r\n                    >\r\n                      <Plus className=\"h-4 w-4 mr-2\" />\r\n                      Add Button\r\n                    </Button>\r\n                  </div>\r\n                  {newTemplate.buttons?.map((btn, index) => (\r\n                    <div key={index} className=\"flex gap-3 items-start p-4 border rounded-xl bg-muted/50\">\r\n                      <Select\r\n                        value={btn.type}\r\n                        onValueChange={(v) => handleUpdateButton(index, \"type\", v)}\r\n                      >\r\n                        <SelectTrigger className=\"w-32\">\r\n                          <SelectValue />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                          {buttonTypes.map((type) => (\r\n                            <SelectItem key={type.value} value={type.value}>\r\n                              <span className=\"flex items-center gap-2\">\r\n                                <type.icon className=\"h-3 w-3\" />\r\n                                {type.label}\r\n                              </span>\r\n                            </SelectItem>\r\n                          ))}\r\n                        </SelectContent>\r\n                      </Select>\r\n                      <Input\r\n                        placeholder=\"Button text\"\r\n                        value={btn.text}\r\n                        onChange={(e) => handleUpdateButton(index, \"text\", e.target.value)}\r\n                        className=\"flex-1\"\r\n                      />\r\n                      {(btn.type === \"url\" || btn.type === \"phone\") && (\r\n                        <Input\r\n                          placeholder={btn.type === \"url\" ? \"https://...\" : \"+1234567890\"}\r\n                          value={btn.value || \"\"}\r\n                          onChange={(e) => handleUpdateButton(index, \"value\", e.target.value)}\r\n                          className=\"flex-1\"\r\n                        />\r\n                      )}\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"icon\"\r\n                        onClick={() => handleRemoveButton(index)}\r\n                        className=\"text-destructive\"\r\n                      >\r\n                        <Trash2 className=\"h-4 w-4\" />\r\n                      </Button>\r\n                    </div>\r\n                  ))}\r\n                  <p className=\"text-xs text-muted-foreground\">\r\n                    Maximum 3 buttons. Quick replies are for user responses, URL opens a link, Phone initiates a call.\r\n                  </p>\r\n                </div>\r\n\r\n                {/* Preview */}\r\n                <div className=\"space-y-3\">\r\n                  <Label>Preview</Label>\r\n                  <div className=\"max-w-sm mx-auto\">\r\n                    <div className=\"bg-[#075E54] rounded-t-xl p-3 flex items-center gap-3\">\r\n                      <div className=\"h-8 w-8 rounded-full bg-white/20\" />\r\n                      <span className=\"text-white font-medium\">WhatsApp Preview</span>\r\n                    </div>\r\n                    <div className=\"bg-[#ECE5DD] p-4 rounded-b-xl min-h-[200px]\">\r\n                      <div className=\"bg-white rounded-lg p-3 shadow-sm max-w-[85%]\">\r\n                        {newTemplate.headerType === \"text\" && newTemplate.headerContent && (\r\n                          <p className=\"font-semibold text-sm mb-1\">{newTemplate.headerContent}</p>\r\n                        )}\r\n                        {(newTemplate.headerType === \"image\" || newTemplate.headerType === \"video\") && (\r\n                          <div className=\"bg-muted rounded h-32 mb-2 flex items-center justify-center\">\r\n                            <Image className=\"h-8 w-8 text-muted-foreground\" />\r\n                          </div>\r\n                        )}\r\n                        <p className=\"text-sm whitespace-pre-wrap\">\r\n                          {newTemplate.body || \"Your message will appear here...\"}\r\n                        </p>\r\n                        {newTemplate.footer && (\r\n                          <p className=\"text-xs text-muted-foreground mt-2\">{newTemplate.footer}</p>\r\n                        )}\r\n                        {newTemplate.buttons && newTemplate.buttons.length > 0 && (\r\n                          <div className=\"border-t mt-2 pt-2 space-y-1\">\r\n                            {newTemplate.buttons.map((btn, i) => (\r\n                              <button\r\n                                key={i}\r\n                                className=\"w-full text-center text-sm text-[#075E54] font-medium py-1\"\r\n                              >\r\n                                {btn.text || \"Button\"}\r\n                              </button>\r\n                            ))}\r\n                          </div>\r\n                        )}\r\n                        <p className=\"text-[10px] text-muted-foreground text-right mt-1\">12:00 PM</p>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Info */}\r\n                <div className=\"bg-blue-50 border border-blue-200 rounded-xl p-4\">\r\n                  <div className=\"flex gap-3\">\r\n                    <AlertCircle className=\"h-5 w-5 text-blue-600 shrink-0\" />\r\n                    <div className=\"text-sm\">\r\n                      <p className=\"font-medium text-blue-800\">Template Approval Required</p>\r\n                      <p className=\"text-blue-700 mt-1\">\r\n                        All templates must be approved by Meta before they can be used for campaigns. \r\n                        Approval typically takes 24-48 hours. Marketing templates require opt-in consent.\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </TabsContent>\r\n          </ScrollArea>\r\n        </Tabs>\r\n\r\n        {/* Footer */}\r\n        <div className=\"px-6 py-4 border-t border-border flex items-center justify-between\">\r\n          <Button variant=\"ghost\" onClick={() => onOpenChange(false)}>\r\n            Cancel\r\n          </Button>\r\n          {activeTab === \"create\" && (\r\n            <Button onClick={handleCreateTemplate}>\r\n              <Check className=\"h-4 w-4 mr-2\" />\r\n              Submit for Approval\r\n            </Button>\r\n          )}\r\n        </div>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing\\email-builder\\EmailBlockEditor.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":17,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[711,714],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[711,714],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":256,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":256,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10442,10445],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10442,10445],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { EmailBlock, BlockType } from './types';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Textarea } from '@/components/ui/textarea';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\r\nimport { Switch } from '@/components/ui/switch';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Trash2 } from 'lucide-react';\r\n\r\ninterface EmailBlockEditorProps {\r\n  block: EmailBlock;\r\n  onUpdate: (block: EmailBlock) => void;\r\n  onDelete: () => void;\r\n}\r\n\r\nexport function EmailBlockEditor({ block, onUpdate, onDelete }: EmailBlockEditorProps) {\r\n  const updateContent = (key: string, value: any) => {\r\n    onUpdate({\r\n      ...block,\r\n      content: { ...block.content, [key]: value },\r\n    });\r\n  };\r\n\r\n  const renderEditor = () => {\r\n    switch (block.type) {\r\n      case 'header':\r\n        return (\r\n          <>\r\n            <div className=\"space-y-2\">\r\n              <Label>Header Text</Label>\r\n              <Input \r\n                value={block.content.text} \r\n                onChange={(e) => updateContent('text', e.target.value)} \r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Logo URL (optional)</Label>\r\n              <Input \r\n                value={block.content.logoUrl} \r\n                onChange={(e) => updateContent('logoUrl', e.target.value)} \r\n                placeholder=\"https://...\"\r\n              />\r\n            </div>\r\n            <div className=\"grid grid-cols-2 gap-3\">\r\n              <div className=\"space-y-2\">\r\n                <Label>Font Size</Label>\r\n                <Select value={block.content.fontSize} onValueChange={(v) => updateContent('fontSize', v)}>\r\n                  <SelectTrigger><SelectValue /></SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"18px\">Small</SelectItem>\r\n                    <SelectItem value=\"24px\">Medium</SelectItem>\r\n                    <SelectItem value=\"32px\">Large</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>Alignment</Label>\r\n                <Select value={block.content.alignment} onValueChange={(v) => updateContent('alignment', v)}>\r\n                  <SelectTrigger><SelectValue /></SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"left\">Left</SelectItem>\r\n                    <SelectItem value=\"center\">Center</SelectItem>\r\n                    <SelectItem value=\"right\">Right</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Text Color</Label>\r\n              <Input type=\"color\" value={block.content.color} onChange={(e) => updateContent('color', e.target.value)} />\r\n            </div>\r\n          </>\r\n        );\r\n\r\n      case 'text':\r\n        return (\r\n          <>\r\n            <div className=\"space-y-2\">\r\n              <Label>Text Content</Label>\r\n              <Textarea \r\n                value={block.content.text} \r\n                onChange={(e) => updateContent('text', e.target.value)}\r\n                rows={4}\r\n              />\r\n            </div>\r\n            <div className=\"grid grid-cols-2 gap-3\">\r\n              <div className=\"space-y-2\">\r\n                <Label>Font Size</Label>\r\n                <Select value={block.content.fontSize} onValueChange={(v) => updateContent('fontSize', v)}>\r\n                  <SelectTrigger><SelectValue /></SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"14px\">Small</SelectItem>\r\n                    <SelectItem value=\"16px\">Medium</SelectItem>\r\n                    <SelectItem value=\"18px\">Large</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>Alignment</Label>\r\n                <Select value={block.content.alignment} onValueChange={(v) => updateContent('alignment', v)}>\r\n                  <SelectTrigger><SelectValue /></SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"left\">Left</SelectItem>\r\n                    <SelectItem value=\"center\">Center</SelectItem>\r\n                    <SelectItem value=\"right\">Right</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Text Color</Label>\r\n              <Input type=\"color\" value={block.content.color} onChange={(e) => updateContent('color', e.target.value)} />\r\n            </div>\r\n          </>\r\n        );\r\n\r\n      case 'image':\r\n        return (\r\n          <>\r\n            <div className=\"space-y-2\">\r\n              <Label>Image URL</Label>\r\n              <Input \r\n                value={block.content.src} \r\n                onChange={(e) => updateContent('src', e.target.value)} \r\n                placeholder=\"https://...\"\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Alt Text</Label>\r\n              <Input \r\n                value={block.content.alt} \r\n                onChange={(e) => updateContent('alt', e.target.value)} \r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Link URL (optional)</Label>\r\n              <Input \r\n                value={block.content.link} \r\n                onChange={(e) => updateContent('link', e.target.value)} \r\n                placeholder=\"https://...\"\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Width</Label>\r\n              <Select value={block.content.width} onValueChange={(v) => updateContent('width', v)}>\r\n                <SelectTrigger><SelectValue /></SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"50%\">50%</SelectItem>\r\n                  <SelectItem value=\"75%\">75%</SelectItem>\r\n                  <SelectItem value=\"100%\">100%</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n          </>\r\n        );\r\n\r\n      case 'button':\r\n        return (\r\n          <>\r\n            <div className=\"space-y-2\">\r\n              <Label>Button Text</Label>\r\n              <Input \r\n                value={block.content.text} \r\n                onChange={(e) => updateContent('text', e.target.value)} \r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Link URL</Label>\r\n              <Input \r\n                value={block.content.url} \r\n                onChange={(e) => updateContent('url', e.target.value)} \r\n              />\r\n            </div>\r\n            <div className=\"grid grid-cols-2 gap-3\">\r\n              <div className=\"space-y-2\">\r\n                <Label>Background</Label>\r\n                <Input type=\"color\" value={block.content.backgroundColor} onChange={(e) => updateContent('backgroundColor', e.target.value)} />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>Text Color</Label>\r\n                <Input type=\"color\" value={block.content.textColor} onChange={(e) => updateContent('textColor', e.target.value)} />\r\n              </div>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Alignment</Label>\r\n              <Select value={block.content.alignment} onValueChange={(v) => updateContent('alignment', v)}>\r\n                <SelectTrigger><SelectValue /></SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"left\">Left</SelectItem>\r\n                  <SelectItem value=\"center\">Center</SelectItem>\r\n                  <SelectItem value=\"right\">Right</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n          </>\r\n        );\r\n\r\n      case 'divider':\r\n        return (\r\n          <>\r\n            <div className=\"space-y-2\">\r\n              <Label>Color</Label>\r\n              <Input type=\"color\" value={block.content.color} onChange={(e) => updateContent('color', e.target.value)} />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Style</Label>\r\n              <Select value={block.content.style} onValueChange={(v) => updateContent('style', v)}>\r\n                <SelectTrigger><SelectValue /></SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"solid\">Solid</SelectItem>\r\n                  <SelectItem value=\"dashed\">Dashed</SelectItem>\r\n                  <SelectItem value=\"dotted\">Dotted</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n          </>\r\n        );\r\n\r\n      case 'spacer':\r\n        return (\r\n          <div className=\"space-y-2\">\r\n            <Label>Height</Label>\r\n            <Select value={block.content.height} onValueChange={(v) => updateContent('height', v)}>\r\n              <SelectTrigger><SelectValue /></SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"15px\">Small</SelectItem>\r\n                <SelectItem value=\"30px\">Medium</SelectItem>\r\n                <SelectItem value=\"50px\">Large</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n          </div>\r\n        );\r\n\r\n      case 'columns':\r\n        return (\r\n          <>\r\n            <div className=\"space-y-2\">\r\n              <Label>Number of Columns</Label>\r\n              <Select \r\n                value={String(block.content.columns)} \r\n                onValueChange={(v) => {\r\n                  const numCols = parseInt(v);\r\n                  const content = Array(numCols).fill({ text: 'Column content' });\r\n                  updateContent('columns', numCols);\r\n                  updateContent('content', content);\r\n                }}\r\n              >\r\n                <SelectTrigger><SelectValue /></SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"2\">2 Columns</SelectItem>\r\n                  <SelectItem value=\"3\">3 Columns</SelectItem>\r\n                  <SelectItem value=\"4\">4 Columns</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n            {block.content.content.map((col: any, idx: number) => (\r\n              <div key={idx} className=\"space-y-2\">\r\n                <Label>Column {idx + 1} Content</Label>\r\n                <Textarea \r\n                  value={col.text}\r\n                  onChange={(e) => {\r\n                    const newContent = [...block.content.content];\r\n                    newContent[idx] = { text: e.target.value };\r\n                    updateContent('content', newContent);\r\n                  }}\r\n                  rows={2}\r\n                />\r\n              </div>\r\n            ))}\r\n          </>\r\n        );\r\n\r\n      case 'social':\r\n        return (\r\n          <div className=\"space-y-2\">\r\n            <Label>Alignment</Label>\r\n            <Select value={block.content.alignment} onValueChange={(v) => updateContent('alignment', v)}>\r\n              <SelectTrigger><SelectValue /></SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"left\">Left</SelectItem>\r\n                <SelectItem value=\"center\">Center</SelectItem>\r\n                <SelectItem value=\"right\">Right</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n          </div>\r\n        );\r\n\r\n      case 'footer':\r\n        return (\r\n          <>\r\n            <div className=\"space-y-2\">\r\n              <Label>Footer Text</Label>\r\n              <Textarea \r\n                value={block.content.text} \r\n                onChange={(e) => updateContent('text', e.target.value)}\r\n                rows={2}\r\n              />\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <Switch \r\n                checked={block.content.showUnsubscribe}\r\n                onCheckedChange={(v) => updateContent('showUnsubscribe', v)}\r\n              />\r\n              <Label>Show Unsubscribe Link</Label>\r\n            </div>\r\n          </>\r\n        );\r\n\r\n      default:\r\n        return <p className=\"text-sm text-muted-foreground\">No settings available</p>;\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <h3 className=\"font-semibold capitalize\">{block.type} Settings</h3>\r\n        <Button variant=\"ghost\" size=\"sm\" onClick={onDelete} className=\"text-destructive hover:text-destructive\">\r\n          <Trash2 className=\"h-4 w-4\" />\r\n        </Button>\r\n      </div>\r\n      {renderEditor()}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing\\email-builder\\EmailBlockPalette.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing\\email-builder\\EmailBlockRenderer.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":100,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3017,3020],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3017,3020],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":109,"column":9,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":114,"endColumn":11,"suggestions":[{"messageId":"addBrackets","fix":{"range":[3251,3938],"text":"{ const iconComponents: Record<string, React.ReactNode> = {\r\n          facebook: <Facebook className=\"h-6 w-6\" />,\r\n          twitter: <Twitter className=\"h-6 w-6\" />,\r\n          instagram: <Instagram className=\"h-6 w-6\" />,\r\n          linkedin: <Linkedin className=\"h-6 w-6\" />,\r\n        };\r\n        return (\r\n          <div style={{ textAlign: block.content.alignment }} className=\"flex gap-4 justify-center\">\r\n            {block.content.icons.map((icon: string) => (\r\n              <a key={icon} href=\"#\" className=\"text-muted-foreground hover:text-foreground transition-colors\">\r\n                {iconComponents[icon]}\r\n              </a>\r\n            ))}\r\n          </div>\r\n        ); }"},"desc":"Add {} brackets around the case block."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { EmailBlock } from './types';\r\nimport { Facebook, Twitter, Instagram, Linkedin } from 'lucide-react';\r\n\r\ninterface EmailBlockRendererProps {\r\n  block: EmailBlock;\r\n  isSelected: boolean;\r\n  onClick: () => void;\r\n}\r\n\r\nexport function EmailBlockRenderer({ block, isSelected, onClick }: EmailBlockRendererProps) {\r\n  const renderBlock = () => {\r\n    switch (block.type) {\r\n      case 'header':\r\n        return (\r\n          <div \r\n            style={{ \r\n              textAlign: block.content.alignment,\r\n              fontSize: block.content.fontSize,\r\n              color: block.content.color,\r\n              fontWeight: 'bold',\r\n            }}\r\n          >\r\n            {block.content.logoUrl ? (\r\n              <img src={block.content.logoUrl} alt=\"Logo\" className=\"max-h-16 inline-block mb-2\" />\r\n            ) : null}\r\n            <div>{block.content.text}</div>\r\n          </div>\r\n        );\r\n      \r\n      case 'text':\r\n        return (\r\n          <div \r\n            style={{ \r\n              textAlign: block.content.alignment,\r\n              fontSize: block.content.fontSize,\r\n              color: block.content.color,\r\n              lineHeight: '1.6',\r\n            }}\r\n          >\r\n            {block.content.text}\r\n          </div>\r\n        );\r\n      \r\n      case 'image':\r\n        return (\r\n          <div style={{ textAlign: block.content.alignment }}>\r\n            <img \r\n              src={block.content.src} \r\n              alt={block.content.alt}\r\n              style={{ width: block.content.width, maxWidth: '100%' }}\r\n              className=\"inline-block rounded\"\r\n            />\r\n          </div>\r\n        );\r\n      \r\n      case 'button':\r\n        return (\r\n          <div style={{ textAlign: block.content.alignment }}>\r\n            <a\r\n              href={block.content.url}\r\n              style={{\r\n                display: 'inline-block',\r\n                padding: '12px 24px',\r\n                backgroundColor: block.content.backgroundColor,\r\n                color: block.content.textColor,\r\n                borderRadius: block.content.borderRadius,\r\n                textDecoration: 'none',\r\n                fontWeight: '600',\r\n              }}\r\n            >\r\n              {block.content.text}\r\n            </a>\r\n          </div>\r\n        );\r\n      \r\n      case 'divider':\r\n        return (\r\n          <hr \r\n            style={{ \r\n              borderColor: block.content.color,\r\n              borderWidth: block.content.thickness,\r\n              borderStyle: block.content.style,\r\n              margin: `${block.content.margin} 0`,\r\n            }} \r\n          />\r\n        );\r\n      \r\n      case 'spacer':\r\n        return <div style={{ height: block.content.height }} />;\r\n      \r\n      case 'columns':\r\n        return (\r\n          <div \r\n            style={{ \r\n              display: 'grid', \r\n              gridTemplateColumns: `repeat(${block.content.columns}, 1fr)`,\r\n              gap: block.content.gap,\r\n            }}\r\n          >\r\n            {block.content.content.map((col: any, idx: number) => (\r\n              <div key={idx} className=\"p-3 bg-muted/30 rounded text-sm\">\r\n                {col.text}\r\n              </div>\r\n            ))}\r\n          </div>\r\n        );\r\n      \r\n      case 'social':\r\n        const iconComponents: Record<string, React.ReactNode> = {\r\n          facebook: <Facebook className=\"h-6 w-6\" />,\r\n          twitter: <Twitter className=\"h-6 w-6\" />,\r\n          instagram: <Instagram className=\"h-6 w-6\" />,\r\n          linkedin: <Linkedin className=\"h-6 w-6\" />,\r\n        };\r\n        return (\r\n          <div style={{ textAlign: block.content.alignment }} className=\"flex gap-4 justify-center\">\r\n            {block.content.icons.map((icon: string) => (\r\n              <a key={icon} href=\"#\" className=\"text-muted-foreground hover:text-foreground transition-colors\">\r\n                {iconComponents[icon]}\r\n              </a>\r\n            ))}\r\n          </div>\r\n        );\r\n      \r\n      case 'footer':\r\n        return (\r\n          <div \r\n            style={{ \r\n              textAlign: block.content.alignment,\r\n              fontSize: block.content.fontSize,\r\n              color: block.content.color,\r\n            }}\r\n          >\r\n            <p>{block.content.text}</p>\r\n            {block.content.showUnsubscribe && (\r\n              <p className=\"mt-2\">\r\n                <a href=\"#\" className=\"underline\">Unsubscribe</a> | <a href=\"#\" className=\"underline\">View in browser</a>\r\n              </p>\r\n            )}\r\n          </div>\r\n        );\r\n      \r\n      default:\r\n        return <div>Unknown block type</div>;\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div\r\n      onClick={onClick}\r\n      className={`relative p-4 rounded-lg border-2 transition-all cursor-pointer ${\r\n        isSelected \r\n          ? 'border-primary bg-primary/5' \r\n          : 'border-transparent hover:border-muted-foreground/20'\r\n      }`}\r\n    >\r\n      {renderBlock()}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing\\email-builder\\EmailCanvas.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing\\email-builder\\EmailTemplateBuilder.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\marketing\\email-builder\\types.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":6,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[216,219],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[216,219],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":19,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[535,538],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[535,538],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export type BlockType = 'header' | 'text' | 'image' | 'button' | 'divider' | 'spacer' | 'columns' | 'social' | 'footer';\r\n\r\nexport interface EmailBlock {\r\n  id: string;\r\n  type: BlockType;\r\n  content: Record<string, any>;\r\n}\r\n\r\nexport interface EmailTemplate {\r\n  id: string;\r\n  name: string;\r\n  subject: string;\r\n  blocks: EmailBlock[];\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n  category: 'promotional' | 'newsletter' | 'transactional' | 'welcome' | 'custom';\r\n}\r\n\r\nexport const defaultBlockContent: Record<BlockType, Record<string, any>> = {\r\n  header: {\r\n    text: 'Your Company Name',\r\n    fontSize: '24px',\r\n    color: '#1a1a1a',\r\n    alignment: 'center',\r\n    logoUrl: '',\r\n  },\r\n  text: {\r\n    text: 'Enter your text here...',\r\n    fontSize: '16px',\r\n    color: '#333333',\r\n    alignment: 'left',\r\n  },\r\n  image: {\r\n    src: 'https://placehold.co/600x300/e2e8f0/64748b?text=Your+Image',\r\n    alt: 'Image description',\r\n    width: '100%',\r\n    alignment: 'center',\r\n    link: '',\r\n  },\r\n  button: {\r\n    text: 'Click Here',\r\n    url: '#',\r\n    backgroundColor: '#3b82f6',\r\n    textColor: '#ffffff',\r\n    alignment: 'center',\r\n    borderRadius: '6px',\r\n  },\r\n  divider: {\r\n    color: '#e2e8f0',\r\n    thickness: '1px',\r\n    style: 'solid',\r\n    margin: '20px',\r\n  },\r\n  spacer: {\r\n    height: '30px',\r\n  },\r\n  columns: {\r\n    columns: 2,\r\n    gap: '20px',\r\n    content: [\r\n      { text: 'Column 1 content' },\r\n      { text: 'Column 2 content' },\r\n    ],\r\n  },\r\n  social: {\r\n    alignment: 'center',\r\n    icons: ['facebook', 'twitter', 'instagram', 'linkedin'],\r\n    iconSize: '32px',\r\n  },\r\n  footer: {\r\n    text: 'Â© 2024 Your Company. All rights reserved.',\r\n    fontSize: '12px',\r\n    color: '#6b7280',\r\n    alignment: 'center',\r\n    showUnsubscribe: true,\r\n  },\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\messaging\\ChannelBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\messaging\\ChannelIntegrations.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\messaging\\ConversationList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\messaging\\MessageThread.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\messaging\\MessagingAnalytics.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\messaging\\MessagingSystem.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\messaging\\mockData.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\messaging\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\pipeline\\AddLeadToPipelineDialog.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchAgents', 'fetchLeads', and 'selectedStageId'. Either include them or remove the dependency array.","line":92,"column":6,"nodeType":"ArrayExpression","endLine":92,"endColumn":36,"suggestions":[{"desc":"Update the dependencies array to be: [open, stages, defaultStageId, fetchLeads, fetchAgents, selectedStageId]","fix":{"range":[2679,2709],"text":"[open, stages, defaultStageId, fetchLeads, fetchAgents, selectedStageId]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":221,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":221,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6438,6441],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6438,6441],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport {\r\n  ResponsiveDialog,\r\n  ResponsiveDialogContent,\r\n  ResponsiveDialogHeader,\r\n  ResponsiveDialogTitle,\r\n  ResponsiveDialogTrigger,\r\n  ResponsiveDialogBody,\r\n  ResponsiveDialogFooter,\r\n} from \"@/components/ui/responsive-dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Checkbox } from \"@/components/ui/checkbox\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { Plus, Search, Loader2, Users, AlertCircle } from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\ninterface Lead {\r\n  id: string;\r\n  name: string;\r\n  phone: string | null;\r\n  email: string | null;\r\n  source: string | null;\r\n  budget: string | null;\r\n  stage: string | null;\r\n  created_at: string;\r\n}\r\n\r\ninterface PipelineStage {\r\n  id: string;\r\n  stage_name: string;\r\n  stage_order: number;\r\n  color: string;\r\n}\r\n\r\ninterface Agent {\r\n  id: string;\r\n  name: string;\r\n  email: string;\r\n}\r\n\r\ninterface AddLeadToPipelineDialogProps {\r\n  children?: React.ReactNode;\r\n  pipelineId: string;\r\n  stages: PipelineStage[];\r\n  existingLeadIds: string[];\r\n  onLeadsAdded?: () => void;\r\n  defaultStageId?: string;\r\n}\r\n\r\nexport function AddLeadToPipelineDialog({\r\n  children,\r\n  pipelineId,\r\n  stages,\r\n  existingLeadIds,\r\n  onLeadsAdded,\r\n  defaultStageId,\r\n}: AddLeadToPipelineDialogProps) {\r\n  const [open, setOpen] = useState(false);\r\n  const [searchQuery, setSearchQuery] = useState(\"\");\r\n  const [leads, setLeads] = useState<Lead[]>([]);\r\n  const [agents, setAgents] = useState<Agent[]>([]);\r\n  const [selectedLeads, setSelectedLeads] = useState<string[]>([]);\r\n  const [selectedStageId, setSelectedStageId] = useState<string>(defaultStageId || \"\");\r\n  const [selectedAgentId, setSelectedAgentId] = useState<string>(\"\");\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n  const { user } = useAuth();\r\n\r\n  // Fetch available leads when dialog opens\r\n  useEffect(() => {\r\n    if (open) {\r\n      fetchLeads();\r\n      fetchAgents();\r\n      // Set default stage to first one if not provided\r\n      if (stages.length > 0 && !selectedStageId) {\r\n        setSelectedStageId(defaultStageId || stages[0].id);\r\n      }\r\n    }\r\n  }, [open, stages, defaultStageId]);\r\n\r\n  const fetchLeads = async () => {\r\n    setIsLoading(true);\r\n    try {\r\n      const { data: profile } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"company_id\")\r\n        .eq(\"id\", user?.id)\r\n        .single();\r\n\r\n      if (!profile?.company_id) return;\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"leads\")\r\n        .select(\"id, name, phone, email, source, budget, stage, created_at\")\r\n        .eq(\"company_id\", profile.company_id)\r\n        .order(\"created_at\", { ascending: false })\r\n        .limit(200);\r\n\r\n      if (error) throw error;\r\n      setLeads(data || []);\r\n    } catch (error) {\r\n      console.error(\"Error fetching leads:\", error);\r\n      toast.error(\"Failed to load leads\");\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const fetchAgents = async () => {\r\n    try {\r\n      const { data: profile } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"company_id\")\r\n        .eq(\"id\", user?.id)\r\n        .single();\r\n\r\n      if (!profile?.company_id) return;\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"agents\")\r\n        .select(\"id, name, email\")\r\n        .eq(\"company_id\", profile.company_id)\r\n        .eq(\"status\", \"active\");\r\n\r\n      if (error) throw error;\r\n      setAgents(data || []);\r\n    } catch (error) {\r\n      console.error(\"Error fetching agents:\", error);\r\n    }\r\n  };\r\n\r\n  // Filter leads based on search and exclude already added leads\r\n  const availableLeads = leads.filter(\r\n    (lead) =>\r\n      !existingLeadIds.includes(lead.id) &&\r\n      (lead.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n        lead.phone?.includes(searchQuery) ||\r\n        lead.email?.toLowerCase().includes(searchQuery.toLowerCase()))\r\n  );\r\n\r\n  const toggleLeadSelection = (leadId: string) => {\r\n    setSelectedLeads((prev) =>\r\n      prev.includes(leadId)\r\n        ? prev.filter((id) => id !== leadId)\r\n        : [...prev, leadId]\r\n    );\r\n  };\r\n\r\n  const toggleSelectAll = () => {\r\n    if (selectedLeads.length === availableLeads.length) {\r\n      setSelectedLeads([]);\r\n    } else {\r\n      setSelectedLeads(availableLeads.map((l) => l.id));\r\n    }\r\n  };\r\n\r\n  const handleAddLeads = async () => {\r\n    if (selectedLeads.length === 0) {\r\n      toast.error(\"Please select at least one lead\");\r\n      return;\r\n    }\r\n\r\n    if (!selectedStageId) {\r\n      toast.error(\"Please select a stage\");\r\n      return;\r\n    }\r\n\r\n    setIsSubmitting(true);\r\n    try {\r\n      // Insert all selected leads into pipeline\r\n      const entries = selectedLeads.map((leadId) => ({\r\n        pipeline_id: pipelineId,\r\n        lead_id: leadId,\r\n        current_stage_id: selectedStageId,\r\n        assigned_agent_id: selectedAgentId || null,\r\n        added_by: user?.id,\r\n      }));\r\n\r\n      const { error } = await supabase\r\n        .from(\"lead_pipeline_entries\")\r\n        .insert(entries);\r\n\r\n      if (error) throw error;\r\n\r\n      // Create history records for each added lead\r\n      const { data: insertedEntries } = await supabase\r\n        .from(\"lead_pipeline_entries\")\r\n        .select(\"id\")\r\n        .in(\"lead_id\", selectedLeads)\r\n        .eq(\"pipeline_id\", pipelineId);\r\n\r\n      if (insertedEntries) {\r\n        const historyRecords = insertedEntries.map((entry) => ({\r\n          pipeline_entry_id: entry.id,\r\n          new_stage_id: selectedStageId,\r\n          new_agent_id: selectedAgentId || null,\r\n          change_type: \"added\",\r\n          changed_by: user?.id,\r\n        }));\r\n\r\n        await supabase.from(\"lead_pipeline_history\").insert(historyRecords);\r\n      }\r\n\r\n      toast.success(`${selectedLeads.length} lead(s) added to pipeline`);\r\n      setSelectedLeads([]);\r\n      setOpen(false);\r\n      onLeadsAdded?.();\r\n    } catch (error: any) {\r\n      console.error(\"Error adding leads to pipeline:\", error);\r\n      if (error.code === \"23505\") {\r\n        toast.error(\"Some leads are already in this pipeline\");\r\n      } else {\r\n        toast.error(\"Failed to add leads to pipeline\");\r\n      }\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <ResponsiveDialog open={open} onOpenChange={setOpen}>\r\n      <ResponsiveDialogTrigger asChild>\r\n        {children || (\r\n          <Button size=\"sm\">\r\n            <Plus className=\"h-4 w-4 mr-1\" />\r\n            Add Lead\r\n          </Button>\r\n        )}\r\n      </ResponsiveDialogTrigger>\r\n      <ResponsiveDialogContent className=\"sm:max-w-[500px]\">\r\n        <ResponsiveDialogHeader>\r\n          <ResponsiveDialogTitle className=\"flex items-center gap-2\">\r\n            <Users className=\"h-5 w-5\" />\r\n            Add Leads to Pipeline\r\n          </ResponsiveDialogTitle>\r\n        </ResponsiveDialogHeader>\r\n\r\n        <ResponsiveDialogBody className=\"space-y-4\">\r\n          {/* Search */}\r\n          <div className=\"relative\">\r\n            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n            <Input\r\n              placeholder=\"Search by name, phone, or email...\"\r\n              value={searchQuery}\r\n              onChange={(e) => setSearchQuery(e.target.value)}\r\n              className=\"pl-9\"\r\n            />\r\n          </div>\r\n\r\n          {/* Stage & Agent Selection */}\r\n          <div className=\"grid grid-cols-2 gap-3\">\r\n            <div className=\"space-y-1.5\">\r\n              <label className=\"text-xs font-medium\">Initial Stage *</label>\r\n              <Select value={selectedStageId} onValueChange={setSelectedStageId}>\r\n                <SelectTrigger className=\"h-9\">\r\n                  <SelectValue placeholder=\"Select stage\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {stages.map((stage) => (\r\n                    <SelectItem key={stage.id} value={stage.id}>\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <div\r\n                          className=\"w-2 h-2 rounded-full\"\r\n                          style={{ backgroundColor: stage.color }}\r\n                        />\r\n                        {stage.stage_name}\r\n                      </div>\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n            <div className=\"space-y-1.5\">\r\n              <label className=\"text-xs font-medium\">Assign Agent</label>\r\n            <Select value={selectedAgentId || \"unassigned\"} onValueChange={(val) => setSelectedAgentId(val === \"unassigned\" ? \"\" : val)}>\r\n                <SelectTrigger className=\"h-9\">\r\n                  <SelectValue placeholder=\"Optional\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"unassigned\">Unassigned</SelectItem>\r\n                  {agents.map((agent) => (\r\n                    <SelectItem key={agent.id} value={agent.id}>\r\n                      {agent.name}\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Select All */}\r\n          {availableLeads.length > 0 && (\r\n            <div className=\"flex items-center justify-between py-2 border-b\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <Checkbox\r\n                  checked={\r\n                    selectedLeads.length === availableLeads.length &&\r\n                    availableLeads.length > 0\r\n                  }\r\n                  onCheckedChange={toggleSelectAll}\r\n                />\r\n                <span className=\"text-sm text-muted-foreground\">\r\n                  Select all ({availableLeads.length} available)\r\n                </span>\r\n              </div>\r\n              {selectedLeads.length > 0 && (\r\n                <Badge variant=\"secondary\">\r\n                  {selectedLeads.length} selected\r\n                </Badge>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {/* Leads List */}\r\n          <ScrollArea className=\"h-[280px] pr-4\">\r\n            {isLoading ? (\r\n              <div className=\"flex items-center justify-center py-8\">\r\n                <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\r\n              </div>\r\n            ) : availableLeads.length === 0 ? (\r\n              <div className=\"flex flex-col items-center justify-center py-8 text-center\">\r\n                <AlertCircle className=\"h-8 w-8 text-muted-foreground mb-2\" />\r\n                <p className=\"text-sm text-muted-foreground\">\r\n                  {leads.length === existingLeadIds.length\r\n                    ? \"All leads are already in this pipeline\"\r\n                    : \"No leads found\"}\r\n                </p>\r\n              </div>\r\n            ) : (\r\n              <div className=\"space-y-2\">\r\n                {availableLeads.map((lead) => (\r\n                  <div\r\n                    key={lead.id}\r\n                    className={cn(\r\n                      \"flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-colors\",\r\n                      selectedLeads.includes(lead.id)\r\n                        ? \"border-primary bg-primary/5\"\r\n                        : \"hover:bg-muted/50\"\r\n                    )}\r\n                    onClick={() => toggleLeadSelection(lead.id)}\r\n                  >\r\n                    <Checkbox\r\n                      checked={selectedLeads.includes(lead.id)}\r\n                      onCheckedChange={() => toggleLeadSelection(lead.id)}\r\n                    />\r\n                    <Avatar className=\"h-9 w-9\">\r\n                      <AvatarImage\r\n                        src={`https://api.dicebear.com/7.x/initials/svg?seed=${lead.name}`}\r\n                      />\r\n                      <AvatarFallback>{lead.name[0]}</AvatarFallback>\r\n                    </Avatar>\r\n                    <div className=\"flex-1 min-w-0\">\r\n                      <p className=\"font-medium text-sm truncate\">{lead.name}</p>\r\n                      <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\r\n                        {lead.phone && <span>{lead.phone}</span>}\r\n                        {lead.source && (\r\n                          <Badge variant=\"outline\" className=\"text-[10px] h-4\">\r\n                            {lead.source}\r\n                          </Badge>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                    {lead.budget && (\r\n                      <span className=\"text-xs font-medium text-primary\">\r\n                        {lead.budget}\r\n                      </span>\r\n                    )}\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </ScrollArea>\r\n        </ResponsiveDialogBody>\r\n\r\n        <ResponsiveDialogFooter className=\"gap-2\">\r\n          <Button\r\n            variant=\"outline\"\r\n            onClick={() => setOpen(false)}\r\n            disabled={isSubmitting}\r\n          >\r\n            Cancel\r\n          </Button>\r\n          <Button\r\n            onClick={handleAddLeads}\r\n            disabled={selectedLeads.length === 0 || isSubmitting}\r\n          >\r\n            {isSubmitting ? (\r\n              <Loader2 className=\"h-4 w-4 mr-1 animate-spin\" />\r\n            ) : (\r\n              <Plus className=\"h-4 w-4 mr-1\" />\r\n            )}\r\n            Add {selectedLeads.length > 0 ? `${selectedLeads.length} Lead(s)` : \"Leads\"}\r\n          </Button>\r\n        </ResponsiveDialogFooter>\r\n      </ResponsiveDialogContent>\r\n    </ResponsiveDialog>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\presentation\\PresentationAgent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\presentation\\PresentationAmenities.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\presentation\\PresentationCompany.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\presentation\\PresentationCover.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\presentation\\PresentationDescription.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\presentation\\PresentationFloorPlan.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\presentation\\PresentationGallery.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\presentation\\PresentationMap.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\presentation\\PresentationSettingsPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\presentation\\PresentationSummary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\presentation\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\publish-portals\\ActivityLog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\publish-portals\\ListingSummary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\publish-portals\\PortalCustomizationPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":752,"column":88,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":752,"endColumn":91,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26631,26634],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26631,26634],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":787,"column":87,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":787,"endColumn":90,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28683,28686],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28683,28686],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useRef, useMemo } from \"react\";\r\nimport {\r\n  DndContext,\r\n  closestCenter,\r\n  KeyboardSensor,\r\n  PointerSensor,\r\n  useSensor,\r\n  useSensors,\r\n  DragEndEvent,\r\n} from \"@dnd-kit/core\";\r\nimport {\r\n  arrayMove,\r\n  SortableContext,\r\n  sortableKeyboardCoordinates,\r\n  useSortable,\r\n  rectSortingStrategy,\r\n} from \"@dnd-kit/sortable\";\r\nimport { CSS } from \"@dnd-kit/utilities\";\r\nimport {\r\n  ChevronDown,\r\n  ChevronUp,\r\n  Sparkles,\r\n  Check,\r\n  AlertCircle,\r\n  X,\r\n  GripVertical,\r\n  Plus,\r\n  Trash2,\r\n  Star,\r\n  Upload,\r\n  Eye,\r\n  Loader2,\r\n  Search,\r\n  ChevronsUpDown,\r\n  Globe,\r\n} from \"lucide-react\";\r\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Checkbox } from \"@/components/ui/checkbox\";\r\nimport { Progress } from \"@/components/ui/progress\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport {\r\n  Collapsible,\r\n  CollapsibleContent,\r\n  CollapsibleTrigger,\r\n} from \"@/components/ui/collapsible\";\r\nimport {\r\n  Command,\r\n  CommandEmpty,\r\n  CommandGroup,\r\n  CommandInput,\r\n  CommandItem,\r\n  CommandList,\r\n} from \"@/components/ui/command\";\r\nimport {\r\n  Popover,\r\n  PopoverContent,\r\n  PopoverTrigger,\r\n} from \"@/components/ui/popover\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { Portal, PortalCustomization, Agent, ListingSummary, PortalAgent } from \"./types\";\r\nimport { toast } from \"sonner\";\r\nimport { PortalPreviewModal } from \"./PortalPreviewModal\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\n\r\n// Sortable Image Item\r\ninterface SortableImageProps {\r\n  id: string;\r\n  image: string;\r\n  index: number;\r\n  isCover: boolean;\r\n  isSelected: boolean;\r\n  onToggle: () => void;\r\n  onSetCover: () => void;\r\n  onRemove: () => void;\r\n}\r\n\r\nfunction SortableImageItem({\r\n  id,\r\n  image,\r\n  index,\r\n  isCover,\r\n  isSelected,\r\n  onToggle,\r\n  onSetCover,\r\n  onRemove,\r\n}: SortableImageProps) {\r\n  const {\r\n    attributes,\r\n    listeners,\r\n    setNodeRef,\r\n    transform,\r\n    transition,\r\n    isDragging,\r\n  } = useSortable({ id });\r\n\r\n  const style = {\r\n    transform: CSS.Transform.toString(transform),\r\n    transition,\r\n    zIndex: isDragging ? 50 : undefined,\r\n  };\r\n\r\n  return (\r\n    <div\r\n      ref={setNodeRef}\r\n      style={style}\r\n      className={cn(\r\n        \"relative aspect-square rounded-lg overflow-hidden cursor-pointer group border-2 transition-all\",\r\n        isDragging && \"opacity-50 scale-105 shadow-lg\",\r\n        isSelected\r\n          ? \"border-primary ring-2 ring-primary/20\"\r\n          : \"border-transparent hover:border-primary/50\",\r\n        isCover && \"ring-2 ring-amber-500 ring-offset-2\"\r\n      )}\r\n      onClick={onToggle}\r\n    >\r\n      <img\r\n        src={image}\r\n        alt={`Image ${index + 1}`}\r\n        className=\"w-full h-full object-cover\"\r\n      />\r\n\r\n      {/* Cover Badge */}\r\n      {isCover && (\r\n        <Badge className=\"absolute top-1 left-1 text-[10px] px-1 py-0 bg-amber-500\">\r\n          <Star className=\"h-3 w-3 mr-0.5\" />\r\n          Cover\r\n        </Badge>\r\n      )}\r\n\r\n      {/* Selection Indicator */}\r\n      {isSelected && !isCover && (\r\n        <div className=\"absolute inset-0 bg-primary/20 flex items-center justify-center\">\r\n          <Check className=\"h-6 w-6 text-primary-foreground bg-primary rounded-full p-1\" />\r\n        </div>\r\n      )}\r\n\r\n      {/* Hover Actions */}\r\n      <div className=\"absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-1\">\r\n        <div className=\"flex items-center gap-1\">\r\n          <Button\r\n            variant=\"secondary\"\r\n            size=\"icon\"\r\n            className=\"h-7 w-7 cursor-grab active:cursor-grabbing\"\r\n            onClick={(e) => e.stopPropagation()}\r\n            {...attributes}\r\n            {...listeners}\r\n          >\r\n            <GripVertical className=\"h-3 w-3\" />\r\n          </Button>\r\n          {!isCover && (\r\n            <Button\r\n              variant=\"secondary\"\r\n              size=\"icon\"\r\n              className=\"h-7 w-7\"\r\n              onClick={(e) => {\r\n                e.stopPropagation();\r\n                onSetCover();\r\n              }}\r\n              title=\"Set as cover\"\r\n            >\r\n              <Star className=\"h-3 w-3\" />\r\n            </Button>\r\n          )}\r\n          <Button\r\n            variant=\"destructive\"\r\n            size=\"icon\"\r\n            className=\"h-7 w-7\"\r\n            onClick={(e) => {\r\n              e.stopPropagation();\r\n              onRemove();\r\n            }}\r\n          >\r\n            <Trash2 className=\"h-3 w-3\" />\r\n          </Button>\r\n        </div>\r\n        <span className=\"text-[10px] text-white/80\">Drag to reorder</span>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\ninterface PortalCustomizationPanelProps {\r\n  portal: Portal;\r\n  customization: PortalCustomization;\r\n  images: string[];\r\n  agents: Agent[];\r\n  portalAgents?: PortalAgent[];\r\n  isLoadingPortalAgents?: boolean;\r\n  amenitiesList: string[];\r\n  listing: ListingSummary;\r\n  onUpdate: (updates: Partial<PortalCustomization>) => void;\r\n  onImagesChange?: (newImages: string[]) => void;\r\n}\r\n\r\nconst propertyTypes = [\r\n  \"Apartment\",\r\n  \"Villa\",\r\n  \"Townhouse\",\r\n  \"Penthouse\",\r\n  \"Duplex\",\r\n  \"Studio\",\r\n  \"Land\",\r\n  \"Commercial\",\r\n  \"Office\",\r\n  \"Retail\",\r\n  \"Warehouse\",\r\n];\r\n\r\nconst featuresList = [\r\n  \"Sea View\",\r\n  \"City View\",\r\n  \"Balcony\",\r\n  \"Terrace\",\r\n  \"Garden\",\r\n  \"Private Pool\",\r\n  \"Built-in Wardrobes\",\r\n  \"Walk-in Closet\",\r\n  \"Central A/C\",\r\n  \"Kitchen Appliances\",\r\n  \"Smart Home\",\r\n  \"Private Elevator\",\r\n  \"Pets Allowed\",\r\n  \"Study Room\",\r\n  \"Maid's Room\",\r\n  \"Driver's Room\",\r\n  \"Private Garage\",\r\n  \"Laundry Room\",\r\n];\r\n\r\nconst tagsList = [\r\n  \"Hot Deal\",\r\n  \"Investment Opportunity\",\r\n  \"Exclusive\",\r\n  \"New Launch\",\r\n  \"Sea View\",\r\n  \"Luxury\",\r\n  \"Modern\",\r\n  \"Spacious\",\r\n  \"Prime Location\",\r\n  \"Fully Furnished\",\r\n  \"High ROI\",\r\n  \"Family Friendly\",\r\n];\r\n\r\nconst countryLocations: Record<string, string[]> = {\r\n  'Qatar': [\r\n    \"West Bay, Doha\",\r\n    \"The Pearl-Qatar, Doha\",\r\n    \"Lusail City, Doha\",\r\n    \"Musheireb, Doha\",\r\n    \"Al Waab, Doha\",\r\n    \"Al Sadd, Doha\",\r\n    \"Madinat Khalifa, Doha\",\r\n    \"Abu Hamour, Doha\",\r\n    \"Al Rayyan\",\r\n    \"Al Wakrah\",\r\n    \"Al Khor\",\r\n    \"Ain Khaled, Doha\",\r\n    \"Dafna, Doha\",\r\n    \"Msheireb Downtown Doha\"\r\n  ],\r\n  'UAE': [\r\n    \"Dubai Marina, Dubai\",\r\n    \"Downtown Dubai, Dubai\",\r\n    \"Palm Jumeirah, Dubai\",\r\n    \"Jumeirah Village Circle (JVC), Dubai\",\r\n    \"Business Bay, Dubai\",\r\n    \"Dubai Hills Estate, Dubai\",\r\n    \"Jumeirah Lake Towers (JLT), Dubai\",\r\n    \"Arabian Ranches, Dubai\",\r\n    \"Yas Island, Abu Dhabi\",\r\n    \"Saadiyat Island, Abu Dhabi\",\r\n    \"Al Reem Island, Abu Dhabi\",\r\n    \"Dubai South, Dubai\",\r\n    \"Mohammed Bin Rashid City, Dubai\",\r\n    \"Al Barsha, Dubai\"\r\n  ],\r\n  'Saudi Arabia': [\r\n    \"Riyadh\",\r\n    \"Jeddah\",\r\n    \"Dammam\",\r\n    \"Al Khobar\",\r\n    \"Mecca\",\r\n    \"Medina\",\r\n    \"Abha\",\r\n    \"Tabuk\",\r\n    \"Buraidah\",\r\n    \"Al Jubail\"\r\n  ],\r\n};\r\n\r\nexport function PortalCustomizationPanel({\r\n  portal,\r\n  customization,\r\n  images,\r\n  agents,\r\n  portalAgents = [],\r\n  isLoadingPortalAgents = false,\r\n  amenitiesList,\r\n  listing,\r\n  onUpdate,\r\n  onImagesChange,\r\n}: PortalCustomizationPanelProps) {\r\n  const getCurrency = (country?: string | null) => {\r\n    if (!country) return 'AED';\r\n    const map: Record<string, string> = {\r\n      'UAE': 'AED',\r\n      'Qatar': 'QAR',\r\n      'Saudi Arabia': 'SAR',\r\n      'Oman': 'OMR',\r\n      'Bahrain': 'BHD',\r\n      'Kuwait': 'KWD',\r\n      'Egypt': 'EGP',\r\n      'Lebanon': 'LBP'\r\n    };\r\n    return map[country] || 'AED';\r\n  };\r\n\r\n  const currency = getCurrency(portal.country);\r\n  const locationPlaceholder = portal.country === 'Qatar' ? \"e.g. West Bay, Doha\" :\r\n    portal.country === 'UAE' ? \"e.g. Dubai Marina, Dubai\" :\r\n      \"Enter location\";\r\n\r\n  const [isOpen, setIsOpen] = useState(true);\r\n  const [locationOpen, setLocationOpen] = useState(false);\r\n  const [locationSearch, setLocationSearch] = useState(\"\");\r\n  const [isGeneratingDescription, setIsGeneratingDescription] = useState(false);\r\n  const [localImages, setLocalImages] = useState<string[]>(images);\r\n  const [showPreview, setShowPreview] = useState(false);\r\n  const [isUploading, setIsUploading] = useState(false);\r\n  const [agentSearchOpen, setAgentSearchOpen] = useState(false);\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n  const locations = useMemo(() => {\r\n    if (!portal.country) return [];\r\n    return countryLocations[portal.country] || [];\r\n  }, [portal.country]);\r\n\r\n  const filteredLocations = useMemo(() => {\r\n    if (!locationSearch) return locations;\r\n    return locations.filter(l =>\r\n      l.toLowerCase().includes(locationSearch.toLowerCase())\r\n    );\r\n  }, [locations, locationSearch]);\r\n\r\n  const currentAgent = agents.find(a => a.id === customization.agentId);\r\n  const selectedPortalAgent = portalAgents.find(a => a.id === customization.agentId);\r\n\r\n  // DnD sensors\r\n  const sensors = useSensors(\r\n    useSensor(PointerSensor, {\r\n      activationConstraint: {\r\n        distance: 8,\r\n      },\r\n    }),\r\n    useSensor(KeyboardSensor, {\r\n      coordinateGetter: sortableKeyboardCoordinates,\r\n    })\r\n  );\r\n\r\n  const handleGenerateDescription = async () => {\r\n    setIsGeneratingDescription(true);\r\n    toast.loading(\"Generating optimized description...\", { id: \"gen-desc\" });\r\n\r\n    // Simulate AI generation\r\n    await new Promise((resolve) => setTimeout(resolve, 1500));\r\n\r\n    const optimizedDescription = `Discover this exceptional property perfect for ${portal.name}. Featuring modern design, premium finishes, and an ideal location. This property offers everything you need for comfortable living with easy access to amenities and transport links.`;\r\n\r\n    onUpdate({ description: optimizedDescription });\r\n    setIsGeneratingDescription(false);\r\n    toast.success(\"Description generated!\", { id: \"gen-desc\" });\r\n  };\r\n\r\n  const toggleImage = (index: number) => {\r\n    const newSelected = customization.selectedImages.includes(index)\r\n      ? customization.selectedImages.filter((i) => i !== index)\r\n      : [...customization.selectedImages, index];\r\n    onUpdate({ selectedImages: newSelected });\r\n  };\r\n\r\n  const handleDragEnd = (event: DragEndEvent) => {\r\n    const { active, over } = event;\r\n\r\n    if (over && active.id !== over.id) {\r\n      const oldIndex = localImages.findIndex((img) => img === active.id);\r\n      const newIndex = localImages.findIndex((img) => img === over.id);\r\n      const newImages = arrayMove(localImages, oldIndex, newIndex);\r\n      setLocalImages(newImages);\r\n      onImagesChange?.(newImages);\r\n\r\n      // Update selected images indices\r\n      const newSelectedImages = customization.selectedImages.map((selectedIdx) => {\r\n        if (selectedIdx === oldIndex) return newIndex;\r\n        if (oldIndex < newIndex) {\r\n          if (selectedIdx > oldIndex && selectedIdx <= newIndex) return selectedIdx - 1;\r\n        } else {\r\n          if (selectedIdx >= newIndex && selectedIdx < oldIndex) return selectedIdx + 1;\r\n        }\r\n        return selectedIdx;\r\n      });\r\n      onUpdate({ selectedImages: newSelectedImages });\r\n      toast.success(\"Image order updated\");\r\n    }\r\n  };\r\n\r\n  const setCoverImage = (index: number) => {\r\n    // Move image to first position in selected images\r\n    const newSelected = [index, ...customization.selectedImages.filter((i) => i !== index)];\r\n    onUpdate({ selectedImages: newSelected });\r\n    toast.success(\"Cover image set\");\r\n  };\r\n\r\n  const handleAddImages = () => {\r\n    fileInputRef.current?.click();\r\n  };\r\n\r\n  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const files = e.target.files;\r\n    if (!files || files.length === 0) return;\r\n\r\n    setIsUploading(true);\r\n    toast.loading(`Uploading ${files.length} image(s)...`, { id: \"upload-images\" });\r\n\r\n    try {\r\n      const uploadedUrls: string[] = [];\r\n\r\n      for (const file of Array.from(files)) {\r\n        // Generate unique filename\r\n        const fileExt = file.name.split('.').pop();\r\n        const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 15)}.${fileExt}`;\r\n        const filePath = `listings/${fileName}`;\r\n\r\n        // Upload to Supabase storage\r\n        const { data, error } = await supabase.storage\r\n          .from('property-media')\r\n          .upload(filePath, file, {\r\n            cacheControl: '3600',\r\n            upsert: false,\r\n          });\r\n\r\n        if (error) {\r\n          console.error('Upload error:', error);\r\n          continue;\r\n        }\r\n\r\n        // Get public URL\r\n        const { data: urlData } = supabase.storage\r\n          .from('property-media')\r\n          .getPublicUrl(filePath);\r\n\r\n        if (urlData?.publicUrl) {\r\n          uploadedUrls.push(urlData.publicUrl);\r\n        }\r\n      }\r\n\r\n      if (uploadedUrls.length > 0) {\r\n        const updatedImages = [...localImages, ...uploadedUrls];\r\n        setLocalImages(updatedImages);\r\n        onImagesChange?.(updatedImages);\r\n\r\n        // Auto-select new images\r\n        const newIndices = uploadedUrls.map((_, idx) => localImages.length + idx);\r\n        onUpdate({ selectedImages: [...customization.selectedImages, ...newIndices] });\r\n\r\n        toast.success(`${uploadedUrls.length} image(s) uploaded successfully`, { id: \"upload-images\" });\r\n      } else {\r\n        toast.error(\"Failed to upload images\", { id: \"upload-images\" });\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Error uploading images:\", err);\r\n      toast.error(\"Failed to upload images\", { id: \"upload-images\" });\r\n    } finally {\r\n      setIsUploading(false);\r\n      // Reset input\r\n      if (fileInputRef.current) {\r\n        fileInputRef.current.value = \"\";\r\n      }\r\n    }\r\n  };\r\n\r\n  const removeImage = (index: number) => {\r\n    const newImages = localImages.filter((_, i) => i !== index);\r\n    setLocalImages(newImages);\r\n    onImagesChange?.(newImages);\r\n\r\n    // Update selected images\r\n    const newSelected = customization.selectedImages\r\n      .filter((i) => i !== index)\r\n      .map((i) => (i > index ? i - 1 : i));\r\n    onUpdate({ selectedImages: newSelected });\r\n    toast.success(\"Image removed\");\r\n  };\r\n\r\n  const toggleAmenity = (amenity: string) => {\r\n    const newAmenities = customization.amenities.includes(amenity)\r\n      ? customization.amenities.filter((a) => a !== amenity)\r\n      : [...customization.amenities, amenity];\r\n    onUpdate({ amenities: newAmenities });\r\n  };\r\n\r\n  const addKeyword = (keyword: string) => {\r\n    if (keyword && !customization.seoKeywords.includes(keyword)) {\r\n      onUpdate({ seoKeywords: [...customization.seoKeywords, keyword] });\r\n    }\r\n  };\r\n\r\n  const removeKeyword = (keyword: string) => {\r\n    onUpdate({\r\n      seoKeywords: customization.seoKeywords.filter((k) => k !== keyword),\r\n    });\r\n  };\r\n\r\n  const validationColor = customization.validationScore >= 90\r\n    ? \"text-emerald-600\"\r\n    : customization.validationScore >= 70\r\n      ? \"text-amber-600\"\r\n      : \"text-red-600\";\r\n\r\n  return (\r\n    <Collapsible open={isOpen} onOpenChange={setIsOpen}>\r\n      <Card className={cn(\"transition-all\", isOpen && \"ring-1 ring-primary/20\")}>\r\n        <CollapsibleTrigger asChild>\r\n          <CardHeader className=\"cursor-pointer hover:bg-secondary/30 transition-colors p-3 sm:p-4\">\r\n            <div className=\"flex items-center justify-between gap-2\">\r\n              <div className=\"flex items-center gap-2 sm:gap-3 min-w-0 flex-1\">\r\n                <div className=\"h-7 w-7 sm:h-8 sm:w-8 rounded-lg bg-secondary flex items-center justify-center shrink-0\">\r\n                  <span className=\"text-[10px] sm:text-xs font-bold\">\r\n                    {portal.name.substring(0, 2).toUpperCase()}\r\n                  </span>\r\n                </div>\r\n                <div className=\"min-w-0 flex-1\">\r\n                  <h4 className=\"font-semibold text-sm sm:text-base truncate\">{portal.name}</h4>\r\n                  <p className=\"text-[10px] sm:text-xs text-muted-foreground\">\r\n                    {customization.selectedImages.length} images\r\n                  </p>\r\n                </div>\r\n              </div>\r\n              <div className=\"flex items-center gap-1.5 sm:gap-3 shrink-0\">\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  className=\"gap-1 h-7 sm:h-8 px-2 sm:px-3 text-xs\"\r\n                  onClick={(e) => {\r\n                    e.stopPropagation();\r\n                    setShowPreview(true);\r\n                  }}\r\n                >\r\n                  <Eye className=\"h-3 w-3 sm:h-4 sm:w-4\" />\r\n                  <span className=\"hidden sm:inline\">Preview</span>\r\n                </Button>\r\n                <div className=\"hidden sm:flex items-center gap-2\">\r\n                  <Progress\r\n                    value={customization.validationScore}\r\n                    className=\"w-16 sm:w-20 h-2\"\r\n                  />\r\n                  <span className={cn(\"text-xs sm:text-sm font-medium\", validationColor)}>\r\n                    {customization.validationScore}%\r\n                  </span>\r\n                </div>\r\n                {customization.isValid ? (\r\n                  <Badge className=\"bg-emerald-100 text-emerald-700 border-emerald-200 text-[10px] sm:text-xs px-1.5 sm:px-2 py-0\">\r\n                    <Check className=\"h-2.5 w-2.5 sm:h-3 sm:w-3 mr-0.5\" />\r\n                    <span className=\"hidden sm:inline\">Valid</span>\r\n                  </Badge>\r\n                ) : (\r\n                  <Badge variant=\"destructive\" className=\"text-[10px] sm:text-xs px-1.5 sm:px-2 py-0\">\r\n                    <AlertCircle className=\"h-2.5 w-2.5 sm:h-3 sm:w-3 mr-0.5\" />\r\n                    <span className=\"hidden sm:inline\">Issues</span>\r\n                  </Badge>\r\n                )}\r\n                {isOpen ? (\r\n                  <ChevronUp className=\"h-4 w-4 sm:h-5 sm:w-5 text-muted-foreground\" />\r\n                ) : (\r\n                  <ChevronDown className=\"h-4 w-4 sm:h-5 sm:w-5 text-muted-foreground\" />\r\n                )}\r\n              </div>\r\n            </div>\r\n          </CardHeader>\r\n        </CollapsibleTrigger>\r\n\r\n        <CollapsibleContent>\r\n          <CardContent className=\"space-y-3 sm:space-y-4 pt-0 px-3 sm:px-6\">\r\n            {/* Validation Errors */}\r\n            {customization.errors.length > 0 && (\r\n              <div className=\"p-2 sm:p-3 bg-destructive/10 rounded-lg space-y-1\">\r\n                <p className=\"text-xs sm:text-sm font-medium text-destructive\">Missing Requirements:</p>\r\n                {customization.errors.map((error, i) => (\r\n                  <p key={i} className=\"text-xs sm:text-sm text-destructive flex items-center gap-1.5\">\r\n                    <X className=\"h-3 w-3 shrink-0\" />\r\n                    {error}\r\n                  </p>\r\n                ))}\r\n              </div>\r\n            )}\r\n\r\n            {/* Basic Info Section - Collapsible on mobile */}\r\n            <Collapsible defaultOpen className=\"border rounded-lg\">\r\n              <CollapsibleTrigger className=\"flex items-center justify-between w-full p-2.5 sm:p-3 hover:bg-secondary/30 transition-colors\">\r\n                <span className=\"text-xs sm:text-sm font-medium\">Basic Information</span>\r\n                <ChevronDown className=\"h-4 w-4 text-muted-foreground transition-transform [[data-state=open]>&]:rotate-180\" />\r\n              </CollapsibleTrigger>\r\n              <CollapsibleContent className=\"px-2.5 sm:px-3 pb-2.5 sm:pb-3 space-y-3\">\r\n                {/* Title */}\r\n                <div className=\"space-y-1.5\">\r\n                  <Label htmlFor={`title-${portal.id}`} className=\"text-xs sm:text-sm\">Listing Title</Label>\r\n                  <Input\r\n                    id={`title-${portal.id}`}\r\n                    value={customization.title}\r\n                    onChange={(e) => onUpdate({ title: e.target.value })}\r\n                    placeholder=\"Enter listing title\"\r\n                    className=\"h-9 sm:h-10 text-sm\"\r\n                  />\r\n                </div>\r\n\r\n                {/* Description */}\r\n                <div className=\"space-y-1.5\">\r\n                  <div className=\"flex items-center justify-between gap-2\">\r\n                    <Label htmlFor={`desc-${portal.id}`} className=\"text-xs sm:text-sm\">Description</Label>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      onClick={handleGenerateDescription}\r\n                      disabled={isGeneratingDescription}\r\n                      className=\"h-7 sm:h-8 text-xs px-2 sm:px-3\"\r\n                    >\r\n                      <Sparkles className=\"h-3 w-3 sm:mr-1\" />\r\n                      <span className=\"hidden sm:inline\">{isGeneratingDescription ? \"Generating...\" : \"Auto-Generate\"}</span>\r\n                    </Button>\r\n                  </div>\r\n                  <Textarea\r\n                    id={`desc-${portal.id}`}\r\n                    value={customization.description}\r\n                    onChange={(e) => onUpdate({ description: e.target.value })}\r\n                    placeholder=\"Enter listing description\"\r\n                    rows={3}\r\n                    className=\"text-sm resize-none\"\r\n                  />\r\n                  <p className=\"text-[10px] sm:text-xs text-muted-foreground\">\r\n                    {customization.description.length} characters\r\n                  </p>\r\n                </div>\r\n\r\n                {/* Price & Property Type */}\r\n                <div className=\"grid grid-cols-2 gap-2 sm:gap-3\">\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label htmlFor={`price-${portal.id}`} className=\"text-xs sm:text-sm\">Price</Label>\r\n                    <Input\r\n                      id={`price-${portal.id}`}\r\n                      value={customization.price}\r\n                      onChange={(e) => onUpdate({ price: e.target.value })}\r\n                      placeholder={`${currency} 2,500,000`}\r\n                      className=\"h-9 sm:h-10 text-sm\"\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label className=\"text-xs sm:text-sm\">Property Type</Label>\r\n                    <Select\r\n                      value={customization.propertyType}\r\n                      onValueChange={(value) => onUpdate({ propertyType: value })}\r\n                    >\r\n                      <SelectTrigger className=\"h-9 sm:h-10 text-sm\">\r\n                        <SelectValue placeholder=\"Select\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        {propertyTypes.map((type) => (\r\n                          <SelectItem key={type} value={type} className=\"text-sm\">\r\n                            {type}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Location */}\r\n                <div className=\"space-y-1.5\">\r\n                  <Label htmlFor={`location-${portal.id}`} className=\"text-xs sm:text-sm\">Location</Label>\r\n                  <Popover open={locationOpen} onOpenChange={setLocationOpen}>\r\n                    <PopoverTrigger asChild>\r\n                      <div className=\"relative\">\r\n                        <Input\r\n                          id={`location-${portal.id}`}\r\n                          value={customization.location || \"\"}\r\n                          onChange={(e) => {\r\n                            onUpdate({ location: e.target.value });\r\n                            setLocationSearch(e.target.value);\r\n                            if (!locationOpen) setLocationOpen(true);\r\n                          }}\r\n                          onFocus={() => {\r\n                            setLocationSearch(customization.location || \"\");\r\n                            setLocationOpen(true);\r\n                          }}\r\n                          placeholder={locationPlaceholder}\r\n                          className=\"h-9 sm:h-10 text-sm pr-9\"\r\n                        />\r\n                        <div className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground\">\r\n                          <Search className=\"h-4 w-4\" />\r\n                        </div>\r\n                      </div>\r\n                    </PopoverTrigger>\r\n                    <PopoverContent className=\"p-0 w-[var(--radix-popover-trigger-width)]\" align=\"start\">\r\n                      <Command shouldFilter={false}>\r\n                        <CommandList>\r\n                          <CommandEmpty>No locations found.</CommandEmpty>\r\n                          <CommandGroup heading=\"Suggestions\">\r\n                            {filteredLocations.map((loc) => (\r\n                              <CommandItem\r\n                                key={loc}\r\n                                value={loc}\r\n                                onSelect={() => {\r\n                                  onUpdate({ location: loc });\r\n                                  setLocationOpen(false);\r\n                                }}\r\n                                className=\"text-sm\"\r\n                              >\r\n                                <Check\r\n                                  className={cn(\r\n                                    \"mr-2 h-4 w-4\",\r\n                                    customization.location === loc ? \"opacity-100\" : \"opacity-0\"\r\n                                  )}\r\n                                />\r\n                                {loc}\r\n                              </CommandItem>\r\n                            ))}\r\n                          </CommandGroup>\r\n                        </CommandList>\r\n                      </Command>\r\n                    </PopoverContent>\r\n                  </Popover>\r\n                </div>\r\n\r\n                {/* Property Status & Details */}\r\n                <div className=\"grid grid-cols-2 gap-2 sm:gap-3\">\r\n                  {customization.purpose === 'Rent' && (\r\n                    <div className=\"space-y-3\">\r\n                      <div className=\"space-y-1.5\">\r\n                        <Label className=\"text-xs sm:text-sm\">Rent Frequency</Label>\r\n                        <Select\r\n                          value={customization.rentFrequency || \"Yearly\"}\r\n                          onValueChange={(value) => onUpdate({ rentFrequency: value as any })}\r\n                        >\r\n                          <SelectTrigger className=\"h-9 sm:h-10 text-sm\">\r\n                            <SelectValue placeholder=\"Select\" />\r\n                          </SelectTrigger>\r\n                          <SelectContent>\r\n                            <SelectItem value=\"Yearly\" className=\"text-sm\">Yearly</SelectItem>\r\n                            <SelectItem value=\"Monthly\" className=\"text-sm\">Monthly</SelectItem>\r\n                            <SelectItem value=\"Weekly\" className=\"text-sm\">Weekly</SelectItem>\r\n                            <SelectItem value=\"Daily\" className=\"text-sm\">Daily</SelectItem>\r\n                          </SelectContent>\r\n                        </Select>\r\n                      </div>\r\n                      <div className=\"space-y-1.5\">\r\n                        <Label className=\"text-xs sm:text-sm\">Number of Cheques</Label>\r\n                        <Select\r\n                          value={customization.cheques?.toString() || \"\"}\r\n                          onValueChange={(value) => onUpdate({ cheques: parseInt(value) })}\r\n                        >\r\n                          <SelectTrigger className=\"h-9 sm:h-10 text-sm\">\r\n                            <SelectValue placeholder=\"Select\" />\r\n                          </SelectTrigger>\r\n                          <SelectContent>\r\n                            {[1, 2, 4, 6, 12].map(num => (\r\n                              <SelectItem key={num} value={num.toString()} className=\"text-sm\">{num} Cheques</SelectItem>\r\n                            ))}\r\n                          </SelectContent>\r\n                        </Select>\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label className=\"text-xs sm:text-sm\">Completion Status</Label>\r\n                    <Select\r\n                      value={customization.completionStatus || \"Ready\"}\r\n                      onValueChange={(value) => onUpdate({ completionStatus: value as any })}\r\n                    >\r\n                      <SelectTrigger className=\"h-9 sm:h-10 text-sm\">\r\n                        <SelectValue placeholder=\"Select\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"Ready\" className=\"text-sm\">Ready</SelectItem>\r\n                        <SelectItem value=\"Off-plan\" className=\"text-sm\">Off-plan</SelectItem>\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-2 gap-2 sm:gap-3\">\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label htmlFor={`developer-${portal.id}`} className=\"text-xs sm:text-sm\">Developer (Optional)</Label>\r\n                    <Input\r\n                      id={`developer-${portal.id}`}\r\n                      value={customization.developer || \"\"}\r\n                      onChange={(e) => onUpdate({ developer: e.target.value })}\r\n                      placeholder=\"e.g. Emaar\"\r\n                      className=\"h-9 sm:h-10 text-sm\"\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label htmlFor={`project-${portal.id}`} className=\"text-xs sm:text-sm\">Project (Optional)</Label>\r\n                    <Input\r\n                      id={`project-${portal.id}`}\r\n                      value={customization.projectName || \"\"}\r\n                      onChange={(e) => onUpdate({ projectName: e.target.value })}\r\n                      placeholder=\"e.g. Dubai Marina\"\r\n                      className=\"h-9 sm:h-10 text-sm\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"space-y-1.5\">\r\n                  <Label htmlFor={`building-${portal.id}`} className=\"text-xs sm:text-sm\">Building Name (Optional)</Label>\r\n                  <Input\r\n                    id={`building-${portal.id}`}\r\n                    value={customization.buildingName || \"\"}\r\n                    onChange={(e) => onUpdate({ buildingName: e.target.value })}\r\n                    placeholder=\"e.g. Marina Gate\"\r\n                    className=\"h-9 sm:h-10 text-sm\"\r\n                  />\r\n                </div>\r\n\r\n                {portal.country === 'UAE' && (\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label htmlFor={`permit-${portal.id}`} className=\"text-xs sm:text-sm\">Permit Number</Label>\r\n                    <Input\r\n                      id={`permit-${portal.id}`}\r\n                      value={customization.permitNumber || \"\"}\r\n                      onChange={(e) => onUpdate({ permitNumber: e.target.value })}\r\n                      placeholder=\"e.g. 7123456789\"\r\n                      className=\"h-9 sm:h-10 text-sm border-amber-200 focus-visible:ring-amber-500\"\r\n                    />\r\n                  </div>\r\n                )}\r\n\r\n                {/* Floor and Parking */}\r\n                <div className=\"grid grid-cols-2 gap-2 sm:gap-3\">\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label htmlFor={`floor-${portal.id}`} className=\"text-xs sm:text-sm\">Floor Number (Optional)</Label>\r\n                    <Input\r\n                      id={`floor-${portal.id}`}\r\n                      type=\"number\"\r\n                      value={customization.floorNumber || \"\"}\r\n                      onChange={(e) => onUpdate({ floorNumber: parseInt(e.target.value) || 0 })}\r\n                      placeholder=\"e.g. 15\"\r\n                      className=\"h-9 sm:h-10 text-sm\"\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label htmlFor={`parking-${portal.id}`} className=\"text-xs sm:text-sm\">Parking Spaces (Optional)</Label>\r\n                    <Input\r\n                      id={`parking-${portal.id}`}\r\n                      type=\"number\"\r\n                      value={customization.parkingSpaces || \"\"}\r\n                      onChange={(e) => onUpdate({ parkingSpaces: parseInt(e.target.value) || 0 })}\r\n                      placeholder=\"e.g. 1\"\r\n                      className=\"h-9 sm:h-10 text-sm\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Bedrooms, Bathrooms, Size */}\r\n                <div className=\"grid grid-cols-3 gap-2 sm:gap-3\">\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label htmlFor={`beds-${portal.id}`} className=\"text-xs sm:text-sm\">Beds</Label>\r\n                    <Input\r\n                      id={`beds-${portal.id}`}\r\n                      type=\"number\"\r\n                      value={customization.bedrooms || \"\"}\r\n                      onChange={(e) => onUpdate({ bedrooms: parseInt(e.target.value) || 0 })}\r\n                      placeholder=\"3\"\r\n                      className=\"h-9 sm:h-10 text-sm\"\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label htmlFor={`baths-${portal.id}`} className=\"text-xs sm:text-sm\">Baths</Label>\r\n                    <Input\r\n                      id={`baths-${portal.id}`}\r\n                      type=\"number\"\r\n                      value={customization.bathrooms || \"\"}\r\n                      onChange={(e) => onUpdate({ bathrooms: parseInt(e.target.value) || 0 })}\r\n                      placeholder=\"2\"\r\n                      className=\"h-9 sm:h-10 text-sm\"\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label htmlFor={`size-${portal.id}`} className=\"text-xs sm:text-sm\">Size</Label>\r\n                    <Input\r\n                      id={`size-${portal.id}`}\r\n                      value={customization.size || \"\"}\r\n                      onChange={(e) => onUpdate({ size: e.target.value })}\r\n                      placeholder=\"1,500 sqft\"\r\n                      className=\"h-9 sm:h-10 text-sm\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Purpose & Furnishing */}\r\n                <div className=\"grid grid-cols-2 gap-2 sm:gap-3\">\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label className=\"text-xs sm:text-sm\">Purpose</Label>\r\n                    <Select\r\n                      value={customization.purpose || \"Sale\"}\r\n                      onValueChange={(value) => onUpdate({ purpose: value as 'Sale' | 'Rent' })}\r\n                    >\r\n                      <SelectTrigger className=\"h-9 sm:h-10 text-sm\">\r\n                        <SelectValue placeholder=\"Select\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"Sale\" className=\"text-sm\">For Sale</SelectItem>\r\n                        <SelectItem value=\"Rent\" className=\"text-sm\">For Rent</SelectItem>\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label className=\"text-xs sm:text-sm\">Furnishing (Optional)</Label>\r\n                    <Select\r\n                      value={customization.furnishing || \"\"}\r\n                      onValueChange={(value) => onUpdate({ furnishing: value })}\r\n                    >\r\n                      <SelectTrigger className=\"h-9 sm:h-10 text-sm\">\r\n                        <SelectValue placeholder=\"Select\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"Furnished\" className=\"text-sm\">Furnished</SelectItem>\r\n                        <SelectItem value=\"Semi-Furnished\" className=\"text-sm\">Semi-Furnished</SelectItem>\r\n                        <SelectItem value=\"Unfurnished\" className=\"text-sm\">Unfurnished</SelectItem>\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Country-Specific: UAE Permit Number */}\r\n                {portal.country === 'UAE' && (\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label htmlFor={`permit-${portal.id}`} className=\"text-xs sm:text-sm\">\r\n                      Permit Number (Trakheesi)\r\n                    </Label>\r\n                    <Input\r\n                      id={`permit-${portal.id}`}\r\n                      value={customization.permitNumber || \"\"}\r\n                      onChange={(e) => onUpdate({ permitNumber: e.target.value })}\r\n                      placeholder=\"Enter permit number\"\r\n                      className=\"h-9 sm:h-10 text-sm\"\r\n                    />\r\n                  </div>\r\n                )}\r\n\r\n                {/* Qatar-Specific fields could go here if any */}\r\n                {portal.country === 'Qatar' && (\r\n                  <div className=\"text-[10px] text-muted-foreground italic px-1\">\r\n                    No permit number required for Qatar portals.\r\n                  </div>\r\n                )}\r\n              </CollapsibleContent>\r\n            </Collapsible>\r\n            \\\r\n            {/* Advanced Mapping & Media */}\r\n            <Collapsible>\r\n              <CollapsibleTrigger asChild>\r\n                <div className=\"flex items-center justify-between p-3 sm:p-4 bg-muted/30 hover:bg-muted/50 rounded-lg cursor-pointer transition-colors\">\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <Globe className=\"h-4 w-4 text-primary\" />\r\n                    <span className=\"text-xs sm:text-sm font-medium\">Advanced Mapping & Media</span>\r\n                  </div>\r\n                  <ChevronDown className=\"h-4 w-4 text-muted-foreground\" />\r\n                </div>\r\n              </CollapsibleTrigger>\r\n              <CollapsibleContent className=\"space-y-4 pt-4 px-1 pb-2\">\r\n                {/* Coordinates */}\r\n                <div className=\"grid grid-cols-2 gap-2 sm:gap-3\">\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label htmlFor={`lat-${portal.id}`} className=\"text-xs sm:text-sm\">Latitude</Label>\r\n                    <Input\r\n                      id={`lat-${portal.id}`}\r\n                      type=\"number\"\r\n                      step=\"any\"\r\n                      value={customization.latitude || \"\"}\r\n                      onChange={(e) => onUpdate({ latitude: parseFloat(e.target.value) || 0 })}\r\n                      placeholder=\"e.g. 25.2048\"\r\n                      className=\"h-9 sm:h-10 text-sm\"\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label htmlFor={`long-${portal.id}`} className=\"text-xs sm:text-sm\">Longitude</Label>\r\n                    <Input\r\n                      id={`long-${portal.id}`}\r\n                      type=\"number\"\r\n                      step=\"any\"\r\n                      value={customization.longitude || \"\"}\r\n                      onChange={(e) => onUpdate({ longitude: parseFloat(e.target.value) || 0 })}\r\n                      placeholder=\"e.g. 55.2708\"\r\n                      className=\"h-9 sm:h-10 text-sm\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Plot Size & View */}\r\n                <div className=\"grid grid-cols-2 gap-2 sm:gap-3\">\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label htmlFor={`plot-${portal.id}`} className=\"text-xs sm:text-sm\">Plot Size (Optional)</Label>\r\n                    <Input\r\n                      id={`plot-${portal.id}`}\r\n                      value={customization.plotSize || \"\"}\r\n                      onChange={(e) => onUpdate({ plotSize: e.target.value })}\r\n                      placeholder=\"e.g. 6,000 sqft\"\r\n                      className=\"h-9 sm:h-10 text-sm\"\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label htmlFor={`view-${portal.id}`} className=\"text-xs sm:text-sm\">Property View (Optional)</Label>\r\n                    <Input\r\n                      id={`view-${portal.id}`}\r\n                      value={customization.view || \"\"}\r\n                      onChange={(e) => onUpdate({ view: e.target.value })}\r\n                      placeholder=\"e.g. Full Marina View\"\r\n                      className=\"h-9 sm:h-10 text-sm\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Occupancy & Service Charges */}\r\n                <div className=\"grid grid-cols-2 gap-2 sm:gap-3\">\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label className=\"text-xs sm:text-sm\">Occupancy</Label>\r\n                    <Select\r\n                      value={customization.occupancy || \"\"}\r\n                      onValueChange={(value) => onUpdate({ occupancy: value })}\r\n                    >\r\n                      <SelectTrigger className=\"h-9 sm:h-10 text-sm\">\r\n                        <SelectValue placeholder=\"Select\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"Vacant\" className=\"text-sm\">Vacant</SelectItem>\r\n                        <SelectItem value=\"Tenanted\" className=\"text-sm\">Tenanted</SelectItem>\r\n                        <SelectItem value=\"Owner Occupied\" className=\"text-sm\">Owner Occupied</SelectItem>\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label htmlFor={`service-${portal.id}`} className=\"text-xs sm:text-sm\">Service Charges (AED/yr)</Label>\r\n                    <Input\r\n                      id={`service-${portal.id}`}\r\n                      type=\"number\"\r\n                      value={customization.serviceCharges || \"\"}\r\n                      onChange={(e) => onUpdate({ serviceCharges: parseFloat(e.target.value) || 0 })}\r\n                      placeholder=\"e.g. 25000\"\r\n                      className=\"h-9 sm:h-10 text-sm\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Ownership Type */}\r\n                <div className=\"space-y-1.5\">\r\n                  <Label className=\"text-xs sm:text-sm\">Ownership Type (Optional)</Label>\r\n                  <Select\r\n                    value={customization.ownershipType || \"\"}\r\n                    onValueChange={(value) => onUpdate({ ownershipType: value })}\r\n                  >\r\n                    <SelectTrigger className=\"h-9 sm:h-10 text-sm\">\r\n                      <SelectValue placeholder=\"Select\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      <SelectItem value=\"Freehold\" className=\"text-sm\">Freehold</SelectItem>\r\n                      <SelectItem value=\"Leasehold\" className=\"text-sm\">Leasehold</SelectItem>\r\n                      <SelectItem value=\"Commonhold\" className=\"text-sm\">Commonhold</SelectItem>\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n\r\n                {/* Media Links */}\r\n                <div className=\"space-y-3\">\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label htmlFor={`video-${portal.id}`} className=\"text-xs sm:text-sm\">Video URL (YouTube/Vimeo)</Label>\r\n                    <Input\r\n                      id={`video-${portal.id}`}\r\n                      value={customization.videoUrl || \"\"}\r\n                      onChange={(e) => onUpdate({ videoUrl: e.target.value })}\r\n                      placeholder=\"https://youtu.be/...\"\r\n                      className=\"h-9 sm:h-10 text-sm\"\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label htmlFor={`tour-${portal.id}`} className=\"text-xs sm:text-sm\">360 Virtual Tour URL</Label>\r\n                    <Input\r\n                      id={`tour-${portal.id}`}\r\n                      value={customization.tourUrl || \"\"}\r\n                      onChange={(e) => onUpdate({ tourUrl: e.target.value })}\r\n                      placeholder=\"https://my.matterport.com/...\"\r\n                      className=\"h-9 sm:h-10 text-sm\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n              </CollapsibleContent>\r\n            </Collapsible>\r\n\r\n            {/* Features Section - NEW */}\r\n            <Collapsible className=\"border rounded-lg\">\r\n              <CollapsibleTrigger className=\"flex items-center justify-between w-full p-2.5 sm:p-3 hover:bg-secondary/30 transition-colors\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  <span className=\"text-xs sm:text-sm font-medium\">Features (Optional)</span>\r\n                  <Badge variant=\"secondary\" className=\"text-[10px] px-1.5 py-0\">\r\n                    {(customization.features || []).length}\r\n                  </Badge>\r\n                </div>\r\n                <ChevronDown className=\"h-4 w-4 text-muted-foreground transition-transform [[data-state=open]>&]:rotate-180\" />\r\n              </CollapsibleTrigger>\r\n              <CollapsibleContent className=\"px-2.5 sm:px-3 pb-2.5 sm:pb-3\">\r\n                <div className=\"flex flex-wrap gap-1.5 sm:gap-2\">\r\n                  {featuresList.map((feature) => (\r\n                    <Badge\r\n                      key={feature}\r\n                      variant={(customization.features || []).includes(feature) ? \"default\" : \"outline\"}\r\n                      className=\"cursor-pointer transition-all text-[10px] sm:text-xs px-2 py-0.5\"\r\n                      onClick={() => {\r\n                        const currentFeatures = customization.features || [];\r\n                        const newFeatures = currentFeatures.includes(feature)\r\n                          ? currentFeatures.filter((f) => f !== feature)\r\n                          : [...currentFeatures, feature];\r\n                        onUpdate({ features: newFeatures });\r\n                      }}\r\n                    >\r\n                      {(customization.features || []).includes(feature) && (\r\n                        <Check className=\"h-2.5 w-2.5 mr-0.5\" />\r\n                      )}\r\n                      {feature}\r\n                    </Badge>\r\n                  ))}\r\n                </div>\r\n              </CollapsibleContent>\r\n            </Collapsible>\r\n\r\n            {/* Tags Section - NEW */}\r\n            <Collapsible className=\"border rounded-lg\">\r\n              <CollapsibleTrigger className=\"flex items-center justify-between w-full p-2.5 sm:p-3 hover:bg-secondary/30 transition-colors\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  <span className=\"text-xs sm:text-sm font-medium\">Optional Tags</span>\r\n                  <Badge variant=\"secondary\" className=\"text-[10px] px-1.5 py-0\">\r\n                    {(customization.tags || []).length}\r\n                  </Badge>\r\n                </div>\r\n                <ChevronDown className=\"h-4 w-4 text-muted-foreground transition-transform [[data-state=open]>&]:rotate-180\" />\r\n              </CollapsibleTrigger>\r\n              <CollapsibleContent className=\"px-2.5 sm:px-3 pb-2.5 sm:pb-3\">\r\n                <div className=\"flex flex-wrap gap-1.5 sm:gap-2\">\r\n                  {tagsList.map((tag) => (\r\n                    <Badge\r\n                      key={tag}\r\n                      variant={(customization.tags || []).includes(tag) ? \"default\" : \"outline\"}\r\n                      className=\"cursor-pointer transition-all text-[10px] sm:text-xs px-2 py-0.5\"\r\n                      onClick={() => {\r\n                        const currentTags = customization.tags || [];\r\n                        const newTags = currentTags.includes(tag)\r\n                          ? currentTags.filter((t) => t !== tag)\r\n                          : [...currentTags, tag];\r\n                        onUpdate({ tags: newTags });\r\n                      }}\r\n                    >\r\n                      {(customization.tags || []).includes(tag) && (\r\n                        <Check className=\"h-2.5 w-2.5 mr-0.5\" />\r\n                      )}\r\n                      {tag}\r\n                    </Badge>\r\n                  ))}\r\n                </div>\r\n              </CollapsibleContent>\r\n            </Collapsible>\r\n\r\n            {/* Images Section - Collapsible on mobile */}\r\n            <Collapsible defaultOpen className=\"border rounded-lg\">\r\n              <CollapsibleTrigger className=\"flex items-center justify-between w-full p-2.5 sm:p-3 hover:bg-secondary/30 transition-colors\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  <span className=\"text-xs sm:text-sm font-medium\">Images</span>\r\n                  <Badge variant=\"secondary\" className=\"text-[10px] px-1.5 py-0\">\r\n                    {customization.selectedImages.length} selected\r\n                  </Badge>\r\n                </div>\r\n                <ChevronDown className=\"h-4 w-4 text-muted-foreground transition-transform [[data-state=open]>&]:rotate-180\" />\r\n              </CollapsibleTrigger>\r\n              <CollapsibleContent className=\"px-2.5 sm:px-3 pb-2.5 sm:pb-3 space-y-2\">\r\n                <div className=\"flex items-center justify-between gap-2\">\r\n                  <p className=\"text-[10px] sm:text-xs text-muted-foreground\">\r\n                    Drag to reorder. First = cover.\r\n                  </p>\r\n                  <div className=\"flex items-center gap-1\">\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      onClick={handleAddImages}\r\n                      disabled={isUploading}\r\n                      className=\"h-7 text-xs px-2\"\r\n                    >\r\n                      {isUploading ? (\r\n                        <Loader2 className=\"h-3 w-3 animate-spin sm:mr-1\" />\r\n                      ) : (\r\n                        <Plus className=\"h-3 w-3 sm:mr-1\" />\r\n                      )}\r\n                      <span className=\"hidden sm:inline\">{isUploading ? \"Uploading...\" : \"Add\"}</span>\r\n                    </Button>\r\n                    <Button\r\n                      variant=\"ghost\"\r\n                      size=\"sm\"\r\n                      onClick={() => onUpdate({ selectedImages: localImages.map((_, i) => i) })}\r\n                      className=\"h-7 text-xs px-2\"\r\n                    >\r\n                      All\r\n                    </Button>\r\n                  </div>\r\n                  <input\r\n                    type=\"file\"\r\n                    ref={fileInputRef}\r\n                    className=\"hidden\"\r\n                    accept=\"image/*\"\r\n                    multiple\r\n                    onChange={handleFileChange}\r\n                  />\r\n                </div>\r\n\r\n                <DndContext\r\n                  sensors={sensors}\r\n                  collisionDetection={closestCenter}\r\n                  onDragEnd={handleDragEnd}\r\n                >\r\n                  <SortableContext\r\n                    items={localImages}\r\n                    strategy={rectSortingStrategy}\r\n                  >\r\n                    <div className=\"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-1.5 sm:gap-2\">\r\n                      {localImages.map((img, index) => (\r\n                        <SortableImageItem\r\n                          key={img}\r\n                          id={img}\r\n                          image={img}\r\n                          index={index}\r\n                          isCover={customization.selectedImages[0] === index}\r\n                          isSelected={customization.selectedImages.includes(index)}\r\n                          onToggle={() => toggleImage(index)}\r\n                          onSetCover={() => setCoverImage(index)}\r\n                          onRemove={() => removeImage(index)}\r\n                        />\r\n                      ))}\r\n\r\n                      {/* Add Image Placeholder */}\r\n                      <div\r\n                        className={cn(\r\n                          \"aspect-square rounded-lg border-2 border-dashed border-muted-foreground/30 hover:border-primary/50 transition-colors flex flex-col items-center justify-center cursor-pointer bg-muted/30\",\r\n                          isUploading && \"opacity-50 pointer-events-none\"\r\n                        )}\r\n                        onClick={handleAddImages}\r\n                      >\r\n                        {isUploading ? (\r\n                          <Loader2 className=\"h-4 w-4 text-muted-foreground animate-spin\" />\r\n                        ) : (\r\n                          <>\r\n                            <Upload className=\"h-4 w-4 text-muted-foreground mb-0.5\" />\r\n                            <span className=\"text-[9px] text-muted-foreground\">Add</span>\r\n                          </>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  </SortableContext>\r\n                </DndContext>\r\n              </CollapsibleContent>\r\n            </Collapsible>\r\n\r\n            {/* Agent Section - Collapsible on mobile */}\r\n            <Collapsible defaultOpen className=\"border rounded-lg\">\r\n              <CollapsibleTrigger className=\"flex items-center justify-between w-full p-2.5 sm:p-3 hover:bg-secondary/30 transition-colors\">\r\n                <span className=\"text-xs sm:text-sm font-medium\">Agent Assignment</span>\r\n                <ChevronDown className=\"h-4 w-4 text-muted-foreground transition-transform [[data-state=open]>&]:rotate-180\" />\r\n              </CollapsibleTrigger>\r\n              <CollapsibleContent className=\"px-2.5 sm:px-3 pb-2.5 sm:pb-3\">\r\n                {isLoadingPortalAgents ? (\r\n                  <div className=\"flex items-center justify-center py-4\">\r\n                    <div className=\"h-4 w-4 animate-spin rounded-full border-2 border-primary border-t-transparent mr-2\" />\r\n                    <span className=\"text-xs text-muted-foreground\">Loading portal agents...</span>\r\n                  </div>\r\n                ) : portalAgents.length > 0 ? (\r\n                  <Popover open={agentSearchOpen} onOpenChange={setAgentSearchOpen}>\r\n                    <PopoverTrigger asChild>\r\n                      <Button\r\n                        variant=\"outline\"\r\n                        role=\"combobox\"\r\n                        aria-expanded={agentSearchOpen}\r\n                        className=\"w-full h-9 sm:h-10 justify-between text-sm font-normal\"\r\n                      >\r\n                        {selectedPortalAgent ? (\r\n                          <div className=\"flex items-center gap-2 truncate\">\r\n                            <span className=\"truncate\">{selectedPortalAgent.name}</span>\r\n                            {selectedPortalAgent.brn && (\r\n                              <span className=\"text-[10px] text-muted-foreground shrink-0\">\r\n                                BRN: {selectedPortalAgent.brn}\r\n                              </span>\r\n                            )}\r\n                          </div>\r\n                        ) : (\r\n                          <span className=\"text-muted-foreground\">Select agent...</span>\r\n                        )}\r\n                        <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\r\n                      </Button>\r\n                    </PopoverTrigger>\r\n                    <PopoverContent className=\"w-[var(--radix-popover-trigger-width)] p-0\" align=\"start\">\r\n                      <Command>\r\n                        <CommandInput placeholder=\"Search agents...\" className=\"h-9\" />\r\n                        <CommandList>\r\n                          <CommandEmpty>No agent found.</CommandEmpty>\r\n                          <CommandGroup>\r\n                            {portalAgents.map((agent) => (\r\n                              <CommandItem\r\n                                key={agent.id}\r\n                                value={`${agent.name} ${agent.email || ''} ${agent.brn || ''}`}\r\n                                onSelect={() => {\r\n                                  onUpdate({ agentId: agent.id });\r\n                                  setAgentSearchOpen(false);\r\n                                }}\r\n                                className=\"cursor-pointer\"\r\n                              >\r\n                                <Check\r\n                                  className={cn(\r\n                                    \"mr-2 h-4 w-4\",\r\n                                    customization.agentId === agent.id ? \"opacity-100\" : \"opacity-0\"\r\n                                  )}\r\n                                />\r\n                                <div className=\"flex flex-col min-w-0\">\r\n                                  <span className=\"truncate\">{agent.name}</span>\r\n                                  <div className=\"flex items-center gap-2 text-[10px] text-muted-foreground\">\r\n                                    {agent.email && <span className=\"truncate\">{agent.email}</span>}\r\n                                    {agent.brn && <span className=\"shrink-0\">BRN: {agent.brn}</span>}\r\n                                  </div>\r\n                                </div>\r\n                              </CommandItem>\r\n                            ))}\r\n                          </CommandGroup>\r\n                        </CommandList>\r\n                      </Command>\r\n                    </PopoverContent>\r\n                  </Popover>\r\n                ) : (\r\n                  <div className=\"text-center py-3 text-muted-foreground\">\r\n                    <p className=\"text-xs\">No agents available for this portal</p>\r\n                    <p className=\"text-[10px] mt-1\">Connect your portal account to fetch agents</p>\r\n                  </div>\r\n                )}\r\n              </CollapsibleContent>\r\n            </Collapsible>\r\n\r\n            {/* Amenities Section - Collapsible on mobile */}\r\n            <Collapsible className=\"border rounded-lg\">\r\n              <CollapsibleTrigger className=\"flex items-center justify-between w-full p-2.5 sm:p-3 hover:bg-secondary/30 transition-colors\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  <span className=\"text-xs sm:text-sm font-medium\">Amenities</span>\r\n                  <Badge variant=\"secondary\" className=\"text-[10px] px-1.5 py-0\">\r\n                    {customization.amenities.length}\r\n                  </Badge>\r\n                </div>\r\n                <ChevronDown className=\"h-4 w-4 text-muted-foreground transition-transform [[data-state=open]>&]:rotate-180\" />\r\n              </CollapsibleTrigger>\r\n              <CollapsibleContent className=\"px-2.5 sm:px-3 pb-2.5 sm:pb-3\">\r\n                <div className=\"flex flex-wrap gap-1.5 sm:gap-2\">\r\n                  {amenitiesList.map((amenity) => (\r\n                    <Badge\r\n                      key={amenity}\r\n                      variant={customization.amenities.includes(amenity) ? \"default\" : \"outline\"}\r\n                      className=\"cursor-pointer transition-all text-[10px] sm:text-xs px-2 py-0.5\"\r\n                      onClick={() => toggleAmenity(amenity)}\r\n                    >\r\n                      {customization.amenities.includes(amenity) && (\r\n                        <Check className=\"h-2.5 w-2.5 mr-0.5\" />\r\n                      )}\r\n                      {amenity}\r\n                    </Badge>\r\n                  ))}\r\n                </div>\r\n              </CollapsibleContent>\r\n            </Collapsible>\r\n\r\n            {/* SEO Keywords Section - Collapsible on mobile */}\r\n            <Collapsible className=\"border rounded-lg\">\r\n              <CollapsibleTrigger className=\"flex items-center justify-between w-full p-2.5 sm:p-3 hover:bg-secondary/30 transition-colors\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  <span className=\"text-xs sm:text-sm font-medium\">SEO Keywords</span>\r\n                  <Badge variant=\"secondary\" className=\"text-[10px] px-1.5 py-0\">\r\n                    {customization.seoKeywords.length}\r\n                  </Badge>\r\n                </div>\r\n                <ChevronDown className=\"h-4 w-4 text-muted-foreground transition-transform [[data-state=open]>&]:rotate-180\" />\r\n              </CollapsibleTrigger>\r\n              <CollapsibleContent className=\"px-2.5 sm:px-3 pb-2.5 sm:pb-3 space-y-2\">\r\n                {customization.seoKeywords.length > 0 && (\r\n                  <div className=\"flex flex-wrap gap-1.5\">\r\n                    {customization.seoKeywords.map((keyword) => (\r\n                      <Badge key={keyword} variant=\"secondary\" className=\"gap-1 text-[10px] sm:text-xs px-2 py-0.5\">\r\n                        {keyword}\r\n                        <button\r\n                          onClick={() => removeKeyword(keyword)}\r\n                          className=\"hover:text-destructive\"\r\n                        >\r\n                          <X className=\"h-2.5 w-2.5\" />\r\n                        </button>\r\n                      </Badge>\r\n                    ))}\r\n                  </div>\r\n                )}\r\n                <div className=\"flex gap-1.5 sm:gap-2\">\r\n                  <Input\r\n                    placeholder=\"Add keyword\"\r\n                    className=\"h-8 sm:h-9 text-sm flex-1\"\r\n                    onKeyDown={(e) => {\r\n                      if (e.key === \"Enter\") {\r\n                        addKeyword(e.currentTarget.value);\r\n                        e.currentTarget.value = \"\";\r\n                      }\r\n                    }}\r\n                  />\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    className=\"h-8 sm:h-9 text-xs px-2 sm:px-3\"\r\n                    onClick={() => {\r\n                      const suggestions = [\"luxury\", \"modern\", \"spacious\", \"prime location\"];\r\n                      suggestions.forEach(addKeyword);\r\n                    }}\r\n                  >\r\n                    <Sparkles className=\"h-3 w-3 sm:mr-1\" />\r\n                    <span className=\"hidden sm:inline\">Suggest</span>\r\n                  </Button>\r\n                </div>\r\n              </CollapsibleContent>\r\n            </Collapsible>\r\n          </CardContent>\r\n        </CollapsibleContent>\r\n      </Card>\r\n\r\n      {/* Preview Modal */}\r\n      <PortalPreviewModal\r\n        open={showPreview}\r\n        onOpenChange={setShowPreview}\r\n        portal={portal}\r\n        customization={customization}\r\n        listing={listing}\r\n        agent={currentAgent}\r\n      />\r\n    </Collapsible >\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\publish-portals\\PortalPreviewModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\publish-portals\\PortalSelection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\publish-portals\\PublishActions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\publish-portals\\ValidationStatus.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\publish-portals\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\roles\\RolesFAB.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\settings\\LocalizationSettings.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\subscription\\UpgradeModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\teams\\AgentCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\teams\\BulkActionsBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\teams\\CreateAgentDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":126,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3743,3746],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3743,3746],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport {\r\n  ResponsiveDialog,\r\n  ResponsiveDialogContent,\r\n  ResponsiveDialogHeader,\r\n  ResponsiveDialogTitle,\r\n  ResponsiveDialogFooter,\r\n  ResponsiveDialogBody,\r\n} from '@/components/ui/responsive-dialog';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Switch } from '@/components/ui/switch';\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\r\nimport { Card } from '@/components/ui/card';\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select';\r\nimport { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';\r\nimport { User, Shield, Upload, Mail, Loader2, Check, ArrowRight, Copy, ExternalLink, RefreshCw } from 'lucide-react';\r\nimport { Agent, Team, UserRole } from './types';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { cn } from '@/lib/utils';\r\nimport { Badge } from '@/components/ui/badge';\r\n\r\ninterface CreateAgentDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  agent?: Agent | null;\r\n  teams: Team[];\r\n  onSave: (agentData: Partial<Agent>) => void;\r\n}\r\n\r\ntype InviteStep = \"details\" | \"permissions\" | \"complete\";\r\n\r\nexport function CreateAgentDialog({ open, onOpenChange, agent, teams, onSave }: CreateAgentDialogProps) {\r\n  const { toast } = useToast();\r\n  const [step, setStep] = useState<InviteStep>(\"details\");\r\n  const [name, setName] = useState('');\r\n  const [email, setEmail] = useState('');\r\n  const [phone, setPhone] = useState('');\r\n  const [role, setRole] = useState<UserRole>('agent');\r\n  const [teamId, setTeamId] = useState<string>('');\r\n  const [isInviting, setIsInviting] = useState(false);\r\n  const [inviteLink, setInviteLink] = useState('');\r\n  const [permissions, setPermissions] = useState({\r\n    leads: true,\r\n    listings: true,\r\n    marketing: false,\r\n    reports: false,\r\n    integrations: false,\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (open) {\r\n      if (agent) {\r\n        setName(agent.name);\r\n        setEmail(agent.email);\r\n        setPhone(agent.phone);\r\n        setRole(agent.role);\r\n        setTeamId(agent.teamId || '');\r\n        setPermissions(agent.permissions);\r\n        setStep(\"details\");\r\n      } else {\r\n        setName('');\r\n        setEmail('');\r\n        setPhone('');\r\n        setRole('agent');\r\n        setTeamId('');\r\n        setPermissions({\r\n          leads: true,\r\n          listings: true,\r\n          marketing: false,\r\n          reports: false,\r\n          integrations: false,\r\n        });\r\n        setStep(\"details\");\r\n      }\r\n      setInviteLink('');\r\n    }\r\n  }, [agent, open]);\r\n\r\n  const handleInvite = async () => {\r\n    if (!name.trim() || !email.trim()) {\r\n      toast({\r\n        title: 'Missing Information',\r\n        description: 'Please provide name and email.',\r\n        variant: 'destructive',\r\n      });\r\n      return;\r\n    }\r\n\r\n    setIsInviting(true);\r\n    try {\r\n      const { data, error } = await supabase.functions.invoke('invite-agent', {\r\n        body: {\r\n          name,\r\n          email,\r\n          phone,\r\n          role,\r\n          team_id: teamId || null,\r\n          permissions,\r\n        },\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      setInviteLink(data.invite_link || `${window.location.origin}/invite/${data.agent.id}`);\r\n      setStep(\"complete\");\r\n\r\n      onSave({\r\n        id: data.agent.id,\r\n        name,\r\n        email,\r\n        phone,\r\n        role,\r\n        status: 'invited',\r\n        teamId: teamId || undefined,\r\n        permissions,\r\n      });\r\n    } catch (error: any) {\r\n      console.error('Error inviting agent:', error);\r\n      toast({\r\n        title: 'Failed to Send Invitation',\r\n        description: error.message || 'Please try again.',\r\n        variant: 'destructive',\r\n      });\r\n    } finally {\r\n      setIsInviting(false);\r\n    }\r\n  };\r\n\r\n  const handleSave = () => {\r\n    if (agent) {\r\n      // Editing existing agent\r\n      onSave({\r\n        name,\r\n        email,\r\n        phone,\r\n        role,\r\n        status: agent.status,\r\n        teamId: teamId || undefined,\r\n        permissions,\r\n      });\r\n      onOpenChange(false);\r\n    } else {\r\n      // New agent - send invitation\r\n      handleInvite();\r\n    }\r\n  };\r\n\r\n  const handleCopyLink = () => {\r\n    navigator.clipboard.writeText(inviteLink);\r\n    toast({ title: 'Link copied!', description: 'Invite link copied to clipboard.' });\r\n  };\r\n\r\n  const isEditing = !!agent;\r\n\r\n  return (\r\n    <ResponsiveDialog open={open} onOpenChange={onOpenChange}>\r\n      <ResponsiveDialogContent className=\"sm:max-w-[480px] p-0 overflow-hidden\">\r\n        <ResponsiveDialogHeader className=\"px-5 py-2.5 border-b\">\r\n          <ResponsiveDialogTitle className=\"flex items-center gap-2 text-sm\">\r\n            {isEditing ? (\r\n              <User className=\"h-5 w-5 text-primary\" />\r\n            ) : (\r\n              <Mail className=\"h-5 w-5 text-primary\" />\r\n            )}\r\n            {isEditing ? 'Edit Agent Profile' : 'Invite New Agent'}\r\n          </ResponsiveDialogTitle>\r\n        </ResponsiveDialogHeader>\r\n\r\n        <ResponsiveDialogBody className=\"p-0\">\r\n          <div className=\"p-4 space-y-3\">\r\n            {/* Steps Indicator */}\r\n            {!isEditing && step !== \"complete\" && (\r\n              <div className=\"flex items-center justify-between pb-2 border-b\">\r\n                {[\r\n                  { id: \"details\", label: \"Agent Info\", icon: User },\r\n                  { id: \"permissions\", label: \"Permissions\", icon: Shield },\r\n                ].map((s, i) => (\r\n                  <div key={s.id} className=\"flex items-center gap-2\">\r\n                    <div className={cn(\r\n                      \"flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium transition-colors\",\r\n                      step === s.id\r\n                        ? \"bg-primary text-primary-foreground shadow-sm\"\r\n                        : step === \"permissions\" && i === 0\r\n                          ? \"bg-primary/20 text-primary\"\r\n                          : \"bg-muted text-muted-foreground\"\r\n                    )}>\r\n                      <s.icon className=\"h-3.5 w-3.5\" />\r\n                      <span>{s.label}</span>\r\n                    </div>\r\n                    {i === 0 && <ArrowRight className=\"h-4 w-4 text-muted-foreground\" />}\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n\r\n            {step === \"details\" && (\r\n              <div className=\"space-y-3 animate-in fade-in slide-in-from-bottom-2\">\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3\">\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label className=\"text-xs font-medium\">Full Name</Label>\r\n                    <Input\r\n                      value={name}\r\n                      onChange={(e) => setName(e.target.value)}\r\n                      placeholder=\"e.g. John Doe\"\r\n                      className=\"h-9 text-sm\"\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label className=\"text-xs font-medium\">Role</Label>\r\n                    <Select value={role} onValueChange={(v) => setRole(v as UserRole)}>\r\n                      <SelectTrigger className=\"h-9 text-sm\">\r\n                        <SelectValue />\r\n                      </SelectTrigger>\r\n                      <SelectContent className=\"bg-popover\">\r\n                        <SelectItem value=\"team_leader\">Team Leader</SelectItem>\r\n                        <SelectItem value=\"agent\">Agent</SelectItem>\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3\">\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label className=\"text-xs font-medium\">Email Address</Label>\r\n                    <Input\r\n                      type=\"email\"\r\n                      value={email}\r\n                      onChange={(e) => setEmail(e.target.value)}\r\n                      placeholder=\"john@company.com\"\r\n                      disabled={isEditing}\r\n                      className=\"h-9 text-sm\"\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-1.5\">\r\n                    <Label className=\"text-xs font-medium\">Phone Number</Label>\r\n                    <Input\r\n                      value={phone}\r\n                      onChange={(e) => setPhone(e.target.value)}\r\n                      placeholder=\"+971 50 123 4567\"\r\n                      className=\"h-9 text-sm\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"space-y-1.5\">\r\n                  <Label className=\"text-xs font-medium\">Team Assignment</Label>\r\n                  <Select value={teamId || 'none'} onValueChange={(v) => setTeamId(v === 'none' ? '' : v)}>\r\n                    <SelectTrigger className=\"h-9 text-sm\">\r\n                      <SelectValue placeholder=\"Select team\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent className=\"bg-popover\">\r\n                      <SelectItem value=\"none\">No Team (Individual Agent)</SelectItem>\r\n                      {teams.map((team) => (\r\n                        <SelectItem key={team.id} value={team.id}>{team.name}</SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n\r\n                {!isEditing && (\r\n                  <div className=\"p-2.5 rounded-lg bg-blue-50/50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-900/30 flex gap-2\">\r\n                    <Mail className=\"h-3.5 w-3.5 text-blue-600 dark:text-blue-400 mt-0.5 shrink-0\" />\r\n                    <p className=\"text-[9px] leading-relaxed text-blue-800 dark:text-blue-200\">\r\n                      <span className=\"font-semibold text-[10px]\">Professional Invite:</span> Official invitation will be sent to this email.\r\n                    </p>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            )}\r\n\r\n            {step === \"permissions\" && (\r\n              <div className=\"space-y-4 animate-in fade-in slide-in-from-right-2\">\r\n                <div className=\"flex items-center gap-2 mb-2\">\r\n                  <Shield className=\"h-4 w-4 text-primary\" />\r\n                  <h4 className=\"text-sm font-semibold\">Module Access Control</h4>\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                  {[\r\n                    { key: 'leads', label: 'Leads Management', description: 'CRM leads and pipeline' },\r\n                    { key: 'listings', label: 'Property Listings', description: 'Property listings' },\r\n                    { key: 'marketing', label: 'Marketing Tools', description: 'Marketing tools' },\r\n                    { key: 'reports', label: 'Analytics', description: 'Performance data' },\r\n                    { key: 'integrations', label: 'Integrations', description: 'API access' },\r\n                  ].map((perm) => (\r\n                    <div key={perm.key} className=\"flex items-center justify-between p-2.5 rounded-lg bg-muted/30 border border-transparent hover:border-border transition-all\">\r\n                      <div className=\"space-y-0.5\">\r\n                        <p className=\"text-[11px] font-medium\">{perm.label}</p>\r\n                        <p className=\"text-[9px] text-muted-foreground\">{perm.description}</p>\r\n                      </div>\r\n                      <Switch\r\n                        checked={permissions[perm.key as keyof typeof permissions]}\r\n                        onCheckedChange={(checked) =>\r\n                          setPermissions(prev => ({ ...prev, [perm.key]: checked }))\r\n                        }\r\n                        className=\"scale-90\"\r\n                      />\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {step === \"complete\" && (\r\n              <div className=\"py-6 space-y-6 text-center animate-in zoom-in-95\">\r\n                <div className=\"h-16 w-16 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mx-auto ring-8 ring-green-50 dark:ring-green-900/10\">\r\n                  <Check className=\"h-8 w-8 text-green-600\" />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <p className=\"text-xl font-bold\">Invitation Sent!</p>\r\n                  <p className=\"text-sm text-muted-foreground\">\r\n                    We've sent an invite to <span className=\"font-semibold text-foreground\">{email}</span>.\r\n                  </p>\r\n                </div>\r\n\r\n                <Card className=\"p-4 bg-muted/50 border-dashed border-2\">\r\n                  <div className=\"space-y-3\">\r\n                    <p className=\"text-xs font-medium text-muted-foreground\">Direct Invitation Link</p>\r\n                    <div className=\"flex gap-2\">\r\n                      <Input value={inviteLink} readOnly className=\"h-9 text-xs bg-background\" />\r\n                      <Button size=\"sm\" variant=\"outline\" className=\"h-9 px-3\" onClick={handleCopyLink}>\r\n                        <Copy className=\"h-4 w-4\" />\r\n                      </Button>\r\n                    </div>\r\n                  </div>\r\n                </Card>\r\n\r\n                <div className=\"flex flex-col sm:flex-row gap-2 pt-4\">\r\n                  <Button variant=\"outline\" className=\"flex-1\" onClick={() => {\r\n                    setStep(\"details\");\r\n                    setName('');\r\n                    setEmail('');\r\n                    setPhone('');\r\n                  }}>\r\n                    <RefreshCw className=\"h-4 w-4 mr-2\" />\r\n                    Invite Another\r\n                  </Button>\r\n                  <Button className=\"flex-1\" onClick={() => onOpenChange(false)}>\r\n                    Close\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </ResponsiveDialogBody>\r\n\r\n        {step !== \"complete\" && (\r\n          <ResponsiveDialogFooter className=\"p-3 border-t bg-muted/20\">\r\n            <div className=\"flex w-full items-center justify-between gap-2\">\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={() => step === \"permissions\" ? setStep(\"details\") : onOpenChange(false)}\r\n                disabled={isInviting}\r\n                className=\"h-8 px-3 text-xs\"\r\n              >\r\n                {step === \"permissions\" ? \"Back\" : \"Cancel\"}\r\n              </Button>\r\n              <Button\r\n                size=\"sm\"\r\n                onClick={() => {\r\n                  if (step === \"details\") setStep(\"permissions\");\r\n                  else handleSave();\r\n                }}\r\n                disabled={!name.trim() || !email.trim() || isInviting}\r\n                className=\"min-w-[120px] h-8 text-xs shadow-sm\"\r\n              >\r\n                {isInviting && <Loader2 className=\"h-3.5 w-3.5 mr-2 animate-spin\" />}\r\n                {isEditing ? 'Save Changes' : step === \"details\" ? (\r\n                  <>\r\n                    Next\r\n                    <ArrowRight className=\"h-3.5 w-3.5 ml-1.5\" />\r\n                  </>\r\n                ) : 'Send Invite'}\r\n              </Button>\r\n            </div>\r\n          </ResponsiveDialogFooter>\r\n        )}\r\n      </ResponsiveDialogContent>\r\n    </ResponsiveDialog>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\teams\\CreateTeamDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\teams\\DragOverlayCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\teams\\DraggableAgentCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\teams\\DroppableTeamCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\teams\\PerformanceLeaderboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\teams\\TeamCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\teams\\TeamFilters.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\teams\\TeamStats.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\teams\\TeamsFAB.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\teams\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\VirtualList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\accordion.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\alert-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\alert.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\aspect-ratio.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\avatar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\badge.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":29,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":29,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\";\r\nimport { cva, type VariantProps } from \"class-variance-authority\";\r\n\r\nimport { cn } from \"@/lib/utils\";\r\n\r\nconst badgeVariants = cva(\r\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\r\n  {\r\n    variants: {\r\n      variant: {\r\n        default: \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\r\n        secondary: \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\r\n        destructive: \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\r\n        outline: \"text-foreground\",\r\n      },\r\n    },\r\n    defaultVariants: {\r\n      variant: \"default\",\r\n    },\r\n  },\r\n);\r\n\r\nexport interface BadgeProps extends React.HTMLAttributes<HTMLDivElement>, VariantProps<typeof badgeVariants> {}\r\n\r\nfunction Badge({ className, variant, ...props }: BadgeProps) {\r\n  return <div className={cn(badgeVariants({ variant }), className)} {...props} />;\r\n}\r\n\r\nexport { Badge, badgeVariants };\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\bottom-sheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\breadcrumb.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\button.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":47,"column":18,"nodeType":"Identifier","messageId":"namedExport","endLine":47,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\";\r\nimport { Slot } from \"@radix-ui/react-slot\";\r\nimport { cva, type VariantProps } from \"class-variance-authority\";\r\n\r\nimport { cn } from \"@/lib/utils\";\r\n\r\nconst buttonVariants = cva(\r\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium transition-all duration-150 ease-out focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\r\n  {\r\n    variants: {\r\n      variant: {\r\n        default: \"bg-primary text-primary-foreground shadow-sm hover:bg-primary/90 active:bg-primary/95\",\r\n        destructive: \"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90\",\r\n        outline: \"border border-border bg-background hover:bg-muted hover:border-border/80 text-foreground\",\r\n        secondary: \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\r\n        ghost: \"hover:bg-muted text-foreground\",\r\n        link: \"text-primary underline-offset-4 hover:underline\",\r\n      },\r\n      size: {\r\n        default: \"h-10 px-5 py-2 rounded-lg\",\r\n        sm: \"h-9 px-4 rounded-md text-sm\",\r\n        lg: \"h-12 px-8 rounded-lg text-base\",\r\n        icon: \"h-10 w-10 rounded-lg\",\r\n      },\r\n    },\r\n    defaultVariants: {\r\n      variant: \"default\",\r\n      size: \"default\",\r\n    },\r\n  },\r\n);\r\n\r\nexport interface ButtonProps\r\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\r\n    VariantProps<typeof buttonVariants> {\r\n  asChild?: boolean;\r\n}\r\n\r\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\r\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\r\n    const Comp = asChild ? Slot : \"button\";\r\n    return <Comp className={cn(buttonVariants({ variant, size, className }))} ref={ref} {...props} />;\r\n  },\r\n);\r\nButton.displayName = \"Button\";\r\n\r\nexport { Button, buttonVariants };\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\calendar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\carousel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\chart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\checkbox.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\collapsible.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\command.tsx","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An interface declaring no members is equivalent to its supertype.","line":24,"column":11,"nodeType":"Identifier","messageId":"noEmptyInterfaceWithSuper","endLine":24,"endColumn":29,"suggestions":[{"messageId":"replaceEmptyInterfaceWithSuper","fix":{"range":[733,784],"text":"type CommandDialogProps = DialogProps"},"desc":"Replace empty interface with a type alias."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\";\r\nimport { type DialogProps } from \"@radix-ui/react-dialog\";\r\nimport { Command as CommandPrimitive } from \"cmdk\";\r\nimport { Search } from \"lucide-react\";\r\n\r\nimport { cn } from \"@/lib/utils\";\r\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\";\r\n\r\nconst Command = React.forwardRef<\r\n  React.ElementRef<typeof CommandPrimitive>,\r\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\r\n>(({ className, ...props }, ref) => (\r\n  <CommandPrimitive\r\n    ref={ref}\r\n    className={cn(\r\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\r\n      className,\r\n    )}\r\n    {...props}\r\n  />\r\n));\r\nCommand.displayName = CommandPrimitive.displayName;\r\n\r\ninterface CommandDialogProps extends DialogProps {}\r\n\r\nconst CommandDialog = ({ children, ...props }: CommandDialogProps) => {\r\n  return (\r\n    <Dialog {...props}>\r\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\r\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\r\n          {children}\r\n        </Command>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n};\r\n\r\nconst CommandInput = React.forwardRef<\r\n  React.ElementRef<typeof CommandPrimitive.Input>,\r\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\r\n>(({ className, ...props }, ref) => (\r\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\r\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\r\n    <CommandPrimitive.Input\r\n      ref={ref}\r\n      className={cn(\r\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  </div>\r\n));\r\n\r\nCommandInput.displayName = CommandPrimitive.Input.displayName;\r\n\r\nconst CommandList = React.forwardRef<\r\n  React.ElementRef<typeof CommandPrimitive.List>,\r\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\r\n>(({ className, ...props }, ref) => (\r\n  <CommandPrimitive.List\r\n    ref={ref}\r\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\r\n    {...props}\r\n  />\r\n));\r\n\r\nCommandList.displayName = CommandPrimitive.List.displayName;\r\n\r\nconst CommandEmpty = React.forwardRef<\r\n  React.ElementRef<typeof CommandPrimitive.Empty>,\r\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\r\n>((props, ref) => <CommandPrimitive.Empty ref={ref} className=\"py-6 text-center text-sm\" {...props} />);\r\n\r\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName;\r\n\r\nconst CommandGroup = React.forwardRef<\r\n  React.ElementRef<typeof CommandPrimitive.Group>,\r\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\r\n>(({ className, ...props }, ref) => (\r\n  <CommandPrimitive.Group\r\n    ref={ref}\r\n    className={cn(\r\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\r\n      className,\r\n    )}\r\n    {...props}\r\n  />\r\n));\r\n\r\nCommandGroup.displayName = CommandPrimitive.Group.displayName;\r\n\r\nconst CommandSeparator = React.forwardRef<\r\n  React.ElementRef<typeof CommandPrimitive.Separator>,\r\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\r\n>(({ className, ...props }, ref) => (\r\n  <CommandPrimitive.Separator ref={ref} className={cn(\"-mx-1 h-px bg-border\", className)} {...props} />\r\n));\r\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName;\r\n\r\nconst CommandItem = React.forwardRef<\r\n  React.ElementRef<typeof CommandPrimitive.Item>,\r\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\r\n>(({ className, ...props }, ref) => (\r\n  <CommandPrimitive.Item\r\n    ref={ref}\r\n    className={cn(\r\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50\",\r\n      className,\r\n    )}\r\n    {...props}\r\n  />\r\n));\r\n\r\nCommandItem.displayName = CommandPrimitive.Item.displayName;\r\n\r\nconst CommandShortcut = ({ className, ...props }: React.HTMLAttributes<HTMLSpanElement>) => {\r\n  return <span className={cn(\"ml-auto text-xs tracking-widest text-muted-foreground\", className)} {...props} />;\r\n};\r\nCommandShortcut.displayName = \"CommandShortcut\";\r\n\r\nexport {\r\n  Command,\r\n  CommandDialog,\r\n  CommandInput,\r\n  CommandList,\r\n  CommandEmpty,\r\n  CommandGroup,\r\n  CommandItem,\r\n  CommandShortcut,\r\n  CommandSeparator,\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\context-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\country-select.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":27,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":27,"endColumn":37},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":187,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":187,"endColumn":37},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":192,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":192,"endColumn":37}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\";\r\nimport { Check, ChevronsUpDown, Search } from \"lucide-react\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport {\r\n  Command,\r\n  CommandEmpty,\r\n  CommandGroup,\r\n  CommandInput,\r\n  CommandItem,\r\n  CommandList,\r\n} from \"@/components/ui/command\";\r\nimport {\r\n  Popover,\r\n  PopoverContent,\r\n  PopoverTrigger,\r\n} from \"@/components/ui/popover\";\r\n\r\nexport interface Country {\r\n  code: string;\r\n  name: string;\r\n  nameAr: string;\r\n  currency: string;\r\n  timezone: string;\r\n}\r\n\r\nexport const allCountries: Country[] = [\r\n  // Middle East\r\n  { code: 'AE', name: 'United Arab Emirates', nameAr: 'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©', currency: 'AED', timezone: 'Asia/Dubai' },\r\n  { code: 'SA', name: 'Saudi Arabia', nameAr: 'Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', currency: 'SAR', timezone: 'Asia/Riyadh' },\r\n  { code: 'QA', name: 'Qatar', nameAr: 'Ù‚Ø·Ø±', currency: 'QAR', timezone: 'Asia/Qatar' },\r\n  { code: 'KW', name: 'Kuwait', nameAr: 'Ø§Ù„ÙƒÙˆÙŠØª', currency: 'KWD', timezone: 'Asia/Kuwait' },\r\n  { code: 'OM', name: 'Oman', nameAr: 'Ø¹ÙÙ…Ø§Ù†', currency: 'OMR', timezone: 'Asia/Muscat' },\r\n  { code: 'BH', name: 'Bahrain', nameAr: 'Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†', currency: 'BHD', timezone: 'Asia/Bahrain' },\r\n  { code: 'IQ', name: 'Iraq', nameAr: 'Ø§Ù„Ø¹Ø±Ø§Ù‚', currency: 'IQD', timezone: 'Asia/Baghdad' },\r\n  { code: 'JO', name: 'Jordan', nameAr: 'Ø§Ù„Ø£Ø±Ø¯Ù†', currency: 'JOD', timezone: 'Asia/Amman' },\r\n  { code: 'LB', name: 'Lebanon', nameAr: 'Ù„Ø¨Ù†Ø§Ù†', currency: 'LBP', timezone: 'Asia/Beirut' },\r\n  { code: 'SY', name: 'Syria', nameAr: 'Ø³ÙˆØ±ÙŠØ§', currency: 'SYP', timezone: 'Asia/Damascus' },\r\n  { code: 'PS', name: 'Palestine', nameAr: 'ÙÙ„Ø³Ø·ÙŠÙ†', currency: 'ILS', timezone: 'Asia/Gaza' },\r\n  { code: 'YE', name: 'Yemen', nameAr: 'Ø§Ù„ÙŠÙ…Ù†', currency: 'YER', timezone: 'Asia/Aden' },\r\n  // North Africa\r\n  { code: 'EG', name: 'Egypt', nameAr: 'Ù…ØµØ±', currency: 'EGP', timezone: 'Africa/Cairo' },\r\n  { code: 'MA', name: 'Morocco', nameAr: 'Ø§Ù„Ù…ØºØ±Ø¨', currency: 'MAD', timezone: 'Africa/Casablanca' },\r\n  { code: 'TN', name: 'Tunisia', nameAr: 'ØªÙˆÙ†Ø³', currency: 'TND', timezone: 'Africa/Tunis' },\r\n  { code: 'DZ', name: 'Algeria', nameAr: 'Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±', currency: 'DZD', timezone: 'Africa/Algiers' },\r\n  { code: 'LY', name: 'Libya', nameAr: 'Ù„ÙŠØ¨ÙŠØ§', currency: 'LYD', timezone: 'Africa/Tripoli' },\r\n  { code: 'SD', name: 'Sudan', nameAr: 'Ø§Ù„Ø³ÙˆØ¯Ø§Ù†', currency: 'SDG', timezone: 'Africa/Khartoum' },\r\n  // Asia\r\n  { code: 'TR', name: 'Turkey', nameAr: 'ØªØ±ÙƒÙŠØ§', currency: 'TRY', timezone: 'Europe/Istanbul' },\r\n  { code: 'PK', name: 'Pakistan', nameAr: 'Ø¨Ø§ÙƒØ³ØªØ§Ù†', currency: 'PKR', timezone: 'Asia/Karachi' },\r\n  { code: 'IN', name: 'India', nameAr: 'Ø§Ù„Ù‡Ù†Ø¯', currency: 'INR', timezone: 'Asia/Kolkata' },\r\n  { code: 'BD', name: 'Bangladesh', nameAr: 'Ø¨Ù†ØºÙ„Ø§Ø¯ÙŠØ´', currency: 'BDT', timezone: 'Asia/Dhaka' },\r\n  { code: 'ID', name: 'Indonesia', nameAr: 'Ø¥Ù†Ø¯ÙˆÙ†ÙŠØ³ÙŠØ§', currency: 'IDR', timezone: 'Asia/Jakarta' },\r\n  { code: 'MY', name: 'Malaysia', nameAr: 'Ù…Ø§Ù„ÙŠØ²ÙŠØ§', currency: 'MYR', timezone: 'Asia/Kuala_Lumpur' },\r\n  { code: 'SG', name: 'Singapore', nameAr: 'Ø³Ù†ØºØ§ÙÙˆØ±Ø©', currency: 'SGD', timezone: 'Asia/Singapore' },\r\n  { code: 'TH', name: 'Thailand', nameAr: 'ØªØ§ÙŠÙ„Ø§Ù†Ø¯', currency: 'THB', timezone: 'Asia/Bangkok' },\r\n  { code: 'VN', name: 'Vietnam', nameAr: 'ÙÙŠØªÙ†Ø§Ù…', currency: 'VND', timezone: 'Asia/Ho_Chi_Minh' },\r\n  { code: 'PH', name: 'Philippines', nameAr: 'Ø§Ù„ÙÙ„Ø¨ÙŠÙ†', currency: 'PHP', timezone: 'Asia/Manila' },\r\n  { code: 'JP', name: 'Japan', nameAr: 'Ø§Ù„ÙŠØ§Ø¨Ø§Ù†', currency: 'JPY', timezone: 'Asia/Tokyo' },\r\n  { code: 'KR', name: 'South Korea', nameAr: 'ÙƒÙˆØ±ÙŠØ§ Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©', currency: 'KRW', timezone: 'Asia/Seoul' },\r\n  { code: 'CN', name: 'China', nameAr: 'Ø§Ù„ØµÙŠÙ†', currency: 'CNY', timezone: 'Asia/Shanghai' },\r\n  { code: 'HK', name: 'Hong Kong', nameAr: 'Ù‡ÙˆÙ†Øº ÙƒÙˆÙ†Øº', currency: 'HKD', timezone: 'Asia/Hong_Kong' },\r\n  // Europe\r\n  { code: 'GB', name: 'United Kingdom', nameAr: 'Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©', currency: 'GBP', timezone: 'Europe/London' },\r\n  { code: 'DE', name: 'Germany', nameAr: 'Ø£Ù„Ù…Ø§Ù†ÙŠØ§', currency: 'EUR', timezone: 'Europe/Berlin' },\r\n  { code: 'FR', name: 'France', nameAr: 'ÙØ±Ù†Ø³Ø§', currency: 'EUR', timezone: 'Europe/Paris' },\r\n  { code: 'IT', name: 'Italy', nameAr: 'Ø¥ÙŠØ·Ø§Ù„ÙŠØ§', currency: 'EUR', timezone: 'Europe/Rome' },\r\n  { code: 'ES', name: 'Spain', nameAr: 'Ø¥Ø³Ø¨Ø§Ù†ÙŠØ§', currency: 'EUR', timezone: 'Europe/Madrid' },\r\n  { code: 'PT', name: 'Portugal', nameAr: 'Ø§Ù„Ø¨Ø±ØªØºØ§Ù„', currency: 'EUR', timezone: 'Europe/Lisbon' },\r\n  { code: 'NL', name: 'Netherlands', nameAr: 'Ù‡ÙˆÙ„Ù†Ø¯Ø§', currency: 'EUR', timezone: 'Europe/Amsterdam' },\r\n  { code: 'BE', name: 'Belgium', nameAr: 'Ø¨Ù„Ø¬ÙŠÙƒØ§', currency: 'EUR', timezone: 'Europe/Brussels' },\r\n  { code: 'AT', name: 'Austria', nameAr: 'Ø§Ù„Ù†Ù…Ø³Ø§', currency: 'EUR', timezone: 'Europe/Vienna' },\r\n  { code: 'CH', name: 'Switzerland', nameAr: 'Ø³ÙˆÙŠØ³Ø±Ø§', currency: 'CHF', timezone: 'Europe/Zurich' },\r\n  { code: 'SE', name: 'Sweden', nameAr: 'Ø§Ù„Ø³ÙˆÙŠØ¯', currency: 'SEK', timezone: 'Europe/Stockholm' },\r\n  { code: 'NO', name: 'Norway', nameAr: 'Ø§Ù„Ù†Ø±ÙˆÙŠØ¬', currency: 'NOK', timezone: 'Europe/Oslo' },\r\n  { code: 'DK', name: 'Denmark', nameAr: 'Ø§Ù„Ø¯Ù†Ù…Ø§Ø±Ùƒ', currency: 'DKK', timezone: 'Europe/Copenhagen' },\r\n  { code: 'FI', name: 'Finland', nameAr: 'ÙÙ†Ù„Ù†Ø¯Ø§', currency: 'EUR', timezone: 'Europe/Helsinki' },\r\n  { code: 'IE', name: 'Ireland', nameAr: 'Ø£ÙŠØ±Ù„Ù†Ø¯Ø§', currency: 'EUR', timezone: 'Europe/Dublin' },\r\n  { code: 'PL', name: 'Poland', nameAr: 'Ø¨ÙˆÙ„Ù†Ø¯Ø§', currency: 'PLN', timezone: 'Europe/Warsaw' },\r\n  { code: 'CZ', name: 'Czech Republic', nameAr: 'Ø§Ù„ØªØ´ÙŠÙƒ', currency: 'CZK', timezone: 'Europe/Prague' },\r\n  { code: 'GR', name: 'Greece', nameAr: 'Ø§Ù„ÙŠÙˆÙ†Ø§Ù†', currency: 'EUR', timezone: 'Europe/Athens' },\r\n  { code: 'RO', name: 'Romania', nameAr: 'Ø±ÙˆÙ…Ø§Ù†ÙŠØ§', currency: 'RON', timezone: 'Europe/Bucharest' },\r\n  { code: 'HU', name: 'Hungary', nameAr: 'Ø§Ù„Ù…Ø¬Ø±', currency: 'HUF', timezone: 'Europe/Budapest' },\r\n  { code: 'RU', name: 'Russia', nameAr: 'Ø±ÙˆØ³ÙŠØ§', currency: 'RUB', timezone: 'Europe/Moscow' },\r\n  { code: 'UA', name: 'Ukraine', nameAr: 'Ø£ÙˆÙƒØ±Ø§Ù†ÙŠØ§', currency: 'UAH', timezone: 'Europe/Kiev' },\r\n  // Americas\r\n  { code: 'US', name: 'United States', nameAr: 'Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø¯Ø©', currency: 'USD', timezone: 'America/New_York' },\r\n  { code: 'CA', name: 'Canada', nameAr: 'ÙƒÙ†Ø¯Ø§', currency: 'CAD', timezone: 'America/Toronto' },\r\n  { code: 'MX', name: 'Mexico', nameAr: 'Ø§Ù„Ù…ÙƒØ³ÙŠÙƒ', currency: 'MXN', timezone: 'America/Mexico_City' },\r\n  { code: 'BR', name: 'Brazil', nameAr: 'Ø§Ù„Ø¨Ø±Ø§Ø²ÙŠÙ„', currency: 'BRL', timezone: 'America/Sao_Paulo' },\r\n  { code: 'AR', name: 'Argentina', nameAr: 'Ø§Ù„Ø£Ø±Ø¬Ù†ØªÙŠÙ†', currency: 'ARS', timezone: 'America/Argentina/Buenos_Aires' },\r\n  { code: 'CL', name: 'Chile', nameAr: 'ØªØ´ÙŠÙ„ÙŠ', currency: 'CLP', timezone: 'America/Santiago' },\r\n  { code: 'CO', name: 'Colombia', nameAr: 'ÙƒÙˆÙ„ÙˆÙ…Ø¨ÙŠØ§', currency: 'COP', timezone: 'America/Bogota' },\r\n  { code: 'PE', name: 'Peru', nameAr: 'Ø¨ÙŠØ±Ùˆ', currency: 'PEN', timezone: 'America/Lima' },\r\n  // Africa\r\n  { code: 'ZA', name: 'South Africa', nameAr: 'Ø¬Ù†ÙˆØ¨ Ø£ÙØ±ÙŠÙ‚ÙŠØ§', currency: 'ZAR', timezone: 'Africa/Johannesburg' },\r\n  { code: 'NG', name: 'Nigeria', nameAr: 'Ù†ÙŠØ¬ÙŠØ±ÙŠØ§', currency: 'NGN', timezone: 'Africa/Lagos' },\r\n  { code: 'KE', name: 'Kenya', nameAr: 'ÙƒÙŠÙ†ÙŠØ§', currency: 'KES', timezone: 'Africa/Nairobi' },\r\n  { code: 'GH', name: 'Ghana', nameAr: 'ØºØ§Ù†Ø§', currency: 'GHS', timezone: 'Africa/Accra' },\r\n  { code: 'ET', name: 'Ethiopia', nameAr: 'Ø¥Ø«ÙŠÙˆØ¨ÙŠØ§', currency: 'ETB', timezone: 'Africa/Addis_Ababa' },\r\n  { code: 'TZ', name: 'Tanzania', nameAr: 'ØªÙ†Ø²Ø§Ù†ÙŠØ§', currency: 'TZS', timezone: 'Africa/Dar_es_Salaam' },\r\n  // Oceania\r\n  { code: 'AU', name: 'Australia', nameAr: 'Ø£Ø³ØªØ±Ø§Ù„ÙŠØ§', currency: 'AUD', timezone: 'Australia/Sydney' },\r\n  { code: 'NZ', name: 'New Zealand', nameAr: 'Ù†ÙŠÙˆØ²ÙŠÙ„Ù†Ø¯Ø§', currency: 'NZD', timezone: 'Pacific/Auckland' },\r\n].sort((a, b) => a.name.localeCompare(b.name));\r\n\r\ninterface CountrySelectProps {\r\n  value?: string;\r\n  onValueChange: (value: string) => void;\r\n  placeholder?: string;\r\n  disabled?: boolean;\r\n  className?: string;\r\n  isArabic?: boolean;\r\n}\r\n\r\nexport function CountrySelect({\r\n  value,\r\n  onValueChange,\r\n  placeholder = \"Select country\",\r\n  disabled = false,\r\n  className,\r\n  isArabic = false,\r\n}: CountrySelectProps) {\r\n  const [open, setOpen] = React.useState(false);\r\n\r\n  const selectedCountry = allCountries.find((c) => c.code === value);\r\n\r\n  return (\r\n    <Popover open={open} onOpenChange={setOpen}>\r\n      <PopoverTrigger asChild>\r\n        <Button\r\n          variant=\"outline\"\r\n          role=\"combobox\"\r\n          aria-expanded={open}\r\n          disabled={disabled}\r\n          className={cn(\r\n            \"w-full justify-between font-normal\",\r\n            !value && \"text-muted-foreground\",\r\n            className\r\n          )}\r\n        >\r\n          {selectedCountry\r\n            ? isArabic\r\n              ? selectedCountry.nameAr\r\n              : selectedCountry.name\r\n            : placeholder}\r\n          <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\r\n        </Button>\r\n      </PopoverTrigger>\r\n      <PopoverContent className=\"w-full min-w-[280px] p-0\" align=\"start\">\r\n        <Command>\r\n          <CommandInput placeholder=\"Search country...\" />\r\n          <CommandList>\r\n            <CommandEmpty>No country found.</CommandEmpty>\r\n            <CommandGroup>\r\n              {allCountries.map((country) => (\r\n                <CommandItem\r\n                  key={country.code}\r\n                  value={`${country.name} ${country.nameAr}`}\r\n                  onSelect={() => {\r\n                    onValueChange(country.code);\r\n                    setOpen(false);\r\n                  }}\r\n                >\r\n                  <Check\r\n                    className={cn(\r\n                      \"mr-2 h-4 w-4\",\r\n                      value === country.code ? \"opacity-100\" : \"opacity-0\"\r\n                    )}\r\n                  />\r\n                  <span className=\"flex-1\">\r\n                    {isArabic ? country.nameAr : country.name}\r\n                  </span>\r\n                  <span className=\"text-xs text-muted-foreground ml-2\">\r\n                    {country.currency}\r\n                  </span>\r\n                </CommandItem>\r\n              ))}\r\n            </CommandGroup>\r\n          </CommandList>\r\n        </Command>\r\n      </PopoverContent>\r\n    </Popover>\r\n  );\r\n}\r\n\r\nexport function getCurrencyByCountry(countryCode: string): string {\r\n  const country = allCountries.find((c) => c.code === countryCode);\r\n  return country?.currency || 'USD';\r\n}\r\n\r\nexport function getTimezoneByCountry(countryCode: string): string {\r\n  const country = allCountries.find((c) => c.code === countryCode);\r\n  return country?.timezone || 'UTC';\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\drawer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\dropdown-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\empty-state.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\error-boundary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\form.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":129,"column":10,"nodeType":"Identifier","messageId":"namedExport","endLine":129,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\";\r\nimport * as LabelPrimitive from \"@radix-ui/react-label\";\r\nimport { Slot } from \"@radix-ui/react-slot\";\r\nimport { Controller, ControllerProps, FieldPath, FieldValues, FormProvider, useFormContext } from \"react-hook-form\";\r\n\r\nimport { cn } from \"@/lib/utils\";\r\nimport { Label } from \"@/components/ui/label\";\r\n\r\nconst Form = FormProvider;\r\n\r\ntype FormFieldContextValue<\r\n  TFieldValues extends FieldValues = FieldValues,\r\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,\r\n> = {\r\n  name: TName;\r\n};\r\n\r\nconst FormFieldContext = React.createContext<FormFieldContextValue>({} as FormFieldContextValue);\r\n\r\nconst FormField = <\r\n  TFieldValues extends FieldValues = FieldValues,\r\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,\r\n>({\r\n  ...props\r\n}: ControllerProps<TFieldValues, TName>) => {\r\n  return (\r\n    <FormFieldContext.Provider value={{ name: props.name }}>\r\n      <Controller {...props} />\r\n    </FormFieldContext.Provider>\r\n  );\r\n};\r\n\r\nconst useFormField = () => {\r\n  const fieldContext = React.useContext(FormFieldContext);\r\n  const itemContext = React.useContext(FormItemContext);\r\n  const { getFieldState, formState } = useFormContext();\r\n\r\n  const fieldState = getFieldState(fieldContext.name, formState);\r\n\r\n  if (!fieldContext) {\r\n    throw new Error(\"useFormField should be used within <FormField>\");\r\n  }\r\n\r\n  const { id } = itemContext;\r\n\r\n  return {\r\n    id,\r\n    name: fieldContext.name,\r\n    formItemId: `${id}-form-item`,\r\n    formDescriptionId: `${id}-form-item-description`,\r\n    formMessageId: `${id}-form-item-message`,\r\n    ...fieldState,\r\n  };\r\n};\r\n\r\ntype FormItemContextValue = {\r\n  id: string;\r\n};\r\n\r\nconst FormItemContext = React.createContext<FormItemContextValue>({} as FormItemContextValue);\r\n\r\nconst FormItem = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(\r\n  ({ className, ...props }, ref) => {\r\n    const id = React.useId();\r\n\r\n    return (\r\n      <FormItemContext.Provider value={{ id }}>\r\n        <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\r\n      </FormItemContext.Provider>\r\n    );\r\n  },\r\n);\r\nFormItem.displayName = \"FormItem\";\r\n\r\nconst FormLabel = React.forwardRef<\r\n  React.ElementRef<typeof LabelPrimitive.Root>,\r\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\r\n>(({ className, ...props }, ref) => {\r\n  const { error, formItemId } = useFormField();\r\n\r\n  return <Label ref={ref} className={cn(error && \"text-destructive\", className)} htmlFor={formItemId} {...props} />;\r\n});\r\nFormLabel.displayName = \"FormLabel\";\r\n\r\nconst FormControl = React.forwardRef<React.ElementRef<typeof Slot>, React.ComponentPropsWithoutRef<typeof Slot>>(\r\n  ({ ...props }, ref) => {\r\n    const { error, formItemId, formDescriptionId, formMessageId } = useFormField();\r\n\r\n    return (\r\n      <Slot\r\n        ref={ref}\r\n        id={formItemId}\r\n        aria-describedby={!error ? `${formDescriptionId}` : `${formDescriptionId} ${formMessageId}`}\r\n        aria-invalid={!!error}\r\n        {...props}\r\n      />\r\n    );\r\n  },\r\n);\r\nFormControl.displayName = \"FormControl\";\r\n\r\nconst FormDescription = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLParagraphElement>>(\r\n  ({ className, ...props }, ref) => {\r\n    const { formDescriptionId } = useFormField();\r\n\r\n    return <p ref={ref} id={formDescriptionId} className={cn(\"text-sm text-muted-foreground\", className)} {...props} />;\r\n  },\r\n);\r\nFormDescription.displayName = \"FormDescription\";\r\n\r\nconst FormMessage = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLParagraphElement>>(\r\n  ({ className, children, ...props }, ref) => {\r\n    const { error, formMessageId } = useFormField();\r\n    const body = error ? String(error?.message) : children;\r\n\r\n    if (!body) {\r\n      return null;\r\n    }\r\n\r\n    return (\r\n      <p ref={ref} id={formMessageId} className={cn(\"text-sm font-medium text-destructive\", className)} {...props}>\r\n        {body}\r\n      </p>\r\n    );\r\n  },\r\n);\r\nFormMessage.displayName = \"FormMessage\";\r\n\r\nexport { useFormField, Form, FormItem, FormLabel, FormControl, FormDescription, FormMessage, FormField };\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\group-badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\hover-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\input-otp.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\menubar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\mobile-search-filter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\navigation-menu.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":111,"column":3,"nodeType":"Identifier","messageId":"namedExport","endLine":111,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\";\r\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\";\r\nimport { cva } from \"class-variance-authority\";\r\nimport { ChevronDown } from \"lucide-react\";\r\n\r\nimport { cn } from \"@/lib/utils\";\r\n\r\nconst NavigationMenu = React.forwardRef<\r\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\r\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\r\n>(({ className, children, ...props }, ref) => (\r\n  <NavigationMenuPrimitive.Root\r\n    ref={ref}\r\n    className={cn(\"relative z-10 flex max-w-max flex-1 items-center justify-center\", className)}\r\n    {...props}\r\n  >\r\n    {children}\r\n    <NavigationMenuViewport />\r\n  </NavigationMenuPrimitive.Root>\r\n));\r\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName;\r\n\r\nconst NavigationMenuList = React.forwardRef<\r\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\r\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\r\n>(({ className, ...props }, ref) => (\r\n  <NavigationMenuPrimitive.List\r\n    ref={ref}\r\n    className={cn(\"group flex flex-1 list-none items-center justify-center space-x-1\", className)}\r\n    {...props}\r\n  />\r\n));\r\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName;\r\n\r\nconst NavigationMenuItem = NavigationMenuPrimitive.Item;\r\n\r\nconst navigationMenuTriggerStyle = cva(\r\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[active]:bg-accent/50 data-[state=open]:bg-accent/50\",\r\n);\r\n\r\nconst NavigationMenuTrigger = React.forwardRef<\r\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\r\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\r\n>(({ className, children, ...props }, ref) => (\r\n  <NavigationMenuPrimitive.Trigger\r\n    ref={ref}\r\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\r\n    {...props}\r\n  >\r\n    {children}{\" \"}\r\n    <ChevronDown\r\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\r\n      aria-hidden=\"true\"\r\n    />\r\n  </NavigationMenuPrimitive.Trigger>\r\n));\r\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName;\r\n\r\nconst NavigationMenuContent = React.forwardRef<\r\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\r\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\r\n>(({ className, ...props }, ref) => (\r\n  <NavigationMenuPrimitive.Content\r\n    ref={ref}\r\n    className={cn(\r\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto\",\r\n      className,\r\n    )}\r\n    {...props}\r\n  />\r\n));\r\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName;\r\n\r\nconst NavigationMenuLink = NavigationMenuPrimitive.Link;\r\n\r\nconst NavigationMenuViewport = React.forwardRef<\r\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\r\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\r\n>(({ className, ...props }, ref) => (\r\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\r\n    <NavigationMenuPrimitive.Viewport\r\n      className={cn(\r\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\r\n        className,\r\n      )}\r\n      ref={ref}\r\n      {...props}\r\n    />\r\n  </div>\r\n));\r\nNavigationMenuViewport.displayName = NavigationMenuPrimitive.Viewport.displayName;\r\n\r\nconst NavigationMenuIndicator = React.forwardRef<\r\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\r\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\r\n>(({ className, ...props }, ref) => (\r\n  <NavigationMenuPrimitive.Indicator\r\n    ref={ref}\r\n    className={cn(\r\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\r\n      className,\r\n    )}\r\n    {...props}\r\n  >\r\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\r\n  </NavigationMenuPrimitive.Indicator>\r\n));\r\nNavigationMenuIndicator.displayName = NavigationMenuPrimitive.Indicator.displayName;\r\n\r\nexport {\r\n  navigationMenuTriggerStyle,\r\n  NavigationMenu,\r\n  NavigationMenuList,\r\n  NavigationMenuItem,\r\n  NavigationMenuContent,\r\n  NavigationMenuTrigger,\r\n  NavigationMenuLink,\r\n  NavigationMenuIndicator,\r\n  NavigationMenuViewport,\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\page-skeletons.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\pagination.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\popover.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\progress.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\pull-to-refresh.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\radio-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\resizable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\responsive-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\scroll-area.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\separator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\sheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\sidebar.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":636,"column":3,"nodeType":"Identifier","messageId":"namedExport","endLine":636,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\";\r\nimport { Slot } from \"@radix-ui/react-slot\";\r\nimport { VariantProps, cva } from \"class-variance-authority\";\r\nimport { PanelLeft } from \"lucide-react\";\r\n\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { Sheet, SheetContent } from \"@/components/ui/sheet\";\r\nimport { Skeleton } from \"@/components/ui/skeleton\";\r\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\r\n\r\nconst SIDEBAR_COOKIE_NAME = \"sidebar:state\";\r\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7;\r\nconst SIDEBAR_WIDTH = \"16rem\";\r\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\";\r\nconst SIDEBAR_WIDTH_ICON = \"3rem\";\r\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\";\r\n\r\ntype SidebarContext = {\r\n  state: \"expanded\" | \"collapsed\";\r\n  open: boolean;\r\n  setOpen: (open: boolean) => void;\r\n  openMobile: boolean;\r\n  setOpenMobile: (open: boolean) => void;\r\n  isMobile: boolean;\r\n  toggleSidebar: () => void;\r\n};\r\n\r\nconst SidebarContext = React.createContext<SidebarContext | null>(null);\r\n\r\nfunction useSidebar() {\r\n  const context = React.useContext(SidebarContext);\r\n  if (!context) {\r\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\");\r\n  }\r\n\r\n  return context;\r\n}\r\n\r\nconst SidebarProvider = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.ComponentProps<\"div\"> & {\r\n    defaultOpen?: boolean;\r\n    open?: boolean;\r\n    onOpenChange?: (open: boolean) => void;\r\n  }\r\n>(({ defaultOpen = true, open: openProp, onOpenChange: setOpenProp, className, style, children, ...props }, ref) => {\r\n  const isMobile = useIsMobile();\r\n  const [openMobile, setOpenMobile] = React.useState(false);\r\n\r\n  // This is the internal state of the sidebar.\r\n  // We use openProp and setOpenProp for control from outside the component.\r\n  const [_open, _setOpen] = React.useState(defaultOpen);\r\n  const open = openProp ?? _open;\r\n  const setOpen = React.useCallback(\r\n    (value: boolean | ((value: boolean) => boolean)) => {\r\n      const openState = typeof value === \"function\" ? value(open) : value;\r\n      if (setOpenProp) {\r\n        setOpenProp(openState);\r\n      } else {\r\n        _setOpen(openState);\r\n      }\r\n\r\n      // This sets the cookie to keep the sidebar state.\r\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`;\r\n    },\r\n    [setOpenProp, open],\r\n  );\r\n\r\n  // Helper to toggle the sidebar.\r\n  const toggleSidebar = React.useCallback(() => {\r\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open);\r\n  }, [isMobile, setOpen, setOpenMobile]);\r\n\r\n  // Adds a keyboard shortcut to toggle the sidebar.\r\n  React.useEffect(() => {\r\n    const handleKeyDown = (event: KeyboardEvent) => {\r\n      if (event.key === SIDEBAR_KEYBOARD_SHORTCUT && (event.metaKey || event.ctrlKey)) {\r\n        event.preventDefault();\r\n        toggleSidebar();\r\n      }\r\n    };\r\n\r\n    window.addEventListener(\"keydown\", handleKeyDown);\r\n    return () => window.removeEventListener(\"keydown\", handleKeyDown);\r\n  }, [toggleSidebar]);\r\n\r\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\r\n  // This makes it easier to style the sidebar with Tailwind classes.\r\n  const state = open ? \"expanded\" : \"collapsed\";\r\n\r\n  const contextValue = React.useMemo<SidebarContext>(\r\n    () => ({\r\n      state,\r\n      open,\r\n      setOpen,\r\n      isMobile,\r\n      openMobile,\r\n      setOpenMobile,\r\n      toggleSidebar,\r\n    }),\r\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar],\r\n  );\r\n\r\n  return (\r\n    <SidebarContext.Provider value={contextValue}>\r\n      <TooltipProvider delayDuration={0}>\r\n        <div\r\n          style={\r\n            {\r\n              \"--sidebar-width\": SIDEBAR_WIDTH,\r\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\r\n              ...style,\r\n            } as React.CSSProperties\r\n          }\r\n          className={cn(\"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\", className)}\r\n          ref={ref}\r\n          {...props}\r\n        >\r\n          {children}\r\n        </div>\r\n      </TooltipProvider>\r\n    </SidebarContext.Provider>\r\n  );\r\n});\r\nSidebarProvider.displayName = \"SidebarProvider\";\r\n\r\nconst Sidebar = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.ComponentProps<\"div\"> & {\r\n    side?: \"left\" | \"right\";\r\n    variant?: \"sidebar\" | \"floating\" | \"inset\";\r\n    collapsible?: \"offcanvas\" | \"icon\" | \"none\";\r\n  }\r\n>(({ side = \"left\", variant = \"sidebar\", collapsible = \"offcanvas\", className, children, ...props }, ref) => {\r\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar();\r\n\r\n  if (collapsible === \"none\") {\r\n    return (\r\n      <div\r\n        className={cn(\"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\", className)}\r\n        ref={ref}\r\n        {...props}\r\n      >\r\n        {children}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (isMobile) {\r\n    return (\r\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\r\n        <SheetContent\r\n          data-sidebar=\"sidebar\"\r\n          data-mobile=\"true\"\r\n          className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\r\n          style={\r\n            {\r\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\r\n            } as React.CSSProperties\r\n          }\r\n          side={side}\r\n        >\r\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\r\n        </SheetContent>\r\n      </Sheet>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div\r\n      ref={ref}\r\n      className=\"group peer hidden text-sidebar-foreground md:block\"\r\n      data-state={state}\r\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\r\n      data-variant={variant}\r\n      data-side={side}\r\n    >\r\n      {/* This is what handles the sidebar gap on desktop */}\r\n      <div\r\n        className={cn(\r\n          \"relative h-svh w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear\",\r\n          \"group-data-[collapsible=offcanvas]:w-0\",\r\n          \"group-data-[side=right]:rotate-180\",\r\n          variant === \"floating\" || variant === \"inset\"\r\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\r\n            : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\",\r\n        )}\r\n      />\r\n      <div\r\n        className={cn(\r\n          \"fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex\",\r\n          side === \"left\"\r\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\r\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\r\n          // Adjust the padding for floating and inset variants.\r\n          variant === \"floating\" || variant === \"inset\"\r\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\r\n            : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\r\n          className,\r\n        )}\r\n        {...props}\r\n      >\r\n        <div\r\n          data-sidebar=\"sidebar\"\r\n          className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\r\n        >\r\n          {children}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n});\r\nSidebar.displayName = \"Sidebar\";\r\n\r\nconst SidebarTrigger = React.forwardRef<React.ElementRef<typeof Button>, React.ComponentProps<typeof Button>>(\r\n  ({ className, onClick, ...props }, ref) => {\r\n    const { toggleSidebar } = useSidebar();\r\n\r\n    return (\r\n      <Button\r\n        ref={ref}\r\n        data-sidebar=\"trigger\"\r\n        variant=\"ghost\"\r\n        size=\"icon\"\r\n        className={cn(\"h-7 w-7\", className)}\r\n        onClick={(event) => {\r\n          onClick?.(event);\r\n          toggleSidebar();\r\n        }}\r\n        {...props}\r\n      >\r\n        <PanelLeft />\r\n        <span className=\"sr-only\">Toggle Sidebar</span>\r\n      </Button>\r\n    );\r\n  },\r\n);\r\nSidebarTrigger.displayName = \"SidebarTrigger\";\r\n\r\nconst SidebarRail = React.forwardRef<HTMLButtonElement, React.ComponentProps<\"button\">>(\r\n  ({ className, ...props }, ref) => {\r\n    const { toggleSidebar } = useSidebar();\r\n\r\n    return (\r\n      <button\r\n        ref={ref}\r\n        data-sidebar=\"rail\"\r\n        aria-label=\"Toggle Sidebar\"\r\n        tabIndex={-1}\r\n        onClick={toggleSidebar}\r\n        title=\"Toggle Sidebar\"\r\n        className={cn(\r\n          \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] group-data-[side=left]:-right-4 group-data-[side=right]:left-0 hover:after:bg-sidebar-border sm:flex\",\r\n          \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\r\n          \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\r\n          \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\r\n          \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\r\n          \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\r\n          className,\r\n        )}\r\n        {...props}\r\n      />\r\n    );\r\n  },\r\n);\r\nSidebarRail.displayName = \"SidebarRail\";\r\n\r\nconst SidebarInset = React.forwardRef<HTMLDivElement, React.ComponentProps<\"main\">>(({ className, ...props }, ref) => {\r\n  return (\r\n    <main\r\n      ref={ref}\r\n      className={cn(\r\n        \"relative flex min-h-svh flex-1 flex-col bg-background\",\r\n        \"peer-data-[variant=inset]:min-h-[calc(100svh-theme(spacing.4))] md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n});\r\nSidebarInset.displayName = \"SidebarInset\";\r\n\r\nconst SidebarInput = React.forwardRef<React.ElementRef<typeof Input>, React.ComponentProps<typeof Input>>(\r\n  ({ className, ...props }, ref) => {\r\n    return (\r\n      <Input\r\n        ref={ref}\r\n        data-sidebar=\"input\"\r\n        className={cn(\r\n          \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\r\n          className,\r\n        )}\r\n        {...props}\r\n      />\r\n    );\r\n  },\r\n);\r\nSidebarInput.displayName = \"SidebarInput\";\r\n\r\nconst SidebarHeader = React.forwardRef<HTMLDivElement, React.ComponentProps<\"div\">>(({ className, ...props }, ref) => {\r\n  return <div ref={ref} data-sidebar=\"header\" className={cn(\"flex flex-col gap-2 p-2\", className)} {...props} />;\r\n});\r\nSidebarHeader.displayName = \"SidebarHeader\";\r\n\r\nconst SidebarFooter = React.forwardRef<HTMLDivElement, React.ComponentProps<\"div\">>(({ className, ...props }, ref) => {\r\n  return <div ref={ref} data-sidebar=\"footer\" className={cn(\"flex flex-col gap-2 p-2\", className)} {...props} />;\r\n});\r\nSidebarFooter.displayName = \"SidebarFooter\";\r\n\r\nconst SidebarSeparator = React.forwardRef<React.ElementRef<typeof Separator>, React.ComponentProps<typeof Separator>>(\r\n  ({ className, ...props }, ref) => {\r\n    return (\r\n      <Separator\r\n        ref={ref}\r\n        data-sidebar=\"separator\"\r\n        className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\r\n        {...props}\r\n      />\r\n    );\r\n  },\r\n);\r\nSidebarSeparator.displayName = \"SidebarSeparator\";\r\n\r\nconst SidebarContent = React.forwardRef<HTMLDivElement, React.ComponentProps<\"div\">>(({ className, ...props }, ref) => {\r\n  return (\r\n    <div\r\n      ref={ref}\r\n      data-sidebar=\"content\"\r\n      className={cn(\r\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n});\r\nSidebarContent.displayName = \"SidebarContent\";\r\n\r\nconst SidebarGroup = React.forwardRef<HTMLDivElement, React.ComponentProps<\"div\">>(({ className, ...props }, ref) => {\r\n  return (\r\n    <div\r\n      ref={ref}\r\n      data-sidebar=\"group\"\r\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\r\n      {...props}\r\n    />\r\n  );\r\n});\r\nSidebarGroup.displayName = \"SidebarGroup\";\r\n\r\nconst SidebarGroupLabel = React.forwardRef<HTMLDivElement, React.ComponentProps<\"div\"> & { asChild?: boolean }>(\r\n  ({ className, asChild = false, ...props }, ref) => {\r\n    const Comp = asChild ? Slot : \"div\";\r\n\r\n    return (\r\n      <Comp\r\n        ref={ref}\r\n        data-sidebar=\"group-label\"\r\n        className={cn(\r\n          \"flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opa] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\r\n          \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\r\n          className,\r\n        )}\r\n        {...props}\r\n      />\r\n    );\r\n  },\r\n);\r\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\";\r\n\r\nconst SidebarGroupAction = React.forwardRef<HTMLButtonElement, React.ComponentProps<\"button\"> & { asChild?: boolean }>(\r\n  ({ className, asChild = false, ...props }, ref) => {\r\n    const Comp = asChild ? Slot : \"button\";\r\n\r\n    return (\r\n      <Comp\r\n        ref={ref}\r\n        data-sidebar=\"group-action\"\r\n        className={cn(\r\n          \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\r\n          // Increases the hit area of the button on mobile.\r\n          \"after:absolute after:-inset-2 after:md:hidden\",\r\n          \"group-data-[collapsible=icon]:hidden\",\r\n          className,\r\n        )}\r\n        {...props}\r\n      />\r\n    );\r\n  },\r\n);\r\nSidebarGroupAction.displayName = \"SidebarGroupAction\";\r\n\r\nconst SidebarGroupContent = React.forwardRef<HTMLDivElement, React.ComponentProps<\"div\">>(\r\n  ({ className, ...props }, ref) => (\r\n    <div ref={ref} data-sidebar=\"group-content\" className={cn(\"w-full text-sm\", className)} {...props} />\r\n  ),\r\n);\r\nSidebarGroupContent.displayName = \"SidebarGroupContent\";\r\n\r\nconst SidebarMenu = React.forwardRef<HTMLUListElement, React.ComponentProps<\"ul\">>(({ className, ...props }, ref) => (\r\n  <ul ref={ref} data-sidebar=\"menu\" className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)} {...props} />\r\n));\r\nSidebarMenu.displayName = \"SidebarMenu\";\r\n\r\nconst SidebarMenuItem = React.forwardRef<HTMLLIElement, React.ComponentProps<\"li\">>(({ className, ...props }, ref) => (\r\n  <li ref={ref} data-sidebar=\"menu-item\" className={cn(\"group/menu-item relative\", className)} {...props} />\r\n));\r\nSidebarMenuItem.displayName = \"SidebarMenuItem\";\r\n\r\nconst sidebarMenuButtonVariants = cva(\r\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\r\n  {\r\n    variants: {\r\n      variant: {\r\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\r\n        outline:\r\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\r\n      },\r\n      size: {\r\n        default: \"h-8 text-sm\",\r\n        sm: \"h-7 text-xs\",\r\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\r\n      },\r\n    },\r\n    defaultVariants: {\r\n      variant: \"default\",\r\n      size: \"default\",\r\n    },\r\n  },\r\n);\r\n\r\nconst SidebarMenuButton = React.forwardRef<\r\n  HTMLButtonElement,\r\n  React.ComponentProps<\"button\"> & {\r\n    asChild?: boolean;\r\n    isActive?: boolean;\r\n    tooltip?: string | React.ComponentProps<typeof TooltipContent>;\r\n  } & VariantProps<typeof sidebarMenuButtonVariants>\r\n>(({ asChild = false, isActive = false, variant = \"default\", size = \"default\", tooltip, className, ...props }, ref) => {\r\n  const Comp = asChild ? Slot : \"button\";\r\n  const { isMobile, state } = useSidebar();\r\n\r\n  const button = (\r\n    <Comp\r\n      ref={ref}\r\n      data-sidebar=\"menu-button\"\r\n      data-size={size}\r\n      data-active={isActive}\r\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\r\n      {...props}\r\n    />\r\n  );\r\n\r\n  if (!tooltip) {\r\n    return button;\r\n  }\r\n\r\n  if (typeof tooltip === \"string\") {\r\n    tooltip = {\r\n      children: tooltip,\r\n    };\r\n  }\r\n\r\n  return (\r\n    <Tooltip>\r\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\r\n      <TooltipContent side=\"right\" align=\"center\" hidden={state !== \"collapsed\" || isMobile} {...tooltip} />\r\n    </Tooltip>\r\n  );\r\n});\r\nSidebarMenuButton.displayName = \"SidebarMenuButton\";\r\n\r\nconst SidebarMenuAction = React.forwardRef<\r\n  HTMLButtonElement,\r\n  React.ComponentProps<\"button\"> & {\r\n    asChild?: boolean;\r\n    showOnHover?: boolean;\r\n  }\r\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\r\n  const Comp = asChild ? Slot : \"button\";\r\n\r\n  return (\r\n    <Comp\r\n      ref={ref}\r\n      data-sidebar=\"menu-action\"\r\n      className={cn(\r\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform peer-hover/menu-button:text-sidebar-accent-foreground hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\r\n        // Increases the hit area of the button on mobile.\r\n        \"after:absolute after:-inset-2 after:md:hidden\",\r\n        \"peer-data-[size=sm]/menu-button:top-1\",\r\n        \"peer-data-[size=default]/menu-button:top-1.5\",\r\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\r\n        \"group-data-[collapsible=icon]:hidden\",\r\n        showOnHover &&\r\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n});\r\nSidebarMenuAction.displayName = \"SidebarMenuAction\";\r\n\r\nconst SidebarMenuBadge = React.forwardRef<HTMLDivElement, React.ComponentProps<\"div\">>(\r\n  ({ className, ...props }, ref) => (\r\n    <div\r\n      ref={ref}\r\n      data-sidebar=\"menu-badge\"\r\n      className={cn(\r\n        \"pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground\",\r\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\r\n        \"peer-data-[size=sm]/menu-button:top-1\",\r\n        \"peer-data-[size=default]/menu-button:top-1.5\",\r\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\r\n        \"group-data-[collapsible=icon]:hidden\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  ),\r\n);\r\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\";\r\n\r\nconst SidebarMenuSkeleton = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.ComponentProps<\"div\"> & {\r\n    showIcon?: boolean;\r\n  }\r\n>(({ className, showIcon = false, ...props }, ref) => {\r\n  // Random width between 50 to 90%.\r\n  const width = React.useMemo(() => {\r\n    return `${Math.floor(Math.random() * 40) + 50}%`;\r\n  }, []);\r\n\r\n  return (\r\n    <div\r\n      ref={ref}\r\n      data-sidebar=\"menu-skeleton\"\r\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\r\n      {...props}\r\n    >\r\n      {showIcon && <Skeleton className=\"size-4 rounded-md\" data-sidebar=\"menu-skeleton-icon\" />}\r\n      <Skeleton\r\n        className=\"h-4 max-w-[--skeleton-width] flex-1\"\r\n        data-sidebar=\"menu-skeleton-text\"\r\n        style={\r\n          {\r\n            \"--skeleton-width\": width,\r\n          } as React.CSSProperties\r\n        }\r\n      />\r\n    </div>\r\n  );\r\n});\r\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\";\r\n\r\nconst SidebarMenuSub = React.forwardRef<HTMLUListElement, React.ComponentProps<\"ul\">>(\r\n  ({ className, ...props }, ref) => (\r\n    <ul\r\n      ref={ref}\r\n      data-sidebar=\"menu-sub\"\r\n      className={cn(\r\n        \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\r\n        \"group-data-[collapsible=icon]:hidden\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  ),\r\n);\r\nSidebarMenuSub.displayName = \"SidebarMenuSub\";\r\n\r\nconst SidebarMenuSubItem = React.forwardRef<HTMLLIElement, React.ComponentProps<\"li\">>(({ ...props }, ref) => (\r\n  <li ref={ref} {...props} />\r\n));\r\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\";\r\n\r\nconst SidebarMenuSubButton = React.forwardRef<\r\n  HTMLAnchorElement,\r\n  React.ComponentProps<\"a\"> & {\r\n    asChild?: boolean;\r\n    size?: \"sm\" | \"md\";\r\n    isActive?: boolean;\r\n  }\r\n>(({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\r\n  const Comp = asChild ? Slot : \"a\";\r\n\r\n  return (\r\n    <Comp\r\n      ref={ref}\r\n      data-sidebar=\"menu-sub-button\"\r\n      data-size={size}\r\n      data-active={isActive}\r\n      className={cn(\r\n        \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring aria-disabled:pointer-events-none aria-disabled:opacity-50 hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\r\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\r\n        size === \"sm\" && \"text-xs\",\r\n        size === \"md\" && \"text-sm\",\r\n        \"group-data-[collapsible=icon]:hidden\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n});\r\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\";\r\n\r\nexport {\r\n  Sidebar,\r\n  SidebarContent,\r\n  SidebarFooter,\r\n  SidebarGroup,\r\n  SidebarGroupAction,\r\n  SidebarGroupContent,\r\n  SidebarGroupLabel,\r\n  SidebarHeader,\r\n  SidebarInput,\r\n  SidebarInset,\r\n  SidebarMenu,\r\n  SidebarMenuAction,\r\n  SidebarMenuBadge,\r\n  SidebarMenuButton,\r\n  SidebarMenuItem,\r\n  SidebarMenuSkeleton,\r\n  SidebarMenuSub,\r\n  SidebarMenuSubButton,\r\n  SidebarMenuSubItem,\r\n  SidebarProvider,\r\n  SidebarRail,\r\n  SidebarSeparator,\r\n  SidebarTrigger,\r\n  useSidebar,\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\slider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\sonner.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":27,"column":19,"nodeType":"Identifier","messageId":"namedExport","endLine":27,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useTheme } from \"next-themes\";\r\nimport { Toaster as Sonner, toast } from \"sonner\";\r\n\r\ntype ToasterProps = React.ComponentProps<typeof Sonner>;\r\n\r\nconst Toaster = ({ ...props }: ToasterProps) => {\r\n  const { theme = \"system\" } = useTheme();\r\n\r\n  return (\r\n    <Sonner\r\n      theme={theme as ToasterProps[\"theme\"]}\r\n      className=\"toaster group\"\r\n      toastOptions={{\r\n        classNames: {\r\n          toast:\r\n            \"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg\",\r\n          description: \"group-[.toast]:text-muted-foreground\",\r\n          actionButton: \"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground\",\r\n          cancelButton: \"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground\",\r\n        },\r\n      }}\r\n      {...props}\r\n    />\r\n  );\r\n};\r\n\r\nexport { Toaster, toast };\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\source-badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\stage-badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\stat-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\switch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\textarea.tsx","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An interface declaring no members is equivalent to its supertype.","line":5,"column":18,"nodeType":"Identifier","messageId":"noEmptyInterfaceWithSuper","endLine":5,"endColumn":31,"suggestions":[{"messageId":"replaceEmptyInterfaceWithSuper","fix":{"range":[79,163],"text":"type TextareaProps = React.TextareaHTMLAttributes<HTMLTextAreaElement>"},"desc":"Replace empty interface with a type alias."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\";\r\n\r\nimport { cn } from \"@/lib/utils\";\r\n\r\nexport interface TextareaProps extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}\r\n\r\nconst Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(({ className, ...props }, ref) => {\r\n  return (\r\n    <textarea\r\n      className={cn(\r\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\r\n        className,\r\n      )}\r\n      ref={ref}\r\n      {...props}\r\n    />\r\n  );\r\n});\r\nTextarea.displayName = \"Textarea\";\r\n\r\nexport { Textarea };\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\toast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\toaster.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\toggle-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\toggle.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":37,"column":18,"nodeType":"Identifier","messageId":"namedExport","endLine":37,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\";\r\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\";\r\nimport { cva, type VariantProps } from \"class-variance-authority\";\r\n\r\nimport { cn } from \"@/lib/utils\";\r\n\r\nconst toggleVariants = cva(\r\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground\",\r\n  {\r\n    variants: {\r\n      variant: {\r\n        default: \"bg-transparent\",\r\n        outline: \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\r\n      },\r\n      size: {\r\n        default: \"h-10 px-3\",\r\n        sm: \"h-9 px-2.5\",\r\n        lg: \"h-11 px-5\",\r\n      },\r\n    },\r\n    defaultVariants: {\r\n      variant: \"default\",\r\n      size: \"default\",\r\n    },\r\n  },\r\n);\r\n\r\nconst Toggle = React.forwardRef<\r\n  React.ElementRef<typeof TogglePrimitive.Root>,\r\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> & VariantProps<typeof toggleVariants>\r\n>(({ className, variant, size, ...props }, ref) => (\r\n  <TogglePrimitive.Root ref={ref} className={cn(toggleVariants({ variant, size, className }))} {...props} />\r\n));\r\n\r\nToggle.displayName = TogglePrimitive.Root.displayName;\r\n\r\nexport { Toggle, toggleVariants };\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\tooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\ui\\use-toast.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\whatsapp-chatbot\\AITrainingPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\whatsapp-chatbot\\ChatbotFlowBuilder.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\whatsapp-chatbot\\ChatbotManager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\whatsapp-chatbot\\ChatbotTester.tsx","messages":[{"ruleId":null,"nodeType":null,"fatal":true,"severity":2,"message":"Parsing error: ';' expected.","line":82,"column":13}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":1,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useRef, useEffect } from 'react';\r\nimport { Send, Bot, User, Loader2, RefreshCw, Sparkles } from 'lucide-react';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { ScrollArea } from '@/components/ui/scroll-area';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select';\r\nimport { useChatbots, LLM_PROVIDERS, Chatbot } from '@/hooks/useChatbots';\r\nimport { useLanguageSafe } from '@/contexts/LanguageContext';\r\nimport { cn } from '@/lib/utils';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { toast } from 'sonner';\r\n\r\ninterface Message {\r\n  id: string;\r\n  role: 'user' | 'assistant';\r\n  content: string;\r\n  timestamp: Date;\r\n}\r\n\r\nexport function ChatbotTester() {\r\n  const { isRTL } = useLanguageSafe();\r\n  const { chatbots, isLoading } = useChatbots();\r\n  const [selectedBotId, setSelectedBotId] = useState<string>('');\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [input, setInput] = useState('');\r\n  const [isSending, setIsSending] = useState(false);\r\n  const scrollRef = useRef<HTMLDivElement>(null);\r\n  const inputRef = useRef<HTMLInputElement>(null);\r\n\r\n  const selectedBot = chatbots.find(b => b.id === selectedBotId);\r\n\r\n  // Auto-scroll to bottom when new messages arrive\r\n  useEffect(() => {\r\n    if (scrollRef.current) {\r\n      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;\r\n    }\r\n  }, [messages]);\r\n\r\n  // Show welcome message when bot is selected\r\n  useEffect(() => {\r\n    if (selectedBot?.welcome_message && messages.length === 0) {\r\n      setMessages([{\r\n        id: 'welcome',\r\n        role: 'assistant',\r\n        content: selectedBot.welcome_message,\r\n        timestamp: new Date(),\r\n      }]);\r\n    }\r\n  }, [selectedBot, messages.length]);\r\n\r\n  const handleSend = async () => {\r\n    if (!input.trim() || !selectedBot || isSending) return;\r\n\r\n    const userMessage: Message = {\r\n      id: `user-${Date.now()}`,\r\n      role: 'user',\r\n      content: input.trim(),\r\n      timestamp: new Date(),\r\n    };\r\n\r\n    setMessages(prev => [...prev, userMessage]);\r\n    setInput('');\r\n    setIsSending(true);\r\n\r\n    try {\r\n      // Prepare messages for API\r\n      const apiMessages = messages\r\n        .filter(m => m.id !== 'welcome')\r\n        .map(m => ({ role: m.role, content: m.content }));\r\n      apiMessages.push({ role: 'user', content: userMessage.content });\r\n\r\n\r\n      provider: selectedBot.llm_provider,\r\n        model: selectedBot.llm_model,\r\n      });\r\n\r\n    const { data, error } = await supabase.functions.invoke('chatbot-chat', {\r\n      body: {\r\n        messages: apiMessages,\r\n        provider: selectedBot.llm_provider,\r\n        model: selectedBot.llm_model,\r\n        apiKey: selectedBot.llm_api_key_encrypted,\r\n        systemPrompt: selectedBot.system_prompt,\r\n        temperature: selectedBot.temperature,\r\n        maxTokens: selectedBot.max_tokens,\r\n        stream: false,\r\n      },\r\n    });\r\n\r\n    if (error) throw error;\r\n\r\n    if (data?.error) {\r\n      throw new Error(data.error);\r\n    }\r\n\r\n    const assistantMessage: Message = {\r\n      id: `assistant-${Date.now()}`,\r\n      role: 'assistant',\r\n      content: data.content || 'No response received.',\r\n      timestamp: new Date(),\r\n    };\r\n\r\n    setMessages(prev => [...prev, assistantMessage]);\r\n  } catch (error) {\r\n    console.error('Chat error:', error);\r\n    toast.error(error instanceof Error ? error.message : 'Failed to send message');\r\n\r\n    // Add error message to chat\r\n    setMessages(prev => [...prev, {\r\n      id: `error-${Date.now()}`,\r\n      role: 'assistant',\r\n      content: `Error: ${error instanceof Error ? error.message : 'Failed to get response'}`,\r\n      timestamp: new Date(),\r\n    }]);\r\n  } finally {\r\n    setIsSending(false);\r\n    inputRef.current?.focus();\r\n  }\r\n};\r\n\r\nconst handleKeyDown = (e: React.KeyboardEvent) => {\r\n  if (e.key === 'Enter' && !e.shiftKey) {\r\n    e.preventDefault();\r\n    handleSend();\r\n  }\r\n};\r\n\r\nconst clearChat = () => {\r\n  setMessages([]);\r\n  if (selectedBot?.welcome_message) {\r\n    setMessages([{\r\n      id: 'welcome',\r\n      role: 'assistant',\r\n      content: selectedBot.welcome_message,\r\n      timestamp: new Date(),\r\n    }]);\r\n  }\r\n};\r\n\r\nif (isLoading) {\r\n  return (\r\n    <Card>\r\n      <CardContent className=\"p-8 text-center\">\r\n        <Loader2 className=\"h-8 w-8 animate-spin mx-auto text-muted-foreground\" />\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n\r\nreturn (\r\n  <div className=\"space-y-4\">\r\n    {/* Bot Selector */}\r\n    <Card>\r\n      <CardHeader className=\"pb-3\">\r\n        <CardTitle className=\"text-lg flex items-center gap-2\">\r\n          <Sparkles className=\"h-5 w-5 text-primary\" />\r\n          {isRTL ? 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±ÙˆØ¨ÙˆØª' : 'Test Chatbot'}\r\n        </CardTitle>\r\n      </CardHeader>\r\n      <CardContent>\r\n        <div className=\"flex flex-col sm:flex-row gap-3\">\r\n          <Select\r\n            value={selectedBotId}\r\n            onValueChange={(value) => {\r\n              setSelectedBotId(value);\r\n              setMessages([]);\r\n            }}\r\n          >\r\n            <SelectTrigger className=\"flex-1\">\r\n              <SelectValue placeholder={isRTL ? 'Ø§Ø®ØªØ± Ø±ÙˆØ¨ÙˆØª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 'Select a chatbot to test'} />\r\n            </SelectTrigger>\r\n            <SelectContent>\r\n              {chatbots.length === 0 ? (\r\n                <div className=\"p-2 text-sm text-muted-foreground text-center\">\r\n                  {isRTL ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ¨ÙˆØªØ§Øª' : 'No chatbots available'}\r\n                </div>\r\n              ) : (\r\n                chatbots.map(bot => (\r\n                  <SelectItem key={bot.id} value={bot.id}>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <Bot className=\"h-4 w-4\" />\r\n                      <span>{bot.name}</span>\r\n                      <Badge variant=\"outline\" className=\"text-xs\">\r\n                        {LLM_PROVIDERS[bot.llm_provider]?.name || bot.llm_provider}\r\n                      </Badge>\r\n                    </div>\r\n                  </SelectItem>\r\n                ))\r\n              )}\r\n            </SelectContent>\r\n          </Select>\r\n          {selectedBot && (\r\n            <Button variant=\"outline\" size=\"icon\" onClick={clearChat} title=\"Clear chat\">\r\n              <RefreshCw className=\"h-4 w-4\" />\r\n            </Button>\r\n          )}\r\n        </div>\r\n\r\n        {selectedBot && (\r\n          <div className=\"mt-3 flex flex-wrap gap-2 text-xs text-muted-foreground\">\r\n            <Badge variant=\"secondary\">\r\n              {selectedBot.llm_model.split('/').pop()}\r\n            </Badge>\r\n            <span>â€¢</span>\r\n            <span>Temp: {selectedBot.temperature}</span>\r\n            <span>â€¢</span>\r\n            <span>Max tokens: {selectedBot.max_tokens}</span>\r\n          </div>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n\r\n    {/* Chat Interface */}\r\n    {selectedBot && (\r\n      <Card className=\"flex flex-col h-[500px]\">\r\n        <CardHeader className=\"pb-2 border-b\">\r\n          <div className={cn(\"flex items-center gap-2\", isRTL && \"flex-row-reverse\")}>\r\n            <div className=\"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center\">\r\n              <Bot className=\"h-4 w-4 text-primary\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"font-medium text-sm\">{selectedBot.name}</p>\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                {selectedBot.is_active\r\n                  ? (isRTL ? 'Ù…ØªØµÙ„' : 'Online')\r\n                  : (isRTL ? 'ØºÙŠØ± Ù…ØªØµÙ„' : 'Offline')}\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </CardHeader>\r\n\r\n        <ScrollArea className=\"flex-1 p-4\" ref={scrollRef}>\r\n          <div className=\"space-y-4\">\r\n            {messages.map((message) => (\r\n              <div\r\n                key={message.id}\r\n                className={cn(\r\n                  \"flex gap-3\",\r\n                  message.role === 'user' ? \"flex-row-reverse\" : \"\",\r\n                  isRTL && \"flex-row-reverse\",\r\n                  isRTL && message.role === 'user' && \"flex-row\"\r\n                )}\r\n              >\r\n                <div className={cn(\r\n                  \"w-8 h-8 rounded-full flex items-center justify-center shrink-0\",\r\n                  message.role === 'user'\r\n                    ? \"bg-primary text-primary-foreground\"\r\n                    : \"bg-muted\"\r\n                )}>\r\n                  {message.role === 'user'\r\n                    ? <User className=\"h-4 w-4\" />\r\n                    : <Bot className=\"h-4 w-4\" />}\r\n                </div>\r\n                <div className={cn(\r\n                  \"max-w-[80%] rounded-lg px-4 py-2\",\r\n                  message.role === 'user'\r\n                    ? \"bg-primary text-primary-foreground\"\r\n                    : \"bg-muted\",\r\n                  message.content.startsWith('Error:') && \"bg-destructive/10 text-destructive\"\r\n                )}>\r\n                  <p className=\"text-sm whitespace-pre-wrap\">{message.content}</p>\r\n                  <p className={cn(\r\n                    \"text-xs mt-1 opacity-70\",\r\n                    message.role === 'user' ? \"text-right\" : \"text-left\"\r\n                  )}>\r\n                    {message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            ))}\r\n\r\n            {isSending && (\r\n              <div className={cn(\"flex gap-3\", isRTL && \"flex-row-reverse\")}>\r\n                <div className=\"w-8 h-8 rounded-full bg-muted flex items-center justify-center\">\r\n                  <Bot className=\"h-4 w-4\" />\r\n                </div>\r\n                <div className=\"bg-muted rounded-lg px-4 py-3\">\r\n                  <div className=\"flex gap-1\">\r\n                    <span className=\"w-2 h-2 bg-foreground/40 rounded-full animate-bounce\" style={{ animationDelay: '0ms' }} />\r\n                    <span className=\"w-2 h-2 bg-foreground/40 rounded-full animate-bounce\" style={{ animationDelay: '150ms' }} />\r\n                    <span className=\"w-2 h-2 bg-foreground/40 rounded-full animate-bounce\" style={{ animationDelay: '300ms' }} />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </ScrollArea>\r\n\r\n        <div className=\"p-4 border-t\">\r\n          <div className=\"flex gap-2\">\r\n            <Input\r\n              ref={inputRef}\r\n              value={input}\r\n              onChange={(e) => setInput(e.target.value)}\r\n              onKeyDown={handleKeyDown}\r\n              placeholder={isRTL ? 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...' : 'Type your message...'}\r\n              disabled={isSending}\r\n              className={cn(isRTL && \"text-right\")}\r\n            />\r\n            <Button\r\n              onClick={handleSend}\r\n              disabled={!input.trim() || isSending}\r\n              size=\"icon\"\r\n            >\r\n              {isSending ? (\r\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n              ) : (\r\n                <Send className=\"h-4 w-4\" />\r\n              )}\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </Card>\r\n    )}\r\n\r\n    {/* Empty State */}\r\n    {!selectedBot && chatbots.length > 0 && (\r\n      <Card className=\"border-dashed\">\r\n        <CardContent className=\"p-8 text-center\">\r\n          <Bot className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\r\n          <p className=\"text-muted-foreground\">\r\n            {isRTL ? 'Ø§Ø®ØªØ± Ø±ÙˆØ¨ÙˆØª Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©' : 'Select a chatbot to start testing'}\r\n          </p>\r\n        </CardContent>\r\n      </Card>\r\n    )}\r\n\r\n    {chatbots.length === 0 && (\r\n      <Card className=\"border-dashed\">\r\n        <CardContent className=\"p-8 text-center\">\r\n          <Bot className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\r\n          <p className=\"font-medium mb-2\">{isRTL ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ¨ÙˆØªØ§Øª' : 'No Chatbots Yet'}</p>\r\n          <p className=\"text-muted-foreground text-sm\">\r\n            {isRTL ? 'Ø£Ù†Ø´Ø¦ Ø±ÙˆØ¨ÙˆØª Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø±ÙˆØ¨ÙˆØªØ§Øª' : 'Create a chatbot first from the Bots tab'}\r\n          </p>\r\n        </CardContent>\r\n      </Card>\r\n    )}\r\n  </div>\r\n);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\whatsapp-chatbot\\DeploymentControls.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\whatsapp-chatbot\\TemplatesLibrary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\whatsapp-chatbot\\WhatsAppAnalytics.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\whatsapp-chatbot\\WhatsAppInbox.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\whatsapp-chatbot\\WhatsAppSettings.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":46,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1871,1874],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1871,1874],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":62,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2391,2394],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2391,2394],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from 'react';\r\nimport { \r\n  RefreshCw, Check, X, AlertCircle, Save,\r\n  MessageCircle, ExternalLink, ShieldCheck, FileText, Clock, CheckCircle2, Info\r\n} from 'lucide-react';\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select';\r\nimport { useWhatsAppConnection } from '@/contexts/WhatsAppConnectionContext';\r\nimport { useLanguageSafe } from '@/contexts/LanguageContext';\r\nimport { toast } from 'sonner';\r\n\r\nexport function WhatsAppSettings() {\r\n  const { isRTL } = useLanguageSafe();\r\n  const { connections, activeConnection, addConnection, updateConnection, testConnection, isLoading } = useWhatsAppConnection();\r\n  const [isSaving, setIsSaving] = useState(false);\r\n  const [formData, setFormData] = useState({\r\n    provider: activeConnection?.provider || 'meta',\r\n    apiKey: activeConnection?.apiKey || '',\r\n    phoneNumber: activeConnection?.phoneNumber || '',\r\n    token: activeConnection?.token || '',\r\n  });\r\n\r\n  const handleTestConnection = async () => {\r\n    if (activeConnection) {\r\n      const success = await testConnection(activeConnection.id);\r\n      if (success) {\r\n        toast.success(isRTL ? 'ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­' : 'Connected successfully');\r\n      } else {\r\n        toast.error(isRTL ? 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„' : 'Connection failed');\r\n      }\r\n    } else if (formData.apiKey && formData.phoneNumber) {\r\n      // Create new connection\r\n      addConnection({\r\n        phoneNumber: formData.phoneNumber,\r\n        displayName: 'WhatsApp Business',\r\n        provider: formData.provider as any,\r\n        status: 'connected',\r\n        apiKey: formData.apiKey,\r\n        token: formData.token,\r\n        lastSync: new Date(),\r\n      });\r\n      toast.success(isRTL ? 'ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­' : 'Connected successfully');\r\n    } else {\r\n      toast.error(isRTL ? 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©' : 'Please enter required fields');\r\n    }\r\n  };\r\n\r\n  const handleSaveSettings = () => {\r\n    setIsSaving(true);\r\n    if (activeConnection) {\r\n      updateConnection(activeConnection.id, {\r\n        provider: formData.provider as any,\r\n        apiKey: formData.apiKey,\r\n        phoneNumber: formData.phoneNumber,\r\n        token: formData.token,\r\n      });\r\n    }\r\n    setTimeout(() => {\r\n      toast.success(isRTL ? 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª' : 'Settings saved');\r\n      setIsSaving(false);\r\n    }, 500);\r\n  };\r\n\r\n  const getStatusBadge = (status?: string) => {\r\n    switch (status) {\r\n      case 'connected':\r\n        return (\r\n          <Badge className=\"bg-green-500/10 text-green-600 border-green-500/20\">\r\n            <Check className=\"h-3 w-3 mr-1\" />\r\n            {isRTL ? 'Ù…ØªØµÙ„' : 'Connected'}\r\n          </Badge>\r\n        );\r\n      case 'error':\r\n        return (\r\n          <Badge className=\"bg-red-500/10 text-red-600 border-red-500/20\">\r\n            <AlertCircle className=\"h-3 w-3 mr-1\" />\r\n            {isRTL ? 'Ø®Ø·Ø£' : 'Error'}\r\n          </Badge>\r\n        );\r\n      default:\r\n        return (\r\n          <Badge variant=\"outline\" className=\"text-muted-foreground\">\r\n            <X className=\"h-3 w-3 mr-1\" />\r\n            {isRTL ? 'ØºÙŠØ± Ù…ØªØµÙ„' : 'Disconnected'}\r\n          </Badge>\r\n        );\r\n    }\r\n  };\r\n\r\n  const isConnected = activeConnection?.status === 'connected';\r\n\r\n  return (\r\n    <div className=\"space-y-4 md:space-y-6 p-3 md:p-6 max-w-4xl mx-auto\">\r\n      {/* Hero Connect Button for Disconnected State */}\r\n      {!isConnected && (\r\n        <Card className=\"bg-gradient-to-br from-green-500/10 via-green-600/5 to-transparent border-green-500/20\">\r\n          <CardContent className=\"p-6 md:p-8 text-center space-y-4\">\r\n            <div className=\"w-16 h-16 mx-auto bg-green-500/20 rounded-full flex items-center justify-center\">\r\n              <MessageCircle className=\"h-8 w-8 text-green-600\" />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <h2 className=\"text-xl md:text-2xl font-bold\">\r\n                {isRTL ? 'Ø±Ø¨Ø· WhatsApp Business API' : 'Connect WhatsApp Business API'}\r\n              </h2>\r\n              <p className=\"text-muted-foreground text-sm md:text-base max-w-md mx-auto\">\r\n                {isRTL \r\n                  ? 'Ø§Ø±Ø¨Ø· Ø±Ù‚Ù… WhatsApp Business Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¢Ù„ÙŠØ© ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª'\r\n                  : 'Connect your WhatsApp Business number to send automated messages and run your chatbot'\r\n                }\r\n              </p>\r\n            </div>\r\n            <Button \r\n              size=\"lg\" \r\n              className=\"bg-green-600 hover:bg-green-700 text-white gap-2 px-8\"\r\n              onClick={() => window.open('https://business.facebook.com/settings/whatsapp-business-accounts', '_blank')}\r\n            >\r\n              <MessageCircle className=\"h-5 w-5\" />\r\n              {isRTL ? 'Ø±Ø¨Ø· WhatsApp Ø§Ù„Ø¢Ù†' : 'Connect WhatsApp Now'}\r\n              <ExternalLink className=\"h-4 w-4\" />\r\n            </Button>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              {isRTL ? 'Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø¥Ù„Ù‰ Meta Business Suite' : 'You will be redirected to Meta Business Suite'}\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Meta Rules & Guidelines */}\r\n      <Card className=\"bg-card/50 backdrop-blur-sm border-amber-500/20\">\r\n        <CardHeader className=\"pb-3\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <ShieldCheck className=\"h-5 w-5 text-amber-500\" />\r\n            <CardTitle className=\"text-base md:text-lg text-amber-600\">\r\n              {isRTL ? 'Ù‚ÙˆØ§Ø¹Ø¯ Meta Ø§Ù„Ù…Ù‡Ù…Ø©' : 'Important Meta Rules'}\r\n            </CardTitle>\r\n          </div>\r\n          <CardDescription>\r\n            {isRTL \r\n              ? 'ÙŠØ¬Ø¨ Ø§ØªØ¨Ø§Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ù„ØªØ¬Ù†Ø¨ Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ'\r\n              : 'You must follow these rules to avoid account suspension'\r\n            }\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent className=\"space-y-3\">\r\n          <div className=\"grid gap-3 md:grid-cols-2\">\r\n            <div className=\"flex items-start gap-2 p-3 bg-muted/30 rounded-lg\">\r\n              <FileText className=\"h-4 w-4 mt-0.5 text-muted-foreground\" />\r\n              <div>\r\n                <p className=\"text-sm font-medium\">{isRTL ? 'Ù‚ÙˆØ§Ù„Ø¨ Ù…Ø¹ØªÙ…Ø¯Ø© ÙÙ‚Ø·' : 'Approved Templates Only'}</p>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  {isRTL \r\n                    ? 'Ø§Ø³ØªØ®Ø¯Ù… Ù‚ÙˆØ§Ù„Ø¨ Ù…Ø¹ØªÙ…Ø¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù…Ù† Meta ÙÙ‚Ø·'\r\n                    : 'Only use pre-approved Meta templates'\r\n                  }\r\n                </p>\r\n              </div>\r\n            </div>\r\n            \r\n            <div className=\"flex items-start gap-2 p-3 bg-muted/30 rounded-lg\">\r\n              <Clock className=\"h-4 w-4 mt-0.5 text-muted-foreground\" />\r\n              <div>\r\n                <p className=\"text-sm font-medium\">{isRTL ? 'Ù†Ø§ÙØ°Ø© 24 Ø³Ø§Ø¹Ø©' : '24-Hour Window'}</p>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  {isRTL \r\n                    ? 'Ø§Ù„Ø±Ø¯ Ø¨Ø­Ø±ÙŠØ© Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø© Ù…Ù† Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©'\r\n                    : 'Reply freely within 24 hours of last message'\r\n                  }\r\n                </p>\r\n              </div>\r\n            </div>\r\n            \r\n            <div className=\"flex items-start gap-2 p-3 bg-muted/30 rounded-lg\">\r\n              <CheckCircle2 className=\"h-4 w-4 mt-0.5 text-muted-foreground\" />\r\n              <div>\r\n                <p className=\"text-sm font-medium\">{isRTL ? 'Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„' : 'Customer Consent'}</p>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  {isRTL \r\n                    ? 'Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ§ÙÙ‚Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ©'\r\n                    : 'Get consent before marketing messages'\r\n                  }\r\n                </p>\r\n              </div>\r\n            </div>\r\n            \r\n            <div className=\"flex items-start gap-2 p-3 bg-muted/30 rounded-lg\">\r\n              <Info className=\"h-4 w-4 mt-0.5 text-muted-foreground\" />\r\n              <div>\r\n                <p className=\"text-sm font-medium\">{isRTL ? 'Ø±Ù‚Ù… Ø£Ø¹Ù…Ø§Ù„ ÙÙ‚Ø·' : 'Business Number Only'}</p>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  {isRTL \r\n                    ? 'Ø§Ø³ØªØ®Ø¯Ù… Ø±Ù‚Ù… WhatsApp Business Ù…ÙØªØ­Ù‚Ù‚ Ù…Ù†Ù‡'\r\n                    : 'Use a verified WhatsApp Business number'\r\n                  }\r\n                </p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          \r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            className=\"w-full gap-2\"\r\n            onClick={() => window.open('https://developers.facebook.com/docs/whatsapp/overview/getting-started', '_blank')}\r\n          >\r\n            <FileText className=\"h-4 w-4\" />\r\n            {isRTL ? 'Ù‚Ø±Ø§Ø¡Ø© Ø³ÙŠØ§Ø³Ø§Øª Meta Ø§Ù„ÙƒØ§Ù…Ù„Ø©' : 'Read Full Meta Policies'}\r\n            <ExternalLink className=\"h-3 w-3\" />\r\n          </Button>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* API Configuration */}\r\n      <Card className=\"bg-card/50 backdrop-blur-sm\">\r\n        <CardHeader>\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <CardTitle className=\"text-base md:text-lg\">\r\n                {isRTL ? 'ØªÙƒÙˆÙŠÙ† API' : 'API Configuration'}\r\n              </CardTitle>\r\n              <CardDescription>\r\n                {isRTL ? 'Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø¹ØªÙ…Ø§Ø¯ WhatsApp Business API' : 'Enter your WhatsApp Business API credentials'}\r\n              </CardDescription>\r\n            </div>\r\n            {getStatusBadge(activeConnection?.status)}\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent className=\"space-y-4\">\r\n          {/* Show connected numbers if any */}\r\n          {connections.length > 0 && (\r\n            <div className=\"space-y-2 mb-4\">\r\n              <Label>{isRTL ? 'Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ØªØµÙ„Ø©' : 'Connected Numbers'}</Label>\r\n              <div className=\"flex flex-wrap gap-2\">\r\n                {connections.map(conn => (\r\n                  <Badge \r\n                    key={conn.id} \r\n                    variant={conn.status === 'connected' ? 'default' : 'outline'}\r\n                    className=\"gap-1\"\r\n                  >\r\n                    {conn.status === 'connected' && <Check className=\"h-3 w-3\" />}\r\n                    {conn.phoneNumber} ({conn.provider})\r\n                  </Badge>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"space-y-2\">\r\n            <Label>{isRTL ? 'Ø§Ù„Ù…Ø²ÙˆØ¯' : 'Provider'}</Label>\r\n            <Select value={formData.provider} onValueChange={(v) => setFormData({ ...formData, provider: v as 'meta' | 'twilio' | '360dialog' | 'vonage' })}>\r\n              <SelectTrigger>\r\n                <SelectValue />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"meta\">Official WhatsApp Cloud API (Recommended)</SelectItem>\r\n                <SelectItem value=\"twilio\">Twilio</SelectItem>\r\n                <SelectItem value=\"360dialog\">360Dialog</SelectItem>\r\n                <SelectItem value=\"vonage\">Vonage</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <Label>{isRTL ? 'Ù…ÙØªØ§Ø­ API' : 'API Key / Access Token'}</Label>\r\n            <Input\r\n              type=\"password\"\r\n              value={formData.apiKey}\r\n              onChange={(e) => setFormData({ ...formData, apiKey: e.target.value })}\r\n              placeholder=\"EAAxxxxxxx...\"\r\n            />\r\n          </div>\r\n\r\n          <div className=\"grid gap-4 sm:grid-cols-2\">\r\n            <div className=\"space-y-2\">\r\n              <Label>{isRTL ? 'Ù…Ø¹Ø±Ù Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ' : 'Phone Number ID'}</Label>\r\n              <Input\r\n                value={formData.phoneNumber}\r\n                onChange={(e) => setFormData({ ...formData, phoneNumber: e.target.value })}\r\n                placeholder=\"1234567890...\"\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>{isRTL ? 'Ù…Ø¹Ø±Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„' : 'Business Account ID'}</Label>\r\n              <Input\r\n                type=\"password\"\r\n                value={formData.token}\r\n                onChange={(e) => setFormData({ ...formData, token: e.target.value })}\r\n                placeholder=\"1234567890...\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex flex-col sm:flex-row gap-2 pt-4\">\r\n            <Button\r\n              variant=\"outline\"\r\n              onClick={handleTestConnection}\r\n              disabled={isLoading}\r\n              className=\"flex-1\"\r\n            >\r\n              {isLoading ? (\r\n                <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\r\n              ) : (\r\n                <RefreshCw className=\"h-4 w-4 mr-2\" />\r\n              )}\r\n              {isRTL ? 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„' : 'Test Connection'}\r\n            </Button>\r\n            <Button onClick={handleSaveSettings} disabled={isSaving} className=\"flex-1 bg-green-600 hover:bg-green-700\">\r\n              <Save className=\"h-4 w-4 mr-2\" />\r\n              {isRTL ? 'Ø­ÙØ¸ Ø§Ù„ØªÙƒÙˆÙŠÙ†' : 'Save Configuration'}\r\n            </Button>\r\n          </div>\r\n\r\n          {isConnected && (\r\n            <div className=\"flex items-center gap-2 p-3 bg-green-500/10 rounded-lg border border-green-500/20\">\r\n              <Check className=\"h-5 w-5 text-green-600\" />\r\n              <div className=\"flex-1\">\r\n                <p className=\"text-sm font-medium text-green-700\">\r\n                  {isRTL ? 'Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­' : 'Successfully Connected'}\r\n                </p>\r\n                <p className=\"text-xs text-green-600/80\">\r\n                  {isRTL ? 'Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©: ' : 'Last sync: '}\r\n                  {activeConnection?.lastSync?.toLocaleString()}\r\n                </p>\r\n              </div>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                className=\"text-green-700 hover:text-green-800 hover:bg-green-500/10\"\r\n                onClick={() => window.open('https://business.facebook.com/settings/whatsapp-business-accounts', '_blank')}\r\n              >\r\n                <ExternalLink className=\"h-4 w-4\" />\r\n              </Button>\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\whatsapp-chatbot\\WhatsAppThread.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\whatsapp-chatbot\\mockData.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\components\\whatsapp-chatbot\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\config\\navigation.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":21,"column":9,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":12,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[275,278],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[275,278],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n  LayoutDashboard,\r\n  Users,\r\n  GitBranch,\r\n  Building2,\r\n  Link2,\r\n  CreditCard,\r\n  Settings,\r\n  Home,\r\n  Target,\r\n  Workflow,\r\n  Megaphone,\r\n  UsersRound,\r\n  Shield,\r\n  Cloud,\r\n  MessageCircle,\r\n  Plug,\r\n} from \"lucide-react\";\r\n\r\nexport type NavItem = {\r\n  icon: any;\r\n  label: string; // Fallback English label\r\n  labelKey: string; // Translation key\r\n  path: string;\r\n};\r\n\r\nexport type NavSection = {\r\n  label: string; // Fallback English label\r\n  labelKey: string; // Translation key\r\n  items: NavItem[];\r\n};\r\n\r\nconst leadsSection: NavSection = {\r\n  label: \"Leads Management\",\r\n  labelKey: \"leads_management\",\r\n  items: [\r\n    { icon: LayoutDashboard, label: \"Dashboard\", labelKey: \"dashboard\", path: \"/\" },\r\n    { icon: Users, label: \"Leads\", labelKey: \"leads\", path: \"/leads\" },\r\n    { icon: GitBranch, label: \"Pipeline\", labelKey: \"pipeline\", path: \"/pipeline\" },\r\n    { icon: Target, label: \"Lead Sources\", labelKey: \"lead_sources\", path: \"/lead-sources\" },\r\n    { icon: Workflow, label: \"Lead Assignment\", labelKey: \"lead_assignment\", path: \"/lead-assignment\" },\r\n  ],\r\n};\r\n\r\nconst marketingSection: NavSection = {\r\n  label: \"Marketing Hub\",\r\n  labelKey: \"marketing_hub\",\r\n  items: [\r\n    { icon: Megaphone, label: \"Campaigns\", labelKey: \"campaigns\", path: \"/campaigns\" },\r\n    { icon: MessageCircle, label: \"WhatsApp Bot\", labelKey: \"whatsapp_bot\", path: \"/whatsapp-chatbot\" },\r\n    { icon: Plug, label: \"Connections\", labelKey: \"connections\", path: \"/connections\" },\r\n  ],\r\n};\r\n\r\nconst listingsSection: NavSection = {\r\n  label: \"Listings\",\r\n  labelKey: \"listings\",\r\n  items: [\r\n    { icon: Home, label: \"My Listings\", labelKey: \"my_listings\", path: \"/listings\" },\r\n    { icon: Building2, label: \"Company Listings\", labelKey: \"company_listings\", path: \"/company-listings\" },\r\n    { icon: Link2, label: \"Integrations\", labelKey: \"integrations\", path: \"/integrations\" },\r\n    { icon: Cloud, label: \"Portal Settings\", labelKey: \"portal_settings\", path: \"/portal-settings\" },\r\n  ],\r\n};\r\n\r\nconst adminSection: NavSection = {\r\n  label: \"Admin\",\r\n  labelKey: \"admin\",\r\n  items: [\r\n    { icon: UsersRound, label: \"Teams\", labelKey: \"teams\", path: \"/teams\" },\r\n    { icon: Shield, label: \"Roles & Permissions\", labelKey: \"roles_permissions\", path: \"/roles\" },\r\n    { icon: CreditCard, label: \"Billing\", labelKey: \"billing\", path: \"/billing\" },\r\n    { icon: Settings, label: \"Settings\", labelKey: \"settings\", path: \"/settings\" },\r\n  ],\r\n};\r\n\r\nexport const navigation: NavSection[] = [\r\n  leadsSection,\r\n  listingsSection,\r\n  marketingSection,\r\n  adminSection,\r\n];","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\contexts\\AuthContext.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":13,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[459,462],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[459,462],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'fetchProfile'. Either include it or remove the dependency array.","line":91,"column":6,"nodeType":"ArrayExpression","endLine":91,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchProfile]","fix":{"range":[2957,2959],"text":"[fetchProfile]"}}]},{"ruleId":"prefer-const","severity":2,"message":"'refreshInterval' is never reassigned. Use 'const' instead.","line":183,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":183,"endColumn":20},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchProfile'. Either include it or remove the dependency array.","line":226,"column":6,"nodeType":"ArrayExpression","endLine":226,"endColumn":45,"suggestions":[{"desc":"Update the dependencies array to be: [refreshSession, isSessionExpiringSoon, fetchProfile]","fix":{"range":[7207,7246],"text":"[refreshSession, isSessionExpiringSoon, fetchProfile]"}}]},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":283,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":283,"endColumn":24}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createContext, useContext, useEffect, useState, useCallback, ReactNode } from \"react\";\r\nimport { User, Session } from \"@supabase/supabase-js\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { toast } from \"sonner\";\r\n\r\ntype Profile = {\r\n  id: string;\r\n  first_name: string | null;\r\n  last_name: string | null;\r\n  avatar_url: string | null;\r\n  onboarding_completed: boolean;\r\n  company_id: string | null;\r\n  dashboard_preferences: any;\r\n};\r\n\r\ntype AuthContextType = {\r\n  user: User | null;\r\n  session: Session | null;\r\n  profile: Profile | null;\r\n  isLoading: boolean;\r\n  signIn: (email: string, password: string) => Promise<{ error: Error | null }>;\r\n  signUp: (email: string, password: string, firstName: string, lastName: string) => Promise<{ error: Error | null }>;\r\n  signInWithGoogle: () => Promise<{ error: Error | null }>;\r\n  signOut: () => Promise<void>;\r\n  refreshProfile: () => Promise<void>;\r\n  refreshSession: () => Promise<boolean>;\r\n};\r\n\r\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\r\n\r\nexport function AuthProvider({ children }: { children: ReactNode }) {\r\n  const [user, setUser] = useState<User | null>(null);\r\n  const [session, setSession] = useState<Session | null>(null);\r\n  const [profile, setProfile] = useState<Profile | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n\r\n  const fetchProfile = async (userId: string) => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"id, first_name, last_name, avatar_url, onboarding_completed, company_id, dashboard_preferences\")\r\n        .eq(\"id\", userId)\r\n        .single();\r\n\r\n      if (!error && data) {\r\n        setProfile(data);\r\n      } else if (error?.code === 'PGRST301' || error?.message?.includes('JWT')) {\r\n        // JWT expired, try to refresh\r\n        await refreshSession();\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching profile:', error);\r\n    }\r\n  };\r\n\r\n  const refreshProfile = async () => {\r\n    if (user) {\r\n      await fetchProfile(user.id);\r\n    }\r\n  };\r\n\r\n  // Refresh session and return success status\r\n  const refreshSession = useCallback(async (): Promise<boolean> => {\r\n    try {\r\n      const { data, error } = await supabase.auth.refreshSession();\r\n\r\n      if (error) {\r\n        console.error('Session refresh failed:', error);\r\n        // Session truly expired, sign out\r\n        setUser(null);\r\n        setSession(null);\r\n        setProfile(null);\r\n        toast.error('Session expired. Please log in again.');\r\n        return false;\r\n      }\r\n\r\n      if (data.session) {\r\n        setSession(data.session);\r\n        setUser(data.session.user);\r\n        if (data.session.user) {\r\n          await fetchProfile(data.session.user.id);\r\n        }\r\n        return true;\r\n      }\r\n\r\n      return false;\r\n    } catch (error) {\r\n      console.error('Error refreshing session:', error);\r\n      return false;\r\n    }\r\n  }, []);\r\n\r\n  // Check if session is about to expire (within 5 minutes)\r\n  const isSessionExpiringSoon = useCallback((sess: Session | null): boolean => {\r\n    if (!sess?.expires_at) return false;\r\n    const expiresAt = sess.expires_at * 1000; // Convert to milliseconds\r\n    const now = Date.now();\r\n    const fiveMinutes = 5 * 60 * 1000;\r\n    return expiresAt - now < fiveMinutes;\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    let refreshInterval: NodeJS.Timeout;\r\n    let mounted = true;\r\n\r\n    // Get initial session\r\n    const initSession = async () => {\r\n      try {\r\n        const { data: { session: initialSession } } = await supabase.auth.getSession();\r\n\r\n        if (!mounted) return;\r\n\r\n        if (initialSession) {\r\n          // Check if session is expired or expiring soon\r\n          if (isSessionExpiringSoon(initialSession)) {\r\n            const refreshed = await refreshSession();\r\n            if (!refreshed && mounted) {\r\n              setIsLoading(false);\r\n            }\r\n          } else {\r\n            setSession(initialSession);\r\n            setUser(initialSession.user);\r\n            if (initialSession.user) {\r\n              await fetchProfile(initialSession.user.id);\r\n            }\r\n          }\r\n        }\r\n\r\n        if (mounted) {\r\n          setIsLoading(false);\r\n        }\r\n      } catch (error) {\r\n        console.error('Error initializing session:', error);\r\n        if (mounted) {\r\n          setIsLoading(false);\r\n        }\r\n      }\r\n    };\r\n\r\n    initSession();\r\n\r\n    // Listen for auth changes\r\n    const { data: { subscription } } = supabase.auth.onAuthStateChange(\r\n      async (event, newSession) => {\r\n        if (!mounted) return;\r\n\r\n\r\n\r\n        if (event === 'TOKEN_REFRESHED' && newSession) {\r\n          setSession(newSession);\r\n          setUser(newSession.user);\r\n        } else if (event === 'SIGNED_OUT') {\r\n          setSession(null);\r\n          setUser(null);\r\n          setProfile(null);\r\n        } else if (event === 'SIGNED_IN' && newSession) {\r\n          setSession(newSession);\r\n          setUser(newSession.user);\r\n          if (newSession.user) {\r\n            setTimeout(() => {\r\n              if (mounted) fetchProfile(newSession.user.id);\r\n            }, 0);\r\n          }\r\n        } else {\r\n          setSession(newSession);\r\n          setUser(newSession?.user ?? null);\r\n          if (newSession?.user) {\r\n            setTimeout(() => {\r\n              if (mounted) fetchProfile(newSession.user.id);\r\n            }, 0);\r\n          } else {\r\n            setProfile(null);\r\n          }\r\n        }\r\n\r\n        if (mounted) {\r\n          setIsLoading(false);\r\n        }\r\n      }\r\n    );\r\n\r\n    // Auto-refresh session every 4 minutes to prevent JWT expiration\r\n    refreshInterval = setInterval(async () => {\r\n      if (!mounted) return;\r\n\r\n      const { data: { session: currentSession } } = await supabase.auth.getSession();\r\n      if (currentSession && isSessionExpiringSoon(currentSession)) {\r\n        await refreshSession();\r\n      }\r\n    }, 4 * 60 * 1000);\r\n\r\n    // Refresh session when tab becomes visible (user returns to tab)\r\n    const handleVisibilityChange = async () => {\r\n      if (document.visibilityState === 'visible' && mounted) {\r\n        const { data: { session: currentSession } } = await supabase.auth.getSession();\r\n        if (currentSession) {\r\n          // Always try to refresh when returning to tab if session exists\r\n          if (isSessionExpiringSoon(currentSession)) {\r\n            await refreshSession();\r\n          }\r\n        }\r\n      }\r\n    };\r\n\r\n    document.addEventListener('visibilitychange', handleVisibilityChange);\r\n\r\n    // Refresh session on window focus\r\n    const handleFocus = async () => {\r\n      if (mounted) {\r\n        const { data: { session: currentSession } } = await supabase.auth.getSession();\r\n        if (currentSession && isSessionExpiringSoon(currentSession)) {\r\n          await refreshSession();\r\n        }\r\n      }\r\n    };\r\n\r\n    window.addEventListener('focus', handleFocus);\r\n\r\n    return () => {\r\n      mounted = false;\r\n      subscription.unsubscribe();\r\n      clearInterval(refreshInterval);\r\n      document.removeEventListener('visibilitychange', handleVisibilityChange);\r\n      window.removeEventListener('focus', handleFocus);\r\n    };\r\n  }, [refreshSession, isSessionExpiringSoon]);\r\n\r\n  const signIn = async (email: string, password: string) => {\r\n    const { error } = await supabase.auth.signInWithPassword({ email, password });\r\n    return { error };\r\n  };\r\n\r\n  const signInWithGoogle = async () => {\r\n    const { error } = await supabase.auth.signInWithOAuth({\r\n      provider: 'google',\r\n      options: {\r\n        redirectTo: `${window.location.origin}/`,\r\n      }\r\n    });\r\n    return { error };\r\n  };\r\n\r\n  const signUp = async (email: string, password: string, firstName: string, lastName: string) => {\r\n    const redirectUrl = `${window.location.origin}/`;\r\n\r\n    const { error } = await supabase.auth.signUp({\r\n      email,\r\n      password,\r\n      options: {\r\n        data: {\r\n          first_name: firstName,\r\n          last_name: lastName,\r\n        },\r\n        emailRedirectTo: redirectUrl,\r\n      },\r\n    });\r\n\r\n    return { error };\r\n  };\r\n\r\n  const signOut = async () => {\r\n    // Clear local state first to ensure UI updates immediately\r\n    setUser(null);\r\n    setSession(null);\r\n    setProfile(null);\r\n\r\n    // Then attempt server-side signout (ignore errors if session already expired)\r\n    try {\r\n      await supabase.auth.signOut({ scope: 'local' });\r\n    } catch (error) {\r\n      // Session may already be expired, that's okay\r\n\r\n    }\r\n  };\r\n\r\n  return (\r\n    <AuthContext.Provider value={{ user, session, profile, isLoading, signIn, signInWithGoogle, signUp, signOut, refreshProfile, refreshSession }}>\r\n      {children}\r\n    </AuthContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useAuth() {\r\n  const context = useContext(AuthContext);\r\n  if (!context) {\r\n    throw new Error(\"useAuth must be used within an AuthProvider\");\r\n  }\r\n  return context;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\contexts\\EmailConnectionContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":205,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":205,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useState, useCallback, useEffect, ReactNode } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { toast } from 'sonner';\r\n\r\nexport interface EmailConnection {\r\n  id: string;\r\n  email: string;\r\n  displayName: string;\r\n  provider: 'resend' | 'sendgrid' | 'mailgun' | 'ses';\r\n  status: 'connected' | 'disconnected' | 'error';\r\n  lastSync?: Date;\r\n  apiKey?: string;\r\n  verified?: boolean;\r\n}\r\n\r\ninterface EmailConnectionContextType {\r\n  connections: EmailConnection[];\r\n  activeConnection: EmailConnection | null;\r\n  isLoading: boolean;\r\n  addConnection: (connection: Omit<EmailConnection, 'id'>) => void;\r\n  updateConnection: (id: string, updates: Partial<EmailConnection>) => void;\r\n  removeConnection: (id: string) => void;\r\n  setActiveConnection: (id: string) => void;\r\n  testConnection: (id: string) => Promise<boolean>;\r\n}\r\n\r\nconst EmailConnectionContext = createContext<EmailConnectionContextType | undefined>(undefined);\r\n\r\nexport function EmailConnectionProvider({ children }: { children: ReactNode }) {\r\n  const { user, profile } = useAuth();\r\n  const [connections, setConnections] = useState<EmailConnection[]>([]);\r\n  const [activeConnectionId, setActiveConnectionId] = useState<string | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n\r\n  const activeConnection = connections.find(c => c.id === activeConnectionId) || null;\r\n\r\n  // Fetch connections from database\r\n  const fetchConnections = useCallback(async () => {\r\n    if (!user || !profile?.company_id) {\r\n      setConnections([]);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('marketing_connections')\r\n        .select('*')\r\n        .eq('company_id', profile.company_id)\r\n        .eq('channel', 'email')\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (error) throw error;\r\n\r\n      const mapped: EmailConnection[] = (data || []).map(row => ({\r\n        id: row.id,\r\n        email: row.identifier,\r\n        displayName: row.display_name,\r\n        provider: row.provider as EmailConnection['provider'],\r\n        status: row.status as EmailConnection['status'],\r\n        lastSync: row.last_sync ? new Date(row.last_sync) : undefined,\r\n        apiKey: (row.credentials as Record<string, string>)?.apiKey,\r\n        verified: row.verified,\r\n      }));\r\n\r\n      setConnections(mapped);\r\n      if (mapped.length > 0 && !activeConnectionId) {\r\n        setActiveConnectionId(mapped[0].id);\r\n      }\r\n    } catch (err) {\r\n      console.error('Error fetching email connections:', err);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [user, profile?.company_id, activeConnectionId]);\r\n\r\n  useEffect(() => {\r\n    fetchConnections();\r\n  }, [fetchConnections]);\r\n\r\n  const addConnection = useCallback(async (connection: Omit<EmailConnection, 'id'>) => {\r\n    if (!user || !profile?.company_id) {\r\n      toast.error('Please log in to add connections');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('marketing_connections')\r\n        .insert({\r\n          company_id: profile.company_id,\r\n          channel: 'email',\r\n          provider: connection.provider,\r\n          display_name: connection.displayName,\r\n          identifier: connection.email,\r\n          credentials: { apiKey: connection.apiKey },\r\n          status: connection.status,\r\n          verified: connection.verified || false,\r\n          last_sync: connection.lastSync?.toISOString(),\r\n          created_by: user.id,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      const newConnection: EmailConnection = {\r\n        id: data.id,\r\n        email: data.identifier,\r\n        displayName: data.display_name,\r\n        provider: data.provider as EmailConnection['provider'],\r\n        status: data.status as EmailConnection['status'],\r\n        lastSync: data.last_sync ? new Date(data.last_sync) : undefined,\r\n        apiKey: connection.apiKey,\r\n        verified: data.verified,\r\n      };\r\n\r\n      setConnections(prev => [newConnection, ...prev]);\r\n      toast.success('Email connection added');\r\n    } catch (err) {\r\n      console.error('Error adding email connection:', err);\r\n      toast.error('Failed to add connection');\r\n    }\r\n  }, [user, profile?.company_id]);\r\n\r\n  const updateConnection = useCallback(async (id: string, updates: Partial<EmailConnection>) => {\r\n    try {\r\n      const dbUpdates: Record<string, unknown> = {};\r\n      if (updates.displayName) dbUpdates.display_name = updates.displayName;\r\n      if (updates.email) dbUpdates.identifier = updates.email;\r\n      if (updates.status) dbUpdates.status = updates.status;\r\n      if (updates.lastSync) dbUpdates.last_sync = updates.lastSync.toISOString();\r\n      if (typeof updates.verified === 'boolean') dbUpdates.verified = updates.verified;\r\n\r\n      await supabase\r\n        .from('marketing_connections')\r\n        .update(dbUpdates)\r\n        .eq('id', id);\r\n\r\n      setConnections(prev => \r\n        prev.map(conn => conn.id === id ? { ...conn, ...updates } : conn)\r\n      );\r\n    } catch (err) {\r\n      console.error('Error updating connection:', err);\r\n    }\r\n  }, []);\r\n\r\n  const removeConnection = useCallback(async (id: string) => {\r\n    try {\r\n      await supabase\r\n        .from('marketing_connections')\r\n        .delete()\r\n        .eq('id', id);\r\n\r\n      setConnections(prev => prev.filter(conn => conn.id !== id));\r\n      if (activeConnectionId === id) {\r\n        setActiveConnectionId(null);\r\n      }\r\n      toast.success('Email connection removed');\r\n    } catch (err) {\r\n      console.error('Error removing connection:', err);\r\n      toast.error('Failed to remove connection');\r\n    }\r\n  }, [activeConnectionId]);\r\n\r\n  const setActiveConnection = useCallback((id: string) => {\r\n    setActiveConnectionId(id);\r\n  }, []);\r\n\r\n  const testConnection = useCallback(async (id: string): Promise<boolean> => {\r\n    setIsLoading(true);\r\n    await new Promise(resolve => setTimeout(resolve, 1500));\r\n    \r\n    const connection = connections.find(c => c.id === id);\r\n    if (connection) {\r\n      const success = connection.apiKey && connection.email;\r\n      await updateConnection(id, { \r\n        status: success ? 'connected' : 'error',\r\n        lastSync: success ? new Date() : undefined\r\n      });\r\n      setIsLoading(false);\r\n      return !!success;\r\n    }\r\n    setIsLoading(false);\r\n    return false;\r\n  }, [connections, updateConnection]);\r\n\r\n  return (\r\n    <EmailConnectionContext.Provider value={{\r\n      connections,\r\n      activeConnection,\r\n      isLoading,\r\n      addConnection,\r\n      updateConnection,\r\n      removeConnection,\r\n      setActiveConnection,\r\n      testConnection,\r\n    }}>\r\n      {children}\r\n    </EmailConnectionContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useEmailConnection() {\r\n  const context = useContext(EmailConnectionContext);\r\n  if (context === undefined) {\r\n    throw new Error('useEmailConnection must be used within an EmailConnectionProvider');\r\n  }\r\n  return context;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\contexts\\GroupsContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":13,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":13,"endColumn":33},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":126,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":126,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createContext, useContext, useState, useEffect, ReactNode } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"./AuthContext\";\r\n\r\nexport type LeadGroup = {\r\n  id: string;\r\n  name: string;\r\n  color: string;\r\n  leadCount?: number;\r\n};\r\n\r\n// 15 distinct vibrant group color options (no gray/neutral)\r\nexport const GROUP_COLOR_OPTIONS = [\r\n  \"#EF4444\", // Red\r\n  \"#F59E0B\", // Amber\r\n  \"#10B981\", // Emerald\r\n  \"#3B82F6\", // Blue\r\n  \"#8B5CF6\", // Purple\r\n  \"#EC4899\", // Pink\r\n  \"#06B6D4\", // Cyan\r\n  \"#F97316\", // Orange\r\n  \"#14B8A6\", // Teal\r\n  \"#6366F1\", // Indigo\r\n  \"#84CC16\", // Lime\r\n  \"#A855F7\", // Violet\r\n  \"#0EA5E9\", // Sky\r\n  \"#22C55E\", // Green\r\n  \"#E11D48\", // Rose\r\n];\r\n\r\ntype GroupsContextType = {\r\n  groups: LeadGroup[];\r\n  setGroups: React.Dispatch<React.SetStateAction<LeadGroup[]>>;\r\n  addGroup: (group: LeadGroup) => void;\r\n  updateGroup: (id: string, updates: Partial<LeadGroup>) => void;\r\n  deleteGroup: (id: string) => void;\r\n  reorderGroups: (newGroups: LeadGroup[]) => void;\r\n  isLoading: boolean;\r\n};\r\n\r\nconst fallbackGroups: LeadGroup[] = [\r\n  { id: \"vip\", name: \"VIP\", color: \"#F59E0B\", leadCount: 0 },\r\n  { id: \"hot\", name: \"Hot Leads\", color: \"#EF4444\", leadCount: 0 },\r\n  { id: \"cold\", name: \"Cold Leads\", color: \"#3B82F6\", leadCount: 0 },\r\n  { id: \"investor\", name: \"Investors\", color: \"#8B5CF6\", leadCount: 0 },\r\n  { id: \"first-time\", name: \"First Time Buyers\", color: \"#06B6D4\", leadCount: 0 },\r\n  { id: \"cash\", name: \"Cash Buyers\", color: \"#10B981\", leadCount: 0 },\r\n  { id: \"followup\", name: \"Follow Up Required\", color: \"#EC4899\", leadCount: 0 },\r\n];\r\n\r\nconst GroupsContext = createContext<GroupsContextType | undefined>(undefined);\r\n\r\nexport function GroupsProvider({ children }: { children: ReactNode }) {\r\n  const [groups, setGroups] = useState<LeadGroup[]>(fallbackGroups);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const { profile } = useAuth();\r\n\r\n  // Fetch groups from database\r\n  useEffect(() => {\r\n    const fetchGroups = async () => {\r\n      if (!profile?.company_id) {\r\n        setGroups(fallbackGroups);\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n\r\n      try {\r\n        const { data, error } = await supabase\r\n          .from(\"lead_groups\")\r\n          .select(\"*\")\r\n          .eq(\"company_id\", profile.company_id)\r\n          .order(\"created_at\", { ascending: true });\r\n\r\n        if (error) {\r\n          console.error(\"Error fetching groups:\", error);\r\n          setGroups(fallbackGroups);\r\n        } else if (data && data.length > 0) {\r\n          const mappedGroups: LeadGroup[] = data.map(group => ({\r\n            id: group.id,\r\n            name: group.name,\r\n            color: group.color || \"#3B82F6\",\r\n            leadCount: 0,\r\n          }));\r\n          setGroups(mappedGroups);\r\n        } else {\r\n          setGroups(fallbackGroups);\r\n        }\r\n      } catch (error) {\r\n        console.error(\"Error fetching groups:\", error);\r\n        setGroups(fallbackGroups);\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    };\r\n\r\n    fetchGroups();\r\n  }, [profile?.company_id]);\r\n\r\n  const addGroup = (group: LeadGroup) => {\r\n    setGroups((prev) => [...prev, group]);\r\n  };\r\n\r\n  const updateGroup = (id: string, updates: Partial<LeadGroup>) => {\r\n    setGroups((prev) =>\r\n      prev.map((group) => (group.id === id ? { ...group, ...updates } : group))\r\n    );\r\n  };\r\n\r\n  const deleteGroup = (id: string) => {\r\n    setGroups((prev) => prev.filter((group) => group.id !== id));\r\n  };\r\n\r\n  const reorderGroups = (newGroups: LeadGroup[]) => {\r\n    setGroups(newGroups);\r\n  };\r\n\r\n  return (\r\n    <GroupsContext.Provider\r\n      value={{ groups, setGroups, addGroup, updateGroup, deleteGroup, reorderGroups, isLoading }}\r\n    >\r\n      {children}\r\n    </GroupsContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useGroups() {\r\n  const context = useContext(GroupsContext);\r\n  if (!context) {\r\n    throw new Error(\"useGroups must be used within a GroupsProvider\");\r\n  }\r\n  return context;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\contexts\\LanguageContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":201,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":201,"endColumn":28},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":210,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":210,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createContext, useContext, useState, useEffect, ReactNode } from 'react';\r\n\r\ntype Language = 'en' | 'ar';\r\n\r\ninterface LanguageContextType {\r\n  language: Language;\r\n  setLanguage: (lang: Language) => void;\r\n  isRTL: boolean;\r\n  t: (key: string) => string;\r\n}\r\n\r\nconst translations: Record<string, Record<Language, string>> = {\r\n  // Navigation\r\n  'nav.home': { en: 'Home', ar: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' },\r\n  'nav.features': { en: 'Features', ar: 'Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª' },\r\n  'nav.pricing': { en: 'Pricing', ar: 'Ø§Ù„Ø£Ø³Ø¹Ø§Ø±' },\r\n  'nav.faq': { en: 'FAQs', ar: 'Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©' },\r\n  'nav.blog': { en: 'Blog', ar: 'Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©' },\r\n  'nav.contact': { en: 'Contact', ar: 'ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§' },\r\n  'nav.signin': { en: 'Sign In', ar: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' },\r\n  'nav.getStarted': { en: 'Get Started', ar: 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†' },\r\n  \r\n  // Hero\r\n  'hero.tagline': { en: 'All Your Real Estate Leads. One Powerful CRM.', ar: 'Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„Ø§Ø¦Ùƒ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠÙŠÙ†. Ù†Ø¸Ø§Ù… CRM ÙˆØ§Ø­Ø¯ Ù‚ÙˆÙŠ.' },\r\n  'hero.subtitle': { en: \"OneLinker CRM â€” The Middle East's First Mobile-First Real Estate CRM to manage leads, listings, marketing, teams & portalsâ€¦ all in one app.\", ar: 'OneLinker CRM â€” Ø£ÙˆÙ„ Ù†Ø¸Ø§Ù… CRM Ø¹Ù‚Ø§Ø±ÙŠ Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¬ÙˆØ§Ù„ ÙÙŠ Ø§Ù„Ø´Ø±Ù‚ Ø§Ù„Ø£ÙˆØ³Ø· Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙˆØ§Ù„ØªØ³ÙˆÙŠÙ‚ ÙˆØ§Ù„ÙØ±Ù‚ ÙˆØ§Ù„Ø¨ÙˆØ§Ø¨Ø§Øª... ÙƒÙ„ Ø°Ù„Ùƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ø­Ø¯.' },\r\n  'hero.bookDemo': { en: 'Book Free Demo', ar: 'Ø§Ø­Ø¬Ø² Ø¹Ø±Ø¶ Ù…Ø¬Ø§Ù†ÙŠ' },\r\n  'hero.getStarted': { en: 'Get Started', ar: 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†' },\r\n  \r\n  // Why OneLinker\r\n  'why.title': { en: 'Why OneLinker CRM?', ar: 'Ù„Ù…Ø§Ø°Ø§ OneLinker CRMØŸ' },\r\n  'why.subtitle': { en: 'Built specifically for Middle East real estate professionals', ar: 'Ù…ØµÙ…Ù… Ø®ØµÙŠØµØ§Ù‹ Ù„Ù…Ø­ØªØ±ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø´Ø±Ù‚ Ø§Ù„Ø£ÙˆØ³Ø·' },\r\n  'why.faster.title': { en: 'Faster Lead Closing', ar: 'Ø¥ØºÙ„Ø§Ù‚ Ø£Ø³Ø±Ø¹ Ù„Ù„ØµÙÙ‚Ø§Øª' },\r\n  'why.faster.desc': { en: 'Close deals 3x faster with automated follow-ups and smart reminders', ar: 'Ø£ØºÙ„Ù‚ Ø§Ù„ØµÙÙ‚Ø§Øª Ø£Ø³Ø±Ø¹ 3 Ù…Ø±Ø§Øª Ù…Ø¹ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ÙˆØ§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©' },\r\n  'why.mobile.title': { en: 'Mobile-First Design', ar: 'ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹' },\r\n  'why.mobile.desc': { en: 'Manage your entire business from your phone, anywhere, anytime', ar: 'Ø£Ø¯Ø± Ø¹Ù…Ù„Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† Ù‡Ø§ØªÙÙƒØŒ ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† ÙˆØ²Ù…Ø§Ù†' },\r\n  'why.ai.title': { en: 'AI-Powered Automation', ar: 'Ø£ØªÙ…ØªØ© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' },\r\n  'why.ai.desc': { en: 'Let AI handle routine tasks while you focus on closing deals', ar: 'Ø¯Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠØªÙˆÙ„Ù‰ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø±ÙˆØªÙŠÙ†ÙŠØ© Ø¨ÙŠÙ†Ù…Ø§ ØªØ±ÙƒØ² Ø¹Ù„Ù‰ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙÙ‚Ø§Øª' },\r\n  'why.currency.title': { en: 'Multi-Currency Support', ar: 'Ø¯Ø¹Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©' },\r\n  'why.currency.desc': { en: 'AED, QAR, SAR, USD â€” work seamlessly across GCC markets', ar: 'Ø¯Ø±Ù‡Ù…ØŒ Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠØŒ Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠØŒ Ø¯ÙˆÙ„Ø§Ø± â€” Ø§Ø¹Ù…Ù„ Ø¨Ø³Ù„Ø§Ø³Ø© Ø¹Ø¨Ø± Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ø®Ù„ÙŠØ¬' },\r\n  \r\n  // Features\r\n  'features.title': { en: 'Powerful Features', ar: 'Ù…Ù…ÙŠØ²Ø§Øª Ù‚ÙˆÙŠØ©' },\r\n  'features.subtitle': { en: 'Everything you need to dominate the real estate market', ar: 'ÙƒÙ„ Ù…Ø§ ØªØ­ØªØ§Ø¬Ù‡ Ù„Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ Ø³ÙˆÙ‚ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª' },\r\n  'features.leads.title': { en: 'Lead Management', ar: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' },\r\n  'features.leads.desc': { en: 'Capture, track, and convert leads with intelligent pipeline management', ar: 'Ø§Ù„ØªÙ‚Ø· ÙˆØªØªØ¨Ø¹ ÙˆØ­ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ø°ÙƒÙŠØ© Ù„Ù„Ù…Ø±Ø§Ø­Ù„' },\r\n  'features.sources.title': { en: 'Lead Source Integration', ar: 'ØªÙƒØ§Ù…Ù„ Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' },\r\n  'features.sources.desc': { en: 'Connect Meta, Google, TikTok ads and property portals instantly', ar: 'Ø§ØªØµÙ„ Ø¨Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…ÙŠØªØ§ ÙˆØ¬ÙˆØ¬Ù„ ÙˆØªÙŠÙƒ ØªÙˆÙƒ ÙˆØ§Ù„Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© ÙÙˆØ±Ø§Ù‹' },\r\n  'features.listings.title': { en: 'Listings Management', ar: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª' },\r\n  'features.listings.desc': { en: 'Manage your entire property portfolio from one dashboard', ar: 'Ø£Ø¯Ø± Ù…Ø­ÙØ¸ØªÙƒ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ÙˆØ§Ø­Ø¯Ø©' },\r\n  'features.portals.title': { en: 'Portal Publishing', ar: 'Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø§Øª' },\r\n  'features.portals.desc': { en: 'One-click publish to 20+ property portals across the region', ar: 'Ù†Ø´Ø± Ø¨Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø£ÙƒØ«Ø± Ù…Ù† 20 Ø¨ÙˆØ§Ø¨Ø© Ø¹Ù‚Ø§Ø±ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©' },\r\n  'features.teams.title': { en: 'Team Management', ar: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙŠÙ‚' },\r\n  'features.teams.desc': { en: 'Admin, managers, team leaders, and agents â€” all organized', ar: 'Ù…Ø¯Ø±Ø§Ø¡ ÙˆÙ…Ø³Ø¤ÙˆÙ„ÙˆÙ† ÙˆÙ‚Ø§Ø¯Ø© ÙØ±Ù‚ ÙˆÙˆÙƒÙ„Ø§Ø¡ â€” Ø§Ù„ÙƒÙ„ Ù…Ù†Ø¸Ù…' },\r\n  'features.whatsapp.title': { en: 'WhatsApp Integration', ar: 'ØªÙƒØ§Ù…Ù„ ÙˆØ§ØªØ³Ø§Ø¨' },\r\n  'features.whatsapp.desc': { en: 'Send templates, follow-ups, and communicate directly from CRM', ar: 'Ø£Ø±Ø³Ù„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª ÙˆØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…' },\r\n  'features.chatbot.title': { en: 'AI WhatsApp Chatbot', ar: 'Ø±ÙˆØ¨ÙˆØª ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø°ÙƒÙŠ' },\r\n  'features.chatbot.desc': { en: 'Qualify leads 24/7 with AI-powered WhatsApp chatbots that never sleep', ar: 'Ø£Ù‡Ù‘Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ø³Ø§Ø¹Ø© Ù…Ø¹ Ø±ÙˆØ¨ÙˆØªØ§Øª ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø°ÙƒÙŠØ©' },\r\n  'features.campaigns.title': { en: 'Marketing Campaigns', ar: 'Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ©' },\r\n  'features.campaigns.desc': { en: 'Create multi-channel campaigns via WhatsApp, SMS, and Email', ar: 'Ø£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯' },\r\n  'features.sms.title': { en: 'SMS Marketing', ar: 'Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø¨Ø§Ù„Ø±Ø³Ø§Ø¦Ù„' },\r\n  'features.sms.desc': { en: 'Bulk SMS campaigns with personalized templates and tracking', ar: 'Ø­Ù…Ù„Ø§Øª Ø±Ø³Ø§Ø¦Ù„ Ø¬Ù…Ø§Ø¹ÙŠØ© Ù…Ø¹ Ù‚ÙˆØ§Ù„Ø¨ Ù…Ø®ØµØµØ© ÙˆØªØªØ¨Ø¹' },\r\n  'features.email.title': { en: 'Email Campaigns', ar: 'Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯' },\r\n  'features.email.desc': { en: 'Beautiful drag-and-drop email builder with analytics', ar: 'Ù…Ù†Ø´Ø¦ Ø¨Ø±ÙŠØ¯ Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù…Ø¹ ØªØ­Ù„ÙŠÙ„Ø§Øª' },\r\n  'features.aiAssistant.title': { en: 'AI Lead Assistant', ar: 'Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø°ÙƒÙŠ' },\r\n  'features.aiAssistant.desc': { en: 'AI suggests responses, qualifies leads, and writes follow-ups', ar: 'Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠÙ‚ØªØ±Ø­ Ø§Ù„Ø±Ø¯ÙˆØ¯ ÙˆÙŠØ¤Ù‡Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆÙŠÙƒØªØ¨ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª' },\r\n  'features.leadScoring.title': { en: 'Lead Scoring', ar: 'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' },\r\n  'features.leadScoring.desc': { en: 'Automatically score leads based on engagement and behavior', ar: 'ØªÙ‚ÙŠÙŠÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ' },\r\n  'features.automation.title': { en: 'Workflow Automation', ar: 'Ø£ØªÙ…ØªØ© Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„' },\r\n  'features.automation.desc': { en: 'Automate repetitive tasks with powerful IF/THEN rules', ar: 'Ø£ØªÙ…Øª Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© Ù…Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Ø¥Ø°Ø§/Ø¹Ù†Ø¯Ù‡Ø§ Ø§Ù„Ù‚ÙˆÙŠØ©' },\r\n  'features.followups.title': { en: 'Smart Follow-ups', ar: 'Ù…ØªØ§Ø¨Ø¹Ø§Øª Ø°ÙƒÙŠØ©' },\r\n  'features.followups.desc': { en: 'Never miss a follow-up with automated reminders and scheduling', ar: 'Ù„Ø§ ØªÙÙˆØª Ø£ÙŠ Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¹ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„Ø©' },\r\n  'features.landing.title': { en: 'Landing Page Builder', ar: 'Ù…Ù†Ø´Ø¦ ØµÙØ­Ø§Øª Ø§Ù„Ù‡Ø¨ÙˆØ·' },\r\n  'features.landing.desc': { en: 'Create stunning landing pages without any coding', ar: 'Ø£Ù†Ø´Ø¦ ØµÙØ­Ø§Øª Ù‡Ø¨ÙˆØ· Ù…Ø°Ù‡Ù„Ø© Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø¨Ø±Ù…Ø¬Ø©' },\r\n  'features.analytics.title': { en: 'Analytics Dashboard', ar: 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª' },\r\n  'features.analytics.desc': { en: 'Real-time insights into your sales performance and team metrics', ar: 'Ø±Ø¤Ù‰ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆÙ…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„ÙØ±ÙŠÙ‚' },\r\n  'features.ai.title': { en: 'AI Follow-ups', ar: 'Ù…ØªØ§Ø¨Ø¹Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' },\r\n  'features.ai.desc': { en: 'Smart AI-powered follow-up suggestions and voice notes', ar: 'Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù…ØªØ§Ø¨Ø¹Ø© Ø°ÙƒÙŠØ© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©' },\r\n  'features.stages.title': { en: 'Custom Lead Stages', ar: 'Ù…Ø±Ø§Ø­Ù„ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø®ØµØµØ©' },\r\n  'features.stages.desc': { en: 'Create custom pipelines that match your sales process', ar: 'Ø£Ù†Ø´Ø¦ Ù…Ø±Ø§Ø­Ù„ Ù…Ø®ØµØµØ© ØªØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ' },\r\n  'features.assign.title': { en: 'Smart Assignment', ar: 'Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø°ÙƒÙŠ' },\r\n  'features.assign.desc': { en: 'Round-robin, weighted, and rule-based lead assignment', ar: 'ØªØ¹ÙŠÙŠÙ† Ø¯ÙˆØ±ÙŠ ÙˆÙ…ÙˆØ²ÙˆÙ† ÙˆÙ‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯' },\r\n  'features.pdf.title': { en: 'PDF Generator', ar: 'Ù…Ù†Ø´Ø¦ PDF' },\r\n  'features.pdf.desc': { en: 'Generate professional listing brochures with one click', ar: 'Ø£Ù†Ø´Ø¦ ÙƒØªÙŠØ¨Ø§Øª Ø¹Ù‚Ø§Ø±ÙŠØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø¨Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø©' },\r\n  'features.presentation.title': { en: 'Presentation Generator', ar: 'Ù…Ù†Ø´Ø¦ Ø§Ù„Ø¹Ø±ÙˆØ¶' },\r\n  'features.presentation.desc': { en: 'Create stunning horizontal presentations for clients', ar: 'Ø£Ù†Ø´Ø¦ Ø¹Ø±ÙˆØ¶ Ø£ÙÙ‚ÙŠØ© Ù…Ø°Ù‡Ù„Ø© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡' },\r\n  'features.mobile.title': { en: 'Mobile-First App', ar: 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹' },\r\n  'features.mobile.desc': { en: 'Full CRM functionality on iOS and Android devices', ar: 'ÙˆØ¸Ø§Ø¦Ù CRM ÙƒØ§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø£Ø¬Ù‡Ø²Ø© iOS ÙˆØ£Ù†Ø¯Ø±ÙˆÙŠØ¯' },\r\n  'features.security.title': { en: 'Enterprise Security', ar: 'Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª' },\r\n  'features.security.desc': { en: 'Role-based access, data encryption, and audit logs', ar: 'ÙˆØµÙˆÙ„ Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚' },\r\n  \r\n  // Mobile App\r\n  'mobile.title': { en: \"Middle East's First Mobile-First Real Estate CRM\", ar: 'Ø£ÙˆÙ„ Ù†Ø¸Ø§Ù… CRM Ø¹Ù‚Ø§Ø±ÙŠ Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¬ÙˆØ§Ù„ ÙÙŠ Ø§Ù„Ø´Ø±Ù‚ Ø§Ù„Ø£ÙˆØ³Ø·' },\r\n  'mobile.subtitle': { en: 'Your entire business in your pocket', ar: 'Ø¹Ù…Ù„Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø¬ÙŠØ¨Ùƒ' },\r\n  'mobile.push': { en: 'Instant Push Notifications', ar: 'Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙˆØ±ÙŠØ©' },\r\n  'mobile.calls': { en: 'One-Tap Lead Calls', ar: 'Ø§ØªØµØ§Ù„ Ø¨Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø©' },\r\n  'mobile.voice': { en: 'Voice Note Recording', ar: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©' },\r\n  'mobile.followup': { en: 'Quick Follow-ups', ar: 'Ù…ØªØ§Ø¨Ø¹Ø§Øª Ø³Ø±ÙŠØ¹Ø©' },\r\n  \r\n  // Portals\r\n  'portals.title': { en: 'Publish to 20+ Property Portals', ar: 'Ø§Ù†Ø´Ø± Ø¹Ù„Ù‰ Ø£ÙƒØ«Ø± Ù…Ù† 20 Ø¨ÙˆØ§Ø¨Ø© Ø¹Ù‚Ø§Ø±ÙŠØ©' },\r\n  'portals.subtitle': { en: 'One-click publishing to all major property portals in the region', ar: 'Ù†Ø´Ø± Ø¨Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©' },\r\n  \r\n  // Integrations\r\n  'integrations.title': { en: 'Seamless Integrations', ar: 'ØªÙƒØ§Ù…Ù„Ø§Øª Ø³Ù„Ø³Ø©' },\r\n  'integrations.subtitle': { en: 'Connect with the tools you already use', ar: 'Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙŠ ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„' },\r\n  \r\n  // Pricing\r\n  'pricing.title': { en: 'Simple, Transparent Pricing', ar: 'Ø£Ø³Ø¹Ø§Ø± Ø¨Ø³ÙŠØ·Ø© ÙˆØ´ÙØ§ÙØ©' },\r\n  'pricing.subtitle': { en: 'Choose the plan that fits your business', ar: 'Ø§Ø®ØªØ± Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙŠ ØªÙ†Ø§Ø³Ø¨ Ø¹Ù…Ù„Ùƒ' },\r\n  'pricing.monthly': { en: 'Monthly', ar: 'Ø´Ù‡Ø±ÙŠ' },\r\n  'pricing.yearly': { en: 'Yearly', ar: 'Ø³Ù†ÙˆÙŠ' },\r\n  'pricing.save': { en: 'Save 20%', ar: 'ÙˆÙØ± 20%' },\r\n  'pricing.starter': { en: 'Starter', ar: 'Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©' },\r\n  'pricing.professional': { en: 'Professional', ar: 'Ø§Ø­ØªØ±Ø§ÙÙŠ' },\r\n  'pricing.enterprise': { en: 'Enterprise', ar: 'Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª' },\r\n  'pricing.perMonth': { en: '/month', ar: '/Ø´Ù‡Ø±' },\r\n  'pricing.perYear': { en: '/year', ar: '/Ø³Ù†Ø©' },\r\n  'pricing.getStarted': { en: 'Get Started', ar: 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†' },\r\n  'pricing.contactSales': { en: 'Contact Sales', ar: 'ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª' },\r\n  'pricing.popular': { en: 'Most Popular', ar: 'Ø§Ù„Ø£ÙƒØ«Ø± Ø´Ø¹Ø¨ÙŠØ©' },\r\n  \r\n  // FAQ\r\n  'faq.title': { en: 'Frequently Asked Questions', ar: 'Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©' },\r\n  'faq.subtitle': { en: 'Everything you need to know about OneLinker CRM', ar: 'ÙƒÙ„ Ù…Ø§ ØªØ­ØªØ§Ø¬ Ù…Ø¹Ø±ÙØªÙ‡ Ø¹Ù† OneLinker CRM' },\r\n  \r\n  // Testimonials\r\n  'testimonials.title': { en: 'Loved by Real Estate Professionals', ar: 'Ù…Ø­Ø¨ÙˆØ¨ Ù…Ù† Ù…Ø­ØªØ±ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª' },\r\n  'testimonials.subtitle': { en: 'See what our customers are saying', ar: 'Ø´Ø§Ù‡Ø¯ Ù…Ø§ ÙŠÙ‚ÙˆÙ„Ù‡ Ø¹Ù…Ù„Ø§Ø¤Ù†Ø§' },\r\n  \r\n  // Blog\r\n  'blog.title': { en: 'Latest Insights', ar: 'Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª' },\r\n  'blog.subtitle': { en: 'Tips, trends, and strategies for real estate success', ar: 'Ù†ØµØ§Ø¦Ø­ ÙˆØ§ØªØ¬Ø§Ù‡Ø§Øª ÙˆØ§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ù„Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ' },\r\n  'blog.readMore': { en: 'Read More', ar: 'Ø§Ù‚Ø±Ø£ Ø§Ù„Ù…Ø²ÙŠØ¯' },\r\n  \r\n  // Contact\r\n  'contact.title': { en: 'Get in Touch', ar: 'ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§' },\r\n  'contact.subtitle': { en: \"We'd love to hear from you\", ar: 'ÙŠØ³Ø¹Ø¯Ù†Ø§ Ø³Ù…Ø§Ø¹ Ø±Ø£ÙŠÙƒ' },\r\n  'contact.name': { en: 'Your Name', ar: 'Ø§Ø³Ù…Ùƒ' },\r\n  'contact.email': { en: 'Email Address', ar: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' },\r\n  'contact.phone': { en: 'Phone Number', ar: 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ' },\r\n  'contact.company': { en: 'Company Name', ar: 'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©' },\r\n  'contact.message': { en: 'Your Message', ar: 'Ø±Ø³Ø§Ù„ØªÙƒ' },\r\n  'contact.send': { en: 'Send Message', ar: 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©' },\r\n  \r\n  // Footer\r\n  'footer.product': { en: 'Product', ar: 'Ø§Ù„Ù…Ù†ØªØ¬' },\r\n  'footer.company': { en: 'Company', ar: 'Ø§Ù„Ø´Ø±ÙƒØ©' },\r\n  'footer.resources': { en: 'Resources', ar: 'Ø§Ù„Ù…ÙˆØ§Ø±Ø¯' },\r\n  'footer.legal': { en: 'Legal', ar: 'Ù‚Ø§Ù†ÙˆÙ†ÙŠ' },\r\n  'footer.about': { en: 'About Us', ar: 'Ù…Ù† Ù†Ø­Ù†' },\r\n  'footer.careers': { en: 'Careers', ar: 'Ø§Ù„ÙˆØ¸Ø§Ø¦Ù' },\r\n  'footer.press': { en: 'Press', ar: 'Ø§Ù„ØµØ­Ø§ÙØ©' },\r\n  'footer.privacy': { en: 'Privacy Policy', ar: 'Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©' },\r\n  'footer.terms': { en: 'Terms of Service', ar: 'Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø©' },\r\n  'footer.help': { en: 'Help Center', ar: 'Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©' },\r\n  'footer.docs': { en: 'Documentation', ar: 'Ø§Ù„ØªÙˆØ«ÙŠÙ‚' },\r\n  'footer.api': { en: 'API Reference', ar: 'Ù…Ø±Ø¬Ø¹ API' },\r\n  'footer.rights': { en: 'All rights reserved.', ar: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.' },\r\n  \r\n  // Auth\r\n  'auth.signin': { en: 'Sign In', ar: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' },\r\n  'auth.signup': { en: 'Create Account', ar: 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨' },\r\n  'auth.forgot': { en: 'Forgot Password?', ar: 'Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ' },\r\n  'auth.reset': { en: 'Reset Password', ar: 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' },\r\n  'auth.email': { en: 'Email', ar: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' },\r\n  'auth.password': { en: 'Password', ar: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' },\r\n  'auth.confirmPassword': { en: 'Confirm Password', ar: 'ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' },\r\n  'auth.google': { en: 'Continue with Google', ar: 'Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¹ Ø¬ÙˆØ¬Ù„' },\r\n  'auth.noAccount': { en: \"Don't have an account?\", ar: 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ' },\r\n  'auth.hasAccount': { en: 'Already have an account?', ar: 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ' },\r\n  'auth.backToLogin': { en: 'Back to Sign In', ar: 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' },\r\n};\r\n\r\nconst LanguageContext = createContext<LanguageContextType | undefined>(undefined);\r\n\r\nexport function LanguageProvider({ children }: { children: ReactNode }) {\r\n  const [language, setLanguage] = useState<Language>(() => {\r\n    const saved = localStorage.getItem('onelinker-lang');\r\n    return (saved as Language) || 'en';\r\n  });\r\n\r\n  const isRTL = language === 'ar';\r\n\r\n  useEffect(() => {\r\n    localStorage.setItem('onelinker-lang', language);\r\n    document.documentElement.dir = isRTL ? 'rtl' : 'ltr';\r\n    document.documentElement.lang = language;\r\n  }, [language, isRTL]);\r\n\r\n  const t = (key: string): string => {\r\n    return translations[key]?.[language] || key;\r\n  };\r\n\r\n  return (\r\n    <LanguageContext.Provider value={{ language, setLanguage, isRTL, t }}>\r\n      {children}\r\n    </LanguageContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useLanguage() {\r\n  const context = useContext(LanguageContext);\r\n  if (!context) {\r\n    throw new Error('useLanguage must be used within LanguageProvider');\r\n  }\r\n  return context;\r\n}\r\n\r\n// Safe hook that returns defaults when used outside LanguageProvider\r\nexport function useLanguageSafe() {\r\n  const context = useContext(LanguageContext);\r\n  if (!context) {\r\n    return {\r\n      language: 'en' as Language,\r\n      setLanguage: () => {},\r\n      isRTL: false,\r\n      t: (key: string) => key,\r\n    };\r\n  }\r\n  return context;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\contexts\\LocalizationContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":8,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":8,"endColumn":23},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":21,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":21,"endColumn":92},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":443,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":443,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21995,21998],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21995,21998],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":444,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":444,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22055,22058],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22055,22058],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":445,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":445,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22123,22126],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22123,22126],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":467,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":467,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22806,22809],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22806,22809],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":594,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":594,"endColumn":32}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createContext, useContext, useEffect, useState, ReactNode, useCallback } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useAuth } from './AuthContext';\r\n\r\ntype Language = 'en' | 'ar';\r\ntype Currency = 'AED' | 'QAR' | 'SAR' | 'KWD' | 'OMR' | 'BHD' | 'USD';\r\n\r\nexport const timezones = [\r\n  { value: 'Asia/Dubai', label: 'Dubai (GMT+4)', labelAr: 'Ø¯Ø¨ÙŠ' },\r\n  { value: 'Asia/Qatar', label: 'Doha (GMT+3)', labelAr: 'Ø§Ù„Ø¯ÙˆØ­Ø©' },\r\n  { value: 'Asia/Riyadh', label: 'Riyadh (GMT+3)', labelAr: 'Ø§Ù„Ø±ÙŠØ§Ø¶' },\r\n  { value: 'Asia/Kuwait', label: 'Kuwait (GMT+3)', labelAr: 'Ø§Ù„ÙƒÙˆÙŠØª' },\r\n  { value: 'Asia/Muscat', label: 'Muscat (GMT+4)', labelAr: 'Ù…Ø³Ù‚Ø·' },\r\n  { value: 'Asia/Bahrain', label: 'Manama (GMT+3)', labelAr: 'Ø§Ù„Ù…Ù†Ø§Ù…Ø©' },\r\n  { value: 'Europe/London', label: 'London (GMT+0)', labelAr: 'Ù„Ù†Ø¯Ù†' },\r\n  { value: 'America/New_York', label: 'New York (GMT-5)', labelAr: 'Ù†ÙŠÙˆÙŠÙˆØ±Ùƒ' },\r\n  { value: 'America/Los_Angeles', label: 'Los Angeles (GMT-8)', labelAr: 'Ù„ÙˆØ³ Ø£Ù†Ø¬Ù„ÙˆØ³' },\r\n  { value: 'UTC', label: 'UTC', labelAr: 'Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ' },\r\n];\r\n\r\nexport const currencies: { code: Currency; name: string; nameAr: string; symbol: string }[] = [\r\n  { code: 'AED', name: 'UAE Dirham', nameAr: 'Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ', symbol: 'Ø¯.Ø¥' },\r\n  { code: 'QAR', name: 'Qatar Riyal', nameAr: 'Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ', symbol: 'Ø±.Ù‚' },\r\n  { code: 'SAR', name: 'Saudi Riyal', nameAr: 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ', symbol: 'Ø±.Ø³' },\r\n  { code: 'KWD', name: 'Kuwait Dinar', nameAr: 'Ø¯ÙŠÙ†Ø§Ø± ÙƒÙˆÙŠØªÙŠ', symbol: 'Ø¯.Ùƒ' },\r\n  { code: 'OMR', name: 'Omani Rial', nameAr: 'Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ', symbol: 'Ø±.Ø¹' },\r\n  { code: 'BHD', name: 'Bahrain Dinar', nameAr: 'Ø¯ÙŠÙ†Ø§Ø± Ø¨Ø­Ø±ÙŠÙ†ÙŠ', symbol: 'Ø¯.Ø¨' },\r\n  { code: 'USD', name: 'US Dollar', nameAr: 'Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ', symbol: '$' },\r\n];\r\n\r\n// Translation dictionary\r\nconst translations: Record<string, Record<Language, string>> = {\r\n  // Common\r\n  'save': { en: 'Save', ar: 'Ø­ÙØ¸' },\r\n  'cancel': { en: 'Cancel', ar: 'Ø¥Ù„ØºØ§Ø¡' },\r\n  'loading': { en: 'Loading...', ar: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...' },\r\n  'search': { en: 'Search', ar: 'Ø¨Ø­Ø«' },\r\n  'filter': { en: 'Filter', ar: 'ØªØµÙÙŠØ©' },\r\n  'filters': { en: 'Filters', ar: 'Ø§Ù„ØªØµÙÙŠØ§Øª' },\r\n  'edit': { en: 'Edit', ar: 'ØªØ¹Ø¯ÙŠÙ„' },\r\n  'delete': { en: 'Delete', ar: 'Ø­Ø°Ù' },\r\n  'add': { en: 'Add', ar: 'Ø¥Ø¶Ø§ÙØ©' },\r\n  'view': { en: 'View', ar: 'Ø¹Ø±Ø¶' },\r\n  'close': { en: 'Close', ar: 'Ø¥ØºÙ„Ø§Ù‚' },\r\n  'confirm': { en: 'Confirm', ar: 'ØªØ£ÙƒÙŠØ¯' },\r\n  'back': { en: 'Back', ar: 'Ø±Ø¬ÙˆØ¹' },\r\n  'next': { en: 'Next', ar: 'Ø§Ù„ØªØ§Ù„ÙŠ' },\r\n  'submit': { en: 'Submit', ar: 'Ø¥Ø±Ø³Ø§Ù„' },\r\n  'success': { en: 'Success', ar: 'Ù†Ø¬Ø§Ø­' },\r\n  'error': { en: 'Error', ar: 'Ø®Ø·Ø£' },\r\n  'warning': { en: 'Warning', ar: 'ØªØ­Ø°ÙŠØ±' },\r\n  'info': { en: 'Info', ar: 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª' },\r\n  'all': { en: 'All', ar: 'Ø§Ù„ÙƒÙ„' },\r\n  'export': { en: 'Export', ar: 'ØªØµØ¯ÙŠØ±' },\r\n  'import': { en: 'Import', ar: 'Ø§Ø³ØªÙŠØ±Ø§Ø¯' },\r\n  'customize': { en: 'Customize', ar: 'ØªØ®ØµÙŠØµ' },\r\n  'refresh': { en: 'Refresh', ar: 'ØªØ­Ø¯ÙŠØ«' },\r\n  'manage': { en: 'Manage', ar: 'Ø¥Ø¯Ø§Ø±Ø©' },\r\n  'actions': { en: 'Actions', ar: 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª' },\r\n  'menu': { en: 'Menu', ar: 'Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©' },\r\n\r\n  // Navigation\r\n  'dashboard': { en: 'Dashboard', ar: 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…' },\r\n  'leads': { en: 'Leads', ar: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙŠÙ†' },\r\n  'listings': { en: 'Listings', ar: 'Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª' },\r\n  'my_listings': { en: 'My Listings', ar: 'Ø¹Ù‚Ø§Ø±Ø§ØªÙŠ' },\r\n  'marketing': { en: 'Marketing', ar: 'Ø§Ù„ØªØ³ÙˆÙŠÙ‚' },\r\n  'teams': { en: 'Teams', ar: 'Ø§Ù„ÙØ±Ù‚' },\r\n  'settings': { en: 'Settings', ar: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª' },\r\n  'pipeline': { en: 'Pipeline', ar: 'Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª' },\r\n  'integrations': { en: 'Integrations', ar: 'Ø§Ù„ØªÙƒØ§Ù…Ù„Ø§Øª' },\r\n  'notifications': { en: 'Notifications', ar: 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª' },\r\n  'profile': { en: 'Profile', ar: 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ' },\r\n  'logout': { en: 'Log Out', ar: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬' },\r\n\r\n  // Navigation Sections\r\n  'leads_management': { en: 'Leads Management', ar: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' },\r\n  'marketing_hub': { en: 'Marketing Hub', ar: 'Ù…Ø±ÙƒØ² Ø§Ù„ØªØ³ÙˆÙŠÙ‚' },\r\n  'admin': { en: 'Admin', ar: 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©' },\r\n\r\n  // Additional Navigation Items\r\n  'lead_sources': { en: 'Lead Sources', ar: 'Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' },\r\n  'lead_assignment': { en: 'Lead Assignment', ar: 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' },\r\n  'campaigns': { en: 'Campaigns', ar: 'Ø§Ù„Ø­Ù…Ù„Ø§Øª' },\r\n  'whatsapp_bot': { en: 'WhatsApp Bot', ar: 'Ø¨ÙˆØª ÙˆØ§ØªØ³Ø§Ø¨' },\r\n  'connections': { en: 'Connections', ar: 'Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª' },\r\n  'company_listings': { en: 'Company Listings', ar: 'Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©' },\r\n  'portal_settings': { en: 'Portal Settings', ar: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©' },\r\n  'roles_permissions': { en: 'Roles & Permissions', ar: 'Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª' },\r\n  'billing': { en: 'Billing', ar: 'Ø§Ù„ÙÙˆØ§ØªÙŠØ±' },\r\n\r\n  // Settings\r\n  'language': { en: 'Language', ar: 'Ø§Ù„Ù„ØºØ©' },\r\n  'timezone': { en: 'Timezone', ar: 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©' },\r\n  'currency': { en: 'Currency', ar: 'Ø§Ù„Ø¹Ù…Ù„Ø©' },\r\n  'company': { en: 'Company', ar: 'Ø§Ù„Ø´Ø±ÙƒØ©' },\r\n  'appearance': { en: 'Appearance', ar: 'Ø§Ù„Ù…Ø¸Ù‡Ø±' },\r\n  'security': { en: 'Security', ar: 'Ø§Ù„Ø£Ù…Ø§Ù†' },\r\n  'api_keys': { en: 'API Keys', ar: 'Ù…ÙØ§ØªÙŠØ­ API' },\r\n\r\n  // Leads\r\n  'new_lead': { en: 'New Lead', ar: 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯' },\r\n  'add_lead': { en: 'Add Lead', ar: 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„' },\r\n  'lead_name': { en: 'Lead Name', ar: 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„' },\r\n  'phone': { en: 'Phone', ar: 'Ø§Ù„Ù‡Ø§ØªÙ' },\r\n  'email': { en: 'Email', ar: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' },\r\n  'source': { en: 'Source', ar: 'Ø§Ù„Ù…ØµØ¯Ø±' },\r\n  'stage': { en: 'Stage', ar: 'Ø§Ù„Ù…Ø±Ø­Ù„Ø©' },\r\n  'assigned_agent': { en: 'Assigned Agent', ar: 'Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„' },\r\n  'budget': { en: 'Budget', ar: 'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©' },\r\n  'created': { en: 'Created', ar: 'ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡' },\r\n  'last_contacted': { en: 'Last Contacted', ar: 'Ø¢Ø®Ø± ØªÙˆØ§ØµÙ„' },\r\n  'manage_track_leads': { en: 'Manage and track all your leads', ar: 'Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØªØ¨Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙŠÙ†' },\r\n  'total_leads': { en: 'Total Leads', ar: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' },\r\n  'new_leads': { en: 'New Leads', ar: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯' },\r\n  'search_leads': { en: 'Search leads...', ar: 'Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…Ù„Ø§Ø¡...' },\r\n\r\n  // Listings\r\n  'property': { en: 'Property', ar: 'Ø§Ù„Ø¹Ù‚Ø§Ø±' },\r\n  'price': { en: 'Price', ar: 'Ø§Ù„Ø³Ø¹Ø±' },\r\n  'bedrooms': { en: 'Bedrooms', ar: 'ØºØ±Ù Ø§Ù„Ù†ÙˆÙ…' },\r\n  'bathrooms': { en: 'Bathrooms', ar: 'Ø§Ù„Ø­Ù…Ø§Ù…Ø§Øª' },\r\n  'area': { en: 'Area', ar: 'Ø§Ù„Ù…Ø³Ø§Ø­Ø©' },\r\n  'location': { en: 'Location', ar: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹' },\r\n  'status': { en: 'Status', ar: 'Ø§Ù„Ø­Ø§Ù„Ø©' },\r\n  'published': { en: 'Published', ar: 'Ù…Ù†Ø´ÙˆØ±' },\r\n  'draft': { en: 'Draft', ar: 'Ù…Ø³ÙˆØ¯Ø©' },\r\n  'active': { en: 'Active', ar: 'Ù†Ø´Ø·' },\r\n  'pending': { en: 'Pending', ar: 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' },\r\n  'sold': { en: 'Sold', ar: 'Ù…Ø¨Ø§Ø¹' },\r\n  'rented': { en: 'Rented', ar: 'Ù…Ø¤Ø¬Ø±' },\r\n  'add_listing': { en: 'Add Listing', ar: 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø±' },\r\n  'manage_property_listings': { en: 'Manage your property listings', ar: 'Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù‚Ø§Ø±Ø§ØªÙƒ' },\r\n  'total_listings': { en: 'Total Listings', ar: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª' },\r\n  'total_views': { en: 'Total Views', ar: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª' },\r\n  'inquiries': { en: 'Inquiries', ar: 'Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª' },\r\n  'search_listings': { en: 'Search listings...', ar: 'Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù‚Ø§Ø±Ø§Øª...' },\r\n  'property_type': { en: 'Property Type', ar: 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±' },\r\n  'all_types': { en: 'All Types', ar: 'ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹' },\r\n  'all_status': { en: 'All Status', ar: 'ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª' },\r\n  'apartment': { en: 'Apartment', ar: 'Ø´Ù‚Ø©' },\r\n  'villa': { en: 'Villa', ar: 'ÙÙŠÙ„Ø§' },\r\n  'townhouse': { en: 'Townhouse', ar: 'ØªØ§ÙˆÙ† Ù‡Ø§ÙˆØ³' },\r\n  'penthouse': { en: 'Penthouse', ar: 'Ø¨Ù†ØªÙ‡Ø§ÙˆØ³' },\r\n  'studio': { en: 'Studio', ar: 'Ø§Ø³ØªÙˆØ¯ÙŠÙˆ' },\r\n\r\n  // Marketing\r\n  'campaign': { en: 'Campaign', ar: 'Ø§Ù„Ø­Ù…Ù„Ø©' },\r\n  'create_campaign': { en: 'Create Campaign', ar: 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø©' },\r\n  'send_now': { en: 'Send Now', ar: 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†' },\r\n  'schedule': { en: 'Schedule', ar: 'Ø¬Ø¯ÙˆÙ„Ø©' },\r\n\r\n  // Teams\r\n  'team': { en: 'Team', ar: 'Ø§Ù„ÙØ±ÙŠÙ‚' },\r\n  'agent': { en: 'Agent', ar: 'Ø§Ù„ÙˆÙƒÙŠÙ„' },\r\n  'agents': { en: 'Agents', ar: 'Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡' },\r\n  'role': { en: 'Role', ar: 'Ø§Ù„Ø¯ÙˆØ±' },\r\n  'admin_role': { en: 'Admin', ar: 'Ù…Ø¯ÙŠØ±' },\r\n  'manager': { en: 'Manager', ar: 'Ù…Ø¯ÙŠØ± ÙØ±ÙŠÙ‚' },\r\n  'team_leader': { en: 'Team Leader', ar: 'Ù‚Ø§Ø¦Ø¯ ÙØ±ÙŠÙ‚' },\r\n\r\n  // Chatbot / Messages\r\n  'message': { en: 'Message', ar: 'Ø±Ø³Ø§Ù„Ø©' },\r\n  'messages': { en: 'Messages', ar: 'Ø§Ù„Ø±Ø³Ø§Ø¦Ù„' },\r\n  'send': { en: 'Send', ar: 'Ø¥Ø±Ø³Ø§Ù„' },\r\n  'type_message': { en: 'Type a message...', ar: 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...' },\r\n  'inbox': { en: 'Inbox', ar: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„ÙˆØ§Ø±Ø¯' },\r\n\r\n  // Time\r\n  'today': { en: 'Today', ar: 'Ø§Ù„ÙŠÙˆÙ…' },\r\n  'yesterday': { en: 'Yesterday', ar: 'Ø£Ù…Ø³' },\r\n  'this_week': { en: 'This Week', ar: 'Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹' },\r\n  'last_week': { en: 'Last Week', ar: 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¶ÙŠ' },\r\n  'this_month': { en: 'This Month', ar: 'Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±' },\r\n  'last_month': { en: 'Last Month', ar: 'Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ' },\r\n\r\n  // Dashboard specific\r\n  'good_morning': { en: 'Good morning', ar: 'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±' },\r\n  'good_afternoon': { en: 'Good afternoon', ar: 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±' },\r\n  'good_evening': { en: 'Good evening', ar: 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±' },\r\n  'crm_overview': { en: \"Here's your CRM overview for today.\", ar: 'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ù†Ø¸Ø§Ù…Ùƒ Ø§Ù„ÙŠÙˆÙ….' },\r\n  'key_metrics': { en: 'Key Metrics', ar: 'Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' },\r\n  'conversion_rate': { en: 'Conversion Rate', ar: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„' },\r\n  'active_listings': { en: 'Active Listings', ar: 'Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©' },\r\n  'meetings_today': { en: 'Meetings Today', ar: 'Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…' },\r\n  'follow_ups_due': { en: 'Follow Ups Due', ar: 'Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©' },\r\n  'calls_made': { en: 'Calls Made', ar: 'Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©' },\r\n  'revenue_mtd': { en: 'Revenue (MTD)', ar: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ)' },\r\n  'hot_leads': { en: 'Hot Leads', ar: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ†' },\r\n  'avg_response_time': { en: 'Avg Response Time', ar: 'Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©' },\r\n  'leads_trend': { en: 'Leads Trend', ar: 'Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' },\r\n  'leads_by_stage': { en: 'Leads by Stage', ar: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø©' },\r\n  'leads_by_source': { en: 'Leads by Source', ar: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ¯Ø±' },\r\n  'agent_performance': { en: 'Agent Performance', ar: 'Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡' },\r\n  'recent_activities': { en: 'Recent Activities', ar: 'Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©' },\r\n  'upcoming': { en: 'upcoming', ar: 'Ù‚Ø§Ø¯Ù…Ø©' },\r\n  'overdue': { en: 'overdue', ar: 'Ù…ØªØ£Ø®Ø±Ø©' },\r\n  'improved': { en: 'improved', ar: 'ØªØ­Ø³Ù†' },\r\n  'ready_to_close': { en: 'Ready to close', ar: 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥ØºÙ„Ø§Ù‚' },\r\n  'from_last_month': { en: 'from last month', ar: 'Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ' },\r\n  'from_last_week': { en: 'from last week', ar: 'Ù…Ù† Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¶ÙŠ' },\r\n  'vs_goal': { en: 'vs goal', ar: 'Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ù‡Ø¯Ù' },\r\n  'closed': { en: 'Closed', ar: 'Ù…ØºÙ„Ù‚' },\r\n  'lost': { en: 'Lost', ar: 'Ø®Ø³Ø§Ø±Ø©' },\r\n  'contacted': { en: 'Contacted', ar: 'ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„' },\r\n  'follow_up': { en: 'Follow Up', ar: 'Ù…ØªØ§Ø¨Ø¹Ø©' },\r\n  'meeting': { en: 'Meeting', ar: 'Ø§Ø¬ØªÙ…Ø§Ø¹' },\r\n  'new': { en: 'New', ar: 'Ø¬Ø¯ÙŠØ¯' },\r\n\r\n  // Settings specific\r\n  'save_changes': { en: 'Save Changes', ar: 'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª' },\r\n  'settings_saved': { en: 'Settings saved successfully', ar: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­' },\r\n  'select_language': { en: 'Select Language', ar: 'Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©' },\r\n  'select_timezone': { en: 'Select Timezone', ar: 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©' },\r\n  'select_currency': { en: 'Select Currency', ar: 'Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„Ø©' },\r\n  'localization': { en: 'Localization', ar: 'Ø§Ù„ØªÙˆØ·ÙŠÙ†' },\r\n  'localization_desc': { en: 'Manage your language, timezone, and currency preferences', ar: 'Ø¥Ø¯Ø§Ø±Ø© ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© ÙˆØ§Ù„Ø¹Ù…Ù„Ø©' },\r\n  'preview_changes': { en: 'Preview Changes', ar: 'Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª' },\r\n  'current_time': { en: 'Current Time', ar: 'Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ' },\r\n  'sample_price': { en: 'Sample Price', ar: 'Ø³Ø¹Ø± Ù†Ù…ÙˆØ°Ø¬ÙŠ' },\r\n\r\n  // Common UI Elements\r\n  'name': { en: 'Name', ar: 'Ø§Ù„Ø§Ø³Ù…' },\r\n  'description': { en: 'Description', ar: 'Ø§Ù„ÙˆØµÙ' },\r\n  'title': { en: 'Title', ar: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†' },\r\n  'details': { en: 'Details', ar: 'Ø§Ù„ØªÙØ§ØµÙŠÙ„' },\r\n  'notes': { en: 'Notes', ar: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª' },\r\n  'comments': { en: 'Comments', ar: 'Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª' },\r\n  'date': { en: 'Date', ar: 'Ø§Ù„ØªØ§Ø±ÙŠØ®' },\r\n  'time': { en: 'Time', ar: 'Ø§Ù„ÙˆÙ‚Øª' },\r\n  'created_at': { en: 'Created At', ar: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡' },\r\n  'updated_at': { en: 'Updated At', ar: 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«' },\r\n  'created_by': { en: 'Created By', ar: 'Ø£Ù†Ø´Ø¦ Ø¨ÙˆØ§Ø³Ø·Ø©' },\r\n  'updated_by': { en: 'Updated By', ar: 'Ø­Ø¯Ø« Ø¨ÙˆØ§Ø³Ø·Ø©' },\r\n  'owner': { en: 'Owner', ar: 'Ø§Ù„Ù…Ø§Ù„Ùƒ' },\r\n  'assigned_to': { en: 'Assigned To', ar: 'Ù…Ø³Ù†Ø¯ Ø¥Ù„Ù‰' },\r\n  'priority': { en: 'Priority', ar: 'Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©' },\r\n  'high': { en: 'High', ar: 'Ø¹Ø§Ù„ÙŠØ©' },\r\n  'medium': { en: 'Medium', ar: 'Ù…ØªÙˆØ³Ø·Ø©' },\r\n  'low': { en: 'Low', ar: 'Ù…Ù†Ø®ÙØ¶Ø©' },\r\n  'urgent': { en: 'Urgent', ar: 'Ø¹Ø§Ø¬Ù„' },\r\n  'normal': { en: 'Normal', ar: 'Ø¹Ø§Ø¯ÙŠ' },\r\n\r\n  // Actions & Buttons\r\n  'create': { en: 'Create', ar: 'Ø¥Ù†Ø´Ø§Ø¡' },\r\n  'update': { en: 'Update', ar: 'ØªØ­Ø¯ÙŠØ«' },\r\n  'remove': { en: 'Remove', ar: 'Ø¥Ø²Ø§Ù„Ø©' },\r\n  'duplicate': { en: 'Duplicate', ar: 'Ù†Ø³Ø®' },\r\n  'archive': { en: 'Archive', ar: 'Ø£Ø±Ø´ÙØ©' },\r\n  'restore': { en: 'Restore', ar: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø©' },\r\n  'download': { en: 'Download', ar: 'ØªØ­Ù…ÙŠÙ„' },\r\n  'upload': { en: 'Upload', ar: 'Ø±ÙØ¹' },\r\n  'print': { en: 'Print', ar: 'Ø·Ø¨Ø§Ø¹Ø©' },\r\n  'share': { en: 'Share', ar: 'Ù…Ø´Ø§Ø±ÙƒØ©' },\r\n  'copy': { en: 'Copy', ar: 'Ù†Ø³Ø®' },\r\n  'paste': { en: 'Paste', ar: 'Ù„ØµÙ‚' },\r\n  'cut': { en: 'Cut', ar: 'Ù‚Øµ' },\r\n  'undo': { en: 'Undo', ar: 'ØªØ±Ø§Ø¬Ø¹' },\r\n  'redo': { en: 'Redo', ar: 'Ø¥Ø¹Ø§Ø¯Ø©' },\r\n  'select_all': { en: 'Select All', ar: 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„' },\r\n  'deselect_all': { en: 'Deselect All', ar: 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯' },\r\n  'clear': { en: 'Clear', ar: 'Ù…Ø³Ø­' },\r\n  'reset': { en: 'Reset', ar: 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†' },\r\n  'apply': { en: 'Apply', ar: 'ØªØ·Ø¨ÙŠÙ‚' },\r\n  'done': { en: 'Done', ar: 'ØªÙ…' },\r\n  'finish': { en: 'Finish', ar: 'Ø¥Ù†Ù‡Ø§Ø¡' },\r\n  'continue': { en: 'Continue', ar: 'Ù…ØªØ§Ø¨Ø¹Ø©' },\r\n  'skip': { en: 'Skip', ar: 'ØªØ®Ø·ÙŠ' },\r\n  'previous': { en: 'Previous', ar: 'Ø§Ù„Ø³Ø§Ø¨Ù‚' },\r\n  'more': { en: 'More', ar: 'Ø§Ù„Ù…Ø²ÙŠØ¯' },\r\n  'less': { en: 'Less', ar: 'Ø£Ù‚Ù„' },\r\n  'show_more': { en: 'Show More', ar: 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯' },\r\n  'show_less': { en: 'Show Less', ar: 'Ø¹Ø±Ø¶ Ø£Ù‚Ù„' },\r\n  'expand': { en: 'Expand', ar: 'ØªÙˆØ³ÙŠØ¹' },\r\n  'collapse': { en: 'Collapse', ar: 'Ø·ÙŠ' },\r\n  'open': { en: 'Open', ar: 'ÙØªØ­' },\r\n\r\n  // Status & States\r\n  'enabled': { en: 'Enabled', ar: 'Ù…ÙØ¹Ù„' },\r\n  'disabled': { en: 'Disabled', ar: 'Ù…Ø¹Ø·Ù„' },\r\n  'available': { en: 'Available', ar: 'Ù…ØªØ§Ø­' },\r\n  'unavailable': { en: 'Unavailable', ar: 'ØºÙŠØ± Ù…ØªØ§Ø­' },\r\n  'online': { en: 'Online', ar: 'Ù…ØªØµÙ„' },\r\n  'offline': { en: 'Offline', ar: 'ØºÙŠØ± Ù…ØªØµÙ„' },\r\n  'completed': { en: 'Completed', ar: 'Ù…ÙƒØªÙ…Ù„' },\r\n  'incomplete': { en: 'Incomplete', ar: 'ØºÙŠØ± Ù…ÙƒØªÙ…Ù„' },\r\n  'in_progress': { en: 'In Progress', ar: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' },\r\n  'on_hold': { en: 'On Hold', ar: 'Ù…Ø¹Ù„Ù‚' },\r\n  'cancelled': { en: 'Cancelled', ar: 'Ù…Ù„ØºÙŠ' },\r\n  'approved': { en: 'Approved', ar: 'Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡' },\r\n  'rejected': { en: 'Rejected', ar: 'Ù…Ø±ÙÙˆØ¶' },\r\n  'verified': { en: 'Verified', ar: 'Ù…ÙˆØ«Ù‚' },\r\n  'unverified': { en: 'Unverified', ar: 'ØºÙŠØ± Ù…ÙˆØ«Ù‚' },\r\n\r\n  // Messages & Notifications\r\n  'success_message': { en: 'Operation completed successfully', ar: 'ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­' },\r\n  'error_message': { en: 'An error occurred', ar: 'Ø­Ø¯Ø« Ø®Ø·Ø£' },\r\n  'warning_message': { en: 'Please review before proceeding', ar: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©' },\r\n  'info_message': { en: 'Information', ar: 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª' },\r\n  'no_data': { en: 'No data available', ar: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª' },\r\n  'no_results': { en: 'No results found', ar: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬' },\r\n  'loading_data': { en: 'Loading data...', ar: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...' },\r\n  'saving_data': { en: 'Saving...', ar: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...' },\r\n  'deleting_data': { en: 'Deleting...', ar: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...' },\r\n  'processing': { en: 'Processing...', ar: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...' },\r\n  'please_wait': { en: 'Please wait', ar: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' },\r\n  'are_you_sure': { en: 'Are you sure?', ar: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ' },\r\n  'cannot_be_undone': { en: 'This action cannot be undone', ar: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡' },\r\n  'confirm_delete': { en: 'Are you sure you want to delete this?', ar: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ØŸ' },\r\n  'confirm_action': { en: 'Please confirm this action', ar: 'ÙŠØ±Ø¬Ù‰ ØªØ£ÙƒÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡' },\r\n  'required_field': { en: 'This field is required', ar: 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ù…Ø·Ù„ÙˆØ¨' },\r\n  'invalid_input': { en: 'Invalid input', ar: 'Ø¥Ø¯Ø®Ø§Ù„ ØºÙŠØ± ØµØ­ÙŠØ­' },\r\n  'changes_saved': { en: 'Changes saved successfully', ar: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­' },\r\n  'changes_discarded': { en: 'Changes discarded', ar: 'ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª' },\r\n\r\n  // Forms & Inputs\r\n  'enter': { en: 'Enter', ar: 'Ø£Ø¯Ø®Ù„' },\r\n  'select': { en: 'Select', ar: 'Ø§Ø®ØªØ±' },\r\n  'choose': { en: 'Choose', ar: 'Ø§Ø®ØªØ±' },\r\n  'pick': { en: 'Pick', ar: 'Ø§Ù†ØªÙ‚ÙŠ' },\r\n  'browse': { en: 'Browse', ar: 'ØªØµÙØ­' },\r\n  'search_for': { en: 'Search for', ar: 'Ø§Ø¨Ø­Ø« Ø¹Ù†' },\r\n  'type_here': { en: 'Type here...', ar: 'Ø§ÙƒØªØ¨ Ù‡Ù†Ø§...' },\r\n  'enter_text': { en: 'Enter text', ar: 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ' },\r\n  'select_option': { en: 'Select an option', ar: 'Ø§Ø®ØªØ± Ø®ÙŠØ§Ø±Ø§Ù‹' },\r\n  'choose_file': { en: 'Choose file', ar: 'Ø§Ø®ØªØ± Ù…Ù„Ù' },\r\n  'drop_files': { en: 'Drop files here', ar: 'Ø£Ø³Ù‚Ø· Ø§Ù„Ù…Ù„ÙØ§Øª Ù‡Ù†Ø§' },\r\n  'or': { en: 'or', ar: 'Ø£Ùˆ' },\r\n  'and': { en: 'and', ar: 'Ùˆ' },\r\n  'optional': { en: 'Optional', ar: 'Ø§Ø®ØªÙŠØ§Ø±ÙŠ' },\r\n  'required': { en: 'Required', ar: 'Ù…Ø·Ù„ÙˆØ¨' },\r\n\r\n  // Pagination & Lists\r\n  'page': { en: 'Page', ar: 'ØµÙØ­Ø©' },\r\n  'of': { en: 'of', ar: 'Ù…Ù†' },\r\n  'items': { en: 'items', ar: 'Ø¹Ù†Ø§ØµØ±' },\r\n  'per_page': { en: 'per page', ar: 'Ù„ÙƒÙ„ ØµÙØ­Ø©' },\r\n  'showing': { en: 'Showing', ar: 'Ø¹Ø±Ø¶' },\r\n  'to': { en: 'to', ar: 'Ø¥Ù„Ù‰' },\r\n  'first': { en: 'First', ar: 'Ø§Ù„Ø£ÙˆÙ„' },\r\n  'last': { en: 'Last', ar: 'Ø§Ù„Ø£Ø®ÙŠØ±' },\r\n  'go_to_page': { en: 'Go to page', ar: 'Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©' },\r\n  'rows_per_page': { en: 'Rows per page', ar: 'ØµÙÙˆÙ Ù„ÙƒÙ„ ØµÙØ­Ø©' },\r\n\r\n  // Tables\r\n  'columns': { en: 'Columns', ar: 'Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©' },\r\n  'rows': { en: 'Rows', ar: 'Ø§Ù„ØµÙÙˆÙ' },\r\n  'sort_by': { en: 'Sort by', ar: 'ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨' },\r\n  'sort_ascending': { en: 'Sort Ascending', ar: 'ØªØ±ØªÙŠØ¨ ØªØµØ§Ø¹Ø¯ÙŠ' },\r\n  'sort_descending': { en: 'Sort Descending', ar: 'ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ' },\r\n  'group_by': { en: 'Group by', ar: 'ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨' },\r\n  'filter_by': { en: 'Filter by', ar: 'ØªØµÙÙŠØ© Ø­Ø³Ø¨' },\r\n  'show_columns': { en: 'Show Columns', ar: 'Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©' },\r\n  'hide_columns': { en: 'Hide Columns', ar: 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©' },\r\n\r\n  // Settings Page Specific\r\n  'account': { en: 'Account', ar: 'Ø§Ù„Ø­Ø³Ø§Ø¨' },\r\n  'personal_information': { en: 'Personal Information', ar: 'Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©' },\r\n  'company_details': { en: 'Company Details', ar: 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ©' },\r\n  'notification_preferences': { en: 'Notification Preferences', ar: 'ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª' },\r\n  'theme_preferences': { en: 'Theme Preferences', ar: 'ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø±' },\r\n  'change_password': { en: 'Change Password', ar: 'ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' },\r\n  'danger_zone': { en: 'Danger Zone', ar: 'Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±' },\r\n  'delete_account': { en: 'Delete Account', ar: 'Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨' },\r\n  'api_access': { en: 'API Access', ar: 'Ø§Ù„ÙˆØµÙˆÙ„ Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©' },\r\n  'full_name': { en: 'Full Name', ar: 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„' },\r\n  'email_address': { en: 'Email Address', ar: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' },\r\n  'phone_number': { en: 'Phone Number', ar: 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ' },\r\n  'profile_picture': { en: 'Profile Picture', ar: 'ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ' },\r\n  'change_picture': { en: 'Change Picture', ar: 'ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©' },\r\n  'company_name': { en: 'Company Name', ar: 'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©' },\r\n  'website': { en: 'Website', ar: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' },\r\n  'email_notifications': { en: 'Email Notifications', ar: 'Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' },\r\n  'push_notifications': { en: 'Push Notifications', ar: 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©' },\r\n  'new_lead_alerts': { en: 'New Lead Alerts', ar: 'ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯' },\r\n  'weekly_reports': { en: 'Weekly Reports', ar: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©' },\r\n  'color_theme': { en: 'Color Theme', ar: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù„ÙˆØ§Ù†' },\r\n  'light': { en: 'Light', ar: 'ÙØ§ØªØ­' },\r\n  'dark': { en: 'Dark', ar: 'Ø¯Ø§ÙƒÙ†' },\r\n  'system': { en: 'System', ar: 'Ø§Ù„Ù†Ø¸Ø§Ù…' },\r\n  'current_password': { en: 'Current Password', ar: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©' },\r\n  'new_password': { en: 'New Password', ar: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©' },\r\n  'confirm_password': { en: 'Confirm Password', ar: 'ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' },\r\n  'update_password': { en: 'Update Password', ar: 'ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' },\r\n  'api_key': { en: 'API Key', ar: 'Ù…ÙØªØ§Ø­ API' },\r\n  'regenerate': { en: 'Regenerate', ar: 'Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡' },\r\n  'api_documentation': { en: 'API Documentation', ar: 'ÙˆØ«Ø§Ø¦Ù‚ API' },\r\n  'view_documentation': { en: 'View Documentation', ar: 'Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚' },\r\n\r\n  // Additional Common Terms\r\n  'yes': { en: 'Yes', ar: 'Ù†Ø¹Ù…' },\r\n  'no': { en: 'No', ar: 'Ù„Ø§' },\r\n  'ok': { en: 'OK', ar: 'Ù…ÙˆØ§ÙÙ‚' },\r\n  'got_it': { en: 'Got it', ar: 'ÙÙ‡Ù…Øª' },\r\n  'dismiss': { en: 'Dismiss', ar: 'ØªØ¬Ø§Ù‡Ù„' },\r\n  'learn_more': { en: 'Learn More', ar: 'Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯' },\r\n  'help': { en: 'Help', ar: 'Ù…Ø³Ø§Ø¹Ø¯Ø©' },\r\n  'support': { en: 'Support', ar: 'Ø§Ù„Ø¯Ø¹Ù…' },\r\n  'documentation': { en: 'Documentation', ar: 'Ø§Ù„ØªÙˆØ«ÙŠÙ‚' },\r\n  'feedback': { en: 'Feedback', ar: 'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª' },\r\n  'report_issue': { en: 'Report Issue', ar: 'Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©' },\r\n  'version': { en: 'Version', ar: 'Ø§Ù„Ø¥ØµØ¯Ø§Ø±' },\r\n  'powered_by': { en: 'Powered by', ar: 'Ù…Ø¯Ø¹ÙˆÙ… Ù…Ù†' },\r\n  'all_rights_reserved': { en: 'All rights reserved', ar: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©' },\r\n\r\n};\r\n\r\ntype LocalizationContextType = {\r\n  language: Language;\r\n  timezone: string;\r\n  currency: Currency;\r\n  isRTL: boolean;\r\n  isLoading: boolean;\r\n  isSaving: boolean;\r\n  setLanguage: (lang: Language) => Promise<void>;\r\n  setTimezone: (tz: string) => Promise<void>;\r\n  setCurrency: (curr: Currency) => Promise<void>;\r\n  t: (key: string) => string;\r\n  formatDate: (date: Date | string, options?: Intl.DateTimeFormatOptions) => string;\r\n  formatTime: (date: Date | string) => string;\r\n  formatDateTime: (date: Date | string) => string;\r\n  formatRelativeTime: (date: Date | string) => string;\r\n  formatCurrency: (amount: number, currencyOverride?: Currency) => string;\r\n  formatNumber: (num: number) => string;\r\n  getCurrencySymbol: (currencyCode?: Currency) => string;\r\n};\r\n\r\nconst LocalizationContext = createContext<LocalizationContextType | undefined>(undefined);\r\n\r\nexport function LocalizationProvider({ children }: { children: ReactNode }) {\r\n  const { user, profile } = useAuth();\r\n  const [language, setLanguageState] = useState<Language>('en');\r\n  const [timezone, setTimezoneState] = useState('Asia/Dubai');\r\n  const [currency, setCurrencyState] = useState<Currency>('AED');\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isSaving, setIsSaving] = useState(false);\r\n\r\n  const isRTL = language === 'ar';\r\n\r\n  // Load user preferences\r\n  useEffect(() => {\r\n    if (profile) {\r\n      setLanguageState((profile as any).language || 'en');\r\n      setTimezoneState((profile as any).timezone || 'Asia/Dubai');\r\n      setCurrencyState((profile as any).currency || 'AED');\r\n    }\r\n    setIsLoading(false);\r\n  }, [profile]);\r\n\r\n  // Auto-detect timezone on first load\r\n  useEffect(() => {\r\n    if (!profile && !user) {\r\n      const detectedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;\r\n      const matchedTz = timezones.find(tz => tz.value === detectedTimezone);\r\n      if (matchedTz) {\r\n        setTimezoneState(matchedTz.value);\r\n      }\r\n    }\r\n  }, [profile, user]);\r\n\r\n  // Update document direction\r\n  useEffect(() => {\r\n    document.documentElement.dir = isRTL ? 'rtl' : 'ltr';\r\n    document.documentElement.lang = language;\r\n  }, [isRTL, language]);\r\n\r\n  const updateProfile = async (updates: Record<string, any>) => {\r\n    if (!user) return;\r\n    setIsSaving(true);\r\n    try {\r\n      const { error } = await supabase\r\n        .from('profiles')\r\n        .update(updates)\r\n        .eq('id', user.id);\r\n      if (error) throw error;\r\n    } catch (error) {\r\n      console.error('Failed to update preferences:', error);\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const setLanguage = async (lang: Language) => {\r\n    setLanguageState(lang);\r\n    await updateProfile({ language: lang });\r\n  };\r\n\r\n  const setTimezone = async (tz: string) => {\r\n    setTimezoneState(tz);\r\n    await updateProfile({ timezone: tz });\r\n  };\r\n\r\n  const setCurrency = async (curr: Currency) => {\r\n    setCurrencyState(curr);\r\n    await updateProfile({ currency: curr });\r\n  };\r\n\r\n  const t = useCallback((key: string): string => {\r\n    const translation = translations[key];\r\n    if (!translation) return key;\r\n    return translation[language] || translation['en'] || key;\r\n  }, [language]);\r\n\r\n  const formatDate = useCallback((date: Date | string, options?: Intl.DateTimeFormatOptions): string => {\r\n    const d = typeof date === 'string' ? new Date(date) : date;\r\n    return new Intl.DateTimeFormat(language === 'ar' ? 'ar-AE' : 'en-AE', {\r\n      timeZone: timezone,\r\n      dateStyle: 'medium',\r\n      ...options,\r\n    }).format(d);\r\n  }, [language, timezone]);\r\n\r\n  const formatTime = useCallback((date: Date | string): string => {\r\n    const d = typeof date === 'string' ? new Date(date) : date;\r\n    return new Intl.DateTimeFormat(language === 'ar' ? 'ar-AE' : 'en-AE', {\r\n      timeZone: timezone,\r\n      timeStyle: 'short',\r\n    }).format(d);\r\n  }, [language, timezone]);\r\n\r\n  const formatDateTime = useCallback((date: Date | string): string => {\r\n    const d = typeof date === 'string' ? new Date(date) : date;\r\n    return new Intl.DateTimeFormat(language === 'ar' ? 'ar-AE' : 'en-AE', {\r\n      timeZone: timezone,\r\n      dateStyle: 'medium',\r\n      timeStyle: 'short',\r\n    }).format(d);\r\n  }, [language, timezone]);\r\n\r\n  const formatRelativeTime = useCallback((date: Date | string): string => {\r\n    const d = typeof date === 'string' ? new Date(date) : date;\r\n    const now = new Date();\r\n    const diffMs = now.getTime() - d.getTime();\r\n    const diffMins = Math.floor(diffMs / 60000);\r\n    const diffHours = Math.floor(diffMs / 3600000);\r\n    const diffDays = Math.floor(diffMs / 86400000);\r\n\r\n    if (diffMins < 1) return language === 'ar' ? 'Ø§Ù„Ø¢Ù†' : 'Just now';\r\n    if (diffMins < 60) return language === 'ar' ? `Ù…Ù†Ø° ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©` : `${diffMins}m ago`;\r\n    if (diffHours < 24) return language === 'ar' ? `Ù…Ù†Ø° ${diffHours} Ø³Ø§Ø¹Ø©` : `${diffHours}h ago`;\r\n    if (diffDays < 7) return language === 'ar' ? `Ù…Ù†Ø° ${diffDays} ÙŠÙˆÙ…` : `${diffDays}d ago`;\r\n    return formatDate(d);\r\n  }, [language, formatDate]);\r\n\r\n  const formatCurrency = useCallback((amount: number, currencyOverride?: Currency): string => {\r\n    const curr = currencyOverride || currency;\r\n    const locale = language === 'ar' ? 'ar-AE' : 'en-AE';\r\n\r\n    return new Intl.NumberFormat(locale, {\r\n      style: 'currency',\r\n      currency: curr,\r\n      minimumFractionDigits: 0,\r\n      maximumFractionDigits: 0,\r\n    }).format(amount);\r\n  }, [currency, language]);\r\n\r\n  const formatNumber = useCallback((num: number): string => {\r\n    const locale = language === 'ar' ? 'ar-AE' : 'en-AE';\r\n    return new Intl.NumberFormat(locale).format(num);\r\n  }, [language]);\r\n\r\n  const getCurrencySymbol = useCallback((currencyCode?: Currency): string => {\r\n    const curr = currencies.find(c => c.code === (currencyCode || currency));\r\n    return curr?.symbol || currency;\r\n  }, [currency]);\r\n\r\n  return (\r\n    <LocalizationContext.Provider\r\n      value={{\r\n        language,\r\n        timezone,\r\n        currency,\r\n        isRTL,\r\n        isLoading,\r\n        isSaving,\r\n        setLanguage,\r\n        setTimezone,\r\n        setCurrency,\r\n        t,\r\n        formatDate,\r\n        formatTime,\r\n        formatDateTime,\r\n        formatRelativeTime,\r\n        formatCurrency,\r\n        formatNumber,\r\n        getCurrencySymbol,\r\n      }}\r\n    >\r\n      {children}\r\n    </LocalizationContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useLocalization() {\r\n  const context = useContext(LocalizationContext);\r\n  if (!context) {\r\n    throw new Error('useLocalization must be used within a LocalizationProvider');\r\n  }\r\n  return context;\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\contexts\\OrganizationContext.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":117,"column":77,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":117,"endColumn":80,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3302,3305],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3302,3305],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":318,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":318,"endColumn":32}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useAuth } from './AuthContext';\r\nimport type { Json } from '@/integrations/supabase/types';\r\n\r\n// Types\r\nexport type OrgRole = 'owner' | 'admin' | 'member' | 'viewer';\r\n\r\nexport interface Organization {\r\n  id: string;\r\n  name: string;\r\n  slug: string;\r\n  logo_url: string | null;\r\n  website: string | null;\r\n  industry: string | null;\r\n  size: string | null;\r\n  settings: Json;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface OrganizationMembership {\r\n  id: string;\r\n  organization_id: string;\r\n  user_id: string;\r\n  role: OrgRole;\r\n  is_active: boolean;\r\n  joined_at: string;\r\n  organization: Organization;\r\n}\r\n\r\ninterface OrganizationContextType {\r\n  // Current organization\r\n  currentOrg: Organization | null;\r\n  currentRole: OrgRole | null;\r\n  \r\n  // All user's organizations\r\n  organizations: OrganizationMembership[];\r\n  \r\n  // Loading states\r\n  isLoading: boolean;\r\n  isLoadingOrgs: boolean;\r\n  \r\n  // Actions\r\n  setCurrentOrg: (org: Organization | null) => void;\r\n  switchOrganization: (orgId: string) => Promise<void>;\r\n  createOrganization: (data: CreateOrgData) => Promise<Organization>;\r\n  updateOrganization: (orgId: string, data: Partial<Organization>) => Promise<void>;\r\n  refreshOrganizations: () => Promise<void>;\r\n  \r\n  // Permission helpers\r\n  isOwner: boolean;\r\n  isAdmin: boolean;\r\n  canManageMembers: boolean;\r\n  canManageSettings: boolean;\r\n  canEdit: boolean;\r\n}\r\n\r\ninterface CreateOrgData {\r\n  name: string;\r\n  slug?: string;\r\n  industry?: string;\r\n  size?: string;\r\n  website?: string;\r\n}\r\n\r\nconst OrganizationContext = createContext<OrganizationContextType | undefined>(undefined);\r\n\r\nconst ORG_STORAGE_KEY = 'current_organization_id';\r\n\r\nexport function OrganizationProvider({ children }: { children: React.ReactNode }) {\r\n  const { user } = useAuth();\r\n  const [currentOrg, setCurrentOrgState] = useState<Organization | null>(null);\r\n  const [currentRole, setCurrentRole] = useState<OrgRole | null>(null);\r\n  const [organizations, setOrganizations] = useState<OrganizationMembership[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isLoadingOrgs, setIsLoadingOrgs] = useState(true);\r\n\r\n  // Fetch all organizations user belongs to\r\n  const fetchOrganizations = useCallback(async () => {\r\n    if (!user) {\r\n      setOrganizations([]);\r\n      setIsLoadingOrgs(false);\r\n      return;\r\n    }\r\n\r\n    setIsLoadingOrgs(true);\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('organization_members')\r\n        .select(`\r\n          id,\r\n          organization_id,\r\n          user_id,\r\n          role,\r\n          is_active,\r\n          joined_at,\r\n          organization:organizations (\r\n            id,\r\n            name,\r\n            slug,\r\n            logo_url,\r\n            website,\r\n            industry,\r\n            size,\r\n            settings,\r\n            created_at,\r\n            updated_at\r\n          )\r\n        `)\r\n        .eq('user_id', user.id)\r\n        .eq('is_active', true);\r\n\r\n      if (error) throw error;\r\n\r\n      // Transform the data to flatten organization\r\n      const memberships: OrganizationMembership[] = (data || []).map((item: any) => ({\r\n        id: item.id,\r\n        organization_id: item.organization_id,\r\n        user_id: item.user_id,\r\n        role: item.role as OrgRole,\r\n        is_active: item.is_active,\r\n        joined_at: item.joined_at,\r\n        organization: item.organization as Organization,\r\n      }));\r\n\r\n      setOrganizations(memberships);\r\n    } catch (error) {\r\n      console.error('Error fetching organizations:', error);\r\n      setOrganizations([]);\r\n    } finally {\r\n      setIsLoadingOrgs(false);\r\n    }\r\n  }, [user]);\r\n\r\n  // Set current organization with persistence\r\n  const setCurrentOrg = useCallback((org: Organization | null) => {\r\n    setCurrentOrgState(org);\r\n    if (org) {\r\n      localStorage.setItem(ORG_STORAGE_KEY, org.id);\r\n      // Find and set role\r\n      const membership = organizations.find(m => m.organization_id === org.id);\r\n      setCurrentRole(membership?.role || null);\r\n    } else {\r\n      localStorage.removeItem(ORG_STORAGE_KEY);\r\n      setCurrentRole(null);\r\n    }\r\n  }, [organizations]);\r\n\r\n  // Switch to a different organization\r\n  const switchOrganization = useCallback(async (orgId: string) => {\r\n    const membership = organizations.find(m => m.organization_id === orgId);\r\n    if (membership) {\r\n      setCurrentOrgState(membership.organization);\r\n      setCurrentRole(membership.role);\r\n      localStorage.setItem(ORG_STORAGE_KEY, orgId);\r\n    }\r\n  }, [organizations]);\r\n\r\n  // Create a new organization\r\n  const createOrganization = useCallback(async (data: CreateOrgData): Promise<Organization> => {\r\n    if (!user) throw new Error('Must be logged in to create organization');\r\n\r\n    // Generate slug if not provided\r\n    const slug = data.slug || data.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');\r\n\r\n    // Create organization\r\n    const { data: org, error: orgError } = await supabase\r\n      .from('organizations')\r\n      .insert({\r\n        name: data.name,\r\n        slug,\r\n        industry: data.industry,\r\n        size: data.size,\r\n        website: data.website,\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (orgError) throw orgError;\r\n\r\n    // Add creator as owner\r\n    const { error: memberError } = await supabase\r\n      .from('organization_members')\r\n      .insert({\r\n        organization_id: org.id,\r\n        user_id: user.id,\r\n        role: 'owner',\r\n        joined_at: new Date().toISOString(),\r\n      });\r\n\r\n    if (memberError) throw memberError;\r\n\r\n    // Create default settings\r\n    await supabase\r\n      .from('organization_settings')\r\n      .insert({\r\n        organization_id: org.id,\r\n      });\r\n\r\n    // Refresh organizations list\r\n    await fetchOrganizations();\r\n\r\n    return org;\r\n  }, [user, fetchOrganizations]);\r\n\r\n  // Update organization\r\n  const updateOrganization = useCallback(async (orgId: string, data: Partial<Organization>) => {\r\n    const { error } = await supabase\r\n      .from('organizations')\r\n      .update(data)\r\n      .eq('id', orgId);\r\n\r\n    if (error) throw error;\r\n\r\n    // Update local state\r\n    if (currentOrg?.id === orgId) {\r\n      setCurrentOrgState(prev => prev ? { ...prev, ...data } : null);\r\n    }\r\n\r\n    await fetchOrganizations();\r\n  }, [currentOrg, fetchOrganizations]);\r\n\r\n  // Initialize: fetch orgs and restore last selected\r\n  useEffect(() => {\r\n    if (user) {\r\n      fetchOrganizations();\r\n    } else {\r\n      setOrganizations([]);\r\n      setCurrentOrgState(null);\r\n      setCurrentRole(null);\r\n      setIsLoading(false);\r\n      setIsLoadingOrgs(false);\r\n    }\r\n  }, [user, fetchOrganizations]);\r\n\r\n  // Restore last selected org after orgs are loaded\r\n  useEffect(() => {\r\n    if (!isLoadingOrgs && organizations.length > 0 && !currentOrg) {\r\n      const savedOrgId = localStorage.getItem(ORG_STORAGE_KEY);\r\n      const savedMembership = savedOrgId \r\n        ? organizations.find(m => m.organization_id === savedOrgId)\r\n        : null;\r\n\r\n      if (savedMembership) {\r\n        setCurrentOrgState(savedMembership.organization);\r\n        setCurrentRole(savedMembership.role);\r\n      } else {\r\n        // Default to first organization\r\n        const firstMembership = organizations[0];\r\n        setCurrentOrgState(firstMembership.organization);\r\n        setCurrentRole(firstMembership.role);\r\n        localStorage.setItem(ORG_STORAGE_KEY, firstMembership.organization_id);\r\n      }\r\n      setIsLoading(false);\r\n    } else if (!isLoadingOrgs && organizations.length === 0) {\r\n      setIsLoading(false);\r\n    }\r\n  }, [isLoadingOrgs, organizations, currentOrg]);\r\n\r\n  // Subscribe to organization_members changes for real-time updates\r\n  useEffect(() => {\r\n    if (!user) return;\r\n\r\n    const channel = supabase\r\n      .channel('org-membership-changes')\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'organization_members',\r\n          filter: `user_id=eq.${user.id}`,\r\n        },\r\n        () => {\r\n          fetchOrganizations();\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [user, fetchOrganizations]);\r\n\r\n  // Permission helpers\r\n  const isOwner = currentRole === 'owner';\r\n  const isAdmin = currentRole === 'owner' || currentRole === 'admin';\r\n  const canManageMembers = isAdmin;\r\n  const canManageSettings = isAdmin;\r\n  const canEdit = currentRole !== 'viewer';\r\n\r\n  const value: OrganizationContextType = {\r\n    currentOrg,\r\n    currentRole,\r\n    organizations,\r\n    isLoading,\r\n    isLoadingOrgs,\r\n    setCurrentOrg,\r\n    switchOrganization,\r\n    createOrganization,\r\n    updateOrganization,\r\n    refreshOrganizations: fetchOrganizations,\r\n    isOwner,\r\n    isAdmin,\r\n    canManageMembers,\r\n    canManageSettings,\r\n    canEdit,\r\n  };\r\n\r\n  return (\r\n    <OrganizationContext.Provider value={value}>\r\n      {children}\r\n    </OrganizationContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useOrganization() {\r\n  const context = useContext(OrganizationContext);\r\n  if (context === undefined) {\r\n    throw new Error('useOrganization must be used within an OrganizationProvider');\r\n  }\r\n  return context;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\contexts\\SMSConnectionContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":203,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":203,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useState, useCallback, useEffect, ReactNode } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { toast } from 'sonner';\r\n\r\nexport interface SMSConnection {\r\n  id: string;\r\n  phoneNumber: string;\r\n  displayName: string;\r\n  provider: 'twilio' | 'messagebird' | 'vonage' | 'plivo';\r\n  status: 'connected' | 'disconnected' | 'error';\r\n  lastSync?: Date;\r\n  accountSid?: string;\r\n  authToken?: string;\r\n}\r\n\r\ninterface SMSConnectionContextType {\r\n  connections: SMSConnection[];\r\n  activeConnection: SMSConnection | null;\r\n  isLoading: boolean;\r\n  addConnection: (connection: Omit<SMSConnection, 'id'>) => void;\r\n  updateConnection: (id: string, updates: Partial<SMSConnection>) => void;\r\n  removeConnection: (id: string) => void;\r\n  setActiveConnection: (id: string) => void;\r\n  testConnection: (id: string) => Promise<boolean>;\r\n}\r\n\r\nconst SMSConnectionContext = createContext<SMSConnectionContextType | undefined>(undefined);\r\n\r\nexport function SMSConnectionProvider({ children }: { children: ReactNode }) {\r\n  const { user, profile } = useAuth();\r\n  const [connections, setConnections] = useState<SMSConnection[]>([]);\r\n  const [activeConnectionId, setActiveConnectionId] = useState<string | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n\r\n  const activeConnection = connections.find(c => c.id === activeConnectionId) || null;\r\n\r\n  // Fetch connections from database\r\n  const fetchConnections = useCallback(async () => {\r\n    if (!user || !profile?.company_id) {\r\n      setConnections([]);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('marketing_connections')\r\n        .select('*')\r\n        .eq('company_id', profile.company_id)\r\n        .eq('channel', 'sms')\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (error) throw error;\r\n\r\n      const mapped: SMSConnection[] = (data || []).map(row => ({\r\n        id: row.id,\r\n        phoneNumber: row.identifier,\r\n        displayName: row.display_name,\r\n        provider: row.provider as SMSConnection['provider'],\r\n        status: row.status as SMSConnection['status'],\r\n        lastSync: row.last_sync ? new Date(row.last_sync) : undefined,\r\n        accountSid: (row.credentials as Record<string, string>)?.accountSid,\r\n        authToken: (row.credentials as Record<string, string>)?.authToken,\r\n      }));\r\n\r\n      setConnections(mapped);\r\n      if (mapped.length > 0 && !activeConnectionId) {\r\n        setActiveConnectionId(mapped[0].id);\r\n      }\r\n    } catch (err) {\r\n      console.error('Error fetching SMS connections:', err);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [user, profile?.company_id, activeConnectionId]);\r\n\r\n  useEffect(() => {\r\n    fetchConnections();\r\n  }, [fetchConnections]);\r\n\r\n  const addConnection = useCallback(async (connection: Omit<SMSConnection, 'id'>) => {\r\n    if (!user || !profile?.company_id) {\r\n      toast.error('Please log in to add connections');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('marketing_connections')\r\n        .insert({\r\n          company_id: profile.company_id,\r\n          channel: 'sms',\r\n          provider: connection.provider,\r\n          display_name: connection.displayName,\r\n          identifier: connection.phoneNumber,\r\n          credentials: { accountSid: connection.accountSid, authToken: connection.authToken },\r\n          status: connection.status,\r\n          last_sync: connection.lastSync?.toISOString(),\r\n          created_by: user.id,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      const newConnection: SMSConnection = {\r\n        id: data.id,\r\n        phoneNumber: data.identifier,\r\n        displayName: data.display_name,\r\n        provider: data.provider as SMSConnection['provider'],\r\n        status: data.status as SMSConnection['status'],\r\n        lastSync: data.last_sync ? new Date(data.last_sync) : undefined,\r\n        accountSid: connection.accountSid,\r\n        authToken: connection.authToken,\r\n      };\r\n\r\n      setConnections(prev => [newConnection, ...prev]);\r\n      toast.success('SMS connection added');\r\n    } catch (err) {\r\n      console.error('Error adding SMS connection:', err);\r\n      toast.error('Failed to add connection');\r\n    }\r\n  }, [user, profile?.company_id]);\r\n\r\n  const updateConnection = useCallback(async (id: string, updates: Partial<SMSConnection>) => {\r\n    try {\r\n      const dbUpdates: Record<string, unknown> = {};\r\n      if (updates.displayName) dbUpdates.display_name = updates.displayName;\r\n      if (updates.phoneNumber) dbUpdates.identifier = updates.phoneNumber;\r\n      if (updates.status) dbUpdates.status = updates.status;\r\n      if (updates.lastSync) dbUpdates.last_sync = updates.lastSync.toISOString();\r\n\r\n      await supabase\r\n        .from('marketing_connections')\r\n        .update(dbUpdates)\r\n        .eq('id', id);\r\n\r\n      setConnections(prev => \r\n        prev.map(conn => conn.id === id ? { ...conn, ...updates } : conn)\r\n      );\r\n    } catch (err) {\r\n      console.error('Error updating connection:', err);\r\n    }\r\n  }, []);\r\n\r\n  const removeConnection = useCallback(async (id: string) => {\r\n    try {\r\n      await supabase\r\n        .from('marketing_connections')\r\n        .delete()\r\n        .eq('id', id);\r\n\r\n      setConnections(prev => prev.filter(conn => conn.id !== id));\r\n      if (activeConnectionId === id) {\r\n        setActiveConnectionId(null);\r\n      }\r\n      toast.success('SMS connection removed');\r\n    } catch (err) {\r\n      console.error('Error removing connection:', err);\r\n      toast.error('Failed to remove connection');\r\n    }\r\n  }, [activeConnectionId]);\r\n\r\n  const setActiveConnection = useCallback((id: string) => {\r\n    setActiveConnectionId(id);\r\n  }, []);\r\n\r\n  const testConnection = useCallback(async (id: string): Promise<boolean> => {\r\n    setIsLoading(true);\r\n    await new Promise(resolve => setTimeout(resolve, 1500));\r\n    \r\n    const connection = connections.find(c => c.id === id);\r\n    if (connection) {\r\n      const success = connection.accountSid && connection.phoneNumber;\r\n      await updateConnection(id, { \r\n        status: success ? 'connected' : 'error',\r\n        lastSync: success ? new Date() : undefined\r\n      });\r\n      setIsLoading(false);\r\n      return !!success;\r\n    }\r\n    setIsLoading(false);\r\n    return false;\r\n  }, [connections, updateConnection]);\r\n\r\n  return (\r\n    <SMSConnectionContext.Provider value={{\r\n      connections,\r\n      activeConnection,\r\n      isLoading,\r\n      addConnection,\r\n      updateConnection,\r\n      removeConnection,\r\n      setActiveConnection,\r\n      testConnection,\r\n    }}>\r\n      {children}\r\n    </SMSConnectionContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useSMSConnection() {\r\n  const context = useContext(SMSConnectionContext);\r\n  if (context === undefined) {\r\n    throw new Error('useSMSConnection must be used within an SMSConnectionProvider');\r\n  }\r\n  return context;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\contexts\\StagesContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":18,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":18,"endColumn":33},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchStages'. Either include it or remove the dependency array.","line":142,"column":6,"nodeType":"ArrayExpression","endLine":142,"endColumn":27,"suggestions":[{"desc":"Update the dependencies array to be: [fetchStages, profile.company_id]","fix":{"range":[5353,5374],"text":"[fetchStages, profile.company_id]"}}]},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":255,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":255,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createContext, useContext, useState, useEffect, ReactNode } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"./AuthContext\";\r\n\r\nexport type LeadStage = {\r\n  id: string;\r\n  name: string;\r\n  color: string;\r\n  category?: \"initial\" | \"intermediate\" | \"final\";\r\n  leadCount?: number;\r\n  position?: number;\r\n  is_default?: boolean;\r\n  is_won?: boolean;\r\n  is_lost?: boolean;\r\n};\r\n\r\n// 15 distinct vibrant stage color options (no gray/neutral)\r\nexport const STAGE_COLOR_OPTIONS = [\r\n  \"#3B82F6\", // Blue\r\n  \"#8B5CF6\", // Purple\r\n  \"#F59E0B\", // Amber\r\n  \"#06B6D4\", // Cyan\r\n  \"#10B981\", // Emerald\r\n  \"#EF4444\", // Red\r\n  \"#EC4899\", // Pink\r\n  \"#6366F1\", // Indigo\r\n  \"#14B8A6\", // Teal\r\n  \"#F97316\", // Orange\r\n  \"#84CC16\", // Lime\r\n  \"#A855F7\", // Violet\r\n  \"#0EA5E9\", // Sky\r\n  \"#22C55E\", // Green\r\n  \"#E11D48\", // Rose\r\n];\r\n\r\ntype StagesContextType = {\r\n  stages: LeadStage[];\r\n  setStages: React.Dispatch<React.SetStateAction<LeadStage[]>>;\r\n  addStage: (stage: Omit<LeadStage, 'id'>) => Promise<LeadStage | null>;\r\n  updateStage: (id: string, updates: Partial<LeadStage>) => Promise<boolean>;\r\n  deleteStage: (id: string) => Promise<boolean>;\r\n  reorderStages: (newStages: LeadStage[]) => Promise<boolean>;\r\n  isLoading: boolean;\r\n  refetch: () => Promise<void>;\r\n};\r\n\r\nconst fallbackStages: LeadStage[] = [\r\n  { id: \"uncontacted\", name: \"Uncontacted\", color: \"#6366F1\", category: \"initial\", leadCount: 0, is_default: true },\r\n  { id: \"new\", name: \"New\", color: \"#3B82F6\", category: \"initial\", leadCount: 0 },\r\n  { id: \"contacted\", name: \"Contacted\", color: \"#8B5CF6\", category: \"intermediate\", leadCount: 0 },\r\n  { id: \"qualified\", name: \"Qualified\", color: \"#06B6D4\", category: \"intermediate\", leadCount: 0 },\r\n  { id: \"meeting\", name: \"Meeting Scheduled\", color: \"#EC4899\", category: \"intermediate\", leadCount: 0 },\r\n  { id: \"viewing\", name: \"Viewing Done\", color: \"#14B8A6\", category: \"intermediate\", leadCount: 0 },\r\n  { id: \"proposal\", name: \"Proposal Sent\", color: \"#F59E0B\", category: \"intermediate\", leadCount: 0 },\r\n  { id: \"negotiation\", name: \"Negotiation\", color: \"#F97316\", category: \"intermediate\", leadCount: 0 },\r\n  { id: \"contract\", name: \"Contract Signed\", color: \"#84CC16\", category: \"intermediate\", leadCount: 0 },\r\n  { id: \"won\", name: \"Won\", color: \"#10B981\", category: \"final\", leadCount: 0, is_won: true },\r\n  { id: \"lost\", name: \"Lost\", color: \"#EF4444\", category: \"final\", leadCount: 0, is_lost: true },\r\n];\r\n\r\nconst StagesContext = createContext<StagesContextType | undefined>(undefined);\r\n\r\nexport function StagesProvider({ children }: { children: ReactNode }) {\r\n  const [stages, setStages] = useState<LeadStage[]>(fallbackStages);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const { profile } = useAuth();\r\n\r\n  // Fetch stages from database\r\n  const fetchStages = async () => {\r\n    if (!profile?.company_id) {\r\n      setStages(fallbackStages);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from(\"lead_stages\")\r\n        .select(\"*\")\r\n        .eq(\"company_id\", profile.company_id)\r\n        .order(\"position\", { ascending: true });\r\n\r\n      if (error) {\r\n        console.error(\"Error fetching stages:\", error);\r\n        setStages(fallbackStages);\r\n      } else if (data && data.length > 0) {\r\n        const mappedStages: LeadStage[] = data.map(stage => ({\r\n          id: stage.id,\r\n          name: stage.name,\r\n          color: stage.color || \"#3B82F6\",\r\n          category: stage.is_won ? \"final\" : stage.is_lost ? \"final\" : stage.is_default ? \"initial\" : \"intermediate\",\r\n          position: stage.position,\r\n          is_default: stage.is_default,\r\n          is_won: stage.is_won,\r\n          is_lost: stage.is_lost,\r\n          leadCount: 0,\r\n        }));\r\n        setStages(mappedStages);\r\n      } else {\r\n        // No stages found - create defaults for this company\r\n        if (profile.company_id) {\r\n          await supabase.rpc('create_default_stages_for_company', { \r\n            p_company_id: profile.company_id \r\n          });\r\n          // Refetch after creating defaults\r\n          const { data: newData } = await supabase\r\n            .from(\"lead_stages\")\r\n            .select(\"*\")\r\n            .eq(\"company_id\", profile.company_id)\r\n            .order(\"position\", { ascending: true });\r\n          \r\n          if (newData && newData.length > 0) {\r\n            const mappedStages: LeadStage[] = newData.map(stage => ({\r\n              id: stage.id,\r\n              name: stage.name,\r\n              color: stage.color || \"#3B82F6\",\r\n              category: stage.is_won ? \"final\" : stage.is_lost ? \"final\" : stage.is_default ? \"initial\" : \"intermediate\",\r\n              position: stage.position,\r\n              is_default: stage.is_default,\r\n              is_won: stage.is_won,\r\n              is_lost: stage.is_lost,\r\n              leadCount: 0,\r\n            }));\r\n            setStages(mappedStages);\r\n          } else {\r\n            setStages(fallbackStages);\r\n          }\r\n        } else {\r\n          setStages(fallbackStages);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error fetching stages:\", error);\r\n      setStages(fallbackStages);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchStages();\r\n  }, [profile?.company_id]);\r\n\r\n  const addStage = async (stage: Omit<LeadStage, 'id'>): Promise<LeadStage | null> => {\r\n    if (!profile?.company_id) return null;\r\n    \r\n    const maxPosition = Math.max(...stages.map(s => s.position || 0), 0);\r\n    \r\n    const { data, error } = await supabase\r\n      .from(\"lead_stages\")\r\n      .insert({\r\n        company_id: profile.company_id,\r\n        name: stage.name,\r\n        color: stage.color,\r\n        position: maxPosition + 1,\r\n        is_default: stage.is_default || false,\r\n        is_won: stage.is_won || false,\r\n        is_lost: stage.is_lost || false,\r\n      })\r\n      .select()\r\n      .single();\r\n    \r\n    if (error) {\r\n      console.error(\"Error adding stage:\", error);\r\n      return null;\r\n    }\r\n    \r\n    const newStage: LeadStage = {\r\n      id: data.id,\r\n      name: data.name,\r\n      color: data.color || \"#3B82F6\",\r\n      category: data.is_won ? \"final\" : data.is_lost ? \"final\" : data.is_default ? \"initial\" : \"intermediate\",\r\n      position: data.position,\r\n      is_default: data.is_default,\r\n      is_won: data.is_won,\r\n      is_lost: data.is_lost,\r\n      leadCount: 0,\r\n    };\r\n    \r\n    setStages((prev) => [...prev, newStage]);\r\n    return newStage;\r\n  };\r\n\r\n  const updateStage = async (id: string, updates: Partial<LeadStage>): Promise<boolean> => {\r\n    const { error } = await supabase\r\n      .from(\"lead_stages\")\r\n      .update({\r\n        name: updates.name,\r\n        color: updates.color,\r\n        position: updates.position,\r\n        is_default: updates.is_default,\r\n        is_won: updates.is_won,\r\n        is_lost: updates.is_lost,\r\n      })\r\n      .eq(\"id\", id);\r\n    \r\n    if (error) {\r\n      console.error(\"Error updating stage:\", error);\r\n      return false;\r\n    }\r\n    \r\n    setStages((prev) =>\r\n      prev.map((stage) => (stage.id === id ? { ...stage, ...updates } : stage))\r\n    );\r\n    return true;\r\n  };\r\n\r\n  const deleteStage = async (id: string): Promise<boolean> => {\r\n    const { error } = await supabase\r\n      .from(\"lead_stages\")\r\n      .delete()\r\n      .eq(\"id\", id);\r\n    \r\n    if (error) {\r\n      console.error(\"Error deleting stage:\", error);\r\n      return false;\r\n    }\r\n    \r\n    setStages((prev) => prev.filter((stage) => stage.id !== id));\r\n    return true;\r\n  };\r\n\r\n  const reorderStages = async (newStages: LeadStage[]): Promise<boolean> => {\r\n    // Update positions in database\r\n    const updates = newStages.map((stage, index) => ({\r\n      id: stage.id,\r\n      position: index + 1,\r\n    }));\r\n    \r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from(\"lead_stages\")\r\n        .update({ position: update.position })\r\n        .eq(\"id\", update.id);\r\n      \r\n      if (error) {\r\n        console.error(\"Error reordering stages:\", error);\r\n        return false;\r\n      }\r\n    }\r\n    \r\n    setStages(newStages.map((stage, index) => ({ ...stage, position: index + 1 })));\r\n    return true;\r\n  };\r\n\r\n  return (\r\n    <StagesContext.Provider\r\n      value={{ stages, setStages, addStage, updateStage, deleteStage, reorderStages, isLoading, refetch: fetchStages }}\r\n    >\r\n      {children}\r\n    </StagesContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useStages() {\r\n  const context = useContext(StagesContext);\r\n  if (!context) {\r\n    throw new Error(\"useStages must be used within a StagesProvider\");\r\n  }\r\n  return context;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\contexts\\SubscriptionContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":35,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":35,"endColumn":39},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":44,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":44,"endColumn":36}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, ReactNode } from 'react';\r\nimport { useSubscription, PlanFeatures, PricingPlan, SubscriptionUsage, PlanType } from '@/hooks/useSubscription';\r\n\r\ninterface SubscriptionContextType {\r\n  planFeatures: PlanFeatures | null;\r\n  allPlans: PricingPlan[];\r\n  usage: SubscriptionUsage;\r\n  isLoading: boolean;\r\n  canAddLead: () => boolean;\r\n  canAddListing: () => boolean;\r\n  canAddUser: () => boolean;\r\n  canSendCampaign: () => boolean;\r\n  canActivateChatbot: () => boolean;\r\n  canUseAutomations: () => boolean;\r\n  canManageTeam: () => boolean;\r\n  canUseAdvancedAssignment: () => boolean;\r\n  canUseCustomRoles: () => boolean;\r\n  isFreePlan: () => boolean;\r\n  getRequiredPlanForFeature: (feature: string) => PlanType;\r\n  refreshSubscription: () => Promise<void>;\r\n}\r\n\r\nconst SubscriptionContext = createContext<SubscriptionContextType | undefined>(undefined);\r\n\r\nexport function SubscriptionProvider({ children }: { children: ReactNode }) {\r\n  const subscription = useSubscription();\r\n\r\n  return (\r\n    <SubscriptionContext.Provider value={subscription}>\r\n      {children}\r\n    </SubscriptionContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useSubscriptionContext() {\r\n  const context = useContext(SubscriptionContext);\r\n  if (context === undefined) {\r\n    throw new Error('useSubscriptionContext must be used within a SubscriptionProvider');\r\n  }\r\n  return context;\r\n}\r\n\r\n// Safe version that doesn't throw\r\nexport function useSubscriptionSafe() {\r\n  const context = useContext(SubscriptionContext);\r\n  return context;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\contexts\\ThemeContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":75,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":75,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createContext, useContext, useEffect, useState } from \"react\";\r\n\r\ntype Theme = \"light\" | \"dark\" | \"system\";\r\n\r\ninterface ThemeContextType {\r\n  theme: Theme;\r\n  setTheme: (theme: Theme) => void;\r\n  resolvedTheme: \"light\" | \"dark\";\r\n  forceLightMode: boolean;\r\n  setForceLightMode: (force: boolean) => void;\r\n}\r\n\r\nconst ThemeContext = createContext<ThemeContextType | undefined>(undefined);\r\n\r\nexport function ThemeProvider({ children }: { children: React.ReactNode }) {\r\n  const [theme, setThemeState] = useState<Theme>(() => {\r\n    if (typeof window !== \"undefined\") {\r\n      return (localStorage.getItem(\"theme\") as Theme) || \"system\";\r\n    }\r\n    return \"system\";\r\n  });\r\n\r\n  const [resolvedTheme, setResolvedTheme] = useState<\"light\" | \"dark\">(\"light\");\r\n  const [forceLightMode, setForceLightMode] = useState(false);\r\n\r\n  useEffect(() => {\r\n    const root = window.document.documentElement;\r\n\r\n    const getSystemTheme = () => {\r\n      return window.matchMedia(\"(prefers-color-scheme: dark)\").matches ? \"dark\" : \"light\";\r\n    };\r\n\r\n    const applyTheme = (newTheme: Theme, forceLight: boolean) => {\r\n      // Always use light mode when forced (landing/auth pages)\r\n      if (forceLight) {\r\n        setResolvedTheme(\"light\");\r\n        root.classList.remove(\"light\", \"dark\");\r\n        root.classList.add(\"light\");\r\n        return;\r\n      }\r\n\r\n      const resolved = newTheme === \"system\" ? getSystemTheme() : newTheme;\r\n      setResolvedTheme(resolved);\r\n\r\n      root.classList.remove(\"light\", \"dark\");\r\n      root.classList.add(resolved);\r\n    };\r\n\r\n    applyTheme(theme, forceLightMode);\r\n\r\n    // Listen for system theme changes\r\n    const mediaQuery = window.matchMedia(\"(prefers-color-scheme: dark)\");\r\n    const handleChange = () => {\r\n      if (theme === \"system\" && !forceLightMode) {\r\n        applyTheme(\"system\", forceLightMode);\r\n      }\r\n    };\r\n\r\n    mediaQuery.addEventListener(\"change\", handleChange);\r\n    return () => mediaQuery.removeEventListener(\"change\", handleChange);\r\n  }, [theme, forceLightMode]);\r\n\r\n  const setTheme = (newTheme: Theme) => {\r\n    setThemeState(newTheme);\r\n    localStorage.setItem(\"theme\", newTheme);\r\n  };\r\n\r\n  return (\r\n    <ThemeContext.Provider value={{ theme, setTheme, resolvedTheme, forceLightMode, setForceLightMode }}>\r\n      {children}\r\n    </ThemeContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useTheme() {\r\n  const context = useContext(ThemeContext);\r\n  if (context === undefined) {\r\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\r\n  }\r\n  return context;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\contexts\\WhatsAppConnectionContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":203,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":203,"endColumn":38}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useState, useCallback, useEffect, ReactNode } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { toast } from 'sonner';\r\n\r\nexport interface WhatsAppConnection {\r\n  id: string;\r\n  phoneNumber: string;\r\n  displayName: string;\r\n  provider: 'meta' | 'twilio' | '360dialog' | 'vonage';\r\n  status: 'connected' | 'disconnected' | 'error';\r\n  lastSync?: Date;\r\n  apiKey?: string;\r\n  token?: string;\r\n}\r\n\r\ninterface WhatsAppConnectionContextType {\r\n  connections: WhatsAppConnection[];\r\n  activeConnection: WhatsAppConnection | null;\r\n  isLoading: boolean;\r\n  addConnection: (connection: Omit<WhatsAppConnection, 'id'>) => void;\r\n  updateConnection: (id: string, updates: Partial<WhatsAppConnection>) => void;\r\n  removeConnection: (id: string) => void;\r\n  setActiveConnection: (id: string) => void;\r\n  testConnection: (id: string) => Promise<boolean>;\r\n}\r\n\r\nconst WhatsAppConnectionContext = createContext<WhatsAppConnectionContextType | undefined>(undefined);\r\n\r\nexport function WhatsAppConnectionProvider({ children }: { children: ReactNode }) {\r\n  const { user, profile } = useAuth();\r\n  const [connections, setConnections] = useState<WhatsAppConnection[]>([]);\r\n  const [activeConnectionId, setActiveConnectionId] = useState<string | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n\r\n  const activeConnection = connections.find(c => c.id === activeConnectionId) || null;\r\n\r\n  // Fetch connections from database\r\n  const fetchConnections = useCallback(async () => {\r\n    if (!user || !profile?.company_id) {\r\n      setConnections([]);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('marketing_connections')\r\n        .select('*')\r\n        .eq('company_id', profile.company_id)\r\n        .eq('channel', 'whatsapp')\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (error) throw error;\r\n\r\n      const mapped: WhatsAppConnection[] = (data || []).map(row => ({\r\n        id: row.id,\r\n        phoneNumber: row.identifier,\r\n        displayName: row.display_name,\r\n        provider: row.provider as WhatsAppConnection['provider'],\r\n        status: row.status as WhatsAppConnection['status'],\r\n        lastSync: row.last_sync ? new Date(row.last_sync) : undefined,\r\n        apiKey: (row.credentials as Record<string, string>)?.apiKey || (row.credentials as Record<string, string>)?.accessToken,\r\n        token: (row.credentials as Record<string, string>)?.businessId,\r\n      }));\r\n\r\n      setConnections(mapped);\r\n      if (mapped.length > 0 && !activeConnectionId) {\r\n        setActiveConnectionId(mapped[0].id);\r\n      }\r\n    } catch (err) {\r\n      console.error('Error fetching WhatsApp connections:', err);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [user, profile?.company_id, activeConnectionId]);\r\n\r\n  useEffect(() => {\r\n    fetchConnections();\r\n  }, [fetchConnections]);\r\n\r\n  const addConnection = useCallback(async (connection: Omit<WhatsAppConnection, 'id'>) => {\r\n    if (!user || !profile?.company_id) {\r\n      toast.error('Please log in to add connections');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('marketing_connections')\r\n        .insert({\r\n          company_id: profile.company_id,\r\n          channel: 'whatsapp',\r\n          provider: connection.provider,\r\n          display_name: connection.displayName,\r\n          identifier: connection.phoneNumber,\r\n          credentials: { apiKey: connection.apiKey, businessId: connection.token },\r\n          status: connection.status,\r\n          last_sync: connection.lastSync?.toISOString(),\r\n          created_by: user.id,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      const newConnection: WhatsAppConnection = {\r\n        id: data.id,\r\n        phoneNumber: data.identifier,\r\n        displayName: data.display_name,\r\n        provider: data.provider as WhatsAppConnection['provider'],\r\n        status: data.status as WhatsAppConnection['status'],\r\n        lastSync: data.last_sync ? new Date(data.last_sync) : undefined,\r\n        apiKey: connection.apiKey,\r\n        token: connection.token,\r\n      };\r\n\r\n      setConnections(prev => [newConnection, ...prev]);\r\n      toast.success('WhatsApp connection added');\r\n    } catch (err) {\r\n      console.error('Error adding WhatsApp connection:', err);\r\n      toast.error('Failed to add connection');\r\n    }\r\n  }, [user, profile?.company_id]);\r\n\r\n  const updateConnection = useCallback(async (id: string, updates: Partial<WhatsAppConnection>) => {\r\n    try {\r\n      const dbUpdates: Record<string, unknown> = {};\r\n      if (updates.displayName) dbUpdates.display_name = updates.displayName;\r\n      if (updates.phoneNumber) dbUpdates.identifier = updates.phoneNumber;\r\n      if (updates.status) dbUpdates.status = updates.status;\r\n      if (updates.lastSync) dbUpdates.last_sync = updates.lastSync.toISOString();\r\n\r\n      await supabase\r\n        .from('marketing_connections')\r\n        .update(dbUpdates)\r\n        .eq('id', id);\r\n\r\n      setConnections(prev => \r\n        prev.map(conn => conn.id === id ? { ...conn, ...updates } : conn)\r\n      );\r\n    } catch (err) {\r\n      console.error('Error updating connection:', err);\r\n    }\r\n  }, []);\r\n\r\n  const removeConnection = useCallback(async (id: string) => {\r\n    try {\r\n      await supabase\r\n        .from('marketing_connections')\r\n        .delete()\r\n        .eq('id', id);\r\n\r\n      setConnections(prev => prev.filter(conn => conn.id !== id));\r\n      if (activeConnectionId === id) {\r\n        setActiveConnectionId(null);\r\n      }\r\n      toast.success('Connection removed');\r\n    } catch (err) {\r\n      console.error('Error removing connection:', err);\r\n      toast.error('Failed to remove connection');\r\n    }\r\n  }, [activeConnectionId]);\r\n\r\n  const setActiveConnection = useCallback((id: string) => {\r\n    setActiveConnectionId(id);\r\n  }, []);\r\n\r\n  const testConnection = useCallback(async (id: string): Promise<boolean> => {\r\n    setIsLoading(true);\r\n    await new Promise(resolve => setTimeout(resolve, 1500));\r\n    \r\n    const connection = connections.find(c => c.id === id);\r\n    if (connection) {\r\n      const success = connection.apiKey && connection.phoneNumber;\r\n      await updateConnection(id, { \r\n        status: success ? 'connected' : 'error',\r\n        lastSync: success ? new Date() : undefined\r\n      });\r\n      setIsLoading(false);\r\n      return !!success;\r\n    }\r\n    setIsLoading(false);\r\n    return false;\r\n  }, [connections, updateConnection]);\r\n\r\n  return (\r\n    <WhatsAppConnectionContext.Provider value={{\r\n      connections,\r\n      activeConnection,\r\n      isLoading,\r\n      addConnection,\r\n      updateConnection,\r\n      removeConnection,\r\n      setActiveConnection,\r\n      testConnection,\r\n    }}>\r\n      {children}\r\n    </WhatsAppConnectionContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useWhatsAppConnection() {\r\n  const context = useContext(WhatsAppConnectionContext);\r\n  if (context === undefined) {\r\n    throw new Error('useWhatsAppConnection must be used within a WhatsAppConnectionProvider');\r\n  }\r\n  return context;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\crm\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\use-mobile.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\use-toast.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useAccessibility.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useAccounts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useActivities.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useAllActivities.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":19,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[653,656],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[653,656],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":245,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":245,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8025,8028],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8025,8028],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback, useMemo } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { useUserRole } from '@/hooks/useUserRole';\r\n\r\nexport type ActivityType = 'call' | 'email' | 'meeting' | 'note' | 'voicenote' | 'stage' | 'followup' | 'attachment' | 'other';\r\n\r\nexport interface Activity {\r\n  id: string;\r\n  lead_id: string;\r\n  type: ActivityType;\r\n  title: string;\r\n  description: string | null;\r\n  agent_id: string | null;\r\n  agent_name: string;\r\n  duration: string | null;\r\n  audio_url: string | null;\r\n  attachments_count: number;\r\n  attachments: any[];\r\n  created_at: string;\r\n  company_id: string;\r\n  import_job_id: string | null;\r\n  // For compatibility with UI\r\n  subject: string;\r\n  scheduled_at: string | null;\r\n  owner_id: string | null;\r\n  // Joined data\r\n  lead?: {\r\n    id: string;\r\n    name: string;\r\n    first_name: string;\r\n    last_name: string | null;\r\n  } | null;\r\n}\r\n\r\nexport interface ActivityFilters {\r\n  type?: ActivityType | ActivityType[];\r\n  lead_id?: string;\r\n  owner_id?: string;\r\n  from_date?: string;\r\n  to_date?: string;\r\n  search?: string;\r\n}\r\n\r\ninterface CreateActivityData {\r\n  type: ActivityType;\r\n  subject: string;\r\n  description?: string;\r\n  lead_id?: string;\r\n  duration_minutes?: number;\r\n  outcome?: string;\r\n  scheduled_at?: string;\r\n  completed_at?: string;\r\n  owner_id?: string;\r\n}\r\n\r\ninterface UseAllActivitiesOptions {\r\n  filters?: ActivityFilters;\r\n  page?: number;\r\n  pageSize?: number;\r\n}\r\n\r\nexport function useAllActivities(options: UseAllActivitiesOptions = {}) {\r\n  const { filters, page = 1, pageSize = 50 } = options;\r\n  const { user, profile } = useAuth();\r\n  const { role, isLoading: roleLoading } = useUserRole();\r\n  \r\n  const [activities, setActivities] = useState<Activity[]>([]);\r\n  const [leads, setLeads] = useState<Map<string, { id: string; name: string }>>(new Map());\r\n  const [profiles, setProfiles] = useState<Map<string, { first_name: string | null; last_name: string | null }>>(new Map());\r\n  const [totalCount, setTotalCount] = useState(0);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const companyId = profile?.company_id;\r\n  const isAdminOrManager = role === 'admin' || role === 'manager';\r\n\r\n  const fetchActivities = useCallback(async () => {\r\n    if (!companyId || roleLoading) {\r\n      setActivities([]);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      // Build query for lead_activities\r\n      let query = supabase\r\n        .from('lead_activities')\r\n        .select('*', { count: 'exact' })\r\n        .eq('company_id', companyId)\r\n        .order('created_at', { ascending: false });\r\n\r\n      // Role-based filtering - agents can only see activities for their leads\r\n      if (!isAdminOrManager && user?.id) {\r\n        // Get leads assigned to this agent first\r\n        const { data: agentLeads } = await supabase\r\n          .from('leads')\r\n          .select('id')\r\n          .eq('company_id', companyId)\r\n          .eq('assigned_agent_id', user.id);\r\n        \r\n        const leadIds = agentLeads?.map(l => l.id) || [];\r\n        if (leadIds.length > 0) {\r\n          query = query.in('lead_id', leadIds);\r\n        } else {\r\n          // No leads assigned, show only activities created by this agent\r\n          query = query.eq('agent_id', user.id);\r\n        }\r\n      }\r\n\r\n      // Apply filters\r\n      if (filters?.type) {\r\n        const types = Array.isArray(filters.type) ? filters.type : [filters.type];\r\n        query = query.in('type', types);\r\n      }\r\n\r\n      if (filters?.lead_id) {\r\n        query = query.eq('lead_id', filters.lead_id);\r\n      }\r\n\r\n      if (filters?.owner_id) {\r\n        query = query.eq('agent_id', filters.owner_id);\r\n      }\r\n\r\n      if (filters?.from_date) {\r\n        query = query.gte('created_at', filters.from_date);\r\n      }\r\n\r\n      if (filters?.to_date) {\r\n        query = query.lte('created_at', filters.to_date);\r\n      }\r\n\r\n      if (filters?.search) {\r\n        query = query.or(`title.ilike.%${filters.search}%,description.ilike.%${filters.search}%`);\r\n      }\r\n\r\n      // Pagination\r\n      const from = (page - 1) * pageSize;\r\n      const to = from + pageSize - 1;\r\n      query = query.range(from, to);\r\n\r\n      const { data, error: fetchError, count } = await query;\r\n\r\n      if (fetchError) throw fetchError;\r\n      \r\n      // Fetch leads for lead_ids\r\n      const leadIds = [...new Set((data || []).map(a => a.lead_id).filter(Boolean))] as string[];\r\n      if (leadIds.length > 0) {\r\n        const { data: leadsData } = await supabase\r\n          .from('leads')\r\n          .select('id, name')\r\n          .in('id', leadIds);\r\n        \r\n        const leadsMap = new Map<string, { id: string; name: string }>();\r\n        leadsData?.forEach(l => {\r\n          leadsMap.set(l.id, { id: l.id, name: l.name });\r\n        });\r\n        setLeads(leadsMap);\r\n      }\r\n\r\n      // Fetch profiles for agent_ids\r\n      const agentIds = [...new Set((data || []).map(a => a.agent_id).filter(Boolean))] as string[];\r\n      if (agentIds.length > 0) {\r\n        const { data: profilesData } = await supabase\r\n          .from('profiles')\r\n          .select('id, first_name, last_name')\r\n          .in('id', agentIds);\r\n        \r\n        const profilesMap = new Map<string, { first_name: string | null; last_name: string | null }>();\r\n        profilesData?.forEach(p => {\r\n          profilesMap.set(p.id, { first_name: p.first_name, last_name: p.last_name });\r\n        });\r\n        setProfiles(profilesMap);\r\n      }\r\n      \r\n      // Map to Activity interface with compatibility fields\r\n      const mappedActivities = (data || []).map(a => {\r\n        const leadData = leads.get(a.lead_id);\r\n        return {\r\n          ...a,\r\n          type: mapActivityType(a.type),\r\n          // Compatibility mappings\r\n          subject: a.title,\r\n          scheduled_at: a.created_at,\r\n          owner_id: a.agent_id,\r\n          lead: leadData ? {\r\n            id: leadData.id,\r\n            name: leadData.name,\r\n            first_name: leadData.name?.split(' ')[0] || leadData.name || '',\r\n            last_name: leadData.name?.split(' ').slice(1).join(' ') || null,\r\n          } : null,\r\n        };\r\n      }) as Activity[];\r\n      \r\n      setActivities(mappedActivities);\r\n      setTotalCount(count || 0);\r\n    } catch (err) {\r\n      console.error('Error fetching activities:', err);\r\n      setError(err instanceof Error ? err.message : 'Failed to fetch activities');\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [companyId, filters, page, pageSize, isAdminOrManager, user?.id, roleLoading, leads]);\r\n\r\n  const createActivity = useCallback(async (data: CreateActivityData): Promise<Activity> => {\r\n    if (!companyId) throw new Error('No company selected');\r\n\r\n    const { data: activity, error } = await supabase\r\n      .from('lead_activities')\r\n      .insert({\r\n        title: data.subject,\r\n        description: data.description,\r\n        type: data.type,\r\n        lead_id: data.lead_id,\r\n        agent_id: data.owner_id || user?.id,\r\n        agent_name: profile?.first_name ? `${profile.first_name} ${profile.last_name || ''}`.trim() : 'Agent',\r\n        company_id: companyId,\r\n        attachments: [],\r\n        attachments_count: 0,\r\n      })\r\n      .select('*')\r\n      .single();\r\n\r\n    if (error) throw error;\r\n    \r\n    // Refetch to get updated list\r\n    fetchActivities();\r\n    \r\n    return {\r\n      ...activity,\r\n      type: mapActivityType(activity.type),\r\n      subject: activity.title,\r\n      scheduled_at: activity.created_at,\r\n      owner_id: activity.agent_id,\r\n      lead: null,\r\n    } as Activity;\r\n  }, [companyId, user, profile, fetchActivities]);\r\n\r\n  const updateActivity = useCallback(async (activityId: string, data: Partial<CreateActivityData>) => {\r\n    if (!isAdminOrManager) throw new Error('Permission denied');\r\n\r\n    const updateData: Record<string, any> = {};\r\n    if (data.subject) updateData.title = data.subject;\r\n    if (data.description !== undefined) updateData.description = data.description;\r\n    if (data.type) updateData.type = data.type;\r\n    if (data.lead_id) updateData.lead_id = data.lead_id;\r\n    if (data.owner_id) updateData.agent_id = data.owner_id;\r\n\r\n    const { data: activity, error } = await supabase\r\n      .from('lead_activities')\r\n      .update(updateData)\r\n      .eq('id', activityId)\r\n      .select('*')\r\n      .single();\r\n\r\n    if (error) throw error;\r\n    \r\n    // Refetch to get updated list\r\n    fetchActivities();\r\n    \r\n    return {\r\n      ...activity,\r\n      type: mapActivityType(activity.type),\r\n      subject: activity.title,\r\n      scheduled_at: activity.created_at,\r\n      owner_id: activity.agent_id,\r\n      lead: null,\r\n    } as Activity;\r\n  }, [isAdminOrManager, fetchActivities]);\r\n\r\n  const deleteActivity = useCallback(async (activityId: string) => {\r\n    if (!isAdminOrManager) throw new Error('Permission denied');\r\n\r\n    const { error } = await supabase\r\n      .from('lead_activities')\r\n      .delete()\r\n      .eq('id', activityId);\r\n\r\n    if (error) throw error;\r\n    \r\n    // Refetch to get updated list\r\n    fetchActivities();\r\n  }, [isAdminOrManager, fetchActivities]);\r\n\r\n  // Real-time subscription\r\n  useEffect(() => {\r\n    if (!companyId) return;\r\n\r\n    const channel = supabase\r\n      .channel('lead-activities-realtime')\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'lead_activities',\r\n          filter: `company_id=eq.${companyId}`,\r\n        },\r\n        () => {\r\n          // Refetch on any change\r\n          fetchActivities();\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [companyId, fetchActivities]);\r\n\r\n  useEffect(() => {\r\n    fetchActivities();\r\n  }, [fetchActivities]);\r\n\r\n  // Stats\r\n  const stats = useMemo(() => ({\r\n    total: totalCount,\r\n    calls: activities.filter(a => a.type === 'call').length,\r\n    emails: activities.filter(a => a.type === 'email').length,\r\n    meetings: activities.filter(a => a.type === 'meeting').length,\r\n    notes: activities.filter(a => a.type === 'note').length,\r\n  }), [activities, totalCount]);\r\n\r\n  const totalPages = Math.ceil(totalCount / pageSize);\r\n\r\n  // Helper to get profile by id\r\n  const getProfile = useCallback((id: string | null) => {\r\n    if (!id) return null;\r\n    return profiles.get(id) || null;\r\n  }, [profiles]);\r\n\r\n  return {\r\n    activities,\r\n    stats,\r\n    totalCount,\r\n    totalPages,\r\n    isLoading,\r\n    error,\r\n    isAdminOrManager,\r\n    createActivity,\r\n    updateActivity,\r\n    deleteActivity,\r\n    refetch: fetchActivities,\r\n    getProfile,\r\n  };\r\n}\r\n\r\n// Map database activity types to our ActivityType\r\nfunction mapActivityType(dbType: string): ActivityType {\r\n  const typeMap: Record<string, ActivityType> = {\r\n    'call': 'call',\r\n    'email': 'email',\r\n    'meeting': 'meeting',\r\n    'note': 'note',\r\n    'voicenote': 'voicenote',\r\n    'stage': 'stage',\r\n    'followup': 'followup',\r\n    'attachment': 'attachment',\r\n  };\r\n  return typeMap[dbType] || 'other';\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useAssignmentConfig.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":76,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2497,2500],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2497,2500],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":122,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":122,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4191,4194],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4191,4194],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":149,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":149,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5055,5058],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5055,5058],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":200,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":200,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6557,6560],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6557,6560],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":226,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":226,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7401,7404],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7401,7404],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":245,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":245,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7999,8002],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7999,8002],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":264,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":264,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8556,8559],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8556,8559],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { toast } from \"sonner\";\r\n\r\nexport interface AssignmentConfig {\r\n    id: string;\r\n    company_id: string;\r\n    assignment_method: \"manual\" | \"round_robin\" | \"rules\";\r\n    round_robin_index: number;\r\n    enabled_agent_ids: string[];\r\n    agent_leads_per_round: Record<string, number>;\r\n    created_at: string;\r\n    updated_at: string;\r\n}\r\n\r\nexport interface AssignmentRule {\r\n    id: string;\r\n    company_id: string;\r\n    name: string;\r\n    priority: number;\r\n    enabled: boolean;\r\n    conditions: {\r\n        source?: string;\r\n        budget_min?: number;\r\n        budget_max?: number;\r\n        location?: string;\r\n        property_type?: string;\r\n    };\r\n    assign_to_agent_id: string | null;\r\n    created_at: string;\r\n    updated_at: string;\r\n}\r\n\r\nexport function useAssignmentConfig() {\r\n    const { profile } = useAuth();\r\n    const [config, setConfig] = useState<AssignmentConfig | null>(null);\r\n    const [isLoading, setIsLoading] = useState(true);\r\n    const [error, setError] = useState<string | null>(null);\r\n\r\n    const fetchConfig = useCallback(async () => {\r\n        if (!profile?.company_id) {\r\n            setIsLoading(false);\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from(\"lead_assignment_config\")\r\n                .select(\"*\")\r\n                .eq(\"company_id\", profile.company_id)\r\n                .single();\r\n\r\n            if (error) {\r\n                // If no config exists, create default one\r\n                if (error.code === \"PGRST116\") {\r\n                    const { data: newConfig, error: createError } = await supabase\r\n                        .from(\"lead_assignment_config\")\r\n                        .insert({\r\n                            company_id: profile.company_id,\r\n                            assignment_method: \"manual\",\r\n                            enabled_agent_ids: [],\r\n                            agent_leads_per_round: {},\r\n                        })\r\n                        .select()\r\n                        .single();\r\n\r\n                    if (createError) throw createError;\r\n                    setConfig(newConfig);\r\n                } else {\r\n                    throw error;\r\n                }\r\n            } else {\r\n                setConfig(data);\r\n            }\r\n        } catch (err: any) {\r\n            console.error(\"Error fetching assignment config:\", err);\r\n            setError(err.message);\r\n            toast.error(\"Failed to load assignment configuration\");\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    }, [profile?.company_id]);\r\n\r\n    useEffect(() => {\r\n        fetchConfig();\r\n    }, [fetchConfig]);\r\n\r\n    const updateConfig = async (\r\n        updates: Partial<Omit<AssignmentConfig, \"id\" | \"company_id\" | \"created_at\" | \"updated_at\">>\r\n    ) => {\r\n        if (!profile?.company_id) {\r\n            toast.error(\"No company found\");\r\n            return false;\r\n        }\r\n\r\n        // If no config exists, create it first\r\n        if (!config) {\r\n\r\n            try {\r\n                const { data: newConfig, error: createError } = await supabase\r\n                    .from(\"lead_assignment_config\")\r\n                    .insert({\r\n                        company_id: profile.company_id,\r\n                        assignment_method: \"manual\",\r\n                        enabled_agent_ids: [],\r\n                        agent_leads_per_round: {},\r\n                        ...updates, // Apply the updates to the new config\r\n                    })\r\n                    .select()\r\n                    .single();\r\n\r\n                if (createError) {\r\n                    console.error(\"Error creating config:\", createError);\r\n                    toast.error(`Failed to create configuration: ${createError.message}`);\r\n                    return false;\r\n                }\r\n\r\n                setConfig(newConfig);\r\n                toast.success(\"Assignment configuration created and updated\");\r\n                return true;\r\n            } catch (err: any) {\r\n                console.error(\"Exception creating config:\", err);\r\n                toast.error(`Failed to create configuration: ${err.message}`);\r\n                return false;\r\n            }\r\n        }\r\n\r\n        // Update existing config\r\n        try {\r\n\r\n            const { data, error } = await supabase\r\n                .from(\"lead_assignment_config\")\r\n                .update(updates)\r\n                .eq(\"company_id\", profile.company_id)\r\n                .select()\r\n                .single();\r\n\r\n            if (error) {\r\n                console.error(\"Error updating config:\", error);\r\n                toast.error(`Failed to update: ${error.message}`);\r\n                return false;\r\n            }\r\n\r\n\r\n            setConfig(data);\r\n            toast.success(\"Assignment configuration updated\");\r\n            return true;\r\n        } catch (err: any) {\r\n            console.error(\"Exception updating config:\", err);\r\n            toast.error(`Failed to update: ${err.message}`);\r\n            return false;\r\n        }\r\n    };\r\n\r\n    const updateAssignmentMethod = async (method: \"manual\" | \"round_robin\" | \"rules\") => {\r\n\r\n        return updateConfig({ assignment_method: method });\r\n    };\r\n\r\n    const updateEnabledAgents = async (agentIds: string[], leadsPerRound: Record<string, number>) => {\r\n\r\n        return updateConfig({\r\n            enabled_agent_ids: agentIds,\r\n            agent_leads_per_round: leadsPerRound,\r\n        });\r\n    };\r\n\r\n    return {\r\n        config,\r\n        isLoading,\r\n        error,\r\n        refetch: fetchConfig,\r\n        updateConfig,\r\n        updateAssignmentMethod,\r\n        updateEnabledAgents,\r\n    };\r\n}\r\n\r\nexport function useAssignmentRules() {\r\n    const { profile } = useAuth();\r\n    const [rules, setRules] = useState<AssignmentRule[]>([]);\r\n    const [isLoading, setIsLoading] = useState(true);\r\n\r\n    const fetchRules = useCallback(async () => {\r\n        if (!profile?.company_id) {\r\n            setIsLoading(false);\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from(\"lead_assignment_rules\")\r\n                .select(\"*\")\r\n                .eq(\"company_id\", profile.company_id)\r\n                .order(\"priority\", { ascending: false });\r\n\r\n            if (error) throw error;\r\n            setRules(data || []);\r\n        } catch (err: any) {\r\n            console.error(\"Error fetching assignment rules:\", err);\r\n            toast.error(\"Failed to load assignment rules\");\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    }, [profile?.company_id]);\r\n\r\n    useEffect(() => {\r\n        fetchRules();\r\n    }, [fetchRules]);\r\n\r\n    const createRule = async (rule: Omit<AssignmentRule, \"id\" | \"company_id\" | \"created_at\" | \"updated_at\">) => {\r\n        if (!profile?.company_id) return false;\r\n\r\n        try {\r\n            const { error } = await supabase.from(\"lead_assignment_rules\").insert({\r\n                ...rule,\r\n                company_id: profile.company_id,\r\n            });\r\n\r\n            if (error) throw error;\r\n\r\n            toast.success(\"Assignment rule created\");\r\n            await fetchRules();\r\n            return true;\r\n        } catch (err: any) {\r\n            console.error(\"Error creating rule:\", err);\r\n            toast.error(\"Failed to create rule\");\r\n            return false;\r\n        }\r\n    };\r\n\r\n    const updateRule = async (id: string, updates: Partial<AssignmentRule>) => {\r\n        try {\r\n            const { error } = await supabase\r\n                .from(\"lead_assignment_rules\")\r\n                .update(updates)\r\n                .eq(\"id\", id);\r\n\r\n            if (error) throw error;\r\n\r\n            toast.success(\"Assignment rule updated\");\r\n            await fetchRules();\r\n            return true;\r\n        } catch (err: any) {\r\n            console.error(\"Error updating rule:\", err);\r\n            toast.error(\"Failed to update rule\");\r\n            return false;\r\n        }\r\n    };\r\n\r\n    const deleteRule = async (id: string) => {\r\n        try {\r\n            const { error } = await supabase\r\n                .from(\"lead_assignment_rules\")\r\n                .delete()\r\n                .eq(\"id\", id);\r\n\r\n            if (error) throw error;\r\n\r\n            toast.success(\"Assignment rule deleted\");\r\n            await fetchRules();\r\n            return true;\r\n        } catch (err: any) {\r\n            console.error(\"Error deleting rule:\", err);\r\n            toast.error(\"Failed to delete rule\");\r\n            return false;\r\n        }\r\n    };\r\n\r\n    return {\r\n        rules,\r\n        isLoading,\r\n        refetch: fetchRules,\r\n        createRule,\r\n        updateRule,\r\n        deleteRule,\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useAssignmentLogs.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":87,"column":81,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":87,"endColumn":84,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2535,2538],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2535,2538],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\n\r\nexport interface AssignmentLog {\r\n  id: string;\r\n  leadName: string;\r\n  leadEmail: string;\r\n  source: string;\r\n  assignedTo: string;\r\n  assignedToAvatar: string;\r\n  previousAgent: string | null;\r\n  rule: string;\r\n  method: \"Campaign Rule\" | \"Round Robin\" | \"Manual\" | \"Advanced Logic\" | \"Auto-Reassign\";\r\n  status: \"success\" | \"failed\" | \"pending\" | \"reassigned\";\r\n  timestamp: string;\r\n  responseTime: string | null;\r\n  notes: string;\r\n}\r\n\r\ninterface UseAssignmentLogsResult {\r\n  logs: AssignmentLog[];\r\n  isLoading: boolean;\r\n  error: string | null;\r\n  refetch: () => void;\r\n  stats: {\r\n    total: number;\r\n    success: number;\r\n    failed: number;\r\n    pending: number;\r\n    reassigned: number;\r\n  };\r\n  sources: string[];\r\n}\r\n\r\nexport function useAssignmentLogs(): UseAssignmentLogsResult {\r\n  const [logs, setLogs] = useState<AssignmentLog[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const fetchLogs = async () => {\r\n    setIsLoading(true);\r\n    setError(null);\r\n    \r\n    try {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) {\r\n        setLogs([]);\r\n        return;\r\n      }\r\n\r\n      const { data: profile } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"company_id\")\r\n        .eq(\"id\", user.id)\r\n        .single();\r\n\r\n      if (!profile?.company_id) {\r\n        setLogs([]);\r\n        return;\r\n      }\r\n\r\n      // Fetch assignment logs with related data\r\n      const { data: assignmentLogs, error: logsError } = await supabase\r\n        .from(\"lead_assignment_logs\")\r\n        .select(`\r\n          id,\r\n          assignment_method,\r\n          change_reason,\r\n          created_at,\r\n          can_undo,\r\n          undone_at,\r\n          lead:leads(id, name, email, source),\r\n          from_agent:agents!lead_assignment_logs_from_agent_id_fkey(id, name, avatar_url),\r\n          to_agent:agents!lead_assignment_logs_to_agent_id_fkey(id, name, avatar_url),\r\n          rule:campaign_assignment_rules(name)\r\n        `)\r\n        .eq(\"company_id\", profile.company_id)\r\n        .order(\"created_at\", { ascending: false })\r\n        .limit(100);\r\n\r\n      if (logsError) {\r\n        console.error(\"Error fetching assignment logs:\", logsError);\r\n        throw logsError;\r\n      }\r\n\r\n      // Transform to AssignmentLog format\r\n      const transformedLogs: AssignmentLog[] = (assignmentLogs || []).map((log: any) => {\r\n        const leadData = log.lead || {};\r\n        const toAgentData = log.to_agent || {};\r\n        const fromAgentData = log.from_agent;\r\n        const ruleData = log.rule;\r\n\r\n        // Map assignment_method to display format\r\n        let method: AssignmentLog[\"method\"] = \"Manual\";\r\n        switch (log.assignment_method) {\r\n          case \"campaign_rule\":\r\n            method = \"Campaign Rule\";\r\n            break;\r\n          case \"round_robin\":\r\n            method = \"Round Robin\";\r\n            break;\r\n          case \"manual\":\r\n            method = \"Manual\";\r\n            break;\r\n          case \"advanced_logic\":\r\n            method = \"Advanced Logic\";\r\n            break;\r\n          case \"auto_reassign\":\r\n            method = \"Auto-Reassign\";\r\n            break;\r\n        }\r\n\r\n        // Determine status\r\n        let status: AssignmentLog[\"status\"] = \"success\";\r\n        if (log.undone_at) {\r\n          status = \"reassigned\";\r\n        } else if (fromAgentData && toAgentData?.id !== fromAgentData?.id) {\r\n          status = \"reassigned\";\r\n        } else if (!toAgentData?.id) {\r\n          status = \"failed\";\r\n        }\r\n\r\n        return {\r\n          id: log.id,\r\n          leadName: leadData.name || \"Unknown Lead\",\r\n          leadEmail: leadData.email || \"\",\r\n          source: leadData.source || \"Unknown\",\r\n          assignedTo: toAgentData.name || \"Unassigned\",\r\n          assignedToAvatar: toAgentData.avatar_url || \"\",\r\n          previousAgent: fromAgentData?.name || null,\r\n          rule: ruleData?.name || log.change_reason || \"Direct Assignment\",\r\n          method,\r\n          status,\r\n          timestamp: log.created_at ? new Date(log.created_at).toLocaleString() : \"\",\r\n          responseTime: null, // Would need to calculate from activity logs\r\n          notes: log.change_reason || \"\",\r\n        };\r\n      });\r\n\r\n      setLogs(transformedLogs);\r\n    } catch (err) {\r\n      console.error(\"Failed to fetch assignment logs:\", err);\r\n      setError(err instanceof Error ? err.message : \"Failed to fetch logs\");\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchLogs();\r\n  }, []);\r\n\r\n  const stats = {\r\n    total: logs.length,\r\n    success: logs.filter(l => l.status === \"success\").length,\r\n    failed: logs.filter(l => l.status === \"failed\").length,\r\n    pending: logs.filter(l => l.status === \"pending\").length,\r\n    reassigned: logs.filter(l => l.status === \"reassigned\").length,\r\n  };\r\n\r\n  const sources = [...new Set(logs.map(l => l.source))];\r\n\r\n  return {\r\n    logs,\r\n    isLoading,\r\n    error,\r\n    refetch: fetchLogs,\r\n    stats,\r\n    sources,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useAutoCompany.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":77,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2424,2427],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2424,2427],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":77,"column":88,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":91,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2436,2439],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2436,2439],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":144,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":144,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4639,4642],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4639,4642],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\n\r\n/**\r\n * Hook that ensures the current user has a company assigned.\r\n * If the user doesn't have a company, one is automatically created for them.\r\n * This ensures all users have full access to all features.\r\n */\r\nexport function useAutoCompany() {\r\n  const { user, profile, refreshProfile } = useAuth();\r\n  const [companyId, setCompanyId] = useState<string | null>(profile?.company_id || null);\r\n  const [isLoading, setIsLoading] = useState(!profile?.company_id);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const isCreating = useRef(false);\r\n\r\n  useEffect(() => {\r\n    // If profile already has company_id, use it\r\n    if (profile?.company_id) {\r\n      setCompanyId(profile.company_id);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    // If no user, stop loading\r\n    if (!user) {\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    // Prevent duplicate creation attempts\r\n    if (isCreating.current) {\r\n      return;\r\n    }\r\n\r\n    let isMounted = true;\r\n\r\n    async function ensureCompany() {\r\n      isCreating.current = true;\r\n\r\n      try {\r\n\r\n\r\n        // Double-check profile in case context is stale\r\n        const { data: freshProfile, error: profileError } = await supabase\r\n          .from('profiles')\r\n          .select('company_id, first_name')\r\n          .eq('id', user.id)\r\n          .single();\r\n\r\n        if (profileError) {\r\n          console.error('[useAutoCompany] Error fetching profile:', profileError);\r\n          if (isMounted) {\r\n            setError('Failed to load profile');\r\n            setIsLoading(false);\r\n          }\r\n          isCreating.current = false;\r\n          return;\r\n        }\r\n\r\n        if (freshProfile?.company_id) {\r\n\r\n          if (isMounted) {\r\n            setCompanyId(freshProfile.company_id);\r\n            setIsLoading(false);\r\n          }\r\n          isCreating.current = false;\r\n          return;\r\n        }\r\n\r\n        // Create a new company for the user\r\n\r\n        const userName = freshProfile?.first_name || user.email?.split('@')[0] || 'User';\r\n        let companyName = `${userName}'s Company`;\r\n\r\n        // Try to create company, retry with timestamp if it fails (likely due to unique name)\r\n        const createCompanyAttempt = async (name: string): Promise<{ data: any, error: any }> => {\r\n          return await supabase\r\n            .from('companies')\r\n            .insert({\r\n              name: name,\r\n              country: 'AE',\r\n              currency: 'AED',\r\n              industry: 'brokerage',\r\n              lead_sources: [],\r\n              created_by: user.id,\r\n            })\r\n            .select('id')\r\n            .single();\r\n        };\r\n\r\n        let { data: newCompany, error: createError } = await createCompanyAttempt(companyName);\r\n\r\n        if (createError) {\r\n          // If error might be due to duplicate name, try appending random string\r\n          console.warn('[useAutoCompany] First creation attempt failed, retrying with unique name:', createError);\r\n          const timestamp = new Date().getTime().toString().slice(-4);\r\n          companyName = `${companyName} ${timestamp}`;\r\n          const retry = await createCompanyAttempt(companyName);\r\n          newCompany = retry.data;\r\n          createError = retry.error;\r\n        }\r\n\r\n        if (createError) {\r\n          console.error('[useAutoCompany] Error creating company:', createError);\r\n          if (isMounted) {\r\n            setError('Failed to create company');\r\n            setIsLoading(false);\r\n          }\r\n          isCreating.current = false;\r\n          return;\r\n        }\r\n\r\n        // Link company to profile and set user as admin\r\n        const { error: updateError } = await supabase\r\n          .from('profiles')\r\n          .update({\r\n            company_id: newCompany.id,\r\n            onboarding_completed: true,\r\n            role: 'admin'\r\n          })\r\n          .eq('id', user.id);\r\n\r\n        if (updateError) {\r\n          console.error('[useAutoCompany] Error linking company:', updateError);\r\n        } else {\r\n          // Also insert into user_roles (the security source of truth)\r\n          await supabase\r\n            .from('user_roles')\r\n            .insert({\r\n              user_id: user.id,\r\n              role: 'admin'\r\n            });\r\n\r\n          // Refresh the auth context profile\r\n          await refreshProfile?.();\r\n        }\r\n\r\n\r\n        if (isMounted) {\r\n          setCompanyId(newCompany.id);\r\n          setIsLoading(false);\r\n        }\r\n      } catch (err: any) {\r\n        console.error('[useAutoCompany] Unexpected error:', err);\r\n        if (isMounted) {\r\n          setError(err.message || 'Unexpected error');\r\n          setIsLoading(false);\r\n        }\r\n      } finally {\r\n        isCreating.current = false;\r\n      }\r\n    }\r\n\r\n    ensureCompany();\r\n\r\n    return () => {\r\n      isMounted = false;\r\n    };\r\n  }, [user, profile?.company_id, refreshProfile]);\r\n\r\n  return { companyId, isLoading, error };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useAutoSave.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":37,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1015,1018],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1015,1018],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useRef, useCallback, useState } from 'react';\r\n\r\n/**\r\n * Custom hook for debouncing a value\r\n * @param value - The value to debounce\r\n * @param delay - Delay in milliseconds\r\n * @returns The debounced value\r\n */\r\nexport function useDebounce<T>(value: T, delay: number): T {\r\n    const [debouncedValue, setDebouncedValue] = useState<T>(value);\r\n\r\n    useEffect(() => {\r\n        const handler = setTimeout(() => {\r\n            setDebouncedValue(value);\r\n        }, delay);\r\n\r\n        return () => {\r\n            clearTimeout(handler);\r\n        };\r\n    }, [value, delay]);\r\n\r\n    return debouncedValue;\r\n}\r\n\r\n/**\r\n * Custom hook for auto-save functionality\r\n * @param data - The data to auto-save\r\n * @param saveFunction - Function to call for saving\r\n * @param options - Configuration options\r\n */\r\ninterface UseAutoSaveOptions {\r\n    enabled?: boolean;\r\n    debounceMs?: number;\r\n    intervalMs?: number;\r\n    onSaveStart?: () => void;\r\n    onSaveSuccess?: () => void;\r\n    onSaveError?: (error: any) => void;\r\n}\r\n\r\nexport function useAutoSave<T>(\r\n    data: T,\r\n    saveFunction: (data: T) => Promise<void>,\r\n    options: UseAutoSaveOptions = {}\r\n) {\r\n    const {\r\n        enabled = true,\r\n        debounceMs = 3000,\r\n        intervalMs = 30000,\r\n        onSaveStart,\r\n        onSaveSuccess,\r\n        onSaveError,\r\n    } = options;\r\n\r\n    const [isSaving, setIsSaving] = useState(false);\r\n    const [lastSaved, setLastSaved] = useState<Date | null>(null);\r\n    const saveTimeoutRef = useRef<NodeJS.Timeout>();\r\n    const intervalRef = useRef<NodeJS.Timeout>();\r\n    const lastDataRef = useRef<T>(data);\r\n    const isFirstRender = useRef(true);\r\n\r\n    const save = useCallback(async () => {\r\n        if (!enabled) return;\r\n\r\n        try {\r\n            setIsSaving(true);\r\n            onSaveStart?.();\r\n            await saveFunction(data);\r\n            setLastSaved(new Date());\r\n            onSaveSuccess?.();\r\n        } catch (error) {\r\n            console.error('Auto-save error:', error);\r\n            onSaveError?.(error);\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    }, [data, saveFunction, enabled, onSaveStart, onSaveSuccess, onSaveError]);\r\n\r\n    // Debounced save on data change\r\n    useEffect(() => {\r\n        if (!enabled) return;\r\n\r\n        // Skip first render\r\n        if (isFirstRender.current) {\r\n            isFirstRender.current = false;\r\n            lastDataRef.current = data;\r\n            return;\r\n        }\r\n\r\n        // Check if data actually changed\r\n        if (JSON.stringify(data) === JSON.stringify(lastDataRef.current)) {\r\n            return;\r\n        }\r\n\r\n        lastDataRef.current = data;\r\n\r\n        // Clear existing timeout\r\n        if (saveTimeoutRef.current) {\r\n            clearTimeout(saveTimeoutRef.current);\r\n        }\r\n\r\n        // Set new timeout for debounced save\r\n        saveTimeoutRef.current = setTimeout(() => {\r\n            save();\r\n        }, debounceMs);\r\n\r\n        return () => {\r\n            if (saveTimeoutRef.current) {\r\n                clearTimeout(saveTimeoutRef.current);\r\n            }\r\n        };\r\n    }, [data, enabled, debounceMs, save]);\r\n\r\n    // Interval-based save\r\n    useEffect(() => {\r\n        if (!enabled || !intervalMs) return;\r\n\r\n        intervalRef.current = setInterval(() => {\r\n            save();\r\n        }, intervalMs);\r\n\r\n        return () => {\r\n            if (intervalRef.current) {\r\n                clearInterval(intervalRef.current);\r\n            }\r\n        };\r\n    }, [enabled, intervalMs, save]);\r\n\r\n    // Cleanup on unmount\r\n    useEffect(() => {\r\n        return () => {\r\n            if (saveTimeoutRef.current) {\r\n                clearTimeout(saveTimeoutRef.current);\r\n            }\r\n            if (intervalRef.current) {\r\n                clearInterval(intervalRef.current);\r\n            }\r\n        };\r\n    }, []);\r\n\r\n    return {\r\n        isSaving,\r\n        lastSaved,\r\n        forceSave: save,\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useChatbotAnalytics.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":119,"column":89,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":92,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4104,4107],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4104,4107],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchAnalytics'. Either include it or remove the dependency array.","line":153,"column":6,"nodeType":"ArrayExpression","endLine":153,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [chatbotId, fetchAnalytics]","fix":{"range":[5159,5170],"text":"[chatbotId, fetchAnalytics]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\n\r\nexport interface BotStats {\r\n  totalConversations: number;\r\n  activeNow: number;\r\n  leadsQualified: number;\r\n  handoversToday: number;\r\n  avgResponseTime: string;\r\n  satisfactionRate: number;\r\n}\r\n\r\nexport interface RecentActivity {\r\n  id: string;\r\n  type: 'message' | 'qualification' | 'handover' | 'error';\r\n  content: string;\r\n  timestamp: Date;\r\n}\r\n\r\ninterface UseChatbotAnalyticsResult {\r\n  stats: BotStats;\r\n  activities: RecentActivity[];\r\n  isLoading: boolean;\r\n  error: string | null;\r\n  refetch: () => void;\r\n}\r\n\r\nexport function useChatbotAnalytics(chatbotId?: string): UseChatbotAnalyticsResult {\r\n  const [stats, setStats] = useState<BotStats>({\r\n    totalConversations: 0,\r\n    activeNow: 0,\r\n    leadsQualified: 0,\r\n    handoversToday: 0,\r\n    avgResponseTime: \"0s\",\r\n    satisfactionRate: 0,\r\n  });\r\n  const [activities, setActivities] = useState<RecentActivity[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const fetchAnalytics = async () => {\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) return;\r\n\r\n      const { data: profile } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"company_id\")\r\n        .eq(\"id\", user.id)\r\n        .single();\r\n\r\n      if (!profile?.company_id) return;\r\n\r\n      // Get today's date for filtering\r\n      const today = new Date();\r\n      today.setHours(0, 0, 0, 0);\r\n\r\n      // Build query for chatbot analytics\r\n      let analyticsQuery = supabase\r\n        .from(\"chatbot_analytics\")\r\n        .select(\"*\")\r\n        .eq(\"company_id\", profile.company_id)\r\n        .order(\"date\", { ascending: false })\r\n        .limit(30);\r\n\r\n      if (chatbotId) {\r\n        analyticsQuery = analyticsQuery.eq(\"chatbot_id\", chatbotId);\r\n      }\r\n\r\n      const { data: analyticsData } = await analyticsQuery;\r\n\r\n      // Calculate aggregated stats\r\n      const totalStats = (analyticsData || []).reduce((acc, day) => {\r\n        acc.totalConversations += day.unique_leads || 0;\r\n        acc.leadsQualified += day.new_leads_created || 0;\r\n        acc.messagesSent += day.messages_sent || 0;\r\n        acc.messagesReceived += day.messages_received || 0;\r\n        acc.avgResponseTime += day.avg_response_time_ms || 0;\r\n        return acc;\r\n      }, { totalConversations: 0, leadsQualified: 0, messagesSent: 0, messagesReceived: 0, avgResponseTime: 0 });\r\n\r\n      // Get active sessions count\r\n      const { count: activeSessions } = await supabase\r\n        .from(\"chatbot_sessions\")\r\n        .select(\"*\", { count: \"exact\", head: true })\r\n        .eq(\"company_id\", profile.company_id)\r\n        .gte(\"last_message_at\", new Date(Date.now() - 10 * 60 * 1000).toISOString());\r\n\r\n      // Calculate average response time\r\n      const avgMs = analyticsData?.length ? totalStats.avgResponseTime / analyticsData.length : 0;\r\n      const avgResponseTime = avgMs < 1000 ? `${Math.round(avgMs)}ms` : `${(avgMs / 1000).toFixed(1)}s`;\r\n\r\n      setStats({\r\n        totalConversations: totalStats.totalConversations,\r\n        activeNow: activeSessions || 0,\r\n        leadsQualified: totalStats.leadsQualified,\r\n        handoversToday: 0, // Would need to track handover events\r\n        avgResponseTime,\r\n        satisfactionRate: 0, // Would need satisfaction feedback system\r\n      });\r\n\r\n      // Fetch recent interactions for activity feed\r\n      let interactionsQuery = supabase\r\n        .from(\"chatbot_interactions\")\r\n        .select(\"id, direction, message_content, message_type, created_at, status, lead_id\")\r\n        .eq(\"company_id\", profile.company_id)\r\n        .order(\"created_at\", { ascending: false })\r\n        .limit(20);\r\n\r\n      if (chatbotId) {\r\n        interactionsQuery = interactionsQuery.eq(\"chatbot_id\", chatbotId);\r\n      }\r\n\r\n      const { data: interactions } = await interactionsQuery;\r\n\r\n      const recentActivities: RecentActivity[] = (interactions || []).map((interaction: any) => {\r\n        let type: RecentActivity['type'] = 'message';\r\n        let content = '';\r\n\r\n        if (interaction.status === 'error') {\r\n          type = 'error';\r\n          content = 'Error sending message';\r\n        } else if (interaction.direction === 'inbound') {\r\n          type = 'message';\r\n          content = `New message received: \"${(interaction.message_content || '').substring(0, 50)}...\"`;\r\n        } else {\r\n          type = 'message';\r\n          content = `Bot responded: \"${(interaction.message_content || '').substring(0, 50)}...\"`;\r\n        }\r\n\r\n        return {\r\n          id: interaction.id,\r\n          type,\r\n          content,\r\n          timestamp: new Date(interaction.created_at),\r\n        };\r\n      });\r\n\r\n      setActivities(recentActivities);\r\n    } catch (err) {\r\n      console.error(\"Failed to fetch chatbot analytics:\", err);\r\n      setError(err instanceof Error ? err.message : \"Failed to fetch analytics\");\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchAnalytics();\r\n  }, [chatbotId]);\r\n\r\n  return {\r\n    stats,\r\n    activities,\r\n    isLoading,\r\n    error,\r\n    refetch: fetchAnalytics,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useChatbots.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":270,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":270,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10598,10601],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10598,10601],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":319,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":319,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12399,12402],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12399,12402],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":355,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":355,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14352,14355],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14352,14355],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":374,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":374,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14905,14908],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14905,14908],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { toast } from 'sonner';\r\n\r\nexport type LLMProvider = 'lovable' | 'openai' | 'anthropic' | 'google' | 'deepseek' | 'groq' | 'mistral' | 'xai' | 'cohere' | 'together' | 'perplexity' | 'fireworks' | 'replicate' | 'ai21' | 'cerebras' | 'sambanova' | 'custom';\r\n\r\nexport interface Chatbot {\r\n  id: string;\r\n  company_id: string | null;\r\n  name: string;\r\n  description: string | null;\r\n  whatsapp_connection_id: string | null;\r\n  llm_provider: LLMProvider;\r\n  llm_model: string;\r\n  llm_api_key_encrypted: string | null;\r\n  system_prompt: string | null;\r\n  welcome_message: string | null;\r\n  qualification_questions: { question: string; field: string }[];\r\n  is_active: boolean;\r\n  auto_create_leads: boolean;\r\n  max_tokens: number;\r\n  temperature: number;\r\n  created_at: string;\r\n  updated_at: string;\r\n  created_by: string | null;\r\n}\r\n\r\nexport interface ChatbotInput {\r\n  name: string;\r\n  description?: string;\r\n  whatsapp_connection_id?: string;\r\n  llm_provider: LLMProvider;\r\n  llm_model: string;\r\n  llm_api_key?: string;\r\n  system_prompt?: string;\r\n  welcome_message?: string;\r\n  qualification_questions?: { question: string; field: string }[];\r\n  is_active?: boolean;\r\n  auto_create_leads?: boolean;\r\n  max_tokens?: number;\r\n  temperature?: number;\r\n}\r\n\r\nexport const LLM_PROVIDERS: Record<LLMProvider, {\r\n  name: string;\r\n  description: string;\r\n  models: { id: string; name: string; description: string }[];\r\n  requiresApiKey: boolean;\r\n  baseUrl?: string;\r\n}> = {\r\n  lovable: {\r\n    name: 'Lovable AI',\r\n    description: 'Built-in AI (no API key required)',\r\n    models: [\r\n      { id: 'google/gemini-2.5-flash', name: 'Gemini 2.5 Flash', description: 'Fast and efficient' },\r\n      { id: 'google/gemini-2.5-pro', name: 'Gemini 2.5 Pro', description: 'Most capable' },\r\n      { id: 'google/gemini-2.5-flash-lite', name: 'Gemini 2.5 Flash Lite', description: 'Fastest, cheapest' },\r\n      { id: 'openai/gpt-5', name: 'GPT-5', description: 'Powerful all-rounder' },\r\n      { id: 'openai/gpt-5-mini', name: 'GPT-5 Mini', description: 'Fast and affordable' },\r\n    ],\r\n    requiresApiKey: false,\r\n  },\r\n  openai: {\r\n    name: 'OpenAI',\r\n    description: 'GPT models from OpenAI',\r\n    models: [\r\n      { id: 'gpt-4o', name: 'GPT-4o', description: 'Latest flagship model' },\r\n      { id: 'gpt-4o-mini', name: 'GPT-4o Mini', description: 'Fast and affordable' },\r\n      { id: 'gpt-4-turbo', name: 'GPT-4 Turbo', description: 'High capability' },\r\n      { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo', description: 'Fast legacy model' },\r\n    ],\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://api.openai.com/v1',\r\n  },\r\n  anthropic: {\r\n    name: 'Anthropic',\r\n    description: 'Claude models from Anthropic',\r\n    models: [\r\n      { id: 'claude-sonnet-4-5', name: 'Claude Sonnet 4.5', description: 'Most intelligent' },\r\n      { id: 'claude-3-5-sonnet-20241022', name: 'Claude 3.5 Sonnet', description: 'Balanced performance' },\r\n      { id: 'claude-3-5-haiku-20241022', name: 'Claude 3.5 Haiku', description: 'Fastest responses' },\r\n    ],\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://api.anthropic.com',\r\n  },\r\n  google: {\r\n    name: 'Google AI',\r\n    description: 'Gemini models directly from Google',\r\n    models: [\r\n      { id: 'gemini-2.0-flash', name: 'Gemini 2.0 Flash', description: 'Latest fast model' },\r\n      { id: 'gemini-1.5-pro', name: 'Gemini 1.5 Pro', description: 'Most capable' },\r\n      { id: 'gemini-1.5-flash', name: 'Gemini 1.5 Flash', description: 'Fast and efficient' },\r\n    ],\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://generativelanguage.googleapis.com',\r\n  },\r\n  deepseek: {\r\n    name: 'DeepSeek',\r\n    description: 'DeepSeek AI models',\r\n    models: [\r\n      { id: 'deepseek-chat', name: 'DeepSeek Chat', description: 'General purpose chat' },\r\n      { id: 'deepseek-coder', name: 'DeepSeek Coder', description: 'Optimized for code' },\r\n      { id: 'deepseek-reasoner', name: 'DeepSeek Reasoner', description: 'Advanced reasoning' },\r\n    ],\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://api.deepseek.com',\r\n  },\r\n  groq: {\r\n    name: 'Groq',\r\n    description: 'Ultra-fast inference with Groq',\r\n    models: [\r\n      { id: 'llama-3.3-70b-versatile', name: 'Llama 3.3 70B', description: 'Powerful and fast' },\r\n      { id: 'llama-3.1-8b-instant', name: 'Llama 3.1 8B', description: 'Ultra fast' },\r\n      { id: 'mixtral-8x7b-32768', name: 'Mixtral 8x7B', description: 'Great balance' },\r\n    ],\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://api.groq.com/openai/v1',\r\n  },\r\n  mistral: {\r\n    name: 'Mistral AI',\r\n    description: 'Mistral AI models',\r\n    models: [\r\n      { id: 'mistral-large-latest', name: 'Mistral Large', description: 'Most capable' },\r\n      { id: 'mistral-medium-latest', name: 'Mistral Medium', description: 'Balanced' },\r\n      { id: 'mistral-small-latest', name: 'Mistral Small', description: 'Fast and efficient' },\r\n    ],\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://api.mistral.ai/v1',\r\n  },\r\n  xai: {\r\n    name: 'xAI (Grok)',\r\n    description: 'Grok models from xAI',\r\n    models: [\r\n      { id: 'grok-2', name: 'Grok 2', description: 'Latest flagship model' },\r\n      { id: 'grok-2-mini', name: 'Grok 2 Mini', description: 'Fast and efficient' },\r\n      { id: 'grok-beta', name: 'Grok Beta', description: 'Experimental features' },\r\n    ],\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://api.x.ai/v1',\r\n  },\r\n  cohere: {\r\n    name: 'Cohere',\r\n    description: 'Enterprise-grade AI models',\r\n    models: [\r\n      { id: 'command-r-plus', name: 'Command R+', description: 'Most powerful' },\r\n      { id: 'command-r', name: 'Command R', description: 'Balanced performance' },\r\n      { id: 'command-light', name: 'Command Light', description: 'Fast responses' },\r\n    ],\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://api.cohere.ai/v1',\r\n  },\r\n  together: {\r\n    name: 'Together AI',\r\n    description: 'Open source models hosted by Together',\r\n    models: [\r\n      { id: 'meta-llama/Llama-3.3-70B-Instruct-Turbo', name: 'Llama 3.3 70B', description: 'Powerful open model' },\r\n      { id: 'meta-llama/Llama-3.1-8B-Instruct-Turbo', name: 'Llama 3.1 8B', description: 'Fast and efficient' },\r\n      { id: 'Qwen/Qwen2.5-72B-Instruct-Turbo', name: 'Qwen 2.5 72B', description: 'High capability' },\r\n      { id: 'mistralai/Mixtral-8x22B-Instruct-v0.1', name: 'Mixtral 8x22B', description: 'Large MoE model' },\r\n    ],\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://api.together.xyz/v1',\r\n  },\r\n  perplexity: {\r\n    name: 'Perplexity',\r\n    description: 'AI with real-time web search',\r\n    models: [\r\n      { id: 'llama-3.1-sonar-large-128k-online', name: 'Sonar Large Online', description: 'With web search' },\r\n      { id: 'llama-3.1-sonar-small-128k-online', name: 'Sonar Small Online', description: 'Fast with search' },\r\n      { id: 'llama-3.1-sonar-large-128k-chat', name: 'Sonar Large Chat', description: 'Chat without search' },\r\n    ],\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://api.perplexity.ai',\r\n  },\r\n  fireworks: {\r\n    name: 'Fireworks AI',\r\n    description: 'Fast inference for open models',\r\n    models: [\r\n      { id: 'accounts/fireworks/models/llama-v3p3-70b-instruct', name: 'Llama 3.3 70B', description: 'Powerful' },\r\n      { id: 'accounts/fireworks/models/llama-v3p1-8b-instruct', name: 'Llama 3.1 8B', description: 'Fast' },\r\n      { id: 'accounts/fireworks/models/mixtral-8x22b-instruct', name: 'Mixtral 8x22B', description: 'MoE model' },\r\n    ],\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://api.fireworks.ai/inference/v1',\r\n  },\r\n  replicate: {\r\n    name: 'Replicate',\r\n    description: 'Run open-source models',\r\n    models: [\r\n      { id: 'meta/llama-3.3-70b-instruct', name: 'Llama 3.3 70B', description: 'Powerful' },\r\n      { id: 'meta/llama-3.1-8b-instruct', name: 'Llama 3.1 8B', description: 'Fast' },\r\n      { id: 'mistralai/mixtral-8x7b-instruct-v0.1', name: 'Mixtral 8x7B', description: 'Balanced' },\r\n    ],\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://api.replicate.com/v1',\r\n  },\r\n  ai21: {\r\n    name: 'AI21 Labs',\r\n    description: 'Jamba models from AI21',\r\n    models: [\r\n      { id: 'jamba-1.5-large', name: 'Jamba 1.5 Large', description: 'Most capable' },\r\n      { id: 'jamba-1.5-mini', name: 'Jamba 1.5 Mini', description: 'Fast and efficient' },\r\n    ],\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://api.ai21.com/studio/v1',\r\n  },\r\n  cerebras: {\r\n    name: 'Cerebras',\r\n    description: 'Ultra-fast inference',\r\n    models: [\r\n      { id: 'llama3.3-70b', name: 'Llama 3.3 70B', description: 'Extremely fast' },\r\n      { id: 'llama3.1-8b', name: 'Llama 3.1 8B', description: 'Ultra fast' },\r\n    ],\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://api.cerebras.ai/v1',\r\n  },\r\n  sambanova: {\r\n    name: 'SambaNova',\r\n    description: 'Enterprise AI platform',\r\n    models: [\r\n      { id: 'Meta-Llama-3.3-70B-Instruct', name: 'Llama 3.3 70B', description: 'High performance' },\r\n      { id: 'Meta-Llama-3.1-8B-Instruct', name: 'Llama 3.1 8B', description: 'Fast' },\r\n    ],\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://api.sambanova.ai/v1',\r\n  },\r\n  custom: {\r\n    name: 'Custom API',\r\n    description: 'Use any OpenAI-compatible API',\r\n    models: [\r\n      { id: 'custom', name: 'Custom Model', description: 'Specify your own model' },\r\n    ],\r\n    requiresApiKey: true,\r\n  },\r\n};\r\n\r\nexport function useChatbots() {\r\n  const { user, profile } = useAuth();\r\n  const [chatbots, setChatbots] = useState<Chatbot[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const fetchChatbots = useCallback(async () => {\r\n    if (!user || !profile?.company_id) {\r\n      setChatbots([]);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setIsLoading(true);\r\n      const { data, error: fetchError } = await supabase\r\n        .from('chatbots')\r\n        .select('*')\r\n        .eq('company_id', profile.company_id)\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (fetchError) throw fetchError;\r\n\r\n      const mapped: Chatbot[] = (data || []).map(row => ({\r\n        ...row,\r\n        llm_provider: row.llm_provider as LLMProvider,\r\n        qualification_questions: (row.qualification_questions || []) as { question: string; field: string }[],\r\n        temperature: Number(row.temperature),\r\n      }));\r\n\r\n      setChatbots(mapped);\r\n      setError(null);\r\n    } catch (err: any) {\r\n      console.error('Error fetching chatbots:', err);\r\n      setError(err.message);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [user, profile?.company_id]);\r\n\r\n  const createChatbot = useCallback(async (input: ChatbotInput): Promise<Chatbot | null> => {\r\n    if (!user || !profile?.company_id) {\r\n      toast.error('Please log in to create chatbots');\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      const { data, error: insertError } = await supabase\r\n        .from('chatbots')\r\n        .insert({\r\n          company_id: profile.company_id,\r\n          name: input.name,\r\n          description: input.description,\r\n          whatsapp_connection_id: input.whatsapp_connection_id,\r\n          llm_provider: input.llm_provider,\r\n          llm_model: input.llm_model,\r\n          llm_api_key_encrypted: input.llm_api_key, // In production, encrypt this\r\n          system_prompt: input.system_prompt,\r\n          welcome_message: input.welcome_message,\r\n          qualification_questions: input.qualification_questions || [],\r\n          is_active: input.is_active ?? true,\r\n          auto_create_leads: input.auto_create_leads ?? true,\r\n          max_tokens: input.max_tokens ?? 1000,\r\n          temperature: input.temperature ?? 0.7,\r\n          created_by: user.id,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (insertError) throw insertError;\r\n\r\n      const mapped: Chatbot = {\r\n        ...data,\r\n        llm_provider: data.llm_provider as LLMProvider,\r\n        qualification_questions: (data.qualification_questions || []) as { question: string; field: string }[],\r\n        temperature: Number(data.temperature),\r\n      };\r\n\r\n      setChatbots(prev => [mapped, ...prev]);\r\n      toast.success('Chatbot created successfully');\r\n      return mapped;\r\n    } catch (err: any) {\r\n      console.error('Error creating chatbot:', err);\r\n      toast.error('Failed to create chatbot');\r\n      return null;\r\n    }\r\n  }, [user, profile?.company_id]);\r\n\r\n  const updateChatbot = useCallback(async (id: string, updates: Partial<ChatbotInput>): Promise<boolean> => {\r\n    try {\r\n      const dbUpdates: Record<string, unknown> = {};\r\n      if (updates.name) dbUpdates.name = updates.name;\r\n      if (updates.description !== undefined) dbUpdates.description = updates.description;\r\n      if (updates.whatsapp_connection_id !== undefined) dbUpdates.whatsapp_connection_id = updates.whatsapp_connection_id;\r\n      if (updates.llm_provider) dbUpdates.llm_provider = updates.llm_provider;\r\n      if (updates.llm_model) dbUpdates.llm_model = updates.llm_model;\r\n      if (updates.llm_api_key !== undefined) dbUpdates.llm_api_key_encrypted = updates.llm_api_key;\r\n      if (updates.system_prompt !== undefined) dbUpdates.system_prompt = updates.system_prompt;\r\n      if (updates.welcome_message !== undefined) dbUpdates.welcome_message = updates.welcome_message;\r\n      if (updates.qualification_questions !== undefined) dbUpdates.qualification_questions = updates.qualification_questions;\r\n      if (updates.is_active !== undefined) dbUpdates.is_active = updates.is_active;\r\n      if (updates.auto_create_leads !== undefined) dbUpdates.auto_create_leads = updates.auto_create_leads;\r\n      if (updates.max_tokens !== undefined) dbUpdates.max_tokens = updates.max_tokens;\r\n      if (updates.temperature !== undefined) dbUpdates.temperature = updates.temperature;\r\n\r\n      const { error: updateError } = await supabase\r\n        .from('chatbots')\r\n        .update(dbUpdates)\r\n        .eq('id', id);\r\n\r\n      if (updateError) throw updateError;\r\n\r\n      setChatbots(prev =>\r\n        prev.map(bot => bot.id === id ? { ...bot, ...updates } as Chatbot : bot)\r\n      );\r\n      toast.success('Chatbot updated');\r\n      return true;\r\n    } catch (err: any) {\r\n      console.error('Error updating chatbot:', err);\r\n      toast.error('Failed to update chatbot');\r\n      return false;\r\n    }\r\n  }, []);\r\n\r\n  const deleteChatbot = useCallback(async (id: string): Promise<boolean> => {\r\n    try {\r\n      const { error: deleteError } = await supabase\r\n        .from('chatbots')\r\n        .delete()\r\n        .eq('id', id);\r\n\r\n      if (deleteError) throw deleteError;\r\n\r\n      setChatbots(prev => prev.filter(bot => bot.id !== id));\r\n      toast.success('Chatbot deleted');\r\n      return true;\r\n    } catch (err: any) {\r\n      console.error('Error deleting chatbot:', err);\r\n      toast.error('Failed to delete chatbot');\r\n      return false;\r\n    }\r\n  }, []);\r\n\r\n  const toggleChatbot = useCallback(async (id: string): Promise<boolean> => {\r\n    const chatbot = chatbots.find(b => b.id === id);\r\n    if (!chatbot) return false;\r\n    return updateChatbot(id, { is_active: !chatbot.is_active });\r\n  }, [chatbots, updateChatbot]);\r\n\r\n  useEffect(() => {\r\n    fetchChatbots();\r\n  }, [fetchChatbots]);\r\n\r\n  return {\r\n    chatbots,\r\n    isLoading,\r\n    error,\r\n    createChatbot,\r\n    updateChatbot,\r\n    deleteChatbot,\r\n    toggleChatbot,\r\n    refetch: fetchChatbots,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useCompany.ts","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchCompany'. Either include it or remove the dependency array.","line":46,"column":6,"nodeType":"ArrayExpression","endLine":46,"endColumn":27,"suggestions":[{"desc":"Update the dependencies array to be: [fetchCompany, profile?.company_id]","fix":{"range":[1439,1460],"text":"[fetchCompany, profile?.company_id]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { toast } from 'sonner';\r\nimport { allCountries } from '@/components/ui/country-select';\r\n\r\nexport type Company = {\r\n  id: string;\r\n  name: string;\r\n  country: string;\r\n  currency: string;\r\n  industry: string;\r\n  lead_sources: string[];\r\n  created_by: string | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\n// Re-export for backward compatibility\r\nconst countries = allCountries.map(c => ({ code: c.code, name: c.name }));\r\n\r\n// Get unique currencies from all countries\r\nconst currencies = [...new Set(allCountries.map(c => c.currency))].sort();\r\n\r\nconst industries = [\r\n  { id: 'brokerage', label: 'Real Estate Brokerage' },\r\n  { id: 'developer', label: 'Developer' },\r\n  { id: 'property-management', label: 'Property Management' },\r\n  { id: 'holiday-homes', label: 'Holiday Homes / Short Stay' },\r\n  { id: 'mortgage', label: 'Mortgage Brokerage' },\r\n  { id: 'other', label: 'Other' },\r\n];\r\n\r\nexport function useCompany() {\r\n  const { profile } = useAuth();\r\n  const [company, setCompany] = useState<Company | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isSaving, setIsSaving] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (profile?.company_id) {\r\n      fetchCompany();\r\n    } else {\r\n      setIsLoading(false);\r\n    }\r\n  }, [profile?.company_id]);\r\n\r\n  const fetchCompany = async () => {\r\n    if (!profile?.company_id) return;\r\n    \r\n    setIsLoading(true);\r\n    const { data, error } = await supabase\r\n      .from('companies')\r\n      .select('*')\r\n      .eq('id', profile.company_id)\r\n      .maybeSingle();\r\n\r\n    if (error) {\r\n      console.error('Error fetching company:', error);\r\n    } else {\r\n      setCompany(data);\r\n    }\r\n    setIsLoading(false);\r\n  };\r\n\r\n  const updateCompany = async (updates: Partial<Pick<Company, 'name' | 'country' | 'currency' | 'industry'>>) => {\r\n    if (!company?.id) return { error: new Error('No company found') };\r\n\r\n    setIsSaving(true);\r\n    const { error } = await supabase\r\n      .from('companies')\r\n      .update(updates)\r\n      .eq('id', company.id);\r\n\r\n    if (error) {\r\n      toast.error('Failed to update company settings');\r\n      console.error('Error updating company:', error);\r\n    } else {\r\n      setCompany(prev => prev ? { ...prev, ...updates } : null);\r\n      toast.success('Company settings saved');\r\n    }\r\n    setIsSaving(false);\r\n    return { error };\r\n  };\r\n\r\n  const createCompany = async (data: { name: string; country: string; currency: string; industry: string }) => {\r\n    if (!profile?.id) return { error: new Error('No user found') };\r\n\r\n    setIsSaving(true);\r\n    const { data: newCompany, error: companyError } = await supabase\r\n      .from('companies')\r\n      .insert({\r\n        name: data.name,\r\n        country: data.country,\r\n        currency: data.currency,\r\n        industry: data.industry,\r\n        lead_sources: [],\r\n        created_by: profile.id,\r\n      })\r\n      .select('*')\r\n      .single();\r\n\r\n    if (companyError) {\r\n      toast.error('Failed to create company');\r\n      console.error('Error creating company:', companyError);\r\n      setIsSaving(false);\r\n      return { error: companyError };\r\n    }\r\n\r\n    // Update profile with company_id\r\n    const { error: profileError } = await supabase\r\n      .from('profiles')\r\n      .update({\r\n        company_id: newCompany.id,\r\n        onboarding_completed: true,\r\n      })\r\n      .eq('id', profile.id);\r\n\r\n    if (profileError) {\r\n      toast.error('Failed to link company to profile');\r\n      console.error('Error updating profile:', profileError);\r\n      setIsSaving(false);\r\n      return { error: profileError };\r\n    }\r\n\r\n    setCompany(newCompany);\r\n    toast.success('Company created successfully');\r\n    setIsSaving(false);\r\n    \r\n    // Reload page to refresh auth context\r\n    window.location.reload();\r\n    return { error: null };\r\n  };\r\n\r\n  return {\r\n    company,\r\n    isLoading,\r\n    isSaving,\r\n    updateCompany,\r\n    createCompany,\r\n    refetch: fetchCompany,\r\n    countries,\r\n    currencies,\r\n    industries,\r\n  };\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useCompanyListings.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'analyticsMap' is never reassigned. Use 'const' instead.","line":105,"column":11,"nodeType":"Identifier","messageId":"useConst","endLine":105,"endColumn":77,"fix":{"range":[2777,2853],"text":"const analyticsMap: Record<string, { views: number; inquiries: number }> = {};"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":126,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3611,3614],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3611,3614],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":157,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":157,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4835,4838],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4835,4838],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback, useRef } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\n\r\nexport interface CompanyListing {\r\n  id: string;\r\n  title: string;\r\n  description: string | null;\r\n  price: number | null;\r\n  currency: string;\r\n  address: string | null;\r\n  city: string | null;\r\n  country: string | null;\r\n  bedrooms: number | null;\r\n  bathrooms: number | null;\r\n  size: number | null;\r\n  size_unit: string | null;\r\n  property_type: string | null;\r\n  listing_type: string | null;\r\n  status: string;\r\n  images: string[] | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n  reference_number: string | null;\r\n  assigned_agent_id: string | null;\r\n  company_id: string | null;\r\n  // Joined data\r\n  agent: {\r\n    id: string;\r\n    name: string;\r\n    avatar_url: string | null;\r\n  } | null;\r\n  // Computed for UI\r\n  views: number;\r\n  inquiries: number;\r\n}\r\n\r\ninterface ListingStats {\r\n  total: number;\r\n  active: number;\r\n  totalViews: number;\r\n  totalInquiries: number;\r\n  uniqueAgents: number;\r\n}\r\n\r\nexport function useCompanyListings() {\r\n  const { user } = useAuth();\r\n  const [listings, setListings] = useState<CompanyListing[]>([]);\r\n  const [stats, setStats] = useState<ListingStats>({\r\n    total: 0,\r\n    active: 0,\r\n    totalViews: 0,\r\n    totalInquiries: 0,\r\n    uniqueAgents: 0,\r\n  });\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const fetchListingsRef = useRef<(() => Promise<void>) | null>(null);\r\n\r\n  const fetchListings = useCallback(async () => {\r\n    if (!user) {\r\n      setListings([]);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      // Get user's company_id through agents table\r\n      const { data: agent } = await supabase\r\n        .from(\"agents\")\r\n        .select(\"company_id\")\r\n        .eq(\"user_id\", user.id)\r\n        .maybeSingle();\r\n\r\n      if (!agent?.company_id) {\r\n        setListings([]);\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n\r\n      // Fetch all listings for the company with agent info\r\n      const { data, error: fetchError } = await supabase\r\n        .from(\"listings\")\r\n        .select(`\r\n          *,\r\n          agents:assigned_agent_id (\r\n            id,\r\n            name,\r\n            avatar_url\r\n          )\r\n        `)\r\n        .eq(\"company_id\", agent.company_id)\r\n        .in(\"status\", [\"active\", \"published\", \"Active\"]) // checking both cases to be safe\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (fetchError) {\r\n        throw fetchError;\r\n      }\r\n\r\n      // Fetch analytics for all listings\r\n      const listingIds = (data || []).map((l) => l.id);\r\n      let analyticsMap: Record<string, { views: number; inquiries: number }> = {};\r\n\r\n      if (listingIds.length > 0) {\r\n        const { data: analytics } = await supabase\r\n          .from(\"listing_analytics\")\r\n          .select(\"listing_id, views_count, inquiries_count\")\r\n          .in(\"listing_id\", listingIds);\r\n\r\n        if (analytics) {\r\n          // Aggregate analytics per listing\r\n          analytics.forEach((a) => {\r\n            if (!analyticsMap[a.listing_id]) {\r\n              analyticsMap[a.listing_id] = { views: 0, inquiries: 0 };\r\n            }\r\n            analyticsMap[a.listing_id].views += a.views_count || 0;\r\n            analyticsMap[a.listing_id].inquiries += a.inquiries_count || 0;\r\n          });\r\n        }\r\n      }\r\n\r\n      // Transform data\r\n      const transformed: CompanyListing[] = (data || []).map((item: any) => ({\r\n        ...item,\r\n        bedrooms: item.number_of_bedrooms,\r\n        bathrooms: item.number_of_bathrooms,\r\n        size: item.area_size ? `${item.area_size} ${item.area_unit || 'sqft'}` : \"N/A\",\r\n        location: item.address || item.city || \"Unknown Location\",\r\n        price: item.price ? `${item.currency || 'AED'} ${Number(item.price).toLocaleString()}` : \"Price on request\",\r\n        refNumber: item.reference_number,\r\n        agent: item.agents || null,\r\n        views: analyticsMap[item.id]?.views || 0,\r\n        inquiries: analyticsMap[item.id]?.inquiries || 0,\r\n      }));\r\n\r\n      setListings(transformed);\r\n\r\n      // Calculate stats\r\n      const uniqueAgentIds = new Set(\r\n        transformed\r\n          .filter((l) => l.assigned_agent_id)\r\n          .map((l) => l.assigned_agent_id)\r\n      );\r\n\r\n      setStats({\r\n        total: transformed.length,\r\n        active: transformed.filter(\r\n          (l) => l.status === \"active\" || l.status === \"published\"\r\n        ).length,\r\n        totalViews: transformed.reduce((sum, l) => sum + l.views, 0),\r\n        totalInquiries: transformed.reduce((sum, l) => sum + l.inquiries, 0),\r\n        uniqueAgents: uniqueAgentIds.size,\r\n      });\r\n    } catch (err: any) {\r\n      console.error(\"Error fetching company listings:\", err);\r\n      setError(err.message);\r\n      setListings([]);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [user]);\r\n\r\n  // Keep ref updated\r\n  useEffect(() => {\r\n    fetchListingsRef.current = fetchListings;\r\n  }, [fetchListings]);\r\n\r\n  useEffect(() => {\r\n    fetchListings();\r\n\r\n    // Subscribe to real-time changes\r\n    const channel = supabase\r\n      .channel(\"company-listings-realtime\")\r\n      .on(\r\n        \"postgres_changes\",\r\n        {\r\n          event: \"*\",\r\n          schema: \"public\",\r\n          table: \"listings\",\r\n        },\r\n        (payload) => {\r\n\r\n          // Refetch to get updated data with joins\r\n          if (fetchListingsRef.current) {\r\n            fetchListingsRef.current();\r\n          }\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [user, fetchListings]); // Added fetchListings for initial fetch, but use ref in callback\r\n\r\n  const refetch = () => {\r\n    fetchListings();\r\n  };\r\n\r\n  return { listings, stats, isLoading, error, refetch };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useCompanySettings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useConnectionHealth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useContacts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useCrmLeads.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useDashboardData.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":149,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":149,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5482,5485],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5482,5485],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":362,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":362,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13326,13329],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13326,13329],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'debouncedRefetch'. Either include it or remove the dependency array.","line":488,"column":6,"nodeType":"ArrayExpression","endLine":488,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [companyId, debouncedRefetch]","fix":{"range":[19359,19370],"text":"[companyId, debouncedRefetch]"}}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef, useCallback } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { useAutoCompany } from '@/hooks/useAutoCompany';\r\nimport { startOfMonth, endOfMonth, subMonths, format, startOfDay, endOfDay } from 'date-fns';\r\nimport { toast } from 'sonner';\r\n\r\ninterface LeadsTrendData {\r\n  month: string;\r\n  leads: number;\r\n}\r\n\r\ninterface LeadsByStageData {\r\n  name: string;\r\n  value: number;\r\n  color: string;\r\n}\r\n\r\ninterface LeadsBySourceData {\r\n  source: string;\r\n  leads: number;\r\n}\r\n\r\ninterface AgentPerformance {\r\n  name: string;\r\n  leads: number;\r\n  closed: number;\r\n  avatar: string;\r\n  id: string;\r\n}\r\n\r\ninterface RecentActivity {\r\n  id: string;\r\n  type: string;\r\n  agent: string;\r\n  lead: string;\r\n  time: string;\r\n  avatar: string;\r\n}\r\n\r\ninterface DashboardMetrics {\r\n  totalLeads: number;\r\n  totalLeadsChange: number;\r\n  newLeadsToday: number;\r\n  activeListings: number;\r\n  listingsChange: number;\r\n  meetingsToday: number;\r\n  meetingsUpcoming: number;\r\n  conversionRate: number;\r\n  conversionRateChange: number;\r\n  followUpsDue: number;\r\n  overdueFollowUps: number;\r\n  callsToday: number;\r\n  hotLeads: number;\r\n}\r\n\r\ninterface DashboardData {\r\n  metrics: DashboardMetrics;\r\n  leadsTrend: LeadsTrendData[];\r\n  leadsByStage: LeadsByStageData[];\r\n  leadsBySource: LeadsBySourceData[];\r\n  agentPerformance: AgentPerformance[];\r\n  recentActivities: RecentActivity[];\r\n  isLoading: boolean;\r\n  error: string | null;\r\n  refetch: () => Promise<void>;\r\n}\r\n\r\nconst stageColors: Record<string, string> = {\r\n  'New': '#3B82F6',\r\n  'Contacted': '#8B5CF6',\r\n  'Follow Up': '#F59E0B',\r\n  'Meeting': '#06B6D4',\r\n  'Qualified': '#10B981',\r\n  'Proposal': '#EC4899',\r\n  'Negotiation': '#F97316',\r\n  'Won': '#22C55E',\r\n  'Closed': '#10B981',\r\n  'Lost': '#EF4444',\r\n};\r\n\r\nconst defaultMetrics: DashboardMetrics = {\r\n  totalLeads: 0,\r\n  totalLeadsChange: 0,\r\n  newLeadsToday: 0,\r\n  activeListings: 0,\r\n  listingsChange: 0,\r\n  meetingsToday: 0,\r\n  meetingsUpcoming: 0,\r\n  conversionRate: 0,\r\n  conversionRateChange: 0,\r\n  followUpsDue: 0,\r\n  overdueFollowUps: 0,\r\n  callsToday: 0,\r\n  hotLeads: 0,\r\n};\r\n\r\nexport function useDashboardData(): DashboardData {\r\n  const { refreshSession } = useAuth();\r\n  const { companyId, isLoading: companyLoading } = useAutoCompany();\r\n  const prevCompanyIdRef = useRef<string | null>(null);\r\n\r\n  // #region agent log\r\n  if (prevCompanyIdRef.current !== companyId) {\r\n    fetch('http://127.0.0.1:7242/ingest/64664f1c-2aa5-4d5b-a8e0-b4c2f83d09ac', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'useDashboardData.ts:100', message: 'companyId changed', data: { prevCompanyId: prevCompanyIdRef.current, newCompanyId: companyId, companyLoading }, timestamp: Date.now(), sessionId: 'debug-session', runId: 'run2', hypothesisId: 'D' }) }).catch(() => { });\r\n    prevCompanyIdRef.current = companyId;\r\n  }\r\n  // #endregion\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const retryCountRef = useRef(0);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [metrics, setMetrics] = useState<DashboardMetrics>(defaultMetrics);\r\n  const [leadsTrend, setLeadsTrend] = useState<LeadsTrendData[]>([]);\r\n  const [leadsByStage, setLeadsByStage] = useState<LeadsByStageData[]>([]);\r\n  const [leadsBySource, setLeadsBySource] = useState<LeadsBySourceData[]>([]);\r\n  const [agentPerformance, setAgentPerformance] = useState<AgentPerformance[]>([]);\r\n  const [recentActivities, setRecentActivities] = useState<RecentActivity[]>([]);\r\n\r\n  const debounceTimerRef = useRef<NodeJS.Timeout | null>(null);\r\n  const isMountedRef = useRef(true);\r\n  const fetchDataRef = useRef<() => Promise<void>>();\r\n  const subscriptionSetupCountRef = useRef(0);\r\n\r\n  const fetchData = useCallback(async () => {\r\n    // #region agent log\r\n    fetch('http://127.0.0.1:7242/ingest/64664f1c-2aa5-4d5b-a8e0-b4c2f83d09ac', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'useDashboardData.ts:114', message: 'fetchData entry', data: { companyId: !!companyId, companyLoading, isMounted: isMountedRef.current, retryCount: retryCountRef.current }, timestamp: Date.now(), sessionId: 'debug-session', runId: 'run1', hypothesisId: 'B' }) }).catch(() => { });\r\n    // #endregion\r\n    if (!companyId || companyLoading || !isMountedRef.current) {\r\n      // #region agent log\r\n      fetch('http://127.0.0.1:7242/ingest/64664f1c-2aa5-4d5b-a8e0-b4c2f83d09ac', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'useDashboardData.ts:115', message: 'fetchData early return', data: { companyId: !!companyId, companyLoading, isMounted: isMountedRef.current }, timestamp: Date.now(), sessionId: 'debug-session', runId: 'run1', hypothesisId: 'B' }) }).catch(() => { });\r\n      // #endregion\r\n      if (!companyLoading) {\r\n        setIsLoading(false);\r\n      }\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const now = new Date();\r\n      const todayStart = startOfDay(now).toISOString();\r\n      const todayEnd = endOfDay(now).toISOString();\r\n      const lastMonthStart = startOfMonth(subMonths(now, 1)).toISOString();\r\n      const lastMonthEnd = endOfMonth(subMonths(now, 1)).toISOString();\r\n\r\n      // Fetch all data in parallel with independent error handling\r\n      const wrapQuery = (p: Promise<any>) => p.then(res => res).catch(err => ({ data: [], count: 0, error: err }));\r\n\r\n      const [\r\n        leadsResult,\r\n        leadsLastMonthResult,\r\n        leadsTodayResult,\r\n        listingsResult,\r\n        listingsLastWeekResult,\r\n        activitiesResult,\r\n        stagesResult,\r\n        agentsResult,\r\n        followUpsResult,\r\n      ] = await Promise.all([\r\n        wrapQuery(supabase\r\n          .from('leads')\r\n          .select('id, stage, source, created_at, lead_score, assigned_agent_id', { count: 'exact' })\r\n          .eq('company_id', companyId)),\r\n        wrapQuery(supabase\r\n          .from('leads')\r\n          .select('id', { count: 'exact' })\r\n          .eq('company_id', companyId)\r\n          .gte('created_at', lastMonthStart)\r\n          .lte('created_at', lastMonthEnd)),\r\n        wrapQuery(supabase\r\n          .from('leads')\r\n          .select('id', { count: 'exact' })\r\n          .eq('company_id', companyId)\r\n          .gte('created_at', todayStart)\r\n          .lte('created_at', todayEnd)),\r\n        wrapQuery(supabase\r\n          .from('properties')\r\n          .select('id, status', { count: 'exact' })\r\n          .eq('company_id', companyId)),\r\n        wrapQuery(supabase\r\n          .from('properties')\r\n          .select('id', { count: 'exact' })\r\n          .eq('company_id', companyId)\r\n          .lte('created_at', new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString())),\r\n        wrapQuery(supabase\r\n          .from('lead_activities')\r\n          .select('id, type, title, agent_name, lead_id, created_at')\r\n          .eq('company_id', companyId)\r\n          .order('created_at', { ascending: false })\r\n          .limit(10)),\r\n        wrapQuery(supabase\r\n          .from('lead_stages')\r\n          .select('id, name, color, is_won, is_lost')\r\n          .eq('company_id', companyId)),\r\n        wrapQuery(supabase\r\n          .from('agents')\r\n          .select('id, name, avatar_url')\r\n          .eq('company_id', companyId)\r\n          .eq('status', 'active')),\r\n        wrapQuery(supabase\r\n          .from('lead_followups')\r\n          .select('id, status, due_date')\r\n          .eq('company_id', companyId)\r\n          .eq('status', 'pending')),\r\n      ]);\r\n\r\n      if (!isMountedRef.current) return;\r\n\r\n      // Calculate metrics\r\n      const totalLeads = leadsResult.count || 0;\r\n      const lastMonthLeads = leadsLastMonthResult.count || 0;\r\n      const leadsChange = lastMonthLeads > 0\r\n        ? ((totalLeads - lastMonthLeads) / lastMonthLeads * 100).toFixed(1)\r\n        : 0;\r\n\r\n      const newLeadsToday = leadsTodayResult.count || 0;\r\n\r\n      const listings = listingsResult.data || [];\r\n      const activeListings = listings.filter(l => l.status === 'active' || l.status === 'published').length;\r\n      const listingsLastWeek = listingsLastWeekResult.count || 0;\r\n      const listingsChange = activeListings - listingsLastWeek;\r\n\r\n      const leads = leadsResult.data || [];\r\n      const wonStages = (stagesResult.data || []).filter(s => s.is_won).map(s => s.name.toLowerCase());\r\n      const wonLeads = leads.filter(l => wonStages.includes((l.stage || '').toLowerCase())).length;\r\n      const conversionRate = totalLeads > 0 ? (wonLeads / totalLeads * 100) : 0;\r\n\r\n      const hotStages = ['meeting', 'proposal', 'negotiation', 'qualified'];\r\n      const hotLeads = leads.filter(l =>\r\n        (l.lead_score && l.lead_score >= 70) ||\r\n        hotStages.includes((l.stage || '').toLowerCase())\r\n      ).length;\r\n\r\n      const followUps = followUpsResult.data || [];\r\n      const followUpsDue = followUps.length;\r\n      const overdueFollowUps = followUps.filter(f => new Date(f.due_date) < now).length;\r\n\r\n      const activities = activitiesResult.data || [];\r\n      const callsToday = activities.filter(a =>\r\n        a.type === 'call' &&\r\n        new Date(a.created_at) >= new Date(todayStart)\r\n      ).length;\r\n\r\n      const meetingsToday = activities.filter(a =>\r\n        a.type === 'meeting' &&\r\n        new Date(a.created_at) >= new Date(todayStart)\r\n      ).length;\r\n\r\n      // Batch state updates\r\n      setMetrics({\r\n        totalLeads,\r\n        totalLeadsChange: Number(leadsChange),\r\n        newLeadsToday,\r\n        activeListings,\r\n        listingsChange,\r\n        meetingsToday,\r\n        meetingsUpcoming: followUps.filter(f => new Date(f.due_date) > now).length,\r\n        conversionRate: Number(conversionRate.toFixed(1)),\r\n        conversionRateChange: 0,\r\n        followUpsDue,\r\n        overdueFollowUps,\r\n        callsToday,\r\n        hotLeads,\r\n      });\r\n\r\n      // Calculate leads by stage with database colors\r\n      const stageCounts: Record<string, number> = {};\r\n      leads.forEach(lead => {\r\n        const stage = lead.stage || 'New';\r\n        stageCounts[stage] = (stageCounts[stage] || 0) + 1;\r\n      });\r\n\r\n      // Build color map from database stages\r\n      const dbStageColors: Record<string, string> = {};\r\n      (stagesResult.data || []).forEach(s => {\r\n        dbStageColors[s.name] = s.color || '#3B82F6';\r\n        dbStageColors[s.name.toLowerCase()] = s.color || '#3B82F6';\r\n      });\r\n\r\n      setLeadsByStage(Object.entries(stageCounts).map(([name, value]) => ({\r\n        name,\r\n        value,\r\n        color: dbStageColors[name] || dbStageColors[name.toLowerCase()] || stageColors[name] || '#3B82F6',\r\n      })));\r\n\r\n      // Calculate leads by source\r\n      const sourceCounts: Record<string, number> = {};\r\n      leads.forEach(lead => {\r\n        const source = lead.source || 'Direct';\r\n        sourceCounts[source] = (sourceCounts[source] || 0) + 1;\r\n      });\r\n\r\n      setLeadsBySource(\r\n        Object.entries(sourceCounts)\r\n          .map(([source, leads]) => ({ source, leads }))\r\n          .sort((a, b) => b.leads - a.leads)\r\n          .slice(0, 5)\r\n      );\r\n\r\n      // Calculate leads trend (last 6 months)\r\n      const trendData: LeadsTrendData[] = [];\r\n      for (let i = 5; i >= 0; i--) {\r\n        const monthDate = subMonths(now, i);\r\n        const monthStart = startOfMonth(monthDate);\r\n        const monthEnd = endOfMonth(monthDate);\r\n\r\n        const monthLeads = leads.filter(l => {\r\n          const createdAt = new Date(l.created_at);\r\n          return createdAt >= monthStart && createdAt <= monthEnd;\r\n        }).length;\r\n\r\n        trendData.push({\r\n          month: format(monthDate, 'MMM'),\r\n          leads: monthLeads,\r\n        });\r\n      }\r\n      setLeadsTrend(trendData);\r\n\r\n      // Agent performance\r\n      const agents = agentsResult.data || [];\r\n      const agentLeadCounts: Record<string, { leads: number; closed: number }> = {};\r\n\r\n      leads.forEach(lead => {\r\n        if (lead.assigned_agent_id) {\r\n          if (!agentLeadCounts[lead.assigned_agent_id]) {\r\n            agentLeadCounts[lead.assigned_agent_id] = { leads: 0, closed: 0 };\r\n          }\r\n          agentLeadCounts[lead.assigned_agent_id].leads++;\r\n          if (wonStages.includes((lead.stage || '').toLowerCase())) {\r\n            agentLeadCounts[lead.assigned_agent_id].closed++;\r\n          }\r\n        }\r\n      });\r\n\r\n      setAgentPerformance(\r\n        agents\r\n          .map(agent => ({\r\n            id: agent.id,\r\n            name: agent.name,\r\n            leads: agentLeadCounts[agent.id]?.leads || 0,\r\n            closed: agentLeadCounts[agent.id]?.closed || 0,\r\n            avatar: agent.name.toLowerCase().replace(/\\s+/g, ''),\r\n          }))\r\n          .sort((a, b) => b.leads - a.leads)\r\n          .slice(0, 4)\r\n      );\r\n\r\n      // Recent activities\r\n      setRecentActivities(\r\n        activities.slice(0, 5).map(activity => ({\r\n          id: activity.id,\r\n          type: activity.type,\r\n          agent: activity.agent_name,\r\n          lead: activity.title || 'Unknown Lead',\r\n          time: getTimeAgo(new Date(activity.created_at)),\r\n          avatar: activity.agent_name.toLowerCase().replace(/\\s+/g, ''),\r\n        }))\r\n      );\r\n\r\n    } catch (err: any) {\r\n      console.error('Error fetching dashboard data:', err);\r\n\r\n      // Check if it's a JWT error\r\n      const isJwtError = err?.message?.includes('JWT') ||\r\n        err?.code === 'PGRST301' ||\r\n        err?.code === 'PGRST303';\r\n\r\n      if (isJwtError && retryCountRef.current < 2) {\r\n        retryCountRef.current += 1;\r\n\r\n        // #region agent log\r\n        fetch('http://127.0.0.1:7242/ingest/64664f1c-2aa5-4d5b-a8e0-b4c2f83d09ac', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'useDashboardData.ts:352', message: 'JWT error in fetchData, attempting refresh', data: { retryCount: retryCountRef.current, refreshSessionExists: !!refreshSession }, timestamp: Date.now(), sessionId: 'debug-session', runId: 'run1', hypothesisId: 'B' }) }).catch(() => { });\r\n        // #endregion\r\n        const refreshed = await refreshSession();\r\n        // #region agent log\r\n        fetch('http://127.0.0.1:7242/ingest/64664f1c-2aa5-4d5b-a8e0-b4c2f83d09ac', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'useDashboardData.ts:355', message: 'Session refresh result in fetchData', data: { refreshed, retryCount: retryCountRef.current }, timestamp: Date.now(), sessionId: 'debug-session', runId: 'run1', hypothesisId: 'B' }) }).catch(() => { });\r\n        // #endregion\r\n        if (refreshed) {\r\n          // Retry fetch after session refresh\r\n          setTimeout(() => fetchData(), 500);\r\n          return;\r\n        }\r\n      }\r\n\r\n      if (isMountedRef.current) {\r\n        setError('Failed to load dashboard data');\r\n        if (isJwtError) {\r\n          toast.error('Session expired. Please refresh the page or log in again.');\r\n        }\r\n      }\r\n    } finally {\r\n      if (isMountedRef.current) {\r\n        setIsLoading(false);\r\n      }\r\n    }\r\n  }, [companyId, companyLoading, refreshSession]);\r\n\r\n  // Keep ref updated with latest fetchData\r\n  useEffect(() => {\r\n    fetchDataRef.current = fetchData;\r\n  }, [fetchData]);\r\n\r\n  // Debounced refetch for real-time updates - stable reference to prevent subscription recreation\r\n  const debouncedRefetch = useCallback(() => {\r\n    // #region agent log\r\n    fetch('http://127.0.0.1:7242/ingest/64664f1c-2aa5-4d5b-a8e0-b4c2f83d09ac', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'useDashboardData.ts:389', message: 'debouncedRefetch called', data: { hasTimer: !!debounceTimerRef.current }, timestamp: Date.now(), sessionId: 'debug-session', runId: 'run1', hypothesisId: 'C' }) }).catch(() => { });\r\n    // #endregion\r\n    if (debounceTimerRef.current) {\r\n      clearTimeout(debounceTimerRef.current);\r\n    }\r\n    debounceTimerRef.current = setTimeout(() => {\r\n      if (isMountedRef.current && fetchDataRef.current) {\r\n        fetchDataRef.current();\r\n      }\r\n    }, 500);\r\n  }, []); // Empty deps - stable reference, uses ref to call latest fetchData\r\n\r\n  // Initial fetch - only re-run when companyId or companyLoading changes, not when refreshSession changes\r\n  useEffect(() => {\r\n    isMountedRef.current = true;\r\n    if (companyId && !companyLoading) {\r\n      fetchData();\r\n    }\r\n\r\n    return () => {\r\n      isMountedRef.current = false;\r\n      if (debounceTimerRef.current) {\r\n        clearTimeout(debounceTimerRef.current);\r\n      }\r\n    };\r\n  }, [companyId, companyLoading, fetchData]); // Keep fetchData for JWT retry scenarios, but guard with companyId/companyLoading\r\n\r\n  // Real-time subscriptions\r\n  useEffect(() => {\r\n    subscriptionSetupCountRef.current += 1;\r\n    // #region agent log\r\n    fetch('http://127.0.0.1:7242/ingest/64664f1c-2aa5-4d5b-a8e0-b4c2f83d09ac', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'useDashboardData.ts:424', message: 'Realtime subscription effect running', data: { companyId: !!companyId, companyIdValue: companyId, setupCount: subscriptionSetupCountRef.current }, timestamp: Date.now(), sessionId: 'debug-session', runId: 'run2', hypothesisId: 'C' }) }).catch(() => { });\r\n    // #endregion\r\n    if (!companyId) return;\r\n\r\n    const leadsChannel = supabase\r\n      .channel('dashboard-leads-realtime')\r\n      .on(\r\n        'postgres_changes',\r\n        { event: '*', schema: 'public', table: 'leads', filter: `company_id=eq.${companyId}` },\r\n        debouncedRefetch\r\n      )\r\n      .subscribe();\r\n\r\n    const activitiesChannel = supabase\r\n      .channel('dashboard-activities-realtime')\r\n      .on(\r\n        'postgres_changes',\r\n        { event: '*', schema: 'public', table: 'lead_activities', filter: `company_id=eq.${companyId}` },\r\n        debouncedRefetch\r\n      )\r\n      .subscribe();\r\n\r\n    const followupsChannel = supabase\r\n      .channel('dashboard-followups-realtime')\r\n      .on(\r\n        'postgres_changes',\r\n        { event: '*', schema: 'public', table: 'lead_followups', filter: `company_id=eq.${companyId}` },\r\n        debouncedRefetch\r\n      )\r\n      .subscribe();\r\n\r\n    const propertiesChannel = supabase\r\n      .channel('dashboard-properties-realtime')\r\n      .on(\r\n        'postgres_changes',\r\n        { event: '*', schema: 'public', table: 'properties', filter: `company_id=eq.${companyId}` },\r\n        debouncedRefetch\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      // #region agent log\r\n      fetch('http://127.0.0.1:7242/ingest/64664f1c-2aa5-4d5b-a8e0-b4c2f83d09ac', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'useDashboardData.ts:468', message: 'Cleaning up realtime subscriptions', data: { companyId: !!companyId, companyIdValue: companyId, setupCount: subscriptionSetupCountRef.current }, timestamp: Date.now(), sessionId: 'debug-session', runId: 'run2', hypothesisId: 'C' }) }).catch(() => { });\r\n      // #endregion\r\n      supabase.removeChannel(leadsChannel);\r\n      supabase.removeChannel(activitiesChannel);\r\n      supabase.removeChannel(followupsChannel);\r\n      supabase.removeChannel(propertiesChannel);\r\n    };\r\n  }, [companyId]); // Removed debouncedRefetch from deps - it's now stable\r\n\r\n  return {\r\n    metrics,\r\n    leadsTrend,\r\n    leadsByStage,\r\n    leadsBySource,\r\n    agentPerformance,\r\n    recentActivities,\r\n    isLoading,\r\n    error,\r\n    refetch: fetchData,\r\n  };\r\n}\r\n\r\nfunction getTimeAgo(date: Date): string {\r\n  const now = new Date();\r\n  const diffMs = now.getTime() - date.getTime();\r\n  const diffMins = Math.floor(diffMs / 60000);\r\n  const diffHours = Math.floor(diffMs / 3600000);\r\n  const diffDays = Math.floor(diffMs / 86400000);\r\n\r\n  if (diffMins < 1) return 'Just now';\r\n  if (diffMins < 60) return `${diffMins} min ago`;\r\n  if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;\r\n  return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useDeals.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useDebounce.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":19,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[483,486],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[483,486],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":19,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[493,496],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[493,496],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState, useCallback, useRef } from \"react\";\r\n\r\nexport function useDebounce<T>(value: T, delay: number): T {\r\n  const [debouncedValue, setDebouncedValue] = useState<T>(value);\r\n\r\n  useEffect(() => {\r\n    const handler = setTimeout(() => {\r\n      setDebouncedValue(value);\r\n    }, delay);\r\n\r\n    return () => {\r\n      clearTimeout(handler);\r\n    };\r\n  }, [value, delay]);\r\n\r\n  return debouncedValue;\r\n}\r\n\r\nexport function useDebouncedCallback<T extends (...args: any[]) => any>(\r\n  callback: T,\r\n  delay: number\r\n): (...args: Parameters<T>) => void {\r\n  const timeoutRef = useRef<NodeJS.Timeout>();\r\n\r\n  const debouncedCallback = useCallback(\r\n    (...args: Parameters<T>) => {\r\n      if (timeoutRef.current) {\r\n        clearTimeout(timeoutRef.current);\r\n      }\r\n\r\n      timeoutRef.current = setTimeout(() => {\r\n        callback(...args);\r\n      }, delay);\r\n    },\r\n    [callback, delay]\r\n  );\r\n\r\n  useEffect(() => {\r\n    return () => {\r\n      if (timeoutRef.current) {\r\n        clearTimeout(timeoutRef.current);\r\n      }\r\n    };\r\n  }, [debouncedCallback]); // Clean up when callback changes\r\n\r\n  return debouncedCallback;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useDebouncedValue.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useLead.ts","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchLead'. Either include it or remove the dependency array.","line":116,"column":6,"nodeType":"ArrayExpression","endLine":116,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [fetchLead, leadId]","fix":{"range":[2790,2798],"text":"[fetchLead, leadId]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport type { Json } from \"@/integrations/supabase/types\";\r\n\r\nexport interface Lead {\r\n  id: string;\r\n  company_id: string | null;\r\n  name: string;\r\n  phone: string | null;\r\n  email: string | null;\r\n  source: string | null;\r\n  stage: string | null;\r\n  stage_id: string | null;\r\n  budget: string | null;\r\n  requirements: string | null;\r\n  location: string | null;\r\n  assigned_agent_id: string | null;\r\n  lead_group_id: string | null;\r\n  tags: string[] | null;\r\n  lead_score: number | null;\r\n  gender: string | null;\r\n  nationality: string | null;\r\n  language: string | null;\r\n  preferred_contact_time: string | null;\r\n  purpose: string | null;\r\n  property_type: string | null;\r\n  bedrooms: string | null;\r\n  furnished: string | null;\r\n  move_in_date: string | null;\r\n  form_data: Json | null;\r\n  source_metadata: Json | null;\r\n  mapped_fields: Json | null;\r\n  campaign_name: string | null;\r\n  ad_set_name: string | null;\r\n  ad_name: string | null;\r\n  form_id: string | null;\r\n  form_name: string | null;\r\n  external_id: string | null;\r\n  fetched_at: string | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n  last_contacted_at: string | null;\r\n  agent?: {\r\n    id: string;\r\n    name: string;\r\n    avatar_url: string | null;\r\n  } | null;\r\n  lead_group?: {\r\n    id: string;\r\n    name: string;\r\n    color: string;\r\n  } | null;\r\n  lead_stage?: {\r\n    id: string;\r\n    name: string;\r\n    color: string;\r\n    position: number;\r\n    is_default: boolean;\r\n    is_won: boolean;\r\n    is_lost: boolean;\r\n  } | null;\r\n}\r\n\r\nexport function useLead(leadId: string | undefined) {\r\n  const [lead, setLead] = useState<Lead | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const fetchLead = async () => {\r\n    if (!leadId) {\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    const { data, error: fetchError } = await supabase\r\n      .from(\"leads\")\r\n      .select(`\r\n        *,\r\n        agent:agents!assigned_agent_id (\r\n          id,\r\n          name,\r\n          avatar_url\r\n        ),\r\n        lead_group:lead_groups!lead_group_id (\r\n          id,\r\n          name,\r\n          color\r\n        ),\r\n        lead_stage:lead_stages!stage_id (\r\n          id,\r\n          name,\r\n          color,\r\n          position,\r\n          is_default,\r\n          is_won,\r\n          is_lost\r\n        )\r\n      `)\r\n      .eq(\"id\", leadId)\r\n      .maybeSingle();\r\n\r\n    if (fetchError) {\r\n      setError(fetchError.message);\r\n      setLead(null);\r\n    } else {\r\n      setLead(data as Lead | null);\r\n    }\r\n    setIsLoading(false);\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchLead();\r\n  }, [leadId]);\r\n\r\n  const refetch = async () => {\r\n    await fetchLead();\r\n  };\r\n\r\n  return { lead, isLoading, error, refetch };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useLeadActivities.ts","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchActivities'. Either include it or remove the dependency array.","line":211,"column":6,"nodeType":"ArrayExpression","endLine":211,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [fetchActivities, leadId]","fix":{"range":[6816,6824],"text":"[fetchActivities, leadId]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useMemo } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { toast } from \"sonner\";\r\n\r\nexport interface AttachmentInfo {\r\n  name: string;\r\n  url: string;\r\n  size: number;\r\n  type: string;\r\n}\r\n\r\nexport interface LeadActivity {\r\n  id: string;\r\n  lead_id: string;\r\n  type: string;\r\n  title: string;\r\n  description: string | null;\r\n  agent_id: string | null;\r\n  agent_name: string;\r\n  duration: string | null;\r\n  audio_url: string | null;\r\n  attachments_count: number;\r\n  attachments: AttachmentInfo[] | null;\r\n  created_at: string;\r\n}\r\n\r\nexport interface TimelineItem {\r\n  id: number | string;\r\n  type: string;\r\n  title: string;\r\n  description: string;\r\n  agent: string;\r\n  time: string;\r\n  rawTime?: Date;\r\n  duration?: string;\r\n  audioUrl?: string;\r\n  attachments?: number;\r\n  attachmentsList?: AttachmentInfo[];\r\n  isSystem?: boolean;\r\n}\r\n\r\nexport interface LeadInfo {\r\n  id: string;\r\n  name: string;\r\n  created_at: string;\r\n  source?: string | null;\r\n  assigned_agent_id?: string | null;\r\n  agent?: {\r\n    name: string;\r\n  } | null;\r\n}\r\n\r\nconst formatTimeAgo = (dateString: string): string => {\r\n  const date = new Date(dateString);\r\n  const now = new Date();\r\n  const diffMs = now.getTime() - date.getTime();\r\n  const diffMins = Math.floor(diffMs / 60000);\r\n  const diffHours = Math.floor(diffMins / 60);\r\n  const diffDays = Math.floor(diffHours / 24);\r\n\r\n  if (diffMins < 1) return \"Just now\";\r\n  if (diffMins < 60) return `${diffMins} min ago`;\r\n  if (diffHours < 24) {\r\n    const hours = date.getHours();\r\n    const minutes = date.getMinutes();\r\n    const ampm = hours >= 12 ? \"PM\" : \"AM\";\r\n    const formattedHours = hours % 12 || 12;\r\n    const formattedMinutes = minutes.toString().padStart(2, \"0\");\r\n    return `Today, ${formattedHours}:${formattedMinutes} ${ampm}`;\r\n  }\r\n  if (diffDays === 1) {\r\n    const hours = date.getHours();\r\n    const minutes = date.getMinutes();\r\n    const ampm = hours >= 12 ? \"PM\" : \"AM\";\r\n    const formattedHours = hours % 12 || 12;\r\n    const formattedMinutes = minutes.toString().padStart(2, \"0\");\r\n    return `Yesterday, ${formattedHours}:${formattedMinutes} ${ampm}`;\r\n  }\r\n\r\n  const month = date.toLocaleDateString(\"en-US\", { month: \"short\" });\r\n  const day = date.getDate();\r\n  const year = date.getFullYear();\r\n  const hours = date.getHours();\r\n  const minutes = date.getMinutes();\r\n  const ampm = hours >= 12 ? \"PM\" : \"AM\";\r\n  const formattedHours = hours % 12 || 12;\r\n  const formattedMinutes = minutes.toString().padStart(2, \"0\");\r\n  return `${month} ${day}, ${year} ${formattedHours}:${formattedMinutes} ${ampm}`;\r\n};\r\n\r\nconst mapActivityToTimeline = (activity: LeadActivity): TimelineItem => {\r\n  const attachmentsList = Array.isArray(activity.attachments)\r\n    ? activity.attachments\r\n    : [];\r\n\r\n  return {\r\n    id: activity.id,\r\n    type: activity.type,\r\n    title: activity.title,\r\n    description: activity.description || \"\",\r\n    agent: activity.agent_name,\r\n    time: formatTimeAgo(activity.created_at),\r\n    rawTime: new Date(activity.created_at),\r\n    duration: activity.duration || undefined,\r\n    audioUrl: activity.audio_url || undefined,\r\n    attachments: attachmentsList.length || activity.attachments_count || undefined,\r\n    attachmentsList: attachmentsList.length > 0 ? attachmentsList : undefined,\r\n  };\r\n};\r\n\r\n// Format date for system activity descriptions\r\nconst formatDateTime = (dateString: string): string => {\r\n  const date = new Date(dateString);\r\n  const month = date.toLocaleDateString(\"en-US\", { month: \"short\" });\r\n  const day = date.getDate();\r\n  const year = date.getFullYear();\r\n  const hours = date.getHours();\r\n  const minutes = date.getMinutes();\r\n  const ampm = hours >= 12 ? \"PM\" : \"AM\";\r\n  const formattedHours = hours % 12 || 12;\r\n  const formattedMinutes = minutes.toString().padStart(2, \"0\");\r\n  return `${month} ${day}, ${year} at ${formattedHours}:${formattedMinutes} ${ampm}`;\r\n};\r\n\r\n// Generate system activities based on lead data\r\nconst generateSystemActivities = (lead: LeadInfo | null): TimelineItem[] => {\r\n  if (!lead) return [];\r\n\r\n  const systemActivities: TimelineItem[] = [];\r\n  const createdDateTime = formatDateTime(lead.created_at);\r\n\r\n  // Lead Created activity\r\n  systemActivities.push({\r\n    id: `system-created-${lead.id}`,\r\n    type: \"added\",\r\n    title: \"Lead added to CRM\",\r\n    description: lead.source\r\n      ? `${createdDateTime} â€¢ Source: ${lead.source}`\r\n      : `${createdDateTime} â€¢ Manually added`,\r\n    agent: \"System\",\r\n    time: formatTimeAgo(lead.created_at),\r\n    rawTime: new Date(lead.created_at),\r\n    isSystem: true,\r\n  });\r\n\r\n  // Lead Assigned activity (if assigned)\r\n  if (lead.assigned_agent_id && lead.agent?.name) {\r\n    // Add a slight offset so assignment appears after creation\r\n    const assignedTime = new Date(new Date(lead.created_at).getTime() + 1000);\r\n    const assignedDateTime = formatDateTime(assignedTime.toISOString());\r\n    systemActivities.push({\r\n      id: `system-assigned-${lead.id}`,\r\n      type: \"assignment\",\r\n      title: `Assigned to ${lead.agent.name}`,\r\n      description: assignedDateTime,\r\n      agent: \"System\",\r\n      time: formatTimeAgo(assignedTime.toISOString()),\r\n      rawTime: assignedTime,\r\n      isSystem: true,\r\n    });\r\n  }\r\n\r\n  return systemActivities;\r\n};\r\n\r\nexport function useLeadActivities(leadId: string, leadInfo?: LeadInfo | null) {\r\n  const [dbActivities, setDbActivities] = useState<TimelineItem[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n\r\n  // Generate system activities from lead info\r\n  const systemActivities = useMemo(() => generateSystemActivities(leadInfo || null), [leadInfo]);\r\n\r\n  // Combine and sort all activities\r\n  const activities = useMemo(() => {\r\n    const combined = [...dbActivities, ...systemActivities];\r\n    // Sort by rawTime descending (newest first)\r\n    return combined.sort((a, b) => {\r\n      const timeA = a.rawTime ? a.rawTime.getTime() : 0;\r\n      const timeB = b.rawTime ? b.rawTime.getTime() : 0;\r\n      return timeB - timeA;\r\n    });\r\n  }, [dbActivities, systemActivities]);\r\n\r\n  const fetchActivities = async () => {\r\n    setIsLoading(true);\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from(\"lead_activities\")\r\n        .select(\"*\")\r\n        .eq(\"lead_id\", leadId)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (error) {\r\n        console.error(\"Error fetching activities:\", error);\r\n        return;\r\n      }\r\n\r\n      if (data) {\r\n        setDbActivities(data.map((item) => mapActivityToTimeline(item as unknown as LeadActivity)));\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error fetching activities:\", error);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  // Fetch initial activities\r\n  useEffect(() => {\r\n    fetchActivities();\r\n  }, [leadId]);\r\n\r\n  // Subscribe to realtime updates\r\n  useEffect(() => {\r\n\r\n\r\n    const channel = supabase\r\n      .channel(`lead-activities-${leadId}`)\r\n      .on(\r\n        \"postgres_changes\",\r\n        {\r\n          event: \"INSERT\",\r\n          schema: \"public\",\r\n          table: \"lead_activities\",\r\n          filter: `lead_id=eq.${leadId}`,\r\n        },\r\n        (payload) => {\r\n\r\n          const newActivity = payload.new as LeadActivity;\r\n          const timelineItem = mapActivityToTimeline(newActivity);\r\n\r\n          setDbActivities((prev) => [timelineItem, ...prev]);\r\n          toast.success(`New ${newActivity.type} added to timeline`);\r\n        }\r\n      )\r\n      .on(\r\n        \"postgres_changes\",\r\n        {\r\n          event: \"DELETE\",\r\n          schema: \"public\",\r\n          table: \"lead_activities\",\r\n          filter: `lead_id=eq.${leadId}`,\r\n        },\r\n        (payload) => {\r\n\r\n          const deletedId = (payload.old as LeadActivity).id;\r\n          setDbActivities((prev) => prev.filter((a) => a.id !== deletedId));\r\n        }\r\n      )\r\n      .subscribe((status) => {\r\n\r\n      });\r\n\r\n    return () => {\r\n\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [leadId]);\r\n\r\n  // Upload files and return attachment info\r\n  const uploadFiles = async (files: File[], activityId: string): Promise<AttachmentInfo[]> => {\r\n    const attachments: AttachmentInfo[] = [];\r\n\r\n    for (const file of files) {\r\n      const fileExt = file.name.split('.').pop();\r\n      const fileName = `${leadId}/${activityId}/${Date.now()}-${file.name}`;\r\n\r\n      const { data, error } = await supabase.storage\r\n        .from('activity-attachments')\r\n        .upload(fileName, file);\r\n\r\n      if (error) {\r\n        console.error(\"Error uploading file:\", error);\r\n        toast.error(`Failed to upload ${file.name}`);\r\n        continue;\r\n      }\r\n\r\n      const { data: urlData } = supabase.storage\r\n        .from('activity-attachments')\r\n        .getPublicUrl(data.path);\r\n\r\n      attachments.push({\r\n        name: file.name,\r\n        url: urlData.publicUrl,\r\n        size: file.size,\r\n        type: file.type,\r\n      });\r\n    }\r\n\r\n    return attachments;\r\n  };\r\n\r\n  // Add a new activity with optional attachments\r\n  const addActivity = async (\r\n    type: string,\r\n    title: string,\r\n    description: string,\r\n    agentName: string = \"Current User\",\r\n    agentId?: string,\r\n    files?: File[]\r\n  ) => {\r\n    try {\r\n      // First insert the activity to get its ID\r\n      const { data: insertedActivity, error } = await supabase\r\n        .from(\"lead_activities\")\r\n        .insert({\r\n          lead_id: leadId,\r\n          type,\r\n          title,\r\n          description,\r\n          agent_name: agentName,\r\n          agent_id: agentId,\r\n          attachments: [],\r\n          attachments_count: 0,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error(\"Error adding activity:\", error);\r\n        toast.error(\"Failed to add activity\");\r\n        return false;\r\n      }\r\n\r\n      // If there are files, upload them and update the activity\r\n      if (files && files.length > 0) {\r\n        const attachments = await uploadFiles(files, insertedActivity.id);\r\n\r\n        if (attachments.length > 0) {\r\n          const { error: updateError } = await supabase\r\n            .from(\"lead_activities\")\r\n            .update({\r\n              attachments: JSON.parse(JSON.stringify(attachments)),\r\n              attachments_count: attachments.length,\r\n            })\r\n            .eq(\"id\", insertedActivity.id);\r\n\r\n          if (updateError) {\r\n            console.error(\"Error updating attachments:\", updateError);\r\n          }\r\n        }\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error(\"Error adding activity:\", error);\r\n      toast.error(\"Failed to add activity\");\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const refetch = async () => {\r\n    await fetchActivities();\r\n  };\r\n\r\n  return {\r\n    activities,\r\n    isLoading,\r\n    addActivity,\r\n    refetch,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useLeadAssignment.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":199,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":199,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5511,5514],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5511,5514],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { toast } from \"sonner\";\r\n\r\nexport interface LeadPool {\r\n  id: string;\r\n  pool_name: string;\r\n  description: string | null;\r\n  color: string;\r\n  is_active: boolean;\r\n  created_at: string;\r\n  lead_count?: number;\r\n}\r\n\r\nexport interface AgentLoad {\r\n  id: string;\r\n  agent_id: string;\r\n  agent_name: string;\r\n  current_leads_count: number;\r\n  pending_followups_count: number;\r\n  total_assignments_today: number;\r\n  total_assignments_week: number;\r\n  conversion_rate: number;\r\n  max_leads_capacity: number;\r\n  is_available: boolean;\r\n  last_assignment_at: string | null;\r\n}\r\n\r\nexport interface AssignmentNotification {\r\n  id: string;\r\n  lead_id: string;\r\n  lead_name: string;\r\n  notification_type: string;\r\n  title: string;\r\n  message: string | null;\r\n  is_read: boolean;\r\n  created_at: string;\r\n}\r\n\r\nexport interface AutoReassignmentRule {\r\n  id: string;\r\n  name: string;\r\n  days_without_contact: number;\r\n  use_round_robin: boolean;\r\n  is_active: boolean;\r\n  apply_to_stages: string[];\r\n}\r\n\r\nexport const useLeadPools = () => {\r\n  const { profile } = useAuth();\r\n  const [pools, setPools] = useState<LeadPool[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n\r\n  const fetchPools = useCallback(async () => {\r\n    if (!profile?.company_id) return;\r\n    \r\n    const { data, error } = await supabase\r\n      .from(\"lead_pools\")\r\n      .select(`\r\n        *,\r\n        lead_pool_members(count)\r\n      `)\r\n      .eq(\"company_id\", profile.company_id)\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching pools:\", error);\r\n      return;\r\n    }\r\n\r\n    setPools(data?.map(p => ({\r\n      ...p,\r\n      lead_count: p.lead_pool_members?.[0]?.count || 0\r\n    })) || []);\r\n    setIsLoading(false);\r\n  }, [profile?.company_id]);\r\n\r\n  useEffect(() => {\r\n    fetchPools();\r\n  }, [fetchPools]);\r\n\r\n  const createPool = async (name: string, description?: string, color?: string) => {\r\n    if (!profile?.company_id) return null;\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"lead_pools\")\r\n      .insert({\r\n        company_id: profile.company_id,\r\n        pool_name: name,\r\n        description,\r\n        color: color || \"#3B82F6\",\r\n        created_by: profile.id\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      toast.error(\"Failed to create pool\");\r\n      return null;\r\n    }\r\n\r\n    toast.success(\"Pool created successfully\");\r\n    fetchPools();\r\n    return data;\r\n  };\r\n\r\n  const deletePool = async (poolId: string) => {\r\n    const { error } = await supabase\r\n      .from(\"lead_pools\")\r\n      .delete()\r\n      .eq(\"id\", poolId);\r\n\r\n    if (error) {\r\n      toast.error(\"Failed to delete pool\");\r\n      return false;\r\n    }\r\n\r\n    toast.success(\"Pool deleted\");\r\n    fetchPools();\r\n    return true;\r\n  };\r\n\r\n  const addLeadsToPool = async (poolId: string, leadIds: string[]) => {\r\n    if (!profile?.id) return false;\r\n\r\n    const insertData = leadIds.map(leadId => ({\r\n      pool_id: poolId,\r\n      lead_id: leadId,\r\n      added_by: profile.id\r\n    }));\r\n\r\n    const { error } = await supabase\r\n      .from(\"lead_pool_members\")\r\n      .upsert(insertData, { onConflict: \"pool_id,lead_id\" });\r\n\r\n    if (error) {\r\n      toast.error(\"Failed to add leads to pool\");\r\n      return false;\r\n    }\r\n\r\n    toast.success(`${leadIds.length} lead(s) added to pool`);\r\n    fetchPools();\r\n    return true;\r\n  };\r\n\r\n  return { pools, isLoading, fetchPools, createPool, deletePool, addLeadsToPool };\r\n};\r\n\r\nexport const useAgentLoad = () => {\r\n  const { profile } = useAuth();\r\n  const [agentLoads, setAgentLoads] = useState<AgentLoad[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n\r\n  const fetchAgentLoads = useCallback(async () => {\r\n    if (!profile?.company_id) return;\r\n\r\n    // Fetch from get_assignment_analytics function\r\n    const { data, error } = await supabase\r\n      .rpc(\"get_assignment_analytics\", { p_company_id: profile.company_id });\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching agent loads:\", error);\r\n      // Fallback to direct query\r\n      const { data: agents } = await supabase\r\n        .from(\"agents\")\r\n        .select(\"id, name\")\r\n        .eq(\"company_id\", profile.company_id)\r\n        .eq(\"status\", \"active\");\r\n\r\n      if (agents) {\r\n        const { data: loads } = await supabase\r\n          .from(\"agent_load\")\r\n          .select(\"*\")\r\n          .eq(\"company_id\", profile.company_id);\r\n\r\n        const combined = agents.map(agent => {\r\n          const load = loads?.find(l => l.agent_id === agent.id);\r\n          return {\r\n            id: load?.id || agent.id,\r\n            agent_id: agent.id,\r\n            agent_name: agent.name,\r\n            current_leads_count: load?.current_leads_count || 0,\r\n            pending_followups_count: load?.pending_followups_count || 0,\r\n            total_assignments_today: load?.total_assignments_today || 0,\r\n            total_assignments_week: load?.total_assignments_week || 0,\r\n            conversion_rate: load?.conversion_rate || 0,\r\n            max_leads_capacity: load?.max_leads_capacity || 50,\r\n            is_available: load?.is_available ?? true,\r\n            last_assignment_at: load?.last_assignment_at || null\r\n          };\r\n        });\r\n        setAgentLoads(combined);\r\n      }\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    setAgentLoads(data?.map((d: any) => ({\r\n      id: d.agent_id,\r\n      agent_id: d.agent_id,\r\n      agent_name: d.agent_name,\r\n      current_leads_count: d.active_leads || 0,\r\n      pending_followups_count: d.pending_followups || 0,\r\n      total_assignments_today: d.assignments_today || 0,\r\n      total_assignments_week: d.assignments_week || 0,\r\n      conversion_rate: d.conversion_rate || 0,\r\n      max_leads_capacity: 50,\r\n      is_available: d.is_available ?? true,\r\n      last_assignment_at: null\r\n    })) || []);\r\n    setIsLoading(false);\r\n  }, [profile?.company_id]);\r\n\r\n  useEffect(() => {\r\n    fetchAgentLoads();\r\n  }, [fetchAgentLoads]);\r\n\r\n  const updateAgentAvailability = async (agentId: string, isAvailable: boolean) => {\r\n    if (!profile?.company_id) return false;\r\n\r\n    const { error } = await supabase\r\n      .from(\"agent_load\")\r\n      .upsert({\r\n        agent_id: agentId,\r\n        company_id: profile.company_id,\r\n        is_available: isAvailable\r\n      }, { onConflict: \"agent_id\" });\r\n\r\n    if (error) {\r\n      toast.error(\"Failed to update availability\");\r\n      return false;\r\n    }\r\n\r\n    toast.success(`Agent ${isAvailable ? \"available\" : \"unavailable\"}`);\r\n    fetchAgentLoads();\r\n    return true;\r\n  };\r\n\r\n  return { agentLoads, isLoading, fetchAgentLoads, updateAgentAvailability };\r\n};\r\n\r\nexport const useAssignmentNotifications = () => {\r\n  const { profile } = useAuth();\r\n  const [notifications, setNotifications] = useState<AssignmentNotification[]>([]);\r\n  const [unreadCount, setUnreadCount] = useState(0);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n\r\n  const fetchNotifications = useCallback(async () => {\r\n    if (!profile?.company_id) return;\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"assignment_notifications\")\r\n      .select(`\r\n        *,\r\n        leads:lead_id (name)\r\n      `)\r\n      .eq(\"company_id\", profile.company_id)\r\n      .order(\"created_at\", { ascending: false })\r\n      .limit(50);\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching notifications:\", error);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    const mapped = data?.map(n => ({\r\n      id: n.id,\r\n      lead_id: n.lead_id,\r\n      lead_name: n.leads?.name || \"Unknown Lead\",\r\n      notification_type: n.notification_type,\r\n      title: n.title,\r\n      message: n.message,\r\n      is_read: n.is_read,\r\n      created_at: n.created_at\r\n    })) || [];\r\n\r\n    setNotifications(mapped);\r\n    setUnreadCount(mapped.filter(n => !n.is_read).length);\r\n    setIsLoading(false);\r\n  }, [profile?.company_id]);\r\n\r\n  useEffect(() => {\r\n    fetchNotifications();\r\n\r\n    // Subscribe to new notifications\r\n    if (profile?.company_id) {\r\n      const channel = supabase\r\n        .channel(\"assignment-notifications\")\r\n        .on(\r\n          \"postgres_changes\",\r\n          {\r\n            event: \"INSERT\",\r\n            schema: \"public\",\r\n            table: \"assignment_notifications\",\r\n            filter: `company_id=eq.${profile.company_id}`\r\n          },\r\n          () => {\r\n            fetchNotifications();\r\n          }\r\n        )\r\n        .subscribe();\r\n\r\n      return () => {\r\n        supabase.removeChannel(channel);\r\n      };\r\n    }\r\n  }, [fetchNotifications, profile?.company_id]);\r\n\r\n  const markAsRead = async (notificationId: string) => {\r\n    const { error } = await supabase\r\n      .from(\"assignment_notifications\")\r\n      .update({ is_read: true, read_at: new Date().toISOString() })\r\n      .eq(\"id\", notificationId);\r\n\r\n    if (!error) {\r\n      fetchNotifications();\r\n    }\r\n  };\r\n\r\n  const markAllAsRead = async () => {\r\n    if (!profile?.company_id) return;\r\n\r\n    const { error } = await supabase\r\n      .from(\"assignment_notifications\")\r\n      .update({ is_read: true, read_at: new Date().toISOString() })\r\n      .eq(\"company_id\", profile.company_id)\r\n      .eq(\"is_read\", false);\r\n\r\n    if (!error) {\r\n      toast.success(\"All notifications marked as read\");\r\n      fetchNotifications();\r\n    }\r\n  };\r\n\r\n  return { notifications, unreadCount, isLoading, fetchNotifications, markAsRead, markAllAsRead };\r\n};\r\n\r\nexport const useAutoReassignment = () => {\r\n  const { profile } = useAuth();\r\n  const [rules, setRules] = useState<AutoReassignmentRule[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n\r\n  const fetchRules = useCallback(async () => {\r\n    if (!profile?.company_id) return;\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"auto_reassignment_rules\")\r\n      .select(\"*\")\r\n      .eq(\"company_id\", profile.company_id)\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching rules:\", error);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    setRules(data || []);\r\n    setIsLoading(false);\r\n  }, [profile?.company_id]);\r\n\r\n  useEffect(() => {\r\n    fetchRules();\r\n  }, [fetchRules]);\r\n\r\n  const createRule = async (rule: Partial<AutoReassignmentRule>) => {\r\n    if (!profile?.company_id) return null;\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"auto_reassignment_rules\")\r\n      .insert({\r\n        company_id: profile.company_id,\r\n        name: rule.name || \"New Rule\",\r\n        days_without_contact: rule.days_without_contact || 3,\r\n        use_round_robin: rule.use_round_robin ?? true,\r\n        is_active: rule.is_active ?? true,\r\n        apply_to_stages: rule.apply_to_stages || [\"New\", \"Contacted\"],\r\n        created_by: profile.id\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      toast.error(\"Failed to create rule\");\r\n      return null;\r\n    }\r\n\r\n    toast.success(\"Auto-reassignment rule created\");\r\n    fetchRules();\r\n    return data;\r\n  };\r\n\r\n  const toggleRule = async (ruleId: string, isActive: boolean) => {\r\n    const { error } = await supabase\r\n      .from(\"auto_reassignment_rules\")\r\n      .update({ is_active: isActive })\r\n      .eq(\"id\", ruleId);\r\n\r\n    if (error) {\r\n      toast.error(\"Failed to update rule\");\r\n      return false;\r\n    }\r\n\r\n    fetchRules();\r\n    return true;\r\n  };\r\n\r\n  const deleteRule = async (ruleId: string) => {\r\n    const { error } = await supabase\r\n      .from(\"auto_reassignment_rules\")\r\n      .delete()\r\n      .eq(\"id\", ruleId);\r\n\r\n    if (error) {\r\n      toast.error(\"Failed to delete rule\");\r\n      return false;\r\n    }\r\n\r\n    toast.success(\"Rule deleted\");\r\n    fetchRules();\r\n    return true;\r\n  };\r\n\r\n  return { rules, isLoading, fetchRules, createRule, toggleRule, deleteRule };\r\n};\r\n\r\nexport const useLeadAssignment = () => {\r\n  const { profile } = useAuth();\r\n\r\n  const assignLead = async (leadId: string, agentId: string, reason: string = \"manual\") => {\r\n    const { data, error } = await supabase\r\n      .rpc(\"assign_lead_to_agent\", {\r\n        p_lead_id: leadId,\r\n        p_to_agent_id: agentId,\r\n        p_change_reason: reason\r\n      });\r\n\r\n    if (error) {\r\n      toast.error(\"Failed to assign lead\");\r\n      return null;\r\n    }\r\n\r\n    toast.success(\"Lead assigned successfully\");\r\n    return data;\r\n  };\r\n\r\n  const bulkAssignLeads = async (leadIds: string[], agentId: string) => {\r\n    const { data, error } = await supabase\r\n      .rpc(\"bulk_assign_leads\", {\r\n        p_lead_ids: leadIds,\r\n        p_agent_id: agentId\r\n      });\r\n\r\n    if (error) {\r\n      toast.error(\"Failed to bulk assign leads\");\r\n      return 0;\r\n    }\r\n\r\n    toast.success(`${data} leads assigned successfully`);\r\n    return data;\r\n  };\r\n\r\n  const undoAssignment = async (leadId: string) => {\r\n    const { data, error } = await supabase\r\n      .rpc(\"undo_lead_assignment\", {\r\n        p_lead_id: leadId\r\n      });\r\n\r\n    if (error) {\r\n      toast.error(\"Failed to undo assignment\");\r\n      return false;\r\n    }\r\n\r\n    if (data) {\r\n      toast.success(\"Assignment undone\");\r\n    } else {\r\n      toast.error(\"Cannot undo this assignment\");\r\n    }\r\n    return data;\r\n  };\r\n\r\n  const setLeadPriority = async (leadId: string, priority: \"low\" | \"medium\" | \"high\" | \"urgent\") => {\r\n    const { error } = await supabase\r\n      .from(\"leads\")\r\n      .update({ assignment_priority: priority })\r\n      .eq(\"id\", leadId);\r\n\r\n    if (error) {\r\n      toast.error(\"Failed to set priority\");\r\n      return false;\r\n    }\r\n\r\n    toast.success(`Priority set to ${priority}`);\r\n    return true;\r\n  };\r\n\r\n  return { assignLead, bulkAssignLeads, undoAssignment, setLeadPriority };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useLeadGroups.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useLeadImport.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":365,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":365,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10462,10465],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10462,10465],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":366,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":366,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10509,10512],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10509,10512],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":367,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":367,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10550,10553],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10550,10553],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":420,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":420,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12278,12281],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12278,12281],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":653,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":653,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20727,20730],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20727,20730],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useCallback } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { toast } from \"sonner\";\r\n\r\n// =====================================================\r\n// ENHANCED CRM MIGRATION SYSTEM\r\n// Supports enterprise-grade lead import with:\r\n// - Preview mode (mandatory before import)\r\n// - Merge duplicate handling\r\n// - Activity migration\r\n// - Rollback capability\r\n// - Custom fields support\r\n// - Detailed error tracking\r\n// =====================================================\r\n\r\ninterface ImportedLead {\r\n  name: string;\r\n  phone?: string;\r\n  email?: string;\r\n  source?: string;\r\n  stage?: string;\r\n  group?: string;\r\n  assigned_agent?: string;\r\n  notes?: string;\r\n  opted_in?: boolean;\r\n  activity_date?: string;\r\n  activity_description?: string;\r\n  [key: string]: string | boolean | undefined; // For custom fields\r\n}\r\n\r\ninterface PreviewResult {\r\n  jobId: string;\r\n  totalRows: number;\r\n  validRows: number;\r\n  duplicateRows: number;\r\n  invalidRows: number;\r\n  previewData: Array<{\r\n    row: number;\r\n    data: ImportedLead;\r\n    isDuplicate: boolean;\r\n    existingLeadId?: string;\r\n    errors: string[];\r\n  }>;\r\n}\r\n\r\ninterface ImportJobResult {\r\n  jobId: string;\r\n  totalRows: number;\r\n  importedRows: number;\r\n  skippedRows: number;\r\n  failedRows: number;\r\n  duplicateRows: number;\r\n  errors: Array<{ row: number; reason: string }>;\r\n  rollbackUntil?: string;\r\n}\r\n\r\ninterface ImportOptions {\r\n  duplicateAction: \"skip\" | \"merge\";\r\n  sourceLabel?: string;\r\n  defaultAgentId?: string;\r\n  defaultStage?: string;\r\n  defaultGroupId?: string;\r\n  forceAgentReassign?: boolean;\r\n}\r\n\r\nexport function useLeadImport() {\r\n  const { user } = useAuth();\r\n  const [isImporting, setIsImporting] = useState(false);\r\n  const [isPreviewing, setIsPreviewing] = useState(false);\r\n  const [progress, setProgress] = useState(0);\r\n\r\n  // Get company_id from user profile\r\n  const getCompanyId = useCallback(async (): Promise<string | null> => {\r\n    if (!user) return null;\r\n\r\n    const { data } = await supabase\r\n      .from(\"profiles\")\r\n      .select(\"company_id\")\r\n      .eq(\"id\", user.id)\r\n      .single();\r\n\r\n    return data?.company_id || null;\r\n  }, [user]);\r\n\r\n  // Check user role (everyone has access as requested)\r\n  const checkUserRole = useCallback(async (): Promise<boolean> => {\r\n    return !!user;\r\n  }, [user]);\r\n\r\n  // Normalize phone number for duplicate detection\r\n  const normalizePhone = (phone: string): string => {\r\n    if (!phone) return \"\";\r\n    // Remove all non-numeric chars\r\n    let cleaned = phone.replace(/[^0-9]/g, \"\");\r\n    // Remove leading 00 (international prefix)\r\n    if (cleaned.startsWith(\"00\")) {\r\n      cleaned = cleaned.slice(2);\r\n    }\r\n    // Require minimum 7 digits\r\n    if (cleaned.length < 7) return \"\";\r\n    return \"+\" + cleaned;\r\n  };\r\n\r\n  // Check for duplicate lead\r\n  const checkDuplicate = async (\r\n    phone: string,\r\n    email: string | undefined,\r\n    companyId: string\r\n  ): Promise<{ leadId: string; matchType: string } | null> => {\r\n    // First check by normalized phone\r\n    const normalizedPhone = normalizePhone(phone);\r\n    if (normalizedPhone) {\r\n      const { data: phoneMatch } = await supabase\r\n        .from(\"leads\")\r\n        .select(\"id\")\r\n        .eq(\"company_id\", companyId)\r\n        .eq(\"normalized_phone\", normalizedPhone)\r\n        .limit(1)\r\n        .maybeSingle();\r\n\r\n      if (phoneMatch) {\r\n        return { leadId: phoneMatch.id, matchType: \"phone\" };\r\n      }\r\n    }\r\n\r\n    // Then check by email\r\n    if (email && email.trim()) {\r\n      const { data: emailMatch } = await supabase\r\n        .from(\"leads\")\r\n        .select(\"id\")\r\n        .eq(\"company_id\", companyId)\r\n        .ilike(\"email\", email.trim())\r\n        .limit(1)\r\n        .maybeSingle();\r\n\r\n      if (emailMatch) {\r\n        return { leadId: emailMatch.id, matchType: \"email\" };\r\n      }\r\n    }\r\n\r\n    return null;\r\n  };\r\n\r\n  // Extract custom fields from lead data\r\n  const extractCustomFields = (lead: ImportedLead): Record<string, string> => {\r\n    const standardFields = [\r\n      \"name\", \"phone\", \"email\", \"source\", \"stage\", \"group\",\r\n      \"assigned_agent\", \"notes\", \"opted_in\", \"activity_date\",\r\n      \"activity_description\"\r\n    ];\r\n\r\n    const customFields: Record<string, string> = {};\r\n    Object.entries(lead).forEach(([key, value]) => {\r\n      if (!standardFields.includes(key) && value !== undefined && value !== \"\") {\r\n        customFields[key] = String(value);\r\n      }\r\n    });\r\n\r\n    return customFields;\r\n  };\r\n\r\n  // STEP 1: Preview import (analyze without inserting)\r\n  const previewImport = async (\r\n    leads: ImportedLead[],\r\n    fileName: string,\r\n    sourceLabel: string = \"Excel Import\"\r\n  ): Promise<PreviewResult | null> => {\r\n    if (!user) {\r\n      toast.error(\"You must be logged in\");\r\n      return null;\r\n    }\r\n\r\n    const hasPermission = await checkUserRole();\r\n    if (!hasPermission) {\r\n      toast.error(\"Only Admin or Manager can import leads\");\r\n      return null;\r\n    }\r\n\r\n    const companyId = await getCompanyId();\r\n    if (!companyId) {\r\n      toast.error(\"Company not found\");\r\n      return null;\r\n    }\r\n\r\n    setIsPreviewing(true);\r\n    setProgress(0);\r\n\r\n    try {\r\n      const previewData: PreviewResult[\"previewData\"] = [];\r\n      let validRows = 0;\r\n      let duplicateRows = 0;\r\n      let invalidRows = 0;\r\n\r\n      // Analyze each row\r\n      for (let i = 0; i < leads.length; i++) {\r\n        const lead = leads[i];\r\n        const rowNumber = i + 1;\r\n        const errors: string[] = [];\r\n        let isDuplicate = false;\r\n        let existingLeadId: string | undefined;\r\n\r\n        // Validate required fields\r\n        if (!lead.name?.trim()) {\r\n          errors.push(\"Name is required\");\r\n        }\r\n\r\n        // Require phone OR email\r\n        if (!lead.phone?.trim() && !lead.email?.trim()) {\r\n          errors.push(\"Phone or Email is required\");\r\n        }\r\n\r\n        // Check for duplicates\r\n        if (lead.phone?.trim() || lead.email?.trim()) {\r\n          const duplicate = await checkDuplicate(\r\n            lead.phone || \"\",\r\n            lead.email,\r\n            companyId\r\n          );\r\n          if (duplicate) {\r\n            isDuplicate = true;\r\n            existingLeadId = duplicate.leadId;\r\n            duplicateRows++;\r\n          }\r\n        }\r\n\r\n        if (errors.length > 0) {\r\n          invalidRows++;\r\n        } else if (!isDuplicate) {\r\n          validRows++;\r\n        }\r\n\r\n        previewData.push({\r\n          row: rowNumber,\r\n          data: lead,\r\n          isDuplicate,\r\n          existingLeadId,\r\n          errors,\r\n        });\r\n\r\n        // Update progress\r\n        if (i % 100 === 0) {\r\n          setProgress(Math.round((i / leads.length) * 100));\r\n        }\r\n      }\r\n\r\n      // Create import job in preview status\r\n      const { data: job, error: jobError } = await supabase\r\n        .from(\"lead_import_jobs\")\r\n        .insert({\r\n          company_id: companyId,\r\n          uploaded_by: user.id,\r\n          file_name: fileName,\r\n          source_label: sourceLabel,\r\n          total_rows: leads.length,\r\n          valid_rows: validRows,\r\n          duplicate_rows: duplicateRows,\r\n          skipped_rows: invalidRows,\r\n          status: \"preview\",\r\n          preview_rows: previewData.slice(0, 100), // Store first 100 for UI preview\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (jobError) {\r\n        console.error(\"Failed to create preview job:\", jobError);\r\n        toast.error(\"Failed to create import preview\");\r\n        setIsPreviewing(false);\r\n        return null;\r\n      }\r\n\r\n      setIsPreviewing(false);\r\n      setProgress(100);\r\n\r\n      return {\r\n        jobId: job.id,\r\n        totalRows: leads.length,\r\n        validRows,\r\n        duplicateRows,\r\n        invalidRows,\r\n        previewData,\r\n      };\r\n    } catch (error) {\r\n      console.error(\"Preview error:\", error);\r\n      setIsPreviewing(false);\r\n      toast.error(\"Preview failed unexpectedly\");\r\n      return null;\r\n    }\r\n  };\r\n\r\n  // STEP 2: Execute import (after preview)\r\n  const importLeads = async (\r\n    leads: ImportedLead[],\r\n    fileName: string,\r\n    duplicateAction: \"skip\" | \"merge\" = \"skip\",\r\n    options?: Partial<ImportOptions>\r\n  ): Promise<ImportJobResult | null> => {\r\n    if (!user) {\r\n      toast.error(\"You must be logged in to import leads\");\r\n      return null;\r\n    }\r\n\r\n    const hasPermission = await checkUserRole();\r\n    if (!hasPermission) {\r\n      toast.error(\"Only Admin or Manager can import leads\");\r\n      return null;\r\n    }\r\n\r\n    const companyId = await getCompanyId();\r\n    if (!companyId) {\r\n      toast.error(\"Company not found\");\r\n      return null;\r\n    }\r\n\r\n    setIsImporting(true);\r\n    setProgress(0);\r\n\r\n    const errors: Array<{ row: number; reason: string }> = [];\r\n    let importedRows = 0;\r\n    let skippedRows = 0;\r\n    let failedRows = 0;\r\n    let duplicateRows = 0;\r\n\r\n    try {\r\n      // Create import job record\r\n      const rollbackUntil = new Date();\r\n      rollbackUntil.setHours(rollbackUntil.getHours() + 24); // 24-hour rollback window\r\n\r\n      const { data: job, error: jobError } = await supabase\r\n        .from(\"lead_import_jobs\")\r\n        .insert({\r\n          company_id: companyId,\r\n          uploaded_by: user.id,\r\n          file_name: fileName,\r\n          source_label: options?.sourceLabel || \"Excel Import\",\r\n          total_rows: leads.length,\r\n          duplicate_action: duplicateAction,\r\n          default_agent_id: options?.defaultAgentId || null,\r\n          default_stage: options?.defaultStage || null,\r\n          default_group_id: options?.defaultGroupId || null,\r\n          status: \"processing\",\r\n          rollback_until: rollbackUntil.toISOString(),\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (jobError) {\r\n        console.error(\"Failed to create import job:\", jobError);\r\n        toast.error(\"Failed to start import. Check your permissions.\");\r\n        setIsImporting(false);\r\n        return null;\r\n      }\r\n\r\n      const jobId = job.id;\r\n\r\n      // Process leads in batches\r\n      const batchSize = 50;\r\n      const totalBatches = Math.ceil(leads.length / batchSize);\r\n\r\n      for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {\r\n        const batchStart = batchIndex * batchSize;\r\n        const batchEnd = Math.min(batchStart + batchSize, leads.length);\r\n        const batch = leads.slice(batchStart, batchEnd);\r\n\r\n        const leadsToInsert: any[] = [];\r\n        const activitiesToInsert: any[] = [];\r\n        const errorRecords: any[] = [];\r\n\r\n        for (let i = 0; i < batch.length; i++) {\r\n          const lead = batch[i];\r\n          const rowNumber = batchStart + i + 1;\r\n\r\n          // Validate required fields\r\n          const hasName = lead.name?.trim();\r\n          const hasPhone = lead.phone?.trim();\r\n          const hasEmail = lead.email?.trim();\r\n\r\n          if (!hasName) {\r\n            errors.push({ row: rowNumber, reason: \"Name is required\" });\r\n            errorRecords.push({\r\n              import_job_id: jobId,\r\n              row_number: rowNumber,\r\n              error_type: \"validation\",\r\n              error_message: \"Name is required\",\r\n              raw_row_data: lead,\r\n            });\r\n            failedRows++;\r\n            continue;\r\n          }\r\n\r\n          if (!hasPhone && !hasEmail) {\r\n            errors.push({ row: rowNumber, reason: \"Phone or Email is required\" });\r\n            errorRecords.push({\r\n              import_job_id: jobId,\r\n              row_number: rowNumber,\r\n              error_type: \"validation\",\r\n              error_message: \"Phone or Email is required\",\r\n              raw_row_data: lead,\r\n            });\r\n            failedRows++;\r\n            continue;\r\n          }\r\n\r\n          // Check for duplicates\r\n          const duplicate = await checkDuplicate(\r\n            lead.phone || \"\",\r\n            lead.email,\r\n            companyId\r\n          );\r\n\r\n          if (duplicate) {\r\n            duplicateRows++;\r\n\r\n            if (duplicateAction === \"skip\") {\r\n              skippedRows++;\r\n              continue;\r\n            } else {\r\n              // Merge: update only empty fields on existing lead\r\n              const customFields = extractCustomFields(lead);\r\n              const updateData: any = {};\r\n\r\n              // Only add non-empty values for merge\r\n              if (lead.email?.trim()) updateData.email = lead.email.trim();\r\n              if (lead.source?.trim()) updateData.source = lead.source.trim();\r\n              if (lead.stage?.trim()) updateData.stage = lead.stage.trim();\r\n              if (Object.keys(customFields).length > 0) updateData.custom_fields = customFields;\r\n\r\n              // Optionally reassign agent\r\n              if (options?.forceAgentReassign && options?.defaultAgentId) {\r\n                updateData.assigned_agent_id = options.defaultAgentId;\r\n              }\r\n\r\n              // Call merge function or update directly\r\n              const { error: mergeError } = await supabase\r\n                .from(\"leads\")\r\n                .update({\r\n                  ...updateData,\r\n                  updated_at: new Date().toISOString(),\r\n                })\r\n                .eq(\"id\", duplicate.leadId)\r\n                .is(\"email\", null); // Only update if field is empty (basic merge)\r\n\r\n              if (!mergeError) {\r\n                importedRows++;\r\n\r\n                // Add merge activity\r\n                activitiesToInsert.push({\r\n                  lead_id: duplicate.leadId,\r\n                  type: \"note\",\r\n                  title: \"Lead data merged from import\",\r\n                  description: `Data merged from file: ${fileName}`,\r\n                  agent_id: user.id,\r\n                  agent_name: user.email || \"System\",\r\n                  company_id: companyId,\r\n                  import_job_id: jobId,\r\n                });\r\n\r\n                // Import activities if provided\r\n                if (lead.activity_date || lead.activity_description) {\r\n                  activitiesToInsert.push({\r\n                    lead_id: duplicate.leadId,\r\n                    type: \"note\",\r\n                    title: lead.activity_description?.substring(0, 100) || \"Imported activity\",\r\n                    description: lead.activity_description || \"\",\r\n                    agent_name: \"Imported\",\r\n                    company_id: companyId,\r\n                    import_job_id: jobId,\r\n                    created_at: lead.activity_date || new Date().toISOString(),\r\n                  });\r\n                }\r\n              }\r\n              continue;\r\n            }\r\n          }\r\n\r\n          // Extract custom fields for new lead\r\n          const customFields = extractCustomFields(lead);\r\n\r\n          // Prepare new lead\r\n          leadsToInsert.push({\r\n            company_id: companyId,\r\n            name: lead.name.trim(),\r\n            phone: lead.phone?.trim() || null,\r\n            email: lead.email?.trim() || null,\r\n            source: lead.source?.trim() || options?.sourceLabel || \"Excel Import\",\r\n            stage: lead.stage?.trim() || options?.defaultStage || \"New\",\r\n            lead_group_id: options?.defaultGroupId || null,\r\n            assigned_agent_id: options?.defaultAgentId || null,\r\n            imported_from: \"excel\",\r\n            import_job_id: jobId,\r\n            opted_in: lead.opted_in !== undefined ? lead.opted_in : false,\r\n            custom_fields: Object.keys(customFields).length > 0 ? customFields : null,\r\n          });\r\n        }\r\n\r\n        // Insert error records\r\n        if (errorRecords.length > 0) {\r\n          await supabase.from(\"import_row_errors\").insert(errorRecords);\r\n        }\r\n\r\n        // Insert new leads\r\n        if (leadsToInsert.length > 0) {\r\n          const { data: insertedLeads, error: insertError } = await supabase\r\n            .from(\"leads\")\r\n            .insert(leadsToInsert)\r\n            .select(\"id\");\r\n\r\n          if (insertError) {\r\n            console.error(\"Insert error:\", insertError);\r\n            failedRows += leadsToInsert.length;\r\n            errors.push({\r\n              row: batchStart + 1,\r\n              reason: `Batch insert failed: ${insertError.message}`\r\n            });\r\n          } else {\r\n            importedRows += insertedLeads?.length || 0;\r\n\r\n            // Create activity records for imported leads\r\n            if (insertedLeads && insertedLeads.length > 0) {\r\n              const importActivities = insertedLeads.map((lead, idx) => ({\r\n                lead_id: lead.id,\r\n                type: \"import\",\r\n                title: \"Lead imported via Excel\",\r\n                description: `Imported from file: ${fileName}`,\r\n                agent_id: user.id,\r\n                agent_name: user.email || \"System\",\r\n                company_id: companyId,\r\n                import_job_id: jobId,\r\n              }));\r\n\r\n              activitiesToInsert.push(...importActivities);\r\n\r\n              // Add migrated activities if present\r\n              batch.forEach((batchLead, idx) => {\r\n                if (insertedLeads[idx] && (batchLead.activity_date || batchLead.activity_description)) {\r\n                  activitiesToInsert.push({\r\n                    lead_id: insertedLeads[idx].id,\r\n                    type: \"note\",\r\n                    title: batchLead.activity_description?.substring(0, 100) || \"Imported activity\",\r\n                    description: batchLead.activity_description || \"\",\r\n                    agent_name: \"Imported\",\r\n                    company_id: companyId,\r\n                    import_job_id: jobId,\r\n                    created_at: batchLead.activity_date || new Date().toISOString(),\r\n                  });\r\n                }\r\n              });\r\n            }\r\n          }\r\n        }\r\n\r\n        // Insert activities\r\n        if (activitiesToInsert.length > 0) {\r\n          await supabase.from(\"lead_activities\").insert(activitiesToInsert);\r\n        }\r\n\r\n        // Update progress\r\n        const progressPercent = Math.round(((batchIndex + 1) / totalBatches) * 100);\r\n        setProgress(progressPercent);\r\n\r\n        // Update job progress in database\r\n        await supabase\r\n          .from(\"lead_import_jobs\")\r\n          .update({\r\n            imported_rows: importedRows,\r\n            skipped_rows: skippedRows,\r\n            failed_rows: failedRows,\r\n            duplicate_rows: duplicateRows,\r\n            error_details: errors.slice(0, 100), // Keep first 100 errors in job record\r\n          })\r\n          .eq(\"id\", jobId);\r\n      }\r\n\r\n      // Mark job as completed\r\n      const finalStatus = failedRows > 0 && importedRows === 0 ? \"failed\" : \"completed\";\r\n\r\n      await supabase\r\n        .from(\"lead_import_jobs\")\r\n        .update({\r\n          status: finalStatus,\r\n          imported_rows: importedRows,\r\n          skipped_rows: skippedRows,\r\n          failed_rows: failedRows,\r\n          duplicate_rows: duplicateRows,\r\n          error_details: errors.slice(0, 100),\r\n          completed_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"id\", jobId);\r\n\r\n      setIsImporting(false);\r\n      setProgress(100);\r\n\r\n      return {\r\n        jobId,\r\n        totalRows: leads.length,\r\n        importedRows,\r\n        skippedRows,\r\n        failedRows,\r\n        duplicateRows,\r\n        errors,\r\n        rollbackUntil: rollbackUntil.toISOString(),\r\n      };\r\n    } catch (error) {\r\n      console.error(\"Import error:\", error);\r\n      setIsImporting(false);\r\n      toast.error(\"Import failed unexpectedly\");\r\n      return null;\r\n    }\r\n  };\r\n\r\n  // STEP 3: Rollback import\r\n  const rollbackImport = async (jobId: string): Promise<boolean> => {\r\n    if (!user) {\r\n      toast.error(\"You must be logged in\");\r\n      return false;\r\n    }\r\n\r\n    const hasPermission = await checkUserRole();\r\n    if (!hasPermission) {\r\n      toast.error(\"Only Admin or Manager can rollback imports\");\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      const { data, error } = await supabase.rpc(\"rollback_import\", {\r\n        p_job_id: jobId,\r\n        p_user_id: user.id,\r\n      });\r\n\r\n      if (error) {\r\n        console.error(\"Rollback error:\", error);\r\n        toast.error(\"Rollback failed: \" + error.message);\r\n        return false;\r\n      }\r\n\r\n      const result = data as { success: boolean; error?: string; leads_deleted?: number };\r\n\r\n      if (result.success) {\r\n        toast.success(`Rolled back ${result.leads_deleted} leads`);\r\n        return true;\r\n      } else {\r\n        toast.error(result.error || \"Rollback failed\");\r\n        return false;\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Rollback error:\", error);\r\n      toast.error(\"Rollback failed unexpectedly\");\r\n      return false;\r\n    }\r\n  };\r\n\r\n  // Get import job history\r\n  const getImportHistory = async (): Promise<any[]> => {\r\n    const companyId = await getCompanyId();\r\n    if (!companyId) return [];\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"lead_import_jobs\")\r\n      .select(\"*\")\r\n      .eq(\"company_id\", companyId)\r\n      .order(\"created_at\", { ascending: false })\r\n      .limit(50);\r\n\r\n    if (error) {\r\n      console.error(\"Failed to fetch import history:\", error);\r\n      return [];\r\n    }\r\n\r\n    return data || [];\r\n  };\r\n\r\n  // Download error report for an import job\r\n  const downloadErrorReport = async (jobId: string): Promise<string | null> => {\r\n    const { data, error } = await supabase\r\n      .from(\"import_row_errors\")\r\n      .select(\"*\")\r\n      .eq(\"import_job_id\", jobId)\r\n      .order(\"row_number\");\r\n\r\n    if (error || !data) {\r\n      toast.error(\"Failed to fetch error report\");\r\n      return null;\r\n    }\r\n\r\n    // Create CSV content\r\n    const headers = [\"Row Number\", \"Error Type\", \"Error Message\", \"Raw Data\"];\r\n    const rows = data.map(e => [\r\n      e.row_number,\r\n      e.error_type,\r\n      e.error_message,\r\n      JSON.stringify(e.raw_row_data),\r\n    ]);\r\n\r\n    const csv = [\r\n      headers.join(\",\"),\r\n      ...rows.map(r => r.map(c => `\"${String(c).replace(/\"/g, '\"\"')}\"`).join(\",\")),\r\n    ].join(\"\\n\");\r\n\r\n    return csv;\r\n  };\r\n\r\n  return {\r\n    // Core functions\r\n    previewImport,\r\n    importLeads,\r\n    rollbackImport,\r\n\r\n    // Utility functions\r\n    getImportHistory,\r\n    downloadErrorReport,\r\n\r\n    // State\r\n    isImporting,\r\n    isPreviewing,\r\n    progress,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useLeadSources.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":13,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[454,457],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[454,457],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":14,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[493,496],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[493,496],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":105,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":105,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3390,3393],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3390,3393],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":133,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":133,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4187,4190],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4187,4190],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":150,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":150,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4634,4637],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4634,4637],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":189,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":189,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5784,5787],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5784,5787],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":197,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":197,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6041,6044],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6041,6044],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":198,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":198,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6082,6085],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6082,6085],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":223,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":223,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6742,6745],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6742,6745],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'testConnection'. Either include it or remove the dependency array.","line":227,"column":6,"nodeType":"ArrayExpression","endLine":227,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [fetchSources, testConnection]","fix":{"range":[6866,6880],"text":"[fetchSources, testConnection]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":244,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":244,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7348,7351],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7348,7351],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":260,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":260,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7859,7862],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7859,7862],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":289,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":289,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8819,8822],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8819,8822],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":319,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":319,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9754,9757],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9754,9757],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":407,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":407,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12881,12884],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12881,12884],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":451,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":451,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14424,14427],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14424,14427],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":458,"column":96,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":458,"endColumn":99,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14683,14686],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14683,14686],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":468,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":468,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14986,14989],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14986,14989],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":486,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":486,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15547,15550],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15547,15550],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":18,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback, useRef } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { useAutoCompany } from '@/hooks/useAutoCompany';\r\nimport { toast } from 'sonner';\r\n\r\nexport interface LeadSource {\r\n  id: string;\r\n  company_id: string;\r\n  source_name: string;\r\n  display_name: string;\r\n  connection_type: string;\r\n  connection_details: Record<string, any>;\r\n  field_mapping: Record<string, any>;\r\n  status: 'connected' | 'disconnected' | 'pending' | 'error';\r\n  is_active: boolean;\r\n  last_fetched_at: string | null;\r\n  last_error: string | null;\r\n  total_leads_fetched: number;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface LeadSourceLog {\r\n  id: string;\r\n  source_id: string | null;\r\n  company_id: string;\r\n  action: string;\r\n  status: string;\r\n  leads_processed: number;\r\n  leads_created: number;\r\n  leads_updated: number;\r\n  leads_skipped: number;\r\n  error_message: string | null;\r\n  created_at: string;\r\n}\r\n\r\nexport interface LeadWebhook {\r\n  id: string;\r\n  source_id: string;\r\n  company_id: string;\r\n  webhook_url: string;\r\n  secret_key: string;\r\n  verify_token: string;\r\n  is_active: boolean;\r\n  last_received_at: string | null;\r\n  total_received: number;\r\n}\r\n\r\nconst SOURCE_CONFIGS = [\r\n  { name: 'meta', display_name: 'Meta (Facebook / Instagram)', connection_type: 'oauth' },\r\n  { name: 'tiktok', display_name: 'TikTok', connection_type: 'oauth' },\r\n  { name: 'linkedin', display_name: 'LinkedIn', connection_type: 'oauth' },\r\n  { name: 'website', display_name: 'Website', connection_type: 'webhook' },\r\n  { name: 'property_finder', display_name: 'Property Finder', connection_type: 'api' },\r\n  { name: 'bayut', display_name: 'Bayut', connection_type: 'api' },\r\n  { name: 'dubizzle', display_name: 'Dubizzle', connection_type: 'api' },\r\n  { name: 'google_sheets', display_name: 'Google Sheets', connection_type: 'oauth' },\r\n];\r\n\r\nexport function useLeadSources() {\r\n  const { user } = useAuth();\r\n  const { companyId, isLoading: companyLoading, error: companyError } = useAutoCompany();\r\n  const [sources, setSources] = useState<LeadSource[]>([]);\r\n  const [logs, setLogs] = useState<LeadSourceLog[]>([]);\r\n  const [webhooks, setWebhooks] = useState<LeadWebhook[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const fetchSourcesRef = useRef<(() => Promise<void>) | null>(null);\r\n  const fetchLogsRef = useRef<((sourceId?: string) => Promise<void>) | null>(null);\r\n\r\n  // Sync loading and error state from useAutoCompany\r\n  useEffect(() => {\r\n    if (companyError) {\r\n      setError(companyError);\r\n      setIsLoading(false);\r\n    }\r\n  }, [companyError]);\r\n\r\n  // Fetch sources with error handling\r\n  const fetchSources = useCallback(async () => {\r\n    if (!companyId) {\r\n\r\n      return;\r\n    }\r\n\r\n\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const { data, error: fetchError } = await supabase\r\n        .from('lead_sources')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .order('created_at', { ascending: true });\r\n\r\n      if (fetchError) {\r\n        console.error('[useLeadSources] Error fetching lead_sources:', fetchError);\r\n        throw fetchError;\r\n      }\r\n\r\n\r\n      setSources((data || []) as LeadSource[]);\r\n    } catch (err: any) {\r\n      console.error('[useLeadSources] fetchSources error:', err);\r\n      setError('Failed to load lead sources');\r\n      toast.error('Failed to load lead sources');\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [companyId]);\r\n\r\n  // Fetch logs\r\n  const fetchLogs = useCallback(async (sourceId?: string) => {\r\n    if (!companyId) return;\r\n\r\n    try {\r\n      let query = supabase\r\n        .from('lead_source_logs')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .order('created_at', { ascending: false })\r\n        .limit(50);\r\n\r\n      if (sourceId) {\r\n        query = query.eq('source_id', sourceId);\r\n      }\r\n\r\n      const { data, error } = await query;\r\n      if (error) throw error;\r\n      setLogs((data || []) as LeadSourceLog[]);\r\n    } catch (error: any) {\r\n      console.error('Error fetching logs:', error);\r\n    }\r\n  }, [companyId]);\r\n\r\n  // Fetch webhooks\r\n  const fetchWebhooks = useCallback(async () => {\r\n    if (!companyId) return;\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('lead_webhooks')\r\n        .select('*')\r\n        .eq('company_id', companyId);\r\n\r\n      if (error) throw error;\r\n      setWebhooks((data || []) as LeadWebhook[]);\r\n    } catch (error: any) {\r\n      console.error('Error fetching webhooks:', error);\r\n    }\r\n  }, [companyId]);\r\n\r\n  // Keep refs updated\r\n  useEffect(() => {\r\n    fetchSourcesRef.current = fetchSources;\r\n  }, [fetchSources]);\r\n\r\n  useEffect(() => {\r\n    fetchLogsRef.current = fetchLogs;\r\n  }, [fetchLogs]);\r\n\r\n  // Initialize sources for company\r\n  const initializeSources = useCallback(async () => {\r\n    if (!companyId) return;\r\n\r\n    try {\r\n      const existingSources = sources.map(s => s.source_name);\r\n      const missingSources = SOURCE_CONFIGS.filter(c => !existingSources.includes(c.name));\r\n\r\n      if (missingSources.length > 0) {\r\n        const { error } = await supabase\r\n          .from('lead_sources')\r\n          .insert(\r\n            missingSources.map(config => ({\r\n              company_id: companyId,\r\n              source_name: config.name,\r\n              display_name: config.display_name,\r\n              connection_type: config.connection_type,\r\n              status: 'disconnected',\r\n              created_by: user?.id\r\n            }))\r\n          );\r\n\r\n        if (error) throw error;\r\n        await fetchSources();\r\n      }\r\n    } catch (error: any) {\r\n      console.error('Error initializing sources:', error);\r\n    }\r\n  }, [companyId, sources, user?.id, fetchSources]);\r\n\r\n  // Connect source\r\n  const connectSource = useCallback(async (\r\n    sourceId: string,\r\n    connectionDetails: Record<string, any>,\r\n    fieldMapping?: Record<string, any>\r\n  ) => {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('lead_sources')\r\n        .update({\r\n          connection_details: connectionDetails,\r\n          field_mapping: fieldMapping || {},\r\n          status: 'pending'\r\n        })\r\n        .eq('id', sourceId);\r\n\r\n      if (error) throw error;\r\n\r\n      // Test connection\r\n      const testResult = await testConnection(sourceId);\r\n\r\n      if (testResult.success) {\r\n        toast.success('Source connected successfully');\r\n      } else {\r\n        toast.error(testResult.error || 'Connection failed');\r\n      }\r\n\r\n      await fetchSources();\r\n      return testResult;\r\n    } catch (error: any) {\r\n      toast.error('Failed to connect source');\r\n      return { success: false, error: error.message };\r\n    }\r\n  }, [fetchSources]);\r\n\r\n  // Disconnect source\r\n  const disconnectSource = useCallback(async (sourceId: string) => {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('lead_sources')\r\n        .update({\r\n          connection_details: {},\r\n          status: 'disconnected',\r\n          last_error: null\r\n        })\r\n        .eq('id', sourceId);\r\n\r\n      if (error) throw error;\r\n      toast.success('Source disconnected');\r\n      await fetchSources();\r\n    } catch (error: any) {\r\n      toast.error('Failed to disconnect source');\r\n    }\r\n  }, [fetchSources]);\r\n\r\n  // Test connection\r\n  const testConnection = useCallback(async (sourceId: string) => {\r\n    if (!companyId) return { success: false, error: 'No company' };\r\n\r\n    try {\r\n      const { data, error } = await supabase.functions.invoke('lead-source-fetch', {\r\n        body: { source_id: sourceId, company_id: companyId, action: 'test' }\r\n      });\r\n\r\n      if (error) throw error;\r\n      return data;\r\n    } catch (error: any) {\r\n      return { success: false, error: error.message };\r\n    }\r\n  }, [companyId]);\r\n\r\n  // Get Meta forms from connected pages\r\n  const getMetaForms = useCallback(async (sourceId: string) => {\r\n    if (!companyId) return [];\r\n\r\n    try {\r\n      const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;\r\n      const { data: { session } } = await supabase.auth.getSession();\r\n\r\n      const response = await fetch(\r\n        `${supabaseUrl}/functions/v1/meta-oauth?action=get_forms`,\r\n        {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n            'Authorization': `Bearer ${session?.access_token || ''}`\r\n          },\r\n          body: JSON.stringify({ source_id: sourceId, company_id: companyId })\r\n        }\r\n      );\r\n\r\n      const data = await response.json();\r\n      if (!response.ok) throw new Error(data.error || 'Failed to fetch forms');\r\n\r\n      return data.forms || [];\r\n    } catch (error: any) {\r\n      console.error('Error fetching Meta forms:', error);\r\n      return [];\r\n    }\r\n  }, [companyId]);\r\n\r\n  // Get TikTok forms\r\n  const getTikTokForms = useCallback(async () => {\r\n    if (!companyId) return [];\r\n\r\n    try {\r\n      const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;\r\n      const { data: { session } } = await supabase.auth.getSession();\r\n\r\n      const response = await fetch(\r\n        `${supabaseUrl}/functions/v1/tiktok-integration?action=get_forms`,\r\n        {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n            'Authorization': `Bearer ${session?.access_token || ''}`\r\n          },\r\n          body: JSON.stringify({ company_id: companyId })\r\n        }\r\n      );\r\n\r\n      const data = await response.json();\r\n      if (!response.ok) throw new Error(data.error || 'Failed to fetch forms');\r\n\r\n      return data.forms || [];\r\n    } catch (error: any) {\r\n      console.error('Error fetching TikTok forms:', error);\r\n      return [];\r\n    }\r\n  }, [companyId]);\r\n\r\n  // Fetch leads manually with optional filters\r\n  const fetchLeads = useCallback(async (\r\n    sourceId: string,\r\n    options?: { form_ids?: string[]; date_from?: string; date_to?: string }\r\n  ) => {\r\n    if (!companyId) return { success: false, error: 'No company' };\r\n\r\n    try {\r\n      toast.loading('Fetching leads...', { id: 'fetch-leads' });\r\n\r\n      // Find the source to check its type\r\n      const source = sources.find(s => s.id === sourceId);\r\n      let data;\r\n\r\n      if (source?.source_name === 'meta') {\r\n        // Use Meta OAuth edge function for fetching - action must be in query params\r\n        const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;\r\n        const { data: { session } } = await supabase.auth.getSession();\r\n\r\n        const response = await fetch(\r\n          `${supabaseUrl}/functions/v1/meta-oauth?action=fetch_leads`,\r\n          {\r\n            method: 'POST',\r\n            headers: {\r\n              'Content-Type': 'application/json',\r\n              'Authorization': `Bearer ${session?.access_token || ''}`\r\n            },\r\n            body: JSON.stringify({\r\n              source_id: sourceId,\r\n              company_id: companyId,\r\n              form_ids: options?.form_ids,\r\n              date_from: options?.date_from,\r\n              date_to: options?.date_to\r\n            })\r\n          }\r\n        );\r\n\r\n        data = await response.json();\r\n        if (!response.ok) throw new Error(data.error || 'Failed to fetch');\r\n      } else if (source?.source_name === 'tiktok') {\r\n        // Use TikTok integration edge function\r\n        const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;\r\n        const { data: { session } } = await supabase.auth.getSession();\r\n\r\n        const response = await fetch(\r\n          `${supabaseUrl}/functions/v1/tiktok-integration?action=fetch_leads`,\r\n          {\r\n            method: 'POST',\r\n            headers: {\r\n              'Content-Type': 'application/json',\r\n              'Authorization': `Bearer ${session?.access_token || ''}`\r\n            },\r\n            body: JSON.stringify({\r\n              form_ids: options?.form_ids,\r\n              date_from: options?.date_from,\r\n              date_to: options?.date_to\r\n            })\r\n          }\r\n        );\r\n\r\n        data = await response.json();\r\n        if (!response.ok) throw new Error(data.error || 'Failed to fetch');\r\n      } else {\r\n        // Use generic lead-source-fetch for other sources\r\n        const response = await supabase.functions.invoke('lead-source-fetch', {\r\n          body: { source_id: sourceId, company_id: companyId, action: 'fetch' }\r\n        });\r\n\r\n        if (response.error) throw response.error;\r\n        data = response.data;\r\n      }\r\n\r\n      toast.dismiss('fetch-leads');\r\n      if (data.success) {\r\n        toast.success(`Fetched ${data.created || 0} new leads`);\r\n      } else {\r\n        toast.error(data.error || 'Fetch failed');\r\n      }\r\n\r\n      await fetchSources();\r\n      await fetchLogs(sourceId);\r\n      return data;\r\n    } catch (error: any) {\r\n      toast.dismiss('fetch-leads');\r\n      toast.error('Failed to fetch leads');\r\n      return { success: false, error: error.message };\r\n    }\r\n  }, [companyId, sources, fetchSources, fetchLogs]);\r\n\r\n  // Get webhook URL for source\r\n  const getWebhookUrl = useCallback((sourceId: string) => {\r\n    const source = sources.find(s => s.id === sourceId);\r\n    if (!source || !companyId) return '';\r\n\r\n    const baseUrl = import.meta.env.VITE_SUPABASE_URL;\r\n    const webhook = webhooks.find(w => w.source_id === sourceId);\r\n    const verifyToken = webhook?.verify_token || '';\r\n\r\n    return `${baseUrl}/functions/v1/lead-source-webhook?source=${source.source_name}&company_id=${companyId}&verify_token=${verifyToken}`;\r\n  }, [sources, webhooks, companyId]);\r\n\r\n  // Create webhook for source\r\n  const createWebhook = useCallback(async (sourceId: string) => {\r\n    if (!companyId) return null;\r\n\r\n    try {\r\n      const source = sources.find(s => s.id === sourceId);\r\n      if (!source) return null;\r\n\r\n      const webhookUrl = `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/lead-source-webhook?source=${source.source_name}&company_id=${companyId}`;\r\n\r\n      const { data, error } = await supabase\r\n        .from('lead_webhooks')\r\n        .insert({\r\n          source_id: sourceId,\r\n          company_id: companyId,\r\n          webhook_url: webhookUrl,\r\n          is_active: true\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      await fetchWebhooks();\r\n      return data;\r\n    } catch (error: any) {\r\n      console.error('Error creating webhook:', error);\r\n      return null;\r\n    }\r\n  }, [companyId, sources, fetchWebhooks]);\r\n\r\n  // Update field mapping\r\n  const updateFieldMapping = useCallback(async (sourceId: string, fieldMapping: Record<string, any>) => {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('lead_sources')\r\n        .update({ field_mapping: fieldMapping })\r\n        .eq('id', sourceId);\r\n\r\n      if (error) throw error;\r\n      toast.success('Field mapping updated');\r\n      await fetchSources();\r\n    } catch (error: any) {\r\n      toast.error('Failed to update field mapping');\r\n    }\r\n  }, [fetchSources]);\r\n\r\n  // Mark website source as connected\r\n  const markWebsiteConnected = useCallback(async (sourceId: string) => {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('lead_sources')\r\n        .update({\r\n          status: 'connected',\r\n          connection_details: { embed_installed: true, installed_at: new Date().toISOString() }\r\n        })\r\n        .eq('id', sourceId);\r\n\r\n      if (error) throw error;\r\n      await fetchSources();\r\n    } catch (error: any) {\r\n      console.error('Failed to mark website as connected:', error);\r\n    }\r\n  }, [fetchSources]);\r\n\r\n  // Initialize on mount\r\n  useEffect(() => {\r\n    if (companyId) {\r\n      fetchSources();\r\n      fetchLogs();\r\n      fetchWebhooks();\r\n    }\r\n  }, [companyId, fetchSources, fetchLogs, fetchWebhooks]);\r\n\r\n  // Initialize sources after first fetch\r\n  useEffect(() => {\r\n    if (companyId && sources.length === 0 && !isLoading) {\r\n      initializeSources();\r\n    }\r\n  }, [companyId, sources.length, isLoading, initializeSources]);\r\n\r\n  // Real-time subscription\r\n  useEffect(() => {\r\n    if (!companyId) return;\r\n\r\n    const channel = supabase\r\n      .channel('lead-sources-changes')\r\n      .on(\r\n        'postgres_changes',\r\n        { event: '*', schema: 'public', table: 'lead_sources', filter: `company_id=eq.${companyId}` },\r\n        () => {\r\n          if (fetchSourcesRef.current) fetchSourcesRef.current();\r\n        }\r\n      )\r\n      .on(\r\n        'postgres_changes',\r\n        { event: 'INSERT', schema: 'public', table: 'lead_source_logs', filter: `company_id=eq.${companyId}` },\r\n        () => {\r\n          if (fetchLogsRef.current) fetchLogsRef.current();\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [companyId]); // Removed fetch functions - using ref pattern\r\n\r\n  return {\r\n    sources,\r\n    logs,\r\n    webhooks,\r\n    isLoading: isLoading || companyLoading,\r\n    companyId,\r\n    error,\r\n    connectSource,\r\n    disconnectSource,\r\n    testConnection,\r\n    fetchLeads,\r\n    getMetaForms,\r\n    getTikTokForms,\r\n    getWebhookUrl,\r\n    createWebhook,\r\n    updateFieldMapping,\r\n    markWebsiteConnected,\r\n    refetch: fetchSources,\r\n    refetchLogs: fetchLogs,\r\n    SOURCE_CONFIGS\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useLeads.ts","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'refreshSession'. Either include it or remove the dependency array.","line":285,"column":6,"nodeType":"ArrayExpression","endLine":285,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [fetchLeads, refreshSession]","fix":{"range":[9815,9827],"text":"[fetchLeads, refreshSession]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef, useCallback } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { toast } from \"sonner\";\r\nimport type { Json } from \"@/integrations/supabase/types\";\r\nexport interface Lead {\r\n  id: string;\r\n  company_id: string | null;\r\n  name: string;\r\n  phone: string | null;\r\n  email: string | null;\r\n  source: string | null;\r\n  stage: string | null;\r\n  stage_id: string | null;\r\n  budget: string | null;\r\n  requirements: string | null;\r\n  location: string | null;\r\n  assigned_agent_id: string | null;\r\n  lead_group_id: string | null;\r\n  tags: string[] | null;\r\n  lead_score: number | null;\r\n  gender: string | null;\r\n  nationality: string | null;\r\n  language: string | null;\r\n  preferred_contact_time: string | null;\r\n  purpose: string | null;\r\n  property_type: string | null;\r\n  bedrooms: string | null;\r\n  furnished: string | null;\r\n  move_in_date: string | null;\r\n  form_data: Json | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n  last_contacted_at: string | null;\r\n  // New fields for Meta lead tracking\r\n  received_at: string | null;\r\n  is_new: boolean | null;\r\n  agent?: {\r\n    id: string;\r\n    name: string;\r\n    avatar_url: string | null;\r\n  } | null;\r\n  lead_group?: {\r\n    id: string;\r\n    name: string;\r\n    color: string;\r\n  } | null;\r\n  lead_stage?: {\r\n    id: string;\r\n    name: string;\r\n    color: string;\r\n    position: number;\r\n    is_default: boolean;\r\n    is_won: boolean;\r\n    is_lost: boolean;\r\n  } | null;\r\n}\r\n\r\nexport function useLeads() {\r\n  const { refreshSession } = useAuth();\r\n  const [leads, setLeads] = useState<Lead[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const retryCountRef = useRef(0);\r\n\r\n  const fetchLeads = useCallback(async () => {\r\n    // #region agent log\r\n    fetch('http://127.0.0.1:7242/ingest/64664f1c-2aa5-4d5b-a8e0-b4c2f83d09ac', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'useLeads.ts:66', message: 'fetchLeads entry', data: { retryCount: retryCountRef.current, refreshSessionExists: !!refreshSession }, timestamp: Date.now(), sessionId: 'debug-session', runId: 'run1', hypothesisId: 'A' }) }).catch(() => { });\r\n    // #endregion\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    // Fetch all leads - override Supabase's default 1000 row limit\r\n    const { data, error: fetchError } = await supabase\r\n      .from(\"leads\")\r\n      .select(`\r\n        *,\r\n        agent:agents!assigned_agent_id (\r\n          id,\r\n          name,\r\n          avatar_url\r\n        ),\r\n        lead_group:lead_groups!lead_group_id (\r\n          id,\r\n          name,\r\n          color\r\n        ),\r\n        lead_stage:lead_stages!stage_id (\r\n          id,\r\n          name,\r\n          color,\r\n          position,\r\n          is_default,\r\n          is_won,\r\n          is_lost\r\n        )\r\n      `)\r\n      .order(\"created_at\", { ascending: false })\r\n      .limit(10000); // Explicitly set higher limit to get all leads\r\n\r\n    if (fetchError) {\r\n      // Check if it's a JWT error\r\n      const isJwtError = fetchError.message?.includes('JWT') ||\r\n        fetchError.code === 'PGRST301' ||\r\n        fetchError.code === 'PGRST303';\r\n\r\n      if (isJwtError && retryCountRef.current < 2) {\r\n        retryCountRef.current += 1;\r\n        // #region agent log\r\n        fetch('http://127.0.0.1:7242/ingest/64664f1c-2aa5-4d5b-a8e0-b4c2f83d09ac', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'useLeads.ts:104', message: 'JWT error detected, attempting refresh', data: { retryCount: retryCountRef.current, refreshSessionExists: !!refreshSession }, timestamp: Date.now(), sessionId: 'debug-session', runId: 'run1', hypothesisId: 'A' }) }).catch(() => { });\r\n        // #endregion\r\n        const refreshed = await refreshSession();\r\n        // #region agent log\r\n        fetch('http://127.0.0.1:7242/ingest/64664f1c-2aa5-4d5b-a8e0-b4c2f83d09ac', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'useLeads.ts:107', message: 'Session refresh result', data: { refreshed, retryCount: retryCountRef.current }, timestamp: Date.now(), sessionId: 'debug-session', runId: 'run1', hypothesisId: 'A' }) }).catch(() => { });\r\n        // #endregion\r\n        if (refreshed) {\r\n          setTimeout(() => fetchLeads(), 500);\r\n          return;\r\n        }\r\n      }\r\n\r\n      setError(fetchError.message);\r\n      setLeads([]);\r\n    } else {\r\n      retryCountRef.current = 0;\r\n      setLeads((data as Lead[]) || []);\r\n    }\r\n    setIsLoading(false);\r\n  }, [refreshSession]);\r\n\r\n  useEffect(() => {\r\n    // #region agent log\r\n    fetch('http://127.0.0.1:7242/ingest/64664f1c-2aa5-4d5b-a8e0-b4c2f83d09ac', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'useLeads.ts:122', message: 'useEffect entry - fetchLeads called', data: { refreshSessionExists: !!refreshSession, retryCount: retryCountRef.current }, timestamp: Date.now(), sessionId: 'debug-session', runId: 'run1', hypothesisId: 'A' }) }).catch(() => { });\r\n    // #endregion\r\n    fetchLeads();\r\n\r\n    // Subscribe to real-time changes with unique channel name\r\n    const channelName = `leads-realtime-${Date.now()}`;\r\n    // #region agent log\r\n    fetch('http://127.0.0.1:7242/ingest/64664f1c-2aa5-4d5b-a8e0-b4c2f83d09ac', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'useLeads.ts:127', message: 'Creating realtime channel', data: { channelName }, timestamp: Date.now(), sessionId: 'debug-session', runId: 'run1', hypothesisId: 'A' }) }).catch(() => { });\r\n    // #endregion\r\n    const channel = supabase\r\n      .channel(channelName)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: 'INSERT',\r\n          schema: 'public',\r\n          table: 'leads',\r\n        },\r\n        async (payload) => {\r\n\r\n\r\n          try {\r\n            // Fetch the full lead with agent relation\r\n            const { data, error } = await supabase\r\n              .from(\"leads\")\r\n              .select(`\r\n                *,\r\n                agent:agents!assigned_agent_id (\r\n                  id,\r\n                  name,\r\n                  avatar_url\r\n                ),\r\n                lead_group:lead_groups!lead_group_id (\r\n                  id,\r\n                  name,\r\n                  color\r\n                ),\r\n                lead_stage:lead_stages!stage_id (\r\n                  id,\r\n                  name,\r\n                  color,\r\n                  position,\r\n                  is_default,\r\n                  is_won,\r\n                  is_lost\r\n                )\r\n              `)\r\n              .eq('id', payload.new.id)\r\n              .single();\r\n\r\n            if (error) {\r\n              console.error('Error fetching new lead details:', error);\r\n              // Still try to add with basic payload data\r\n              const basicLead = payload.new as Lead;\r\n              setLeads((prev) => {\r\n                if (prev.some(lead => lead.id === basicLead.id)) {\r\n                  return prev;\r\n                }\r\n                return [basicLead, ...prev];\r\n              });\r\n              toast.success(`New lead: ${basicLead.name || 'Unknown'}`, {\r\n                description: `Source: ${basicLead.source || 'Direct'} â€¢ ${basicLead.phone || basicLead.email || 'No contact'}`,\r\n                duration: 5000,\r\n              });\r\n              return;\r\n            }\r\n\r\n            if (data) {\r\n\r\n              setLeads((prev) => {\r\n                // Check if lead already exists to avoid duplicates\r\n                if (prev.some(lead => lead.id === data.id)) {\r\n\r\n                  return prev;\r\n                }\r\n\r\n                return [data as Lead, ...prev];\r\n              });\r\n\r\n              // Show notification for new lead\r\n              toast.success(`New lead: ${data.name || 'Unknown'}`, {\r\n                description: `Source: ${data.source || 'Direct'} â€¢ ${data.phone || data.email || 'No contact'}`,\r\n                duration: 5000,\r\n              });\r\n            }\r\n          } catch (err) {\r\n            console.error('Exception in realtime lead handler:', err);\r\n          }\r\n        }\r\n      )\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: 'UPDATE',\r\n          schema: 'public',\r\n          table: 'leads',\r\n        },\r\n        async (payload) => {\r\n\r\n          const { data } = await supabase\r\n            .from(\"leads\")\r\n            .select(`\r\n              *,\r\n              agent:agents!assigned_agent_id (\r\n                id,\r\n                name,\r\n                avatar_url\r\n              ),\r\n              lead_group:lead_groups!lead_group_id (\r\n                id,\r\n                name,\r\n                color\r\n              ),\r\n              lead_stage:lead_stages!stage_id (\r\n                id,\r\n                name,\r\n                color,\r\n                position,\r\n                is_default,\r\n                is_won,\r\n                is_lost\r\n              )\r\n            `)\r\n            .eq('id', payload.new.id)\r\n            .single();\r\n\r\n          if (data) {\r\n            setLeads((prev) =>\r\n              prev.map((lead) => lead.id === data.id ? data as Lead : lead)\r\n            );\r\n          }\r\n        }\r\n      )\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: 'DELETE',\r\n          schema: 'public',\r\n          table: 'leads',\r\n        },\r\n        (payload) => {\r\n\r\n          setLeads((prev) => prev.filter((lead) => lead.id !== payload.old.id));\r\n        }\r\n      )\r\n      .subscribe((status) => {\r\n\r\n      });\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [fetchLeads]);\r\n\r\n  const refetch = () => {\r\n    fetchLeads();\r\n  };\r\n\r\n  // Function to sync leads from Property Finder\r\n  const syncPropertyFinderLeads = async (companyId: string) => {\r\n    try {\r\n      const { data, error } = await supabase.functions.invoke('fetch-property-finder-leads', {\r\n        body: { company_id: companyId },\r\n      });\r\n\r\n      if (error) throw error;\r\n      return data;\r\n    } catch (err) {\r\n      console.error('Error syncing Property Finder leads:', err);\r\n      throw err;\r\n    }\r\n  };\r\n\r\n  return { leads, isLoading, error, refetch, setLeads, syncPropertyFinderLeads };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useLeadsQuery.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useListing.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":40,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1202,1205],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1202,1205],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":168,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":168,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5304,5307],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5304,5307],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchListing'. Either include it or remove the dependency array.","line":179,"column":6,"nodeType":"ArrayExpression","endLine":179,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [fetchListing, id]","fix":{"range":[5528,5532],"text":"[fetchListing, id]"}}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\n\r\nexport interface ListingDetail {\r\n  id: string;\r\n  title: string;\r\n  title_ar: string | null;\r\n  description: string | null;\r\n  description_ar: string | null;\r\n  price: number | null;\r\n  currency: string;\r\n  address: string | null;\r\n  city: string | null;\r\n  country: string | null;\r\n  number_of_bedrooms: number | null;\r\n  number_of_bathrooms: number | null;\r\n  area_size: number | null;\r\n  area_unit: string | null;\r\n  property_type: string | null;\r\n  listing_type: string | null;\r\n  status: string;\r\n  furnished: string | null;\r\n  completion_status: string | null;\r\n  permit_number: string | null;\r\n  reference_number: string | null;\r\n  rent_frequency: string | null;\r\n  developer: string | null;\r\n  project_name: string | null;\r\n  building_name: string | null;\r\n  handover_date: string | null;\r\n  floor_number: number | null;\r\n  parking_spaces: number | null;\r\n  latitude: number | null;\r\n  longitude: number | null;\r\n  plot_size: number | null;\r\n  virtual_tour_url: string | null;\r\n  view_type: string | null;\r\n  ownership_type: string | null;\r\n  service_charge: number | null;\r\n  videos: any[];\r\n  images: string[];\r\n  amenities: string[];\r\n  tags: string[];\r\n  created_at: string;\r\n  updated_at: string;\r\n  assigned_agent_id: string | null;\r\n  agent: {\r\n    id: string;\r\n    name: string;\r\n    email: string;\r\n    phone: string | null;\r\n    avatar_url: string | null;\r\n  } | null;\r\n  views: number;\r\n  inquiries: number;\r\n  portals: Array<{\r\n    portal_name: string;\r\n    publish_status: string;\r\n    last_sync_at: string | null;\r\n  }>;\r\n}\r\n\r\nexport function useListing(id: string | undefined) {\r\n  const [listing, setListing] = useState<ListingDetail | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const fetchListing = async () => {\r\n    if (!id) {\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      // Fetch listing with agent info\r\n      const { data, error: fetchError } = await supabase\r\n        .from(\"listings\")\r\n        .select(`\r\n          *,\r\n          agents!listings_assigned_agent_id_fkey (\r\n            id,\r\n            name,\r\n            email,\r\n            phone,\r\n            avatar_url,\r\n            user_id\r\n          )\r\n        `)\r\n        .eq(\"id\", id)\r\n        .maybeSingle();\r\n\r\n      if (fetchError) throw fetchError;\r\n\r\n      if (!data) {\r\n        setError(\"Listing not found\");\r\n        setListing(null);\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n\r\n      // Fetch profile name and avatar if agent has user_id\r\n      let agentDisplayName = data.agents?.name || null;\r\n      let agentAvatarUrl = data.agents?.avatar_url || null;\r\n      if (data.agents?.user_id) {\r\n        const { data: profile } = await supabase\r\n          .from(\"profiles\")\r\n          .select(\"first_name, last_name, avatar_url\")\r\n          .eq(\"id\", data.agents.user_id)\r\n          .single();\r\n\r\n        if (profile) {\r\n          if (profile.first_name || profile.last_name) {\r\n            agentDisplayName = [profile.first_name, profile.last_name].filter(Boolean).join(\" \");\r\n          }\r\n          if (profile.avatar_url) {\r\n            agentAvatarUrl = profile.avatar_url;\r\n          }\r\n        }\r\n      }\r\n\r\n      // Fetch analytics\r\n      const { data: analytics } = await supabase\r\n        .from(\"listing_analytics\")\r\n        .select(\"views_count, inquiries_count\")\r\n        .eq(\"listing_id\", id);\r\n\r\n      // Fetch portal statuses\r\n      const { data: portals } = await supabase\r\n        .from(\"listing_portals\")\r\n        .select(\"portal_name, publish_status, last_sync_at\")\r\n        .eq(\"listing_id\", id);\r\n\r\n      const totalViews = analytics?.reduce((sum, a) => sum + (a.views_count || 0), 0) || 0;\r\n      const totalInquiries = analytics?.reduce((sum, a) => sum + (a.inquiries_count || 0), 0) || 0;\r\n\r\n      setListing({\r\n        ...data,\r\n        rent_frequency: data.rent_frequency || null,\r\n        developer: data.developer || null,\r\n        project_name: data.project_name || null,\r\n        building_name: data.building_name || null,\r\n        handover_date: data.handover_date || null,\r\n        floor_number: data.floor_number || null,\r\n        parking_spaces: data.parking_spaces || null,\r\n        latitude: data.latitude,\r\n        longitude: data.longitude,\r\n        plot_size: data.plot_size,\r\n        virtual_tour_url: data.virtual_tour_url,\r\n        view_type: data.view_type,\r\n        ownership_type: data.ownership_type,\r\n        service_charge: data.service_charge,\r\n        videos: Array.isArray(data.videos) ? data.videos : [],\r\n        images: Array.isArray(data.images) ? data.images as string[] : [],\r\n        amenities: Array.isArray(data.amenities) ? data.amenities as string[] : [],\r\n        tags: Array.isArray(data.tags) ? data.tags as string[] : [],\r\n        agent: data.agents ? {\r\n          ...data.agents,\r\n          name: agentDisplayName || data.agents.name,\r\n          avatar_url: agentAvatarUrl || data.agents.avatar_url,\r\n        } : null,\r\n        views: totalViews,\r\n        inquiries: totalInquiries,\r\n        portals: portals || [],\r\n      } as ListingDetail);\r\n    } catch (err: any) {\r\n      console.error(\"Error fetching listing:\", err);\r\n      setError(err.message);\r\n      setListing(null);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchListing();\r\n  }, [id]);\r\n\r\n  return { listing, isLoading, error, refetch: fetchListing };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useListings.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":92,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":92,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2675,2678],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2675,2678],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback, useRef } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\n\r\nexport interface Listing {\r\n  id: string;\r\n  title: string;\r\n  title_ar: string | null;\r\n  description: string | null;\r\n  description_ar: string | null;\r\n  price: number | null;\r\n  currency: string;\r\n  price_frequency: string | null;\r\n  location: string | null;\r\n  area: string | null;\r\n  city: string | null;\r\n  state: string | null;\r\n  country: string | null;\r\n  bedrooms: number | null;\r\n  bathrooms: number | null;\r\n  size: number | null;\r\n  size_unit: string | null;\r\n  property_type: string | null;\r\n  listing_type: string | null;\r\n  status: string;\r\n  furnishing: string | null;\r\n  completion_status: string | null;\r\n  permit_number: string | null;\r\n  ref_number: string | null;\r\n  reference_number: string | null;\r\n  amenities: string[] | null;\r\n  features: string[] | null;\r\n  tags: string[] | null;\r\n  images: string[] | null;\r\n  videos: string[] | null;\r\n  documents: string[] | null;\r\n  company_id: string | null;\r\n  created_by: string | null;\r\n  assigned_agent_id: string | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n  // New fields\r\n  latitude: number | null;\r\n  longitude: number | null;\r\n  plot_size: number | null;\r\n  view_type: string | null;\r\n  ownership_type: string | null;\r\n  service_charge: number | null;\r\n  developer: string | null;\r\n  project_name: string | null;\r\n  building_name: string | null;\r\n  floor_number: number | null;\r\n  parking_spaces: number | null;\r\n  virtual_tour_url: string | null;\r\n  // For UI compatibility\r\n  image?: string;\r\n  views?: number;\r\n  inquiries?: number;\r\n  portals?: string[];\r\n  agent?: { name: string; avatar?: string };\r\n  type?: string;\r\n}\r\n\r\nexport function useListings() {\r\n  const [listings, setListings] = useState<Listing[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const fetchListingsRef = useRef<() => Promise<void>>();\r\n\r\n  const fetchListings = useCallback(async () => {\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    // Fetch listings with agent info\r\n    const { data, error: fetchError } = await supabase\r\n      .from(\"listings\")\r\n      .select(`\r\n        *,\r\n        agents:assigned_agent_id (\r\n          id,\r\n          name,\r\n          avatar_url\r\n        )\r\n      `)\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (fetchError) {\r\n      console.error(\"Error fetching listings:\", fetchError);\r\n      setError(fetchError.message);\r\n      setListings([]);\r\n    } else {\r\n      // Transform DB data to UI format\r\n      const transformed = (data || []).map((item: any) => ({\r\n        ...item,\r\n        // UI compatibility fields\r\n        type: item.property_type || \"Apartment\",\r\n        image: item.images?.[0] || \"https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=400&h=300&fit=crop\",\r\n        views: 0,\r\n        inquiries: 0,\r\n        portals: [],\r\n        bedrooms: item.number_of_bedrooms,\r\n        bathrooms: item.number_of_bathrooms,\r\n        size: item.area_size,\r\n        size_unit: item.area_unit,\r\n        agent: item.agents\r\n          ? { name: item.agents.name, avatar: item.agents.avatar_url || \"\" }\r\n          : { name: \"Unassigned\", avatar: \"\" },\r\n      }));\r\n      setListings(transformed);\r\n    }\r\n    setIsLoading(false);\r\n  }, []);\r\n\r\n  // Keep ref updated\r\n  useEffect(() => {\r\n    fetchListingsRef.current = fetchListings;\r\n  }, [fetchListings]);\r\n\r\n  useEffect(() => {\r\n    fetchListings();\r\n\r\n    // Subscribe to real-time changes\r\n    const channel = supabase\r\n      .channel(\"listings-realtime\")\r\n      .on(\r\n        \"postgres_changes\",\r\n        {\r\n          event: \"INSERT\",\r\n          schema: \"public\",\r\n          table: \"listings\",\r\n        },\r\n        (payload) => {\r\n\r\n          const newListing = {\r\n            ...payload.new,\r\n            type: payload.new.property_type || \"Apartment\",\r\n            image: payload.new.images?.[0] || \"https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=400&h=300&fit=crop\",\r\n            views: 0,\r\n            inquiries: 0,\r\n            portals: [],\r\n            bedrooms: payload.new.number_of_bedrooms,\r\n            bathrooms: payload.new.number_of_bathrooms,\r\n            size: payload.new.area_size,\r\n            size_unit: payload.new.area_unit,\r\n            agent: { name: \"Unassigned\", avatar: \"\" },\r\n          } as Listing;\r\n          setListings((prev) => [newListing, ...prev]);\r\n        }\r\n      )\r\n      .on(\r\n        \"postgres_changes\",\r\n        {\r\n          event: \"UPDATE\",\r\n          schema: \"public\",\r\n          table: \"listings\",\r\n        },\r\n        (payload) => {\r\n\r\n          setListings((prev) =>\r\n            prev.map((listing) =>\r\n              listing.id === payload.new.id\r\n                ? {\r\n                  ...payload.new,\r\n                  type: payload.new.property_type || \"Apartment\",\r\n                  image: payload.new.images?.[0] || listing.image,\r\n                  views: listing.views,\r\n                  inquiries: listing.inquiries,\r\n                  portals: listing.portals,\r\n                  agent: listing.agent,\r\n                  bedrooms: payload.new.number_of_bedrooms,\r\n                  bathrooms: payload.new.number_of_bathrooms,\r\n                  size: payload.new.area_size,\r\n                  size_unit: payload.new.area_unit,\r\n                } as Listing\r\n                : listing\r\n            )\r\n          );\r\n        }\r\n      )\r\n      .on(\r\n        \"postgres_changes\",\r\n        {\r\n          event: \"DELETE\",\r\n          schema: \"public\",\r\n          table: \"listings\",\r\n        },\r\n        (payload) => {\r\n\r\n          setListings((prev) => prev.filter((listing) => listing.id !== payload.old.id));\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [fetchListings]);\r\n\r\n  const refetch = () => {\r\n    fetchListings();\r\n  };\r\n\r\n  return { listings, isLoading, error, refetch, setListings };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useLocationSearch.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useMarketingConnections.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":75,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2439,2442],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2439,2442],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":120,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3912,3915],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3912,3915],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":144,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":144,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4733,4736],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4733,4736],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":164,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":164,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5348,5351],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5348,5351],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { useAutoCompany } from '@/hooks/useAutoCompany';\r\nimport { toast } from 'sonner';\r\n\r\nexport type ChannelType = 'whatsapp' | 'email' | 'sms';\r\nexport type ConnectionStatus = 'connected' | 'disconnected' | 'error';\r\nexport type HealthStatus = 'healthy' | 'degraded' | 'failed' | 'unknown';\r\n\r\nexport interface MarketingConnection {\r\n  id: string;\r\n  company_id: string | null;\r\n  channel: ChannelType;\r\n  provider: string;\r\n  display_name: string;\r\n  identifier: string;\r\n  status: ConnectionStatus;\r\n  credentials: Record<string, string>;\r\n  verified: boolean;\r\n  last_sync: string | null;\r\n  last_health_check: string | null;\r\n  health_status: HealthStatus;\r\n  created_at: string;\r\n  updated_at: string;\r\n  created_by: string | null;\r\n}\r\n\r\nexport interface ConnectionInput {\r\n  channel: ChannelType;\r\n  provider: string;\r\n  displayName: string;\r\n  identifier: string;\r\n  credentials: Record<string, string>;\r\n  verified?: boolean;\r\n}\r\n\r\nexport function useMarketingConnections() {\r\n  const { user } = useAuth();\r\n  const { companyId, isLoading: companyLoading } = useAutoCompany();\r\n  const [connections, setConnections] = useState<MarketingConnection[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  // Fetch all connections for the user's company\r\n  const fetchConnections = useCallback(async () => {\r\n    if (!user || !companyId || companyLoading) {\r\n      if (!companyLoading) {\r\n        setConnections([]);\r\n        setIsLoading(false);\r\n      }\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setIsLoading(true);\r\n      const { data, error: fetchError } = await supabase\r\n        .from('marketing_connections')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (fetchError) throw fetchError;\r\n      \r\n      const mapped: MarketingConnection[] = (data || []).map(row => ({\r\n        ...row,\r\n        channel: row.channel as ChannelType,\r\n        status: row.status as ConnectionStatus,\r\n        health_status: row.health_status as HealthStatus,\r\n        credentials: (row.credentials || {}) as Record<string, string>,\r\n      }));\r\n      \r\n      setConnections(mapped);\r\n      setError(null);\r\n    } catch (err: any) {\r\n      console.error('Error fetching connections:', err);\r\n      setError(err.message);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [user, companyId, companyLoading]);\r\n\r\n  // Add a new connection\r\n  const addConnection = useCallback(async (input: ConnectionInput): Promise<MarketingConnection | null> => {\r\n    if (!user || !companyId) {\r\n      toast.error('Please log in to add connections');\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      const { data, error: insertError } = await supabase\r\n        .from('marketing_connections')\r\n        .insert({\r\n          company_id: companyId,\r\n          channel: input.channel,\r\n          provider: input.provider,\r\n          display_name: input.displayName,\r\n          identifier: input.identifier,\r\n          credentials: input.credentials,\r\n          verified: input.verified || false,\r\n          status: 'connected',\r\n          last_sync: new Date().toISOString(),\r\n          created_by: user.id,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (insertError) throw insertError;\r\n      \r\n      const mapped: MarketingConnection = {\r\n        ...data,\r\n        channel: data.channel as ChannelType,\r\n        status: data.status as ConnectionStatus,\r\n        health_status: data.health_status as HealthStatus,\r\n        credentials: (data.credentials || {}) as Record<string, string>,\r\n      };\r\n      \r\n      setConnections(prev => [mapped, ...prev]);\r\n      return mapped;\r\n    } catch (err: any) {\r\n      console.error('Error adding connection:', err);\r\n      toast.error('Failed to add connection');\r\n      return null;\r\n    }\r\n  }, [user, companyId]);\r\n\r\n  // Update a connection\r\n  const updateConnection = useCallback(async (\r\n    id: string, \r\n    updates: Partial<Pick<MarketingConnection, 'display_name' | 'identifier' | 'status' | 'credentials' | 'verified' | 'last_sync' | 'health_status' | 'last_health_check'>>\r\n  ): Promise<boolean> => {\r\n    try {\r\n      const { error: updateError } = await supabase\r\n        .from('marketing_connections')\r\n        .update(updates)\r\n        .eq('id', id);\r\n\r\n      if (updateError) throw updateError;\r\n      \r\n      setConnections(prev => \r\n        prev.map(conn => conn.id === id ? { ...conn, ...updates } : conn)\r\n      );\r\n      return true;\r\n    } catch (err: any) {\r\n      console.error('Error updating connection:', err);\r\n      toast.error('Failed to update connection');\r\n      return false;\r\n    }\r\n  }, []);\r\n\r\n  // Remove a connection\r\n  const removeConnection = useCallback(async (id: string): Promise<boolean> => {\r\n    try {\r\n      const { error: deleteError } = await supabase\r\n        .from('marketing_connections')\r\n        .delete()\r\n        .eq('id', id);\r\n\r\n      if (deleteError) throw deleteError;\r\n      \r\n      setConnections(prev => prev.filter(conn => conn.id !== id));\r\n      toast.success('Connection removed');\r\n      return true;\r\n    } catch (err: any) {\r\n      console.error('Error removing connection:', err);\r\n      toast.error('Failed to remove connection');\r\n      return false;\r\n    }\r\n  }, []);\r\n\r\n  // Test a connection\r\n  const testConnection = useCallback(async (id: string): Promise<boolean> => {\r\n    const connection = connections.find(c => c.id === id);\r\n    if (!connection) return false;\r\n\r\n    // Simulate API test (in production, this would call the actual provider API)\r\n    await new Promise(resolve => setTimeout(resolve, 1500));\r\n    \r\n    const hasCredentials = Object.keys(connection.credentials).length > 0;\r\n    const success = !!(hasCredentials && connection.identifier);\r\n    \r\n    await updateConnection(id, {\r\n      status: success ? 'connected' : 'error',\r\n      health_status: success ? 'healthy' : 'failed',\r\n      last_health_check: new Date().toISOString(),\r\n      last_sync: success ? new Date().toISOString() : connection.last_sync,\r\n    });\r\n\r\n    return success;\r\n  }, [connections, updateConnection]);\r\n\r\n  // Get connections by channel\r\n  const getConnectionsByChannel = useCallback((channel: ChannelType) => {\r\n    return connections.filter(c => c.channel === channel);\r\n  }, [connections]);\r\n\r\n  // Run health check on all connections\r\n  const runHealthCheck = useCallback(async () => {\r\n    const updates = connections.map(async (conn) => {\r\n      const hasCredentials = Object.keys(conn.credentials).length > 0;\r\n      const isHealthy = hasCredentials && conn.status === 'connected';\r\n      \r\n      return updateConnection(conn.id, {\r\n        health_status: isHealthy ? 'healthy' : conn.status === 'error' ? 'failed' : 'degraded',\r\n        last_health_check: new Date().toISOString(),\r\n      });\r\n    });\r\n\r\n    await Promise.all(updates);\r\n  }, [connections, updateConnection]);\r\n\r\n  // Initial fetch\r\n  useEffect(() => {\r\n    fetchConnections();\r\n  }, [fetchConnections]);\r\n\r\n  // Set up realtime subscription\r\n  useEffect(() => {\r\n    if (!companyId) return;\r\n\r\n    const channel = supabase\r\n      .channel('marketing_connections_changes')\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'marketing_connections',\r\n          filter: `company_id=eq.${companyId}`,\r\n        },\r\n        (payload) => {\r\n          if (payload.eventType === 'INSERT') {\r\n            setConnections(prev => [payload.new as MarketingConnection, ...prev]);\r\n          } else if (payload.eventType === 'UPDATE') {\r\n            setConnections(prev => \r\n              prev.map(conn => conn.id === payload.new.id ? payload.new as MarketingConnection : conn)\r\n            );\r\n          } else if (payload.eventType === 'DELETE') {\r\n            setConnections(prev => prev.filter(conn => conn.id !== payload.old.id));\r\n          }\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [companyId]);\r\n\r\n  return {\r\n    connections,\r\n    isLoading,\r\n    error,\r\n    addConnection,\r\n    updateConnection,\r\n    removeConnection,\r\n    testConnection,\r\n    getConnectionsByChannel,\r\n    runHealthCheck,\r\n    refetch: fetchConnections,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useMarketingTemplates.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":55,"column":77,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":80,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1726,1729],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1726,1729],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchTemplates'. Either include it or remove the dependency array.","line":141,"column":6,"nodeType":"ArrayExpression","endLine":141,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [channel, fetchTemplates]","fix":{"range":[4333,4342],"text":"[channel, fetchTemplates]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { CampaignTemplate, CampaignChannel } from \"@/components/marketing-hub/types\";\r\n\r\ninterface UseMarketingTemplatesResult {\r\n  templates: CampaignTemplate[];\r\n  isLoading: boolean;\r\n  error: string | null;\r\n  createTemplate: (template: Omit<CampaignTemplate, \"id\" | \"createdAt\">) => Promise<CampaignTemplate | null>;\r\n  deleteTemplate: (id: string) => Promise<boolean>;\r\n  refetch: () => void;\r\n}\r\n\r\nexport function useMarketingTemplates(channel?: CampaignChannel): UseMarketingTemplatesResult {\r\n  const [templates, setTemplates] = useState<CampaignTemplate[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const fetchTemplates = async () => {\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) {\r\n        setTemplates([]);\r\n        return;\r\n      }\r\n\r\n      const { data: profile } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"company_id\")\r\n        .eq(\"id\", user.id)\r\n        .single();\r\n\r\n      if (!profile?.company_id) {\r\n        setTemplates([]);\r\n        return;\r\n      }\r\n\r\n      let query = supabase\r\n        .from(\"marketing_templates\")\r\n        .select(\"*\")\r\n        .eq(\"company_id\", profile.company_id)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (channel) {\r\n        query = query.eq(\"channel\", channel);\r\n      }\r\n\r\n      const { data, error: fetchError } = await query;\r\n\r\n      if (fetchError) throw fetchError;\r\n\r\n      const transformedTemplates: CampaignTemplate[] = (data || []).map((t: any) => ({\r\n        id: t.id,\r\n        name: t.template_name,\r\n        channel: t.channel as CampaignChannel,\r\n        content: t.body || \"\",\r\n        variables: Array.isArray(t.variables) ? t.variables : [],\r\n        createdAt: new Date(t.created_at),\r\n      }));\r\n\r\n      setTemplates(transformedTemplates);\r\n    } catch (err) {\r\n      console.error(\"Failed to fetch templates:\", err);\r\n      setError(err instanceof Error ? err.message : \"Failed to fetch templates\");\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const createTemplate = async (template: Omit<CampaignTemplate, \"id\" | \"createdAt\">): Promise<CampaignTemplate | null> => {\r\n    try {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) return null;\r\n\r\n      const { data: profile } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"company_id\")\r\n        .eq(\"id\", user.id)\r\n        .single();\r\n\r\n      if (!profile?.company_id) return null;\r\n\r\n      // Extract variables from content using {{variable}} pattern\r\n      const variableMatches = template.content.match(/\\{\\{(\\w+)\\}\\}/g) || [];\r\n      const variables = variableMatches.map(v => v.replace(/\\{\\{|\\}\\}/g, ''));\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"marketing_templates\")\r\n        .insert({\r\n          company_id: profile.company_id,\r\n          template_name: template.name,\r\n          channel: template.channel,\r\n          body: template.content,\r\n          variables,\r\n          created_by: user.id,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      const newTemplate: CampaignTemplate = {\r\n        id: data.id,\r\n        name: data.template_name,\r\n        channel: data.channel as CampaignChannel,\r\n        content: data.body || \"\",\r\n        variables: Array.isArray(data.variables) ? (data.variables as string[]) : [],\r\n        createdAt: new Date(data.created_at),\r\n      };\r\n\r\n      setTemplates(prev => [newTemplate, ...prev]);\r\n      return newTemplate;\r\n    } catch (err) {\r\n      console.error(\"Failed to create template:\", err);\r\n      return null;\r\n    }\r\n  };\r\n\r\n  const deleteTemplate = async (id: string): Promise<boolean> => {\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"marketing_templates\")\r\n        .delete()\r\n        .eq(\"id\", id);\r\n\r\n      if (error) throw error;\r\n\r\n      setTemplates(prev => prev.filter(t => t.id !== id));\r\n      return true;\r\n    } catch (err) {\r\n      console.error(\"Failed to delete template:\", err);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchTemplates();\r\n  }, [channel]);\r\n\r\n  return {\r\n    templates,\r\n    isLoading,\r\n    error,\r\n    createTemplate,\r\n    deleteTemplate,\r\n    refetch: fetchTemplates,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useOrganizationMembers.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":70,"column":80,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":83,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1882,1885],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1882,1885],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useOrganization, OrgRole } from '@/contexts/OrganizationContext';\r\n\r\nexport interface OrganizationMember {\r\n  id: string;\r\n  organization_id: string;\r\n  user_id: string;\r\n  role: OrgRole;\r\n  is_active: boolean;\r\n  invited_by: string | null;\r\n  invited_at: string | null;\r\n  joined_at: string | null;\r\n  created_at: string;\r\n  profile: {\r\n    id: string;\r\n    first_name: string | null;\r\n    last_name: string | null;\r\n    avatar_url: string | null;\r\n  } | null;\r\n}\r\n\r\ninterface InviteMemberData {\r\n  email: string;\r\n  role: OrgRole;\r\n}\r\n\r\nexport function useOrganizationMembers() {\r\n  const { currentOrg, isAdmin } = useOrganization();\r\n  const [members, setMembers] = useState<OrganizationMember[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  // Fetch all members of current organization\r\n  const fetchMembers = useCallback(async () => {\r\n    if (!currentOrg) {\r\n      setMembers([]);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const { data, error: fetchError } = await supabase\r\n        .from('organization_members')\r\n        .select(`\r\n          id,\r\n          organization_id,\r\n          user_id,\r\n          role,\r\n          is_active,\r\n          invited_by,\r\n          invited_at,\r\n          joined_at,\r\n          created_at,\r\n          profile:profiles (\r\n            id,\r\n            first_name,\r\n            last_name,\r\n            avatar_url\r\n          )\r\n        `)\r\n        .eq('organization_id', currentOrg.id)\r\n        .order('created_at', { ascending: true });\r\n\r\n      if (fetchError) throw fetchError;\r\n\r\n      const transformedMembers: OrganizationMember[] = (data || []).map((item: any) => ({\r\n        id: item.id,\r\n        organization_id: item.organization_id,\r\n        user_id: item.user_id,\r\n        role: item.role as OrgRole,\r\n        is_active: item.is_active,\r\n        invited_by: item.invited_by,\r\n        invited_at: item.invited_at,\r\n        joined_at: item.joined_at,\r\n        created_at: item.created_at,\r\n        profile: item.profile,\r\n      }));\r\n\r\n      setMembers(transformedMembers);\r\n    } catch (err) {\r\n      console.error('Error fetching members:', err);\r\n      setError(err instanceof Error ? err.message : 'Failed to fetch members');\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [currentOrg]);\r\n\r\n  // Update member role\r\n  const updateMemberRole = useCallback(async (memberId: string, newRole: OrgRole) => {\r\n    if (!isAdmin) {\r\n      throw new Error('Only admins can update member roles');\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('organization_members')\r\n      .update({ role: newRole })\r\n      .eq('id', memberId);\r\n\r\n    if (error) throw error;\r\n\r\n    // Update local state\r\n    setMembers(prev => prev.map(m => \r\n      m.id === memberId ? { ...m, role: newRole } : m\r\n    ));\r\n  }, [isAdmin]);\r\n\r\n  // Deactivate member (soft remove)\r\n  const deactivateMember = useCallback(async (memberId: string) => {\r\n    if (!isAdmin) {\r\n      throw new Error('Only admins can remove members');\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('organization_members')\r\n      .update({ is_active: false })\r\n      .eq('id', memberId);\r\n\r\n    if (error) throw error;\r\n\r\n    // Update local state\r\n    setMembers(prev => prev.filter(m => m.id !== memberId));\r\n  }, [isAdmin]);\r\n\r\n  // Remove member permanently\r\n  const removeMember = useCallback(async (memberId: string) => {\r\n    if (!isAdmin) {\r\n      throw new Error('Only admins can remove members');\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('organization_members')\r\n      .delete()\r\n      .eq('id', memberId);\r\n\r\n    if (error) throw error;\r\n\r\n    // Update local state\r\n    setMembers(prev => prev.filter(m => m.id !== memberId));\r\n  }, [isAdmin]);\r\n\r\n  // Reactivate member\r\n  const reactivateMember = useCallback(async (memberId: string) => {\r\n    if (!isAdmin) {\r\n      throw new Error('Only admins can reactivate members');\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('organization_members')\r\n      .update({ is_active: true })\r\n      .eq('id', memberId);\r\n\r\n    if (error) throw error;\r\n\r\n    await fetchMembers();\r\n  }, [isAdmin, fetchMembers]);\r\n\r\n  // Get active members count\r\n  const activeCount = members.filter(m => m.is_active).length;\r\n\r\n  // Get members by role\r\n  const getMembersByRole = useCallback((role: OrgRole) => {\r\n    return members.filter(m => m.role === role && m.is_active);\r\n  }, [members]);\r\n\r\n  // Initial fetch\r\n  useEffect(() => {\r\n    fetchMembers();\r\n  }, [fetchMembers]);\r\n\r\n  // Real-time subscription\r\n  useEffect(() => {\r\n    if (!currentOrg) return;\r\n\r\n    const channel = supabase\r\n      .channel('org-members-changes')\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'organization_members',\r\n          filter: `organization_id=eq.${currentOrg.id}`,\r\n        },\r\n        () => {\r\n          fetchMembers();\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [currentOrg, fetchMembers]);\r\n\r\n  return {\r\n    members,\r\n    activeMembers: members.filter(m => m.is_active),\r\n    isLoading,\r\n    error,\r\n    activeCount,\r\n    updateMemberRole,\r\n    deactivateMember,\r\n    removeMember,\r\n    reactivateMember,\r\n    getMembersByRole,\r\n    refetch: fetchMembers,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\usePipeline.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\usePipelines.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\usePlanEnforcement.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\usePortalAccounts.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":188,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":188,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6643,6646],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6643,6646],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { toast } from \"sonner\";\r\n\r\nexport interface PortalAccount {\r\n  id: string;\r\n  company_id: string;\r\n  portal_id: string;\r\n  account_name: string;\r\n  credentials: Record<string, unknown>;\r\n  status: \"connected\" | \"disconnected\" | \"error\";\r\n  auto_publish: boolean;\r\n  sync_schedule: \"realtime\" | \"hourly\" | \"daily\";\r\n  last_sync_at: string | null;\r\n  last_error_message: string | null;\r\n  listings_count: number;\r\n  created_at: string;\r\n  updated_at: string;\r\n  portal?: {\r\n    id: string;\r\n    name: string;\r\n    display_name: string | null;\r\n    logo_url: string | null;\r\n    base_url: string | null;\r\n    country: string | null;\r\n  };\r\n}\r\n\r\nexport interface PortalWithAccount {\r\n  id: string;\r\n  name: string;\r\n  display_name: string | null;\r\n  logo_url: string | null;\r\n  base_url: string | null;\r\n  country: string | null;\r\n  is_active: boolean;\r\n  // Account connection info\r\n  connected: boolean;\r\n  account_id: string | null;\r\n  status: \"connected\" | \"disconnected\" | \"error\";\r\n  auto_publish: boolean;\r\n  sync_schedule: \"realtime\" | \"hourly\" | \"daily\";\r\n  last_sync_at: string | null;\r\n  last_error_message: string | null;\r\n  listings_count: number;\r\n  integration_type: \"api_key\" | \"api_key_secret\" | \"oauth2\" | \"webhook\" | \"credentials\";\r\n}\r\n\r\nexport function usePortalAccounts() {\r\n  const [portals, setPortals] = useState<PortalWithAccount[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const fetchPortalsWithAccounts = useCallback(async () => {\r\n    setIsLoading(true);\r\n    try {\r\n      // Get company ID from profile\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) {\r\n        setPortals([]);\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n\r\n      const { data: profile } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"company_id\")\r\n        .eq(\"id\", user.id)\r\n        .single();\r\n\r\n      const companyId = profile?.company_id;\r\n\r\n      // Fetch all active portals\r\n      const { data: portalsData, error: portalsError } = await supabase\r\n        .from(\"portals\")\r\n        .select(\"id, name, display_name, logo_url, base_url, country, is_active\")\r\n        .eq(\"is_active\", true)\r\n        .order(\"name\");\r\n\r\n      if (portalsError) throw portalsError;\r\n\r\n      // Fetch portal accounts for the company\r\n      let accountsData: Record<string, unknown>[] = [];\r\n      if (companyId) {\r\n        const { data: accounts } = await supabase\r\n          .from(\"portal_accounts\")\r\n          .select(\"*\")\r\n          .eq(\"company_id\", companyId);\r\n        accountsData = accounts || [];\r\n      }\r\n\r\n      // Count active publications per portal\r\n      let publicationsCount: Record<string, number> = {};\r\n      if (companyId) {\r\n        const { data: publications } = await supabase\r\n          .from(\"portal_listing_publications\")\r\n          .select(\"portal_id\")\r\n          .eq(\"company_id\", companyId)\r\n          .eq(\"is_deleted\", false)\r\n          .in(\"status\", [\"live\", \"approved\", \"queued\"]);\r\n\r\n        if (publications) {\r\n          publicationsCount = publications.reduce((acc, pub) => {\r\n            acc[pub.portal_id] = (acc[pub.portal_id] || 0) + 1;\r\n            return acc;\r\n          }, {} as Record<string, number>);\r\n        }\r\n      }\r\n\r\n      // Merge portals with their account info\r\n      const mergedPortals: PortalWithAccount[] = (portalsData || []).map((portal) => {\r\n        const account = accountsData.find((a) => a.portal_id === portal.id) as Record<string, unknown> | undefined;\r\n        const isConnected = account?.status === \"connected\";\r\n\r\n        // Determine integration type based on portal name (can be enhanced with portal_rules)\r\n        let integrationType: PortalWithAccount[\"integration_type\"] = \"api_key\";\r\n        const portalName = portal.name.toLowerCase();\r\n        if (portalName.includes(\"property finder\") || portalName.includes(\"booking\") || portalName.includes(\"bayut\") || portalName.includes(\"dubizzle\")) {\r\n          integrationType = \"api_key_secret\";\r\n        } else if (portalName.includes(\"airbnb\")) {\r\n          integrationType = \"oauth2\";\r\n        } else if (portalName.includes(\"website\") || portalName.includes(\"wordpress\")) {\r\n          integrationType = \"webhook\";\r\n        } else if (portalName.includes(\"qatar\")) {\r\n          integrationType = \"credentials\";\r\n        }\r\n\r\n        return {\r\n          id: portal.id,\r\n          name: portal.name,\r\n          display_name: portal.display_name,\r\n          logo_url: portal.logo_url,\r\n          base_url: portal.base_url,\r\n          country: portal.country,\r\n          is_active: portal.is_active,\r\n          connected: isConnected,\r\n          account_id: account?.id as string | null,\r\n          status: (account?.status as PortalWithAccount[\"status\"]) || \"disconnected\",\r\n          auto_publish: (account?.auto_publish as boolean) ?? false,\r\n          sync_schedule: (account?.sync_schedule as PortalWithAccount[\"sync_schedule\"]) || \"daily\",\r\n          last_sync_at: account?.last_sync_at as string | null,\r\n          last_error_message: account?.last_error_message as string | null,\r\n          listings_count: publicationsCount[portal.id] || 0,\r\n          integration_type: integrationType,\r\n        };\r\n      });\r\n\r\n      setPortals(mergedPortals);\r\n    } catch (err: unknown) {\r\n      console.error(\"Error fetching portal accounts:\", err);\r\n      setError(err instanceof Error ? err.message : \"Unknown error\");\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    fetchPortalsWithAccounts();\r\n  }, [fetchPortalsWithAccounts]);\r\n\r\n  const connectPortal = async (\r\n    portalId: string,\r\n    credentials: Record<string, string>,\r\n    settings: { autoPublish: boolean; syncSchedule: \"realtime\" | \"hourly\" | \"daily\" }\r\n  ) => {\r\n    try {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) throw new Error(\"Not authenticated\");\r\n\r\n      const { data: profile } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"company_id\")\r\n        .eq(\"id\", user.id)\r\n        .single();\r\n\r\n      if (!profile?.company_id) throw new Error(\"No company found\");\r\n\r\n      // Check if account already exists\r\n      const { data: existing } = await supabase\r\n        .from(\"portal_accounts\")\r\n        .select(\"id\")\r\n        .eq(\"company_id\", profile.company_id)\r\n        .eq(\"portal_id\", portalId)\r\n        .single();\r\n\r\n      if (existing) {\r\n        // Update existing account\r\n        const updateData: any = {\r\n          status: \"connected\",\r\n          auto_publish: settings.autoPublish,\r\n          sync_schedule: settings.syncSchedule,\r\n          updated_at: new Date().toISOString(),\r\n        };\r\n\r\n        // Only update credentials if provided\r\n        if (credentials && Object.keys(credentials).length > 0) {\r\n          updateData.credentials = credentials;\r\n        }\r\n\r\n        const { error } = await supabase\r\n          .from(\"portal_accounts\")\r\n          .update(updateData)\r\n          .eq(\"id\", existing.id);\r\n\r\n        if (error) throw error;\r\n      } else {\r\n        // Create new account\r\n        if (!credentials || Object.keys(credentials).length === 0) {\r\n          throw new Error(\"Credentials required for new connection\");\r\n        }\r\n\r\n        const { error } = await supabase\r\n          .from(\"portal_accounts\")\r\n          .insert({\r\n            company_id: profile.company_id,\r\n            portal_id: portalId,\r\n            account_name: \"Default\",\r\n            credentials,\r\n            status: \"connected\",\r\n            auto_publish: settings.autoPublish,\r\n            sync_schedule: settings.syncSchedule,\r\n          });\r\n\r\n        if (error) throw error;\r\n      }\r\n\r\n      await fetchPortalsWithAccounts();\r\n      toast.success(\"Portal connected successfully\");\r\n    } catch (err: unknown) {\r\n      console.error(\"Error connecting portal:\", err);\r\n      const message = err instanceof Error ? err.message : \"Failed to connect portal\";\r\n      toast.error(message);\r\n      throw err;\r\n    }\r\n  };\r\n\r\n  const disconnectPortal = async (portalId: string) => {\r\n    try {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) throw new Error(\"Not authenticated\");\r\n\r\n      const { data: profile } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"company_id\")\r\n        .eq(\"id\", user.id)\r\n        .single();\r\n\r\n      if (!profile?.company_id) throw new Error(\"No company found\");\r\n\r\n      const { error } = await supabase\r\n        .from(\"portal_accounts\")\r\n        .update({\r\n          status: \"disconnected\",\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"company_id\", profile.company_id)\r\n        .eq(\"portal_id\", portalId);\r\n\r\n      if (error) throw error;\r\n\r\n      await fetchPortalsWithAccounts();\r\n      toast.success(\"Portal disconnected\");\r\n    } catch (err: unknown) {\r\n      console.error(\"Error disconnecting portal:\", err);\r\n      const message = err instanceof Error ? err.message : \"Failed to disconnect portal\";\r\n      toast.error(message);\r\n      throw err;\r\n    }\r\n  };\r\n\r\n  const updatePortalSettings = async (\r\n    portalId: string,\r\n    settings: { autoPublish?: boolean; syncSchedule?: \"realtime\" | \"hourly\" | \"daily\" }\r\n  ) => {\r\n    try {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) throw new Error(\"Not authenticated\");\r\n\r\n      const { data: profile } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"company_id\")\r\n        .eq(\"id\", user.id)\r\n        .single();\r\n\r\n      if (!profile?.company_id) throw new Error(\"No company found\");\r\n\r\n      const { error } = await supabase\r\n        .from(\"portal_accounts\")\r\n        .update({\r\n          ...(settings.autoPublish !== undefined && { auto_publish: settings.autoPublish }),\r\n          ...(settings.syncSchedule && { sync_schedule: settings.syncSchedule }),\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"company_id\", profile.company_id)\r\n        .eq(\"portal_id\", portalId);\r\n\r\n      if (error) throw error;\r\n\r\n      await fetchPortalsWithAccounts();\r\n    } catch (err: unknown) {\r\n      console.error(\"Error updating portal settings:\", err);\r\n      const message = err instanceof Error ? err.message : \"Failed to update settings\";\r\n      toast.error(message);\r\n      throw err;\r\n    }\r\n  };\r\n\r\n  const syncPortal = async (portalId: string) => {\r\n    try {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) throw new Error(\"Not authenticated\");\r\n\r\n      const { data: profile } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"company_id\")\r\n        .eq(\"id\", user.id)\r\n        .single();\r\n\r\n      if (!profile?.company_id) throw new Error(\"No company found\");\r\n\r\n      // Update last sync time\r\n      await supabase\r\n        .from(\"portal_accounts\")\r\n        .update({\r\n          last_sync_at: new Date().toISOString(),\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"company_id\", profile.company_id)\r\n        .eq(\"portal_id\", portalId);\r\n\r\n      await fetchPortalsWithAccounts();\r\n      toast.success(\"Sync completed successfully\");\r\n    } catch (err: unknown) {\r\n      console.error(\"Error syncing portal:\", err);\r\n      const message = err instanceof Error ? err.message : \"Failed to sync\";\r\n      toast.error(message);\r\n      throw err;\r\n    }\r\n  };\r\n\r\n  return {\r\n    portals,\r\n    isLoading,\r\n    error,\r\n    refetch: fetchPortalsWithAccounts,\r\n    connectPortal,\r\n    disconnectPortal,\r\n    updatePortalSettings,\r\n    syncPortal,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\usePortalAgents.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\usePortalLeads.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\usePortalPublications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\usePortalWebhooks.ts","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchEvents', 'fetchLogs', and 'fetchStats'. Either include them or remove the dependency array.","line":359,"column":6,"nodeType":"ArrayExpression","endLine":359,"endColumn":32,"suggestions":[{"desc":"Update the dependencies array to be: [companyId, fetchEvents, fetchLogs, fetchStats, fetchWebhooks]","fix":{"range":[9444,9470],"text":"[companyId, fetchEvents, fetchLogs, fetchStats, fetchWebhooks]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback, useRef } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\n\r\nexport interface PortalWebhook {\r\n  id: string;\r\n  company_id: string;\r\n  portal: string;\r\n  webhook_url: string;\r\n  secret_token?: string;\r\n  status: \"active\" | \"disabled\" | \"error\";\r\n  last_verified_at?: string;\r\n  verification_error?: string;\r\n  metadata?: Record<string, unknown>;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface PortalWebhookEvent {\r\n  id: string;\r\n  company_id: string;\r\n  portal: string;\r\n  event_type: string;\r\n  portal_listing_id?: string;\r\n  portal_lead_id?: string;\r\n  portal_agent_id?: string;\r\n  payload: Record<string, unknown>;\r\n  signature?: string;\r\n  ip_address?: string;\r\n  received_at: string;\r\n  processed: boolean;\r\n  processed_at?: string;\r\n  processing_error?: string;\r\n  retry_count: number;\r\n  created_lead_id?: string;\r\n  created_at: string;\r\n}\r\n\r\nexport interface PortalWebhookLog {\r\n  id: string;\r\n  webhook_event_id?: string;\r\n  company_id: string;\r\n  portal: string;\r\n  action: string;\r\n  success: boolean;\r\n  error_message?: string;\r\n  error_code?: string;\r\n  processing_time_ms?: number;\r\n  details?: Record<string, unknown>;\r\n  created_at: string;\r\n}\r\n\r\nexport interface WebhookStats {\r\n  total_events: number;\r\n  processed: number;\r\n  pending: number;\r\n  failed: number;\r\n  leads_created: number;\r\n  listing_updates: number;\r\n}\r\n\r\nexport function usePortalWebhooks(portal?: string) {\r\n  const [webhooks, setWebhooks] = useState<PortalWebhook[]>([]);\r\n  const [events, setEvents] = useState<PortalWebhookEvent[]>([]);\r\n  const [logs, setLogs] = useState<PortalWebhookLog[]>([]);\r\n  const [stats, setStats] = useState<WebhookStats | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [companyId, setCompanyId] = useState<string | null>(null);\r\n  const { toast } = useToast();\r\n  const fetchEventsRef = useRef<(() => Promise<void>) | null>(null);\r\n  const fetchStatsRef = useRef<(() => Promise<void>) | null>(null);\r\n  const fetchLogsRef = useRef<(() => Promise<void>) | null>(null);\r\n\r\n  // Get company ID\r\n  useEffect(() => {\r\n    const fetchCompanyId = async () => {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) return;\r\n\r\n      const { data: agent } = await supabase\r\n        .from(\"agents\")\r\n        .select(\"company_id\")\r\n        .eq(\"user_id\", user.id)\r\n        .single();\r\n\r\n      if (agent) {\r\n        setCompanyId(agent.company_id);\r\n      }\r\n    };\r\n    fetchCompanyId();\r\n  }, []);\r\n\r\n  // Fetch webhooks configuration\r\n  const fetchWebhooks = useCallback(async () => {\r\n    if (!companyId) return;\r\n\r\n    const query = supabase\r\n      .from(\"portal_webhooks\")\r\n      .select(\"*\")\r\n      .eq(\"company_id\", companyId);\r\n\r\n    if (portal) {\r\n      query.eq(\"portal\", portal);\r\n    }\r\n\r\n    const { data, error } = await query.order(\"created_at\", { ascending: false });\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching webhooks:\", error);\r\n    } else {\r\n      setWebhooks(data as PortalWebhook[]);\r\n    }\r\n  }, [companyId, portal]);\r\n\r\n  // Fetch webhook events\r\n  const fetchEvents = useCallback(async (limit = 50) => {\r\n    if (!companyId) return;\r\n\r\n    const query = supabase\r\n      .from(\"portal_webhook_events\")\r\n      .select(\"*\")\r\n      .eq(\"company_id\", companyId);\r\n\r\n    if (portal) {\r\n      query.eq(\"portal\", portal);\r\n    }\r\n\r\n    const { data, error } = await query\r\n      .order(\"received_at\", { ascending: false })\r\n      .limit(limit);\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching webhook events:\", error);\r\n    } else {\r\n      setEvents(data as PortalWebhookEvent[]);\r\n    }\r\n  }, [companyId, portal]);\r\n\r\n  // Fetch webhook logs\r\n  const fetchLogs = useCallback(async (limit = 100) => {\r\n    if (!companyId) return;\r\n\r\n    const query = supabase\r\n      .from(\"portal_webhook_logs\")\r\n      .select(\"*\")\r\n      .eq(\"company_id\", companyId);\r\n\r\n    if (portal) {\r\n      query.eq(\"portal\", portal);\r\n    }\r\n\r\n    const { data, error } = await query\r\n      .order(\"created_at\", { ascending: false })\r\n      .limit(limit);\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching webhook logs:\", error);\r\n    } else {\r\n      setLogs(data as PortalWebhookLog[]);\r\n    }\r\n  }, [companyId, portal]);\r\n\r\n  // Fetch stats\r\n  const fetchStats = useCallback(async (days = 7) => {\r\n    if (!companyId) return;\r\n\r\n    const { data, error } = await supabase.rpc(\"get_webhook_stats\", {\r\n      p_company_id: companyId,\r\n      p_portal: portal || null,\r\n      p_days: days,\r\n    });\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching webhook stats:\", error);\r\n    } else if (data && typeof data === \"object\") {\r\n      setStats(data as unknown as WebhookStats);\r\n    }\r\n  }, [companyId, portal]);\r\n\r\n  // Generate webhook URL\r\n  const generateWebhookUrl = useCallback(async (portalName: string): Promise<string | null> => {\r\n    if (!companyId) return null;\r\n\r\n    const { data, error } = await supabase.rpc(\"generate_webhook_url\", {\r\n      p_company_id: companyId,\r\n      p_portal: portalName,\r\n    });\r\n\r\n    if (error) {\r\n      console.error(\"Error generating webhook URL:\", error);\r\n      return null;\r\n    }\r\n\r\n    return data as string;\r\n  }, [companyId]);\r\n\r\n  // Create/update webhook configuration\r\n  const upsertWebhook = useCallback(async (\r\n    portalName: string,\r\n    secretToken?: string\r\n  ): Promise<PortalWebhook | null> => {\r\n    if (!companyId) return null;\r\n\r\n    const webhookUrl = await generateWebhookUrl(portalName);\r\n    if (!webhookUrl) return null;\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"portal_webhooks\")\r\n      .upsert({\r\n        company_id: companyId,\r\n        portal: portalName,\r\n        webhook_url: webhookUrl,\r\n        secret_token: secretToken,\r\n        status: \"active\",\r\n      }, {\r\n        onConflict: \"company_id,portal\",\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error(\"Error upserting webhook:\", error);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to configure webhook\",\r\n        variant: \"destructive\",\r\n      });\r\n      return null;\r\n    }\r\n\r\n    toast({\r\n      title: \"Webhook configured\",\r\n      description: `Webhook URL for ${portalName} is ready`,\r\n    });\r\n\r\n    await fetchWebhooks();\r\n    return data as PortalWebhook;\r\n  }, [companyId, generateWebhookUrl, fetchWebhooks, toast]);\r\n\r\n  // Disable webhook\r\n  const disableWebhook = useCallback(async (webhookId: string) => {\r\n    const { error } = await supabase\r\n      .from(\"portal_webhooks\")\r\n      .update({ status: \"disabled\" })\r\n      .eq(\"id\", webhookId);\r\n\r\n    if (error) {\r\n      console.error(\"Error disabling webhook:\", error);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to disable webhook\",\r\n        variant: \"destructive\",\r\n      });\r\n      return false;\r\n    }\r\n\r\n    toast({\r\n      title: \"Webhook disabled\",\r\n      description: \"The webhook has been disabled\",\r\n    });\r\n\r\n    await fetchWebhooks();\r\n    return true;\r\n  }, [fetchWebhooks, toast]);\r\n\r\n  // Retry failed event\r\n  const retryEvent = useCallback(async (eventId: string) => {\r\n    const { data, error } = await supabase.rpc(\"process_portal_webhook_event\", {\r\n      p_event_id: eventId,\r\n    });\r\n\r\n    if (error) {\r\n      console.error(\"Error retrying event:\", error);\r\n      toast({\r\n        title: \"Retry failed\",\r\n        description: error.message,\r\n        variant: \"destructive\",\r\n      });\r\n      return null;\r\n    }\r\n\r\n    toast({\r\n      title: \"Event reprocessed\",\r\n      description: \"The webhook event has been reprocessed\",\r\n    });\r\n\r\n    await fetchEvents();\r\n    return data;\r\n  }, [fetchEvents, toast]);\r\n\r\n  // Keep refs updated\r\n  useEffect(() => {\r\n    fetchEventsRef.current = fetchEvents;\r\n  }, [fetchEvents]);\r\n\r\n  useEffect(() => {\r\n    fetchStatsRef.current = fetchStats;\r\n  }, [fetchStats]);\r\n\r\n  useEffect(() => {\r\n    fetchLogsRef.current = fetchLogs;\r\n  }, [fetchLogs]);\r\n\r\n  // Initial fetch and realtime subscription\r\n  useEffect(() => {\r\n    if (!companyId) return;\r\n\r\n    const loadData = async () => {\r\n      setIsLoading(true);\r\n      await Promise.all([\r\n        fetchWebhooks(),\r\n        fetchEvents(),\r\n        fetchLogs(),\r\n        fetchStats(),\r\n      ]);\r\n      setIsLoading(false);\r\n    };\r\n\r\n    loadData();\r\n\r\n    // Subscribe to realtime updates\r\n    const eventsChannel = supabase\r\n      .channel(\"portal_webhook_events_changes\")\r\n      .on(\r\n        \"postgres_changes\",\r\n        {\r\n          event: \"*\",\r\n          schema: \"public\",\r\n          table: \"portal_webhook_events\",\r\n          filter: `company_id=eq.${companyId}`,\r\n        },\r\n        () => {\r\n          if (fetchEventsRef.current) fetchEventsRef.current();\r\n          if (fetchStatsRef.current) fetchStatsRef.current();\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    const logsChannel = supabase\r\n      .channel(\"portal_webhook_logs_changes\")\r\n      .on(\r\n        \"postgres_changes\",\r\n        {\r\n          event: \"INSERT\",\r\n          schema: \"public\",\r\n          table: \"portal_webhook_logs\",\r\n          filter: `company_id=eq.${companyId}`,\r\n        },\r\n        () => {\r\n          if (fetchLogsRef.current) fetchLogsRef.current();\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(eventsChannel);\r\n      supabase.removeChannel(logsChannel);\r\n    };\r\n  }, [companyId, fetchWebhooks]); // Removed fetch functions - using ref pattern\r\n\r\n  return {\r\n    webhooks,\r\n    events,\r\n    logs,\r\n    stats,\r\n    isLoading,\r\n    companyId,\r\n    fetchWebhooks,\r\n    fetchEvents,\r\n    fetchLogs,\r\n    fetchStats,\r\n    generateWebhookUrl,\r\n    upsertWebhook,\r\n    disableWebhook,\r\n    retryEvent,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useSubscription.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useTasks.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useUnsavedChanges.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useUserRole.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useWebsiteForms.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\hooks\\useWhatsAppInbox.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[391,394],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[391,394],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":24,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[980,983],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[980,983],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":65,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2557,2560],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2557,2560],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":130,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4859,4862],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4859,4862],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { useState, useEffect, useCallback } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { WhatsAppConversation, WhatsAppMessage } from '@/components/whatsapp-chatbot/types';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { toast } from 'sonner';\r\n\r\n// Mappers to convert DB snake_case to frontend camelCase\r\nconst mapConversation = (data: any): WhatsAppConversation => ({\r\n    id: data.id,\r\n    leadName: data.lead_name || data.lead_phone || 'Unknown',\r\n    leadPhone: data.lead_phone,\r\n    leadStage: data.lead_stage || 'New',\r\n    qualificationStatus: data.qualification_status || 'pending',\r\n    status: data.status,\r\n    unreadCount: data.unread_count || 0,\r\n    lastMessage: data.last_message || '',\r\n    lastMessageTime: new Date(data.updated_at || new Date()),\r\n    assignedAgent: data.assigned_agent_name,\r\n    isPinned: data.is_pinned,\r\n    qualificationData: data.qualification_data,\r\n});\r\n\r\nconst mapMessage = (data: any): WhatsAppMessage => ({\r\n    id: data.id,\r\n    conversationId: data.conversation_id,\r\n    content: data.content,\r\n    sender: data.sender_type, // 'lead' | 'agent' | 'bot'\r\n    timestamp: new Date(data.created_at),\r\n    status: data.status,\r\n    mediaUrl: data.media_url,\r\n    mediaType: data.media_type,\r\n    isAiGenerated: data.is_ai_generated,\r\n});\r\n\r\nexport function useWhatsAppInbox() {\r\n    const { user, profile } = useAuth();\r\n    const [conversations, setConversations] = useState<WhatsAppConversation[]>([]);\r\n    const [messages, setMessages] = useState<Record<string, WhatsAppMessage[]>>({});\r\n    const [isLoading, setIsLoading] = useState(true);\r\n\r\n    // Fetch conversations\r\n    const fetchConversations = useCallback(async () => {\r\n        if (!profile?.company_id) return;\r\n\r\n        try {\r\n            setIsLoading(true);\r\n            const { data, error } = await supabase\r\n                .from('whatsapp_conversations')\r\n                .select('*')\r\n                .eq('company_id', profile.company_id)\r\n                .order('updated_at', { ascending: false });\r\n\r\n            if (error) {\r\n                // Fallback to empty if table doesn't exist yet (dev environment safety)\r\n                if (error.code === '42P01') {\r\n                    console.warn('whatsapp_conversations table does not exist, using empty state');\r\n                    setConversations([]);\r\n                    return;\r\n                }\r\n                throw error;\r\n            }\r\n\r\n            setConversations(data.map(mapConversation));\r\n        } catch (err: any) {\r\n            console.error('Error fetching conversations:', err);\r\n            // Don't show toast on initial load error if it's just missing tables in dev\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    }, [profile?.company_id]);\r\n\r\n    // Fetch messages for a conversation\r\n    const fetchMessages = useCallback(async (conversationId: string) => {\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('whatsapp_messages')\r\n                .select('*')\r\n                .eq('conversation_id', conversationId)\r\n                .order('created_at', { ascending: true });\r\n\r\n            if (error) throw error;\r\n\r\n            setMessages(prev => ({\r\n                ...prev,\r\n                [conversationId]: data.map(mapMessage)\r\n            }));\r\n        } catch (err) {\r\n            console.error('Error fetching messages:', err);\r\n        }\r\n    }, []);\r\n\r\n    // Send message\r\n    const sendMessage = useCallback(async (conversationId: string, content: string) => {\r\n        try {\r\n            // 1. Insert message\r\n            const { data, error } = await supabase\r\n                .from('whatsapp_messages')\r\n                .insert({\r\n                    conversation_id: conversationId,\r\n                    content,\r\n                    sender_type: 'agent',\r\n                    status: 'sent',\r\n                    created_by: user?.id\r\n                })\r\n                .select()\r\n                .single();\r\n\r\n            if (error) throw error;\r\n\r\n            const newMessage = mapMessage(data);\r\n\r\n            // 2. Update local state immediately\r\n            setMessages(prev => ({\r\n                ...prev,\r\n                [conversationId]: [...(prev[conversationId] || []), newMessage]\r\n            }));\r\n\r\n            // 3. Update conversation last message\r\n            setConversations(prev => prev.map(c =>\r\n                c.id === conversationId\r\n                    ? { ...c, lastMessage: content, lastMessageTime: new Date() }\r\n                    : c\r\n            ));\r\n\r\n            // 4. Trigger backend processing (if needed, usually handled by triggers)\r\n            // await supabase.rpc('process_outbound_whatsapp', { message_id: data.id });\r\n\r\n            return newMessage;\r\n        } catch (err: any) {\r\n            console.error('Error sending message:', err);\r\n            toast.error('Failed to send message');\r\n            throw err;\r\n        }\r\n    }, [user?.id]);\r\n\r\n    // Subscribe to realtime updates\r\n    useEffect(() => {\r\n        if (!profile?.company_id) return;\r\n\r\n        const channel = supabase\r\n            .channel('whatsapp-realtime')\r\n            .on('postgres_changes', {\r\n                event: '*',\r\n                schema: 'public',\r\n                table: 'whatsapp_conversations',\r\n                filter: `company_id=eq.${profile.company_id}`\r\n            }, (payload) => {\r\n                // Simple refetch or optimistic update could go here\r\n                fetchConversations();\r\n            })\r\n            .subscribe();\r\n\r\n        return () => {\r\n            supabase.removeChannel(channel);\r\n        };\r\n    }, [profile?.company_id, fetchConversations]);\r\n\r\n    useEffect(() => {\r\n        fetchConversations();\r\n    }, [fetchConversations]);\r\n\r\n    return {\r\n        conversations,\r\n        messages,\r\n        isLoading,\r\n        fetchMessages,\r\n        sendMessage,\r\n        refetchConversations: fetchConversations\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\integrations\\supabase\\client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\integrations\\supabase\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\lib\\generatePresentationPDF.ts","messages":[{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":334,"column":19,"nodeType":"BlockStatement","messageId":"unexpected","endLine":334,"endColumn":21,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[11425,11425],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":378,"column":19,"nodeType":"BlockStatement","messageId":"unexpected","endLine":378,"endColumn":21,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[13021,13021],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import jsPDF from 'jspdf';\r\nimport QRCode from 'qrcode';\r\nimport { \r\n  PresentationListing, \r\n  PresentationAgent, \r\n  PresentationCompany, \r\n  PresentationSettings,\r\n  themeColors \r\n} from '@/components/presentation/types';\r\n\r\nconst loadImage = (src: string): Promise<HTMLImageElement> => {\r\n  return new Promise((resolve, reject) => {\r\n    const img = new Image();\r\n    img.crossOrigin = 'anonymous';\r\n    img.onload = () => resolve(img);\r\n    img.onerror = reject;\r\n    img.src = src;\r\n  });\r\n};\r\n\r\nconst addImageToPDF = (\r\n  doc: jsPDF,\r\n  img: HTMLImageElement,\r\n  x: number,\r\n  y: number,\r\n  maxWidth: number,\r\n  maxHeight: number\r\n) => {\r\n  const ratio = Math.min(maxWidth / img.width, maxHeight / img.height);\r\n  const width = img.width * ratio;\r\n  const height = img.height * ratio;\r\n  const offsetX = x + (maxWidth - width) / 2;\r\n  const offsetY = y + (maxHeight - height) / 2;\r\n  doc.addImage(img, 'JPEG', offsetX, offsetY, width, height);\r\n  return { width, height, offsetX, offsetY };\r\n};\r\n\r\nconst formatPrice = (price: number): string => {\r\n  return new Intl.NumberFormat('en-AE', {\r\n    style: 'currency',\r\n    currency: 'AED',\r\n    minimumFractionDigits: 0,\r\n    maximumFractionDigits: 0,\r\n  }).format(price);\r\n};\r\n\r\nconst hexToRgb = (hex: string): [number, number, number] => {\r\n  // Handle HSL format\r\n  if (hex.startsWith('hsl')) {\r\n    return [26, 54, 93]; // Default blue for classic theme\r\n  }\r\n  const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\r\n  return result \r\n    ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)]\r\n    : [0, 0, 0];\r\n};\r\n\r\nexport const generatePresentationPDF = async (\r\n  listing: PresentationListing,\r\n  agent: PresentationAgent,\r\n  company: PresentationCompany,\r\n  settings: PresentationSettings\r\n): Promise<void> => {\r\n  const doc = new jsPDF('p', 'mm', 'a4');\r\n  const pageWidth = doc.internal.pageSize.getWidth();\r\n  const pageHeight = doc.internal.pageSize.getHeight();\r\n  const margin = 15;\r\n  const contentWidth = pageWidth - 2 * margin;\r\n  \r\n  const colors = themeColors[settings.theme];\r\n  const primaryRgb = hexToRgb(colors.primary);\r\n\r\n  let currentPage = 1;\r\n\r\n  // Helper function to add new page\r\n  const addNewPage = () => {\r\n    doc.addPage();\r\n    currentPage++;\r\n  };\r\n\r\n  // ==================== COVER PAGE ====================\r\n  if (settings.sections.cover) {\r\n    // Cover image\r\n    try {\r\n      const coverImg = await loadImage(listing.images[0]);\r\n      doc.addImage(coverImg, 'JPEG', 0, 0, pageWidth, pageHeight * 0.6);\r\n    } catch (e) {\r\n      // Fallback gradient background\r\n      doc.setFillColor(240, 240, 240);\r\n      doc.rect(0, 0, pageWidth, pageHeight * 0.6, 'F');\r\n    }\r\n\r\n    // Overlay gradient (semi-transparent dark bar)\r\n    doc.setFillColor(50, 50, 50);\r\n    doc.rect(0, pageHeight * 0.35, pageWidth, pageHeight * 0.25, 'F');\r\n\r\n    // Company logo/name at top\r\n    doc.setTextColor(255, 255, 255);\r\n    doc.setFontSize(14);\r\n    doc.setFont('helvetica', 'bold');\r\n    doc.text(company.name, margin, 20);\r\n\r\n    // Property type badge\r\n    doc.setFillColor(...primaryRgb);\r\n    doc.roundedRect(margin, pageHeight * 0.45, 40, 8, 2, 2, 'F');\r\n    doc.setTextColor(255, 255, 255);\r\n    doc.setFontSize(10);\r\n    doc.text(`For ${listing.priceType === 'sale' ? 'Sale' : 'Rent'}`, margin + 20, pageHeight * 0.45 + 5.5, { align: 'center' });\r\n\r\n    // Title\r\n    doc.setTextColor(255, 255, 255);\r\n    doc.setFontSize(24);\r\n    doc.setFont('helvetica', 'bold');\r\n    const titleLines = doc.splitTextToSize(listing.title, contentWidth);\r\n    doc.text(titleLines, margin, pageHeight * 0.52);\r\n\r\n    // Location\r\n    doc.setFontSize(12);\r\n    doc.setFont('helvetica', 'normal');\r\n    doc.text(listing.location, margin, pageHeight * 0.52 + titleLines.length * 10 + 5);\r\n\r\n    // Price section at bottom\r\n    doc.setFillColor(255, 255, 255);\r\n    doc.roundedRect(margin, pageHeight * 0.65, contentWidth, 50, 3, 3, 'F');\r\n\r\n    doc.setTextColor(...primaryRgb);\r\n    doc.setFontSize(28);\r\n    doc.setFont('helvetica', 'bold');\r\n    doc.text(formatPrice(listing.price) + (listing.priceType === 'rent' ? ' /year' : ''), margin + 10, pageHeight * 0.65 + 20);\r\n\r\n    // Quick stats\r\n    doc.setTextColor(100, 100, 100);\r\n    doc.setFontSize(10);\r\n    const stats = `${listing.bedrooms} Beds  â€¢  ${listing.bathrooms} Baths  â€¢  ${listing.size.toLocaleString()} ${listing.sizeUnit}  â€¢  ${listing.propertyType}`;\r\n    doc.text(stats, margin + 10, pageHeight * 0.65 + 35);\r\n\r\n    // Agent info\r\n    doc.setTextColor(50, 50, 50);\r\n    doc.setFontSize(11);\r\n    doc.setFont('helvetica', 'bold');\r\n    doc.text(agent.name, margin + 10, pageHeight * 0.85);\r\n    doc.setFont('helvetica', 'normal');\r\n    doc.setFontSize(9);\r\n    doc.text(agent.phone + '  |  ' + agent.email, margin + 10, pageHeight * 0.85 + 6);\r\n\r\n    // Reference\r\n    doc.setTextColor(150, 150, 150);\r\n    doc.setFontSize(8);\r\n    doc.text(`Ref: ${listing.referenceId}`, pageWidth - margin, pageHeight - 10, { align: 'right' });\r\n  }\r\n\r\n  // ==================== SUMMARY PAGE ====================\r\n  if (settings.sections.summary || settings.sections.description) {\r\n    addNewPage();\r\n\r\n    let yPos = margin;\r\n\r\n    if (settings.sections.summary) {\r\n      doc.setTextColor(...primaryRgb);\r\n      doc.setFontSize(16);\r\n      doc.setFont('helvetica', 'bold');\r\n      doc.text('Property Overview', margin, yPos);\r\n      yPos += 15;\r\n\r\n      // Stats boxes\r\n      const stats = [\r\n        { label: 'Bedrooms', value: listing.bedrooms.toString() },\r\n        { label: 'Bathrooms', value: listing.bathrooms.toString() },\r\n        { label: 'Size', value: `${listing.size.toLocaleString()} ${listing.sizeUnit}` },\r\n        { label: 'Type', value: listing.propertyType },\r\n      ];\r\n\r\n      if (listing.parking) stats.push({ label: 'Parking', value: listing.parking.toString() });\r\n      if (listing.furnishing) stats.push({ label: 'Furnishing', value: listing.furnishing });\r\n\r\n      const boxWidth = (contentWidth - 15) / 3;\r\n      const boxHeight = 25;\r\n\r\n      stats.forEach((stat, index) => {\r\n        const row = Math.floor(index / 3);\r\n        const col = index % 3;\r\n        const x = margin + col * (boxWidth + 5);\r\n        const y = yPos + row * (boxHeight + 5);\r\n\r\n        doc.setFillColor(245, 245, 245);\r\n        doc.roundedRect(x, y, boxWidth, boxHeight, 2, 2, 'F');\r\n\r\n        doc.setTextColor(150, 150, 150);\r\n        doc.setFontSize(8);\r\n        doc.text(stat.label.toUpperCase(), x + boxWidth / 2, y + 8, { align: 'center' });\r\n\r\n        doc.setTextColor(50, 50, 50);\r\n        doc.setFontSize(12);\r\n        doc.setFont('helvetica', 'bold');\r\n        doc.text(stat.value, x + boxWidth / 2, y + 18, { align: 'center' });\r\n      });\r\n\r\n      yPos += Math.ceil(stats.length / 3) * (boxHeight + 5) + 15;\r\n    }\r\n\r\n    if (settings.sections.description) {\r\n      doc.setTextColor(...primaryRgb);\r\n      doc.setFontSize(16);\r\n      doc.setFont('helvetica', 'bold');\r\n      doc.text('Property Description', margin, yPos);\r\n      yPos += 10;\r\n\r\n      doc.setTextColor(80, 80, 80);\r\n      doc.setFontSize(10);\r\n      doc.setFont('helvetica', 'normal');\r\n      const descLines = doc.splitTextToSize(listing.description, contentWidth);\r\n      doc.text(descLines.slice(0, 20), margin, yPos);\r\n      yPos += descLines.slice(0, 20).length * 5 + 15;\r\n\r\n      // Highlights\r\n      if (listing.features && listing.features.length > 0) {\r\n        doc.setFillColor(245, 245, 245);\r\n        doc.roundedRect(margin, yPos, contentWidth, 10 + listing.features.length * 7, 3, 3, 'F');\r\n\r\n        doc.setTextColor(...primaryRgb);\r\n        doc.setFontSize(11);\r\n        doc.setFont('helvetica', 'bold');\r\n        doc.text('Property Highlights', margin + 5, yPos + 8);\r\n\r\n        doc.setTextColor(80, 80, 80);\r\n        doc.setFontSize(9);\r\n        doc.setFont('helvetica', 'normal');\r\n        listing.features.forEach((feature, index) => {\r\n          doc.text('âœ“ ' + feature, margin + 8, yPos + 17 + index * 6);\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  // ==================== GALLERY PAGE ====================\r\n  if (settings.sections.gallery && listing.images.length > 1) {\r\n    addNewPage();\r\n\r\n    doc.setTextColor(...primaryRgb);\r\n    doc.setFontSize(16);\r\n    doc.setFont('helvetica', 'bold');\r\n    doc.text('Photo Gallery', margin, margin);\r\n\r\n    const galleryImages = listing.images.slice(1, 7);\r\n    const imgWidth = (contentWidth - 5) / 2;\r\n    const imgHeight = 55;\r\n    const startY = margin + 15;\r\n\r\n    for (let i = 0; i < galleryImages.length; i++) {\r\n      try {\r\n        const img = await loadImage(galleryImages[i]);\r\n        const row = Math.floor(i / 2);\r\n        const col = i % 2;\r\n        const x = margin + col * (imgWidth + 5);\r\n        const y = startY + row * (imgHeight + 5);\r\n        \r\n        doc.setFillColor(240, 240, 240);\r\n        doc.roundedRect(x, y, imgWidth, imgHeight, 2, 2, 'F');\r\n        addImageToPDF(doc, img, x, y, imgWidth, imgHeight);\r\n      } catch (e) {\r\n        // Skip failed images\r\n      }\r\n    }\r\n  }\r\n\r\n  // ==================== AMENITIES PAGE ====================\r\n  if (settings.sections.amenities && listing.amenities.length > 0) {\r\n    addNewPage();\r\n\r\n    doc.setTextColor(...primaryRgb);\r\n    doc.setFontSize(16);\r\n    doc.setFont('helvetica', 'bold');\r\n    doc.text('Amenities & Features', margin, margin);\r\n\r\n    const amenityWidth = (contentWidth - 10) / 3;\r\n    const amenityHeight = 12;\r\n    const startY = margin + 15;\r\n\r\n    listing.amenities.forEach((amenity, index) => {\r\n      const row = Math.floor(index / 3);\r\n      const col = index % 3;\r\n      const x = margin + col * (amenityWidth + 5);\r\n      const y = startY + row * (amenityHeight + 3);\r\n\r\n      doc.setFillColor(245, 245, 245);\r\n      doc.roundedRect(x, y, amenityWidth, amenityHeight, 2, 2, 'F');\r\n\r\n      doc.setTextColor(80, 80, 80);\r\n      doc.setFontSize(9);\r\n      doc.text('âœ“ ' + amenity, x + 4, y + 7.5);\r\n    });\r\n  }\r\n\r\n  // ==================== AGENT & COMPANY PAGE ====================\r\n  if (settings.sections.agent || settings.sections.company) {\r\n    addNewPage();\r\n\r\n    let yPos = margin;\r\n\r\n    if (settings.sections.agent) {\r\n      doc.setTextColor(...primaryRgb);\r\n      doc.setFontSize(16);\r\n      doc.setFont('helvetica', 'bold');\r\n      doc.text('Your Property Consultant', margin, yPos);\r\n      yPos += 15;\r\n\r\n      doc.setFillColor(245, 245, 245);\r\n      doc.roundedRect(margin, yPos, contentWidth, 40, 3, 3, 'F');\r\n\r\n      doc.setTextColor(50, 50, 50);\r\n      doc.setFontSize(14);\r\n      doc.setFont('helvetica', 'bold');\r\n      doc.text(agent.name, margin + 10, yPos + 12);\r\n\r\n      doc.setFontSize(10);\r\n      doc.setFont('helvetica', 'normal');\r\n      doc.setTextColor(100, 100, 100);\r\n      doc.text(agent.designation || 'Property Consultant', margin + 10, yPos + 20);\r\n\r\n      doc.setTextColor(80, 80, 80);\r\n      doc.setFontSize(9);\r\n      doc.text(`ðŸ“ž ${agent.phone}`, margin + 10, yPos + 30);\r\n      doc.text(`âœ‰ï¸ ${agent.email}`, margin + 70, yPos + 30);\r\n\r\n      // WhatsApp QR\r\n      try {\r\n        const qrDataUrl = await QRCode.toDataURL(`https://wa.me/${agent.whatsapp || agent.phone.replace(/\\D/g, '')}`, {\r\n          width: 80,\r\n          margin: 0,\r\n        });\r\n        doc.addImage(qrDataUrl, 'PNG', pageWidth - margin - 30, yPos + 5, 25, 25);\r\n        doc.setFontSize(7);\r\n        doc.text('Scan to WhatsApp', pageWidth - margin - 17.5, yPos + 35, { align: 'center' });\r\n      } catch (e) {}\r\n\r\n      yPos += 55;\r\n    }\r\n\r\n    if (settings.sections.company) {\r\n      doc.setTextColor(...primaryRgb);\r\n      doc.setFontSize(16);\r\n      doc.setFont('helvetica', 'bold');\r\n      doc.text('About Us', margin, yPos);\r\n      yPos += 10;\r\n\r\n      doc.setTextColor(50, 50, 50);\r\n      doc.setFontSize(14);\r\n      doc.setFont('helvetica', 'bold');\r\n      doc.text(company.name, margin, yPos);\r\n      yPos += 8;\r\n\r\n      if (company.about) {\r\n        doc.setTextColor(80, 80, 80);\r\n        doc.setFontSize(9);\r\n        doc.setFont('helvetica', 'normal');\r\n        const aboutLines = doc.splitTextToSize(company.about, contentWidth - 40);\r\n        doc.text(aboutLines, margin, yPos);\r\n        yPos += aboutLines.length * 4 + 10;\r\n      }\r\n\r\n      doc.setTextColor(100, 100, 100);\r\n      doc.setFontSize(8);\r\n      if (company.address) doc.text(`ðŸ“ ${company.address}`, margin, yPos);\r\n      if (company.phone) doc.text(`ðŸ“ž ${company.phone}`, margin, yPos + 5);\r\n      if (company.email) doc.text(`âœ‰ï¸ ${company.email}`, margin, yPos + 10);\r\n      if (company.website) doc.text(`ðŸŒ ${company.website}`, margin, yPos + 15);\r\n\r\n      // Listing QR\r\n      try {\r\n        const listingUrl = `${window.location.origin}/listings/${listing.id}/presentation`;\r\n        const qrDataUrl = await QRCode.toDataURL(listingUrl, {\r\n          width: 100,\r\n          margin: 0,\r\n        });\r\n        doc.addImage(qrDataUrl, 'PNG', pageWidth - margin - 35, yPos - 20, 30, 30);\r\n        doc.setFontSize(7);\r\n        doc.text('View Online', pageWidth - margin - 20, yPos + 15, { align: 'center' });\r\n      } catch (e) {}\r\n    }\r\n\r\n    // Footer\r\n    doc.setTextColor(150, 150, 150);\r\n    doc.setFontSize(7);\r\n    doc.text(`Â© ${new Date().getFullYear()} ${company.name}. All rights reserved.`, pageWidth / 2, pageHeight - 10, { align: 'center' });\r\n    if (company.tagline) {\r\n      doc.text(company.tagline, pageWidth / 2, pageHeight - 5, { align: 'center' });\r\n    }\r\n  }\r\n\r\n  // Save PDF\r\n  const fileName = `${listing.title.replace(/[^a-z0-9]/gi, '_')}_Presentation.pdf`;\r\n  doc.save(fileName);\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\lib\\generatePropertyPDF.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\AcceptInvitePage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":20,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[962,965],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[962,965],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":130,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4080,4083],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4080,4083],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { useSearchParams, useNavigate } from 'react-router-dom';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { Loader2, CheckCircle, XCircle, UserPlus } from 'lucide-react';\r\n\r\nexport default function AcceptInvitePage() {\r\n  const [searchParams] = useSearchParams();\r\n  const navigate = useNavigate();\r\n  const { toast } = useToast();\r\n  const token = searchParams.get('token');\r\n\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [agentData, setAgentData] = useState<any>(null);\r\n  const [password, setPassword] = useState('');\r\n  const [confirmPassword, setConfirmPassword] = useState('');\r\n\r\n  useEffect(() => {\r\n    if (!token) {\r\n      setError('Invalid invitation link');\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    // Verify the invitation token\r\n    const verifyToken = async () => {\r\n      try {\r\n        const { data, error } = await supabase\r\n          .from('agents')\r\n          .select('*')\r\n          .eq('invitation_token', token)\r\n          .eq('status', 'invited')\r\n          .single();\r\n\r\n        if (error || !data) {\r\n          setError('This invitation link is invalid or has already been used.');\r\n          return;\r\n        }\r\n\r\n        // Check if invitation is expired (7 days)\r\n        const invitedAt = new Date(data.invitation_sent_at);\r\n        const now = new Date();\r\n        const daysSinceInvite = (now.getTime() - invitedAt.getTime()) / (1000 * 60 * 60 * 24);\r\n        \r\n        if (daysSinceInvite > 7) {\r\n          setError('This invitation link has expired. Please contact your administrator for a new invitation.');\r\n          return;\r\n        }\r\n\r\n        setAgentData(data);\r\n      } catch (err) {\r\n        console.error('Error verifying token:', err);\r\n        setError('Failed to verify invitation. Please try again.');\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    };\r\n\r\n    verifyToken();\r\n  }, [token]);\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n\r\n    if (password.length < 8) {\r\n      toast({\r\n        title: 'Password Too Short',\r\n        description: 'Password must be at least 8 characters.',\r\n        variant: 'destructive',\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (password !== confirmPassword) {\r\n      toast({\r\n        title: 'Passwords Do Not Match',\r\n        description: 'Please make sure your passwords match.',\r\n        variant: 'destructive',\r\n      });\r\n      return;\r\n    }\r\n\r\n    setIsSubmitting(true);\r\n    try {\r\n      // Create auth user\r\n      const { data: authData, error: signUpError } = await supabase.auth.signUp({\r\n        email: agentData.email,\r\n        password,\r\n        options: {\r\n          data: {\r\n            first_name: agentData.name.split(' ')[0],\r\n            last_name: agentData.name.split(' ').slice(1).join(' '),\r\n          },\r\n          emailRedirectTo: `${window.location.origin}/`,\r\n        },\r\n      });\r\n\r\n      if (signUpError) throw signUpError;\r\n\r\n      // Update agent record with user_id and set status to active\r\n      const { error: updateError } = await supabase\r\n        .from('agents')\r\n        .update({\r\n          user_id: authData.user?.id,\r\n          status: 'active',\r\n          invitation_token: null,\r\n        })\r\n        .eq('id', agentData.id);\r\n\r\n      if (updateError) throw updateError;\r\n\r\n      toast({\r\n        title: 'Account Created!',\r\n        description: 'You can now log in to your account.',\r\n      });\r\n\r\n      // Sign in the user\r\n      await supabase.auth.signInWithPassword({\r\n        email: agentData.email,\r\n        password,\r\n      });\r\n\r\n      navigate('/');\r\n    } catch (err: any) {\r\n      console.error('Error accepting invitation:', err);\r\n      toast({\r\n        title: 'Failed to Create Account',\r\n        description: err.message || 'Please try again.',\r\n        variant: 'destructive',\r\n      });\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center bg-muted/30\">\r\n        <Card className=\"w-full max-w-md\">\r\n          <CardContent className=\"flex flex-col items-center py-12\">\r\n            <Loader2 className=\"h-8 w-8 animate-spin text-primary mb-4\" />\r\n            <p className=\"text-muted-foreground\">Verifying invitation...</p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center bg-muted/30\">\r\n        <Card className=\"w-full max-w-md\">\r\n          <CardContent className=\"flex flex-col items-center py-12\">\r\n            <XCircle className=\"h-12 w-12 text-destructive mb-4\" />\r\n            <h2 className=\"text-xl font-semibold mb-2\">Invitation Error</h2>\r\n            <p className=\"text-muted-foreground text-center mb-6\">{error}</p>\r\n            <Button onClick={() => navigate('/login')}>Go to Login</Button>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen flex items-center justify-center bg-muted/30 p-4\">\r\n      <Card className=\"w-full max-w-md\">\r\n        <CardHeader className=\"text-center\">\r\n          <div className=\"w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-4\">\r\n            <UserPlus className=\"h-8 w-8 text-primary\" />\r\n          </div>\r\n          <CardTitle>Welcome to the Team!</CardTitle>\r\n          <CardDescription>\r\n            Complete your account setup to get started\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"mb-6 p-4 rounded-lg bg-muted/50\">\r\n            <div className=\"flex items-center gap-3\">\r\n              <CheckCircle className=\"h-5 w-5 text-green-500\" />\r\n              <div>\r\n                <p className=\"font-medium\">{agentData?.name}</p>\r\n                <p className=\"text-sm text-muted-foreground\">{agentData?.email}</p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"password\">Create Password</Label>\r\n              <Input\r\n                id=\"password\"\r\n                type=\"password\"\r\n                value={password}\r\n                onChange={(e) => setPassword(e.target.value)}\r\n                placeholder=\"Minimum 8 characters\"\r\n                required\r\n                minLength={8}\r\n              />\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"confirmPassword\">Confirm Password</Label>\r\n              <Input\r\n                id=\"confirmPassword\"\r\n                type=\"password\"\r\n                value={confirmPassword}\r\n                onChange={(e) => setConfirmPassword(e.target.value)}\r\n                placeholder=\"Re-enter your password\"\r\n                required\r\n              />\r\n            </div>\r\n\r\n            <Button type=\"submit\" className=\"w-full\" disabled={isSubmitting}>\r\n              {isSubmitting && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\r\n              Complete Setup\r\n            </Button>\r\n          </form>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\ActivitiesPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":71,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2090,2093],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2090,2093],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from \"react\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { useAllActivities, ActivityType, Activity } from \"@/hooks/useAllActivities\";\r\nimport { useOrganizationMembers } from \"@/hooks/useOrganizationMembers\";\r\nimport { useCrmLeads } from \"@/hooks/useCrmLeads\";\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport { PageContent } from \"@/components/layout/PageContent\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\";\r\nimport {\r\n  Sheet,\r\n  SheetContent,\r\n  SheetHeader,\r\n  SheetTitle,\r\n  SheetTrigger,\r\n} from \"@/components/ui/sheet\";\r\nimport { Card, CardContent } from \"@/components/ui/card\";\r\nimport { Skeleton } from \"@/components/ui/skeleton\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Calendar } from \"@/components/ui/calendar\";\r\nimport { Checkbox } from \"@/components/ui/checkbox\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\r\nimport { toast } from \"sonner\";\r\nimport { format, parseISO, isToday, isSameDay } from \"date-fns\";\r\nimport {\r\n  Search,\r\n  Plus,\r\n  Download,\r\n  Phone,\r\n  Mail,\r\n  Calendar as CalendarIcon,\r\n  FileText,\r\n  MoreVertical,\r\n  Pencil,\r\n  Trash2,\r\n  MessageSquare,\r\n  CheckCircle,\r\n  ArrowUpDown,\r\n  ChevronUp,\r\n  ChevronLeft,\r\n  Users,\r\n  Filter,\r\n} from \"lucide-react\";\r\nimport * as XLSX from \"xlsx\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\nconst activityTypeConfig: Record<ActivityType, { label: string; icon: any; color: string; bgColor: string }> = {\r\n  call: { label: \"Phone Call\", icon: Phone, color: \"text-blue-600\", bgColor: \"bg-blue-500\" },\r\n  email: { label: \"Email\", icon: Mail, color: \"text-purple-600\", bgColor: \"bg-purple-500\" },\r\n  meeting: { label: \"Meeting\", icon: CalendarIcon, color: \"text-green-600\", bgColor: \"bg-green-500\" },\r\n  note: { label: \"Note\", icon: FileText, color: \"text-amber-600\", bgColor: \"bg-amber-500\" },\r\n  voicenote: { label: \"Voice Note\", icon: MessageSquare, color: \"text-pink-600\", bgColor: \"bg-pink-500\" },\r\n  stage: { label: \"Stage Change\", icon: ArrowUpDown, color: \"text-orange-600\", bgColor: \"bg-orange-500\" },\r\n  followup: { label: \"Follow Up\", icon: CheckCircle, color: \"text-emerald-600\", bgColor: \"bg-emerald-500\" },\r\n  attachment: { label: \"Attachment\", icon: FileText, color: \"text-indigo-600\", bgColor: \"bg-indigo-500\" },\r\n  other: { label: \"Other\", icon: MessageSquare, color: \"text-cyan-600\", bgColor: \"bg-cyan-500\" },\r\n};\r\n\r\nexport default function ActivitiesPage() {\r\n  const navigate = useNavigate();\r\n  const isMobile = useIsMobile();\r\n  const [page, setPage] = useState(1);\r\n  const [showFiltersSheet, setShowFiltersSheet] = useState(false);\r\n  const [pageSize] = useState(50);\r\n  const [selectedDate, setSelectedDate] = useState<Date>(new Date());\r\n  const [typeFilters, setTypeFilters] = useState<Set<ActivityType>>(new Set());\r\n  const [agentFilters, setAgentFilters] = useState<Set<string>>(new Set());\r\n  const [agentSearch, setAgentSearch] = useState(\"\");\r\n\r\n  // Dialog states\r\n  const [showAddDialog, setShowAddDialog] = useState(false);\r\n  const [showEditDialog, setShowEditDialog] = useState(false);\r\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\r\n  const [selectedActivity, setSelectedActivity] = useState<Activity | null>(null);\r\n\r\n  // Form states\r\n  const [formType, setFormType] = useState<ActivityType>(\"call\");\r\n  const [formSubject, setFormSubject] = useState(\"\");\r\n  const [formDescription, setFormDescription] = useState(\"\");\r\n  const [formLeadId, setFormLeadId] = useState(\"\");\r\n  const [formOwnerId, setFormOwnerId] = useState(\"\");\r\n  const [formScheduledAt, setFormScheduledAt] = useState<Date | undefined>();\r\n\r\n  const filters = useMemo(() => ({\r\n    type: typeFilters.size === 1 ? Array.from(typeFilters)[0] : undefined,\r\n    owner_id: agentFilters.size === 1 ? Array.from(agentFilters)[0] : undefined,\r\n  }), [typeFilters, agentFilters]);\r\n\r\n  const {\r\n    activities,\r\n    totalCount,\r\n    isLoading,\r\n    isAdminOrManager,\r\n    createActivity,\r\n    updateActivity,\r\n    deleteActivity,\r\n    getProfile,\r\n  } = useAllActivities({ filters, page, pageSize });\r\n\r\n  const { members } = useOrganizationMembers();\r\n  const { leads } = useCrmLeads();\r\n\r\n  // Filter activities by selected date and type/agent filters\r\n  const filteredActivities = useMemo(() => {\r\n    return activities.filter((activity) => {\r\n      const activityDate = activity.scheduled_at \r\n        ? parseISO(activity.scheduled_at) \r\n        : parseISO(activity.created_at);\r\n      \r\n      // Date filter\r\n      if (!isSameDay(activityDate, selectedDate)) return false;\r\n      \r\n      // Type filter\r\n      if (typeFilters.size > 0 && !typeFilters.has(activity.type)) return false;\r\n      \r\n      // Agent filter\r\n      if (agentFilters.size > 0 && activity.owner_id && !agentFilters.has(activity.owner_id)) return false;\r\n      \r\n      return true;\r\n    });\r\n  }, [activities, selectedDate, typeFilters, agentFilters]);\r\n\r\n  // Group activities by date for timeline\r\n  const groupedActivities = useMemo(() => {\r\n    const groups: Record<string, Activity[]> = {};\r\n    \r\n    filteredActivities.forEach((activity) => {\r\n      const date = activity.scheduled_at \r\n        ? format(parseISO(activity.scheduled_at), \"yyyy-MM-dd\")\r\n        : format(parseISO(activity.created_at), \"yyyy-MM-dd\");\r\n      \r\n      if (!groups[date]) groups[date] = [];\r\n      groups[date].push(activity);\r\n    });\r\n\r\n    // Sort by date descending\r\n    return Object.entries(groups)\r\n      .sort(([a], [b]) => b.localeCompare(a))\r\n      .map(([date, items]) => ({\r\n        date,\r\n        activities: items.sort((a, b) => {\r\n          const timeA = a.scheduled_at || a.created_at;\r\n          const timeB = b.scheduled_at || b.created_at;\r\n          return timeB.localeCompare(timeA);\r\n        }),\r\n      }));\r\n  }, [filteredActivities]);\r\n\r\n  // Filter members by search\r\n  const filteredMembers = useMemo(() => {\r\n    if (!members) return [];\r\n    if (!agentSearch) return members;\r\n    const search = agentSearch.toLowerCase();\r\n    return members.filter((m) => {\r\n      const name = `${m.profile?.first_name || \"\"} ${m.profile?.last_name || \"\"}`.toLowerCase();\r\n      return name.includes(search);\r\n    });\r\n  }, [members, agentSearch]);\r\n\r\n  const activeFiltersCount = typeFilters.size + agentFilters.size;\r\n\r\n  const toggleTypeFilter = (type: ActivityType) => {\r\n    const newFilters = new Set(typeFilters);\r\n    if (newFilters.has(type)) {\r\n      newFilters.delete(type);\r\n    } else {\r\n      newFilters.add(type);\r\n    }\r\n    setTypeFilters(newFilters);\r\n  };\r\n\r\n  const toggleAgentFilter = (agentId: string) => {\r\n    const newFilters = new Set(agentFilters);\r\n    if (newFilters.has(agentId)) {\r\n      newFilters.delete(agentId);\r\n    } else {\r\n      newFilters.add(agentId);\r\n    }\r\n    setAgentFilters(newFilters);\r\n  };\r\n\r\n  const resetForm = () => {\r\n    setFormType(\"call\");\r\n    setFormSubject(\"\");\r\n    setFormDescription(\"\");\r\n    setFormLeadId(\"\");\r\n    setFormOwnerId(\"\");\r\n    setFormScheduledAt(undefined);\r\n  };\r\n\r\n  const handleAddActivity = async () => {\r\n    if (!formSubject.trim()) {\r\n      toast.error(\"Subject is required\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      await createActivity({\r\n        type: formType,\r\n        subject: formSubject,\r\n        description: formDescription || undefined,\r\n        lead_id: formLeadId || undefined,\r\n        owner_id: formOwnerId || undefined,\r\n        scheduled_at: formScheduledAt?.toISOString(),\r\n      });\r\n      toast.success(\"Activity added successfully\");\r\n      setShowAddDialog(false);\r\n      resetForm();\r\n    } catch (error) {\r\n      toast.error(\"Failed to add activity\");\r\n      console.error(error);\r\n    }\r\n  };\r\n\r\n  const handleEditActivity = async () => {\r\n    if (!selectedActivity || !formSubject.trim()) {\r\n      toast.error(\"Subject is required\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      await updateActivity(selectedActivity.id, {\r\n        type: formType,\r\n        subject: formSubject,\r\n        description: formDescription || undefined,\r\n        lead_id: formLeadId || undefined,\r\n        owner_id: formOwnerId || undefined,\r\n        scheduled_at: formScheduledAt?.toISOString(),\r\n      });\r\n      toast.success(\"Activity updated successfully\");\r\n      setShowEditDialog(false);\r\n      setSelectedActivity(null);\r\n      resetForm();\r\n    } catch (error) {\r\n      toast.error(\"Failed to update activity\");\r\n      console.error(error);\r\n    }\r\n  };\r\n\r\n  const handleDeleteActivity = async () => {\r\n    if (!selectedActivity) return;\r\n\r\n    try {\r\n      await deleteActivity(selectedActivity.id);\r\n      toast.success(\"Activity deleted successfully\");\r\n      setShowDeleteDialog(false);\r\n      setSelectedActivity(null);\r\n    } catch (error) {\r\n      toast.error(\"Failed to delete activity\");\r\n      console.error(error);\r\n    }\r\n  };\r\n\r\n  const openEditDialog = (activity: Activity) => {\r\n    setSelectedActivity(activity);\r\n    setFormType(activity.type);\r\n    setFormSubject(activity.subject);\r\n    setFormDescription(activity.description || \"\");\r\n    setFormLeadId(activity.lead_id || \"\");\r\n    setFormOwnerId(activity.owner_id || \"\");\r\n    setFormScheduledAt(activity.scheduled_at ? parseISO(activity.scheduled_at) : undefined);\r\n    setShowEditDialog(true);\r\n  };\r\n\r\n  const openDeleteDialog = (activity: Activity) => {\r\n    setSelectedActivity(activity);\r\n    setShowDeleteDialog(true);\r\n  };\r\n\r\n  const handleExport = () => {\r\n    const exportData = filteredActivities.map((a) => {\r\n      const ownerProfile = getProfile(a.owner_id);\r\n      return {\r\n        \"Lead Name\": a.lead ? `${a.lead.first_name} ${a.lead.last_name || \"\"}`.trim() : \"-\",\r\n        \"Activity Type\": activityTypeConfig[a.type]?.label || a.type,\r\n        \"Title\": a.subject,\r\n        \"Description\": a.description || \"\",\r\n        \"Assigned Agent\": ownerProfile ? `${ownerProfile.first_name || \"\"} ${ownerProfile.last_name || \"\"}`.trim() : \"-\",\r\n        \"Activity Date\": a.scheduled_at ? format(parseISO(a.scheduled_at), \"PPp\") : \"-\",\r\n        \"Created At\": format(parseISO(a.created_at), \"PPp\"),\r\n      };\r\n    });\r\n\r\n    const worksheet = XLSX.utils.json_to_sheet(exportData);\r\n    const workbook = XLSX.utils.book_new();\r\n    XLSX.utils.book_append_sheet(workbook, worksheet, \"Activities\");\r\n    XLSX.writeFile(workbook, `activities_${format(new Date(), \"yyyy-MM-dd\")}.xlsx`);\r\n    toast.success(\"Exported successfully\");\r\n  };\r\n\r\n  const formatDateHeader = (dateStr: string) => {\r\n    const date = parseISO(dateStr);\r\n    if (isToday(date)) {\r\n      return { main: format(date, \"MMM d, yyyy\"), sub: \"Today\" };\r\n    }\r\n    return { main: format(date, \"MMM d, yyyy\"), sub: format(date, \"EEEE\") };\r\n  };\r\n\r\n  // Filter sidebar content (reused in both desktop sidebar and mobile sheet)\r\n  const FilterContent = () => (\r\n    <div className=\"space-y-6\">\r\n      {/* Calendar Section */}\r\n      <div>\r\n        <h2 className=\"text-lg font-semibold mb-3\">Calendar</h2>\r\n        <Card>\r\n          <CardContent className=\"p-3\">\r\n            <Calendar\r\n              mode=\"single\"\r\n              selected={selectedDate}\r\n              onSelect={(date) => date && setSelectedDate(date)}\r\n              className=\"rounded-md\"\r\n            />\r\n            <div className=\"mt-2 flex justify-end\">\r\n              <Button\r\n                variant=\"link\"\r\n                size=\"sm\"\r\n                className=\"text-primary font-medium\"\r\n                onClick={() => setSelectedDate(new Date())}\r\n              >\r\n                TODAY\r\n              </Button>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Filters Section */}\r\n      <div>\r\n        <h2 className=\"text-lg font-semibold mb-3\">Filters ({activeFiltersCount})</h2>\r\n        \r\n        {/* Activity Type Filters */}\r\n        <Card className=\"mb-4\">\r\n          <CardContent className=\"p-4\">\r\n            <h3 className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3\">\r\n              By Activity Type\r\n            </h3>\r\n            <div className=\"space-y-2\">\r\n              {Object.entries(activityTypeConfig).map(([key, { label, icon: Icon }]) => (\r\n                <label\r\n                  key={key}\r\n                  className=\"flex items-center justify-between cursor-pointer hover:bg-muted/50 p-2 rounded-md -mx-2\"\r\n                >\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <Icon className={cn(\"h-4 w-4\", activityTypeConfig[key as ActivityType].color)} />\r\n                    <span className=\"text-sm\">{label}</span>\r\n                  </div>\r\n                  <Checkbox\r\n                    checked={typeFilters.has(key as ActivityType)}\r\n                    onCheckedChange={() => toggleTypeFilter(key as ActivityType)}\r\n                  />\r\n                </label>\r\n              ))}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Team Member Filters */}\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <h3 className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3\">\r\n              By Team Member\r\n            </h3>\r\n            <div className=\"relative mb-3\">\r\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n              <Input\r\n                placeholder=\"Search team members\"\r\n                value={agentSearch}\r\n                onChange={(e) => setAgentSearch(e.target.value)}\r\n                className=\"pl-9 bg-muted/50\"\r\n              />\r\n            </div>\r\n            <ScrollArea className=\"h-[200px]\">\r\n              <div className=\"space-y-1\">\r\n                {filteredMembers.map((member) => (\r\n                  <label\r\n                    key={member.user_id}\r\n                    className=\"flex items-center justify-between cursor-pointer hover:bg-muted/50 p-2 rounded-md -mx-2\"\r\n                  >\r\n                    <div className=\"flex items-center gap-3\">\r\n                      <Avatar className=\"h-6 w-6\">\r\n                        <AvatarImage src={member.profile?.avatar_url || \"\"} />\r\n                        <AvatarFallback className=\"text-xs\">\r\n                          {(member.profile?.first_name?.[0] || \"\") + (member.profile?.last_name?.[0] || \"\")}\r\n                        </AvatarFallback>\r\n                      </Avatar>\r\n                      <span className=\"text-sm\">\r\n                        {member.profile?.first_name || \"Unknown\"} {member.profile?.last_name || \"\"}\r\n                      </span>\r\n                    </div>\r\n                    <Checkbox\r\n                      checked={agentFilters.has(member.user_id)}\r\n                      onCheckedChange={() => toggleAgentFilter(member.user_id)}\r\n                    />\r\n                  </label>\r\n                ))}\r\n                {filteredMembers.length === 0 && (\r\n                  <p className=\"text-sm text-muted-foreground text-center py-4\">\r\n                    No team members found\r\n                  </p>\r\n                )}\r\n              </div>\r\n            </ScrollArea>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  if (isLoading && activities.length === 0) {\r\n    return (\r\n      <PageContent className=\"pb-24 lg:pb-6\">\r\n        <div className=\"flex items-center gap-2 mb-6\">\r\n          <Button variant=\"ghost\" size=\"icon\" onClick={() => navigate(\"/\")}>\r\n            <ChevronLeft className=\"h-5 w-5\" />\r\n          </Button>\r\n          <h1 className=\"text-xl font-semibold\">Activities</h1>\r\n        </div>\r\n        <div className=\"space-y-4\">\r\n          <Skeleton className=\"h-12 w-full\" />\r\n          <Skeleton className=\"h-[400px] w-full\" />\r\n        </div>\r\n      </PageContent>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <PageContent className=\"pb-24 lg:pb-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between mb-4 lg:mb-6\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <Button variant=\"ghost\" size=\"icon\" onClick={() => navigate(\"/\")}>\r\n            <ChevronLeft className=\"h-5 w-5\" />\r\n          </Button>\r\n          <h1 className=\"text-lg lg:text-xl font-semibold\">Activities</h1>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n          {/* Mobile Filter Button */}\r\n          {isMobile && (\r\n            <Sheet open={showFiltersSheet} onOpenChange={setShowFiltersSheet}>\r\n              <SheetTrigger asChild>\r\n                <Button variant=\"outline\" size=\"sm\" className=\"relative\">\r\n                  <Filter className=\"h-4 w-4\" />\r\n                  {activeFiltersCount > 0 && (\r\n                    <span className=\"absolute -top-1 -right-1 h-4 w-4 bg-primary text-primary-foreground text-[10px] rounded-full flex items-center justify-center\">\r\n                      {activeFiltersCount}\r\n                    </span>\r\n                  )}\r\n                </Button>\r\n              </SheetTrigger>\r\n              <SheetContent side=\"right\" className=\"w-full sm:max-w-md overflow-y-auto\">\r\n                <SheetHeader className=\"mb-4\">\r\n                  <SheetTitle>Filters & Calendar</SheetTitle>\r\n                </SheetHeader>\r\n                <FilterContent />\r\n              </SheetContent>\r\n            </Sheet>\r\n          )}\r\n          {isAdminOrManager && (\r\n            <>\r\n              {!isMobile && (\r\n                <Button variant=\"outline\" size=\"sm\" onClick={handleExport}>\r\n                  <Download className=\"h-4 w-4 mr-2\" />\r\n                  Export\r\n                </Button>\r\n              )}\r\n              <Button size=\"sm\" onClick={() => setShowAddDialog(true)}>\r\n                <Plus className=\"h-4 w-4\" />\r\n                {!isMobile && <span className=\"ml-2\">Add Activity</span>}\r\n              </Button>\r\n            </>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Mobile Date Display */}\r\n      {isMobile && (\r\n        <div className=\"mb-4 flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <CalendarIcon className=\"h-4 w-4 text-muted-foreground\" />\r\n            <span className=\"text-sm font-medium\">{format(selectedDate, \"MMM d, yyyy\")}</span>\r\n            {isToday(selectedDate) && (\r\n              <span className=\"text-xs text-primary\">(Today)</span>\r\n            )}\r\n          </div>\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            className=\"text-primary text-xs\"\r\n            onClick={() => setShowFiltersSheet(true)}\r\n          >\r\n            Change Date\r\n          </Button>\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-[350px_1fr] gap-6\">\r\n        {/* Left Sidebar - Calendar & Filters (Desktop Only) */}\r\n        {!isMobile && (\r\n          <div className=\"hidden lg:block\">\r\n            <FilterContent />\r\n          </div>\r\n        )}\r\n\r\n        {/* Right Side - Timeline */}\r\n        <div className=\"lg:col-span-1\">\r\n          {!isMobile && <h2 className=\"text-lg font-semibold mb-3\">Timeline</h2>}\r\n          \r\n          {/* Load Previous Button */}\r\n          {page > 1 && (\r\n            <Button\r\n              variant=\"ghost\"\r\n              className=\"w-full mb-4 text-primary hover:text-primary text-sm\"\r\n              onClick={() => setPage(page - 1)}\r\n            >\r\n              <ChevronUp className=\"h-4 w-4 mr-2\" />\r\n              LOAD PREVIOUS\r\n            </Button>\r\n          )}\r\n\r\n          {/* Timeline Content */}\r\n          <Card>\r\n            <CardContent className=\"p-0\">\r\n              {groupedActivities.length === 0 ? (\r\n                <div className=\"flex flex-col items-center justify-center py-12 lg:py-16 text-muted-foreground px-4\">\r\n                  <CalendarIcon className=\"h-10 w-10 lg:h-12 lg:w-12 mb-4 opacity-50\" />\r\n                  <p className=\"text-base lg:text-lg font-medium text-center\">No activities found</p>\r\n                  <p className=\"text-xs lg:text-sm text-center\">Try selecting a different date or adjusting filters</p>\r\n                </div>\r\n              ) : (\r\n                <div className=\"divide-y divide-border\">\r\n                  {groupedActivities.map(({ date, activities: dayActivities }) => {\r\n                    const { main, sub } = formatDateHeader(date);\r\n                    return (\r\n                      <div key={date} className={cn(\"flex flex-col lg:flex-row\")}>\r\n                        {/* Date Column - Only on Desktop */}\r\n                        {!isMobile && (\r\n                          <div className=\"w-[140px] shrink-0 p-4 border-r border-border bg-muted/30\">\r\n                            <p className=\"font-semibold text-sm\">{main}</p>\r\n                            <p className=\"text-xs text-muted-foreground\">{sub}</p>\r\n                            <p className=\"text-xs text-primary mt-2 flex items-center gap-1\">\r\n                              <Users className=\"h-3 w-3\" />\r\n                              {dayActivities.length} {dayActivities.length === 1 ? \"activity\" : \"activities\"}\r\n                            </p>\r\n                          </div>\r\n                        )}\r\n\r\n                        {/* Mobile Date Header */}\r\n                        {isMobile && (\r\n                          <div className=\"px-3 py-2 bg-muted/50 border-b border-border flex items-center justify-between\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <p className=\"font-semibold text-sm\">{main}</p>\r\n                              <span className=\"text-xs text-muted-foreground\">({sub})</span>\r\n                            </div>\r\n                            <span className=\"text-xs text-primary\">\r\n                              {dayActivities.length} {dayActivities.length === 1 ? \"activity\" : \"activities\"}\r\n                            </span>\r\n                          </div>\r\n                        )}\r\n\r\n                        {/* Activities Column */}\r\n                        <div className=\"flex-1 divide-y divide-border\">\r\n                          {dayActivities.map((activity) => {\r\n                            const config = activityTypeConfig[activity.type] || activityTypeConfig.other;\r\n                            const Icon = config.icon;\r\n                            const ownerProfile = getProfile(activity.owner_id);\r\n                            const activityTime = activity.scheduled_at \r\n                              ? format(parseISO(activity.scheduled_at), \"hh:mm a\")\r\n                              : format(parseISO(activity.created_at), \"hh:mm a\");\r\n\r\n                            return (\r\n                              <div\r\n                                key={activity.id}\r\n                                className={cn(\r\n                                  \"flex items-start gap-3 lg:gap-4 p-3 lg:p-4 hover:bg-muted/30 transition-colors group\",\r\n                                  isMobile && \"active:bg-muted/50\"\r\n                                )}\r\n                              >\r\n                                {/* Time - Hidden on Mobile, shown inline instead */}\r\n                                {!isMobile && (\r\n                                  <span className=\"text-xs text-muted-foreground w-[60px] shrink-0 pt-1\">\r\n                                    {activityTime}\r\n                                  </span>\r\n                                )}\r\n\r\n                                {/* Icon Circle */}\r\n                                <div className={cn(\r\n                                  \"w-8 h-8 lg:w-8 lg:h-8 rounded-full flex items-center justify-center shrink-0\",\r\n                                  config.bgColor\r\n                                )}>\r\n                                  <Icon className=\"h-4 w-4 text-white\" />\r\n                                </div>\r\n\r\n                                {/* Content */}\r\n                                <div className=\"flex-1 min-w-0\">\r\n                                  <div className=\"flex items-start justify-between gap-2\">\r\n                                    <div className=\"flex-1 min-w-0\">\r\n                                      <p className=\"font-medium text-sm truncate\">\r\n                                        {activity.lead \r\n                                          ? `${activity.lead.first_name} ${activity.lead.last_name || \"\"}`.trim()\r\n                                          : activity.subject}\r\n                                      </p>\r\n                                      <div className=\"flex items-center gap-2 mt-0.5\">\r\n                                        <span className=\"text-xs text-muted-foreground\">{config.label}</span>\r\n                                        {isMobile && (\r\n                                          <span className=\"text-xs text-muted-foreground\">â€¢ {activityTime}</span>\r\n                                        )}\r\n                                      </div>\r\n                                    </div>\r\n                                    \r\n                                    {/* Actions Menu */}\r\n                                    {isAdminOrManager && (\r\n                                      <DropdownMenu>\r\n                                        <DropdownMenuTrigger asChild>\r\n                                          <Button\r\n                                            variant=\"ghost\"\r\n                                            size=\"icon\"\r\n                                            className={cn(\r\n                                              \"h-8 w-8 shrink-0\",\r\n                                              !isMobile && \"opacity-0 group-hover:opacity-100 transition-opacity\"\r\n                                            )}\r\n                                          >\r\n                                            <MoreVertical className=\"h-4 w-4\" />\r\n                                          </Button>\r\n                                        </DropdownMenuTrigger>\r\n                                        <DropdownMenuContent align=\"end\">\r\n                                          <DropdownMenuItem onClick={() => openEditDialog(activity)}>\r\n                                            <Pencil className=\"h-4 w-4 mr-2\" />\r\n                                            Edit\r\n                                          </DropdownMenuItem>\r\n                                          <DropdownMenuItem\r\n                                            onClick={() => openDeleteDialog(activity)}\r\n                                            className=\"text-destructive\"\r\n                                          >\r\n                                            <Trash2 className=\"h-4 w-4 mr-2\" />\r\n                                            Delete\r\n                                          </DropdownMenuItem>\r\n                                        </DropdownMenuContent>\r\n                                      </DropdownMenu>\r\n                                    )}\r\n                                  </div>\r\n                                  \r\n                                  {activity.description && (\r\n                                    <p className=\"text-xs lg:text-sm text-muted-foreground mt-1 line-clamp-2\">\r\n                                      {activity.description}\r\n                                    </p>\r\n                                  )}\r\n                                  {ownerProfile && (\r\n                                    <p className=\"text-xs text-muted-foreground mt-1.5 lg:mt-2 flex items-center gap-1\">\r\n                                      <span className=\"inline-block w-2.5 h-2.5 lg:w-3 lg:h-3 rounded-full bg-muted\" />\r\n                                      by {ownerProfile.first_name || \"\"} {ownerProfile.last_name || \"\"}\r\n                                    </p>\r\n                                  )}\r\n                                </div>\r\n                              </div>\r\n                            );\r\n                          })}\r\n                        </div>\r\n                      </div>\r\n                    );\r\n                  })}\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Load More */}\r\n          {totalCount > page * pageSize && (\r\n            <Button\r\n              variant=\"ghost\"\r\n              className=\"w-full mt-4 text-primary hover:text-primary text-sm\"\r\n              onClick={() => setPage(page + 1)}\r\n            >\r\n              Load More Activities\r\n            </Button>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Add Activity Dialog */}\r\n      <Dialog open={showAddDialog} onOpenChange={setShowAddDialog}>\r\n        <DialogContent className=\"max-w-[95vw] sm:max-w-lg max-h-[90vh] overflow-y-auto\">\r\n          <DialogHeader>\r\n            <DialogTitle>Add Activity</DialogTitle>\r\n            <DialogDescription>Create a new activity for a lead.</DialogDescription>\r\n          </DialogHeader>\r\n          <div className=\"space-y-4\">\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label>Type</Label>\r\n                <Select value={formType} onValueChange={(v) => setFormType(v as ActivityType)}>\r\n                  <SelectTrigger>\r\n                    <SelectValue />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    {Object.entries(activityTypeConfig).map(([key, { label }]) => (\r\n                      <SelectItem key={key} value={key}>\r\n                        {label}\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>Lead</Label>\r\n                <Select value={formLeadId} onValueChange={setFormLeadId}>\r\n                  <SelectTrigger>\r\n                    <SelectValue placeholder=\"Select lead\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    {leads?.map((lead) => (\r\n                      <SelectItem key={lead.id} value={lead.id}>\r\n                        {lead.first_name} {lead.last_name || \"\"}\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Subject *</Label>\r\n              <Input\r\n                value={formSubject}\r\n                onChange={(e) => setFormSubject(e.target.value)}\r\n                placeholder=\"Activity subject\"\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Description</Label>\r\n              <Textarea\r\n                value={formDescription}\r\n                onChange={(e) => setFormDescription(e.target.value)}\r\n                placeholder=\"Activity description\"\r\n                rows={3}\r\n              />\r\n            </div>\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label>Assign to</Label>\r\n                <Select value={formOwnerId} onValueChange={setFormOwnerId}>\r\n                  <SelectTrigger>\r\n                    <SelectValue placeholder=\"Select agent\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    {members?.map((member) => (\r\n                      <SelectItem key={member.user_id} value={member.user_id}>\r\n                        {member.profile?.first_name || \"Unknown\"} {member.profile?.last_name || \"\"}\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>Scheduled Date</Label>\r\n                <Popover>\r\n                  <PopoverTrigger asChild>\r\n                    <Button variant=\"outline\" className=\"w-full justify-start text-left font-normal\">\r\n                      <CalendarIcon className=\"mr-2 h-4 w-4\" />\r\n                      {formScheduledAt ? format(formScheduledAt, \"PPP\") : \"Pick a date\"}\r\n                    </Button>\r\n                  </PopoverTrigger>\r\n                  <PopoverContent className=\"w-auto p-0\" align=\"start\">\r\n                    <Calendar mode=\"single\" selected={formScheduledAt} onSelect={setFormScheduledAt} />\r\n                  </PopoverContent>\r\n                </Popover>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          <DialogFooter className=\"flex-col sm:flex-row gap-2\">\r\n            <Button variant=\"outline\" onClick={() => setShowAddDialog(false)} className=\"w-full sm:w-auto\">\r\n              Cancel\r\n            </Button>\r\n            <Button onClick={handleAddActivity} className=\"w-full sm:w-auto\">Add Activity</Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Edit Activity Dialog */}\r\n      <Dialog open={showEditDialog} onOpenChange={setShowEditDialog}>\r\n        <DialogContent className=\"max-w-[95vw] sm:max-w-lg max-h-[90vh] overflow-y-auto\">\r\n          <DialogHeader>\r\n            <DialogTitle>Edit Activity</DialogTitle>\r\n            <DialogDescription>Update activity details.</DialogDescription>\r\n          </DialogHeader>\r\n          <div className=\"space-y-4\">\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label>Type</Label>\r\n                <Select value={formType} onValueChange={(v) => setFormType(v as ActivityType)}>\r\n                  <SelectTrigger>\r\n                    <SelectValue />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    {Object.entries(activityTypeConfig).map(([key, { label }]) => (\r\n                      <SelectItem key={key} value={key}>\r\n                        {label}\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>Lead</Label>\r\n                <Select value={formLeadId} onValueChange={setFormLeadId}>\r\n                  <SelectTrigger>\r\n                    <SelectValue placeholder=\"Select lead\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    {leads?.map((lead) => (\r\n                      <SelectItem key={lead.id} value={lead.id}>\r\n                        {lead.first_name} {lead.last_name || \"\"}\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Subject *</Label>\r\n              <Input\r\n                value={formSubject}\r\n                onChange={(e) => setFormSubject(e.target.value)}\r\n                placeholder=\"Activity subject\"\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Description</Label>\r\n              <Textarea\r\n                value={formDescription}\r\n                onChange={(e) => setFormDescription(e.target.value)}\r\n                placeholder=\"Activity description\"\r\n                rows={3}\r\n              />\r\n            </div>\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label>Assign to</Label>\r\n                <Select value={formOwnerId} onValueChange={setFormOwnerId}>\r\n                  <SelectTrigger>\r\n                    <SelectValue placeholder=\"Select agent\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    {members?.map((member) => (\r\n                      <SelectItem key={member.user_id} value={member.user_id}>\r\n                        {member.profile?.first_name || \"Unknown\"} {member.profile?.last_name || \"\"}\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>Scheduled Date</Label>\r\n                <Popover>\r\n                  <PopoverTrigger asChild>\r\n                    <Button variant=\"outline\" className=\"w-full justify-start text-left font-normal\">\r\n                      <CalendarIcon className=\"mr-2 h-4 w-4\" />\r\n                      {formScheduledAt ? format(formScheduledAt, \"PPP\") : \"Pick a date\"}\r\n                    </Button>\r\n                  </PopoverTrigger>\r\n                  <PopoverContent className=\"w-auto p-0\" align=\"start\">\r\n                    <Calendar mode=\"single\" selected={formScheduledAt} onSelect={setFormScheduledAt} />\r\n                  </PopoverContent>\r\n                </Popover>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          <DialogFooter className=\"flex-col sm:flex-row gap-2\">\r\n            <Button variant=\"outline\" onClick={() => setShowEditDialog(false)} className=\"w-full sm:w-auto\">\r\n              Cancel\r\n            </Button>\r\n            <Button onClick={handleEditActivity} className=\"w-full sm:w-auto\">Save Changes</Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Delete Confirmation Dialog */}\r\n      <Dialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\r\n        <DialogContent className=\"max-w-[95vw] sm:max-w-md\">\r\n          <DialogHeader>\r\n            <DialogTitle>Delete Activity</DialogTitle>\r\n            <DialogDescription>\r\n              Are you sure you want to delete this activity? This action cannot be undone.\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <DialogFooter className=\"flex-col sm:flex-row gap-2\">\r\n            <Button variant=\"outline\" onClick={() => setShowDeleteDialog(false)} className=\"w-full sm:w-auto\">\r\n              Cancel\r\n            </Button>\r\n            <Button variant=\"destructive\" onClick={handleDeleteActivity} className=\"w-full sm:w-auto\">\r\n              Delete\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </PageContent>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\AssignmentLogsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\AuthPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":187,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":187,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5757,5760],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5757,5760],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":277,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":277,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8555,8558],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8555,8558],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":282,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":282,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8737,8740],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8737,8740],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from \"react\";\r\nimport { useNavigate, Link, useSearchParams } from \"react-router-dom\";\r\nimport { motion, AnimatePresence, useMotionValue, useSpring } from \"framer-motion\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { useTheme } from \"@/contexts/ThemeContext\";\r\nimport { toast } from \"sonner\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport {\r\n  Loader2, Mail, Lock, Building2, Eye, EyeOff, ArrowRight, ArrowLeft, Check\r\n} from \"lucide-react\";\r\nimport { CountrySelect, getCurrencyByCountry, getTimezoneByCountry } from \"@/components/ui/country-select\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport authBackground from \"@/assets/auth-background.jpg\";\r\n\r\ntype AuthMode = \"signin\" | \"signup\" | \"forgot\";\r\n\r\n// Particle configuration with base positions\r\nconst particles = [\r\n  { id: 1, baseTop: 20, baseLeft: 80, size: 8, duration: 8 },\r\n  { id: 2, baseTop: 35, baseLeft: 25, size: 6, duration: 10 },\r\n  { id: 3, baseTop: 70, baseLeft: 70, size: 10, duration: 12 },\r\n  { id: 4, baseTop: 85, baseLeft: 30, size: 5, duration: 9 },\r\n  { id: 5, baseTop: 45, baseLeft: 90, size: 7, duration: 11 },\r\n  { id: 6, baseTop: 10, baseLeft: 50, size: 4, duration: 7 },\r\n  { id: 7, baseTop: 55, baseLeft: 5, size: 6, duration: 13 },\r\n  { id: 8, baseTop: 75, baseLeft: 85, size: 8, duration: 10 },\r\n];\r\n\r\n// Mouse-reactive particle component\r\ninterface MouseReactiveParticleProps {\r\n  baseTop: number;\r\n  baseLeft: number;\r\n  size: number;\r\n  mouseX: ReturnType<typeof useSpring>;\r\n  mouseY: ReturnType<typeof useSpring>;\r\n  sensitivity: number;\r\n  className?: string;\r\n  animateProps?: Record<string, number[]>;\r\n  duration: number;\r\n  delay?: number;\r\n}\r\n\r\nfunction MouseReactiveParticle({\r\n  baseTop,\r\n  baseLeft,\r\n  size,\r\n  mouseX,\r\n  mouseY,\r\n  sensitivity,\r\n  className,\r\n  animateProps = {},\r\n  duration,\r\n  delay = 0,\r\n}: MouseReactiveParticleProps) {\r\n  const x = useMotionValue(0);\r\n  const y = useMotionValue(0);\r\n  const springX = useSpring(x, { stiffness: 100, damping: 30 });\r\n  const springY = useSpring(y, { stiffness: 100, damping: 30 });\r\n\r\n  useEffect(() => {\r\n    const unsubX = mouseX.on('change', (mx) => {\r\n      const distance = baseLeft - mx;\r\n      const push = distance * sensitivity * 0.5;\r\n      x.set(push);\r\n    });\r\n    const unsubY = mouseY.on('change', (my) => {\r\n      const distance = baseTop - my;\r\n      const push = distance * sensitivity * 0.5;\r\n      y.set(push);\r\n    });\r\n    return () => {\r\n      unsubX();\r\n      unsubY();\r\n    };\r\n  }, [mouseX, mouseY, baseLeft, baseTop, sensitivity, x, y]);\r\n\r\n  return (\r\n    <motion.div\r\n      className={cn(\"absolute\", className)}\r\n      style={{\r\n        top: `${baseTop}%`,\r\n        left: `${baseLeft}%`,\r\n        width: size,\r\n        height: size,\r\n        x: springX,\r\n        y: springY,\r\n      }}\r\n      animate={{\r\n        ...animateProps,\r\n      }}\r\n      transition={{\r\n        duration,\r\n        repeat: Infinity,\r\n        ease: \"easeInOut\",\r\n        delay,\r\n      }}\r\n    />\r\n  );\r\n}\r\n\r\nexport default function AuthPage() {\r\n  const navigate = useNavigate();\r\n  const [searchParams] = useSearchParams();\r\n  const { signIn, signInWithGoogle, refreshProfile, user } = useAuth();\r\n  const { setForceLightMode } = useTheme();\r\n  const panelRef = useRef<HTMLDivElement>(null);\r\n\r\n  const initialMode = (searchParams.get(\"mode\") as AuthMode) || \"signin\";\r\n  const [mode, setMode] = useState<AuthMode>(initialMode);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [showPassword, setShowPassword] = useState(false);\r\n\r\n  // Mouse position tracking\r\n  const mouseX = useMotionValue(0);\r\n  const mouseY = useMotionValue(0);\r\n  const smoothMouseX = useSpring(mouseX, { stiffness: 50, damping: 20 });\r\n  const smoothMouseY = useSpring(mouseY, { stiffness: 50, damping: 20 });\r\n\r\n  // Form fields\r\n  const [email, setEmail] = useState(\"\");\r\n  const [password, setPassword] = useState(\"\");\r\n  const [companyName, setCompanyName] = useState(\"\");\r\n  const [country, setCountry] = useState(\"\");\r\n\r\n  // Force light mode\r\n  useEffect(() => {\r\n    setForceLightMode(true);\r\n    return () => setForceLightMode(false);\r\n  }, [setForceLightMode]);\r\n\r\n  // Mouse move handler for particle effect\r\n  useEffect(() => {\r\n    const handleMouseMove = (e: MouseEvent) => {\r\n      if (panelRef.current) {\r\n        const rect = panelRef.current.getBoundingClientRect();\r\n        const x = ((e.clientX - rect.left) / rect.width) * 100;\r\n        const y = ((e.clientY - rect.top) / rect.height) * 100;\r\n        mouseX.set(x);\r\n        mouseY.set(y);\r\n      }\r\n    };\r\n\r\n    const panel = panelRef.current;\r\n    if (panel) {\r\n      panel.addEventListener('mousemove', handleMouseMove);\r\n      return () => panel.removeEventListener('mousemove', handleMouseMove);\r\n    }\r\n  }, [mouseX, mouseY]);\r\n\r\n  // Redirect if already logged in\r\n  useEffect(() => {\r\n    if (user) {\r\n      navigate(\"/\", { replace: true });\r\n    }\r\n  }, [user, navigate]);\r\n\r\n  const resetForm = () => {\r\n    setEmail(\"\");\r\n    setPassword(\"\");\r\n    setCompanyName(\"\");\r\n    setCountry(\"\");\r\n    setShowPassword(false);\r\n  };\r\n\r\n  const handleSignIn = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (isLoading) return;\r\n\r\n    if (!email || !password) {\r\n      toast.error(\"Please fill in all fields\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setIsLoading(true);\r\n      const { error } = await signIn(email, password);\r\n\r\n      if (error) {\r\n        toast.error(error.message);\r\n      } else {\r\n        toast.success(\"Welcome back!\");\r\n        navigate(\"/\");\r\n      }\r\n    } catch (error: any) {\r\n      toast.error(\"An unexpected error occurred\");\r\n      console.error(error);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleGoogleSignIn = async () => {\r\n    if (isLoading) return;\r\n    try {\r\n      setIsLoading(true);\r\n      const { error } = await signInWithGoogle();\r\n      if (error) {\r\n        toast.error(error.message);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Google sign in error:\", error);\r\n      toast.error(\"Failed to sign in with Google\");\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleSignUp = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (isLoading) return;\r\n\r\n    if (!companyName.trim()) {\r\n      toast.error(\"Please enter your company name\");\r\n      return;\r\n    }\r\n    if (!email || !password) {\r\n      toast.error(\"Please fill in all fields\");\r\n      return;\r\n    }\r\n    if (!country) {\r\n      toast.error(\"Please select your country\");\r\n      return;\r\n    }\r\n    if (password.length < 6) {\r\n      toast.error(\"Password must be at least 6 characters\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setIsLoading(true);\r\n      const currency = getCurrencyByCountry(country);\r\n      const timezone = getTimezoneByCountry(country);\r\n      const redirectUrl = `${window.location.origin}/`;\r\n\r\n      // Generate slug from company name\r\n      const slug = companyName.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') + '-' + Date.now().toString(36);\r\n\r\n      const { data: authData, error: authError } = await supabase.auth.signUp({\r\n        email,\r\n        password,\r\n        options: {\r\n          emailRedirectTo: redirectUrl,\r\n          data: { first_name: companyName, last_name: \"\" },\r\n        },\r\n      });\r\n\r\n      if (authError) {\r\n        if (authError.message.includes(\"security purposes\")) {\r\n          toast.error(\"Too many signup attempts. Please wait 60 seconds or sign in if you already have an account.\");\r\n        } else {\r\n          toast.error(authError.message);\r\n        }\r\n        return;\r\n      }\r\n\r\n      if (authData.user) {\r\n        // If the user already exists (and was just returned by signUp), we might need to handle that.\r\n        // But we proceed with setup      if (authData.user) {\r\n        try {\r\n          // Use RPC to setup account atomically and bypass RLS issues\r\n          const { error: setupError } = await supabase.rpc('setup_new_account', {\r\n            p_company_name: companyName,\r\n            p_slug: slug,\r\n            p_country: country,\r\n            p_currency: currency,\r\n            p_timezone: timezone\r\n          });\r\n\r\n          if (setupError) throw setupError;\r\n\r\n          await refreshProfile?.();\r\n          toast.success(\"Account created successfully!\");\r\n          navigate(\"/\");\r\n        } catch (error: any) {\r\n          console.error(\"Setup error:\", error);\r\n          toast.error(`Setup Error: ${error.message || \"Failed to complete setup\"}`);\r\n        }\r\n      }\r\n    } catch (err: any) {\r\n      toast.error(err.message || \"An unexpected error occurred\");\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleForgotPassword = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!email) {\r\n      toast.error(\"Please enter your email\");\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n    const { error } = await supabase.auth.resetPasswordForEmail(email, {\r\n      redirectTo: `${window.location.origin}/login`,\r\n    });\r\n\r\n    if (error) {\r\n      toast.error(error.message);\r\n    } else {\r\n      toast.success(\"Password reset email sent!\");\r\n      setMode(\"signin\");\r\n    }\r\n    setIsLoading(false);\r\n  };\r\n\r\n  const switchMode = (newMode: AuthMode) => {\r\n    resetForm();\r\n    setMode(newMode);\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen flex bg-background\">\r\n      {/* Left Panel - Branding with Image Background (Desktop only) */}\r\n      <div ref={panelRef} className=\"hidden lg:flex lg:w-1/2 relative overflow-hidden\">\r\n        {/* Background Image */}\r\n        <img\r\n          src={authBackground}\r\n          alt=\"Real Estate Skyline\"\r\n          className=\"absolute inset-0 w-full h-full object-cover\"\r\n        />\r\n\r\n        {/* Dark Overlay with Gradient */}\r\n        <div className=\"absolute inset-0 bg-gradient-to-br from-indigo-900/95 via-purple-900/95 to-violet-900/95\" />\r\n\r\n        {/* Subtle Pattern Overlay */}\r\n        <div className=\"absolute inset-0 opacity-5\">\r\n          <div className=\"absolute inset-0\" style={{\r\n            backgroundImage: `radial-gradient(circle at 1px 1px, white 1px, transparent 0)`,\r\n            backgroundSize: '32px 32px'\r\n          }} />\r\n        </div>\r\n\r\n        {/* Mouse-following glow */}\r\n        <motion.div\r\n          className=\"absolute w-96 h-96 bg-white/5 rounded-full blur-3xl pointer-events-none\"\r\n          style={{\r\n            left: smoothMouseX,\r\n            top: smoothMouseY,\r\n            x: '-50%',\r\n            y: '-50%',\r\n          }}\r\n        />\r\n\r\n        {/* Static Glow Effects */}\r\n        <div className=\"absolute top-1/4 right-0 w-96 h-96 bg-white/10 rounded-full blur-3xl\" />\r\n        <div className=\"absolute bottom-1/4 left-0 w-96 h-96 bg-white/5 rounded-full blur-3xl\" />\r\n\r\n        {/* Floating Particles with Mouse Interaction */}\r\n        <div className=\"absolute inset-0 overflow-hidden pointer-events-none\">\r\n          {/* Large slow-moving circles that react to mouse */}\r\n          <MouseReactiveParticle\r\n            baseTop={15}\r\n            baseLeft={10}\r\n            size={96}\r\n            mouseX={smoothMouseX}\r\n            mouseY={smoothMouseY}\r\n            sensitivity={0.15}\r\n            className=\"rounded-full border border-white/10 bg-white/5\"\r\n            animateProps={{\r\n              rotate: [0, 180, 360]\r\n            }}\r\n            duration={20}\r\n          />\r\n          <MouseReactiveParticle\r\n            baseTop={60}\r\n            baseLeft={85}\r\n            size={128}\r\n            mouseX={smoothMouseX}\r\n            mouseY={smoothMouseY}\r\n            sensitivity={0.1}\r\n            className=\"rounded-full border border-white/10 bg-white/5\"\r\n            duration={25}\r\n          />\r\n\r\n          {/* Small floating dots with mouse interaction */}\r\n          {particles.map((particle) => (\r\n            <MouseReactiveParticle\r\n              key={particle.id}\r\n              baseTop={particle.baseTop}\r\n              baseLeft={particle.baseLeft}\r\n              size={particle.size}\r\n              mouseX={smoothMouseX}\r\n              mouseY={smoothMouseY}\r\n              sensitivity={0.3}\r\n              className=\"rounded-full bg-white/30\"\r\n              duration={particle.duration}\r\n              delay={particle.id * 0.5}\r\n            />\r\n          ))}\r\n\r\n          {/* Geometric shapes with mouse interaction */}\r\n          <MouseReactiveParticle\r\n            baseTop={25}\r\n            baseLeft={75}\r\n            size={64}\r\n            mouseX={smoothMouseX}\r\n            mouseY={smoothMouseY}\r\n            sensitivity={0.2}\r\n            className=\"border border-white/10 bg-white/5 rotate-45\"\r\n            animateProps={{\r\n              rotate: [45, 405],\r\n              scale: [1, 1.1, 1],\r\n            }}\r\n            duration={30}\r\n          />\r\n          <MouseReactiveParticle\r\n            baseTop={80}\r\n            baseLeft={20}\r\n            size={48}\r\n            mouseX={smoothMouseX}\r\n            mouseY={smoothMouseY}\r\n            sensitivity={0.25}\r\n            className=\"border border-white/10 bg-white/5 rotate-45\"\r\n            animateProps={{\r\n              rotate: [405, 45],\r\n            }}\r\n            duration={18}\r\n          />\r\n\r\n          {/* Glowing orbs with mouse interaction */}\r\n          <MouseReactiveParticle\r\n            baseTop={40}\r\n            baseLeft={60}\r\n            size={12}\r\n            mouseX={smoothMouseX}\r\n            mouseY={smoothMouseY}\r\n            sensitivity={0.4}\r\n            className=\"rounded-full bg-white shadow-[0_0_20px_rgba(255,255,255,0.5)]\"\r\n            animateProps={{\r\n              scale: [1, 1.3, 1],\r\n              opacity: [0.2, 0.4, 0.2],\r\n            }}\r\n            duration={4}\r\n          />\r\n          <MouseReactiveParticle\r\n            baseTop={65}\r\n            baseLeft={45}\r\n            size={8}\r\n            mouseX={smoothMouseX}\r\n            mouseY={smoothMouseY}\r\n            sensitivity={0.45}\r\n            className=\"rounded-full bg-white shadow-[0_0_15px_rgba(255,255,255,0.5)]\"\r\n            animateProps={{\r\n              scale: [1, 1.5, 1],\r\n              opacity: [0.3, 0.5, 0.3],\r\n            }}\r\n            duration={5}\r\n            delay={1}\r\n          />\r\n          <MouseReactiveParticle\r\n            baseTop={15}\r\n            baseLeft={75}\r\n            size={8}\r\n            mouseX={smoothMouseX}\r\n            mouseY={smoothMouseY}\r\n            sensitivity={0.35}\r\n            className=\"rounded-full bg-white shadow-[0_0_15px_rgba(255,255,255,0.5)]\"\r\n            animateProps={{\r\n              scale: [1, 1.4, 1],\r\n              opacity: [0.2, 0.45, 0.2],\r\n            }}\r\n            duration={6}\r\n            delay={2}\r\n          />\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <div className=\"relative z-10 flex flex-col justify-center p-12 xl:p-16 w-full\">\r\n          {/* Back to Home */}\r\n          <Link\r\n            to=\"/landing\"\r\n            className=\"absolute top-8 left-8 flex items-center gap-2 px-5 py-2.5 rounded-full bg-white/10 backdrop-blur-md border border-white/20 text-sm font-medium text-white hover:bg-white/20 transition-all duration-300 hover:scale-105\"\r\n          >\r\n            <ArrowLeft className=\"w-4 h-4\" />\r\n            Back to Home\r\n          </Link>\r\n\r\n          {/* Logo */}\r\n          <motion.div\r\n            initial={{ opacity: 0, y: 20 }}\r\n            animate={{ opacity: 1, y: 0 }}\r\n            transition={{ duration: 0.5 }}\r\n            className=\"flex items-center gap-3 mb-12\"\r\n          >\r\n            <div className=\"w-14 h-14 rounded-2xl bg-white/15 backdrop-blur-md border border-white/20 flex items-center justify-center shadow-2xl\">\r\n              <span className=\"text-white font-bold text-2xl\">O</span>\r\n            </div>\r\n            <span className=\"font-bold text-2xl text-white tracking-tight\">\r\n              OneLinker\r\n            </span>\r\n          </motion.div>\r\n\r\n          <motion.h1\r\n            initial={{ opacity: 0, y: 20 }}\r\n            animate={{ opacity: 1, y: 0 }}\r\n            transition={{ duration: 0.5, delay: 0.1 }}\r\n            className=\"text-4xl xl:text-5xl font-bold text-white mb-4 leading-tight\"\r\n          >\r\n            Real Estate CRM\r\n          </motion.h1>\r\n          <motion.h2\r\n            initial={{ opacity: 0, y: 20 }}\r\n            animate={{ opacity: 1, y: 0 }}\r\n            transition={{ duration: 0.5, delay: 0.15 }}\r\n            className=\"text-3xl xl:text-4xl font-bold text-white/80 mb-6\"\r\n          >\r\n            Built for Growth\r\n          </motion.h2>\r\n\r\n          <motion.p\r\n            initial={{ opacity: 0, y: 20 }}\r\n            animate={{ opacity: 1, y: 0 }}\r\n            transition={{ duration: 0.5, delay: 0.2 }}\r\n            className=\"text-lg text-white/70 mb-10 max-w-md leading-relaxed\"\r\n          >\r\n            Manage leads, listings, and teams all in one place.\r\n            <br />\r\n            Trusted by 500+ real estate companies.\r\n          </motion.p>\r\n\r\n          {/* Features */}\r\n          <motion.div\r\n            initial={{ opacity: 0, y: 20 }}\r\n            animate={{ opacity: 1, y: 0 }}\r\n            transition={{ duration: 0.5, delay: 0.3 }}\r\n            className=\"space-y-4\"\r\n          >\r\n            {[\r\n              \"Lead management & automation\",\r\n              \"Property listings & portals\",\r\n              \"Team collaboration tools\",\r\n            ].map((feature, index) => (\r\n              <motion.div\r\n                key={index}\r\n                initial={{ opacity: 0, x: -20 }}\r\n                animate={{ opacity: 1, x: 0 }}\r\n                transition={{ duration: 0.4, delay: 0.4 + index * 0.1 }}\r\n                className=\"flex items-center gap-3 text-white\"\r\n              >\r\n                <div className=\"w-7 h-7 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center border border-white/10\">\r\n                  <Check className=\"w-4 h-4\" />\r\n                </div>\r\n                <span className=\"text-base font-medium\">{feature}</span>\r\n              </motion.div>\r\n            ))}\r\n          </motion.div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Right Panel - Form */}\r\n      <div className=\"flex-1 flex items-center justify-center p-6 sm:p-8 lg:p-12 bg-gray-50/50\">\r\n        <div className=\"w-full max-w-md bg-white p-8 rounded-2xl shadow-xl border border-gray-100\">\r\n          {/* Mobile Back Link */}\r\n          <Link\r\n            to=\"/landing\"\r\n            className=\"lg:hidden inline-flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors mb-8\"\r\n          >\r\n            <ArrowLeft className=\"w-4 h-4\" />\r\n            <span className=\"text-sm\">Back to Home</span>\r\n          </Link>\r\n\r\n          {/* Mobile Logo */}\r\n          <div className=\"lg:hidden flex items-center justify-center gap-2 mb-8\">\r\n            <div className=\"w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center\">\r\n              <span className=\"text-white font-bold text-lg\">O</span>\r\n            </div>\r\n            <span className=\"font-bold text-xl\">OneLinker</span>\r\n          </div>\r\n\r\n          <AnimatePresence mode=\"wait\">\r\n            <motion.div\r\n              key={mode}\r\n              initial={{ opacity: 0, y: 10 }}\r\n              animate={{ opacity: 1, y: 0 }}\r\n              exit={{ opacity: 0, y: -10 }}\r\n              transition={{ duration: 0.2 }}\r\n            >\r\n              {/* Header */}\r\n              <div className=\"text-center mb-8\">\r\n                <h2 className=\"text-2xl sm:text-3xl font-bold mb-2\">\r\n                  {mode === \"signin\" && \"Welcome Back\"}\r\n                  {mode === \"signup\" && \"Create Account\"}\r\n                  {mode === \"forgot\" && \"Reset Password\"}\r\n                </h2>\r\n                <p className=\"text-muted-foreground text-sm sm:text-base\">\r\n                  {mode === \"signin\" && \"Sign in to continue to your dashboard\"}\r\n                  {mode === \"signup\" && \"Get started with your free account\"}\r\n                  {mode === \"forgot\" && \"Enter your email to reset your password\"}\r\n                </p>\r\n              </div>\r\n\r\n              {/* Sign Up Benefits */}\r\n              {mode === \"signup\" && (\r\n                <div className=\"flex flex-wrap justify-center gap-x-4 gap-y-2 mb-6\">\r\n                  {[\"Free forever\", \"1 user included\", \"No credit card\"].map((text) => (\r\n                    <div key={text} className=\"flex items-center gap-1.5 text-xs text-muted-foreground\">\r\n                      <Check className=\"w-3.5 h-3.5 text-green-500\" />\r\n                      <span>{text}</span>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n\r\n              {/* Google Button (Sign In/Up only) */}\r\n              {mode !== \"forgot\" && (\r\n                <>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    className=\"w-full h-12 gap-3 mb-6\"\r\n                    onClick={handleGoogleSignIn}\r\n                  >\r\n                    <svg className=\"w-5 h-5\" viewBox=\"0 0 24 24\">\r\n                      <path fill=\"#4285F4\" d=\"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z\" />\r\n                      <path fill=\"#34A853\" d=\"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z\" />\r\n                      <path fill=\"#FBBC05\" d=\"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z\" />\r\n                      <path fill=\"#EA4335\" d=\"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z\" />\r\n                    </svg>\r\n                    Continue with Google\r\n                  </Button>\r\n\r\n                  <div className=\"relative mb-6\">\r\n                    <div className=\"absolute inset-0 flex items-center\">\r\n                      <div className=\"w-full border-t border-border\" />\r\n                    </div>\r\n                    <div className=\"relative flex justify-center text-xs uppercase\">\r\n                      <span className=\"bg-background px-3 text-muted-foreground\">or</span>\r\n                    </div>\r\n                  </div>\r\n                </>\r\n              )}\r\n\r\n              {/* Forms */}\r\n              {mode === \"signin\" && (\r\n                <form onSubmit={handleSignIn} className=\"space-y-4\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"email\">Email</Label>\r\n                    <div className=\"relative\">\r\n                      <Mail className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\r\n                      <Input\r\n                        id=\"email\"\r\n                        type=\"email\"\r\n                        placeholder=\"you@example.com\"\r\n                        className=\"pl-10 h-12\"\r\n                        value={email}\r\n                        onChange={(e) => setEmail(e.target.value)}\r\n                        required\r\n                      />\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <Label htmlFor=\"password\">Password</Label>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => switchMode(\"forgot\")}\r\n                        className=\"text-sm text-indigo-600 hover:text-indigo-700 hover:underline transition-colors\"\r\n                      >\r\n                        Forgot password?\r\n                      </button>\r\n                    </div>\r\n                    <div className=\"relative\">\r\n                      <Lock className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\r\n                      <Input\r\n                        id=\"password\"\r\n                        type={showPassword ? \"text\" : \"password\"}\r\n                        placeholder=\"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢\"\r\n                        className=\"pl-10 pr-10 h-12\"\r\n                        value={password}\r\n                        onChange={(e) => setPassword(e.target.value)}\r\n                        required\r\n                      />\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => setShowPassword(!showPassword)}\r\n                        className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\r\n                      >\r\n                        {showPassword ? <EyeOff className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                  <Button type=\"submit\" className=\"w-full h-12 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white shadow-lg shadow-indigo-500/20 transition-all duration-300\" disabled={isLoading}>\r\n                    {isLoading ? (\r\n                      <><Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />Signing in...</>\r\n                    ) : (\r\n                      <>Sign In<ArrowRight className=\"ml-2 w-4 h-4\" /></>\r\n                    )}\r\n                  </Button>\r\n                </form>\r\n              )}\r\n\r\n              {mode === \"signup\" && (\r\n                <form onSubmit={handleSignUp} className=\"space-y-4\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"company\">Company Name</Label>\r\n                    <div className=\"relative\">\r\n                      <Building2 className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\r\n                      <Input\r\n                        id=\"company\"\r\n                        placeholder=\"Your Company Name\"\r\n                        className=\"pl-10 h-12\"\r\n                        value={companyName}\r\n                        onChange={(e) => setCompanyName(e.target.value)}\r\n                        required\r\n                      />\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"signup-email\">Email</Label>\r\n                    <div className=\"relative\">\r\n                      <Mail className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\r\n                      <Input\r\n                        id=\"signup-email\"\r\n                        type=\"email\"\r\n                        placeholder=\"you@example.com\"\r\n                        className=\"pl-10 h-12\"\r\n                        value={email}\r\n                        onChange={(e) => setEmail(e.target.value)}\r\n                        required\r\n                      />\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"signup-password\">Password</Label>\r\n                    <div className=\"relative\">\r\n                      <Lock className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\r\n                      <Input\r\n                        id=\"signup-password\"\r\n                        type={showPassword ? \"text\" : \"password\"}\r\n                        placeholder=\"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢\"\r\n                        className=\"pl-10 pr-10 h-12\"\r\n                        value={password}\r\n                        onChange={(e) => setPassword(e.target.value)}\r\n                        required\r\n                        minLength={6}\r\n                      />\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => setShowPassword(!showPassword)}\r\n                        className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\r\n                      >\r\n                        {showPassword ? <EyeOff className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label>Country</Label>\r\n                    <CountrySelect\r\n                      value={country}\r\n                      onValueChange={setCountry}\r\n                      placeholder=\"Select country\"\r\n                      className=\"h-12\"\r\n                    />\r\n                  </div>\r\n                  <Button type=\"submit\" className=\"w-full h-12 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white shadow-lg shadow-indigo-500/20 transition-all duration-300\" disabled={isLoading}>\r\n                    {isLoading ? (\r\n                      <><Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />Creating account...</>\r\n                    ) : (\r\n                      <>Create Account<ArrowRight className=\"ml-2 w-4 h-4\" /></>\r\n                    )}\r\n                  </Button>\r\n                </form>\r\n              )}\r\n\r\n              {mode === \"forgot\" && (\r\n                <form onSubmit={handleForgotPassword} className=\"space-y-4\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"forgot-email\">Email</Label>\r\n                    <div className=\"relative\">\r\n                      <Mail className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\r\n                      <Input\r\n                        id=\"forgot-email\"\r\n                        type=\"email\"\r\n                        placeholder=\"you@example.com\"\r\n                        className=\"pl-10 h-12\"\r\n                        value={email}\r\n                        onChange={(e) => setEmail(e.target.value)}\r\n                        required\r\n                      />\r\n                    </div>\r\n                  </div>\r\n                  <Button type=\"submit\" className=\"w-full h-12 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white shadow-lg shadow-indigo-500/20 transition-all duration-300\" disabled={isLoading}>\r\n                    {isLoading ? (\r\n                      <><Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />Sending...</>\r\n                    ) : (\r\n                      <>Send Reset Link<ArrowRight className=\"ml-2 w-4 h-4\" /></>\r\n                    )}\r\n                  </Button>\r\n                  <Button\r\n                    type=\"button\"\r\n                    variant=\"ghost\"\r\n                    className=\"w-full\"\r\n                    onClick={() => switchMode(\"signin\")}\r\n                  >\r\n                    <ArrowLeft className=\"mr-2 w-4 h-4\" />\r\n                    Back to Sign In\r\n                  </Button>\r\n                </form>\r\n              )}\r\n\r\n              {/* Toggle */}\r\n              {mode !== \"forgot\" && (\r\n                <p className=\"text-center text-sm text-muted-foreground mt-6\">\r\n                  {mode === \"signin\" ? \"Don't have an account?\" : \"Already have an account?\"}{\" \"}\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => switchMode(mode === \"signin\" ? \"signup\" : \"signin\")}\r\n                    className=\"text-indigo-600 font-medium hover:underline hover:text-indigo-700 transition-colors\"\r\n                  >\r\n                    {mode === \"signin\" ? \"Sign Up\" : \"Sign In\"}\r\n                  </button>\r\n                </p>\r\n              )}\r\n\r\n              {/* Terms */}\r\n              <p className=\"text-center text-xs text-muted-foreground mt-6\">\r\n                By continuing, you agree to our{\" \"}\r\n                <Link to=\"/landing/terms\" className=\"text-indigo-600 hover:underline hover:text-indigo-700 transition-colors\">Terms</Link>\r\n                {\" \"}and{\" \"}\r\n                <Link to=\"/landing/privacy\" className=\"text-indigo-600 hover:underline hover:text-indigo-700 transition-colors\">Privacy Policy</Link>\r\n              </p>\r\n            </motion.div>\r\n          </AnimatePresence>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\BillingPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\CampaignsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":161,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":161,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6055,6058],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6055,6058],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":292,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":292,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10847,10850],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10847,10850],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { ArrowLeft, ArrowRight, Megaphone, Send, Save } from 'lucide-react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card, CardContent } from '@/components/ui/card';\r\nimport { useLanguageSafe } from '@/contexts/LanguageContext';\r\nimport { CampaignsPageSkeleton } from '@/components/ui/page-skeletons';\r\nimport { useIsMobile } from '@/hooks/use-mobile';\r\nimport { cn } from '@/lib/utils';\r\nimport { toast } from 'sonner';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\n\r\nimport { CampaignStepIndicator } from '@/components/marketing-hub/CampaignStepIndicator';\r\nimport { ChannelStep } from '@/components/marketing-hub/steps/ChannelStep';\r\nimport { ConnectionStep } from '@/components/marketing-hub/steps/ConnectionStep';\r\nimport { CampaignTypeStep } from '@/components/marketing-hub/steps/CampaignTypeStep';\r\nimport { TemplateStep } from '@/components/marketing-hub/steps/TemplateStep';\r\nimport { AudienceStep } from '@/components/marketing-hub/steps/AudienceStep';\r\nimport { ScheduleStep } from '@/components/marketing-hub/steps/ScheduleStep';\r\nimport { ReviewStep } from '@/components/marketing-hub/steps/ReviewStep';\r\nimport { useLocalization } from \"@/contexts/LocalizationContext\";\r\nimport {\r\n  CampaignStep, CampaignChannel, CampaignType, CampaignDraft, LeadFilter, AudienceSelectionMethod, ImportedLead\r\n} from '@/components/marketing-hub/types';\r\n\r\nconst stepOrder: CampaignStep[] = ['channel', 'connection', 'type', 'template', 'audience', 'schedule', 'review'];\r\n\r\nexport default function CampaignsPage() {\r\n  const { t } = useLocalization();\r\n\r\n  const { isRTL } = useLanguageSafe();\r\n  const { session } = useAuth();\r\n  const isMobile = useIsMobile();\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [currentStep, setCurrentStep] = useState<CampaignStep>('channel');\r\n  const [completedSteps, setCompletedSteps] = useState<CampaignStep[]>([]);\r\n  const [draft, setDraft] = useState<CampaignDraft>({ sendNow: true, channel: 'whatsapp' });\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n  const [companyId, setCompanyId] = useState<string | null>(null);\r\n\r\n  useEffect(() => {\r\n    const timer = setTimeout(() => setIsLoading(false), 600);\r\n    return () => clearTimeout(timer);\r\n  }, []);\r\n\r\n  // Fetch company ID\r\n  useEffect(() => {\r\n    const fetchCompanyId = async () => {\r\n      if (!session?.user?.id) return;\r\n\r\n      const { data: agent } = await supabase\r\n        .from('agents')\r\n        .select('company_id')\r\n        .eq('user_id', session.user.id)\r\n        .single();\r\n\r\n      if (agent?.company_id) {\r\n        setCompanyId(agent.company_id);\r\n      }\r\n    };\r\n\r\n    fetchCompanyId();\r\n  }, [session?.user?.id]);\r\n\r\n  if (isLoading) {\r\n    return <CampaignsPageSkeleton isMobile={isMobile} />;\r\n  }\r\n\r\n  const currentIndex = stepOrder.indexOf(currentStep);\r\n  const isFirstStep = currentIndex === 0;\r\n  const isLastStep = currentIndex === stepOrder.length - 1;\r\n\r\n  const getAudienceCount = () => {\r\n    if (draft.audienceMethod === 'excel_import') {\r\n      return draft.importedLeads?.length || 0;\r\n    }\r\n    return draft.selectedLeads?.length || 0;\r\n  };\r\n\r\n  const canProceed = () => {\r\n    switch (currentStep) {\r\n      case 'channel': return !!draft.channel;\r\n      case 'connection': return !!draft.connectionId;\r\n      case 'type': return !!draft.type;\r\n      case 'template': return !!(draft.templateId || draft.customContent);\r\n      case 'audience': return getAudienceCount() > 0;\r\n      case 'schedule': return draft.sendNow || !!draft.scheduledAt;\r\n      case 'review': return true;\r\n      default: return false;\r\n    }\r\n  };\r\n\r\n  const handleNext = () => {\r\n    if (!canProceed()) {\r\n      if (currentStep === 'connection') {\r\n        toast.error(isRTL ? 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠÙ„Ø© Ø§ØªØµØ§Ù„' : 'Please select a connection');\r\n        return;\r\n      }\r\n      if (currentStep === 'audience') {\r\n        toast.error(isRTL ? 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±' : 'Please select audience');\r\n        return;\r\n      }\r\n      toast.error(isRTL ? 'ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©' : 'Please complete this step');\r\n      return;\r\n    }\r\n    if (!completedSteps.includes(currentStep)) {\r\n      setCompletedSteps([...completedSteps, currentStep]);\r\n    }\r\n    if (currentIndex < stepOrder.length - 1) {\r\n      setCurrentStep(stepOrder[currentIndex + 1]);\r\n    }\r\n  };\r\n\r\n  const handleBack = () => {\r\n    if (currentIndex > 0) {\r\n      setCurrentStep(stepOrder[currentIndex - 1]);\r\n    }\r\n  };\r\n\r\n  const handleSubmit = async () => {\r\n    if (!companyId) {\r\n      toast.error(isRTL ? 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ©' : 'Company not found');\r\n      return;\r\n    }\r\n\r\n    setIsSubmitting(true);\r\n\r\n    try {\r\n      // 1. Create the campaign\r\n      const campaignData = {\r\n        company_id: companyId,\r\n        channel: draft.channel || 'whatsapp',\r\n        campaign_type: draft.type === 'lead-nurturing' ? 'broadcast' :\r\n          draft.type === 'drip' ? 'drip' :\r\n            draft.type === 'property-promotion' ? 'broadcast' : 'broadcast',\r\n        name: `Campaign ${new Date().toLocaleDateString()}`,\r\n        connection_id: draft.connectionId,\r\n        template_content: draft.customContent ? { body: draft.customContent } : null,\r\n        template_id: draft.templateId,\r\n        status: draft.sendNow ? 'sending' : 'scheduled',\r\n        scheduled_at: draft.scheduledAt?.toISOString() || null,\r\n        timezone: draft.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone,\r\n        total_recipients: getAudienceCount(),\r\n        audience_type: draft.audienceMethod || 'manual',\r\n      };\r\n\r\n      const { data: campaign, error: campaignError } = await supabase\r\n        .from('campaigns')\r\n        .insert(campaignData)\r\n        .select()\r\n        .single();\r\n\r\n      if (campaignError) {\r\n        console.error('Campaign creation error:', campaignError);\r\n        throw new Error(campaignError.message);\r\n      }\r\n\r\n\r\n\r\n      // 2. Add recipients based on audience method\r\n      let allRecipients: any[] = [];\r\n\r\n      if (draft.audienceMethod === 'excel_import' && draft.importedLeads) {\r\n        // Excel imported leads\r\n        allRecipients = draft.importedLeads.map(lead => ({\r\n          campaign_id: campaign.id,\r\n          company_id: companyId,\r\n          phone_number: lead.phone,\r\n          name: lead.name || null,\r\n          imported_from: 'excel_import',\r\n          delivery_status: 'queued',\r\n        }));\r\n      } else if (draft.selectedLeads && draft.selectedLeads.length > 0) {\r\n        // Manually selected leads from CRM\r\n        // Fetch leads in batches if needed, but for now fetch id/phone/name\r\n        const { data: leads } = await supabase\r\n          .from('leads')\r\n          .select('id, name, phone')\r\n          .in('id', draft.selectedLeads);\r\n\r\n        if (leads) {\r\n          allRecipients = leads\r\n            .filter(lead => lead.phone) // Ensure phone exists\r\n            .map(lead => ({\r\n              campaign_id: campaign.id,\r\n              company_id: companyId,\r\n              lead_id: lead.id,\r\n              phone_number: lead.phone,\r\n              name: lead.name,\r\n              imported_from: draft.audienceMethod === 'select_all' ? 'select_all' : 'manual_selection',\r\n              delivery_status: 'queued',\r\n            }));\r\n        }\r\n      }\r\n\r\n      // Batch insert recipients\r\n      if (allRecipients.length > 0) {\r\n        const BATCH_SIZE = 500;\r\n        const totalBatches = Math.ceil(allRecipients.length / BATCH_SIZE);\r\n        let insertedCount = 0;\r\n\r\n        for (let i = 0; i < totalBatches; i++) {\r\n          const batch = allRecipients.slice(i * BATCH_SIZE, (i + 1) * BATCH_SIZE);\r\n\r\n          // Provide feedback\r\n          toast.loading(\r\n            isRTL\r\n              ? `Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†... (${insertedCount}/${allRecipients.length})`\r\n              : `Adding recipients... (${insertedCount}/${allRecipients.length})`,\r\n            { id: 'recipient-progress' }\r\n          );\r\n\r\n          const { error: recipientsError } = await supabase\r\n            .from('campaign_recipients')\r\n            .insert(batch);\r\n\r\n          if (recipientsError) {\r\n            console.error('Recipients insert error (batch ' + i + '):', recipientsError);\r\n            toast.dismiss('recipient-progress');\r\n\r\n            // Mark campaign as failed/draft due to error\r\n            await supabase.from('campaigns').update({ status: 'draft' }).eq('id', campaign.id);\r\n            throw new Error(`Failed to add recipients batch ${i + 1}. Campaign reverted to draft.`);\r\n          }\r\n\r\n          insertedCount += batch.length;\r\n        }\r\n\r\n        toast.dismiss('recipient-progress');\r\n\r\n      }\r\n\r\n      // 3. Create analytics entry\r\n      await supabase.from('campaign_analytics').insert({\r\n        campaign_id: campaign.id,\r\n        company_id: companyId,\r\n        total_recipients: allRecipients.length,\r\n        total_queued: allRecipients.length,\r\n      });\r\n\r\n      // 4. Log campaign creation\r\n      await supabase.from('campaign_logs').insert({\r\n        campaign_id: campaign.id,\r\n        company_id: companyId,\r\n        action: 'Campaign created',\r\n        action_type: 'created',\r\n        details: {\r\n          audience_count: allRecipients.length,\r\n          audience_type: draft.audienceMethod,\r\n          scheduled: !draft.sendNow,\r\n        },\r\n      });\r\n\r\n      // 5. If sending now, trigger the edge function\r\n      if (draft.sendNow && allRecipients.length > 0) {\r\n        const { data: execData, error: execError } = await supabase.functions.invoke('campaign-execute', {\r\n          body: {\r\n            action: 'start',\r\n            campaign_id: campaign.id,\r\n          },\r\n        });\r\n\r\n        if (execError) {\r\n          console.error('Campaign execution error:', execError);\r\n          toast.warning(isRTL\r\n            ? 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø© ÙˆÙ„ÙƒÙ† ÙØ´Ù„ Ø§Ù„Ø¨Ø¯Ø¡. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ù…Ù„Ø§Øª.'\r\n            : 'Campaign created but failed to start. You can retry from the campaigns list.'\r\n          );\r\n        } else {\r\n          const successMsg = execData?.sent\r\n            ? `${execData.sent}/${allRecipients.length}`\r\n            : `${allRecipients.length}`;\r\n          toast.success(isRTL\r\n            ? `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ù…Ù„Ø© Ø¥Ù„Ù‰ ${successMsg} Ù…Ø³ØªÙ„Ù…!`\r\n            : `Campaign sent to ${successMsg} recipients!`\r\n          );\r\n        }\r\n      } else if (!draft.sendNow) {\r\n        toast.success(isRTL\r\n          ? `ØªÙ… Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø­Ù…Ù„Ø© Ù„Ù€ ${allRecipients.length} Ù…Ø³ØªÙ„Ù…`\r\n          : `Campaign scheduled for ${allRecipients.length} recipients`\r\n        );\r\n      } else {\r\n        toast.success(isRTL ? 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­' : 'Campaign created successfully');\r\n      }\r\n\r\n      // Reset form\r\n      setCurrentStep('channel');\r\n      setCompletedSteps([]);\r\n      setDraft({ sendNow: true });\r\n\r\n    } catch (error: any) {\r\n      console.error('Submit error:', error);\r\n      toast.error(isRTL\r\n        ? `ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©: ${error.message}`\r\n        : `Failed to create campaign: ${error.message}`\r\n      );\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  const renderStep = () => {\r\n    switch (currentStep) {\r\n      case 'channel':\r\n        return <ChannelStep selected={draft.channel} onSelect={(c) => setDraft({ ...draft, channel: c })} isRTL={isRTL} />;\r\n      case 'connection':\r\n        return <ConnectionStep channel={draft.channel!} selectedConnectionId={draft.connectionId} onSelect={(id) => setDraft({ ...draft, connectionId: id })} isRTL={isRTL} />;\r\n      case 'type':\r\n        return <CampaignTypeStep selected={draft.type} onSelect={(t) => setDraft({ ...draft, type: t })} isRTL={isRTL} />;\r\n      case 'template':\r\n        return <TemplateStep channel={draft.channel!} selectedTemplateId={draft.templateId} customContent={draft.customContent} onSelectTemplate={(id) => setDraft({ ...draft, templateId: id, customContent: undefined })} onCustomContent={(c) => setDraft({ ...draft, customContent: c, templateId: undefined })} isRTL={isRTL} />;\r\n      case 'audience':\r\n        return (\r\n          <AudienceStep\r\n            selectedLeads={draft.selectedLeads}\r\n            audienceMethod={draft.audienceMethod}\r\n            importedLeads={draft.importedLeads}\r\n            onSelectLeads={(leads) => setDraft({ ...draft, selectedLeads: leads })}\r\n            onFiltersChange={() => { }}\r\n            onAudienceMethodChange={(method) => setDraft({ ...draft, audienceMethod: method })}\r\n            onImportedLeadsChange={(leads) => setDraft({ ...draft, importedLeads: leads })}\r\n            isRTL={isRTL}\r\n          />\r\n        );\r\n      case 'schedule':\r\n        return <ScheduleStep sendNow={draft.sendNow} scheduledDate={draft.scheduledAt} onSendNowChange={(v) => setDraft({ ...draft, sendNow: v })} onScheduledDateChange={(d) => setDraft({ ...draft, scheduledAt: d })} onTimezoneChange={(tz) => setDraft({ ...draft, timezone: tz })} isRTL={isRTL} />;\r\n      case 'review':\r\n        return <ReviewStep draft={draft} isRTL={isRTL} />;\r\n      default:\r\n        return null;\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className={cn(\"flex items-center gap-3\", isRTL && \"flex-row-reverse\")}>\r\n        <div className=\"w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center\">\r\n          <Megaphone className=\"h-5 w-5 text-primary\" />\r\n        </div>\r\n        <div className={isRTL ? \"text-right\" : \"\"}>\r\n          <h1 className=\"text-2xl font-bold\">{isRTL ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø©' : 'Create Campaign'}</h1>\r\n          <p className=\"text-sm text-muted-foreground\">{isRTL ? 'Ø£Ù†Ø´Ø¦ ÙˆØ£Ø±Ø³Ù„ Ø­Ù…Ù„Ø§Øª ØªØ³ÙˆÙŠÙ‚ÙŠØ©' : 'Create and send marketing campaigns'}</p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Step Indicator */}\r\n      <Card>\r\n        <CardContent className=\"p-4\">\r\n          <CampaignStepIndicator currentStep={currentStep} completedSteps={completedSteps} onStepClick={setCurrentStep} isRTL={isRTL} />\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Step Content */}\r\n      <Card className=\"min-h-[400px]\">\r\n        <CardContent className=\"p-6\">\r\n          {renderStep()}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Navigation */}\r\n      <div className={cn(\"flex items-center justify-between\", isRTL && \"flex-row-reverse\")}>\r\n        <Button variant=\"outline\" onClick={handleBack} disabled={isFirstStep}>\r\n          <ArrowLeft className={cn(\"h-4 w-4\", isRTL ? \"ml-2\" : \"mr-2\")} />\r\n          {isRTL ? 'Ø§Ù„Ø³Ø§Ø¨Ù‚' : 'Back'}\r\n        </Button>\r\n        {isLastStep ? (\r\n          <Button onClick={handleSubmit} disabled={isSubmitting || getAudienceCount() === 0} className=\"bg-success hover:bg-success/90\">\r\n            {isSubmitting ? (\r\n              <><span className=\"animate-spin mr-2\">â³</span>{isRTL ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...' : 'Sending...'}</>\r\n            ) : (\r\n              <><Send className=\"h-4 w-4 mr-2\" />{draft.sendNow ? (isRTL ? 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†' : 'Send Now') : (isRTL ? 'Ø¬Ø¯ÙˆÙ„Ø©' : 'Schedule')} ({getAudienceCount()})</>\r\n            )}\r\n          </Button>\r\n        ) : (\r\n          <Button onClick={handleNext} disabled={!canProceed()}>\r\n            {isRTL ? 'Ø§Ù„ØªØ§Ù„ÙŠ' : 'Next'}\r\n            <ArrowRight className={cn(\"h-4 w-4\", isRTL ? \"mr-2\" : \"ml-2\")} />\r\n          </Button>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\CompanyListingDetailPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":177,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":177,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5525,5528],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5525,5528],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { useParams, useNavigate } from \"react-router-dom\";\r\nimport {\r\n  ArrowLeft,\r\n  Share2,\r\n  Heart,\r\n  MapPin,\r\n  Bed,\r\n  Bath,\r\n  Ruler,\r\n  Calendar,\r\n  Eye,\r\n  MessageSquare,\r\n  ChevronLeft,\r\n  ChevronRight,\r\n  X,\r\n  Facebook,\r\n  Twitter,\r\n  Mail,\r\n  Link2,\r\n  Building2,\r\n  FileText,\r\n  Phone,\r\n  History,\r\n  User,\r\n  Loader2,\r\n  Globe,\r\n} from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { toast } from \"sonner\";\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport { generatePropertyPDF } from \"@/lib/generatePropertyPDF\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { format } from \"date-fns\";\r\nimport { PublishToPFDialog } from \"@/components/listings/PublishToPFDialog\";\r\n\r\nconst statusStyles: Record<string, string> = {\r\n  active: \"bg-emerald-100 text-emerald-700 border-emerald-200\",\r\n  draft: \"bg-gray-100 text-gray-700 border-gray-200\",\r\n  pending: \"bg-amber-100 text-amber-700 border-amber-200\",\r\n  rented: \"bg-blue-100 text-blue-700 border-blue-200\",\r\n  sold: \"bg-purple-100 text-purple-700 border-purple-200\",\r\n  off_market: \"bg-gray-100 text-gray-700 border-gray-200\",\r\n};\r\n\r\ninterface ListingDetail {\r\n  id: string;\r\n  title: string;\r\n  description: string | null;\r\n  price: number | null;\r\n  currency: string;\r\n  address: string | null;\r\n  city: string | null;\r\n  country: string | null;\r\n  number_of_bedrooms: number | null;\r\n  number_of_bathrooms: number | null;\r\n  area_size: number | null;\r\n  area_unit: string | null;\r\n  property_type: string | null;\r\n  listing_type: string | null;\r\n  status: string;\r\n  furnished: string | null;\r\n  completion_status: string | null;\r\n  permit_number: string | null;\r\n  reference_number: string | null;\r\n  images: string[] | null;\r\n  amenities: string[] | null;\r\n  tags: string[] | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n  agent: {\r\n    id: string;\r\n    name: string;\r\n    email: string;\r\n    phone: string | null;\r\n    avatar_url: string | null;\r\n  } | null;\r\n  views: number;\r\n  inquiries: number;\r\n}\r\n\r\nexport default function CompanyListingDetailPage() {\r\n  const { id } = useParams();\r\n  const navigate = useNavigate();\r\n  const isMobile = useIsMobile();\r\n  const [listing, setListing] = useState<ListingDetail | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [currentImageIndex, setCurrentImageIndex] = useState(0);\r\n  const [isGalleryOpen, setIsGalleryOpen] = useState(false);\r\n  const [isFavorite, setIsFavorite] = useState(false);\r\n  const [showPublishDialog, setShowPublishDialog] = useState(false);\r\n\r\n  useEffect(() => {\r\n    const fetchListing = async () => {\r\n      if (!id) return;\r\n      \r\n      setIsLoading(true);\r\n      try {\r\n        // Fetch listing with agent info\r\n        const { data, error } = await supabase\r\n          .from(\"listings\")\r\n          .select(`\r\n            *,\r\n            agents!listings_assigned_agent_id_fkey (\r\n              id,\r\n              name,\r\n              email,\r\n              phone,\r\n              avatar_url,\r\n              user_id\r\n            )\r\n          `)\r\n          .eq(\"id\", id)\r\n          .single();\r\n\r\n        if (error) throw error;\r\n\r\n        // Fetch profile name and avatar if agent has user_id\r\n        let agentDisplayName = data.agents?.name || null;\r\n        let agentAvatarUrl = data.agents?.avatar_url || null;\r\n        if (data.agents?.user_id) {\r\n          const { data: profile } = await supabase\r\n            .from(\"profiles\")\r\n            .select(\"first_name, last_name, avatar_url\")\r\n            .eq(\"id\", data.agents.user_id)\r\n            .single();\r\n          \r\n          if (profile) {\r\n            if (profile.first_name || profile.last_name) {\r\n              agentDisplayName = [profile.first_name, profile.last_name].filter(Boolean).join(\" \");\r\n            }\r\n            if (profile.avatar_url) {\r\n              agentAvatarUrl = profile.avatar_url;\r\n            }\r\n          }\r\n        }\r\n\r\n        // Fetch analytics\r\n        const { data: analytics } = await supabase\r\n          .from(\"listing_analytics\")\r\n          .select(\"views_count, inquiries_count\")\r\n          .eq(\"listing_id\", id);\r\n\r\n        const totalViews = analytics?.reduce((sum, a) => sum + (a.views_count || 0), 0) || 0;\r\n        const totalInquiries = analytics?.reduce((sum, a) => sum + (a.inquiries_count || 0), 0) || 0;\r\n\r\n        setListing({\r\n          ...data,\r\n          images: Array.isArray(data.images) ? data.images as string[] : [],\r\n          amenities: Array.isArray(data.amenities) ? data.amenities as string[] : [],\r\n          tags: Array.isArray(data.tags) ? data.tags as string[] : [],\r\n          agent: data.agents ? { \r\n            ...data.agents, \r\n            name: agentDisplayName || data.agents.name,\r\n            avatar_url: agentAvatarUrl || data.agents.avatar_url\r\n          } : null,\r\n          views: totalViews,\r\n          inquiries: totalInquiries,\r\n        });\r\n      } catch (err: any) {\r\n        console.error(\"Error fetching listing:\", err);\r\n        toast.error(\"Failed to load listing\");\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    };\r\n\r\n    fetchListing();\r\n  }, [id]);\r\n\r\n  const images = listing?.images?.length ? listing.images : [\r\n    \"https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=1200&h=800&fit=crop\"\r\n  ];\r\n\r\n  const handlePrevImage = () => {\r\n    setCurrentImageIndex((prev) =>\r\n      prev === 0 ? images.length - 1 : prev - 1\r\n    );\r\n  };\r\n\r\n  const handleNextImage = () => {\r\n    setCurrentImageIndex((prev) =>\r\n      prev === images.length - 1 ? 0 : prev + 1\r\n    );\r\n  };\r\n\r\n  const formatPrice = (price: number | null, currency: string) => {\r\n    if (!price) return \"Price on Request\";\r\n    return `${currency} ${price.toLocaleString()}`;\r\n  };\r\n\r\n  const handleShare = (platform: string) => {\r\n    if (!listing) return;\r\n    \r\n    const url = window.location.href;\r\n    const title = listing.title;\r\n    const priceStr = formatPrice(listing.price, listing.currency);\r\n    const location = [listing.address, listing.city].filter(Boolean).join(\", \");\r\n    const message = `ðŸ  ${title}\\nðŸ’° ${priceStr}\\nðŸ“ ${location}\\nðŸ›ï¸ ${listing.number_of_bedrooms || 0} Beds | ðŸ› ${listing.number_of_bathrooms || 0} Baths | ðŸ“ ${listing.area_size || 0} ${listing.area_unit || 'sqft'}\\n\\nRef: ${listing.reference_number || listing.id.slice(0, 8)}\\n${url}`;\r\n\r\n    switch (platform) {\r\n      case \"copy\":\r\n        navigator.clipboard.writeText(url);\r\n        toast.success(\"Link copied to clipboard!\");\r\n        break;\r\n      case \"whatsapp\":\r\n        window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, \"_blank\");\r\n        break;\r\n      case \"facebook\":\r\n        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, \"_blank\");\r\n        break;\r\n      case \"twitter\":\r\n        window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`, \"_blank\");\r\n        break;\r\n      case \"email\":\r\n        window.open(`mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(message)}`, \"_blank\");\r\n        break;\r\n    }\r\n  };\r\n\r\n  const handleDownloadPDF = async () => {\r\n    if (!listing) return;\r\n    \r\n    toast.loading(\"Generating PDF brochure...\", { id: \"pdf-gen\" });\r\n    try {\r\n      await generatePropertyPDF({\r\n        id: listing.id,\r\n        title: listing.title,\r\n        description: listing.description || \"\",\r\n        price: formatPrice(listing.price, listing.currency),\r\n        pricePerSqft: listing.price && listing.area_size \r\n          ? `${listing.currency} ${Math.round(listing.price / listing.area_size).toLocaleString()}` \r\n          : \"\",\r\n        location: [listing.address, listing.city, listing.country].filter(Boolean).join(\", \"),\r\n        bedrooms: listing.number_of_bedrooms || 0,\r\n        bathrooms: listing.number_of_bathrooms || 0,\r\n        size: `${listing.area_size || 0} ${listing.area_unit || 'sqft'}`,\r\n        type: listing.property_type || \"Property\",\r\n        status: listing.status,\r\n        purpose: listing.listing_type === \"rent\" ? \"For Rent\" : \"For Sale\",\r\n        furnishing: listing.furnished || \"N/A\",\r\n        refNumber: listing.reference_number || listing.id.slice(0, 8),\r\n        permitNumber: listing.permit_number || \"\",\r\n        agent: listing.agent ? {\r\n          name: listing.agent.name,\r\n          phone: listing.agent.phone || \"\",\r\n          email: listing.agent.email,\r\n        } : undefined,\r\n        amenities: listing.amenities || [],\r\n        features: listing.tags || [],\r\n        images: images,\r\n      });\r\n      toast.success(\"PDF generated successfully!\", { id: \"pdf-gen\" });\r\n    } catch (error) {\r\n      toast.error(\"Failed to generate PDF\", { id: \"pdf-gen\" });\r\n    }\r\n  };\r\n\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-[400px]\">\r\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!listing) {\r\n    return (\r\n      <div className=\"flex flex-col items-center justify-center min-h-[400px] gap-4\">\r\n        <p className=\"text-muted-foreground\">Listing not found</p>\r\n        <Button onClick={() => navigate(\"/company-listings\")}>\r\n          Back to Listings\r\n        </Button>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Back Button & Actions */}\r\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\r\n        <Button variant=\"ghost\" onClick={() => navigate(\"/company-listings\")} className=\"gap-2\">\r\n          <ArrowLeft className=\"h-4 w-4\" />\r\n          Back to Company Listings\r\n        </Button>\r\n        <div className=\"flex items-center gap-2 flex-wrap\">\r\n          {/* Share Dropdown */}\r\n          <DropdownMenu>\r\n            <DropdownMenuTrigger asChild>\r\n              <Button variant=\"outline\" size=\"sm\">\r\n                <Share2 className=\"h-4 w-4 mr-2\" />\r\n                Share\r\n              </Button>\r\n            </DropdownMenuTrigger>\r\n            <DropdownMenuContent align=\"end\" className=\"w-48 bg-popover\">\r\n              <DropdownMenuItem onClick={() => handleShare(\"copy\")}>\r\n                <Link2 className=\"h-4 w-4 mr-2\" />\r\n                Copy Link\r\n              </DropdownMenuItem>\r\n              <DropdownMenuItem onClick={() => handleShare(\"whatsapp\")}>\r\n                <MessageSquare className=\"h-4 w-4 mr-2\" />\r\n                WhatsApp\r\n              </DropdownMenuItem>\r\n              <DropdownMenuItem onClick={() => handleShare(\"facebook\")}>\r\n                <Facebook className=\"h-4 w-4 mr-2\" />\r\n                Facebook\r\n              </DropdownMenuItem>\r\n              <DropdownMenuItem onClick={() => handleShare(\"twitter\")}>\r\n                <Twitter className=\"h-4 w-4 mr-2\" />\r\n                Twitter\r\n              </DropdownMenuItem>\r\n              <DropdownMenuItem onClick={() => handleShare(\"email\")}>\r\n                <Mail className=\"h-4 w-4 mr-2\" />\r\n                Email\r\n              </DropdownMenuItem>\r\n            </DropdownMenuContent>\r\n          </DropdownMenu>\r\n\r\n          <Button variant=\"outline\" size=\"sm\" onClick={handleDownloadPDF}>\r\n            <FileText className=\"h-4 w-4 mr-2\" />\r\n            PDF\r\n          </Button>\r\n\r\n          <Button\r\n            variant=\"default\"\r\n            size=\"sm\"\r\n            onClick={() => setShowPublishDialog(true)}\r\n            className=\"bg-gradient-to-r from-primary to-primary/80\"\r\n          >\r\n            <Globe className=\"h-4 w-4 mr-2\" />\r\n            Publish to PF\r\n          </Button>\r\n\r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            onClick={() => setIsFavorite(!isFavorite)}\r\n          >\r\n            <Heart className={cn(\"h-4 w-4\", isFavorite && \"fill-red-500 text-red-500\")} />\r\n          </Button>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n        {/* Main Content */}\r\n        <div className=\"lg:col-span-2 space-y-6\">\r\n          {/* Image Gallery */}\r\n          <Card className=\"shadow-card overflow-hidden\">\r\n            <div className=\"relative\">\r\n              <div\r\n                className=\"relative aspect-[16/10] cursor-pointer group\"\r\n                onClick={() => setIsGalleryOpen(true)}\r\n              >\r\n                <img\r\n                  src={images[currentImageIndex]}\r\n                  alt={listing.title}\r\n                  className=\"w-full h-full object-cover\"\r\n                />\r\n                <div className=\"absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors flex items-center justify-center\">\r\n                  <span className=\"opacity-0 group-hover:opacity-100 text-white font-medium transition-opacity\">\r\n                    Click to view gallery\r\n                  </span>\r\n                </div>\r\n\r\n                <Button\r\n                  variant=\"secondary\"\r\n                  size=\"icon\"\r\n                  className=\"absolute left-4 top-1/2 -translate-y-1/2 h-10 w-10 rounded-full opacity-0 group-hover:opacity-100 transition-opacity\"\r\n                  onClick={(e) => { e.stopPropagation(); handlePrevImage(); }}\r\n                >\r\n                  <ChevronLeft className=\"h-5 w-5\" />\r\n                </Button>\r\n                <Button\r\n                  variant=\"secondary\"\r\n                  size=\"icon\"\r\n                  className=\"absolute right-4 top-1/2 -translate-y-1/2 h-10 w-10 rounded-full opacity-0 group-hover:opacity-100 transition-opacity\"\r\n                  onClick={(e) => { e.stopPropagation(); handleNextImage(); }}\r\n                >\r\n                  <ChevronRight className=\"h-5 w-5\" />\r\n                </Button>\r\n\r\n                <div className=\"absolute bottom-4 right-4 bg-black/60 text-white text-sm px-3 py-1 rounded-full\">\r\n                  {currentImageIndex + 1} / {images.length}\r\n                </div>\r\n              </div>\r\n\r\n              {images.length > 1 && (\r\n                <div className=\"p-3 bg-secondary/30\">\r\n                  <div className=\"flex gap-2 overflow-x-auto scrollbar-thin\">\r\n                    {images.map((image, index) => (\r\n                      <button\r\n                        key={index}\r\n                        onClick={() => setCurrentImageIndex(index)}\r\n                        className={cn(\r\n                          \"flex-shrink-0 w-20 h-14 rounded-lg overflow-hidden border-2 transition-all\",\r\n                          currentImageIndex === index\r\n                            ? \"border-primary ring-2 ring-primary/20\"\r\n                            : \"border-transparent hover:border-primary/50\"\r\n                        )}\r\n                      >\r\n                        <img\r\n                          src={image}\r\n                          alt={`Thumbnail ${index + 1}`}\r\n                          className=\"w-full h-full object-cover\"\r\n                        />\r\n                      </button>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </Card>\r\n\r\n          {/* Property Details */}\r\n          <Card className=\"shadow-card\">\r\n            <CardHeader>\r\n              <div className=\"flex items-start justify-between flex-wrap gap-4\">\r\n                <div>\r\n                  <div className=\"flex items-center gap-2 mb-1\">\r\n                    <Badge variant=\"secondary\" className=\"text-xs\">\r\n                      Ref: {listing.reference_number || listing.id.slice(0, 8)}\r\n                    </Badge>\r\n                    <Badge className={cn(\"border\", statusStyles[listing.status] || statusStyles.draft)}>\r\n                      {listing.status.replace(\"_\", \" \")}\r\n                    </Badge>\r\n                  </div>\r\n                  <CardTitle className=\"text-xl\">{listing.title}</CardTitle>\r\n                  <p className=\"text-muted-foreground flex items-center gap-1 mt-1\">\r\n                    <MapPin className=\"h-4 w-4\" />\r\n                    {[listing.address, listing.city, listing.country].filter(Boolean).join(\", \") || \"Location not specified\"}\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-6\">\r\n              <div>\r\n                <p className=\"text-3xl font-bold text-primary\">\r\n                  {formatPrice(listing.price, listing.currency)}\r\n                </p>\r\n                {listing.price && listing.area_size && (\r\n                  <p className=\"text-sm text-muted-foreground\">\r\n                    {listing.currency} {Math.round(listing.price / listing.area_size).toLocaleString()} per {listing.area_unit || 'sqft'}\r\n                  </p>\r\n                )}\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-4\">\r\n                <div className=\"flex items-center gap-2 p-3 bg-secondary/30 rounded-lg\">\r\n                  <Bed className=\"h-5 w-5 text-muted-foreground\" />\r\n                  <div>\r\n                    <p className=\"text-sm font-medium\">{listing.number_of_bedrooms || 0}</p>\r\n                    <p className=\"text-xs text-muted-foreground\">Bedrooms</p>\r\n                  </div>\r\n                </div>\r\n                <div className=\"flex items-center gap-2 p-3 bg-secondary/30 rounded-lg\">\r\n                  <Bath className=\"h-5 w-5 text-muted-foreground\" />\r\n                  <div>\r\n                    <p className=\"text-sm font-medium\">{listing.number_of_bathrooms || 0}</p>\r\n                    <p className=\"text-xs text-muted-foreground\">Bathrooms</p>\r\n                  </div>\r\n                </div>\r\n                <div className=\"flex items-center gap-2 p-3 bg-secondary/30 rounded-lg\">\r\n                  <Ruler className=\"h-5 w-5 text-muted-foreground\" />\r\n                  <div>\r\n                    <p className=\"text-sm font-medium\">{listing.area_size || 0} {listing.area_unit || 'sqft'}</p>\r\n                    <p className=\"text-xs text-muted-foreground\">Area</p>\r\n                  </div>\r\n                </div>\r\n                <div className=\"flex items-center gap-2 p-3 bg-secondary/30 rounded-lg\">\r\n                  <Building2 className=\"h-5 w-5 text-muted-foreground\" />\r\n                  <div>\r\n                    <p className=\"text-sm font-medium capitalize\">{listing.property_type || 'N/A'}</p>\r\n                    <p className=\"text-xs text-muted-foreground\">Type</p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <Separator />\r\n\r\n              {listing.description && (\r\n                <>\r\n                  <div>\r\n                    <h3 className=\"font-semibold mb-2\">Description</h3>\r\n                    <p className=\"text-muted-foreground text-sm leading-relaxed\">\r\n                      {listing.description}\r\n                    </p>\r\n                  </div>\r\n                  <Separator />\r\n                </>\r\n              )}\r\n\r\n              <div>\r\n                <h3 className=\"font-semibold mb-3\">Property Information</h3>\r\n                <div className=\"grid grid-cols-2 gap-4 text-sm\">\r\n                  <div className=\"flex justify-between\">\r\n                    <span className=\"text-muted-foreground\">Purpose</span>\r\n                    <span className=\"font-medium\">{listing.listing_type === \"rent\" ? \"For Rent\" : \"For Sale\"}</span>\r\n                  </div>\r\n                  <div className=\"flex justify-between\">\r\n                    <span className=\"text-muted-foreground\">Furnishing</span>\r\n                    <span className=\"font-medium capitalize\">{listing.furnished || \"N/A\"}</span>\r\n                  </div>\r\n                  <div className=\"flex justify-between\">\r\n                    <span className=\"text-muted-foreground\">Completion</span>\r\n                    <span className=\"font-medium capitalize\">{listing.completion_status || \"N/A\"}</span>\r\n                  </div>\r\n                  {listing.permit_number && (\r\n                    <div className=\"flex justify-between\">\r\n                      <span className=\"text-muted-foreground\">Permit No.</span>\r\n                      <span className=\"font-medium\">{listing.permit_number}</span>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              {listing.amenities && listing.amenities.length > 0 && (\r\n                <>\r\n                  <Separator />\r\n                  <div>\r\n                    <h3 className=\"font-semibold mb-3\">Amenities</h3>\r\n                    <div className=\"flex flex-wrap gap-2\">\r\n                      {listing.amenities.map((amenity) => (\r\n                        <Badge key={amenity} variant=\"secondary\" className=\"font-normal\">\r\n                          {amenity}\r\n                        </Badge>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                </>\r\n              )}\r\n\r\n              {listing.tags && listing.tags.length > 0 && (\r\n                <div>\r\n                  <h3 className=\"font-semibold mb-3\">Features</h3>\r\n                  <div className=\"flex flex-wrap gap-2\">\r\n                    {listing.tags.map((feature) => (\r\n                      <Badge key={feature} variant=\"outline\" className=\"font-normal\">\r\n                        {feature}\r\n                      </Badge>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        {/* Sidebar */}\r\n        <div className=\"space-y-6\">\r\n          {/* Stats Card */}\r\n          <Card className=\"shadow-card\">\r\n            <CardContent className=\"pt-6\">\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <div className=\"text-center p-3 bg-secondary/30 rounded-lg\">\r\n                  <Eye className=\"h-5 w-5 mx-auto mb-1 text-muted-foreground\" />\r\n                  <p className=\"text-lg font-semibold\">{listing.views}</p>\r\n                  <p className=\"text-xs text-muted-foreground\">Views</p>\r\n                </div>\r\n                <div className=\"text-center p-3 bg-secondary/30 rounded-lg\">\r\n                  <MessageSquare className=\"h-5 w-5 mx-auto mb-1 text-muted-foreground\" />\r\n                  <p className=\"text-lg font-semibold\">{listing.inquiries}</p>\r\n                  <p className=\"text-xs text-muted-foreground\">Inquiries</p>\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Agent Card */}\r\n          {listing.agent && (\r\n            <Card className=\"shadow-card\">\r\n              <CardHeader>\r\n                <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\r\n                  <User className=\"h-4 w-4\" />\r\n                  Listed By\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <div className=\"flex items-center gap-3 mb-4\">\r\n                  <Avatar className=\"h-14 w-14\">\r\n                    <AvatarImage src={listing.agent.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${listing.agent.name}`} />\r\n                    <AvatarFallback>{listing.agent.name.split(\" \").map(n => n[0]).join(\"\")}</AvatarFallback>\r\n                  </Avatar>\r\n                  <div>\r\n                    <p className=\"font-semibold\">{listing.agent.name}</p>\r\n                    <p className=\"text-sm text-muted-foreground\">Listing Agent</p>\r\n                  </div>\r\n                </div>\r\n                <div className=\"space-y-3\">\r\n                  {listing.agent.phone && (\r\n                    <Button variant=\"outline\" className=\"w-full justify-start gap-2\" asChild>\r\n                      <a href={`tel:${listing.agent.phone}`}>\r\n                        <Phone className=\"h-4 w-4\" />\r\n                        {listing.agent.phone}\r\n                      </a>\r\n                    </Button>\r\n                  )}\r\n                  <Button variant=\"outline\" className=\"w-full justify-start gap-2\" asChild>\r\n                    <a href={`mailto:${listing.agent.email}`}>\r\n                      <Mail className=\"h-4 w-4\" />\r\n                      {listing.agent.email}\r\n                    </a>\r\n                  </Button>\r\n                  <Button\r\n                    className=\"w-full gap-2 bg-emerald-600 hover:bg-emerald-700\"\r\n                    onClick={() => handleShare(\"whatsapp\")}\r\n                  >\r\n                    <MessageSquare className=\"h-4 w-4\" />\r\n                    WhatsApp Agent\r\n                  </Button>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          )}\r\n\r\n          {/* Dates */}\r\n          <Card className=\"shadow-card\">\r\n            <CardContent className=\"pt-6\">\r\n              <div className=\"space-y-3 text-sm\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <span className=\"text-muted-foreground flex items-center gap-2\">\r\n                    <Calendar className=\"h-4 w-4\" />\r\n                    Created\r\n                  </span>\r\n                  <span className=\"font-medium\">\r\n                    {format(new Date(listing.created_at), \"MMM d, yyyy\")}\r\n                  </span>\r\n                </div>\r\n                <div className=\"flex items-center justify-between\">\r\n                  <span className=\"text-muted-foreground flex items-center gap-2\">\r\n                    <History className=\"h-4 w-4\" />\r\n                    Updated\r\n                  </span>\r\n                  <span className=\"font-medium\">\r\n                    {format(new Date(listing.updated_at), \"MMM d, yyyy\")}\r\n                  </span>\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Gallery Modal */}\r\n      <Dialog open={isGalleryOpen} onOpenChange={setIsGalleryOpen}>\r\n        <DialogContent className=\"max-w-5xl p-0 bg-black/95\">\r\n          <DialogHeader className=\"absolute top-4 left-4 right-4 z-10\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <DialogTitle className=\"text-white\">{listing.title}</DialogTitle>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"icon\"\r\n                className=\"text-white hover:bg-white/20\"\r\n                onClick={() => setIsGalleryOpen(false)}\r\n              >\r\n                <X className=\"h-5 w-5\" />\r\n              </Button>\r\n            </div>\r\n          </DialogHeader>\r\n          <div className=\"relative aspect-[16/10]\">\r\n            <img\r\n              src={images[currentImageIndex]}\r\n              alt={`${listing.title} - Image ${currentImageIndex + 1}`}\r\n              className=\"w-full h-full object-contain\"\r\n            />\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              className=\"absolute left-4 top-1/2 -translate-y-1/2 h-12 w-12 rounded-full bg-white/10 hover:bg-white/20 text-white\"\r\n              onClick={handlePrevImage}\r\n            >\r\n              <ChevronLeft className=\"h-6 w-6\" />\r\n            </Button>\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              className=\"absolute right-4 top-1/2 -translate-y-1/2 h-12 w-12 rounded-full bg-white/10 hover:bg-white/20 text-white\"\r\n              onClick={handleNextImage}\r\n            >\r\n              <ChevronRight className=\"h-6 w-6\" />\r\n            </Button>\r\n            <div className=\"absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2\">\r\n              {images.map((_, index) => (\r\n                <button\r\n                  key={index}\r\n                  onClick={() => setCurrentImageIndex(index)}\r\n                  className={cn(\r\n                    \"w-2 h-2 rounded-full transition-all\",\r\n                    currentImageIndex === index ? \"bg-white w-6\" : \"bg-white/50\"\r\n                  )}\r\n                />\r\n              ))}\r\n            </div>\r\n          </div>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Publish to Property Finder Dialog */}\r\n      <PublishToPFDialog\r\n        open={showPublishDialog}\r\n        onOpenChange={setShowPublishDialog}\r\n        listing={{\r\n          id: listing.id,\r\n          title: listing.title,\r\n          reference_number: listing.reference_number || undefined,\r\n        }}\r\n        onSuccess={() => {\r\n          // Optionally refresh listing data\r\n        }}\r\n      />\r\n\r\n      {/* Mobile Bottom Actions */}\r\n      {isMobile && (\r\n        <div className=\"fixed bottom-0 left-0 right-0 bg-background border-t p-4 flex gap-2 z-50\">\r\n          <Button \r\n            className=\"flex-1 gap-2 bg-gradient-to-r from-primary to-primary/80\" \r\n            onClick={() => setShowPublishDialog(true)}\r\n          >\r\n            <Globe className=\"h-4 w-4\" />\r\n            Publish\r\n          </Button>\r\n          <Button variant=\"outline\" className=\"flex-1 gap-2\" onClick={() => handleShare(\"whatsapp\")}>\r\n            <MessageSquare className=\"h-4 w-4\" />\r\n            Share\r\n          </Button>\r\n          <Button variant=\"outline\" size=\"icon\" onClick={handleDownloadPDF}>\r\n            <FileText className=\"h-4 w-4\" />\r\n          </Button>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\CompanyListingsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\ConnectionsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":270,"column":7,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":270,"endColumn":28},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'whatsApp.connections'. Either include it or remove the dependency array.","line":276,"column":6,"nodeType":"ArrayExpression","endLine":276,"endColumn":44,"suggestions":[{"desc":"Update the dependencies array to be: [searchParams, setSearchParams, isRTL, whatsApp.connections]","fix":{"range":[13109,13147],"text":"[searchParams, setSearchParams, isRTL, whatsApp.connections]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":397,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":397,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17027,17030],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17027,17030],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":407,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":407,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17489,17492],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17489,17492],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":417,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":417,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17925,17928],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17925,17928],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { useSearchParams } from 'react-router-dom';\r\nimport { motion } from 'framer-motion';\r\nimport { \r\n  Phone, Mail, MessageSquare, Plus, Check, X, AlertCircle, \r\n  RefreshCw, Trash2, Settings2, ExternalLink, Plug, Activity,\r\n  Shield, Clock, Zap, CheckCircle2, XCircle, AlertTriangle\r\n} from 'lucide-react';\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Progress } from '@/components/ui/progress';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogDescription,\r\n} from '@/components/ui/dialog';\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select';\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n  AlertDialogTrigger,\r\n} from '@/components/ui/alert-dialog';\r\nimport {\r\n  Alert,\r\n  AlertDescription,\r\n  AlertTitle,\r\n} from '@/components/ui/alert';\r\nimport { useWhatsAppConnection } from '@/contexts/WhatsAppConnectionContext';\r\nimport { useEmailConnection } from '@/contexts/EmailConnectionContext';\r\nimport { useSMSConnection } from '@/contexts/SMSConnectionContext';\r\nimport { useLanguageSafe } from '@/contexts/LanguageContext';\r\nimport { useConnectionHealth } from '@/hooks/useConnectionHealth';\r\nimport { ConnectionsPageSkeleton } from '@/components/ui/page-skeletons';\r\nimport { useIsMobile } from '@/hooks/use-mobile';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { toast } from 'sonner';\r\nimport { cn } from '@/lib/utils';\r\n\r\nconst pageVariants = {\r\n  initial: { opacity: 0, y: 20 },\r\n  animate: { opacity: 1, y: 0 },\r\n  exit: { opacity: 0, y: -10 }\r\n};\r\n\r\nconst pageTransition = {\r\n  type: \"tween\" as const,\r\n  ease: \"easeOut\" as const,\r\n  duration: 0.3\r\n};\r\n\r\ntype ChannelType = 'whatsapp' | 'email' | 'sms';\r\n\r\ninterface ProviderConfig {\r\n  value: string;\r\n  label: string;\r\n  icon: string;\r\n  fields: { key: string; label: string; labelAr: string; type: string; placeholder: string; required: boolean }[];\r\n  connectUrl?: string;\r\n  instructions: string;\r\n  instructionsAr: string;\r\n}\r\n\r\nconst PROVIDER_CONFIGS: Record<ChannelType, ProviderConfig[]> = {\r\n  whatsapp: [\r\n    {\r\n      value: 'meta',\r\n      label: 'WhatsApp Cloud API (Official)',\r\n      icon: 'ðŸ“±',\r\n      fields: [], // No manual fields - OAuth handles everything\r\n      connectUrl: '',\r\n      instructions: 'Connect your WhatsApp Business number instantly via Meta. Click \"Connect with Meta\" to authorize.',\r\n      instructionsAr: 'Ø§Ø±Ø¨Ø· Ø±Ù‚Ù… WhatsApp Business Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙÙˆØ±Ø§Ù‹ Ø¹Ø¨Ø± Meta. Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ \"Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ø¨Ø± Meta\" Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø©.',\r\n    },\r\n    {\r\n      value: 'twilio',\r\n      label: 'Twilio',\r\n      icon: 'ðŸ”´',\r\n      fields: [\r\n        { key: 'accountSid', label: 'Account SID', labelAr: 'Ù…Ø¹Ø±Ù Ø§Ù„Ø­Ø³Ø§Ø¨', type: 'text', placeholder: 'ACxxxxxxx...', required: true },\r\n        { key: 'authToken', label: 'Auth Token', labelAr: 'Ø±Ù…Ø² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', type: 'password', placeholder: 'xxxxxxx...', required: true },\r\n        { key: 'phoneNumber', label: 'WhatsApp Number', labelAr: 'Ø±Ù‚Ù… WhatsApp', type: 'tel', placeholder: '+14155238886', required: true },\r\n      ],\r\n      connectUrl: 'https://console.twilio.com/',\r\n      instructions: 'Get your Account SID and Auth Token from Twilio Console. Enable WhatsApp sandbox or connect your own number.',\r\n      instructionsAr: 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ±Ù…Ø² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ù† Ù„ÙˆØ­Ø© Twilio. ÙØ¹Ù‘Ù„ Ø¨ÙŠØ¦Ø© WhatsApp Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø£Ùˆ Ø§Ø±Ø¨Ø· Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø®Ø§Øµ.',\r\n    },\r\n    {\r\n      value: '360dialog',\r\n      label: '360dialog',\r\n      icon: 'ðŸ”µ',\r\n      fields: [\r\n        { key: 'apiKey', label: 'API Key', labelAr: 'Ù…ÙØªØ§Ø­ API', type: 'password', placeholder: 'xxxxxxx...', required: true },\r\n        { key: 'phoneNumber', label: 'Phone Number', labelAr: 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', type: 'tel', placeholder: '+971 50 123 4567', required: true },\r\n      ],\r\n      connectUrl: 'https://hub.360dialog.com/',\r\n      instructions: 'Get your API key from 360dialog Hub after connecting your WhatsApp Business number.',\r\n      instructionsAr: 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ API Ù…Ù† 360dialog Hub Ø¨Ø¹Ø¯ Ø±Ø¨Ø· Ø±Ù‚Ù… WhatsApp Business Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ.',\r\n    },\r\n    {\r\n      value: 'vonage',\r\n      label: 'Vonage',\r\n      icon: 'ðŸŸ£',\r\n      fields: [\r\n        { key: 'apiKey', label: 'API Key', labelAr: 'Ù…ÙØªØ§Ø­ API', type: 'text', placeholder: 'xxxxxxx', required: true },\r\n        { key: 'apiSecret', label: 'API Secret', labelAr: 'Ø³Ø± API', type: 'password', placeholder: 'xxxxxxx...', required: true },\r\n        { key: 'phoneNumber', label: 'Phone Number', labelAr: 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', type: 'tel', placeholder: '+971 50 123 4567', required: true },\r\n      ],\r\n      connectUrl: 'https://dashboard.nexmo.com/',\r\n      instructions: 'Get your API credentials from Vonage Dashboard and configure WhatsApp in Messages API.',\r\n      instructionsAr: 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª API Ù…Ù† Ù„ÙˆØ­Ø© Vonage ÙˆÙ‚Ù… Ø¨ØªÙƒÙˆÙŠÙ† WhatsApp ÙÙŠ Messages API.',\r\n    },\r\n  ],\r\n  email: [\r\n    {\r\n      value: 'resend',\r\n      label: 'Resend',\r\n      icon: 'ðŸ“§',\r\n      fields: [\r\n        { key: 'apiKey', label: 'API Key', labelAr: 'Ù…ÙØªØ§Ø­ API', type: 'password', placeholder: 're_xxxxxxx...', required: true },\r\n        { key: 'email', label: 'Sender Email', labelAr: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø±Ø³Ù„', type: 'email', placeholder: 'campaigns@yourcompany.com', required: true },\r\n        { key: 'domain', label: 'Verified Domain', labelAr: 'Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…ÙØªØ­Ù‚Ù‚ Ù…Ù†Ù‡', type: 'text', placeholder: 'yourcompany.com', required: true },\r\n      ],\r\n      connectUrl: 'https://resend.com/api-keys',\r\n      instructions: 'Create an API key at resend.com/api-keys and verify your domain at resend.com/domains.',\r\n      instructionsAr: 'Ø£Ù†Ø´Ø¦ Ù…ÙØªØ§Ø­ API ÙÙŠ resend.com/api-keys ÙˆØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø·Ø§Ù‚Ùƒ ÙÙŠ resend.com/domains.',\r\n    },\r\n    {\r\n      value: 'sendgrid',\r\n      label: 'SendGrid',\r\n      icon: 'ðŸ’™',\r\n      fields: [\r\n        { key: 'apiKey', label: 'API Key', labelAr: 'Ù…ÙØªØ§Ø­ API', type: 'password', placeholder: 'SG.xxxxxxx...', required: true },\r\n        { key: 'email', label: 'Sender Email', labelAr: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø±Ø³Ù„', type: 'email', placeholder: 'campaigns@yourcompany.com', required: true },\r\n      ],\r\n      connectUrl: 'https://app.sendgrid.com/settings/api_keys',\r\n      instructions: 'Generate an API key with Mail Send permissions and verify your sender identity.',\r\n      instructionsAr: 'Ø£Ù†Ø´Ø¦ Ù…ÙØªØ§Ø­ API Ù…Ø¹ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø±Ø³Ù„.',\r\n    },\r\n    {\r\n      value: 'mailgun',\r\n      label: 'Mailgun',\r\n      icon: 'ðŸ“¬',\r\n      fields: [\r\n        { key: 'apiKey', label: 'API Key', labelAr: 'Ù…ÙØªØ§Ø­ API', type: 'password', placeholder: 'key-xxxxxxx...', required: true },\r\n        { key: 'domain', label: 'Domain', labelAr: 'Ø§Ù„Ù†Ø·Ø§Ù‚', type: 'text', placeholder: 'mg.yourcompany.com', required: true },\r\n        { key: 'email', label: 'Sender Email', labelAr: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø±Ø³Ù„', type: 'email', placeholder: 'campaigns@mg.yourcompany.com', required: true },\r\n      ],\r\n      connectUrl: 'https://app.mailgun.com/app/account/security/api_keys',\r\n      instructions: 'Get your API key from Mailgun and add your sending domain.',\r\n      instructionsAr: 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ API Ù…Ù† Mailgun ÙˆØ£Ø¶Ù Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ.',\r\n    },\r\n    {\r\n      value: 'ses',\r\n      label: 'Amazon SES',\r\n      icon: 'â˜ï¸',\r\n      fields: [\r\n        { key: 'accessKeyId', label: 'Access Key ID', labelAr: 'Ù…Ø¹Ø±Ù Ù…ÙØªØ§Ø­ Ø§Ù„ÙˆØµÙˆÙ„', type: 'text', placeholder: 'AKIAxxxxxxx...', required: true },\r\n        { key: 'secretAccessKey', label: 'Secret Access Key', labelAr: 'Ù…ÙØªØ§Ø­ Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠ', type: 'password', placeholder: 'xxxxxxx...', required: true },\r\n        { key: 'region', label: 'Region', labelAr: 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', type: 'text', placeholder: 'us-east-1', required: true },\r\n        { key: 'email', label: 'Verified Email', labelAr: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…ÙØªØ­Ù‚Ù‚ Ù…Ù†Ù‡', type: 'email', placeholder: 'campaigns@yourcompany.com', required: true },\r\n      ],\r\n      connectUrl: 'https://console.aws.amazon.com/ses/',\r\n      instructions: 'Create IAM credentials with SES permissions and verify your email/domain in SES console.',\r\n      instructionsAr: 'Ø£Ù†Ø´Ø¦ Ø¨ÙŠØ§Ù†Ø§Øª IAM Ù…Ø¹ ØµÙ„Ø§Ø­ÙŠØ§Øª SES ÙˆØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ/Ù†Ø·Ø§Ù‚Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© SES.',\r\n    },\r\n  ],\r\n  sms: [\r\n    {\r\n      value: 'twilio',\r\n      label: 'Twilio',\r\n      icon: 'ðŸ”´',\r\n      fields: [\r\n        { key: 'accountSid', label: 'Account SID', labelAr: 'Ù…Ø¹Ø±Ù Ø§Ù„Ø­Ø³Ø§Ø¨', type: 'text', placeholder: 'ACxxxxxxx...', required: true },\r\n        { key: 'authToken', label: 'Auth Token', labelAr: 'Ø±Ù…Ø² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', type: 'password', placeholder: 'xxxxxxx...', required: true },\r\n        { key: 'phoneNumber', label: 'Phone Number', labelAr: 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', type: 'tel', placeholder: '+14155238886', required: true },\r\n      ],\r\n      connectUrl: 'https://console.twilio.com/',\r\n      instructions: 'Get your Account SID and Auth Token from Twilio Console, then purchase or port a phone number.',\r\n      instructionsAr: 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ±Ù…Ø² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ù† Ù„ÙˆØ­Ø© TwilioØŒ Ø«Ù… Ø§Ø´ØªØ±Ù Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù†Ù‚Ù„Ù‡.',\r\n    },\r\n    {\r\n      value: 'messagebird',\r\n      label: 'MessageBird',\r\n      icon: 'ðŸ¦',\r\n      fields: [\r\n        { key: 'apiKey', label: 'API Key', labelAr: 'Ù…ÙØªØ§Ø­ API', type: 'password', placeholder: 'xxxxxxx...', required: true },\r\n        { key: 'phoneNumber', label: 'Phone Number', labelAr: 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', type: 'tel', placeholder: '+31612345678', required: true },\r\n      ],\r\n      connectUrl: 'https://dashboard.messagebird.com/en/developers/access',\r\n      instructions: 'Generate an API key and purchase a virtual mobile number from MessageBird.',\r\n      instructionsAr: 'Ø£Ù†Ø´Ø¦ Ù…ÙØªØ§Ø­ API ÙˆØ§Ø´ØªØ±Ù Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ù† MessageBird.',\r\n    },\r\n    {\r\n      value: 'vonage',\r\n      label: 'Vonage',\r\n      icon: 'ðŸŸ£',\r\n      fields: [\r\n        { key: 'apiKey', label: 'API Key', labelAr: 'Ù…ÙØªØ§Ø­ API', type: 'text', placeholder: 'xxxxxxx', required: true },\r\n        { key: 'apiSecret', label: 'API Secret', labelAr: 'Ø³Ø± API', type: 'password', placeholder: 'xxxxxxx...', required: true },\r\n        { key: 'phoneNumber', label: 'Phone Number', labelAr: 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', type: 'tel', placeholder: '+14155238886', required: true },\r\n      ],\r\n      connectUrl: 'https://dashboard.nexmo.com/',\r\n      instructions: 'Get your API credentials from Vonage Dashboard and purchase a virtual number.',\r\n      instructionsAr: 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª API Ù…Ù† Ù„ÙˆØ­Ø© Vonage ÙˆØ§Ø´ØªØ±Ù Ø±Ù‚Ù…Ø§Ù‹ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹.',\r\n    },\r\n    {\r\n      value: 'plivo',\r\n      label: 'Plivo',\r\n      icon: 'ðŸŸ¢',\r\n      fields: [\r\n        { key: 'authId', label: 'Auth ID', labelAr: 'Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', type: 'text', placeholder: 'MAxxxxxxx...', required: true },\r\n        { key: 'authToken', label: 'Auth Token', labelAr: 'Ø±Ù…Ø² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', type: 'password', placeholder: 'xxxxxxx...', required: true },\r\n        { key: 'phoneNumber', label: 'Phone Number', labelAr: 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', type: 'tel', placeholder: '+14155238886', required: true },\r\n      ],\r\n      connectUrl: 'https://console.plivo.com/',\r\n      instructions: 'Get your Auth ID and Token from Plivo Console and rent a phone number.',\r\n      instructionsAr: 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù ÙˆÙˆØ±Ù…Ø² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ù† Ù„ÙˆØ­Ø© Plivo ÙˆØ§Ø³ØªØ£Ø¬Ø± Ø±Ù‚Ù… Ù‡Ø§ØªÙ.',\r\n    },\r\n  ],\r\n};\r\n\r\nexport default function ConnectionsPage() {\r\n  const { isRTL } = useLanguageSafe();\r\n  const isMobile = useIsMobile();\r\n  const { profile } = useAuth();\r\n  const [searchParams, setSearchParams] = useSearchParams();\r\n  const whatsApp = useWhatsAppConnection();\r\n  const email = useEmailConnection();\r\n  const sms = useSMSConnection();\r\n  const { checkAllConnections, getHealthSummary } = useConnectionHealth();\r\n  \r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [activeTab, setActiveTab] = useState<ChannelType>('whatsapp');\r\n  const [showAddDialog, setShowAddDialog] = useState(false);\r\n  const [selectedProvider, setSelectedProvider] = useState('');\r\n  const [connecting, setConnecting] = useState(false);\r\n  const [formData, setFormData] = useState<Record<string, string>>({});\r\n  const [healthSummary, setHealthSummary] = useState(getHealthSummary());\r\n  const [lastHealthCheck, setLastHealthCheck] = useState<Date | null>(null);\r\n  const [oauthLoading, setOauthLoading] = useState(false);\r\n\r\n  // Handle OAuth callback\r\n  useEffect(() => {\r\n    const success = searchParams.get('success');\r\n    const error = searchParams.get('error');\r\n    const connectionId = searchParams.get('connection_id');\r\n\r\n    if (success === 'true' && connectionId) {\r\n      toast.success(isRTL ? 'ØªÙ… Ø±Ø¨Ø· WhatsApp Ø¨Ù†Ø¬Ø§Ø­!' : 'WhatsApp connected successfully!');\r\n      // Refresh connections\r\n      whatsApp.connections; // Trigger refetch\r\n      setSearchParams({});\r\n    } else if (error) {\r\n      toast.error(isRTL ? `ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ${error}` : `Connection failed: ${error}`);\r\n      setSearchParams({});\r\n    }\r\n  }, [searchParams, setSearchParams, isRTL]);\r\n\r\n  useEffect(() => {\r\n    const timer = setTimeout(() => setIsLoading(false), 600);\r\n    return () => clearTimeout(timer);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    setHealthSummary(getHealthSummary());\r\n  }, [whatsApp.connections, email.connections, sms.connections, getHealthSummary]);\r\n\r\n  if (isLoading) {\r\n    return <ConnectionsPageSkeleton isMobile={isMobile} />;\r\n  }\r\n\r\n  const runHealthCheck = async () => {\r\n    toast.info(isRTL ? 'Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª...' : 'Checking connections...');\r\n    await checkAllConnections();\r\n    setHealthSummary(getHealthSummary());\r\n    setLastHealthCheck(new Date());\r\n    toast.success(isRTL ? 'ØªÙ… ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª' : 'All connections checked');\r\n  };\r\n\r\n  const resetForm = () => {\r\n    setFormData({});\r\n    setSelectedProvider('');\r\n  };\r\n\r\n  const getProviderConfig = (channel: ChannelType, provider: string) => {\r\n    return PROVIDER_CONFIGS[channel].find(p => p.value === provider);\r\n  };\r\n\r\n  const getProviderOptions = (channel: ChannelType) => {\r\n    return PROVIDER_CONFIGS[channel].map(p => ({\r\n      value: p.value,\r\n      label: p.label,\r\n      icon: p.icon,\r\n    }));\r\n  };\r\n\r\n  // WhatsApp Meta OAuth Connect\r\n  const handleMetaOAuthConnect = async () => {\r\n    if (!profile?.company_id) {\r\n      toast.error(isRTL ? 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹' : 'Please log in first');\r\n      return;\r\n    }\r\n\r\n    setOauthLoading(true);\r\n    try {\r\n      const redirectUri = `${window.location.origin}/connections`;\r\n      \r\n      const { data, error } = await supabase.functions.invoke('whatsapp-embedded-signup', {\r\n        body: {\r\n          company_id: profile.company_id,\r\n          redirect_uri: redirectUri,\r\n        },\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      if (data?.authUrl) {\r\n        // Redirect to Meta OAuth\r\n        window.location.href = data.authUrl;\r\n      } else {\r\n        throw new Error('No auth URL received');\r\n      }\r\n    } catch (error) {\r\n      console.error('OAuth error:', error);\r\n      toast.error(isRTL ? 'ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„' : 'Failed to start connection');\r\n      setOauthLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleAddConnection = async () => {\r\n    const providerConfig = getProviderConfig(activeTab, selectedProvider);\r\n    \r\n    // For WhatsApp Meta, use OAuth\r\n    if (activeTab === 'whatsapp' && selectedProvider === 'meta') {\r\n      await handleMetaOAuthConnect();\r\n      return;\r\n    }\r\n\r\n    // Validate required fields\r\n    if (providerConfig) {\r\n      const missingFields = providerConfig.fields.filter(\r\n        field => field.required && !formData[field.key]\r\n      );\r\n      if (missingFields.length > 0) {\r\n        toast.error(isRTL ? 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©' : 'Please fill in all required fields');\r\n        return;\r\n      }\r\n    }\r\n\r\n    setConnecting(true);\r\n    \r\n    try {\r\n      // Use the connection-manage edge function for real persistence\r\n      const { data, error } = await supabase.functions.invoke('connection-manage', {\r\n        body: {\r\n          action: 'create',\r\n          channel: activeTab,\r\n          provider: selectedProvider,\r\n          display_name: formData.displayName || `${selectedProvider} - ${formData.phoneNumber || formData.email}`,\r\n          identifier: formData.phoneNumber || formData.email,\r\n          credentials: formData,\r\n          is_default: false,\r\n        },\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      if (data?.success) {\r\n        toast.success(isRTL ? 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­' : 'Connection added successfully');\r\n        // Refresh connections based on channel\r\n        if (activeTab === 'whatsapp') {\r\n          whatsApp.addConnection({\r\n            phoneNumber: formData.phoneNumber || '+971 50 000 0000',\r\n            displayName: formData.displayName || 'New WhatsApp Number',\r\n            provider: selectedProvider as any,\r\n            status: 'connected',\r\n            apiKey: formData.accessToken || formData.apiKey || formData.authToken,\r\n            token: formData.businessId,\r\n            lastSync: new Date(),\r\n          });\r\n        } else if (activeTab === 'email') {\r\n          email.addConnection({\r\n            email: formData.email || 'new@company.com',\r\n            displayName: formData.displayName || 'New Email Sender',\r\n            provider: selectedProvider as any,\r\n            status: 'connected',\r\n            apiKey: formData.apiKey || formData.accessKeyId,\r\n            lastSync: new Date(),\r\n            verified: false,\r\n          });\r\n        } else if (activeTab === 'sms') {\r\n          sms.addConnection({\r\n            phoneNumber: formData.phoneNumber || '+971 50 000 0000',\r\n            displayName: formData.displayName || 'New SMS Number',\r\n            provider: selectedProvider as any,\r\n            status: 'connected',\r\n            accountSid: formData.accountSid || formData.authId || formData.apiKey,\r\n            authToken: formData.authToken || formData.apiSecret,\r\n            lastSync: new Date(),\r\n          });\r\n        }\r\n      } else {\r\n        throw new Error(data?.error || 'Failed to add connection');\r\n      }\r\n    } catch (error) {\r\n      console.error('Add connection error:', error);\r\n      toast.error(isRTL ? 'ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§ØªØµØ§Ù„' : 'Failed to add connection');\r\n    }\r\n    \r\n    setConnecting(false);\r\n    setShowAddDialog(false);\r\n    resetForm();\r\n  };\r\n\r\n  const handleTestConnection = async (channel: ChannelType, id: string) => {\r\n    let success = false;\r\n    if (channel === 'whatsapp') {\r\n      success = await whatsApp.testConnection(id);\r\n    } else if (channel === 'email') {\r\n      success = await email.testConnection(id);\r\n    } else if (channel === 'sms') {\r\n      success = await sms.testConnection(id);\r\n    }\r\n    toast.success(success \r\n      ? (isRTL ? 'Ø§Ù„Ø§ØªØµØ§Ù„ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­' : 'Connection working properly')\r\n      : (isRTL ? 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„' : 'Connection failed')\r\n    );\r\n  };\r\n\r\n  const handleRemoveConnection = (channel: ChannelType, id: string) => {\r\n    if (channel === 'whatsapp') {\r\n      whatsApp.removeConnection(id);\r\n    } else if (channel === 'email') {\r\n      email.removeConnection(id);\r\n    } else if (channel === 'sms') {\r\n      sms.removeConnection(id);\r\n    }\r\n  };\r\n\r\n  const getStatusBadge = (status: string) => {\r\n    switch (status) {\r\n      case 'connected':\r\n        return (\r\n          <Badge className=\"bg-green-500/10 text-green-600 border-green-500/20 gap-1\">\r\n            <Check className=\"h-3 w-3\" />\r\n            {isRTL ? 'Ù…ØªØµÙ„' : 'Connected'}\r\n          </Badge>\r\n        );\r\n      case 'error':\r\n        return (\r\n          <Badge className=\"bg-red-500/10 text-red-600 border-red-500/20 gap-1\">\r\n            <AlertCircle className=\"h-3 w-3\" />\r\n            {isRTL ? 'Ø®Ø·Ø£' : 'Error'}\r\n          </Badge>\r\n        );\r\n      default:\r\n        return (\r\n          <Badge variant=\"outline\" className=\"text-muted-foreground gap-1\">\r\n            <X className=\"h-3 w-3\" />\r\n            {isRTL ? 'ØºÙŠØ± Ù…ØªØµÙ„' : 'Disconnected'}\r\n          </Badge>\r\n        );\r\n    }\r\n  };\r\n\r\n  const ConnectionCard = ({ \r\n    channel, \r\n    id, \r\n    identifier, \r\n    displayName, \r\n    provider, \r\n    status, \r\n    lastSync,\r\n    isLoading,\r\n  }: { \r\n    channel: ChannelType;\r\n    id: string;\r\n    identifier: string;\r\n    displayName: string;\r\n    provider: string;\r\n    status: string;\r\n    lastSync?: Date;\r\n    isLoading: boolean;\r\n  }) => {\r\n    const getIcon = () => {\r\n      switch (channel) {\r\n        case 'whatsapp': return <Phone className=\"h-5 w-5 text-green-600\" />;\r\n        case 'email': return <Mail className=\"h-5 w-5 text-blue-600\" />;\r\n        case 'sms': return <MessageSquare className=\"h-5 w-5 text-purple-600\" />;\r\n      }\r\n    };\r\n\r\n    return (\r\n      <Card className=\"bg-card/50 backdrop-blur-sm\">\r\n        <CardContent className=\"p-4\">\r\n          <div className={cn(\"flex items-center justify-between gap-4\", isRTL && \"flex-row-reverse\")}>\r\n            <div className={cn(\"flex items-center gap-3\", isRTL && \"flex-row-reverse\")}>\r\n              <div className=\"w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center\">\r\n                {getIcon()}\r\n              </div>\r\n              <div className={isRTL ? \"text-right\" : \"\"}>\r\n                <p className=\"font-semibold\">{displayName}</p>\r\n                <p className=\"text-sm text-muted-foreground\">{identifier}</p>\r\n                <div className={cn(\"flex items-center gap-2 mt-1\", isRTL && \"flex-row-reverse\")}>\r\n                  <Badge variant=\"outline\" className=\"text-xs\">{provider.toUpperCase()}</Badge>\r\n                  {getStatusBadge(status)}\r\n                </div>\r\n                {lastSync && (\r\n                  <p className=\"text-xs text-muted-foreground mt-1\">\r\n                    {isRTL ? 'Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©: ' : 'Last sync: '}\r\n                    {lastSync.toLocaleString()}\r\n                  </p>\r\n                )}\r\n              </div>\r\n            </div>\r\n            <div className={cn(\"flex items-center gap-1\", isRTL && \"flex-row-reverse\")}>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"icon\"\r\n                disabled={isLoading}\r\n                onClick={() => handleTestConnection(channel, id)}\r\n              >\r\n                <RefreshCw className={cn(\"h-4 w-4\", isLoading && \"animate-spin\")} />\r\n              </Button>\r\n              <Button variant=\"ghost\" size=\"icon\">\r\n                <Settings2 className=\"h-4 w-4\" />\r\n              </Button>\r\n              <AlertDialog>\r\n                <AlertDialogTrigger asChild>\r\n                  <Button variant=\"ghost\" size=\"icon\" className=\"text-destructive hover:text-destructive\">\r\n                    <Trash2 className=\"h-4 w-4\" />\r\n                  </Button>\r\n                </AlertDialogTrigger>\r\n                <AlertDialogContent>\r\n                  <AlertDialogHeader>\r\n                    <AlertDialogTitle>{isRTL ? 'Ø­Ø°Ù Ø§Ù„Ø§ØªØµØ§Ù„ØŸ' : 'Remove Connection?'}</AlertDialogTitle>\r\n                    <AlertDialogDescription>\r\n                      {isRTL \r\n                        ? 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.'\r\n                        : 'This connection will be permanently removed. This action cannot be undone.'}\r\n                    </AlertDialogDescription>\r\n                  </AlertDialogHeader>\r\n                  <AlertDialogFooter>\r\n                    <AlertDialogCancel>{isRTL ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel'}</AlertDialogCancel>\r\n                    <AlertDialogAction \r\n                      onClick={() => handleRemoveConnection(channel, id)}\r\n                      className=\"bg-destructive text-destructive-foreground\"\r\n                    >\r\n                      {isRTL ? 'Ø­Ø°Ù' : 'Remove'}\r\n                    </AlertDialogAction>\r\n                  </AlertDialogFooter>\r\n                </AlertDialogContent>\r\n              </AlertDialog>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    );\r\n  };\r\n\r\n  const EmptyState = ({ channel }: { channel: ChannelType }) => {\r\n    const getIcon = () => {\r\n      switch (channel) {\r\n        case 'whatsapp': return <Phone className=\"h-8 w-8 text-green-600\" />;\r\n        case 'email': return <Mail className=\"h-8 w-8 text-blue-600\" />;\r\n        case 'sms': return <MessageSquare className=\"h-8 w-8 text-purple-600\" />;\r\n      }\r\n    };\r\n\r\n    const getTitle = () => {\r\n      switch (channel) {\r\n        case 'whatsapp': return isRTL ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… WhatsApp' : 'No WhatsApp Numbers';\r\n        case 'email': return isRTL ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¨Ø±ÙŠØ¯' : 'No Email Senders';\r\n        case 'sms': return isRTL ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… SMS' : 'No SMS Numbers';\r\n      }\r\n    };\r\n\r\n    return (\r\n      <Card className=\"border-dashed border-2 border-muted-foreground/20\">\r\n        <CardContent className=\"p-8 text-center\">\r\n          <div className=\"w-16 h-16 rounded-full bg-muted flex items-center justify-center mx-auto mb-4\">\r\n            {getIcon()}\r\n          </div>\r\n          <h3 className=\"font-semibold mb-2\">{getTitle()}</h3>\r\n          <p className=\"text-muted-foreground text-sm mb-4\">\r\n            {isRTL ? 'Ø£Ø¶Ù Ø§ØªØµØ§Ù„Ø§Ù‹ Ù„Ø¨Ø¯Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ù…Ù„Ø§Øª' : 'Add a connection to start sending campaigns'}\r\n          </p>\r\n          <Button onClick={() => setShowAddDialog(true)} className=\"gap-2\">\r\n            <Plus className=\"h-4 w-4\" />\r\n            {isRTL ? 'Ø¥Ø¶Ø§ÙØ© Ø§ØªØµØ§Ù„' : 'Add Connection'}\r\n          </Button>\r\n        </CardContent>\r\n      </Card>\r\n    );\r\n  };\r\n\r\n  const totalConnections = whatsApp.connections.length + email.connections.length + sms.connections.length;\r\n  const connectedCount = [\r\n    ...whatsApp.connections.filter(c => c.status === 'connected'),\r\n    ...email.connections.filter(c => c.status === 'connected'),\r\n    ...sms.connections.filter(c => c.status === 'connected'),\r\n  ].length;\r\n\r\n  return (\r\n    <motion.div \r\n      className=\"space-y-6\"\r\n      initial=\"initial\"\r\n      animate=\"animate\"\r\n      exit=\"exit\"\r\n      variants={pageVariants}\r\n      transition={pageTransition}\r\n    >\r\n      {/* Header */}\r\n      <div className={cn(\"flex items-center justify-between gap-3 flex-wrap\", isRTL && \"flex-row-reverse\")}>\r\n        <div className={cn(\"flex items-center gap-3\", isRTL && \"flex-row-reverse\")}>\r\n          <div className=\"w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center\">\r\n            <Plug className=\"h-5 w-5 text-primary\" />\r\n          </div>\r\n          <div className={isRTL ? \"text-right\" : \"\"}>\r\n            <h1 className=\"text-2xl font-bold\">{isRTL ? 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª' : 'Connection Settings'}</h1>\r\n            <p className=\"text-sm text-muted-foreground\">\r\n              {isRTL \r\n                ? `${connectedCount} Ù…Ù† ${totalConnections} Ø§ØªØµØ§Ù„ Ù†Ø´Ø·`\r\n                : `${connectedCount} of ${totalConnections} connections active`}\r\n            </p>\r\n          </div>\r\n        </div>\r\n        <Button variant=\"outline\" onClick={runHealthCheck} className=\"gap-2\">\r\n          <Activity className=\"h-4 w-4\" />\r\n          {isRTL ? 'ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª' : 'Run Health Check'}\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Health Status Alert */}\r\n      {healthSummary.failed > 0 && (\r\n        <Alert variant=\"destructive\">\r\n          <XCircle className=\"h-4 w-4\" />\r\n          <AlertTitle>{isRTL ? 'ØªØ­Ø°ÙŠØ± Ø§ØªØµØ§Ù„Ø§Øª' : 'Connection Warning'}</AlertTitle>\r\n          <AlertDescription>\r\n            {isRTL \r\n              ? `${healthSummary.failed} Ø§ØªØµØ§Ù„ ÙØ§Ø´Ù„ ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù‡ØªÙ…Ø§Ù…`\r\n              : `${healthSummary.failed} connection(s) failing and need attention`}\r\n          </AlertDescription>\r\n        </Alert>\r\n      )}\r\n\r\n      {/* Stats with Health Monitoring */}\r\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\r\n        <Card className=\"bg-gradient-to-br from-green-500/10 to-transparent border-green-500/20\">\r\n          <CardContent className=\"p-4 text-center\">\r\n            <Phone className=\"h-6 w-6 mx-auto mb-2 text-green-600\" />\r\n            <p className=\"text-2xl font-bold\">{whatsApp.connections.length}</p>\r\n            <p className=\"text-xs text-muted-foreground\">WhatsApp</p>\r\n          </CardContent>\r\n        </Card>\r\n        <Card className=\"bg-gradient-to-br from-blue-500/10 to-transparent border-blue-500/20\">\r\n          <CardContent className=\"p-4 text-center\">\r\n            <Mail className=\"h-6 w-6 mx-auto mb-2 text-blue-600\" />\r\n            <p className=\"text-2xl font-bold\">{email.connections.length}</p>\r\n            <p className=\"text-xs text-muted-foreground\">Email</p>\r\n          </CardContent>\r\n        </Card>\r\n        <Card className=\"bg-gradient-to-br from-purple-500/10 to-transparent border-purple-500/20\">\r\n          <CardContent className=\"p-4 text-center\">\r\n            <MessageSquare className=\"h-6 w-6 mx-auto mb-2 text-purple-600\" />\r\n            <p className=\"text-2xl font-bold\">{sms.connections.length}</p>\r\n            <p className=\"text-xs text-muted-foreground\">SMS</p>\r\n          </CardContent>\r\n        </Card>\r\n        <Card className={cn(\r\n          \"border\",\r\n          healthSummary.overallStatus === 'healthy' && \"bg-gradient-to-br from-emerald-500/10 to-transparent border-emerald-500/20\",\r\n          healthSummary.overallStatus === 'degraded' && \"bg-gradient-to-br from-red-500/10 to-transparent border-red-500/20\",\r\n          healthSummary.overallStatus === 'warning' && \"bg-gradient-to-br from-amber-500/10 to-transparent border-amber-500/20\",\r\n        )}>\r\n          <CardContent className=\"p-4 text-center\">\r\n            {healthSummary.overallStatus === 'healthy' ? (\r\n              <CheckCircle2 className=\"h-6 w-6 mx-auto mb-2 text-emerald-600\" />\r\n            ) : healthSummary.overallStatus === 'degraded' ? (\r\n              <XCircle className=\"h-6 w-6 mx-auto mb-2 text-red-600\" />\r\n            ) : (\r\n              <AlertTriangle className=\"h-6 w-6 mx-auto mb-2 text-amber-600\" />\r\n            )}\r\n            <p className=\"text-2xl font-bold\">{healthSummary.healthy}/{healthSummary.total}</p>\r\n            <p className=\"text-xs text-muted-foreground\">{isRTL ? 'Ø³Ù„ÙŠÙ…' : 'Healthy'}</p>\r\n            {lastHealthCheck && (\r\n              <p className=\"text-[10px] text-muted-foreground mt-1\">\r\n                {isRTL ? 'Ø¢Ø®Ø± ÙØ­Øµ: ' : 'Last: '}{lastHealthCheck.toLocaleTimeString()}\r\n              </p>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Tabs */}\r\n      <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as ChannelType)}>\r\n        <div className=\"flex items-center justify-between gap-4 flex-wrap\">\r\n          <TabsList className=\"bg-muted/50\">\r\n            <TabsTrigger value=\"whatsapp\" className=\"gap-2\">\r\n              <Phone className=\"h-4 w-4\" />\r\n              WhatsApp\r\n              <Badge variant=\"secondary\" className=\"h-5 min-w-[20px] px-1.5 text-xs\">\r\n                {whatsApp.connections.length}\r\n              </Badge>\r\n            </TabsTrigger>\r\n            <TabsTrigger value=\"email\" className=\"gap-2\">\r\n              <Mail className=\"h-4 w-4\" />\r\n              Email\r\n              <Badge variant=\"secondary\" className=\"h-5 min-w-[20px] px-1.5 text-xs\">\r\n                {email.connections.length}\r\n              </Badge>\r\n            </TabsTrigger>\r\n            <TabsTrigger value=\"sms\" className=\"gap-2\">\r\n              <MessageSquare className=\"h-4 w-4\" />\r\n              SMS\r\n              <Badge variant=\"secondary\" className=\"h-5 min-w-[20px] px-1.5 text-xs\">\r\n                {sms.connections.length}\r\n              </Badge>\r\n            </TabsTrigger>\r\n          </TabsList>\r\n          <Button onClick={() => setShowAddDialog(true)} className=\"gap-2\">\r\n            <Plus className=\"h-4 w-4\" />\r\n            {isRTL ? 'Ø¥Ø¶Ø§ÙØ© Ø§ØªØµØ§Ù„' : 'Add Connection'}\r\n          </Button>\r\n        </div>\r\n\r\n        <TabsContent value=\"whatsapp\" className=\"mt-4 space-y-4\">\r\n          {whatsApp.connections.length > 0 ? (\r\n            whatsApp.connections.map(conn => (\r\n              <ConnectionCard\r\n                key={conn.id}\r\n                channel=\"whatsapp\"\r\n                id={conn.id}\r\n                identifier={conn.phoneNumber}\r\n                displayName={conn.displayName}\r\n                provider={conn.provider}\r\n                status={conn.status}\r\n                lastSync={conn.lastSync}\r\n                isLoading={whatsApp.isLoading}\r\n              />\r\n            ))\r\n          ) : (\r\n            <EmptyState channel=\"whatsapp\" />\r\n          )}\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"email\" className=\"mt-4 space-y-4\">\r\n          {email.connections.length > 0 ? (\r\n            email.connections.map(conn => (\r\n              <ConnectionCard\r\n                key={conn.id}\r\n                channel=\"email\"\r\n                id={conn.id}\r\n                identifier={conn.email}\r\n                displayName={conn.displayName}\r\n                provider={conn.provider}\r\n                status={conn.status}\r\n                lastSync={conn.lastSync}\r\n                isLoading={email.isLoading}\r\n              />\r\n            ))\r\n          ) : (\r\n            <EmptyState channel=\"email\" />\r\n          )}\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"sms\" className=\"mt-4 space-y-4\">\r\n          {sms.connections.length > 0 ? (\r\n            sms.connections.map(conn => (\r\n              <ConnectionCard\r\n                key={conn.id}\r\n                channel=\"sms\"\r\n                id={conn.id}\r\n                identifier={conn.phoneNumber}\r\n                displayName={conn.displayName}\r\n                provider={conn.provider}\r\n                status={conn.status}\r\n                lastSync={conn.lastSync}\r\n                isLoading={sms.isLoading}\r\n              />\r\n            ))\r\n          ) : (\r\n            <EmptyState channel=\"sms\" />\r\n          )}\r\n        </TabsContent>\r\n      </Tabs>\r\n\r\n      {/* Add Connection Dialog */}\r\n      <Dialog open={showAddDialog} onOpenChange={(open) => { setShowAddDialog(open); if (!open) resetForm(); }}>\r\n        <DialogContent className=\"max-w-lg max-h-[90vh] overflow-y-auto\">\r\n          <DialogHeader>\r\n            <DialogTitle className=\"flex items-center gap-2\">\r\n              {activeTab === 'whatsapp' && <Phone className=\"h-5 w-5 text-green-600\" />}\r\n              {activeTab === 'email' && <Mail className=\"h-5 w-5 text-blue-600\" />}\r\n              {activeTab === 'sms' && <MessageSquare className=\"h-5 w-5 text-purple-600\" />}\r\n              {isRTL ? 'Ø¥Ø¶Ø§ÙØ© Ø§ØªØµØ§Ù„ Ø¬Ø¯ÙŠØ¯' : `Add ${activeTab.charAt(0).toUpperCase() + activeTab.slice(1)} Connection`}\r\n            </DialogTitle>\r\n            <DialogDescription>\r\n              {isRTL ? 'Ø§Ø®ØªØ± Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø© ÙˆØ£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„' : 'Select a provider and enter connection details'}\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n\r\n          <div className=\"space-y-4 py-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label>{isRTL ? 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶' : 'Display Name'}</Label>\r\n              <Input \r\n                placeholder={isRTL ? 'Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª' : 'e.g., Sales Team'} \r\n                value={formData.displayName || ''}\r\n                onChange={(e) => setFormData({ ...formData, displayName: e.target.value })}\r\n              />\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label>{isRTL ? 'Ø§Ù„Ù…Ø²ÙˆØ¯' : 'Provider'}</Label>\r\n              <Select value={selectedProvider} onValueChange={(value) => {\r\n                setSelectedProvider(value);\r\n                setFormData({ displayName: formData.displayName || '' });\r\n              }}>\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder={isRTL ? 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø²ÙˆØ¯' : 'Select provider'} />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {getProviderOptions(activeTab).map((option) => (\r\n                    <SelectItem key={option.value} value={option.value}>\r\n                      <span className=\"flex items-center gap-2\">\r\n                        <span>{option.icon}</span>\r\n                        <span>{option.label}</span>\r\n                      </span>\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n\r\n            {selectedProvider && (() => {\r\n              const providerConfig = getProviderConfig(activeTab, selectedProvider);\r\n              if (!providerConfig) return null;\r\n\r\n              // Special handling for WhatsApp Meta OAuth\r\n              const isMetaOAuth = activeTab === 'whatsapp' && selectedProvider === 'meta';\r\n\r\n              return (\r\n                <>\r\n                  {/* Provider Instructions */}\r\n                  <Alert className={isMetaOAuth ? 'border-green-500/50 bg-green-500/5' : ''}>\r\n                    <Shield className=\"h-4 w-4\" />\r\n                    <AlertTitle>{isRTL ? 'ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„' : 'Connection Instructions'}</AlertTitle>\r\n                    <AlertDescription className=\"text-sm\">\r\n                      {isRTL ? providerConfig.instructionsAr : providerConfig.instructions}\r\n                      {providerConfig.connectUrl && (\r\n                        <Button \r\n                          variant=\"link\" \r\n                          className=\"h-auto p-0 ml-2\" \r\n                          onClick={() => window.open(providerConfig.connectUrl, '_blank')}\r\n                        >\r\n                          <ExternalLink className=\"h-3 w-3 mr-1\" />\r\n                          {isRTL ? 'ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…' : 'Open Dashboard'}\r\n                        </Button>\r\n                      )}\r\n                    </AlertDescription>\r\n                  </Alert>\r\n\r\n                  {/* Meta OAuth Button */}\r\n                  {isMetaOAuth && (\r\n                    <div className=\"space-y-4\">\r\n                      <div className=\"flex flex-col items-center gap-3 p-6 rounded-lg border-2 border-dashed border-green-500/30 bg-green-500/5\">\r\n                        <div className=\"flex items-center gap-2 text-green-600\">\r\n                          <Phone className=\"h-6 w-6\" />\r\n                          <span className=\"font-semibold\">\r\n                            {isRTL ? 'Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ø¨Ø± Meta Business' : 'Connect via Meta Business'}\r\n                          </span>\r\n                        </div>\r\n                        <p className=\"text-sm text-muted-foreground text-center max-w-sm\">\r\n                          {isRTL \r\n                            ? 'Ø§Ø±Ø¨Ø· Ø±Ù‚Ù… WhatsApp Business Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¨Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø©. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø¥Ù„Ù‰ Meta Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø©.'\r\n                            : 'Connect your WhatsApp Business number with one click. You\\'ll be redirected to Meta for authorization.'}\r\n                        </p>\r\n                        <Button \r\n                          size=\"lg\"\r\n                          className=\"bg-[#1877F2] hover:bg-[#166FE5] text-white gap-2 mt-2\"\r\n                          onClick={handleMetaOAuthConnect}\r\n                          disabled={oauthLoading}\r\n                        >\r\n                          {oauthLoading ? (\r\n                            <>\r\n                              <RefreshCw className=\"h-5 w-5 animate-spin\" />\r\n                              {isRTL ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...' : 'Redirecting...'}\r\n                            </>\r\n                          ) : (\r\n                            <>\r\n                              <svg viewBox=\"0 0 36 36\" className=\"h-5 w-5 fill-current\">\r\n                                <path d=\"M15 35.8C6.5 34.3 0 26.9 0 18 0 8.1 8.1 0 18 0s18 8.1 18 18c0 8.9-6.5 16.3-15 17.8l-1-.8h-4l-1 .8z\"/>\r\n                                <path fill=\"#fff\" d=\"M25 23l.8-5H21v-3.5c0-1.4.5-2.5 2.7-2.5H26V7.4c-1.3-.2-2.7-.4-4-.4-4.1 0-7 2.5-7 7v4h-4.5v5H15v12.7c1 .2 2 .3 3 .3s2-.1 3-.3V23h4z\"/>\r\n                              </svg>\r\n                              {isRTL ? 'Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ø¨Ø± Meta' : 'Connect with Meta'}\r\n                            </>\r\n                          )}\r\n                        </Button>\r\n                      </div>\r\n                      <p className=\"text-xs text-muted-foreground text-center\">\r\n                        {isRTL \r\n                          ? 'Ø³ØªØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¹Ø¨Ø± Meta Cloud API. ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙŠØªØ­Ù…Ù„Ù‡Ø§ Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ Meta.'\r\n                          : 'Messages will be processed via Meta Cloud API. Message costs are charged to your Meta account.'}\r\n                      </p>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Dynamic Fields for non-OAuth providers */}\r\n                  {!isMetaOAuth && providerConfig.fields.map((field) => (\r\n                    <div key={field.key} className=\"space-y-2\">\r\n                      <Label>{isRTL ? field.labelAr : field.label}</Label>\r\n                      <Input \r\n                        type={field.type}\r\n                        placeholder={field.placeholder}\r\n                        value={formData[field.key] || ''}\r\n                        onChange={(e) => setFormData({ ...formData, [field.key]: e.target.value })}\r\n                        required={field.required}\r\n                      />\r\n                    </div>\r\n                  ))}\r\n                </>\r\n              );\r\n            })()}\r\n          </div>\r\n\r\n          <div className=\"flex justify-end gap-2\">\r\n            <Button variant=\"outline\" onClick={() => setShowAddDialog(false)}>\r\n              {isRTL ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel'}\r\n            </Button>\r\n            {/* Hide connect button for Meta OAuth since we have a dedicated button */}\r\n            {!(activeTab === 'whatsapp' && selectedProvider === 'meta') && (\r\n              <Button \r\n                onClick={handleAddConnection} \r\n                disabled={!selectedProvider || connecting}\r\n              >\r\n                {connecting ? (\r\n                  <>\r\n                    <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                    {isRTL ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...' : 'Connecting...'}\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <Zap className=\"h-4 w-4 mr-2\" />\r\n                    {isRTL ? 'Ø§ØªØµØ§Ù„' : 'Connect'}\r\n                  </>\r\n                )}\r\n              </Button>\r\n            )}\r\n          </div>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </motion.div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\Dashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\IntegrationsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\LeadAssignmentPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":119,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4019,4022],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4019,4022],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":123,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":123,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4115,4118],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4115,4118],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useMemo } from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport {\r\n  History,\r\n  CheckCircle,\r\n  ChevronDown,\r\n  UserPlus,\r\n  RefreshCw,\r\n  FolderOpen,\r\n  BarChart3,\r\n  Clock,\r\n  Bell,\r\n  Zap,\r\n  Settings,\r\n  Loader2\r\n} from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent } from \"@/components/ui/card\";\r\nimport { Switch } from \"@/components/ui/switch\";\r\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\";\r\nimport { LeadAssignmentPageSkeleton } from \"@/components/ui/page-skeletons\";\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport { toast } from \"sonner\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { useUserRole } from \"@/hooks/useUserRole\";\r\nimport { useAssignmentConfig } from \"@/hooks/useAssignmentConfig\";\r\nimport { useLocalization } from \"@/contexts/LocalizationContext\";\r\n\r\n// Import new tabs\r\nimport { LeadPoolsTab } from \"@/components/lead-assignment/LeadPoolsTab\";\r\nimport { AgentLoadTab } from \"@/components/lead-assignment/AgentLoadTab\";\r\nimport { AutoReassignTab } from \"@/components/lead-assignment/AutoReassignTab\";\r\nimport { NotificationsTab } from \"@/components/lead-assignment/NotificationsTab\";\r\nimport { RoundRobinTab } from \"@/components/lead-assignment/RoundRobinTab\";\r\nimport { GlobalSettingsTab } from \"@/components/lead-assignment/GlobalSettingsTab\";\r\nimport { CampaignRulesTab } from \"@/components/lead-assignment/CampaignRulesTab\";\r\nimport { AdvancedLogicTab } from \"@/components/lead-assignment/AdvancedLogicTab\";\r\nimport { useAssignmentNotifications } from \"@/hooks/useLeadAssignment\";\r\n\r\ninterface Agent {\r\n  id: string;\r\n  name: string;\r\n  email: string;\r\n  assignLeads: boolean;\r\n  leadsPerRound: number;\r\n}\r\n\r\nconst pageVariants = {\r\n  initial: { opacity: 0, y: 20 },\r\n  animate: { opacity: 1, y: 0 },\r\n  exit: { opacity: 0, y: -10 }\r\n};\r\n\r\nconst pageTransition = {\r\n  type: \"tween\" as const,\r\n  ease: \"easeOut\" as const,\r\n  duration: 0.3\r\n};\r\n\r\nconst LeadAssignmentPage = () => {\r\n  const isMobile = useIsMobile();\r\n  const navigate = useNavigate();\r\n  const { profile } = useAuth();\r\n  const { isAdmin } = useUserRole();\r\n  const { unreadCount } = useAssignmentNotifications();\r\n  const { config, isLoading: configLoading, updateAssignmentMethod, updateEnabledAgents } = useAssignmentConfig();\r\n  const { t } = useLocalization();\r\n\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [activeTab, setActiveTab] = useState(\"overview\");\r\n  const [agents, setAgents] = useState<Agent[]>([]);\r\n  const [isSaving, setIsSaving] = useState(false);\r\n\r\n  // Derive assignment method from config\r\n  const assignmentMethod = config?.assignment_method || \"manual\";\r\n\r\n  useEffect(() => {\r\n    const fetchAgents = async () => {\r\n      if (!profile?.company_id) {\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n\r\n      try {\r\n        const { data, error } = await supabase\r\n          .from(\"agents\")\r\n          .select(\"id, name, email\")\r\n          .eq(\"company_id\", profile.company_id)\r\n          .eq(\"status\", \"active\");\r\n\r\n        if (error) throw error;\r\n\r\n        // Map agents with their assignment status from config\r\n        const mappedAgents = (data || []).map((agent) => ({\r\n          id: agent.id,\r\n          name: agent.name,\r\n          email: agent.email,\r\n          assignLeads: config?.enabled_agent_ids?.includes(agent.id) || false,\r\n          leadsPerRound: (config?.agent_leads_per_round as any)?.[agent.id] || 1,\r\n        }));\r\n\r\n        setAgents(mappedAgents);\r\n      } catch (error: any) {\r\n        console.error(\"Error fetching agents:\", error);\r\n        toast.error(\"Failed to load agents\");\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    };\r\n\r\n    if (!configLoading) {\r\n      fetchAgents();\r\n    }\r\n  }, [profile?.company_id, config, configLoading]);\r\n\r\n  // Show skeleton while loading\r\n  if (isLoading || configLoading) {\r\n    return <LeadAssignmentPageSkeleton isMobile={isMobile} />;\r\n  }\r\n\r\n  // Permission check\r\n  if (!isAdmin) {\r\n    return (\r\n      <div className=\"flex flex-col items-center justify-center min-h-[400px] p-6\">\r\n        <Settings className=\"h-12 w-12 text-muted-foreground mb-4\" />\r\n        <h3 className=\"text-lg font-semibold mb-2\">Admin Access Required</h3>\r\n        <p className=\"text-sm text-muted-foreground text-center max-w-md\">\r\n          Only administrators can configure lead assignment settings. Please contact your admin for access.\r\n        </p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const activeAgents = agents.filter((a) => a.assignLeads);\r\n  const activeAgentName = activeAgents.length === 1 ? activeAgents[0] : null;\r\n\r\n  const handleToggleAssign = async (id: string) => {\r\n    // Optimistic update\r\n    const previousAgents = [...agents];\r\n    setAgents((prev) =>\r\n      prev.map((a) => (a.id === id ? { ...a, assignLeads: !a.assignLeads } : a))\r\n    );\r\n\r\n    try {\r\n      const updatedAgents = agents.map((a) =>\r\n        a.id === id ? { ...a, assignLeads: !a.assignLeads } : a\r\n      );\r\n      const enabledIds = updatedAgents.filter((a) => a.assignLeads).map((a) => a.id);\r\n      const leadsPerRound = updatedAgents\r\n        .filter((a) => a.assignLeads)\r\n        .reduce((acc, a) => ({ ...acc, [a.id]: a.leadsPerRound }), {});\r\n\r\n      const success = await updateEnabledAgents(enabledIds, leadsPerRound);\r\n\r\n      if (!success) {\r\n        // Rollback on failure\r\n        setAgents(previousAgents);\r\n      }\r\n    } catch (error) {\r\n      // Rollback on error\r\n      setAgents(previousAgents);\r\n      toast.error(\"Failed to update agent assignment\");\r\n    }\r\n  };\r\n\r\n  const handleLeadsPerRoundChange = async (id: string, value: string) => {\r\n    // Optimistic update\r\n    const previousAgents = [...agents];\r\n    setAgents((prev) =>\r\n      prev.map((a) =>\r\n        a.id === id ? { ...a, leadsPerRound: parseInt(value) } : a\r\n      )\r\n    );\r\n\r\n    try {\r\n      const updatedAgents = agents.map((a) =>\r\n        a.id === id ? { ...a, leadsPerRound: parseInt(value) } : a\r\n      );\r\n      const enabledIds = updatedAgents.filter((a) => a.assignLeads).map((a) => a.id);\r\n      const leadsPerRound = updatedAgents\r\n        .filter((a) => a.assignLeads)\r\n        .reduce((acc, a) => ({ ...acc, [a.id]: a.leadsPerRound }), {});\r\n\r\n      const success = await updateEnabledAgents(enabledIds, leadsPerRound);\r\n\r\n      if (!success) {\r\n        // Rollback on failure\r\n        setAgents(previousAgents);\r\n      }\r\n    } catch (error) {\r\n      // Rollback on error\r\n      setAgents(previousAgents);\r\n      toast.error(\"Failed to update leads per round\");\r\n    }\r\n  };\r\n\r\n  const handleAssignmentMethodChange = async (method: \"manual\" | \"round_robin\" | \"rules\") => {\r\n    setIsSaving(true);\r\n    try {\r\n      const success = await updateAssignmentMethod(method);\r\n      if (!success) {\r\n        toast.error(\"Failed to update assignment method\");\r\n      }\r\n    } catch (error) {\r\n      toast.error(\"Failed to update assignment method\");\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const tabs = [\r\n    { id: \"overview\", label: \"Overview\", icon: Zap },\r\n    { id: \"pools\", label: \"Lead Pools\", icon: FolderOpen },\r\n    { id: \"load\", label: \"Agent Load\", icon: BarChart3 },\r\n    { id: \"auto-reassign\", label: \"Auto Reassign\", icon: Clock },\r\n    { id: \"round-robin\", label: \"Round Robin\", icon: RefreshCw },\r\n    { id: \"rules\", label: \"Rules\", icon: Settings },\r\n    { id: \"notifications\", label: \"Notifications\", icon: Bell, badge: unreadCount },\r\n    { id: \"settings\", label: \"Settings\", icon: Settings },\r\n  ];\r\n\r\n  return (\r\n    <motion.div\r\n      className=\"space-y-6\"\r\n      initial=\"initial\"\r\n      animate=\"animate\"\r\n      exit=\"exit\"\r\n      variants={pageVariants}\r\n      transition={pageTransition}\r\n    >\r\n      {/* Page Header */}\r\n      <div className=\"flex flex-col gap-4 md:flex-row md:items-start md:justify-between\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold text-foreground md:text-3xl\">\r\n            Lead Assignment\r\n          </h1>\r\n          <p className=\"text-muted-foreground mt-1 text-sm md:text-base\">\r\n            Configure how leads are assigned to your team\r\n          </p>\r\n        </div>\r\n        <Button\r\n          variant=\"outline\"\r\n          onClick={() => navigate(\"/assignment-logs\")}\r\n          className=\"gap-2\"\r\n        >\r\n          <History className=\"h-4 w-4\" />\r\n          View Logs\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Tabs Navigation */}\r\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\r\n        <TabsList className=\"w-full h-auto flex-wrap justify-start gap-1 bg-transparent p-0 mb-6\">\r\n          {tabs.map((tab) => (\r\n            <TabsTrigger\r\n              key={tab.id}\r\n              value={tab.id}\r\n              className=\"data-[state=active]:bg-primary data-[state=active]:text-primary-foreground gap-2 px-4 py-2\"\r\n            >\r\n              <tab.icon className=\"h-4 w-4\" />\r\n              <span className=\"hidden sm:inline\">{tab.label}</span>\r\n              {tab.badge && tab.badge > 0 && (\r\n                <Badge variant=\"destructive\" className=\"h-5 w-5 p-0 flex items-center justify-center text-xs\">\r\n                  {tab.badge}\r\n                </Badge>\r\n              )}\r\n            </TabsTrigger>\r\n          ))}\r\n        </TabsList>\r\n\r\n        {/* Overview Tab */}\r\n        <TabsContent value=\"overview\" className=\"space-y-6 mt-0\">\r\n          {/* Assignment Method Selection */}\r\n          <Card>\r\n            <CardContent className=\"p-6\">\r\n              <h3 className=\"font-semibold text-foreground mb-4\">Assignment Method</h3>\r\n              <RadioGroup\r\n                value={assignmentMethod}\r\n                onValueChange={(v) => handleAssignmentMethodChange(v as \"manual\" | \"round_robin\" | \"rules\")}\r\n                className=\"space-y-4\"\r\n                disabled={isSaving}\r\n              >\r\n                {/* Manual Option */}\r\n                <div className=\"flex items-start gap-3\">\r\n                  <RadioGroupItem value=\"manual\" id=\"manual\" className=\"mt-1\" />\r\n                  <Label htmlFor=\"manual\" className=\"flex-1 cursor-pointer\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <UserPlus className=\"h-4 w-4 text-muted-foreground\" />\r\n                      <span className=\"font-medium\">Manual Assignment</span>\r\n                    </div>\r\n                    <p className=\"text-sm text-muted-foreground mt-1\">\r\n                      Leads will be added to an unassigned pool. Managers can manually assign leads to agents.\r\n                    </p>\r\n                  </Label>\r\n                </div>\r\n\r\n                {/* Round Robin Option */}\r\n                <div className=\"flex items-start gap-3\">\r\n                  <RadioGroupItem value=\"round-robin\" id=\"round-robin\" className=\"mt-1\" />\r\n                  <Label htmlFor=\"round-robin\" className=\"flex-1 cursor-pointer\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <RefreshCw className=\"h-4 w-4 text-muted-foreground\" />\r\n                      <span className=\"font-medium\">Round Robin</span>\r\n                    </div>\r\n                    <p className=\"text-sm text-muted-foreground mt-1\">\r\n                      Automatically distribute leads among selected team members in rotation.\r\n                    </p>\r\n                  </Label>\r\n                </div>\r\n\r\n                {/* Rule-Based Option */}\r\n                <div className=\"flex items-start gap-3\">\r\n                  <RadioGroupItem value=\"rules\" id=\"rules\" className=\"mt-1\" />\r\n                  <Label htmlFor=\"rules\" className=\"flex-1 cursor-pointer\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <Zap className=\"h-4 w-4 text-muted-foreground\" />\r\n                      <span className=\"font-medium\">Rule-Based Assignment</span>\r\n                    </div>\r\n                    <p className=\"text-sm text-muted-foreground mt-1\">\r\n                      Assign leads based on campaign, budget, location, property type, and custom rules.\r\n                    </p>\r\n                  </Label>\r\n                </div>\r\n              </RadioGroup>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Round Robin Configuration */}\r\n          {assignmentMethod === \"round-robin\" && (\r\n            <>\r\n              {/* Info Banner */}\r\n              <Card className=\"border-primary/30 bg-primary/5\">\r\n                <CardContent className=\"p-4\">\r\n                  <div className=\"flex items-start gap-3\">\r\n                    <CheckCircle className=\"h-5 w-5 text-primary mt-0.5 flex-shrink-0\" />\r\n                    <div>\r\n                      <h3 className=\"font-semibold text-foreground\">\r\n                        Automatically Assign to Team Member(s)\r\n                      </h3>\r\n                      <p className=\"text-sm text-muted-foreground mt-1\">\r\n                        Assign leads to selected team members in a round robin distribution. Only the assigned team member will receive an alert for each new lead.\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              {/* Agent Assignment Table */}\r\n              <Card>\r\n                <CardContent className=\"p-0\">\r\n                  {/* Table Header Info */}\r\n                  <div className=\"p-4 border-b\">\r\n                    <p className=\"text-xs font-medium text-muted-foreground uppercase tracking-wider\">\r\n                      ASSIGNING LEADS TO {activeAgents.length} TEAM MEMBER\r\n                      {activeAgents.length !== 1 ? \"S\" : \"\"}\r\n                    </p>\r\n                    {activeAgentName && (\r\n                      <p className=\"text-sm text-muted-foreground mt-1\">\r\n                        All leads will be automatically assigned to {activeAgentName.name} ({activeAgentName.email})\r\n                      </p>\r\n                    )}\r\n                    {activeAgents.length > 1 && (\r\n                      <p className=\"text-sm text-muted-foreground mt-1\">\r\n                        Leads will be distributed among {activeAgents.length} team members in round robin\r\n                      </p>\r\n                    )}\r\n                    {activeAgents.length === 0 && (\r\n                      <p className=\"text-sm text-muted-foreground mt-1\">\r\n                        No team members selected. Enable at least one team member to auto-assign leads.\r\n                      </p>\r\n                    )}\r\n                  </div>\r\n\r\n                  {agents.length === 0 ? (\r\n                    <div className=\"p-8 text-center text-muted-foreground\">\r\n                      <p>No active agents found. Add agents to your team first.</p>\r\n                    </div>\r\n                  ) : (\r\n                    <>\r\n                      {/* Desktop Table */}\r\n                      <div className=\"hidden md:block\">\r\n                        <Table>\r\n                          <TableHeader>\r\n                            <TableRow className=\"hover:bg-transparent\">\r\n                              <TableHead className=\"w-12\"></TableHead>\r\n                              <TableHead className=\"font-medium\">\r\n                                <div className=\"flex items-center gap-1\">\r\n                                  NAME\r\n                                  <ChevronDown className=\"h-3 w-3\" />\r\n                                </div>\r\n                              </TableHead>\r\n                              <TableHead className=\"text-center font-medium\">\r\n                                ASSIGN LEADS\r\n                              </TableHead>\r\n                              <TableHead className=\"text-center font-medium\">\r\n                                LEADS/ROUND\r\n                              </TableHead>\r\n                            </TableRow>\r\n                          </TableHeader>\r\n                          <TableBody>\r\n                            {agents.map((agent, index) => (\r\n                              <TableRow key={agent.id} className=\"hover:bg-muted/50\">\r\n                                <TableCell className=\"text-muted-foreground font-medium\">\r\n                                  {index + 1}\r\n                                </TableCell>\r\n                                <TableCell>\r\n                                  <div>\r\n                                    <p className=\"font-semibold text-foreground\">\r\n                                      {agent.name}\r\n                                    </p>\r\n                                    <p className=\"text-sm text-muted-foreground\">\r\n                                      {agent.email}\r\n                                    </p>\r\n                                  </div>\r\n                                </TableCell>\r\n                                <TableCell>\r\n                                  <div className=\"flex items-center justify-center gap-2\">\r\n                                    <Switch\r\n                                      checked={agent.assignLeads}\r\n                                      onCheckedChange={() => handleToggleAssign(agent.id)}\r\n                                    />\r\n                                    <span\r\n                                      className={`text-sm ${agent.assignLeads\r\n                                        ? \"text-primary font-medium\"\r\n                                        : \"text-muted-foreground\"\r\n                                        }`}\r\n                                    >\r\n                                      {agent.assignLeads ? \"Yes\" : \"No\"}\r\n                                    </span>\r\n                                  </div>\r\n                                </TableCell>\r\n                                <TableCell className=\"text-center\">\r\n                                  {agent.assignLeads ? (\r\n                                    <Select\r\n                                      value={String(agent.leadsPerRound)}\r\n                                      onValueChange={(value) =>\r\n                                        handleLeadsPerRoundChange(agent.id, value)\r\n                                      }\r\n                                    >\r\n                                      <SelectTrigger className=\"w-28 mx-auto\">\r\n                                        <SelectValue />\r\n                                      </SelectTrigger>\r\n                                      <SelectContent>\r\n                                        <SelectItem value=\"1\">1 lead</SelectItem>\r\n                                        <SelectItem value=\"2\">2 leads</SelectItem>\r\n                                        <SelectItem value=\"3\">3 leads</SelectItem>\r\n                                        <SelectItem value=\"5\">5 leads</SelectItem>\r\n                                        <SelectItem value=\"10\">10 leads</SelectItem>\r\n                                      </SelectContent>\r\n                                    </Select>\r\n                                  ) : (\r\n                                    <span className=\"text-muted-foreground\">-</span>\r\n                                  )}\r\n                                </TableCell>\r\n                              </TableRow>\r\n                            ))}\r\n                          </TableBody>\r\n                        </Table>\r\n                      </div>\r\n\r\n                      {/* Mobile Cards */}\r\n                      <div className=\"md:hidden divide-y\">\r\n                        {agents.map((agent, index) => (\r\n                          <div key={agent.id} className=\"p-4 space-y-3\">\r\n                            <div className=\"flex items-start justify-between\">\r\n                              <div className=\"flex items-center gap-3\">\r\n                                <span className=\"text-muted-foreground font-medium text-sm w-5\">\r\n                                  {index + 1}\r\n                                </span>\r\n                                <div>\r\n                                  <p className=\"font-semibold text-foreground\">\r\n                                    {agent.name}\r\n                                  </p>\r\n                                  <p className=\"text-xs text-muted-foreground\">\r\n                                    {agent.email}\r\n                                  </p>\r\n                                </div>\r\n                              </div>\r\n                            </div>\r\n                            <div className=\"flex items-center justify-between pl-8\">\r\n                              <div className=\"flex items-center gap-2\">\r\n                                <Switch\r\n                                  checked={agent.assignLeads}\r\n                                  onCheckedChange={() => handleToggleAssign(agent.id)}\r\n                                />\r\n                                <span\r\n                                  className={`text-sm ${agent.assignLeads\r\n                                    ? \"text-primary font-medium\"\r\n                                    : \"text-muted-foreground\"\r\n                                    }`}\r\n                                >\r\n                                  {agent.assignLeads ? \"Yes\" : \"No\"}\r\n                                </span>\r\n                              </div>\r\n                              {agent.assignLeads ? (\r\n                                <Select\r\n                                  value={String(agent.leadsPerRound)}\r\n                                  onValueChange={(value) =>\r\n                                    handleLeadsPerRoundChange(agent.id, value)\r\n                                  }\r\n                                >\r\n                                  <SelectTrigger className=\"w-28\">\r\n                                    <SelectValue />\r\n                                  </SelectTrigger>\r\n                                  <SelectContent>\r\n                                    <SelectItem value=\"1\">1 lead</SelectItem>\r\n                                    <SelectItem value=\"2\">2 leads</SelectItem>\r\n                                    <SelectItem value=\"3\">3 leads</SelectItem>\r\n                                    <SelectItem value=\"5\">5 leads</SelectItem>\r\n                                    <SelectItem value=\"10\">10 leads</SelectItem>\r\n                                  </SelectContent>\r\n                                </Select>\r\n                              ) : (\r\n                                <span className=\"text-muted-foreground text-sm\">-</span>\r\n                              )}\r\n                            </div>\r\n                          </div>\r\n                        ))}\r\n                      </div>\r\n                    </>\r\n                  )}\r\n                </CardContent>\r\n              </Card>\r\n            </>\r\n          )}\r\n\r\n          {/* Manual Assignment Info */}\r\n          {assignmentMethod === \"manual\" && (\r\n            <Card className=\"border-dashed bg-muted/30\">\r\n              <CardContent className=\"p-6 text-center\">\r\n                <UserPlus className=\"h-10 w-10 text-muted-foreground mx-auto mb-3\" />\r\n                <h3 className=\"font-semibold text-foreground mb-2\">Manual Assignment Enabled</h3>\r\n                <p className=\"text-sm text-muted-foreground max-w-md mx-auto\">\r\n                  New leads will appear in the unassigned pool. Team managers can manually assign leads to agents from the Leads page.\r\n                </p>\r\n              </CardContent>\r\n            </Card>\r\n          )}\r\n\r\n          {/* Rule-Based Assignment Info */}\r\n          {assignmentMethod === \"rules\" && (\r\n            <Card className=\"border-dashed bg-muted/30\">\r\n              <CardContent className=\"p-6 text-center\">\r\n                <Zap className=\"h-10 w-10 text-muted-foreground mx-auto mb-3\" />\r\n                <h3 className=\"font-semibold text-foreground mb-2\">Rule-Based Assignment Enabled</h3>\r\n                <p className=\"text-sm text-muted-foreground max-w-md mx-auto mb-4\">\r\n                  Leads will be automatically assigned based on your configured rules.\r\n                  Configure rules in the Rules tab.\r\n                </p>\r\n                <Button onClick={() => setActiveTab(\"rules\")} className=\"gap-2\">\r\n                  <Settings className=\"h-4 w-4\" />\r\n                  Configure Rules\r\n                </Button>\r\n              </CardContent>\r\n            </Card>\r\n          )}\r\n        </TabsContent>\r\n\r\n        {/* Lead Pools Tab */}\r\n        <TabsContent value=\"pools\" className=\"mt-0\">\r\n          <LeadPoolsTab />\r\n        </TabsContent>\r\n\r\n        {/* Agent Load Tab */}\r\n        <TabsContent value=\"load\" className=\"mt-0\">\r\n          <AgentLoadTab />\r\n        </TabsContent>\r\n\r\n        {/* Auto Reassign Tab */}\r\n        <TabsContent value=\"auto-reassign\" className=\"mt-0\">\r\n          <AutoReassignTab />\r\n        </TabsContent>\r\n\r\n        {/* Round Robin Tab */}\r\n        <TabsContent value=\"round-robin\" className=\"mt-0\">\r\n          <RoundRobinTab />\r\n        </TabsContent>\r\n\r\n        {/* Rules Tab */}\r\n        <TabsContent value=\"rules\" className=\"mt-0\">\r\n          <CampaignRulesTab />\r\n        </TabsContent>\r\n\r\n        {/* Notifications Tab */}\r\n        <TabsContent value=\"notifications\" className=\"mt-0\">\r\n          <NotificationsTab />\r\n        </TabsContent>\r\n\r\n        {/* Settings Tab */}\r\n        <TabsContent value=\"settings\" className=\"mt-0\">\r\n          <GlobalSettingsTab />\r\n        </TabsContent>\r\n      </Tabs>\r\n    </motion.div>\r\n  );\r\n};\r\n\r\nexport default LeadAssignmentPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\LeadDetailPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":90,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2647,2650],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2647,2650],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'currentStage' and 'lead'. Either include them or remove the dependency array.","line":184,"column":6,"nodeType":"ArrayExpression","endLine":184,"endColumn":57,"suggestions":[{"desc":"Update the dependencies array to be: [lead.stage_id, lead.lead_stage?.id, lead.stage, lead, currentStage]","fix":{"range":[5859,5910],"text":"[lead.stage_id, lead.lead_stage?.id, lead.stage, lead, currentStage]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":482,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":482,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15412,15415],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15412,15415],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":515,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":515,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16583,16586],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16583,16586],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":516,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":516,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16657,16660],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16657,16660],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":517,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":517,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16726,16729],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16726,16729],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":520,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":520,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16818,16821],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16818,16821],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useCallback, useEffect, useRef } from \"react\";\r\nimport { createPortal } from \"react-dom\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useParams, useNavigate } from \"react-router-dom\";\r\nimport {\r\n  ArrowLeft,\r\n  Phone,\r\n  Mail,\r\n  MessageSquare,\r\n  DollarSign,\r\n  User,\r\n  Edit2,\r\n  Trash2,\r\n  Plus,\r\n  Paperclip,\r\n  Mic,\r\n  PhoneCall,\r\n  MessageCircle,\r\n  MailIcon,\r\n  StickyNote,\r\n  GitBranch,\r\n  CalendarPlus,\r\n  CheckCircle,\r\n  Pause,\r\n  FileText,\r\n  ChevronDown,\r\n  ChevronRight,\r\n  Merge,\r\n  Upload,\r\n  Zap,\r\n  Facebook,\r\n  Link2,\r\n  Settings,\r\n  Loader2,\r\n  Calendar,\r\n  Clock,\r\n  MapPin,\r\n} from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent } from \"@/components/ui/card\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { StageBadge } from \"@/components/ui/stage-badge\";\r\nimport { GroupBadge } from \"@/components/ui/group-badge\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { Progress } from \"@/components/ui/progress\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\";\r\nimport {\r\n  Collapsible,\r\n  CollapsibleContent,\r\n  CollapsibleTrigger,\r\n} from \"@/components/ui/collapsible\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogFooter,\r\n} from \"@/components/ui/dialog\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport { useStages } from \"@/contexts/StagesContext\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { toast } from \"sonner\";\r\nimport { formatDistanceToNow } from \"date-fns\";\r\nimport { ActivityTimeline } from \"@/components/leads/ActivityTimeline\";\r\nimport { LeadDetailFAB } from \"@/components/leads/LeadDetailFAB\";\r\nimport { useLeadActivities, LeadInfo } from \"@/hooks/useLeadActivities\";\r\nimport { useLead } from \"@/hooks/useLead\";\r\nimport { PullToRefresh } from \"@/components/ui/pull-to-refresh\";\r\nimport { LeadDetailSkeleton } from \"@/components/ui/page-skeletons\";\r\nimport { LeadGroupSelector } from \"@/components/leads/LeadGroupSelector\";\r\nimport { LeadAssignedSelector } from \"@/components/leads/LeadAssignedSelector\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { useLocalization } from \"@/contexts/LocalizationContext\";\r\n\r\nconst timelineIcons: Record<string, any> = {\r\n  call: PhoneCall,\r\n  email: MailIcon,\r\n  whatsapp: MessageCircle,\r\n  note: StickyNote,\r\n  stage: GitBranch,\r\n  followup: CalendarPlus,\r\n  task: CheckCircle,\r\n  voicenote: Mic,\r\n  automation: Zap,\r\n  attachment: Paperclip,\r\n};\r\n\r\nexport default function LeadDetailPage() {\r\n  const { t } = useLocalization();\r\n\r\n  const { id } = useParams();\r\n  const navigate = useNavigate();\r\n  const isMobile = useIsMobile();\r\n  const { stages } = useStages();\r\n  const { profile } = useAuth();\r\n\r\n  // Fetch lead data from database\r\n  const { lead, isLoading: isLoadingLead, error: leadError, refetch } = useLead(id);\r\n\r\n  const [currentStage, setCurrentStage] = useState(\"\");\r\n  const [isRecording, setIsRecording] = useState(false);\r\n  const [recordingTime, setRecordingTime] = useState(0);\r\n  const [showVoiceModal, setShowVoiceModal] = useState(false);\r\n  const [voiceCaption, setVoiceCaption] = useState(\"\");\r\n  const [activeTab, setActiveTab] = useState<\"details\" | \"activity\">(\"details\");\r\n  const [expandedSections, setExpandedSections] = useState({\r\n    basic: true,\r\n    form: true,\r\n    tracking: false,\r\n  });\r\n  const [audioBlob, setAudioBlob] = useState<Blob | null>(null);\r\n  const [audioUrl, setAudioUrl] = useState<string | null>(null);\r\n  const [isSavingVoice, setIsSavingVoice] = useState(false);\r\n\r\n  // Dialog states for FAB\r\n  const [showNoteDialog, setShowNoteDialog] = useState(false);\r\n  const [showAttachmentDialog, setShowAttachmentDialog] = useState(false);\r\n  const [showMeetingDialog, setShowMeetingDialog] = useState(false);\r\n  const [showFollowupDialog, setShowFollowupDialog] = useState(false);\r\n\r\n  const mediaRecorderRef = useRef<MediaRecorder | null>(null);\r\n  const audioChunksRef = useRef<Blob[]>([]);\r\n  const timerRef = useRef<NodeJS.Timeout | null>(null);\r\n\r\n  // Create lead info for activities hook\r\n  const leadInfo = lead ? {\r\n    id: lead.id,\r\n    name: lead.name,\r\n    created_at: lead.created_at,\r\n    source: lead.source,\r\n    assigned_agent_id: lead.assigned_agent_id,\r\n    agent: lead.agent,\r\n  } : null;\r\n\r\n  // Use realtime activities hook with lead info for system activities\r\n  const { activities: realtimeActivities, isLoading: isLoadingActivities, addActivity, refetch: refetchActivities } = useLeadActivities(id || \"\", leadInfo);\r\n\r\n  // Timer for recording\r\n  useEffect(() => {\r\n    if (isRecording) {\r\n      timerRef.current = setInterval(() => {\r\n        setRecordingTime((prev) => prev + 1);\r\n      }, 1000);\r\n    } else {\r\n      if (timerRef.current) {\r\n        clearInterval(timerRef.current);\r\n        timerRef.current = null;\r\n      }\r\n    }\r\n    return () => {\r\n      if (timerRef.current) {\r\n        clearInterval(timerRef.current);\r\n      }\r\n    };\r\n  }, [isRecording]);\r\n\r\n  // Track previous stage to detect changes\r\n  const previousStageRef = useRef<string | null>(null);\r\n\r\n  // Initialize currentStage from lead data (prefer stage_id, fallback to stage text for backwards compatibility)\r\n  useEffect(() => {\r\n    if (lead && !currentStage) {\r\n      const stageId = lead.stage_id || lead.lead_stage?.id || lead.stage;\r\n      if (stageId) {\r\n        setCurrentStage(stageId);\r\n        previousStageRef.current = stageId;\r\n      }\r\n    }\r\n  }, [lead?.stage_id, lead?.lead_stage?.id, lead?.stage]);\r\n\r\n  // Handle stage change - update database and log activity\r\n  useEffect(() => {\r\n    const updateStage = async () => {\r\n      if (!lead || !currentStage || !previousStageRef.current) return;\r\n      if (currentStage === previousStageRef.current) return;\r\n\r\n      const oldStageName = stages.find(s => s.id === previousStageRef.current)?.name || previousStageRef.current;\r\n      const newStageName = stages.find(s => s.id === currentStage)?.name || currentStage;\r\n\r\n      // Update both stage_id (FK) and stage (text) for backwards compatibility\r\n      const { error } = await supabase\r\n        .from(\"leads\")\r\n        .update({\r\n          stage_id: currentStage,\r\n          stage: newStageName // Keep text field in sync for backwards compatibility\r\n        })\r\n        .eq(\"id\", lead.id);\r\n\r\n      if (error) {\r\n        console.error(\"Error updating stage:\", error);\r\n        toast.error(\"Failed to update stage\");\r\n        setCurrentStage(previousStageRef.current);\r\n        return;\r\n      }\r\n\r\n      // Log the stage change as an activity\r\n      await addActivity(\r\n        \"stage\",\r\n        `Stage changed to ${newStageName}`,\r\n        `From \"${oldStageName}\" to \"${newStageName}\"`,\r\n        lead.agent?.name || \"System\"\r\n      );\r\n\r\n      previousStageRef.current = currentStage;\r\n      toast.success(`Stage updated to ${newStageName}`);\r\n    };\r\n\r\n    updateStage();\r\n  }, [currentStage, lead, stages, addActivity]);\r\n\r\n  const handleRefresh = useCallback(async () => {\r\n    await Promise.all([refetch(), refetchActivities()]);\r\n    toast.success(\"Lead refreshed\");\r\n  }, [refetch, refetchActivities]);\r\n\r\n  const handleAddRealtimeNote = async (noteText: string, files?: File[]): Promise<boolean> => {\r\n    const success = await addActivity(\r\n      \"note\",\r\n      \"Note Added\",\r\n      noteText,\r\n      lead?.agent?.name || \"Agent\",\r\n      undefined,\r\n      files\r\n    );\r\n    return success;\r\n  };\r\n\r\n  const handleAddAttachment = async (description: string, files: File[]): Promise<boolean> => {\r\n    const success = await addActivity(\r\n      \"attachment\",\r\n      \"Files Attached\",\r\n      description || `${files.length} file(s) attached`,\r\n      lead?.agent?.name || \"Agent\",\r\n      undefined,\r\n      files\r\n    );\r\n    return success;\r\n  };\r\n\r\n  const handleAddMeeting = async (title: string, date: string, time: string, location: string, notes: string): Promise<boolean> => {\r\n    if (!lead || !profile?.company_id) return false;\r\n\r\n    const dateTimeStr = time ? `${date} at ${time}` : date;\r\n    const description = [\r\n      `Scheduled for ${dateTimeStr}`,\r\n      location && `Location: ${location}`,\r\n      notes && `Notes: ${notes}`,\r\n    ].filter(Boolean).join('\\n');\r\n\r\n    try {\r\n      // Create due_date from date and time\r\n      const dueDate = time ? new Date(`${date}T${time}`) : new Date(date);\r\n\r\n      // Save to lead_followups table for dashboard tracking\r\n      const { error: followupError } = await supabase\r\n        .from('lead_followups')\r\n        .insert({\r\n          lead_id: lead.id,\r\n          company_id: profile.company_id,\r\n          title: `Meeting: ${title}`,\r\n          description: description,\r\n          due_date: dueDate.toISOString(),\r\n          status: 'pending',\r\n          priority: 'medium',\r\n          created_by: profile.id,\r\n        });\r\n\r\n      if (followupError) {\r\n        console.error(\"Error saving meeting:\", followupError);\r\n        toast.error(\"Failed to schedule meeting\");\r\n        return false;\r\n      }\r\n\r\n      // Also add as activity for timeline\r\n      const success = await addActivity(\r\n        \"meeting\",\r\n        title,\r\n        description,\r\n        lead?.agent?.name || \"Agent\"\r\n      );\r\n\r\n      toast.success(\"Meeting scheduled successfully\");\r\n      return success;\r\n    } catch (error) {\r\n      console.error(\"Error adding meeting:\", error);\r\n      toast.error(\"Failed to schedule meeting\");\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const handleAddFollowup = async (title: string, date: string, time: string, priority: string, notes: string): Promise<boolean> => {\r\n    if (!lead || !profile?.company_id) return false;\r\n\r\n    const dateTimeStr = time ? `${date} at ${time}` : date;\r\n    const description = [\r\n      `Due: ${dateTimeStr}`,\r\n      `Priority: ${priority}`,\r\n      notes && `Notes: ${notes}`,\r\n    ].filter(Boolean).join('\\n');\r\n\r\n    try {\r\n      // Create due_date from date and time\r\n      const dueDate = time ? new Date(`${date}T${time}`) : new Date(date);\r\n\r\n      // Save to lead_followups table for dashboard tracking\r\n      const { error: followupError } = await supabase\r\n        .from('lead_followups')\r\n        .insert({\r\n          lead_id: lead.id,\r\n          company_id: profile.company_id,\r\n          title: title,\r\n          description: notes || '',\r\n          due_date: dueDate.toISOString(),\r\n          status: 'pending',\r\n          priority: priority,\r\n          created_by: profile.id,\r\n        });\r\n\r\n      if (followupError) {\r\n        console.error(\"Error saving follow-up:\", followupError);\r\n        toast.error(\"Failed to create follow-up\");\r\n        return false;\r\n      }\r\n\r\n      // Also add as activity for timeline\r\n      const success = await addActivity(\r\n        \"followup\",\r\n        title,\r\n        description,\r\n        lead?.agent?.name || \"Agent\"\r\n      );\r\n\r\n      toast.success(\"Follow-up created successfully\");\r\n      return success;\r\n    } catch (error) {\r\n      console.error(\"Error adding follow-up:\", error);\r\n      toast.error(\"Failed to create follow-up\");\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const toggleSection = (section: keyof typeof expandedSections) => {\r\n    setExpandedSections(prev => ({ ...prev, [section]: !prev[section] }));\r\n  };\r\n\r\n  const handleStartRecording = async () => {\r\n    try {\r\n      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\r\n      const mediaRecorder = new MediaRecorder(stream);\r\n      mediaRecorderRef.current = mediaRecorder;\r\n      audioChunksRef.current = [];\r\n\r\n      mediaRecorder.ondataavailable = (event) => {\r\n        if (event.data.size > 0) {\r\n          audioChunksRef.current.push(event.data);\r\n        }\r\n      };\r\n\r\n      mediaRecorder.onstop = () => {\r\n        const blob = new Blob(audioChunksRef.current, { type: 'audio/webm' });\r\n        setAudioBlob(blob);\r\n        const url = URL.createObjectURL(blob);\r\n        setAudioUrl(url);\r\n        stream.getTracks().forEach(track => track.stop());\r\n      };\r\n\r\n      mediaRecorder.start();\r\n      setIsRecording(true);\r\n      setRecordingTime(0);\r\n      toast.info(\"Recording started...\");\r\n    } catch (error) {\r\n      console.error(\"Error accessing microphone:\", error);\r\n      toast.error(\"Could not access microphone. Please allow microphone permissions.\");\r\n    }\r\n  };\r\n\r\n  const handleStopRecording = () => {\r\n    if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {\r\n      mediaRecorderRef.current.stop();\r\n    }\r\n    setIsRecording(false);\r\n  };\r\n\r\n  const handleSaveVoiceNote = async () => {\r\n    if (!audioBlob) {\r\n      toast.error(\"No recording to save\");\r\n      return;\r\n    }\r\n\r\n    setIsSavingVoice(true);\r\n    try {\r\n      // Convert blob to file for upload\r\n      const durationStr = `${Math.floor(recordingTime / 60)}:${String(recordingTime % 60).padStart(2, '0')}`;\r\n      const audioFile = new File([audioBlob], `voice-note-${Date.now()}.webm`, { type: 'audio/webm' });\r\n\r\n      // Upload voice note file\r\n      const fileName = `${id}/${Date.now()}-voice-note.webm`;\r\n      const { data: uploadData, error: uploadError } = await supabase.storage\r\n        .from('activity-attachments')\r\n        .upload(fileName, audioBlob);\r\n\r\n      let audioUrlToSave: string | undefined;\r\n      if (!uploadError && uploadData) {\r\n        const { data: urlData } = supabase.storage\r\n          .from('activity-attachments')\r\n          .getPublicUrl(uploadData.path);\r\n        audioUrlToSave = urlData.publicUrl;\r\n      }\r\n\r\n      // Save voice note as activity with audio URL\r\n      const { error: activityError } = await supabase\r\n        .from(\"lead_activities\")\r\n        .insert({\r\n          lead_id: id,\r\n          type: \"voicenote\",\r\n          title: \"Voice Note Added\",\r\n          description: voiceCaption || \"Voice note recording\",\r\n          agent_name: lead?.agent?.name || \"Agent\",\r\n          duration: durationStr,\r\n          audio_url: audioUrlToSave,\r\n          attachments: [],\r\n          attachments_count: 0,\r\n        });\r\n\r\n      if (activityError) {\r\n        throw activityError;\r\n      }\r\n\r\n      toast.success(\"Voice note saved\");\r\n      setShowVoiceModal(false);\r\n      setVoiceCaption(\"\");\r\n      setRecordingTime(0);\r\n      setAudioBlob(null);\r\n      if (audioUrl) {\r\n        URL.revokeObjectURL(audioUrl);\r\n        setAudioUrl(null);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error saving voice note:\", error);\r\n      toast.error(\"Failed to save voice note\");\r\n    } finally {\r\n      setIsSavingVoice(false);\r\n    }\r\n  };\r\n\r\n  const handleCancelVoiceModal = () => {\r\n    setShowVoiceModal(false);\r\n    setIsRecording(false);\r\n    setRecordingTime(0);\r\n    setAudioBlob(null);\r\n    if (audioUrl) {\r\n      URL.revokeObjectURL(audioUrl);\r\n      setAudioUrl(null);\r\n    }\r\n    if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {\r\n      mediaRecorderRef.current.stop();\r\n    }\r\n  };\r\n\r\n  const SectionHeader = ({\r\n    title,\r\n    section,\r\n    icon: Icon\r\n  }: {\r\n    title: string;\r\n    section: keyof typeof expandedSections;\r\n    icon: any;\r\n  }) => (\r\n    <CollapsibleTrigger className=\"flex items-center justify-between w-full py-3 hover:bg-muted/50 rounded-lg px-2 -mx-2\">\r\n      <div className=\"flex items-center gap-2\">\r\n        <Icon className=\"h-4 w-4 text-muted-foreground\" />\r\n        <span className=\"font-semibold text-sm\">{title}</span>\r\n      </div>\r\n      {expandedSections[section] ? (\r\n        <ChevronDown className=\"h-4 w-4 text-muted-foreground\" />\r\n      ) : (\r\n        <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\r\n      )}\r\n    </CollapsibleTrigger>\r\n  );\r\n\r\n  // Loading state\r\n  if (isLoadingLead) {\r\n    return <LeadDetailSkeleton isMobile={isMobile} />;\r\n  }\r\n  // Error or not found state\r\n  if (leadError || !lead) {\r\n    return (\r\n      <div className=\"flex flex-col items-center justify-center h-[60vh] gap-4\">\r\n        <p className=\"text-muted-foreground\">Lead not found</p>\r\n        <Button onClick={() => navigate(\"/leads\")}>\r\n          <ArrowLeft className=\"h-4 w-4 mr-2\" />\r\n          Back to Leads\r\n        </Button>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Combine form data from multiple sources\r\n  const sourceMetadata = lead.source_metadata as Record<string, any> | null;\r\n  const mappedFields = lead.mapped_fields as Record<string, any> | null;\r\n  const rawFormData = lead.form_data as Record<string, any> | null;\r\n\r\n  // Build comprehensive form data object\r\n  const formData: Record<string, any> = {\r\n    // From source_metadata\r\n    ...(sourceMetadata?.platform && { platform: sourceMetadata.platform }),\r\n    ...(sourceMetadata?.page_name && { page_name: sourceMetadata.page_name }),\r\n    ...(sourceMetadata?.form_name && { formName: sourceMetadata.form_name }),\r\n    ...(sourceMetadata?.form_id && { formId: sourceMetadata.form_id }),\r\n    ...(sourceMetadata?.ad_id && { ad_id: sourceMetadata.ad_id }),\r\n    ...(sourceMetadata?.adgroup_id && { adgroup_id: sourceMetadata.adgroup_id }),\r\n    ...(sourceMetadata?.created_time && { submittedAt: sourceMetadata.created_time }),\r\n    ...(sourceMetadata?.webhook && { sync_method: 'Webhook' }),\r\n    // From lead columns\r\n    ...(lead.form_name && { formName: lead.form_name }),\r\n    ...(lead.form_id && { formId: lead.form_id }),\r\n    ...(lead.campaign_name && { campaignName: lead.campaign_name }),\r\n    ...(lead.ad_set_name && { adSetName: lead.ad_set_name }),\r\n    ...(lead.ad_name && { adName: lead.ad_name }),\r\n    ...(lead.fetched_at && { fetchedAt: lead.fetched_at }),\r\n    ...(lead.external_id && { external_id: lead.external_id }),\r\n    // From mapped_fields (actual form field values)\r\n    ...mappedFields,\r\n    // From form_data (legacy)\r\n    ...rawFormData,\r\n  };\r\n\r\n  const hasFormData = Object.keys(formData).length > 0;\r\n\r\n  const content = (\r\n    <div className=\"space-y-4 sm:space-y-6 lg:space-y-8 pb-20 sm:pb-0 overflow-x-hidden\" style={{ touchAction: 'pan-y' }}>\r\n      {/* Top Header */}\r\n      <div className=\"bg-card border rounded-xl p-3 sm:p-4 shadow-sm\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              onClick={() => navigate(\"/leads\")}\r\n              className=\"h-9 w-9 rounded-full hover:bg-primary/10 transition-colors\"\r\n            >\r\n              <ArrowLeft className=\"h-4 w-4\" />\r\n            </Button>\r\n            <div>\r\n              <h1 className=\"font-semibold text-base sm:text-lg\">{lead.name}</h1>\r\n              <p className=\"text-xs text-muted-foreground hidden sm:block\">Lead Details</p>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-1.5\">\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              className=\"h-10 w-10 min-h-[40px] min-w-[40px] rounded-full hover:bg-primary/10 transition-colors\"\r\n            >\r\n              <Edit2 className=\"h-5 w-5\" />\r\n            </Button>\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              className=\"h-9 w-9 rounded-full hover:bg-primary/10 transition-colors hidden sm:flex\"\r\n            >\r\n              <Merge className=\"h-4 w-4\" />\r\n            </Button>\r\n            <DropdownMenu>\r\n              <DropdownMenuTrigger asChild>\r\n                <Button\r\n                  variant=\"ghost\"\r\n                  size=\"icon\"\r\n                  className=\"h-9 w-9 rounded-full hover:bg-destructive/10 text-destructive transition-colors\"\r\n                >\r\n                  <Trash2 className=\"h-4 w-4\" />\r\n                </Button>\r\n              </DropdownMenuTrigger>\r\n              <DropdownMenuContent align=\"end\" className=\"bg-popover\">\r\n                <DropdownMenuItem className=\"text-destructive focus:text-destructive\">\r\n                  <Trash2 className=\"h-4 w-4 mr-2\" />\r\n                  Delete Lead\r\n                </DropdownMenuItem>\r\n              </DropdownMenuContent>\r\n            </DropdownMenu>\r\n          </div>\r\n        </div>\r\n\r\n\r\n        {/* Tab Navigation - Mobile */}\r\n        <div className=\"mt-4 lg:hidden\">\r\n          <div className=\"flex bg-muted/50 rounded-lg p-1 gap-1\">\r\n            <button\r\n              onClick={() => setActiveTab(\"details\")}\r\n              className={cn(\r\n                \"flex-1 py-2.5 px-4 text-sm font-medium rounded-lg transition-all duration-200\",\r\n                activeTab === \"details\"\r\n                  ? \"bg-background text-primary shadow-sm border border-border/50\"\r\n                  : \"text-muted-foreground hover:text-foreground hover:bg-background/50\"\r\n              )}\r\n            >\r\n              Details\r\n            </button>\r\n            <button\r\n              onClick={() => setActiveTab(\"activity\")}\r\n              className={cn(\r\n                \"flex-1 py-2.5 px-4 text-sm font-medium rounded-lg transition-all duration-200\",\r\n                activeTab === \"activity\"\r\n                  ? \"bg-background text-primary shadow-sm border border-border/50\"\r\n                  : \"text-muted-foreground hover:text-foreground hover:bg-background/50\"\r\n              )}\r\n            >\r\n              Activity\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Desktop: Side by Side Layout */}\r\n      <div className=\"hidden lg:grid lg:grid-cols-5 gap-6 lg:gap-8\">\r\n        {/* Left Column - Lead Information */}\r\n        <div className=\"lg:col-span-2 space-y-4 sm:space-y-6\">\r\n          {/* Lead Header Card */}\r\n          <Card>\r\n            <div className=\"bg-gradient-to-r from-primary/10 via-primary/5 to-transparent p-4 sm:p-6\">\r\n              <div className=\"flex items-start gap-3 sm:gap-4\">\r\n                <Avatar className=\"h-12 w-12 sm:h-16 sm:w-16 border-2 sm:border-4 border-card shadow-lg flex-shrink-0\">\r\n                  <AvatarImage src={`https://api.dicebear.com/7.x/initials/svg?seed=${lead.name}`} />\r\n                  <AvatarFallback className=\"text-xl\">{lead.name.split(\" \").map(n => n[0]).join(\"\")}</AvatarFallback>\r\n                </Avatar>\r\n                <div className=\"flex-1 min-w-0\">\r\n                  <h2 className=\"text-xl font-bold truncate\">{lead.name}</h2>\r\n                  {lead.phone && (\r\n                    <div className=\"flex items-center gap-2 mt-1 text-sm text-muted-foreground\">\r\n                      <Phone className=\"h-3.5 w-3.5\" />\r\n                      <span>{lead.phone}</span>\r\n                    </div>\r\n                  )}\r\n                  {lead.email && (\r\n                    <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\r\n                      <Mail className=\"h-3.5 w-3.5\" />\r\n                      <span className=\"truncate\">{lead.email}</span>\r\n                    </div>\r\n                  )}\r\n                  {lead.agent && (\r\n                    <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\r\n                      <User className=\"h-3.5 w-3.5\" />\r\n                      <span>Assigned: {lead.agent.name}</span>\r\n                    </div>\r\n                  )}\r\n                  <div className=\"flex flex-wrap items-center gap-2 mt-2\">\r\n                    <StageBadge stage={lead.stage || \"New\"} showTooltip />\r\n                    {lead.lead_group && (\r\n                      <GroupBadge\r\n                        groupId={lead.lead_group?.id}\r\n                        groupName={lead.lead_group?.name}\r\n                        groupColor={lead.lead_group?.color}\r\n                        showTooltip\r\n                      />\r\n                    )}\r\n                  </div>\r\n                  <div className=\"flex flex-wrap items-center gap-2 mt-2\">\r\n                    {lead.agent ? (\r\n                      <Badge variant=\"secondary\" className=\"text-xs font-medium bg-green-100 text-green-700 border-green-200\">\r\n                        Assigned to {lead.agent.name}\r\n                      </Badge>\r\n                    ) : (\r\n                      <Badge variant=\"secondary\" className=\"text-xs font-medium bg-orange-100 text-orange-700 border-orange-200\">\r\n                        Unassigned\r\n                      </Badge>\r\n                    )}\r\n                    {lead.source && (\r\n                      <Badge variant=\"outline\" className=\"bg-blue-50 text-blue-700 border-blue-200\">\r\n                        {lead.source}\r\n                      </Badge>\r\n                    )}\r\n                  </div>\r\n                  {lead.tags && lead.tags.length > 0 && (\r\n                    <div className=\"flex flex-wrap gap-1 mt-2\">\r\n                      {lead.tags.map((tag) => (\r\n                        <Badge key={tag} variant=\"secondary\" className=\"text-xs\">{tag}</Badge>\r\n                      ))}\r\n                      <Button variant=\"ghost\" size=\"sm\" className=\"h-5 px-1\">\r\n                        <Plus className=\"h-3 w-3\" />\r\n                      </Button>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              {/* Lead Score */}\r\n              {lead.lead_score !== null && lead.lead_score > 0 && (\r\n                <div className=\"mt-4 p-3 bg-card/80 rounded-lg\">\r\n                  <div className=\"flex items-center justify-between mb-2\">\r\n                    <span className=\"text-sm font-medium\">Lead Score</span>\r\n                    <span className=\"text-sm font-bold text-primary\">{lead.lead_score}/100</span>\r\n                  </div>\r\n                  <Progress value={lead.lead_score} className=\"h-2\" />\r\n                </div>\r\n              )}\r\n\r\n              {/* Communication Buttons */}\r\n              <div className=\"grid grid-cols-3 gap-2 mt-4\">\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  className=\"h-9\"\r\n                  onClick={async () => {\r\n                    if (lead.phone) {\r\n                      await addActivity(\r\n                        \"call\",\r\n                        \"Outbound Call\",\r\n                        `Called ${lead.phone}`,\r\n                        lead.agent?.name || \"Agent\"\r\n                      );\r\n                      window.open(`tel:${lead.phone}`);\r\n                    }\r\n                  }}\r\n                  disabled={!lead.phone}\r\n                >\r\n                  <Phone className=\"h-4 w-4 mr-1.5\" />\r\n                  Call\r\n                </Button>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  className=\"h-9\"\r\n                  onClick={async () => {\r\n                    if (lead.phone) {\r\n                      await addActivity(\r\n                        \"whatsapp\",\r\n                        \"WhatsApp Message\",\r\n                        `Opened WhatsApp chat with ${lead.phone}`,\r\n                        lead.agent?.name || \"Agent\"\r\n                      );\r\n                      window.open(`https://wa.me/${lead.phone.replace(/\\D/g, '')}`);\r\n                    }\r\n                  }}\r\n                  disabled={!lead.phone}\r\n                >\r\n                  <MessageSquare className=\"h-4 w-4 mr-1.5\" />\r\n                  WhatsApp\r\n                </Button>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  className=\"h-9\"\r\n                  onClick={async () => {\r\n                    if (lead.email) {\r\n                      await addActivity(\r\n                        \"email\",\r\n                        \"Email Sent\",\r\n                        `Opened email to ${lead.email}`,\r\n                        lead.agent?.name || \"Agent\"\r\n                      );\r\n                      window.open(`mailto:${lead.email}`);\r\n                    }\r\n                  }}\r\n                  disabled={!lead.email}\r\n                >\r\n                  <Mail className=\"h-4 w-4 mr-1.5\" />{t('email')}</Button>\r\n              </div>\r\n            </div>\r\n\r\n            <CardContent className=\"p-4 space-y-4\">\r\n              {/* Stage Selector */}\r\n              <div className=\"space-y-2\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <Label className=\"text-xs text-muted-foreground\">Lead Stage</Label>\r\n                  <Button\r\n                    variant=\"ghost\"\r\n                    size=\"sm\"\r\n                    className=\"h-6 px-2 text-xs text-muted-foreground hover:text-primary\"\r\n                    onClick={() => {\r\n                      navigate(\"/leads\");\r\n                      toast.info(\"Go to Leads page to manage stages\");\r\n                    }}\r\n                  >\r\n                    <Settings className=\"h-3 w-3 mr-1\" />\r\n                    Manage Stages\r\n                  </Button>\r\n                </div>\r\n                <Select value={currentStage || lead.stage || \"\"} onValueChange={setCurrentStage}>\r\n                  <SelectTrigger className=\"h-10\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <span\r\n                        className=\"w-2.5 h-2.5 rounded-full\"\r\n                        style={{ backgroundColor: stages.find(s => s.id === (currentStage || lead.stage))?.color || \"#3B82F6\" }}\r\n                      />\r\n                      <SelectValue />\r\n                    </div>\r\n                  </SelectTrigger>\r\n                  <SelectContent className=\"bg-popover\">\r\n                    {stages.map((stage) => (\r\n                      <SelectItem key={stage.id} value={stage.id}>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <span\r\n                            className=\"w-2 h-2 rounded-full\"\r\n                            style={{ backgroundColor: stage.color }}\r\n                          />\r\n                          {stage.name}\r\n                        </div>\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n\r\n              {/* Lead Group Selector */}\r\n              <LeadGroupSelector\r\n                leadId={lead.id}\r\n                currentGroupId={lead.lead_group_id}\r\n                agentName={lead.agent?.name}\r\n                onGroupChange={() => refetch()}\r\n              />\r\n\r\n              {/* Assigned Agent Selector */}\r\n              <LeadAssignedSelector\r\n                leadId={lead.id}\r\n                currentAgentId={lead.assigned_agent_id}\r\n                currentAgentName={lead.agent?.name}\r\n                onAgentChange={() => refetch()}\r\n              />\r\n\r\n              {/* Budget */}\r\n              <div className=\"space-y-1\">\r\n                <Label className=\"text-xs text-muted-foreground\">Budget (Optional)</Label>\r\n                <div className=\"relative\">\r\n                  <DollarSign className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n                  <Input\r\n                    type=\"text\"\r\n                    placeholder=\"e.g. 2,500,000\"\r\n                    defaultValue={lead.budget || \"\"}\r\n                    className=\"h-9 pl-9\"\r\n                  />\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Lead Info Card - Dates & Location */}\r\n          <Card>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center gap-2 mb-3\">\r\n                <Calendar className=\"h-4 w-4 text-muted-foreground\" />\r\n                <span className=\"font-semibold text-sm\">Lead Info</span>\r\n              </div>\r\n              <div className=\"space-y-2 text-sm\">\r\n                <div className=\"flex items-center justify-between py-1.5 border-b border-dashed\">\r\n                  <span className=\"text-muted-foreground flex items-center gap-2\">\r\n                    <Calendar className=\"h-3.5 w-3.5\" />{t('created')}</span>\r\n                  <span className=\"font-medium text-right\">\r\n                    <span>{new Date(lead.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>\r\n                    <span className=\"text-xs text-muted-foreground ml-1\">({formatDistanceToNow(new Date(lead.created_at), { addSuffix: true })})</span>\r\n                  </span>\r\n                </div>\r\n                {lead.last_contacted_at && (\r\n                  <div className=\"flex items-center justify-between py-1.5 border-b border-dashed\">\r\n                    <span className=\"text-muted-foreground flex items-center gap-2\">\r\n                      <Clock className=\"h-3.5 w-3.5\" />\r\n                      Last Contacted\r\n                    </span>\r\n                    <span className=\"font-medium text-right\">\r\n                      <span>{new Date(lead.last_contacted_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>\r\n                      <span className=\"text-xs text-muted-foreground ml-1\">({formatDistanceToNow(new Date(lead.last_contacted_at), { addSuffix: true })})</span>\r\n                    </span>\r\n                  </div>\r\n                )}\r\n                {lead.location && (\r\n                  <div className=\"flex items-center justify-between py-1.5 border-b border-dashed\">\r\n                    <span className=\"text-muted-foreground flex items-center gap-2\">\r\n                      <MapPin className=\"h-3.5 w-3.5\" />\r\n                      Location\r\n                    </span>\r\n                    <span className=\"font-medium\">{lead.location}</span>\r\n                  </div>\r\n                )}\r\n                {lead.requirements && (\r\n                  <div className=\"flex items-center justify-between py-1.5\">\r\n                    <span className=\"text-muted-foreground\">Requirements</span>\r\n                    <span className=\"font-medium text-right max-w-[60%] truncate\">{lead.requirements}</span>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Details - Form Submission */}\r\n          <Card>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center gap-2 mb-3\">\r\n                <FileText className=\"h-4 w-4 text-muted-foreground\" />\r\n                <span className=\"font-semibold text-sm\">Details</span>\r\n              </div>\r\n\r\n              {hasFormData ? (\r\n                <div className=\"space-y-3\">\r\n                  {/* Platform Header */}\r\n                  <div className=\"flex items-center gap-2 p-3 bg-blue-50 dark:bg-blue-950/30 rounded-lg border border-blue-100 dark:border-blue-900/50\">\r\n                    <Facebook className=\"h-5 w-5 text-blue-600\" />\r\n                    <div>\r\n                      <p className=\"text-sm font-medium text-blue-700 dark:text-blue-400\">\r\n                        {formData.platform === 'meta' ? 'Meta Lead Form' : 'Lead Form'}\r\n                      </p>\r\n                      <p className=\"text-xs text-blue-600 dark:text-blue-500\">\r\n                        {formData.formName || formData.form_name || \"Form Submission\"}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Form Details */}\r\n                  <div className=\"space-y-2 text-sm\">\r\n                    {/* Campaign Info */}\r\n                    {formData.campaignName && (\r\n                      <div className=\"flex justify-between py-1.5 border-b border-dashed border-border/50\">\r\n                        <span className=\"text-muted-foreground\">Campaign</span>\r\n                        <span className=\"font-medium\">{formData.campaignName}</span>\r\n                      </div>\r\n                    )}\r\n                    {formData.adSetName && (\r\n                      <div className=\"flex justify-between py-1.5 border-b border-dashed border-border/50\">\r\n                        <span className=\"text-muted-foreground\">Ad Set</span>\r\n                        <span>{formData.adSetName}</span>\r\n                      </div>\r\n                    )}\r\n                    {formData.adName && (\r\n                      <div className=\"flex justify-between py-1.5 border-b border-dashed border-border/50\">\r\n                        <span className=\"text-muted-foreground\">Ad</span>\r\n                        <span>{formData.adName}</span>\r\n                      </div>\r\n                    )}\r\n                    {formData.page_name && (\r\n                      <div className=\"flex justify-between py-1.5 border-b border-dashed border-border/50\">\r\n                        <span className=\"text-muted-foreground\">Page</span>\r\n                        <span>{formData.page_name}</span>\r\n                      </div>\r\n                    )}\r\n\r\n                    {/* All other form fields */}\r\n                    {Object.entries(formData)\r\n                      .filter(([key]) => ![\"formName\", \"form_name\", \"campaignName\", \"adSetName\", \"adName\", \"formId\", \"form_id\", \"submittedAt\", \"platform\", \"page_name\", \"ad_id\", \"adgroup_id\", \"webhook\", \"sync_method\", \"fetchedAt\", \"external_id\", \"raw_data\"].includes(key))\r\n                      .filter(([_, value]) => value !== null && value !== undefined && value !== '')\r\n                      .map(([key, value]) => (\r\n                        <div key={key} className=\"flex justify-between py-1.5 border-b border-dashed border-border/50 last:border-0\">\r\n                          <span className=\"text-muted-foreground capitalize\">{key.replace(/_/g, \" \")}</span>\r\n                          <span className=\"text-right max-w-[60%] break-words\">{String(value)}</span>\r\n                        </div>\r\n                      ))\r\n                    }\r\n\r\n                    {/* Metadata */}\r\n                    {(formData.formId || formData.form_id) && (\r\n                      <div className=\"flex justify-between py-1.5 border-b border-dashed border-border/50\">\r\n                        <span className=\"text-muted-foreground\">Form ID</span>\r\n                        <span className=\"text-xs font-mono opacity-70\">{formData.formId || formData.form_id}</span>\r\n                      </div>\r\n                    )}\r\n                    {formData.external_id && (\r\n                      <div className=\"flex justify-between py-1.5 border-b border-dashed border-border/50\">\r\n                        <span className=\"text-muted-foreground\">Lead ID</span>\r\n                        <span className=\"text-xs font-mono opacity-70\">{formData.external_id}</span>\r\n                      </div>\r\n                    )}\r\n                    {formData.sync_method && (\r\n                      <div className=\"flex justify-between py-1.5 border-b border-dashed border-border/50\">\r\n                        <span className=\"text-muted-foreground\">Sync Method</span>\r\n                        <Badge variant=\"secondary\" className=\"text-xs\">{formData.sync_method}</Badge>\r\n                      </div>\r\n                    )}\r\n                    {formData.fetchedAt && (\r\n                      <div className=\"flex justify-between py-1.5\">\r\n                        <span className=\"text-muted-foreground\">Fetched At</span>\r\n                        <span className=\"text-xs opacity-70\">{new Date(formData.fetchedAt).toLocaleString()}</span>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              ) : (\r\n                <p className=\"text-sm text-muted-foreground\">No form submission details available.</p>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Assigned Agent Card */}\r\n          {lead.agent && (\r\n            <Card>\r\n              <CardContent className=\"p-4\">\r\n                <div className=\"flex items-center gap-2 mb-3\">\r\n                  <User className=\"h-4 w-4 text-muted-foreground\" />\r\n                  <span className=\"font-semibold text-sm\">Assigned Agent</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-3\">\r\n                  <Avatar className=\"h-12 w-12 border-2 border-primary/20\">\r\n                    <AvatarImage src={lead.agent.avatar_url || `https://api.dicebear.com/7.x/initials/svg?seed=${lead.agent.name}`} />\r\n                    <AvatarFallback className=\"bg-primary/10 text-primary font-semibold\">\r\n                      {lead.agent.name.split(\" \").map(n => n[0]).join(\"\")}\r\n                    </AvatarFallback>\r\n                  </Avatar>\r\n                  <div className=\"flex-1\">\r\n                    <p className=\"font-medium\">{lead.agent.name}</p>\r\n                    <p className=\"text-xs text-muted-foreground\">Sales Agent</p>\r\n                  </div>\r\n                </div>\r\n                <div className=\"grid grid-cols-2 gap-2 mt-3\">\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    className=\"h-8 text-xs\"\r\n                    onClick={() => window.open(`tel:+971500000000`)}\r\n                  >\r\n                    <Phone className=\"h-3.5 w-3.5 mr-1\" />\r\n                    Call\r\n                  </Button>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    className=\"h-8 text-xs\"\r\n                    onClick={() => window.open(`https://wa.me/971500000000`)}\r\n                  >\r\n                    <MessageSquare className=\"h-3.5 w-3.5 mr-1\" />\r\n                    Message\r\n                  </Button>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          )}\r\n        </div>\r\n\r\n        {/* Right Column - Activity Timeline */}\r\n        <div className=\"lg:col-span-3\">\r\n          <ActivityTimeline\r\n            timelineData={realtimeActivities}\r\n            onOpenVoiceModal={() => setShowVoiceModal(true)}\r\n            onAddNote={handleAddRealtimeNote}\r\n            onAddAttachment={handleAddAttachment}\r\n            onAddMeeting={handleAddMeeting}\r\n            onAddFollowup={handleAddFollowup}\r\n            isLoading={isLoadingActivities}\r\n            showNoteDialog={showNoteDialog}\r\n            onNoteDialogChange={setShowNoteDialog}\r\n            showAttachmentDialog={showAttachmentDialog}\r\n            onAttachmentDialogChange={setShowAttachmentDialog}\r\n            showMeetingDialog={showMeetingDialog}\r\n            onMeetingDialogChange={setShowMeetingDialog}\r\n            showFollowupDialog={showFollowupDialog}\r\n            onFollowupDialogChange={setShowFollowupDialog}\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Mobile: Tab Content */}\r\n      <div className=\"lg:hidden\">\r\n        <div className=\"touch-pan-y\">\r\n          {activeTab === \"details\" ? (\r\n            <div className=\"space-y-3\">\r\n              {/* Lead Info Card with contact info */}\r\n              <Card className=\"border-0 shadow-sm overflow-hidden\">\r\n                <CardContent className=\"p-4\">\r\n                  <div className=\"flex items-start gap-3\">\r\n                    <Avatar className=\"h-14 w-14 border-2 border-background shadow-md flex-shrink-0\">\r\n                      <AvatarImage src={`https://api.dicebear.com/7.x/initials/svg?seed=${lead.name}`} />\r\n                      <AvatarFallback className=\"text-lg font-bold bg-primary text-primary-foreground\">{lead.name.split(\" \").map(n => n[0]).join(\"\")}</AvatarFallback>\r\n                    </Avatar>\r\n                    <div className=\"flex-1 min-w-0\">\r\n                      <h2 className=\"text-xl font-bold truncate\">{lead.name}</h2>\r\n                      {lead.phone && (\r\n                        <div className=\"flex items-center gap-2 mt-1 text-muted-foreground\">\r\n                          <Phone className=\"h-4 w-4\" />\r\n                          <span className=\"text-sm\">{lead.phone}</span>\r\n                        </div>\r\n                      )}\r\n                      {lead.email && (\r\n                        <div className=\"flex items-center gap-2 text-muted-foreground\">\r\n                          <Mail className=\"h-4 w-4\" />\r\n                          <span className=\"text-sm truncate\">{lead.email}</span>\r\n                        </div>\r\n                      )}\r\n                      <div className=\"flex flex-wrap items-center gap-2 mt-2\">\r\n                        <StageBadge stage={lead.stage || \"New\"} showTooltip />\r\n                        {lead.lead_group && (\r\n                          <GroupBadge\r\n                            groupId={lead.lead_group?.id}\r\n                            groupName={lead.lead_group?.name}\r\n                            groupColor={lead.lead_group?.color}\r\n                            showTooltip\r\n                          />\r\n                        )}\r\n                      </div>\r\n                      <div className=\"flex flex-wrap items-center gap-2 mt-2\">\r\n                        {lead.agent ? (\r\n                          <Badge variant=\"secondary\" className=\"text-xs font-medium bg-green-100 text-green-700 border-green-200\">\r\n                            Assigned to {lead.agent.name}\r\n                          </Badge>\r\n                        ) : (\r\n                          <Badge variant=\"secondary\" className=\"text-xs font-medium bg-orange-100 text-orange-700 border-orange-200\">\r\n                            Unassigned\r\n                          </Badge>\r\n                        )}\r\n                        {lead.source && (\r\n                          <Badge variant=\"outline\" className=\"text-xs font-medium border-primary text-primary\">\r\n                            {lead.source}\r\n                          </Badge>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Communication Buttons - Outline Style */}\r\n                  <div className=\"grid grid-cols-3 gap-2 mt-4 pt-4 border-t border-border/50\">\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      className=\"h-10 gap-2 text-sm font-medium w-full\"\r\n                      type=\"button\"\r\n                      disabled={!lead.phone}\r\n                      onClick={async () => {\r\n                        if (lead.phone) {\r\n                          await addActivity(\r\n                            \"call\",\r\n                            \"Outbound Call\",\r\n                            `Called ${lead.phone}`,\r\n                            lead.agent?.name || \"Agent\"\r\n                          );\r\n                          window.open(`tel:${lead.phone}`);\r\n                        }\r\n                      }}\r\n                    >\r\n                      <Phone className=\"h-4 w-4\" />\r\n                      Call\r\n                    </Button>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      className=\"h-10 gap-2 text-sm font-medium border-green-500 text-green-600 hover:bg-green-50 w-full\"\r\n                      type=\"button\"\r\n                      disabled={!lead.phone}\r\n                      onClick={async () => {\r\n                        if (lead.phone) {\r\n                          await addActivity(\r\n                            \"whatsapp\",\r\n                            \"WhatsApp Message\",\r\n                            `Opened WhatsApp chat with ${lead.phone}`,\r\n                            lead.agent?.name || \"Agent\"\r\n                          );\r\n                          window.open(`https://wa.me/${lead.phone.replace(/\\D/g, '')}`, '_blank');\r\n                        }\r\n                      }}\r\n                    >\r\n                      <MessageSquare className=\"h-4 w-4\" />\r\n                      WhatsApp\r\n                    </Button>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      className=\"h-10 gap-2 text-sm font-medium w-full\"\r\n                      type=\"button\"\r\n                      disabled={!lead.email}\r\n                      onClick={async () => {\r\n                        if (lead.email) {\r\n                          await addActivity(\r\n                            \"email\",\r\n                            \"Email Sent\",\r\n                            `Opened email to ${lead.email}`,\r\n                            lead.agent?.name || \"Agent\"\r\n                          );\r\n                          window.open(`mailto:${lead.email}`);\r\n                        }\r\n                      }}\r\n                    >\r\n                      <Mail className=\"h-4 w-4\" />{t('email')}</Button>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              {/* Lead Stage, Group & Assignment */}\r\n              <Card className=\"border-0 shadow-sm\">\r\n                <CardContent className=\"p-4 space-y-4\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label className=\"text-sm text-muted-foreground\">Lead Stage</Label>\r\n                    <Select value={currentStage || lead.stage || \"\"} onValueChange={setCurrentStage}>\r\n                      <SelectTrigger className=\"h-12 bg-muted/30\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <span\r\n                            className=\"w-3 h-3 rounded-full\"\r\n                            style={{ backgroundColor: stages.find(s => s.id === (currentStage || lead.stage))?.color || \"#3B82F6\" }}\r\n                          />\r\n                          <SelectValue />\r\n                        </div>\r\n                      </SelectTrigger>\r\n                      <SelectContent className=\"bg-popover\">\r\n                        {stages.map((stage) => (\r\n                          <SelectItem key={stage.id} value={stage.id}>\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <span\r\n                                className=\"w-2.5 h-2.5 rounded-full\"\r\n                                style={{ backgroundColor: stage.color }}\r\n                              />\r\n                              {stage.name}\r\n                            </div>\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  {/* Lead Group Selector - Mobile */}\r\n                  <LeadGroupSelector\r\n                    leadId={lead.id}\r\n                    currentGroupId={lead.lead_group_id}\r\n                    agentName={lead.agent?.name}\r\n                    onGroupChange={() => refetch()}\r\n                  />\r\n\r\n                  {/* Assigned Agent Selector - Mobile */}\r\n                  <LeadAssignedSelector\r\n                    leadId={lead.id}\r\n                    currentAgentId={lead.assigned_agent_id}\r\n                    currentAgentName={lead.agent?.name}\r\n                    onAgentChange={() => refetch()}\r\n                  />\r\n\r\n                  <div className=\"space-y-2\">\r\n                    <Label className=\"text-sm text-muted-foreground\">Budget (Optional)</Label>\r\n                    <div className=\"relative\">\r\n                      <DollarSign className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n                      <Input\r\n                        type=\"text\"\r\n                        placeholder=\"AED 2,500,000\"\r\n                        defaultValue={lead.budget || \"\"}\r\n                        className=\"h-12 pl-10 bg-muted/30\"\r\n                      />\r\n                    </div>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              {/* Lead Info Card - Mobile */}\r\n              <Card className=\"border-0 shadow-sm\">\r\n                <CardContent className=\"p-4\">\r\n                  <div className=\"flex items-center gap-2 mb-3\">\r\n                    <Calendar className=\"h-4 w-4 text-muted-foreground\" />\r\n                    <span className=\"font-semibold text-sm\">Lead Info</span>\r\n                  </div>\r\n                  <div className=\"space-y-2 text-sm\">\r\n                    <div className=\"flex items-center justify-between py-1.5 border-b border-dashed\">\r\n                      <span className=\"text-muted-foreground flex items-center gap-2\">\r\n                        <Calendar className=\"h-3.5 w-3.5\" />{t('created')}</span>\r\n                      <span className=\"font-medium text-right\">\r\n                        <span>{new Date(lead.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>\r\n                        <span className=\"text-xs text-muted-foreground ml-1\">({formatDistanceToNow(new Date(lead.created_at), { addSuffix: true })})</span>\r\n                      </span>\r\n                    </div>\r\n                    {lead.last_contacted_at && (\r\n                      <div className=\"flex items-center justify-between py-1.5 border-b border-dashed\">\r\n                        <span className=\"text-muted-foreground flex items-center gap-2\">\r\n                          <Clock className=\"h-3.5 w-3.5\" />\r\n                          Last Contacted\r\n                        </span>\r\n                        <span className=\"font-medium text-right\">\r\n                          <span>{new Date(lead.last_contacted_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>\r\n                          <span className=\"text-xs text-muted-foreground ml-1\">({formatDistanceToNow(new Date(lead.last_contacted_at), { addSuffix: true })})</span>\r\n                        </span>\r\n                      </div>\r\n                    )}\r\n                    {lead.location && (\r\n                      <div className=\"flex items-center justify-between py-1.5 border-b border-dashed\">\r\n                        <span className=\"text-muted-foreground flex items-center gap-2\">\r\n                          <MapPin className=\"h-3.5 w-3.5\" />\r\n                          Location\r\n                        </span>\r\n                        <span className=\"font-medium\">{lead.location}</span>\r\n                      </div>\r\n                    )}\r\n                    {lead.requirements && (\r\n                      <div className=\"flex items-center justify-between py-1.5\">\r\n                        <span className=\"text-muted-foreground\">Requirements</span>\r\n                        <span className=\"font-medium text-right max-w-[60%] truncate\">{lead.requirements}</span>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              {/* Details - Form Submission */}\r\n              <Card className=\"border-0 shadow-sm\">\r\n                <CardContent className=\"p-4\">\r\n                  <div className=\"flex items-center gap-2 mb-4\">\r\n                    <FileText className=\"h-5 w-5 text-muted-foreground\" />\r\n                    <h3 className=\"text-base font-semibold\">Details</h3>\r\n                  </div>\r\n\r\n                  {hasFormData ? (\r\n                    <div className=\"space-y-3\">\r\n                      {/* Platform Header */}\r\n                      <div className=\"flex items-center gap-2 p-3 bg-blue-50 dark:bg-blue-950/30 rounded-lg border border-blue-100 dark:border-blue-900/50\">\r\n                        <Facebook className=\"h-5 w-5 text-blue-600\" />\r\n                        <div>\r\n                          <p className=\"text-sm font-medium text-blue-700 dark:text-blue-400\">\r\n                            {formData.platform === 'meta' ? 'Meta Lead Form' : 'Lead Form'}\r\n                          </p>\r\n                          <p className=\"text-xs text-blue-600 dark:text-blue-500\">\r\n                            {formData.formName || formData.form_name || \"Form Submission\"}\r\n                          </p>\r\n                        </div>\r\n                      </div>\r\n\r\n                      {/* Form Details */}\r\n                      <div className=\"space-y-2 text-sm\">\r\n                        {formData.campaignName && (\r\n                          <div className=\"flex justify-between py-1.5 border-b border-dashed border-border/50\">\r\n                            <span className=\"text-muted-foreground\">Campaign</span>\r\n                            <span className=\"font-medium\">{formData.campaignName}</span>\r\n                          </div>\r\n                        )}\r\n                        {formData.adSetName && (\r\n                          <div className=\"flex justify-between py-1.5 border-b border-dashed border-border/50\">\r\n                            <span className=\"text-muted-foreground\">Ad Set</span>\r\n                            <span>{formData.adSetName}</span>\r\n                          </div>\r\n                        )}\r\n                        {formData.adName && (\r\n                          <div className=\"flex justify-between py-1.5 border-b border-dashed border-border/50\">\r\n                            <span className=\"text-muted-foreground\">Ad</span>\r\n                            <span>{formData.adName}</span>\r\n                          </div>\r\n                        )}\r\n                        {formData.page_name && (\r\n                          <div className=\"flex justify-between py-1.5 border-b border-dashed border-border/50\">\r\n                            <span className=\"text-muted-foreground\">Page</span>\r\n                            <span>{formData.page_name}</span>\r\n                          </div>\r\n                        )}\r\n\r\n                        {/* All other form fields */}\r\n                        {Object.entries(formData)\r\n                          .filter(([key]) => ![\"formName\", \"form_name\", \"campaignName\", \"adSetName\", \"adName\", \"formId\", \"form_id\", \"submittedAt\", \"platform\", \"page_name\", \"ad_id\", \"adgroup_id\", \"webhook\", \"sync_method\", \"fetchedAt\", \"external_id\", \"raw_data\"].includes(key))\r\n                          .filter(([_, value]) => value !== null && value !== undefined && value !== '')\r\n                          .map(([key, value]) => (\r\n                            <div key={key} className=\"flex justify-between py-1.5 border-b border-dashed border-border/50 last:border-0\">\r\n                              <span className=\"text-muted-foreground capitalize\">{key.replace(/_/g, \" \")}</span>\r\n                              <span className=\"text-right max-w-[55%] break-words font-medium\">\r\n                                {typeof value === 'object' ? JSON.stringify(value) : String(value)}\r\n                              </span>\r\n                            </div>\r\n                          ))\r\n                        }\r\n\r\n                        {/* Metadata */}\r\n                        {(formData.formId || formData.form_id) && (\r\n                          <div className=\"flex justify-between py-1.5 border-b border-dashed border-border/50\">\r\n                            <span className=\"text-muted-foreground\">Form ID</span>\r\n                            <span className=\"text-xs font-mono opacity-70\">{formData.formId || formData.form_id}</span>\r\n                          </div>\r\n                        )}\r\n                        {formData.external_id && (\r\n                          <div className=\"flex justify-between py-1.5 border-b border-dashed border-border/50\">\r\n                            <span className=\"text-muted-foreground\">Lead ID</span>\r\n                            <span className=\"text-xs font-mono opacity-70\">{formData.external_id}</span>\r\n                          </div>\r\n                        )}\r\n                        {formData.sync_method && (\r\n                          <div className=\"flex justify-between py-1.5 border-b border-dashed border-border/50\">\r\n                            <span className=\"text-muted-foreground\">Sync Method</span>\r\n                            <Badge variant=\"secondary\" className=\"text-xs\">{formData.sync_method}</Badge>\r\n                          </div>\r\n                        )}\r\n                        {formData.fetchedAt && (\r\n                          <div className=\"flex justify-between py-1.5\">\r\n                            <span className=\"text-muted-foreground\">Fetched At</span>\r\n                            <span className=\"text-xs opacity-70\">{new Date(formData.fetchedAt).toLocaleString()}</span>\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  ) : (\r\n                    <p className=\"text-sm text-muted-foreground\">No form submission details available.</p>\r\n                  )}\r\n\r\n                  {/* Tags */}\r\n                  {lead.tags && lead.tags.length > 0 && (\r\n                    <div className=\"mt-6 pt-4 border-t border-border/50\">\r\n                      <h3 className=\"text-sm font-semibold text-muted-foreground mb-3\">Tags</h3>\r\n                      <div className=\"flex flex-wrap gap-2\">\r\n                        {lead.tags.map((tag) => (\r\n                          <Badge key={tag} variant=\"secondary\" className=\"text-xs\">\r\n                            {tag}\r\n                          </Badge>\r\n                        ))}\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n                </CardContent>\r\n              </Card>\r\n\r\n              {/* Assigned Agent Card - Mobile */}\r\n              {lead.agent && (\r\n                <Card className=\"border-0 shadow-sm\">\r\n                  <CardContent className=\"p-4\">\r\n                    <div className=\"flex items-center gap-2 mb-3\">\r\n                      <User className=\"h-4 w-4 text-muted-foreground\" />\r\n                      <span className=\"font-semibold text-sm\">Assigned Agent</span>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-3\">\r\n                      <Avatar className=\"h-12 w-12 border-2 border-primary/20\">\r\n                        <AvatarImage src={lead.agent.avatar_url || `https://api.dicebear.com/7.x/initials/svg?seed=${lead.agent.name}`} />\r\n                        <AvatarFallback className=\"bg-primary/10 text-primary font-semibold\">\r\n                          {lead.agent.name.split(\" \").map(n => n[0]).join(\"\")}\r\n                        </AvatarFallback>\r\n                      </Avatar>\r\n                      <div className=\"flex-1\">\r\n                        <p className=\"font-medium\">{lead.agent.name}</p>\r\n                        <p className=\"text-xs text-muted-foreground\">Sales Agent</p>\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"grid grid-cols-2 gap-2 mt-3\">\r\n                      <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        className=\"h-8 text-xs\"\r\n                        onClick={() => window.open(`tel:+971500000000`)}\r\n                      >\r\n                        <Phone className=\"h-3.5 w-3.5 mr-1\" />\r\n                        Call\r\n                      </Button>\r\n                      <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        className=\"h-8 text-xs\"\r\n                        onClick={() => window.open(`https://wa.me/971500000000`)}\r\n                      >\r\n                        <MessageSquare className=\"h-3.5 w-3.5 mr-1\" />\r\n                        Message\r\n                      </Button>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              )}\r\n            </div>\r\n          ) : (\r\n            <ActivityTimeline\r\n              timelineData={realtimeActivities}\r\n              onOpenVoiceModal={() => setShowVoiceModal(true)}\r\n              onAddNote={handleAddRealtimeNote}\r\n              onAddAttachment={handleAddAttachment}\r\n              onAddMeeting={handleAddMeeting}\r\n              onAddFollowup={handleAddFollowup}\r\n              isLoading={isLoadingActivities}\r\n              showNoteDialog={showNoteDialog}\r\n              onNoteDialogChange={setShowNoteDialog}\r\n              showAttachmentDialog={showAttachmentDialog}\r\n              onAttachmentDialogChange={setShowAttachmentDialog}\r\n              showMeetingDialog={showMeetingDialog}\r\n              onMeetingDialogChange={setShowMeetingDialog}\r\n              showFollowupDialog={showFollowupDialog}\r\n              onFollowupDialogChange={setShowFollowupDialog}\r\n            />\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Voice Note Recording Modal */}\r\n      <Dialog open={showVoiceModal} onOpenChange={(open) => {\r\n        if (!open) handleCancelVoiceModal();\r\n        else setShowVoiceModal(open);\r\n      }}>\r\n        <DialogContent className=\"sm:max-w-sm p-0 overflow-hidden\">\r\n          <DialogHeader className=\"sr-only\">\r\n            <DialogTitle>Record Voice Note</DialogTitle>\r\n          </DialogHeader>\r\n          <div className=\"p-6 text-center\">\r\n            {!isRecording && !audioBlob ? (\r\n              <div className=\"space-y-6\">\r\n                <div className=\"space-y-2\">\r\n                  <h3 className=\"text-lg font-semibold\">Record Voice Note</h3>\r\n                  <p className=\"text-sm text-muted-foreground\">Tap to start recording</p>\r\n                </div>\r\n                <button\r\n                  onClick={() => {\r\n                    if (navigator.vibrate) navigator.vibrate(50);\r\n                    handleStartRecording();\r\n                  }}\r\n                  className=\"mx-auto h-24 w-24 rounded-full bg-primary hover:bg-primary/90 transition-all hover:scale-105 active:scale-95 flex items-center justify-center shadow-lg\"\r\n                >\r\n                  <Mic className=\"h-10 w-10 text-primary-foreground\" />\r\n                </button>\r\n              </div>\r\n            ) : isRecording ? (\r\n              <div className=\"space-y-6\">\r\n                <div className=\"space-y-2\">\r\n                  <h3 className=\"text-lg font-semibold text-destructive\">Recording...</h3>\r\n                  <p className=\"text-3xl font-mono font-bold\">{Math.floor(recordingTime / 60)}:{String(recordingTime % 60).padStart(2, '0')}</p>\r\n                </div>\r\n\r\n                <div className=\"flex items-center justify-center gap-1 h-16 px-8\">\r\n                  {[...Array(24)].map((_, i) => (\r\n                    <div\r\n                      key={i}\r\n                      className=\"w-1.5 bg-destructive rounded-full animate-pulse\"\r\n                      style={{\r\n                        height: `${20 + Math.random() * 80}%`,\r\n                        animationDelay: `${i * 40}ms`,\r\n                        animationDuration: '0.5s'\r\n                      }}\r\n                    />\r\n                  ))}\r\n                </div>\r\n\r\n                <button\r\n                  onClick={() => {\r\n                    if (navigator.vibrate) navigator.vibrate([50, 50, 50]);\r\n                    handleStopRecording();\r\n                  }}\r\n                  className=\"mx-auto h-24 w-24 rounded-full bg-destructive hover:bg-destructive/90 transition-all hover:scale-105 active:scale-95 flex items-center justify-center shadow-lg\"\r\n                >\r\n                  <div className=\"h-8 w-8 bg-white rounded-sm\" />\r\n                </button>\r\n                <p className=\"text-sm text-muted-foreground\">Tap to stop</p>\r\n              </div>\r\n            ) : (\r\n              <div className=\"space-y-6\">\r\n                <div className=\"space-y-2\">\r\n                  <h3 className=\"text-lg font-semibold\">Preview Recording</h3>\r\n                  <p className=\"text-2xl font-mono font-bold\">{Math.floor(recordingTime / 60)}:{String(recordingTime % 60).padStart(2, '0')}</p>\r\n                </div>\r\n\r\n                {audioUrl && (\r\n                  <audio controls src={audioUrl} className=\"w-full\" />\r\n                )}\r\n\r\n                <div className=\"space-y-2 text-left\">\r\n                  <Label className=\"text-sm\">Caption (optional)</Label>\r\n                  <Input\r\n                    placeholder=\"Add a caption...\"\r\n                    value={voiceCaption}\r\n                    onChange={(e) => setVoiceCaption(e.target.value)}\r\n                  />\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          <div className=\"border-t bg-muted/30 p-4 flex gap-3\">\r\n            <Button\r\n              variant=\"outline\"\r\n              className=\"flex-1\"\r\n              onClick={handleCancelVoiceModal}\r\n            >{t('cancel')}</Button>\r\n            <Button\r\n              className=\"flex-1\"\r\n              onClick={handleSaveVoiceNote}\r\n              disabled={!audioBlob || isSavingVoice}\r\n            >\r\n              {isSavingVoice ? \"Saving...\" : \"Save\"}\r\n            </Button>\r\n          </div>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  );\r\n\r\n  const fabComponent = typeof document !== \"undefined\"\r\n    ? createPortal(\r\n      <LeadDetailFAB\r\n        onNote={() => setShowNoteDialog(true)}\r\n        onVoice={() => setShowVoiceModal(true)}\r\n        onAttachment={() => setShowAttachmentDialog(true)}\r\n        onMeeting={() => setShowMeetingDialog(true)}\r\n        onFollowup={() => setShowFollowupDialog(true)}\r\n      />,\r\n      document.body\r\n    )\r\n    : null;\r\n\r\n  if (isMobile) {\r\n    return (\r\n      <>\r\n        <PullToRefresh onRefresh={handleRefresh}>\r\n          {content}\r\n        </PullToRefresh>\r\n        {fabComponent}\r\n      </>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {content}\r\n      {fabComponent}\r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\LeadSourcesPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":385,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":385,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13616,13619],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13616,13619],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":426,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":426,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14804,14807],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14804,14807],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport {\r\n  Search,\r\n  CheckCircle2,\r\n  XCircle,\r\n  AlertCircle,\r\n  Link2,\r\n  RefreshCw,\r\n  ExternalLink,\r\n  Loader2,\r\n  Zap,\r\n  Globe,\r\n  Copy,\r\n  Eye,\r\n  EyeOff,\r\n} from \"lucide-react\";\r\nimport { Card, CardContent } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogDescription,\r\n  DialogFooter,\r\n} from \"@/components/ui/dialog\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { toast } from \"sonner\";\r\nimport { LeadSourcesPageSkeleton } from \"@/components/ui/page-skeletons\";\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport { EmptyState } from \"@/components/ui/empty-state\";\r\nimport { useLeadSources, LeadSource } from \"@/hooks/useLeadSources\";\r\n\r\nconst pageVariants = {\r\n  initial: { opacity: 0, y: 20 },\r\n  animate: { opacity: 1, y: 0 },\r\n  exit: { opacity: 0, y: -10 }\r\n};\r\n\r\nconst pageTransition = {\r\n  type: \"tween\" as const,\r\n  ease: \"easeOut\" as const,\r\n  duration: 0.3\r\n};\r\n\r\n// Only 8 specific lead sources with original logos\r\nconst SOURCE_DISPLAY_CONFIG: Record<string, { name: string; icon: string; color: string; logo?: string }> = {\r\n  meta: {\r\n    name: \"Meta (Facebook / Instagram)\",\r\n    icon: \"ðŸ“˜\",\r\n    color: \"#1877F2\",\r\n    logo: \"https://upload.wikimedia.org/wikipedia/commons/thumb/7/7b/Meta_Platforms_Inc._logo.svg/800px-Meta_Platforms_Inc._logo.svg.png\"\r\n  },\r\n  tiktok: {\r\n    name: \"TikTok\",\r\n    icon: \"ðŸŽµ\",\r\n    color: \"#000000\",\r\n    logo: \"https://sf-tb-sg.ibytedtos.com/obj/eden-sg/uhtyvueh7nulogpoguhm/tiktok-icon2.png\"\r\n  },\r\n  linkedin: {\r\n    name: \"LinkedIn\",\r\n    icon: \"ðŸ’¼\",\r\n    color: \"#0A66C2\",\r\n    logo: \"https://upload.wikimedia.org/wikipedia/commons/c/ca/LinkedIn_logo_initials.png\"\r\n  },\r\n  website: {\r\n    name: \"Website Forms\",\r\n    icon: \"ðŸŒ\",\r\n    color: \"#6366F1\"\r\n  },\r\n  property_finder: {\r\n    name: \"Property Finder\",\r\n    icon: \"ðŸ \",\r\n    color: \"#E52B50\"\r\n  },\r\n  bayut: {\r\n    name: \"Bayut\",\r\n    icon: \"ðŸ¢\",\r\n    color: \"#00A651\"\r\n  },\r\n  dubizzle: {\r\n    name: \"Dubizzle\",\r\n    icon: \"ðŸ”´\",\r\n    color: \"#E53935\"\r\n  },\r\n  google_sheets: {\r\n    name: \"Google Sheets\",\r\n    icon: \"ðŸ“Š\",\r\n    color: \"#34A853\",\r\n    logo: \"https://upload.wikimedia.org/wikipedia/commons/3/30/Google_Sheets_logo_%282014-2020%29.svg\"\r\n  },\r\n};\r\n\r\n// OAuth sources - use OAuth flow\r\nconst OAUTH_SOURCES = ['meta', 'tiktok', 'linkedin', 'google_sheets'];\r\n\r\n// API key sources - use credential inputs\r\nconst CONNECTION_FIELDS: Record<string, { key: string; label: string; placeholder: string; type: string }[]> = {\r\n  meta: [], // OAuth - no manual fields\r\n  tiktok: [], // OAuth - no manual fields (credentials configured by developer)\r\n  linkedin: [], // OAuth - no manual fields\r\n  google_sheets: [], // OAuth - no manual fields\r\n  website: [], // Webhook only\r\n  property_finder: [\r\n    { key: \"api_key\", label: \"API Key\", placeholder: \"Your Property Finder API key\", type: \"password\" },\r\n    { key: \"partner_id\", label: \"Partner ID\", placeholder: \"Your Partner ID\", type: \"text\" },\r\n  ],\r\n  bayut: [\r\n    { key: \"api_key\", label: \"API Key\", placeholder: \"Your Bayut API key\", type: \"password\" },\r\n    { key: \"agency_id\", label: \"Agency ID\", placeholder: \"Your Agency ID\", type: \"text\" },\r\n  ],\r\n  dubizzle: [\r\n    { key: \"api_key\", label: \"API Key\", placeholder: \"Your Dubizzle API key\", type: \"password\" },\r\n    { key: \"agency_id\", label: \"Agency ID\", placeholder: \"Your Agency ID\", type: \"text\" },\r\n  ],\r\n};\r\n\r\n// OAuth configuration for each provider\r\nconst OAUTH_CONFIG: Record<string, { buttonText: string; buttonColor: string; icon: string }> = {\r\n  meta: { buttonText: \"Sign in with Facebook\", buttonColor: \"#1877F2\", icon: \"ðŸ“˜\" },\r\n  tiktok: { buttonText: \"Sign in with TikTok\", buttonColor: \"#000000\", icon: \"ðŸŽµ\" },\r\n  linkedin: { buttonText: \"Sign in with LinkedIn\", buttonColor: \"#0A66C2\", icon: \"ðŸ’¼\" },\r\n  google_sheets: { buttonText: \"Sign in with Google\", buttonColor: \"#4285F4\", icon: \"ðŸ“Š\" },\r\n};\r\n\r\nexport default function LeadSourcesPage() {\r\n  const isMobile = useIsMobile();\r\n  const {\r\n    sources,\r\n    isLoading,\r\n    error,\r\n    connectSource,\r\n    disconnectSource,\r\n    testConnection,\r\n    fetchLeads,\r\n    getMetaForms,\r\n    getTikTokForms,\r\n    getWebhookUrl,\r\n    createWebhook,\r\n    markWebsiteConnected\r\n  } = useLeadSources();\r\n\r\n  const [search, setSearch] = useState(\"\");\r\n  const [connectDialogOpen, setConnectDialogOpen] = useState(false);\r\n  const [selectedSource, setSelectedSource] = useState<LeadSource | null>(null);\r\n  const [connecting, setConnecting] = useState(false);\r\n  const [connectionFields, setConnectionFields] = useState<Record<string, string>>({});\r\n  const [showWebhookDialog, setShowWebhookDialog] = useState(false);\r\n  const [webhookUrl, setWebhookUrl] = useState(\"\");\r\n  const [showPasswords, setShowPasswords] = useState<Record<string, boolean>>({});\r\n  const [syncing, setSyncing] = useState<string | null>(null);\r\n  const [testing, setTesting] = useState<string | null>(null);\r\n\r\n  // Meta forms dialog state\r\n  const [showMetaFormsDialog, setShowMetaFormsDialog] = useState(false);\r\n  const [metaFormsSource, setMetaFormsSource] = useState<LeadSource | null>(null);\r\n  const [metaPages, setMetaPages] = useState<Array<{ id: string; name: string; access_token?: string }>>([]);\r\n  const [metaForms, setMetaForms] = useState<Array<{ id: string; name: string; page_name: string; leads_count: number; status: string }>>([]);\r\n  const [selectedFormIds, setSelectedFormIds] = useState<Set<string>>(new Set());\r\n  const [selectAllForms, setSelectAllForms] = useState(true);\r\n  const [dateFrom, setDateFrom] = useState(\"\");\r\n  const [dateTo, setDateTo] = useState(\"\");\r\n  const [loadingForms, setLoadingForms] = useState(false);\r\n  const [importing, setImporting] = useState(false);\r\n\r\n  // TikTok forms dialog state\r\n  const [showTikTokFormsDialog, setShowTikTokFormsDialog] = useState(false);\r\n  const [tikTokFormsSource, setTikTokFormsSource] = useState<LeadSource | null>(null);\r\n  const [tikTokForms, setTikTokForms] = useState<Array<{ id: string; name: string; status: string; leads_count: number }>>([]);\r\n  const [selectedTikTokFormIds, setSelectedTikTokFormIds] = useState<Set<string>>(new Set());\r\n  const [selectAllTikTokForms, setSelectAllTikTokForms] = useState(true);\r\n  const [tikTokDateFrom, setTikTokDateFrom] = useState(\"\");\r\n  const [tikTokDateTo, setTikTokDateTo] = useState(\"\");\r\n  const [loadingTikTokForms, setLoadingTikTokForms] = useState(false);\r\n  const [importingTikTok, setImportingTikTok] = useState(false);\r\n\r\n  // Handle OAuth callback from redirect\r\n  useEffect(() => {\r\n    const urlParams = new URLSearchParams(window.location.search);\r\n    const success = urlParams.get('success');\r\n    const errorParam = urlParams.get('error');\r\n    const source = urlParams.get('source');\r\n\r\n    if (success === 'true' && source) {\r\n      toast.success(`Successfully connected to ${SOURCE_DISPLAY_CONFIG[source]?.name || source}!`);\r\n      // Clean up URL\r\n      window.history.replaceState({}, document.title, window.location.pathname);\r\n    } else if (errorParam) {\r\n      toast.error(`Connection failed: ${decodeURIComponent(errorParam)}`);\r\n      window.history.replaceState({}, document.title, window.location.pathname);\r\n    }\r\n  }, []);\r\n\r\n  // Filter sources to only show the 8 specific ones\r\n  const displaySources = sources.filter(s => SOURCE_DISPLAY_CONFIG[s.source_name]);\r\n\r\n  const filteredSources = displaySources.filter(source => {\r\n    const config = SOURCE_DISPLAY_CONFIG[source.source_name];\r\n    return config?.name.toLowerCase().includes(search.toLowerCase());\r\n  });\r\n\r\n  const connectedSources = displaySources.filter(s => s.status === \"connected\");\r\n  const totalLeads = connectedSources.reduce((sum, s) => sum + (s.total_leads_fetched || 0), 0);\r\n\r\n  // Show error state only for actual errors\r\n  if (error) {\r\n    return (\r\n      <motion.div\r\n        initial=\"initial\"\r\n        animate=\"animate\"\r\n        exit=\"exit\"\r\n        variants={pageVariants}\r\n        transition={pageTransition}\r\n        className=\"p-4 md:p-6 space-y-6\"\r\n      >\r\n        <Card className=\"border-destructive\">\r\n          <CardContent className=\"p-8\">\r\n            <EmptyState\r\n              icon={<AlertCircle className=\"h-12 w-12 text-destructive\" />}\r\n              title=\"Failed to Load\"\r\n              description={error}\r\n              action={\r\n                <Button onClick={() => window.location.reload()}>\r\n                  <RefreshCw className=\"h-4 w-4 mr-2\" />\r\n                  Refresh Page\r\n                </Button>\r\n              }\r\n            />\r\n          </CardContent>\r\n        </Card>\r\n      </motion.div>\r\n    );\r\n  }\r\n\r\n  if (isLoading) {\r\n    return <LeadSourcesPageSkeleton isMobile={isMobile} />;\r\n  }\r\n\r\n  const handleConnect = (source: LeadSource) => {\r\n    setSelectedSource(source);\r\n    setConnectionFields({});\r\n\r\n    if (source.source_name === \"website\") {\r\n      // For website, show webhook URL directly\r\n      const url = getWebhookUrl(source.id);\r\n      if (!url) {\r\n        createWebhook(source.id).then(() => {\r\n          setWebhookUrl(getWebhookUrl(source.id));\r\n        });\r\n      } else {\r\n        setWebhookUrl(url);\r\n      }\r\n      setShowWebhookDialog(true);\r\n    } else {\r\n      setConnectDialogOpen(true);\r\n    }\r\n  };\r\n\r\n  const handleOAuthConnect = async (source: LeadSource) => {\r\n    setConnecting(true);\r\n\r\n    const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;\r\n    const redirectUri = `${window.location.origin}/lead-sources`;\r\n\r\n    try {\r\n      if (source.source_name === 'meta') {\r\n        // Call Meta OAuth edge function to get auth URL\r\n        const response = await fetch(\r\n          `${supabaseUrl}/functions/v1/meta-oauth?action=init&source_id=${source.id}&company_id=${source.company_id}&redirect_uri=${encodeURIComponent(redirectUri)}`\r\n        );\r\n\r\n        const data = await response.json();\r\n\r\n        if (data.authUrl) {\r\n          // Redirect to Meta OAuth\r\n          window.location.href = data.authUrl;\r\n          return;\r\n        } else if (data.error) {\r\n          toast.error(data.error);\r\n        }\r\n      } else if (source.source_name === 'tiktok') {\r\n        // Call TikTok integration edge function to get auth URL\r\n        const { supabase } = await import('@/integrations/supabase/client');\r\n        const { data: { session } } = await supabase.auth.getSession();\r\n\r\n        const response = await fetch(\r\n          `${supabaseUrl}/functions/v1/tiktok-integration?action=authorize`,\r\n          {\r\n            headers: {\r\n              'Authorization': `Bearer ${session?.access_token}`,\r\n              'Content-Type': 'application/json'\r\n            }\r\n          }\r\n        );\r\n\r\n        const data = await response.json();\r\n\r\n        if (data.auth_url) {\r\n          // Redirect to TikTok OAuth\r\n          window.location.href = data.auth_url;\r\n          return;\r\n        } else if (data.error) {\r\n          toast.error(data.error || data.message || 'TikTok integration not configured. Please contact your administrator.');\r\n        }\r\n      } else {\r\n        // For other OAuth sources (LinkedIn, Google Sheets) - show instructions\r\n        toast.info(`OAuth for ${SOURCE_DISPLAY_CONFIG[source.source_name]?.name} requires additional setup. Please contact support.`, {\r\n          duration: 5000\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.error('OAuth init error:', error);\r\n      toast.error('Failed to initialize OAuth connection');\r\n    }\r\n\r\n    setConnecting(false);\r\n    setConnectDialogOpen(false);\r\n  };\r\n\r\n  const handleConfirmConnect = async () => {\r\n    if (!selectedSource) return;\r\n\r\n    // For OAuth sources (Meta, TikTok, LinkedIn, Google Sheets), use OAuth flow directly\r\n    if (OAUTH_SOURCES.includes(selectedSource.source_name)) {\r\n      await handleOAuthConnect(selectedSource);\r\n      return;\r\n    }\r\n\r\n    setConnecting(true);\r\n\r\n    const result = await connectSource(selectedSource.id, connectionFields);\r\n\r\n    setConnecting(false);\r\n    if (result.success) {\r\n      setConnectDialogOpen(false);\r\n      setSelectedSource(null);\r\n      setConnectionFields({});\r\n    }\r\n  };\r\n\r\n  const handleTestConnection = async (source: LeadSource) => {\r\n    setTesting(source.id);\r\n    const result = await testConnection(source.id);\r\n    setTesting(null);\r\n\r\n    if (result.success) {\r\n      toast.success(result.message || \"Connection test successful\");\r\n    } else {\r\n      toast.error(result.error || \"Connection test failed\");\r\n    }\r\n  };\r\n\r\n  const handleSync = async (source: LeadSource) => {\r\n    setSyncing(source.id);\r\n    await fetchLeads(source.id);\r\n    setSyncing(null);\r\n  };\r\n\r\n  const handleDisconnect = async (source: LeadSource) => {\r\n    await disconnectSource(source.id);\r\n  };\r\n\r\n  const handleShowMetaForms = async (source: LeadSource) => {\r\n    setMetaFormsSource(source);\r\n    const pages = source.connection_details?.pages || [];\r\n    setMetaPages(pages);\r\n    setMetaForms([]);\r\n    setSelectedFormIds(new Set());\r\n    setSelectAllForms(true);\r\n    setDateFrom(\"\");\r\n    setDateTo(\"\");\r\n    setShowMetaFormsDialog(true);\r\n\r\n    // Fetch forms\r\n    setLoadingForms(true);\r\n    try {\r\n      const forms = await getMetaForms(source.id);\r\n      setMetaForms(forms);\r\n      // Select all forms by default\r\n      setSelectedFormIds(new Set(forms.map((f: any) => f.id)));\r\n    } catch (error) {\r\n      console.error('Error fetching forms:', error);\r\n    }\r\n    setLoadingForms(false);\r\n  };\r\n\r\n  const handleImportMetaLeads = async () => {\r\n    if (!metaFormsSource) return;\r\n    setImporting(true);\r\n\r\n    // Prepare filters\r\n    const formIds = selectAllForms ? undefined : Array.from(selectedFormIds);\r\n\r\n    await fetchLeads(metaFormsSource.id, {\r\n      form_ids: formIds,\r\n      date_from: dateFrom || undefined,\r\n      date_to: dateTo || undefined\r\n    });\r\n\r\n    setImporting(false);\r\n    setShowMetaFormsDialog(false);\r\n    toast.success(\"Leads imported successfully!\");\r\n  };\r\n\r\n  // TikTok Forms Handlers\r\n  const handleShowTikTokForms = async (source: LeadSource) => {\r\n    setTikTokFormsSource(source);\r\n    setTikTokForms([]);\r\n    setSelectedTikTokFormIds(new Set());\r\n    setSelectAllTikTokForms(true);\r\n    setTikTokDateFrom(\"\");\r\n    setTikTokDateTo(\"\");\r\n    setShowTikTokFormsDialog(true);\r\n\r\n    // Fetch forms\r\n    setLoadingTikTokForms(true);\r\n    try {\r\n      const forms = await getTikTokForms();\r\n      setTikTokForms(forms);\r\n      // Select all forms by default\r\n      setSelectedTikTokFormIds(new Set(forms.map((f: any) => f.id)));\r\n    } catch (error) {\r\n      console.error('Error fetching TikTok forms:', error);\r\n    }\r\n    setLoadingTikTokForms(false);\r\n  };\r\n\r\n  const handleImportTikTokLeads = async () => {\r\n    if (!tikTokFormsSource) return;\r\n    setImportingTikTok(true);\r\n\r\n    const formIds = selectAllTikTokForms ? undefined : Array.from(selectedTikTokFormIds);\r\n\r\n    await fetchLeads(tikTokFormsSource.id, {\r\n      form_ids: formIds,\r\n      date_from: tikTokDateFrom || undefined,\r\n      date_to: tikTokDateTo || undefined\r\n    });\r\n\r\n    setImportingTikTok(false);\r\n    setShowTikTokFormsDialog(false);\r\n    toast.success(\"TikTok leads imported successfully!\");\r\n  };\r\n\r\n  const handleTikTokFormToggle = (formId: string) => {\r\n    setSelectedTikTokFormIds(prev => {\r\n      const newSet = new Set(prev);\r\n      if (newSet.has(formId)) {\r\n        newSet.delete(formId);\r\n      } else {\r\n        newSet.add(formId);\r\n      }\r\n      setSelectAllTikTokForms(newSet.size === tikTokForms.length);\r\n      return newSet;\r\n    });\r\n  };\r\n\r\n  const handleSelectAllTikTokForms = (checked: boolean) => {\r\n    setSelectAllTikTokForms(checked);\r\n    if (checked) {\r\n      setSelectedTikTokFormIds(new Set(tikTokForms.map(f => f.id)));\r\n    } else {\r\n      setSelectedTikTokFormIds(new Set());\r\n    }\r\n  };\r\n\r\n  const handleFormToggle = (formId: string) => {\r\n    setSelectedFormIds(prev => {\r\n      const newSet = new Set(prev);\r\n      if (newSet.has(formId)) {\r\n        newSet.delete(formId);\r\n      } else {\r\n        newSet.add(formId);\r\n      }\r\n      setSelectAllForms(newSet.size === metaForms.length);\r\n      return newSet;\r\n    });\r\n  };\r\n\r\n  const handleSelectAllForms = (checked: boolean) => {\r\n    setSelectAllForms(checked);\r\n    if (checked) {\r\n      setSelectedFormIds(new Set(metaForms.map(f => f.id)));\r\n    } else {\r\n      setSelectedFormIds(new Set());\r\n    }\r\n  };\r\n\r\n  const copyWebhookUrl = () => {\r\n    navigator.clipboard.writeText(webhookUrl);\r\n    toast.success(\"Webhook URL copied to clipboard\");\r\n  };\r\n\r\n  const getStatusBadge = (status: string) => {\r\n    switch (status) {\r\n      case \"connected\":\r\n        return (\r\n          <Badge className=\"bg-green-500/10 text-green-600 gap-1\">\r\n            <CheckCircle2 className=\"h-3 w-3\" />\r\n            Connected\r\n          </Badge>\r\n        );\r\n      case \"error\":\r\n        return (\r\n          <Badge className=\"bg-red-500/10 text-red-600 gap-1\">\r\n            <AlertCircle className=\"h-3 w-3\" />\r\n            Error\r\n          </Badge>\r\n        );\r\n      case \"pending\":\r\n        return (\r\n          <Badge className=\"bg-amber-500/10 text-amber-600 gap-1\">\r\n            <Loader2 className=\"h-3 w-3 animate-spin\" />\r\n            Pending\r\n          </Badge>\r\n        );\r\n      default:\r\n        return (\r\n          <Badge variant=\"secondary\" className=\"gap-1\">\r\n            <XCircle className=\"h-3 w-3\" />\r\n            Not Connected\r\n          </Badge>\r\n        );\r\n    }\r\n  };\r\n\r\n  const getSourceDisplay = (source: LeadSource) => {\r\n    return SOURCE_DISPLAY_CONFIG[source.source_name] || {\r\n      name: source.display_name,\r\n      icon: \"ðŸ“‹\",\r\n      color: \"#6B7280\"\r\n    };\r\n  };\r\n\r\n  return (\r\n    <motion.div\r\n      className=\"space-y-6\"\r\n      initial=\"initial\"\r\n      animate=\"animate\"\r\n      exit=\"exit\"\r\n      variants={pageVariants}\r\n      transition={pageTransition}\r\n    >\r\n      {/* Header */}\r\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold text-foreground\">Lead Sources</h1>\r\n          <p className=\"text-muted-foreground\">Connect and manage your lead sources</p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Stats */}\r\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center gap-3\">\r\n              <div className=\"w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center\">\r\n                <CheckCircle2 className=\"h-5 w-5 text-green-600\" />\r\n              </div>\r\n              <div>\r\n                <p className=\"text-2xl font-bold\">{connectedSources.length}</p>\r\n                <p className=\"text-sm text-muted-foreground\">Connected</p>\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center gap-3\">\r\n              <div className=\"w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center\">\r\n                <Zap className=\"h-5 w-5 text-primary\" />\r\n              </div>\r\n              <div>\r\n                <p className=\"text-2xl font-bold\">{totalLeads}</p>\r\n                <p className=\"text-sm text-muted-foreground\">Total Leads</p>\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center gap-3\">\r\n              <div className=\"w-10 h-10 rounded-lg bg-amber-500/10 flex items-center justify-center\">\r\n                <AlertCircle className=\"h-5 w-5 text-amber-600\" />\r\n              </div>\r\n              <div>\r\n                <p className=\"text-2xl font-bold\">{displaySources.filter(s => s.status === \"error\").length}</p>\r\n                <p className=\"text-sm text-muted-foreground\">Needs Attention</p>\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center gap-3\">\r\n              <div className=\"w-10 h-10 rounded-lg bg-muted flex items-center justify-center\">\r\n                <Globe className=\"h-5 w-5 text-muted-foreground\" />\r\n              </div>\r\n              <div>\r\n                <p className=\"text-2xl font-bold\">8</p>\r\n                <p className=\"text-sm text-muted-foreground\">Available</p>\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Search */}\r\n      <div className=\"relative w-full\">\r\n        <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n        <Input\r\n          placeholder=\"Search sources...\"\r\n          value={search}\r\n          onChange={(e) => setSearch(e.target.value)}\r\n          className=\"pl-9\"\r\n        />\r\n      </div>\r\n\r\n      {/* Sources Grid */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n        {filteredSources.map((source) => {\r\n          const display = getSourceDisplay(source);\r\n          return (\r\n            <Card\r\n              key={source.id}\r\n              className={cn(\r\n                \"transition-all hover:shadow-md\",\r\n                source.status === \"error\" && \"border-red-500/50\"\r\n              )}\r\n            >\r\n              <CardContent className=\"p-4\">\r\n                <div className=\"flex items-start justify-between mb-3\">\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <div\r\n                      className=\"w-12 h-12 rounded-xl flex items-center justify-center text-2xl overflow-hidden\"\r\n                      style={{ backgroundColor: `${display.color}15` }}\r\n                    >\r\n                      {display.logo ? (\r\n                        <img\r\n                          src={display.logo}\r\n                          alt={display.name}\r\n                          className=\"w-8 h-8 object-contain\"\r\n                          onError={(e) => {\r\n                            e.currentTarget.style.display = 'none';\r\n                            e.currentTarget.parentElement!.innerHTML = display.icon;\r\n                          }}\r\n                        />\r\n                      ) : (\r\n                        display.icon\r\n                      )}\r\n                    </div>\r\n                    <div>\r\n                      <h3 className=\"font-semibold text-sm\">{display.name}</h3>\r\n                      {getStatusBadge(source.status)}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                {source.status === \"connected\" && (\r\n                  <div className=\"flex items-center justify-between text-xs text-muted-foreground mb-4\">\r\n                    <span>{source.total_leads_fetched || 0} leads</span>\r\n                    {source.last_fetched_at && (\r\n                      <span>Last sync: {new Date(source.last_fetched_at).toLocaleDateString()}</span>\r\n                    )}\r\n                  </div>\r\n                )}\r\n\r\n                {source.status === \"error\" && source.last_error && (\r\n                  <p className=\"text-xs text-red-600 mb-4 truncate\" title={source.last_error}>\r\n                    {source.last_error}\r\n                  </p>\r\n                )}\r\n\r\n                <div className=\"flex gap-2 flex-wrap\">\r\n                  {source.status === \"connected\" ? (\r\n                    <>\r\n                      {/* Show Import Leads for Meta */}\r\n                      {source.source_name === 'meta' && (\r\n                        <Button\r\n                          variant=\"default\"\r\n                          size=\"sm\"\r\n                          className=\"flex-1\"\r\n                          onClick={() => handleShowMetaForms(source)}\r\n                        >\r\n                          <Zap className=\"h-4 w-4 mr-1\" />\r\n                          Import Leads\r\n                        </Button>\r\n                      )}\r\n                      {/* Show Import Leads for TikTok */}\r\n                      {source.source_name === 'tiktok' && (\r\n                        <Button\r\n                          variant=\"default\"\r\n                          size=\"sm\"\r\n                          className=\"flex-1\"\r\n                          onClick={() => handleShowTikTokForms(source)}\r\n                        >\r\n                          <Zap className=\"h-4 w-4 mr-1\" />\r\n                          Import Leads\r\n                        </Button>\r\n                      )}\r\n                      <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        className={(source.source_name === 'meta' || source.source_name === 'tiktok') ? \"\" : \"flex-1\"}\r\n                        onClick={() => handleSync(source)}\r\n                        disabled={syncing === source.id}\r\n                      >\r\n                        {syncing === source.id ? (\r\n                          <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n                        ) : (\r\n                          <RefreshCw className=\"h-4 w-4 mr-1\" />\r\n                        )}\r\n                        Sync\r\n                      </Button>\r\n                      <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        onClick={() => handleTestConnection(source)}\r\n                        disabled={testing === source.id}\r\n                      >\r\n                        {testing === source.id ? (\r\n                          <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n                        ) : (\r\n                          \"Test\"\r\n                        )}\r\n                      </Button>\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"sm\"\r\n                        className=\"text-destructive hover:text-destructive\"\r\n                        onClick={() => handleDisconnect(source)}\r\n                      >\r\n                        Disconnect\r\n                      </Button>\r\n                    </>\r\n                  ) : source.status === \"error\" ? (\r\n                    <Button\r\n                      size=\"sm\"\r\n                      className=\"w-full\"\r\n                      onClick={() => handleConnect(source)}\r\n                    >\r\n                      <RefreshCw className=\"h-4 w-4 mr-1\" />\r\n                      Reconnect\r\n                    </Button>\r\n                  ) : (\r\n                    <Button\r\n                      size=\"sm\"\r\n                      className=\"w-full\"\r\n                      onClick={() => handleConnect(source)}\r\n                    >\r\n                      <Link2 className=\"h-4 w-4 mr-1\" />\r\n                      Connect\r\n                    </Button>\r\n                  )}\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          );\r\n        })}\r\n      </div>\r\n\r\n      {filteredSources.length === 0 && (\r\n        <Card>\r\n          <CardContent className=\"p-6\">\r\n            <EmptyState\r\n              icon={Globe}\r\n              title=\"No sources found\"\r\n              description={search ? \"No sources match your search criteria.\" : \"Connect your first lead source to start receiving leads automatically.\"}\r\n            />\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Connect Dialog */}\r\n      <Dialog open={connectDialogOpen} onOpenChange={setConnectDialogOpen}>\r\n        <DialogContent className=\"max-w-md\">\r\n          <DialogHeader>\r\n            <DialogTitle className=\"flex items-center gap-3\">\r\n              {selectedSource && (\r\n                <>\r\n                  <span className=\"text-2xl\">{getSourceDisplay(selectedSource).icon}</span>\r\n                  Connect to {getSourceDisplay(selectedSource).name}\r\n                </>\r\n              )}\r\n            </DialogTitle>\r\n            <DialogDescription>\r\n              {selectedSource && OAUTH_SOURCES.includes(selectedSource.source_name)\r\n                ? \"Click the button below to securely connect your account via OAuth.\"\r\n                : \"Enter your credentials to connect this lead source.\"}\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n\r\n          {selectedSource && (\r\n            <div className=\"space-y-4 py-4\">\r\n              {/* OAuth Sources - Show OAuth Button Only */}\r\n              {OAUTH_SOURCES.includes(selectedSource.source_name) ? (\r\n                <div className=\"space-y-4\">\r\n                  <Button\r\n                    className=\"w-full h-12 text-white font-medium\"\r\n                    style={{ backgroundColor: OAUTH_CONFIG[selectedSource.source_name]?.buttonColor }}\r\n                    onClick={handleConfirmConnect}\r\n                    disabled={connecting}\r\n                  >\r\n                    {connecting ? (\r\n                      <>\r\n                        <Loader2 className=\"h-5 w-5 mr-2 animate-spin\" />\r\n                        Connecting...\r\n                      </>\r\n                    ) : (\r\n                      <>\r\n                        <span className=\"mr-2 text-lg\">{OAUTH_CONFIG[selectedSource.source_name]?.icon}</span>\r\n                        {OAUTH_CONFIG[selectedSource.source_name]?.buttonText}\r\n                      </>\r\n                    )}\r\n                  </Button>\r\n\r\n                  <div className=\"p-4 rounded-lg bg-muted/50 space-y-2\">\r\n                    <p className=\"text-sm font-medium\">We will request access to:</p>\r\n                    <ul className=\"text-sm text-muted-foreground space-y-1\">\r\n                      <li className=\"flex items-center gap-2\">\r\n                        <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\r\n                        Read lead form submissions\r\n                      </li>\r\n                      <li className=\"flex items-center gap-2\">\r\n                        <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\r\n                        Access contact information\r\n                      </li>\r\n                      <li className=\"flex items-center gap-2\">\r\n                        <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\r\n                        Sync leads automatically\r\n                      </li>\r\n                    </ul>\r\n                  </div>\r\n\r\n                  <p className=\"text-xs text-muted-foreground text-center\">\r\n                    You'll be redirected to {getSourceDisplay(selectedSource).name} to authorize access\r\n                  </p>\r\n                </div>\r\n              ) : (\r\n                /* API Key Sources - Show Form Fields */\r\n                <>\r\n                  {CONNECTION_FIELDS[selectedSource.source_name]?.map((field) => (\r\n                    <div key={field.key} className=\"space-y-2\">\r\n                      <Label htmlFor={field.key}>{field.label}</Label>\r\n                      {field.type === \"textarea\" ? (\r\n                        <Textarea\r\n                          id={field.key}\r\n                          placeholder={field.placeholder}\r\n                          value={connectionFields[field.key] || \"\"}\r\n                          onChange={(e) => setConnectionFields(prev => ({\r\n                            ...prev,\r\n                            [field.key]: e.target.value\r\n                          }))}\r\n                          rows={4}\r\n                        />\r\n                      ) : (\r\n                        <div className=\"relative\">\r\n                          <Input\r\n                            id={field.key}\r\n                            type={field.type === \"password\" && !showPasswords[field.key] ? \"password\" : \"text\"}\r\n                            placeholder={field.placeholder}\r\n                            value={connectionFields[field.key] || \"\"}\r\n                            onChange={(e) => setConnectionFields(prev => ({\r\n                              ...prev,\r\n                              [field.key]: e.target.value\r\n                            }))}\r\n                          />\r\n                          {field.type === \"password\" && (\r\n                            <Button\r\n                              type=\"button\"\r\n                              variant=\"ghost\"\r\n                              size=\"sm\"\r\n                              className=\"absolute right-1 top-1/2 -translate-y-1/2 h-7 w-7 p-0\"\r\n                              onClick={() => setShowPasswords(prev => ({\r\n                                ...prev,\r\n                                [field.key]: !prev[field.key]\r\n                              }))}\r\n                            >\r\n                              {showPasswords[field.key] ? (\r\n                                <EyeOff className=\"h-4 w-4\" />\r\n                              ) : (\r\n                                <Eye className=\"h-4 w-4\" />\r\n                              )}\r\n                            </Button>\r\n                          )}\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  ))}\r\n\r\n                  <div className=\"p-4 rounded-lg bg-muted/50 space-y-2\">\r\n                    <p className=\"text-sm font-medium\">We will request access to:</p>\r\n                    <ul className=\"text-sm text-muted-foreground space-y-1\">\r\n                      <li className=\"flex items-center gap-2\">\r\n                        <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\r\n                        Read lead form submissions\r\n                      </li>\r\n                      <li className=\"flex items-center gap-2\">\r\n                        <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\r\n                        Access contact information\r\n                      </li>\r\n                      <li className=\"flex items-center gap-2\">\r\n                        <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\r\n                        Sync leads automatically\r\n                      </li>\r\n                    </ul>\r\n                  </div>\r\n                </>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {/* Only show footer buttons for non-OAuth, non-TikTok sources */}\r\n          {selectedSource && !OAUTH_SOURCES.includes(selectedSource.source_name) && (\r\n            <DialogFooter>\r\n              <Button variant=\"outline\" onClick={() => setConnectDialogOpen(false)}>\r\n                Cancel\r\n              </Button>\r\n              <Button onClick={handleConfirmConnect} disabled={connecting}>\r\n                {connecting ? (\r\n                  <>\r\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                    Connecting...\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <ExternalLink className=\"h-4 w-4 mr-2\" />\r\n                    Connect\r\n                  </>\r\n                )}\r\n              </Button>\r\n            </DialogFooter>\r\n          )}\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Webhook URL Dialog for Website */}\r\n      <Dialog open={showWebhookDialog} onOpenChange={setShowWebhookDialog}>\r\n        <DialogContent className=\"max-w-xl\">\r\n          <DialogHeader>\r\n            <DialogTitle className=\"flex items-center gap-3\">\r\n              <span className=\"text-2xl\">ðŸŒ</span>\r\n              Website Lead Capture\r\n            </DialogTitle>\r\n            <DialogDescription>\r\n              Capture leads from any website in 2 minutes. Just copy & paste!\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n\r\n          <div className=\"space-y-4 py-4\">\r\n            {/* Simple Steps */}\r\n            <div className=\"grid grid-cols-3 gap-2 text-center\">\r\n              <div className=\"p-3 rounded-lg bg-primary/10\">\r\n                <div className=\"text-2xl mb-1\">1ï¸âƒ£</div>\r\n                <p className=\"text-xs font-medium\">Copy Code</p>\r\n              </div>\r\n              <div className=\"p-3 rounded-lg bg-primary/10\">\r\n                <div className=\"text-2xl mb-1\">2ï¸âƒ£</div>\r\n                <p className=\"text-xs font-medium\">Paste in Site</p>\r\n              </div>\r\n              <div className=\"p-3 rounded-lg bg-primary/10\">\r\n                <div className=\"text-2xl mb-1\">3ï¸âƒ£</div>\r\n                <p className=\"text-xs font-medium\">Get Leads!</p>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Copy-paste ready code */}\r\n            <div className=\"space-y-2\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <Label className=\"text-sm font-medium\">Add this to your website</Label>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={async () => {\r\n                    const endpoint = `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/website-form-submit?company_id=${selectedSource?.company_id}`;\r\n                    const script = `<script src=\"${import.meta.env.VITE_SUPABASE_URL}/functions/v1/website-form-submit?embed=true\" data-endpoint=\"${endpoint}\"></script>`;\r\n                    navigator.clipboard.writeText(script);\r\n                    toast.success(\"Code copied! Paste it before </body> tag\");\r\n                    if (selectedSource) {\r\n                      await markWebsiteConnected(selectedSource.id);\r\n                    }\r\n                  }}\r\n                  className=\"gap-1\"\r\n                >\r\n                  <Copy className=\"h-3 w-3\" />\r\n                  Copy Code\r\n                </Button>\r\n              </div>\r\n              <div className=\"p-3 rounded-lg bg-muted font-mono text-xs overflow-x-auto\">\r\n                <code className=\"text-primary break-all\">\r\n                  {`<script src=\"${import.meta.env.VITE_SUPABASE_URL}/functions/v1/website-form-submit?embed=true\" data-endpoint=\"${import.meta.env.VITE_SUPABASE_URL}/functions/v1/website-form-submit?company_id=${selectedSource?.company_id || 'YOUR_COMPANY_ID'}\"></script>`}\r\n                </code>\r\n              </div>\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                Paste this code before the {\"</body>\"} tag on your website. It will automatically capture all form submissions.\r\n              </p>\r\n            </div>\r\n\r\n            {/* Alternative: Direct API */}\r\n            <details className=\"group\">\r\n              <summary className=\"flex items-center gap-2 cursor-pointer text-sm font-medium text-muted-foreground hover:text-foreground\">\r\n                <span className=\"group-open:rotate-90 transition-transform\">â–¶</span>\r\n                Advanced: Direct API Integration\r\n              </summary>\r\n              <div className=\"mt-3 space-y-3 pl-4 border-l-2 border-muted\">\r\n                <div className=\"space-y-2\">\r\n                  <Label className=\"text-xs\">API Endpoint (POST)</Label>\r\n                  <div className=\"flex gap-2\">\r\n                    <Input\r\n                      value={`${import.meta.env.VITE_SUPABASE_URL}/functions/v1/website-form-submit?company_id=${selectedSource?.company_id || ''}`}\r\n                      readOnly\r\n                      className=\"font-mono text-xs h-8\"\r\n                    />\r\n                    <Button variant=\"outline\" size=\"sm\" onClick={() => {\r\n                      navigator.clipboard.writeText(`${import.meta.env.VITE_SUPABASE_URL}/functions/v1/website-form-submit?company_id=${selectedSource?.company_id || ''}`);\r\n                      toast.success(\"API endpoint copied!\");\r\n                    }} className=\"h-8 px-2\">\r\n                      <Copy className=\"h-3 w-3\" />\r\n                    </Button>\r\n                  </div>\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label className=\"text-xs\">Send POST request with JSON:</Label>\r\n                  <pre className=\"text-xs bg-background p-2 rounded border overflow-x-auto\">\r\n                    {`{\r\n  \"name\": \"Customer Name\",\r\n  \"email\": \"email@example.com\",\r\n  \"phone\": \"+971501234567\"\r\n}`}\r\n                  </pre>\r\n                </div>\r\n              </div>\r\n            </details>\r\n\r\n            {/* Quick tips */}\r\n            <div className=\"p-3 rounded-lg bg-green-500/10 border border-green-500/20\">\r\n              <p className=\"text-sm font-medium text-green-700 dark:text-green-400 flex items-center gap-2\">\r\n                <CheckCircle2 className=\"h-4 w-4\" />\r\n                Works with any form!\r\n              </p>\r\n              <p className=\"text-xs text-green-600 dark:text-green-500 mt-1\">\r\n                HTML forms, WordPress, Webflow, React, or any website builder.\r\n              </p>\r\n            </div>\r\n          </div>\r\n\r\n          <DialogFooter>\r\n            <Button variant=\"outline\" onClick={() => setShowWebhookDialog(false)}>\r\n              Close\r\n            </Button>\r\n            <Button onClick={async () => {\r\n              const endpoint = `https://zyqlwkkiyuqnhlvnuewk.supabase.co/functions/v1/website-form-submit?company_id=${selectedSource?.company_id}`;\r\n              const script = `<script src=\"https://zyqlwkkiyuqnhlvnuewk.supabase.co/functions/v1/website-form-submit?embed=true\" data-endpoint=\"${endpoint}\"></script>`;\r\n              navigator.clipboard.writeText(script);\r\n              toast.success(\"Code copied to clipboard!\");\r\n              if (selectedSource) {\r\n                await markWebsiteConnected(selectedSource.id);\r\n              }\r\n              setShowWebhookDialog(false);\r\n            }}>\r\n              <Copy className=\"h-4 w-4 mr-2\" />\r\n              Copy & Close\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Meta Forms/Import Dialog */}\r\n      <Dialog open={showMetaFormsDialog} onOpenChange={setShowMetaFormsDialog}>\r\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\r\n          <DialogHeader>\r\n            <DialogTitle className=\"flex items-center gap-3\">\r\n              <span className=\"text-2xl\">ðŸ“˜</span>\r\n              Import Leads from Meta\r\n            </DialogTitle>\r\n            <DialogDescription>\r\n              Select forms and date range to import leads from your connected Facebook/Instagram pages.\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n\r\n          <div className=\"space-y-6 py-4\">\r\n            {/* Date Range Filter */}\r\n            <div className=\"space-y-3\">\r\n              <Label className=\"text-sm font-medium\">Date Range (Optional)</Label>\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <div className=\"space-y-1.5\">\r\n                  <Label className=\"text-xs text-muted-foreground\">From</Label>\r\n                  <Input\r\n                    type=\"date\"\r\n                    value={dateFrom}\r\n                    onChange={(e) => setDateFrom(e.target.value)}\r\n                    className=\"h-9\"\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-1.5\">\r\n                  <Label className=\"text-xs text-muted-foreground\">To</Label>\r\n                  <Input\r\n                    type=\"date\"\r\n                    value={dateTo}\r\n                    onChange={(e) => setDateTo(e.target.value)}\r\n                    className=\"h-9\"\r\n                  />\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Lead Forms Selection */}\r\n            <div className=\"space-y-3\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <Label className=\"text-sm font-medium\">Lead Forms</Label>\r\n                {metaForms.length > 0 && (\r\n                  <label className=\"flex items-center gap-2 text-sm cursor-pointer\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      checked={selectAllForms}\r\n                      onChange={(e) => handleSelectAllForms(e.target.checked)}\r\n                      className=\"h-4 w-4 rounded border-border\"\r\n                    />\r\n                    Select All ({metaForms.length})\r\n                  </label>\r\n                )}\r\n              </div>\r\n\r\n              {loadingForms ? (\r\n                <div className=\"flex items-center justify-center p-8\">\r\n                  <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\r\n                  <span className=\"ml-2 text-sm text-muted-foreground\">Loading forms...</span>\r\n                </div>\r\n              ) : metaForms.length > 0 ? (\r\n                <div className=\"space-y-2 max-h-[280px] overflow-y-auto rounded-lg border p-2\">\r\n                  {metaForms.map((form) => (\r\n                    <label\r\n                      key={form.id}\r\n                      className={cn(\r\n                        \"flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-colors\",\r\n                        selectedFormIds.has(form.id)\r\n                          ? \"bg-primary/5 border-primary/30\"\r\n                          : \"bg-muted/30 hover:bg-muted/50\"\r\n                      )}\r\n                    >\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        checked={selectedFormIds.has(form.id)}\r\n                        onChange={() => handleFormToggle(form.id)}\r\n                        className=\"h-4 w-4 rounded border-border\"\r\n                      />\r\n                      <div className=\"flex-1 min-w-0\">\r\n                        <p className=\"font-medium text-sm truncate\">{form.name}</p>\r\n                        <p className=\"text-xs text-muted-foreground\">\r\n                          {form.page_name} â€¢ {form.leads_count || 0} leads\r\n                        </p>\r\n                      </div>\r\n                      <Badge\r\n                        variant=\"secondary\"\r\n                        className={cn(\r\n                          \"text-xs\",\r\n                          form.status === 'ACTIVE'\r\n                            ? \"bg-green-500/10 text-green-600\"\r\n                            : \"bg-muted text-muted-foreground\"\r\n                        )}\r\n                      >\r\n                        {form.status || 'ACTIVE'}\r\n                      </Badge>\r\n                    </label>\r\n                  ))}\r\n                </div>\r\n              ) : (\r\n                <div className=\"p-6 rounded-lg border border-dashed text-center\">\r\n                  <p className=\"text-sm text-muted-foreground\">\r\n                    {metaPages.length > 0\r\n                      ? \"No lead forms found on your connected pages.\"\r\n                      : \"No pages connected. Please connect your Facebook pages first.\"}\r\n                  </p>\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* Connected Pages Summary */}\r\n            <div className=\"p-3 rounded-lg bg-muted/30\">\r\n              <div className=\"flex items-center justify-between text-sm\">\r\n                <span className=\"text-muted-foreground\">Connected Pages:</span>\r\n                <span className=\"font-medium\">{metaPages.length}</span>\r\n              </div>\r\n              <div className=\"flex items-center justify-between text-sm mt-1\">\r\n                <span className=\"text-muted-foreground\">Selected Forms:</span>\r\n                <span className=\"font-medium\">\r\n                  {selectAllForms ? 'All' : selectedFormIds.size} of {metaForms.length}\r\n                </span>\r\n              </div>\r\n              {metaFormsSource?.last_fetched_at && (\r\n                <div className=\"flex items-center justify-between text-sm mt-1\">\r\n                  <span className=\"text-muted-foreground\">Last Import:</span>\r\n                  <span className=\"font-medium\">\r\n                    {new Date(metaFormsSource.last_fetched_at).toLocaleDateString()}\r\n                  </span>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          <DialogFooter>\r\n            <Button variant=\"outline\" onClick={() => setShowMetaFormsDialog(false)}>\r\n              Cancel\r\n            </Button>\r\n            <Button\r\n              onClick={handleImportMetaLeads}\r\n              disabled={importing || (metaForms.length > 0 && selectedFormIds.size === 0)}\r\n            >\r\n              {importing ? (\r\n                <>\r\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                  Importing...\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <Zap className=\"h-4 w-4 mr-2\" />\r\n                  Import Leads\r\n                </>\r\n              )}\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* TikTok Forms/Import Dialog */}\r\n      <Dialog open={showTikTokFormsDialog} onOpenChange={setShowTikTokFormsDialog}>\r\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\r\n          <DialogHeader>\r\n            <DialogTitle className=\"flex items-center gap-3\">\r\n              <span className=\"text-2xl\">ðŸŽµ</span>\r\n              Import Leads from TikTok\r\n            </DialogTitle>\r\n            <DialogDescription>\r\n              Select forms and date range to import leads from your connected TikTok ads account.\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n\r\n          <div className=\"space-y-6 py-4\">\r\n            {/* Date Range Filter */}\r\n            <div className=\"space-y-3\">\r\n              <Label className=\"text-sm font-medium\">Date Range (Optional)</Label>\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <div className=\"space-y-1.5\">\r\n                  <Label className=\"text-xs text-muted-foreground\">From</Label>\r\n                  <Input\r\n                    type=\"date\"\r\n                    value={tikTokDateFrom}\r\n                    onChange={(e) => setTikTokDateFrom(e.target.value)}\r\n                    className=\"h-9\"\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-1.5\">\r\n                  <Label className=\"text-xs text-muted-foreground\">To</Label>\r\n                  <Input\r\n                    type=\"date\"\r\n                    value={tikTokDateTo}\r\n                    onChange={(e) => setTikTokDateTo(e.target.value)}\r\n                    className=\"h-9\"\r\n                  />\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Lead Forms Selection */}\r\n            <div className=\"space-y-3\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <Label className=\"text-sm font-medium\">Instant Forms</Label>\r\n                {tikTokForms.length > 0 && (\r\n                  <label className=\"flex items-center gap-2 text-sm cursor-pointer\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      checked={selectAllTikTokForms}\r\n                      onChange={(e) => handleSelectAllTikTokForms(e.target.checked)}\r\n                      className=\"h-4 w-4 rounded border-border\"\r\n                    />\r\n                    Select All ({tikTokForms.length})\r\n                  </label>\r\n                )}\r\n              </div>\r\n\r\n              {loadingTikTokForms ? (\r\n                <div className=\"flex items-center justify-center p-8\">\r\n                  <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\r\n                  <span className=\"ml-2 text-sm text-muted-foreground\">Loading forms...</span>\r\n                </div>\r\n              ) : tikTokForms.length > 0 ? (\r\n                <div className=\"space-y-2 max-h-[280px] overflow-y-auto rounded-lg border p-2\">\r\n                  {tikTokForms.map((form) => (\r\n                    <label\r\n                      key={form.id}\r\n                      className={cn(\r\n                        \"flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-colors\",\r\n                        selectedTikTokFormIds.has(form.id)\r\n                          ? \"bg-primary/5 border-primary/30\"\r\n                          : \"bg-muted/30 hover:bg-muted/50\"\r\n                      )}\r\n                    >\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        checked={selectedTikTokFormIds.has(form.id)}\r\n                        onChange={() => handleTikTokFormToggle(form.id)}\r\n                        className=\"h-4 w-4 rounded border-border\"\r\n                      />\r\n                      <div className=\"flex-1 min-w-0\">\r\n                        <p className=\"font-medium text-sm truncate\">{form.name}</p>\r\n                        <p className=\"text-xs text-muted-foreground\">\r\n                          {form.leads_count || 0} leads\r\n                        </p>\r\n                      </div>\r\n                      <Badge\r\n                        variant=\"secondary\"\r\n                        className={cn(\r\n                          \"text-xs\",\r\n                          form.status === 'ACTIVE'\r\n                            ? \"bg-green-500/10 text-green-600\"\r\n                            : \"bg-muted text-muted-foreground\"\r\n                        )}\r\n                      >\r\n                        {form.status || 'ACTIVE'}\r\n                      </Badge>\r\n                    </label>\r\n                  ))}\r\n                </div>\r\n              ) : (\r\n                <div className=\"p-6 rounded-lg border border-dashed text-center\">\r\n                  <p className=\"text-sm text-muted-foreground\">\r\n                    No instant forms found. Create lead generation forms in your TikTok Ads Manager.\r\n                  </p>\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* Summary */}\r\n            <div className=\"p-3 rounded-lg bg-muted/30\">\r\n              <div className=\"flex items-center justify-between text-sm\">\r\n                <span className=\"text-muted-foreground\">Selected Forms:</span>\r\n                <span className=\"font-medium\">\r\n                  {selectAllTikTokForms ? 'All' : selectedTikTokFormIds.size} of {tikTokForms.length}\r\n                </span>\r\n              </div>\r\n              {tikTokFormsSource?.last_fetched_at && (\r\n                <div className=\"flex items-center justify-between text-sm mt-1\">\r\n                  <span className=\"text-muted-foreground\">Last Import:</span>\r\n                  <span className=\"font-medium\">\r\n                    {new Date(tikTokFormsSource.last_fetched_at).toLocaleDateString()}\r\n                  </span>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          <DialogFooter>\r\n            <Button variant=\"outline\" onClick={() => setShowTikTokFormsDialog(false)}>\r\n              Cancel\r\n            </Button>\r\n            <Button\r\n              onClick={handleImportTikTokLeads}\r\n              disabled={importingTikTok || (tikTokForms.length > 0 && selectedTikTokFormIds.size === 0)}\r\n            >\r\n              {importingTikTok ? (\r\n                <>\r\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                  Importing...\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <Zap className=\"h-4 w-4 mr-2\" />\r\n                  Import Leads\r\n                </>\r\n              )}\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </motion.div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\LeadsPage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'leads' logical expression could make the dependencies of useMemo Hook (at line 133) change on every render. To fix this, wrap the initialization of 'leads' in its own useMemo() Hook.","line":116,"column":9,"nodeType":"VariableDeclarator","endLine":116,"endColumn":32},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'leads' logical expression could make the dependencies of useMemo Hook (at line 141) change on every render. To fix this, wrap the initialization of 'leads' in its own useMemo() Hook.","line":116,"column":9,"nodeType":"VariableDeclarator","endLine":116,"endColumn":32},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'leads' logical expression could make the dependencies of useMemo Hook (at line 170) change on every render. To fix this, wrap the initialization of 'leads' in its own useMemo() Hook.","line":116,"column":9,"nodeType":"VariableDeclarator","endLine":116,"endColumn":32},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'leads' logical expression could make the dependencies of useMemo Hook (at line 178) change on every render. To fix this, wrap the initialization of 'leads' in its own useMemo() Hook.","line":116,"column":9,"nodeType":"VariableDeclarator","endLine":116,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef, useCallback, useMemo } from \"react\";\r\nimport { createPortal } from \"react-dom\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport {\r\n  Search,\r\n  Download,\r\n  MoreHorizontal,\r\n  ChevronDown,\r\n  ArrowUpDown,\r\n  Plus,\r\n  X,\r\n  ChevronLeft,\r\n  ChevronRight,\r\n  Eye,\r\n  UserPlus,\r\n  Trash2,\r\n  Tag,\r\n  FileSpreadsheet,\r\n  Contact,\r\n  CalendarIcon,\r\n  Loader2,\r\n  Users,\r\n  Layers,\r\n  GitBranch,\r\n  RefreshCw,\r\n} from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\";\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuLabel,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { Checkbox } from \"@/components/ui/checkbox\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { StageBadge } from \"@/components/ui/stage-badge\";\r\nimport { GroupBadge } from \"@/components/ui/group-badge\";\r\nimport { SourceBadge } from \"@/components/ui/source-badge\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { Calendar } from \"@/components/ui/calendar\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport {\r\n  Popover,\r\n  PopoverContent,\r\n  PopoverTrigger,\r\n} from \"@/components/ui/popover\";\r\nimport { AddLeadDialog } from \"@/components/leads/AddLeadDialog\";\r\nimport { ExcelImportDialog } from \"@/components/leads/ExcelImportDialog\";\r\nimport { ContactsImportDialog } from \"@/components/leads/ContactsImportDialog\";\r\nimport { ReassignLeadsDialog } from \"@/components/leads/ReassignLeadsDialog\";\r\nimport { ChangeStageDialog } from \"@/components/leads/ChangeStageDialog\";\r\nimport { StageManager } from \"@/components/leads/StageManager\";\r\nimport { GroupManager } from \"@/components/leads/GroupManager\";\r\nimport { NewLeadRow } from \"@/components/leads/NewLeadRow\";\r\nimport { MobileLeadCard } from \"@/components/leads/MobileLeadCard\";\r\nimport { DeleteLeadsDialog } from \"@/components/leads/DeleteLeadsDialog\";\r\nimport { LeadsFilterDialog } from \"@/components/leads/LeadsFilterDialog\";\r\nimport { ExportLeadsDialog } from \"@/components/leads/ExportLeadsDialog\";\r\nimport { ErrorBoundary } from \"@/components/ui/error-boundary\";\r\nimport { useCompanySettings } from \"@/hooks/useCompanySettings\";\r\nimport { PullToRefresh } from \"@/components/ui/pull-to-refresh\";\r\nimport { useUserRole } from \"@/hooks/useUserRole\";\r\nimport { LeadsPageSkeleton } from \"@/components/ui/page-skeletons\";\r\nimport { MobileSearchFilter } from \"@/components/ui/mobile-search-filter\";\r\nimport { useStages } from \"@/contexts/StagesContext\";\r\nimport { useGroups } from \"@/contexts/GroupsContext\";\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport { useLocalization } from \"@/contexts/LocalizationContext\";\r\nimport { useLeads, Lead } from \"@/hooks/useLeads\";\r\nimport { toast } from \"sonner\";\r\nimport { format, startOfDay, endOfDay, startOfWeek, endOfWeek, startOfMonth, endOfMonth, subDays, subWeeks, subMonths } from \"date-fns\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { useDebouncedValue } from \"@/hooks/useDebouncedValue\";\r\n\r\nconst sources = [\"Meta\", \"TikTok\", \"Website\", \"Referral\", \"Google Ads\", \"WhatsApp\", \"Cold Call\", \"Property Finder\"];\r\n\r\n\r\n\r\nfunction LeadsPageContent() {\r\n\r\n\r\n  const navigate = useNavigate();\r\n  const isMobile = useIsMobile();\r\n  const { t, formatRelativeTime, isRTL } = useLocalization();\r\n  const { stages: baseStages = [], setStages } = useStages();\r\n\r\n  // Ensure \"New\" stage exists if not present\r\n  const rawStages = baseStages || [];\r\n  const hasNewStage = rawStages.some(s => s.name === \"New\");\r\n  // If we have \"Uncontacted\" leads but no \"New\" stage, we might need to handle that, \r\n  // but usually \"New\" is a default stage.\r\n\r\n  const { groups: baseGroups = [], setGroups } = useGroups();\r\n  const { leads: leadsData, isLoading, refetch, setLeads, syncPropertyFinderLeads } = useLeads();\r\n  const leads = leadsData || [];\r\n  const { canDeleteLeads, isAdmin } = useUserRole();\r\n  const { settings: companySettings } = useCompanySettings();\r\n\r\n  // Debounced search to prevent excessive filtering\r\n  const [searchQuery, setSearchQuery] = useState(\"\");\r\n  const debouncedSearch = useDebouncedValue(searchQuery, 300);\r\n\r\n  // Calculate lead counts for stages based on actual leads data\r\n  const stages = useMemo(() => {\r\n    return (baseStages || []).map(stage => ({\r\n      ...stage,\r\n      leadCount: leads.filter(lead => {\r\n        const normalized = (!lead.stage || lead.stage === \"Uncontacted\") ? \"New\" : lead.stage;\r\n        return normalized === stage.name;\r\n      }).length\r\n    }));\r\n  }, [baseStages, leads]);\r\n\r\n  // Calculate lead counts for groups based on actual leads data\r\n  const groups = useMemo(() => {\r\n    return (baseGroups || []).map(group => ({\r\n      ...group,\r\n      leadCount: leads.filter(lead => lead.lead_group?.name === group.name).length\r\n    }));\r\n  }, [baseGroups, leads]);\r\n  const [isSyncing, setIsSyncing] = useState(false);\r\n  const [activeTab, setActiveTab] = useState<\"stages\" | \"groups\">(\"stages\");\r\n  const [isSelectionMode, setIsSelectionMode] = useState(false);\r\n  const longPressTimerRef = useRef<NodeJS.Timeout | null>(null);\r\n  const [filterGroup, setFilterGroup] = useState<string>(\"all\");\r\n  const [selectedLeads, setSelectedLeads] = useState<string[]>([]);\r\n  const [currentPage, setCurrentPage] = useState(1);\r\n  const [pageSize, setPageSize] = useState(isMobile ? 20 : 10);\r\n  const [sortBy, setSortBy] = useState(\"created\");\r\n  const [sortOrder, setSortOrder] = useState<\"asc\" | \"desc\">(\"desc\");\r\n\r\n  // Filter states\r\n  const [filterSource, setFilterSource] = useState<string>(\"all\");\r\n  const [filterStage, setFilterStage] = useState<string>(\"all\");\r\n  const [filterAgent, setFilterAgent] = useState<string>(\"all\");\r\n  const [createdDateFrom, setCreatedDateFrom] = useState<Date | undefined>(undefined);\r\n  const [createdDateTo, setCreatedDateTo] = useState<Date | undefined>(undefined);\r\n  const [isFabOpen, setIsFabOpen] = useState(false);\r\n\r\n  // Extract unique agents and sources from leads data\r\n  const availableAgents = useMemo(() => {\r\n    const uniqueAgents = new Map();\r\n    leads.forEach(l => {\r\n      if (l.agent && l.agent.id) {\r\n        uniqueAgents.set(l.agent.id, l.agent.name || \"Unknown Agent\");\r\n      }\r\n    });\r\n    return Array.from(uniqueAgents.entries()).map(([id, name]) => ({ id, name }));\r\n  }, [leads]);\r\n\r\n  const availableSources = useMemo(() => {\r\n    const s = new Set(sources);\r\n    leads.forEach(l => {\r\n      if (l.source) s.add(l.source);\r\n    });\r\n    return Array.from(s);\r\n  }, [leads]);\r\n\r\n  const agentNames = useMemo(() => availableAgents.map(a => a.name).filter(Boolean), [availableAgents]);\r\n  const [isAddLeadOpen, setIsAddLeadOpen] = useState(false);\r\n  const [isExcelImportOpen, setIsExcelImportOpen] = useState(false);\r\n  const [isContactsImportOpen, setIsContactsImportOpen] = useState(false);\r\n  const [isReassignOpen, setIsReassignOpen] = useState(false);\r\n  const [isChangeStageOpen, setIsChangeStageOpen] = useState(false);\r\n  const [singleLeadAction, setSingleLeadAction] = useState<{ type: 'assign' | 'stage'; leadId: string } | null>(null);\r\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\r\n  const [leadsToDelete, setLeadsToDelete] = useState<string[]>([]);\r\n  const [isFilterDialogOpen, setIsFilterDialogOpen] = useState(false);\r\n  const [isExportDialogOpen, setIsExportDialogOpen] = useState(false);\r\n\r\n  // Infinite scroll state for mobile\r\n  const [visibleCount, setVisibleCount] = useState(20);\r\n  const [isLoadingMore, setIsLoadingMore] = useState(false);\r\n  const observerRef = useRef<IntersectionObserver | null>(null);\r\n  const loadMoreRef = useRef<HTMLDivElement>(null);\r\n\r\n  // Reset visible count when any filter changes\r\n  useEffect(() => {\r\n    setVisibleCount(20);\r\n  }, [filterStage, filterGroup, filterSource, filterAgent, searchQuery, createdDateFrom, createdDateTo]);\r\n\r\n  // Infinite scroll observer\r\n  const handleLoadMore = useCallback(() => {\r\n    if (isLoadingMore) return;\r\n    setIsLoadingMore(true);\r\n    setTimeout(() => {\r\n      setVisibleCount(prev => prev + 20);\r\n      setIsLoadingMore(false);\r\n    }, 300);\r\n  }, [isLoadingMore]);\r\n\r\n  useEffect(() => {\r\n    if (!isMobile || !loadMoreRef.current) return;\r\n\r\n    observerRef.current = new IntersectionObserver(\r\n      (entries) => {\r\n        if (entries[0].isIntersecting) {\r\n          handleLoadMore();\r\n        }\r\n      },\r\n      { threshold: 0.1 }\r\n    );\r\n\r\n    observerRef.current.observe(loadMoreRef.current);\r\n\r\n    return () => {\r\n      if (observerRef.current) {\r\n        observerRef.current.disconnect();\r\n      }\r\n    };\r\n  }, [isMobile, handleLoadMore]);\r\n\r\n  const handleRefresh = async () => {\r\n    setVisibleCount(20);\r\n    await new Promise((resolve) => setTimeout(resolve, 1000));\r\n    toast.success(\"Leads refreshed\");\r\n  };\r\n\r\n  const handleSyncPropertyFinder = async () => {\r\n    // Get company_id from profile - for now use a placeholder\r\n    // In production, this would come from AuthContext\r\n    setIsSyncing(true);\r\n    try {\r\n      const result = await syncPropertyFinderLeads('demo-company-id');\r\n      toast.success(`Synced ${result?.inserted || 0} leads from Property Finder`);\r\n    } catch (error: unknown) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Sync failed';\r\n      toast.error(errorMessage);\r\n    } finally {\r\n      setIsSyncing(false);\r\n    }\r\n  };\r\n\r\n  const handleFabOption = (option: string) => {\r\n    setIsFabOpen(false);\r\n    switch (option) {\r\n      case \"manual\":\r\n        setIsAddLeadOpen(true);\r\n        break;\r\n      case \"excel\":\r\n        setIsExcelImportOpen(true);\r\n        break;\r\n      case \"contact\":\r\n        setIsContactsImportOpen(true);\r\n        break;\r\n    }\r\n  };\r\n\r\n  const handleExcelImport = (leads: Record<string, string>[]) => {\r\n\r\n    // In a real app, this would add leads to the database\r\n  };\r\n\r\n  const handleContactsImport = (leads: { name: string; phone: string; email?: string }[]) => {\r\n\r\n    // In a real app, this would add leads to the database\r\n  };\r\n\r\n\r\n  const toggleSelectLead = (id: string) => {\r\n    setSelectedLeads((prev) => {\r\n      const newSelection = prev.includes(id) ? prev.filter((leadId) => leadId !== id) : [...prev, id];\r\n      // Exit selection mode if no leads selected\r\n      if (newSelection.length === 0) {\r\n        setIsSelectionMode(false);\r\n      }\r\n      return newSelection;\r\n    });\r\n  };\r\n\r\n  // Long press handlers for mobile selection\r\n  const handleLongPressStart = (id: string) => {\r\n    longPressTimerRef.current = setTimeout(() => {\r\n      if (navigator.vibrate) navigator.vibrate(50);\r\n      setIsSelectionMode(true);\r\n      setSelectedLeads((prev) => prev.includes(id) ? prev : [...prev, id]);\r\n    }, 500);\r\n  };\r\n\r\n  const handleLongPressEnd = () => {\r\n    if (longPressTimerRef.current) {\r\n      clearTimeout(longPressTimerRef.current);\r\n      longPressTimerRef.current = null;\r\n    }\r\n  };\r\n\r\n  const handleLeadCardClick = (id: string) => {\r\n    if (isSelectionMode) {\r\n      toggleSelectLead(id);\r\n    } else {\r\n      navigate(`/leads/${id}`);\r\n    }\r\n  };\r\n\r\n  const handleSort = (column: string) => {\r\n    if (sortBy === column) {\r\n      setSortOrder(sortOrder === \"asc\" ? \"desc\" : \"asc\");\r\n    } else {\r\n      setSortBy(column);\r\n      setSortOrder(\"asc\");\r\n    }\r\n  };\r\n\r\n  const clearFilters = () => {\r\n    setFilterSource(\"all\");\r\n    setFilterStage(\"all\");\r\n    setFilterAgent(\"all\");\r\n    setCreatedDateFrom(undefined);\r\n    setCreatedDateTo(undefined);\r\n  };\r\n\r\n  const handleBulkAssign = () => {\r\n    setSingleLeadAction(null);\r\n    setIsReassignOpen(true);\r\n  };\r\n\r\n  const handleReassign = (agentId: string, agentName: string) => {\r\n    const leadsToReassign = singleLeadAction ? [singleLeadAction.leadId] : selectedLeads;\r\n    setLeads(prev => prev.map(lead =>\r\n      leadsToReassign.includes(lead.id)\r\n        ? { ...lead, agent: { ...lead.agent, name: agentName } }\r\n        : lead\r\n    ));\r\n    toast.success(`${leadsToReassign.length} lead(s) assigned to ${agentName}`);\r\n    setSelectedLeads([]);\r\n    setSingleLeadAction(null);\r\n  };\r\n\r\n  const handleBulkStageChange = () => {\r\n    setSingleLeadAction(null);\r\n    setIsChangeStageOpen(true);\r\n  };\r\n\r\n  const handleStageChange = async (stageId: string, stageName: string) => {\r\n    const leadsToChange = singleLeadAction ? [singleLeadAction.leadId] : selectedLeads;\r\n\r\n    // Update in database - also mark is_new as false when stage changes\r\n    const { error } = await supabase\r\n      .from(\"leads\")\r\n      .update({\r\n        stage_id: stageId,\r\n        stage: stageName, // Keep text field in sync for backwards compatibility\r\n        is_new: false, // Mark as not new when stage changes\r\n      })\r\n      .in(\"id\", leadsToChange);\r\n\r\n    if (error) {\r\n      console.error(\"Error updating leads stage:\", error);\r\n      toast.error(\"Failed to update lead stages\");\r\n      return;\r\n    }\r\n\r\n    // Update local state with the stage relation\r\n    const selectedStage = stages.find(s => s.id === stageId);\r\n    setLeads(prev => prev.map(lead =>\r\n      leadsToChange.includes(lead.id)\r\n        ? {\r\n          ...lead,\r\n          stage: stageName,\r\n          stage_id: stageId,\r\n          is_new: false, // Mark as not new\r\n          lead_stage: selectedStage ? {\r\n            id: selectedStage.id,\r\n            name: selectedStage.name,\r\n            color: selectedStage.color,\r\n            position: selectedStage.position || 0,\r\n            is_default: selectedStage.is_default || false,\r\n            is_won: selectedStage.is_won || false,\r\n            is_lost: selectedStage.is_lost || false,\r\n          } : null\r\n        }\r\n        : lead\r\n    ));\r\n    toast.success(`${leadsToChange.length} lead(s) moved to ${stageName}`);\r\n    setSelectedLeads([]);\r\n    setSingleLeadAction(null);\r\n  };\r\n\r\n  const handleBulkTag = () => {\r\n    toast.success(`Adding tag to ${selectedLeads.length} leads...`);\r\n  };\r\n\r\n  const handleBulkExport = () => {\r\n    toast.success(`Exporting ${selectedLeads.length} leads...`);\r\n  };\r\n\r\n  const handleBulkDelete = () => {\r\n    if (!canDeleteLeads) {\r\n      toast.error(\"Only admins can delete leads\");\r\n      return;\r\n    }\r\n    setLeadsToDelete(selectedLeads);\r\n    setIsDeleteDialogOpen(true);\r\n  };\r\n\r\n  // Single lead actions from three dots menu\r\n  const handleSingleLeadAssign = (leadId: string) => {\r\n    setSingleLeadAction({ type: 'assign', leadId });\r\n    setIsReassignOpen(true);\r\n  };\r\n\r\n  const handleSingleLeadStageChange = (leadId: string) => {\r\n    setSingleLeadAction({ type: 'stage', leadId });\r\n    setIsChangeStageOpen(true);\r\n  };\r\n\r\n  const handleSingleLeadDelete = (leadId: string) => {\r\n    if (!canDeleteLeads) {\r\n      toast.error(\"Only admins can delete leads\");\r\n      return;\r\n    }\r\n    setLeadsToDelete([leadId]);\r\n    setIsDeleteDialogOpen(true);\r\n  };\r\n\r\n  const handleDeleteSuccess = () => {\r\n    setLeads(prev => prev.filter(lead => !leadsToDelete.includes(lead.id)));\r\n    setSelectedLeads(prev => prev.filter(id => !leadsToDelete.includes(id)));\r\n    setLeadsToDelete([]);\r\n  };\r\n\r\n  // Inline edit handler - also updates is_new in database\r\n  const handleInlineUpdate = async (leadId: string, updates: Partial<Lead>) => {\r\n    // If stage changes or if is_new is explicitly set to false, update in database too\r\n    if (updates.stage || updates.is_new === false) {\r\n      const dbUpdates: Record<string, unknown> = { ...updates };\r\n      if (updates.stage) {\r\n        dbUpdates.is_new = false; // Mark as not new when stage changes\r\n      }\r\n      delete dbUpdates.agent;\r\n      delete dbUpdates.lead_group;\r\n      delete dbUpdates.lead_stage;\r\n\r\n      await supabase\r\n        .from(\"leads\")\r\n        .update(dbUpdates)\r\n        .eq(\"id\", leadId);\r\n    }\r\n\r\n    // Update local state\r\n    setLeads(prev => prev.map(lead =>\r\n      lead.id === leadId ? { ...lead, ...updates, is_new: updates.stage ? false : lead.is_new } : lead\r\n    ));\r\n    toast.success(\"Lead updated\");\r\n  };\r\n\r\n  const handleImport = () => {\r\n    setIsExcelImportOpen(true);\r\n  };\r\n\r\n  const handleExport = () => {\r\n    setIsExportDialogOpen(true);\r\n  };\r\n\r\n  const getSourceBadgeColor = (source: string) => {\r\n    const colors: Record<string, string> = {\r\n      \"Meta\": \"bg-blue-100 text-blue-700 border-blue-200\",\r\n      \"TikTok\": \"bg-pink-100 text-pink-700 border-pink-200\",\r\n      \"Website\": \"bg-emerald-100 text-emerald-700 border-emerald-200\",\r\n      \"Referral\": \"bg-purple-100 text-purple-700 border-purple-200\",\r\n      \"Google Ads\": \"bg-red-100 text-red-700 border-red-200\",\r\n      \"WhatsApp\": \"bg-green-100 text-green-700 border-green-200\",\r\n    };\r\n    return colors[source] || \"bg-muted text-muted-foreground\";\r\n  };\r\n\r\n  // Helper to normalize stage names (e.g. legacy \"Uncontacted\" -> \"New\")\r\n  const normalizeStage = (stageName: string | null) => {\r\n    if (!stageName) return \"New\";\r\n    if (stageName === \"Uncontacted\") return \"New\";\r\n    return stageName;\r\n  };\r\n\r\n  // Count leads per stage (excluding Lost from \"All\" count)\r\n  const stageCounts = stages.reduce((acc, stage) => {\r\n    acc[stage.name] = leads.filter(lead => normalizeStage(lead.stage) === stage.name).length;\r\n    return acc;\r\n  }, {} as Record<string, number>);\r\n\r\n  // Filter leads: apply all filters\r\n  const filteredLeads = leads.filter(lead => {\r\n    // Hide Lost leads unless specifically filtering by Lost\r\n    if (lead.stage === \"Lost\" && filterStage !== \"Lost\" && filterStage !== \"all\") {\r\n      return false;\r\n    }\r\n\r\n    // Apply stage filter\r\n    if (filterStage !== \"all\" && normalizeStage(lead.stage) !== filterStage) {\r\n      return false;\r\n    }\r\n\r\n    // Apply group filter\r\n    if (filterGroup !== \"all\" && lead.lead_group?.name !== filterGroup) {\r\n      return false;\r\n    }\r\n\r\n    // Apply source filter\r\n    if (filterSource !== \"all\" && lead.source !== filterSource) {\r\n      return false;\r\n    }\r\n\r\n    // Apply agent filter\r\n    if (filterAgent !== \"all\" && lead.agent?.name !== filterAgent) {\r\n      return false;\r\n    }\r\n\r\n    // Apply search query\r\n    if (debouncedSearch.trim()) {\r\n      const query = debouncedSearch.toLowerCase();\r\n      const matchesName = lead.name?.toLowerCase().includes(query);\r\n      const matchesPhone = lead.phone?.toLowerCase().includes(query);\r\n      const matchesEmail = lead.email?.toLowerCase().includes(query);\r\n      if (!matchesName && !matchesPhone && !matchesEmail) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    // Apply date filter\r\n    if (createdDateFrom || createdDateTo) {\r\n      const leadDate = new Date(lead.created_at);\r\n      if (createdDateFrom && leadDate < createdDateFrom) {\r\n        return false;\r\n      }\r\n      if (createdDateTo && leadDate > createdDateTo) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    return true;\r\n  });\r\n\r\n  // Count for \"All\" excludes Lost\r\n  const allCount = leads.filter(lead => lead.stage !== \"Lost\").length;\r\n\r\n  // Pagination based on filtered leads\r\n  const totalLeads = filteredLeads.length;\r\n  const totalPages = Math.ceil(totalLeads / pageSize);\r\n\r\n  // Get current page leads for select all functionality\r\n  const currentPageLeads = useMemo(() => {\r\n    return filteredLeads.slice((currentPage - 1) * pageSize, currentPage * pageSize);\r\n  }, [filteredLeads, currentPage, pageSize]);\r\n\r\n  const toggleSelectAll = () => {\r\n    const currentPageIds = currentPageLeads.map((lead) => lead.id);\r\n    const allCurrentPageSelected = currentPageIds.every(id => selectedLeads.includes(id));\r\n\r\n    if (allCurrentPageSelected) {\r\n      // Deselect all current page leads\r\n      setSelectedLeads(prev => prev.filter(id => !currentPageIds.includes(id)));\r\n    } else {\r\n      // Select all current page leads (merge with existing selections)\r\n      setSelectedLeads(prev => {\r\n        const newSelection = [...prev];\r\n        currentPageIds.forEach(id => {\r\n          if (!newSelection.includes(id)) {\r\n            newSelection.push(id);\r\n          }\r\n        });\r\n        return newSelection;\r\n      });\r\n    }\r\n  };\r\n\r\n  const content = (\r\n    <div className=\"space-y-4 md:space-y-6\">\r\n      {/* Page Header - Hidden on mobile */}\r\n      {!isMobile && (\r\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\r\n          <div>\r\n            <h1 className=\"text-xl font-bold text-foreground sm:text-2xl md:text-3xl\">{t('leads')}</h1>\r\n            <p className=\"text-muted-foreground text-xs sm:text-sm\">{t('manage_track_leads')}</p>\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <Button variant=\"outline\" size=\"sm\" onClick={handleSyncPropertyFinder} disabled={isSyncing} className=\"flex-1 sm:flex-none\">\r\n              <RefreshCw className={cn(\"h-4 w-4 sm:mr-2\", isSyncing && \"animate-spin\")} />\r\n              <span className=\"hidden sm:inline\">{isSyncing ? 'Syncing...' : 'Sync PF'}</span>\r\n            </Button>\r\n            <Button variant=\"outline\" size=\"sm\" onClick={handleExport} className=\"flex-1 sm:flex-none\">\r\n              <Download className=\"h-4 w-4 sm:mr-2\" />\r\n              <span className=\"hidden sm:inline\">{t('export')}</span>\r\n            </Button>\r\n            <DropdownMenu>\r\n              <DropdownMenuTrigger asChild>\r\n                <Button size=\"sm\">\r\n                  <Plus className=\"h-4 w-4 mr-2\" />\r\n                  {t('add_lead')}\r\n                </Button>\r\n              </DropdownMenuTrigger>\r\n              <DropdownMenuContent align=\"end\" className=\"w-48\">\r\n                <DropdownMenuItem onClick={() => setIsAddLeadOpen(true)}>\r\n                  <UserPlus className=\"h-4 w-4 mr-2\" />\r\n                  Manual Add\r\n                </DropdownMenuItem>\r\n                <DropdownMenuSeparator />\r\n                <DropdownMenuItem onClick={() => setIsExcelImportOpen(true)}>\r\n                  <FileSpreadsheet className=\"h-4 w-4 mr-2\" />\r\n                  Import Excel\r\n                </DropdownMenuItem>\r\n                <DropdownMenuItem onClick={() => setIsContactsImportOpen(true)}>\r\n                  <Contact className=\"h-4 w-4 mr-2\" />\r\n                  From Contacts\r\n                </DropdownMenuItem>\r\n              </DropdownMenuContent>\r\n            </DropdownMenu>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Stages & Groups Tabs - Desktop only */}\r\n      <Card className=\"p-3 sm:p-4 hidden lg:block\">\r\n        <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as \"stages\" | \"groups\")}>\r\n          <div className=\"flex items-center justify-between mb-3\">\r\n            <TabsList className=\"h-8\">\r\n              <TabsTrigger value=\"stages\" className=\"gap-1.5 text-xs px-3\">\r\n                <Layers className=\"h-3.5 w-3.5\" />\r\n                Stages\r\n              </TabsTrigger>\r\n              <TabsTrigger value=\"groups\" className=\"gap-1.5 text-xs px-3\">\r\n                <Users className=\"h-3.5 w-3.5\" />\r\n                Groups\r\n              </TabsTrigger>\r\n            </TabsList>\r\n            {activeTab === \"stages\" && filterStage !== \"all\" && (\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                className=\"h-6 text-xs text-muted-foreground\"\r\n                onClick={() => setFilterStage(\"all\")}\r\n              >\r\n                <X className=\"h-3 w-3 mr-1\" />\r\n                Clear filter\r\n              </Button>\r\n            )}\r\n            {activeTab === \"groups\" && filterGroup !== \"all\" && (\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                className=\"h-6 text-xs text-muted-foreground\"\r\n                onClick={() => setFilterGroup(\"all\")}\r\n              >\r\n                <X className=\"h-3 w-3 mr-1\" />\r\n                Clear filter\r\n              </Button>\r\n            )}\r\n          </div>\r\n          <TabsContent value=\"stages\" className=\"mt-0\">\r\n            <StageManager\r\n              stages={stages}\r\n              onStagesChange={setStages}\r\n              onStageFilter={(stageName) => setFilterStage(filterStage === stageName ? \"all\" : stageName)}\r\n              activeStage={filterStage !== \"all\" ? filterStage : undefined}\r\n              isAdmin={true}\r\n            />\r\n          </TabsContent>\r\n          <TabsContent value=\"groups\" className=\"mt-0\">\r\n            <GroupManager\r\n              groups={groups}\r\n              onGroupsChange={setGroups}\r\n              onGroupFilter={(groupName) => setFilterGroup(filterGroup === groupName ? \"all\" : groupName)}\r\n              activeGroup={filterGroup !== \"all\" ? filterGroup : undefined}\r\n              isAdmin={true}\r\n            />\r\n          </TabsContent>\r\n        </Tabs>\r\n      </Card>\r\n\r\n      {/* Search & Filters - Desktop Only */}\r\n      <Card className=\"hidden lg:block p-4 rounded-2xl shadow-subtle border-border/60\">\r\n        <div className=\"flex flex-col gap-3\">\r\n          {/* Search - Beautiful Mobile Design */}\r\n          <div className=\"relative\">\r\n            <Search className=\"absolute left-4 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n            <Input\r\n              placeholder={t('search_leads')}\r\n              className=\"pl-11 h-12 rounded-2xl bg-muted/40 border-0 text-base focus-visible:ring-2 focus-visible:ring-primary/30 focus-visible:bg-background placeholder:text-muted-foreground/60\"\r\n              value={searchQuery}\r\n              onChange={(e) => setSearchQuery(e.target.value)}\r\n            />\r\n            {searchQuery && (\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"icon\"\r\n                className=\"absolute right-2 top-1/2 -translate-y-1/2 h-8 w-8\"\r\n                onClick={() => setSearchQuery(\"\")}\r\n              >\r\n                <X className=\"h-4 w-4\" />\r\n              </Button>\r\n            )}\r\n          </div>\r\n\r\n          {/* Filter Row - Modern Pill Design */}\r\n          <div className=\"flex items-center gap-2 overflow-x-auto no-scrollbar pb-1\">\r\n            {/* Source Filter */}\r\n            <Select value={filterSource} onValueChange={setFilterSource}>\r\n              <SelectTrigger className={cn(\r\n                \"w-auto min-w-[110px] h-9 rounded-full text-xs font-medium gap-1.5 transition-all flex-shrink-0\",\r\n                filterSource !== \"all\"\r\n                  ? \"bg-primary text-primary-foreground border-primary hover:bg-primary/90\"\r\n                  : \"bg-muted/50 border-transparent hover:bg-muted\"\r\n              )}>\r\n                <SelectValue placeholder=\"Source\" />\r\n              </SelectTrigger>\r\n              <SelectContent className=\"bg-popover rounded-xl\">\r\n                <SelectItem value=\"all\">All Sources</SelectItem>\r\n                {sources.map(s => <SelectItem key={s} value={s}>{s}</SelectItem>)}\r\n              </SelectContent>\r\n            </Select>\r\n\r\n            {/* Agent Filter */}\r\n            <Select value={filterAgent} onValueChange={setFilterAgent}>\r\n              <SelectTrigger className={cn(\r\n                \"w-auto min-w-[100px] h-9 rounded-full text-xs font-medium gap-1.5 transition-all flex-shrink-0\",\r\n                filterAgent !== \"all\"\r\n                  ? \"bg-primary text-primary-foreground border-primary hover:bg-primary/90\"\r\n                  : \"bg-muted/50 border-transparent hover:bg-muted\"\r\n              )}>\r\n                <SelectValue placeholder=\"Agent\" />\r\n              </SelectTrigger>\r\n              <SelectContent className=\"bg-popover rounded-xl\">\r\n                <SelectItem value=\"all\">All Agents</SelectItem>\r\n                {agentNames.map(a => <SelectItem key={a} value={a}>{a}</SelectItem>)}\r\n              </SelectContent>\r\n            </Select>\r\n\r\n            {/* Stage Filter - Desktop only (mobile uses chips) */}\r\n            <Select value={filterStage} onValueChange={setFilterStage}>\r\n              <SelectTrigger className={cn(\r\n                \"w-auto min-w-[100px] h-9 rounded-full text-xs font-medium gap-1.5 transition-all hidden lg:flex\",\r\n                filterStage !== \"all\"\r\n                  ? \"bg-primary text-primary-foreground border-primary hover:bg-primary/90\"\r\n                  : \"bg-muted/50 border-transparent hover:bg-muted\"\r\n              )}>\r\n                <SelectValue placeholder=\"Stage\" />\r\n              </SelectTrigger>\r\n              <SelectContent className=\"bg-popover rounded-xl\">\r\n                <SelectItem value=\"all\">All Stages</SelectItem>\r\n                {stages.map(s => <SelectItem key={s.id} value={s.name}>{s.name}</SelectItem>)}\r\n              </SelectContent>\r\n            </Select>\r\n\r\n            {/* Date Filter */}\r\n            <Popover>\r\n              <PopoverTrigger asChild>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  className={cn(\r\n                    \"h-9 gap-1.5 rounded-full text-xs font-medium px-4 transition-all flex-shrink-0\",\r\n                    (createdDateFrom || createdDateTo)\r\n                      ? \"bg-primary text-primary-foreground border-primary hover:bg-primary/90\"\r\n                      : \"bg-muted/50 border-transparent hover:bg-muted\"\r\n                  )}\r\n                >\r\n                  <CalendarIcon className=\"h-3.5 w-3.5\" />\r\n                  <span className=\"hidden sm:inline\">\r\n                    {createdDateFrom ? format(createdDateFrom, \"MMM d\") : \"Date\"}\r\n                    {createdDateTo && createdDateFrom ? ` - ${format(createdDateTo, \"MMM d\")}` : \"\"}\r\n                  </span>\r\n                  <span className=\"sm:hidden\">Date</span>\r\n                </Button>\r\n              </PopoverTrigger>\r\n              <PopoverContent className=\"w-auto p-4 rounded-2xl\" align=\"start\">\r\n                <div className=\"space-y-4\">\r\n                  <div className=\"flex flex-wrap gap-2\">\r\n                    <Button\r\n                      variant={createdDateFrom && format(createdDateFrom, \"yyyy-MM-dd\") === format(new Date(), \"yyyy-MM-dd\") ? \"default\" : \"outline\"}\r\n                      size=\"sm\"\r\n                      className=\"h-8 text-xs rounded-full\"\r\n                      onClick={() => {\r\n                        const today = new Date();\r\n                        setCreatedDateFrom(startOfDay(today));\r\n                        setCreatedDateTo(endOfDay(today));\r\n                      }}\r\n                    >\r\n                      Today\r\n                    </Button>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      className=\"h-8 text-xs rounded-full\"\r\n                      onClick={() => {\r\n                        const yesterday = subDays(new Date(), 1);\r\n                        setCreatedDateFrom(startOfDay(yesterday));\r\n                        setCreatedDateTo(endOfDay(yesterday));\r\n                      }}\r\n                    >\r\n                      Yesterday\r\n                    </Button>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      className=\"h-8 text-xs rounded-full\"\r\n                      onClick={() => {\r\n                        const today = new Date();\r\n                        setCreatedDateFrom(startOfWeek(today, { weekStartsOn: 1 }));\r\n                        setCreatedDateTo(endOfWeek(today, { weekStartsOn: 1 }));\r\n                      }}\r\n                    >\r\n                      This Week\r\n                    </Button>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      className=\"h-8 text-xs rounded-full\"\r\n                      onClick={() => {\r\n                        const today = new Date();\r\n                        setCreatedDateFrom(startOfMonth(today));\r\n                        setCreatedDateTo(endOfMonth(today));\r\n                      }}\r\n                    >\r\n                      This Month\r\n                    </Button>\r\n                  </div>\r\n                  <Separator />\r\n                  <div className=\"grid grid-cols-2 gap-3\">\r\n                    <div className=\"space-y-1.5\">\r\n                      <span className=\"text-xs font-medium text-muted-foreground\">From</span>\r\n                      <Calendar\r\n                        mode=\"single\"\r\n                        selected={createdDateFrom}\r\n                        onSelect={setCreatedDateFrom}\r\n                        className=\"rounded-xl border p-2\"\r\n                      />\r\n                    </div>\r\n                    <div className=\"space-y-1.5\">\r\n                      <span className=\"text-xs font-medium text-muted-foreground\">To</span>\r\n                      <Calendar\r\n                        mode=\"single\"\r\n                        selected={createdDateTo}\r\n                        onSelect={setCreatedDateTo}\r\n                        className=\"rounded-xl border p-2\"\r\n                      />\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </PopoverContent>\r\n            </Popover>\r\n\r\n            {/* Clear Filters */}\r\n            {(filterSource !== \"all\" || filterAgent !== \"all\" || filterStage !== \"all\" || createdDateFrom) && (\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                className=\"h-9 text-xs font-medium text-destructive hover:text-destructive hover:bg-destructive/10 rounded-full px-4 flex-shrink-0\"\r\n                onClick={clearFilters}\r\n              >\r\n                <X className=\"h-3.5 w-3.5 mr-1.5\" />\r\n                Clear\r\n              </Button>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Bulk Actions - Beautiful Mobile Design */}\r\n        {selectedLeads.length > 0 && (\r\n          <div className=\"mt-4 pt-4 border-t border-border/50 animate-fade-in\">\r\n            {/* Header row with count and cancel */}\r\n            <div className=\"flex items-center justify-between mb-3\">\r\n              <Badge variant=\"secondary\" className=\"font-semibold text-sm px-3 py-1\">\r\n                {selectedLeads.length} selected\r\n              </Badge>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={() => setSelectedLeads([])}\r\n                className=\"text-muted-foreground hover:text-foreground\"\r\n              >\r\n                <X className=\"h-4 w-4 mr-1\" />{t('cancel')}</Button>\r\n            </div>\r\n\r\n            {/* Action buttons grid */}\r\n            <div className={cn(\"grid gap-2\", canDeleteLeads ? \"grid-cols-5\" : \"grid-cols-4\")}>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={handleBulkAssign}\r\n                className=\"flex flex-col items-center justify-center h-14 p-1\"\r\n              >\r\n                <UserPlus className=\"h-4 w-4 mb-1\" />\r\n                <span className=\"text-[10px]\">Assign</span>\r\n              </Button>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={handleBulkStageChange}\r\n                className=\"flex flex-col items-center justify-center h-14 p-1\"\r\n              >\r\n                <GitBranch className=\"h-4 w-4 mb-1\" />\r\n                <span className=\"text-[10px]\">Stage</span>\r\n              </Button>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={handleBulkTag}\r\n                className=\"flex flex-col items-center justify-center h-14 p-1\"\r\n              >\r\n                <Tag className=\"h-4 w-4 mb-1\" />\r\n                <span className=\"text-[10px]\">Tag</span>\r\n              </Button>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={handleBulkExport}\r\n                className=\"flex flex-col items-center justify-center h-14 p-1\"\r\n              >\r\n                <Download className=\"h-4 w-4 mb-1\" />\r\n                <span className=\"text-[10px]\">{t('export')}</span>\r\n              </Button>\r\n              {canDeleteLeads && (\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={handleBulkDelete}\r\n                  className=\"flex flex-col items-center justify-center h-14 p-1 text-destructive hover:text-destructive border-destructive/30 hover:bg-destructive/10\"\r\n                >\r\n                  <Trash2 className=\"h-4 w-4 mb-1\" />\r\n                  <span className=\"text-[10px]\">{t('delete')}</span>\r\n                </Button>\r\n              )}\r\n            </div>\r\n          </div>\r\n        )}\r\n      </Card>\r\n\r\n      {/* Desktop Table */}\r\n      <Card className=\"hidden lg:block overflow-hidden\">\r\n        <div className=\"overflow-x-auto\">\r\n          <Table>\r\n            <TableHeader>\r\n              <TableRow className=\"bg-muted/50\">\r\n                <TableHead className=\"w-12\">\r\n                  <Checkbox\r\n                    checked={currentPageLeads.length > 0 && currentPageLeads.every(lead => selectedLeads.includes(lead.id))}\r\n                    onCheckedChange={toggleSelectAll}\r\n                  />\r\n                </TableHead>\r\n                <TableHead className=\"cursor-pointer\" onClick={() => handleSort(\"name\")}>\r\n                  <div className=\"flex items-center gap-1\">\r\n                    Lead Name\r\n                    <ArrowUpDown className=\"h-3 w-3\" />\r\n                  </div>\r\n                </TableHead>\r\n                <TableHead>{t('phone')}</TableHead>\r\n                <TableHead>Source</TableHead>\r\n                <TableHead>Stage</TableHead>\r\n                <TableHead>Agent</TableHead>\r\n                <TableHead className=\"cursor-pointer\" onClick={() => handleSort(\"created\")}>\r\n                  <div className=\"flex items-center gap-1\">{t('created')}<ArrowUpDown className=\"h-3 w-3\" />\r\n                  </div>\r\n                </TableHead>\r\n                <TableHead>Group</TableHead>\r\n                <TableHead className=\"w-12\"></TableHead>\r\n              </TableRow>\r\n            </TableHeader>\r\n            <TableBody>\r\n              {filteredLeads.slice((currentPage - 1) * pageSize, currentPage * pageSize).map((lead) => (\r\n                <NewLeadRow\r\n                  key={lead.id}\r\n                  lead={lead}\r\n                  isSelected={selectedLeads.includes(lead.id)}\r\n                  onToggleSelect={() => toggleSelectLead(lead.id)}\r\n                  onNavigate={() => navigate(`/leads/${lead.id}`)}\r\n                  onUpdate={(updates) => handleInlineUpdate(lead.id, updates)}\r\n                  getSourceBadgeColor={getSourceBadgeColor}\r\n                  agents={agentNames}\r\n                  companySettings={companySettings ? {\r\n                    new_lead_badge_color: companySettings.new_lead_badge_color,\r\n                    new_lead_background_color: companySettings.new_lead_background_color,\r\n                    new_lead_animation: companySettings.new_lead_animation,\r\n                  } : undefined}\r\n                  renderActions={() => (\r\n                    <DropdownMenu>\r\n                      <DropdownMenuTrigger asChild>\r\n                        <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\r\n                          <MoreHorizontal className=\"h-4 w-4\" />\r\n                        </Button>\r\n                      </DropdownMenuTrigger>\r\n                      <DropdownMenuContent align=\"end\" className=\"bg-popover\">\r\n                        <DropdownMenuItem onClick={() => navigate(`/leads/${lead.id}`)}>\r\n                          <Eye className=\"h-4 w-4 mr-2\" />\r\n                          View Details\r\n                        </DropdownMenuItem>\r\n                        <DropdownMenuSeparator />\r\n                        <DropdownMenuItem onClick={() => handleSingleLeadAssign(lead.id)}>\r\n                          <UserPlus className=\"h-4 w-4 mr-2\" />\r\n                          Assign to Agent\r\n                        </DropdownMenuItem>\r\n                        <DropdownMenuItem onClick={() => handleSingleLeadStageChange(lead.id)}>\r\n                          <ChevronDown className=\"h-4 w-4 mr-2\" />\r\n                          Change Stage\r\n                        </DropdownMenuItem>\r\n                        {canDeleteLeads && (\r\n                          <>\r\n                            <DropdownMenuSeparator />\r\n                            <DropdownMenuItem\r\n                              className=\"text-destructive focus:text-destructive\"\r\n                              onClick={() => handleSingleLeadDelete(lead.id)}\r\n                            >\r\n                              <Trash2 className=\"h-4 w-4 mr-2\" />{t('delete')}</DropdownMenuItem>\r\n                          </>\r\n                        )}\r\n                      </DropdownMenuContent>\r\n                    </DropdownMenu>\r\n                  )}\r\n                />\r\n              ))}\r\n            </TableBody>\r\n          </Table>\r\n        </div>\r\n\r\n        {/* Pagination */}\r\n        <div className=\"flex items-center justify-between px-4 py-3 border-t\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <p className=\"text-sm text-muted-foreground\">\r\n              Showing {(currentPage - 1) * pageSize + 1} to {Math.min(currentPage * pageSize, totalLeads)} of {totalLeads} leads\r\n            </p>\r\n            <Select value={String(pageSize)} onValueChange={(v) => setPageSize(Number(v))}>\r\n              <SelectTrigger className=\"w-[80px] h-8\">\r\n                <SelectValue />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"10\">10</SelectItem>\r\n                <SelectItem value=\"25\">25</SelectItem>\r\n                <SelectItem value=\"50\">50</SelectItem>\r\n                <SelectItem value=\"100\">100</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={() => setCurrentPage(p => Math.max(1, p - 1))}\r\n              disabled={currentPage === 1}\r\n            >\r\n              <ChevronLeft className=\"h-4 w-4\" />\r\n              Previous\r\n            </Button>\r\n            <span className=\"text-sm px-2\">\r\n              Page {currentPage} of {totalPages}\r\n            </span>\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}\r\n              disabled={currentPage === totalPages}\r\n            >{t('next')}<ChevronRight className=\"h-4 w-4\" />\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </Card>\r\n\r\n      {/* Mobile Search & Filter Bar */}\r\n      <div className=\"lg:hidden\">\r\n        <MobileSearchFilter\r\n          searchQuery={searchQuery}\r\n          onSearchChange={setSearchQuery}\r\n          placeholder=\"Search clients & phone...\"\r\n          onFilterClick={() => setIsFilterDialogOpen(true)}\r\n        />\r\n      </div>\r\n\r\n      {/* Mobile/Tablet Stage Filter Chips - Fixed padding for no cutoff */}\r\n      <div className=\"lg:hidden w-full overflow-x-auto no-scrollbar\">\r\n        <div className=\"flex gap-2 pb-3 px-4\" style={{ paddingLeft: '16px', paddingRight: '16px' }}>\r\n          <button\r\n            onClick={() => setFilterStage(\"all\")}\r\n            className={cn(\r\n              \"flex-shrink-0 px-4 py-2.5 rounded-full text-xs font-semibold transition-all duration-200 flex items-center gap-2 shadow-sm active:scale-95\",\r\n              filterStage === \"all\"\r\n                ? \"bg-primary text-primary-foreground shadow-md shadow-primary/25\"\r\n                : \"bg-card text-foreground border border-border hover:bg-muted/50\"\r\n            )}\r\n          >\r\n            All\r\n            <span className={cn(\r\n              \"px-2 py-0.5 rounded-full text-[11px] font-bold min-w-[24px] text-center\",\r\n              filterStage === \"all\"\r\n                ? \"bg-primary-foreground/20 text-primary-foreground\"\r\n                : \"bg-primary/10 text-primary\"\r\n            )}>\r\n              {allCount}\r\n            </span>\r\n          </button>\r\n          {stages.map((stage) => (\r\n            <button\r\n              key={stage.id}\r\n              onClick={() => setFilterStage(stage.name)}\r\n              className={cn(\r\n                \"flex-shrink-0 px-4 py-2.5 rounded-full text-xs font-semibold transition-all duration-200 flex items-center gap-2 shadow-sm active:scale-95\",\r\n                filterStage === stage.name\r\n                  ? \"text-white shadow-md\"\r\n                  : \"bg-card text-foreground border border-border hover:bg-muted/50\"\r\n              )}\r\n              style={filterStage === stage.name ? { backgroundColor: stage.color, boxShadow: `0 4px 12px ${stage.color}40` } : undefined}\r\n            >\r\n              <span\r\n                className=\"h-2 w-2 rounded-full flex-shrink-0\"\r\n                style={{ backgroundColor: filterStage === stage.name ? 'white' : stage.color }}\r\n              />\r\n              {stage.name}\r\n              <span className={cn(\r\n                \"px-2 py-0.5 rounded-full text-[11px] font-bold min-w-[24px] text-center\",\r\n                filterStage === stage.name\r\n                  ? \"bg-white/20 text-white\"\r\n                  : \"bg-muted text-muted-foreground\"\r\n              )}>\r\n                {stageCounts[stage.name] || 0}\r\n              </span>\r\n            </button>\r\n          ))}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Mobile/Tablet Cards with Infinite Scroll */}\r\n      <div className=\"lg:hidden space-y-2 pb-24 px-1\">\r\n        {/* Selection mode indicator */}\r\n        {isSelectionMode && (\r\n          <div className=\"flex items-center justify-between bg-primary/10 p-3 rounded-xl mb-2 mx-1\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <Badge variant=\"secondary\" className=\"font-bold text-primary bg-primary/20\">\r\n                {selectedLeads.length}\r\n              </Badge>\r\n              <span className=\"text-sm font-medium text-primary\">\r\n                leads selected\r\n              </span>\r\n            </div>\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              className=\"h-8 text-xs font-medium\"\r\n              onClick={() => {\r\n                setIsSelectionMode(false);\r\n                setSelectedLeads([]);\r\n              }}\r\n            >\r\n              <X className=\"h-3.5 w-3.5 mr-1\" />{t('cancel')}</Button>\r\n          </div>\r\n        )}\r\n\r\n        {/* Lead count indicator */}\r\n        {!isSelectionMode && filteredLeads.length > 0 && (\r\n          <div className=\"flex items-center justify-between px-2 py-1\">\r\n            <span className=\"text-xs text-muted-foreground\">\r\n              {filteredLeads.length} {filteredLeads.length === 1 ? 'lead' : 'leads'}\r\n            </span>\r\n            <span className=\"text-xs text-muted-foreground\">\r\n              Long press to select\r\n            </span>\r\n          </div>\r\n        )}\r\n\r\n        {/* Lead Cards */}\r\n        {filteredLeads.slice(0, visibleCount).map((lead) => (\r\n          <MobileLeadCard\r\n            key={lead.id}\r\n            lead={lead}\r\n            isSelected={selectedLeads.includes(lead.id)}\r\n            isSelectionMode={isSelectionMode}\r\n            onSelect={() => toggleSelectLead(lead.id)}\r\n            onClick={() => handleLeadCardClick(lead.id)}\r\n            onLongPressStart={() => handleLongPressStart(lead.id)}\r\n            onLongPressEnd={handleLongPressEnd}\r\n            onViewDetails={() => navigate(`/leads/${lead.id}`)}\r\n            onAssign={() => handleSingleLeadAssign(lead.id)}\r\n            onChangeStage={() => handleSingleLeadStageChange(lead.id)}\r\n            onDelete={() => handleSingleLeadDelete(lead.id)}\r\n            canDelete={canDeleteLeads}\r\n            companySettings={companySettings ? {\r\n              new_lead_badge_color: companySettings.new_lead_badge_color,\r\n              new_lead_background_color: companySettings.new_lead_background_color,\r\n              new_lead_animation: companySettings.new_lead_animation,\r\n            } : undefined}\r\n          />\r\n        ))}\r\n\r\n        {/* Infinite Scroll Loader with Skeleton Cards */}\r\n        {visibleCount < filteredLeads.length && (\r\n          <div ref={loadMoreRef}>\r\n            {isLoadingMore ? (\r\n              <div className=\"space-y-3\">\r\n                {[1, 2, 3].map((i) => (\r\n                  <div key={i} className=\"bg-card rounded-2xl border border-border/60 p-4 animate-pulse\">\r\n                    <div className=\"flex items-start gap-3\">\r\n                      <div className=\"h-12 w-12 rounded-full bg-muted flex-shrink-0\" />\r\n                      <div className=\"flex-1 space-y-3\">\r\n                        <div className=\"flex items-center justify-between gap-2\">\r\n                          <div className=\"h-4 w-32 bg-muted rounded\" />\r\n                          <div className=\"h-5 w-12 bg-muted rounded-full\" />\r\n                        </div>\r\n                        <div className=\"h-3 w-24 bg-muted rounded\" />\r\n                        <div className=\"flex gap-2 mt-2\">\r\n                          <div className=\"h-6 w-16 bg-muted rounded-full\" />\r\n                          <div className=\"h-6 w-14 bg-muted rounded-full\" />\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            ) : (\r\n              <div className=\"flex items-center justify-center py-6\">\r\n                <span className=\"text-xs text-muted-foreground\">Scroll for more</span>\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {/* End of list indicator */}\r\n        {visibleCount >= filteredLeads.length && filteredLeads.length > 0 && (\r\n          <div className=\"text-center py-6\">\r\n            <div className=\"inline-flex items-center gap-2 px-4 py-2 rounded-full bg-muted/50\">\r\n              <span className=\"text-xs text-muted-foreground\">\r\n                Showing all {filteredLeads.length} leads\r\n              </span>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Empty state */}\r\n        {filteredLeads.length === 0 && (\r\n          <div className=\"flex flex-col items-center justify-center py-16 px-4\">\r\n            <div className=\"h-16 w-16 rounded-full bg-muted/50 flex items-center justify-center mb-4\">\r\n              <Users className=\"h-8 w-8 text-muted-foreground\" />\r\n            </div>\r\n            <h3 className=\"text-lg font-semibold text-foreground mb-1\">No leads found</h3>\r\n            <p className=\"text-sm text-muted-foreground text-center max-w-xs\">\r\n              {searchQuery || filterSource !== \"all\" || filterStage !== \"all\"\r\n                ? \"Try adjusting your filters or search query\"\r\n                : \"Add your first lead to get started\"}\r\n            </p>\r\n            <Button\r\n              className=\"mt-4\"\r\n              onClick={() => setIsAddLeadOpen(true)}\r\n            >\r\n              <Plus className=\"h-4 w-4 mr-2\" />\r\n              Add Lead\r\n            </Button>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  // Show skeleton while loading\r\n  if (isLoading) {\r\n    return <LeadsPageSkeleton isMobile={isMobile} />;\r\n  }\r\n\r\n  if (isMobile) {\r\n    return (\r\n      <>\r\n        <PullToRefresh onRefresh={handleRefresh} className=\"h-full -m-3 p-3\">\r\n          {content}\r\n        </PullToRefresh>\r\n\r\n        {typeof document !== \"undefined\" &&\r\n          createPortal(\r\n            <>\r\n              {/* FAB Menu Overlay - Fixed outside scroll container */}\r\n              {isFabOpen && (\r\n                <div\r\n                  className=\"fixed inset-0 bg-black/30 z-40 animate-fade-in\"\r\n                  onClick={() => setIsFabOpen(false)}\r\n                />\r\n              )}\r\n\r\n              {/* FAB Options - Fixed outside scroll container */}\r\n              <div\r\n                className={`fixed bottom-36 right-4 z-50 flex flex-col gap-2 transition-all duration-200 ${isFabOpen\r\n                  ? \"opacity-100 translate-y-0\"\r\n                  : \"opacity-0 translate-y-4 pointer-events-none\"\r\n                  }`}\r\n              >\r\n                <button\r\n                  onClick={() => handleFabOption(\"excel\")}\r\n                  className=\"flex items-center gap-3 bg-card text-card-foreground px-4 py-3 rounded-full shadow-lg border active:scale-95 transition-transform\"\r\n                >\r\n                  <FileSpreadsheet className=\"h-5 w-5 text-emerald-600\" />\r\n                  <span className=\"text-sm font-medium\">Import Excel</span>\r\n                </button>\r\n                <button\r\n                  onClick={() => handleFabOption(\"contact\")}\r\n                  className=\"flex items-center gap-3 bg-card text-card-foreground px-4 py-3 rounded-full shadow-lg border active:scale-95 transition-transform\"\r\n                >\r\n                  <Contact className=\"h-5 w-5 text-blue-600\" />\r\n                  <span className=\"text-sm font-medium\">From Contacts</span>\r\n                </button>\r\n                <button\r\n                  onClick={() => handleFabOption(\"manual\")}\r\n                  className=\"flex items-center gap-3 bg-card text-card-foreground px-4 py-3 rounded-full shadow-lg border active:scale-95 transition-transform\"\r\n                >\r\n                  <UserPlus className=\"h-5 w-5 text-primary\" />\r\n                  <span className=\"text-sm font-medium\">Manual Add</span>\r\n                </button>\r\n              </div>\r\n\r\n              {/* Floating Action Button - Fixed outside scroll container */}\r\n              <button\r\n                onClick={() => setIsFabOpen(!isFabOpen)}\r\n                className={`fixed bottom-20 right-4 z-50 h-14 w-14 rounded-full bg-primary text-primary-foreground shadow-lg flex items-center justify-center active:scale-95 transition-all duration-200 ${isFabOpen ? \"rotate-45\" : \"\"\r\n                  }`}\r\n              >\r\n                <Plus className=\"h-6 w-6\" />\r\n              </button>\r\n            </>,\r\n            document.body\r\n          )}\r\n\r\n        {/* Mobile Leads Filter Dialog */}\r\n        <LeadsFilterDialog\r\n          open={isFilterDialogOpen}\r\n          onOpenChange={setIsFilterDialogOpen}\r\n          filterStage={filterStage}\r\n          onFilterStageChange={setFilterStage}\r\n          filterGroup={filterGroup}\r\n          onFilterGroupChange={setFilterGroup}\r\n          filterSource={filterSource}\r\n          onFilterSourceChange={setFilterSource}\r\n          filterAgent={filterAgent}\r\n          onFilterAgentChange={setFilterAgent}\r\n          onReset={() => {\r\n            setFilterStage(\"all\");\r\n            setFilterGroup(\"all\");\r\n            setFilterSource(\"all\");\r\n            setFilterAgent(\"all\");\r\n          }}\r\n        />\r\n\r\n        {/* Add Lead Dialog for Manual Add */}\r\n        <AddLeadDialog open={isAddLeadOpen} onOpenChange={setIsAddLeadOpen} />\r\n\r\n        {/* Excel Import Dialog */}\r\n        <ExcelImportDialog\r\n          open={isExcelImportOpen}\r\n          onOpenChange={setIsExcelImportOpen}\r\n          onImport={handleExcelImport}\r\n        />\r\n\r\n        {/* Contacts Import Dialog */}\r\n        <ContactsImportDialog\r\n          open={isContactsImportOpen}\r\n          onOpenChange={setIsContactsImportOpen}\r\n          onImport={handleContactsImport}\r\n        />\r\n      </>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {content}\r\n\r\n      {/* FAB Menu & Button - Desktop/Tablet (fixed via portal) */}\r\n      {typeof document !== \"undefined\" &&\r\n        createPortal(\r\n          <>\r\n            {/* FAB Menu Overlay - Desktop */}\r\n            {isFabOpen && (\r\n              <div\r\n                className=\"fixed inset-0 bg-black/30 z-40 animate-fade-in\"\r\n                onClick={() => setIsFabOpen(false)}\r\n              />\r\n            )}\r\n\r\n            {/* FAB Options - Desktop/Tablet */}\r\n            <div\r\n              className={`fixed bottom-24 right-4 z-50 flex flex-col gap-2 transition-all duration-200 ${isFabOpen ? \"opacity-100 translate-y-0\" : \"opacity-0 translate-y-4 pointer-events-none\"\r\n                }`}\r\n            >\r\n              <button\r\n                onClick={() => handleFabOption(\"excel\")}\r\n                className=\"flex items-center gap-3 bg-card text-card-foreground px-4 py-3 rounded-full shadow-lg border hover:bg-accent active:scale-95 transition-all\"\r\n              >\r\n                <FileSpreadsheet className=\"h-5 w-5 text-emerald-600\" />\r\n                <span className=\"text-sm font-medium\">Import Excel</span>\r\n              </button>\r\n              <button\r\n                onClick={() => handleFabOption(\"contact\")}\r\n                className=\"flex items-center gap-3 bg-card text-card-foreground px-4 py-3 rounded-full shadow-lg border hover:bg-accent active:scale-95 transition-all\"\r\n              >\r\n                <Contact className=\"h-5 w-5 text-blue-600\" />\r\n                <span className=\"text-sm font-medium\">From Contacts</span>\r\n              </button>\r\n              <button\r\n                onClick={() => handleFabOption(\"manual\")}\r\n                className=\"flex items-center gap-3 bg-card text-card-foreground px-4 py-3 rounded-full shadow-lg border hover:bg-accent active:scale-95 transition-all\"\r\n              >\r\n                <UserPlus className=\"h-5 w-5 text-primary\" />\r\n                <span className=\"text-sm font-medium\">Manual Add</span>\r\n              </button>\r\n            </div>\r\n\r\n            {/* Floating Action Button - Desktop/Tablet */}\r\n            <button\r\n              onClick={() => setIsFabOpen(!isFabOpen)}\r\n              className={`fixed bottom-6 right-4 z-50 h-14 w-14 rounded-full bg-primary text-primary-foreground shadow-lg flex items-center justify-center hover:bg-primary/90 active:scale-95 transition-all duration-200 ${isFabOpen ? \"rotate-45\" : \"\"\r\n                }`}\r\n            >\r\n              <Plus className=\"h-6 w-6\" />\r\n            </button>\r\n          </>,\r\n          document.body\r\n        )}\r\n\r\n      {/* Excel Import Dialog for Desktop */}\r\n      <ExcelImportDialog\r\n        open={isExcelImportOpen}\r\n        onOpenChange={setIsExcelImportOpen}\r\n        onImport={handleExcelImport}\r\n      />\r\n      {/* Contacts Import Dialog for Desktop */}\r\n      <ContactsImportDialog\r\n        open={isContactsImportOpen}\r\n        onOpenChange={setIsContactsImportOpen}\r\n        onImport={handleContactsImport}\r\n      />\r\n      {/* Add Lead Dialog for Desktop */}\r\n      <AddLeadDialog open={isAddLeadOpen} onOpenChange={setIsAddLeadOpen} />\r\n      {/* Reassign Leads Dialog */}\r\n      <ReassignLeadsDialog\r\n        open={isReassignOpen}\r\n        onOpenChange={(open) => {\r\n          setIsReassignOpen(open);\r\n          if (!open) setSingleLeadAction(null);\r\n        }}\r\n        selectedLeadIds={singleLeadAction ? [singleLeadAction.leadId] : selectedLeads}\r\n        onReassign={handleReassign}\r\n      />\r\n      {/* Change Stage Dialog */}\r\n      <ChangeStageDialog\r\n        open={isChangeStageOpen}\r\n        onOpenChange={(open) => {\r\n          setIsChangeStageOpen(open);\r\n          if (!open) setSingleLeadAction(null);\r\n        }}\r\n        selectedLeadIds={singleLeadAction ? [singleLeadAction.leadId] : selectedLeads}\r\n        onStageChange={handleStageChange}\r\n      />\r\n      {/* Delete Leads Dialog - Admin Only */}\r\n      <DeleteLeadsDialog\r\n        open={isDeleteDialogOpen}\r\n        onOpenChange={setIsDeleteDialogOpen}\r\n        leadIds={leadsToDelete}\r\n        onSuccess={handleDeleteSuccess}\r\n      />\r\n      {/* Mobile Leads Filter Dialog */}\r\n      <LeadsFilterDialog\r\n        open={isFilterDialogOpen}\r\n        onOpenChange={setIsFilterDialogOpen}\r\n        filterStage={filterStage}\r\n        onFilterStageChange={setFilterStage}\r\n        filterGroup={filterGroup}\r\n        onFilterGroupChange={setFilterGroup}\r\n        filterSource={filterSource}\r\n        onFilterSourceChange={setFilterSource}\r\n        filterAgent={filterAgent}\r\n        onFilterAgentChange={setFilterAgent}\r\n        onReset={() => {\r\n          setFilterStage(\"all\");\r\n          setFilterGroup(\"all\");\r\n          setFilterSource(\"all\");\r\n          setFilterAgent(\"all\");\r\n        }}\r\n        availableAgents={availableAgents}\r\n        availableSources={availableSources}\r\n      />\r\n\r\n      <ExportLeadsDialog\r\n        open={isExportDialogOpen}\r\n        onOpenChange={setIsExportDialogOpen}\r\n        leads={leads}\r\n        availableAgents={availableAgents}\r\n      />\r\n    </>\r\n  );\r\n}\r\n\r\nexport default function LeadsPage() {\r\n  return (\r\n    <ErrorBoundary>\r\n      <LeadsPageContent />\r\n    </ErrorBoundary>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\ListingDetailPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\ListingPresentationPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\ListingsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":272,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":272,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10427,10430],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10427,10430],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":300,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":300,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11184,11187],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11184,11187],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":341,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":341,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12503,12506],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12503,12506],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":362,"column":11,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":365,"endColumn":41,"suggestions":[{"messageId":"addBrackets","fix":{"range":[13116,13403],"text":"{ const { error: archiveError } = await supabase\r\n            .from('listings')\r\n            .update({ status: 'archived' })\r\n            .in('id', selectedListings);\r\n          if (archiveError) throw archiveError;\r\n          toast.success(`${count} listings archived`);\r\n          break; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":370,"column":11,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":373,"endColumn":41,"suggestions":[{"messageId":"addBrackets","fix":{"range":[13442,13771],"text":"{ const { error: unpublishError } = await supabase\r\n            .from('listings')\r\n            .update({ status: 'draft' }) // Assuming draft means unpublished\r\n            .in('id', selectedListings);\r\n          if (unpublishError) throw unpublishError;\r\n          toast.success(`${count} listings unpublished`);\r\n          break; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":379,"column":11,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":382,"endColumn":41,"suggestions":[{"messageId":"addBrackets","fix":{"range":[13807,14155],"text":"{ if (!confirm(`Are you sure you want to delete ${count} listings?`)) return;\r\n          const { error: deleteError } = await supabase\r\n            .from('listings')\r\n            .delete()\r\n            .in('id', selectedListings);\r\n          if (deleteError) throw deleteError;\r\n          toast.success(`${count} listings deleted`);\r\n          break; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":395,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":395,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14455,14458],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14455,14458],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from \"react\";\r\nimport { createPortal } from \"react-dom\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport {\r\n  Plus,\r\n  Search,\r\n  Filter,\r\n  LayoutGrid,\r\n  List,\r\n  Upload,\r\n  Download,\r\n  Building2,\r\n  Home,\r\n  Eye,\r\n  TrendingUp,\r\n  Cloud,\r\n  Trash2,\r\n  Share2,\r\n  X,\r\n  SlidersHorizontal,\r\n  UserPlus,\r\n  RefreshCw,\r\n  MoreHorizontal,\r\n  Pencil,\r\n} from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Checkbox } from \"@/components/ui/checkbox\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\";\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n} from \"@/components/ui/alert-dialog\";\r\nimport { StatCard } from \"@/components/ui/stat-card\";\r\nimport { ListingCard, ListingCardMobile, ListingRowItem, type Listing } from \"@/components/listings/ListingCard\";\r\nimport { AddEditListingForm } from \"@/components/listings/AddEditListingForm\";\r\nimport { PublishToPortalsDialog } from \"@/components/listings/PublishToPortalsDialog\";\r\nimport { AssignAgentDialog } from \"@/components/listings/AssignAgentDialog\";\r\nimport { BulkEditListingsDialog } from \"@/components/listings/BulkEditListingsDialog\";\r\nimport { ListingsFiltersDialog } from \"@/components/listings/ListingsFiltersDialog\";\r\nimport { ListingsImportDialog } from \"@/components/listings/ListingsImportDialog\";\r\nimport { PullToRefresh } from \"@/components/ui/pull-to-refresh\";\r\nimport { ListingsPageSkeleton } from \"@/components/ui/page-skeletons\";\r\nimport { MobileSearchFilter } from \"@/components/ui/mobile-search-filter\";\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport { useLocalization } from \"@/contexts/LocalizationContext\";\r\nimport { useListings, type Listing as DBListing } from \"@/hooks/useListings\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { toast } from \"sonner\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { usePortals } from \"@/hooks/usePortalPublications\";\r\nimport { useOrganizationMembers } from \"@/hooks/useOrganizationMembers\";\r\n\r\n// Helper to format price for display\r\n\r\n\r\nconst FloatingAddListingFAB = ({\r\n  onClick,\r\n  bottomClass,\r\n}: {\r\n  onClick: () => void;\r\n  bottomClass: string;\r\n}) => {\r\n  if (typeof document === \"undefined\") return null;\r\n\r\n  return createPortal(\r\n    <button\r\n      onClick={onClick}\r\n      className={`fixed right-4 ${bottomClass} z-50 h-14 w-14 rounded-full bg-primary text-primary-foreground shadow-lg flex items-center justify-center hover:bg-primary/90 active:scale-95 transition-all`}\r\n    >\r\n      <Plus className=\"h-6 w-6\" />\r\n    </button>,\r\n    document.body\r\n  );\r\n};\r\n\r\nexport default function ListingsPage() {\r\n  const navigate = useNavigate();\r\n  const isMobile = useIsMobile();\r\n  const { t, formatCurrency, isRTL } = useLocalization();\r\n  const { listings: dbListings, isLoading, refetch } = useListings();\r\n  const { portals } = usePortals();\r\n  const { activeMembers: agents } = useOrganizationMembers();\r\n\r\n  // Map DB status to UI status\r\n  const mapStatus = (status: string | null): \"Active\" | \"Draft\" | \"Pending\" | \"Rented\" | \"Sold\" => {\r\n    const statusMap: Record<string, \"Active\" | \"Draft\" | \"Pending\" | \"Rented\" | \"Sold\"> = {\r\n      active: \"Active\",\r\n      published: \"Active\",\r\n      draft: \"Draft\",\r\n      pending: \"Pending\",\r\n      rented: \"Rented\",\r\n      sold: \"Sold\",\r\n      reserved: \"Pending\",\r\n      off_market: \"Draft\",\r\n      archived: \"Draft\",\r\n      expired: \"Draft\",\r\n    };\r\n    return statusMap[(status || \"draft\").toLowerCase()] || \"Draft\";\r\n  };\r\n\r\n  // Helper to format price for display\r\n  const formatListingPrice = (price: number | null, currency: string): string => {\r\n    if (!price) return \"Price on request\";\r\n    return `${currency} ${price.toLocaleString()}`;\r\n  };\r\n\r\n  // Transform DB listings to UI format\r\n  const listings: Listing[] = dbListings.map((item) => ({\r\n    id: item.id,\r\n    title: item.title,\r\n    price: formatListingPrice(item.price, item.currency),\r\n    location: item.location || item.city || \"Unknown\",\r\n    bedrooms: item.bedrooms || 0,\r\n    bathrooms: item.bathrooms || 0,\r\n    size: item.size ? `${item.size} ${item.size_unit || \"sqft\"}` : \"N/A\",\r\n    type: item.property_type ? item.property_type.charAt(0).toUpperCase() + item.property_type.slice(1) : \"Apartment\",\r\n    status: mapStatus(item.status),\r\n    agent: { name: item.agent?.name || \"Unassigned\", avatar: item.agent?.avatar || \"\" },\r\n    views: item.views || 0,\r\n    inquiries: item.inquiries || 0,\r\n    image: item.image || \"https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=400&h=300&fit=crop\",\r\n    refNumber: item.reference_number || item.ref_number || `REF-${item.id.slice(0, 6).toUpperCase()}`,\r\n    portals: item.portals || [],\r\n    latitude: item.latitude || undefined,\r\n    longitude: item.longitude || undefined,\r\n    plotSize: item.plot_size || undefined,\r\n    view: item.view_type || undefined,\r\n    ownershipType: item.ownership_type || undefined,\r\n    serviceCharges: item.service_charge || undefined,\r\n    developer: item.developer || undefined,\r\n    projectName: item.project_name || undefined,\r\n    buildingName: item.building_name || undefined,\r\n    floorNumber: item.floor_number || undefined,\r\n    parkingSpaces: item.parking_spaces || undefined,\r\n    virtualTourUrl: item.virtual_tour_url || undefined,\r\n    videoUrl: (item.videos && item.videos.length > 0) ? (typeof item.videos[0] === 'string' ? item.videos[0] : item.videos[0]?.url) : undefined,\r\n  }));\r\n\r\n  // Calculate real stats\r\n  const totalListings = listings.length;\r\n  const activeListings = listings.filter(l => l.status === \"Active\").length;\r\n  const totalViews = listings.reduce((sum, l) => sum + (l.views || 0), 0);\r\n  const totalInquiries = listings.reduce((sum, l) => sum + (l.inquiries || 0), 0);\r\n\r\n\r\n\r\n  const formatStatValue = (value: number): string => {\r\n    if (value >= 1000000) return `${(value / 1000000).toFixed(1)}M`;\r\n    if (value >= 1000) return `${(value / 1000).toFixed(1)}K`;\r\n    return value.toString();\r\n  };\r\n\r\n  const [viewMode, setViewMode] = useState<\"grid\" | \"list\">(\"grid\");\r\n  const [selectedListings, setSelectedListings] = useState<string[]>([]);\r\n  const [searchQuery, setSearchQuery] = useState(\"\");\r\n  const [statusFilter, setStatusFilter] = useState(\"all\");\r\n  const [typeFilter, setTypeFilter] = useState(\"all\");\r\n  const [isFilterOpen, setIsFilterOpen] = useState(false);\r\n  const [isAddFormOpen, setIsAddFormOpen] = useState(false);\r\n  const [isPublishDialogOpen, setIsPublishDialogOpen] = useState(false);\r\n  const [deleteTarget, setDeleteTarget] = useState<string | null>(null);\r\n  const [isDeleting, setIsDeleting] = useState(false);\r\n  const [isAssignAgentOpen, setIsAssignAgentOpen] = useState(false);\r\n  const [isBulkEditOpen, setIsBulkEditOpen] = useState(false);\r\n  const [isImportOpen, setIsImportOpen] = useState(false);\r\n  const [agentFilter, setAgentFilter] = useState(\"all\");\r\n  const [portalFilter, setPortalFilter] = useState(\"all\");\r\n  const [isSelectionMode, setIsSelectionMode] = useState(false);\r\n  const longPressTimerRef = useRef<NodeJS.Timeout | null>(null);\r\n\r\n  const handleRefresh = async () => {\r\n    await refetch();\r\n    toast.success(\"Listings refreshed\");\r\n  };\r\n\r\n  const filteredListings = listings.filter((listing) => {\r\n    const matchesSearch =\r\n      listing.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n      listing.location.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n      listing.refNumber?.toLowerCase().includes(searchQuery.toLowerCase());\r\n    const matchesStatus = statusFilter === \"all\" || listing.status.toLowerCase() === statusFilter;\r\n    const matchesType = typeFilter === \"all\" || listing.type.toLowerCase() === typeFilter;\r\n    const matchesAgent = agentFilter === \"all\" || listing.agent.name.includes(agentFilter.split(\" \")[0]);\r\n    const matchesPortal = portalFilter === \"all\" || listing.portals?.includes(portalFilter);\r\n    return matchesSearch && matchesStatus && matchesType && matchesAgent && matchesPortal;\r\n  });\r\n\r\n  const handleSelectAll = () => {\r\n    if (selectedListings.length === filteredListings.length) {\r\n      setSelectedListings([]);\r\n    } else {\r\n      setSelectedListings(filteredListings.map((l) => l.id));\r\n    }\r\n  };\r\n\r\n  const handleSelectListing = (id: string) => {\r\n    setSelectedListings((prev) => {\r\n      const newSelection = prev.includes(id) ? prev.filter((i) => i !== id) : [...prev, id];\r\n      // Automatically toggle selection mode\r\n      if (newSelection.length > 0) {\r\n        setIsSelectionMode(true);\r\n      } else {\r\n        setIsSelectionMode(false);\r\n      }\r\n      return newSelection;\r\n    });\r\n  };\r\n\r\n  // Long press handlers for mobile selection\r\n  const handleLongPressStart = (id: string) => {\r\n    longPressTimerRef.current = setTimeout(() => {\r\n      if (navigator.vibrate) navigator.vibrate(50);\r\n      setIsSelectionMode(true);\r\n      setSelectedListings((prev) => prev.includes(id) ? prev : [...prev, id]);\r\n    }, 500);\r\n  };\r\n\r\n  const handleLongPressEnd = () => {\r\n    if (longPressTimerRef.current) {\r\n      clearTimeout(longPressTimerRef.current);\r\n      longPressTimerRef.current = null;\r\n    }\r\n  };\r\n\r\n  const handleListingCardClick = (id: string) => {\r\n    if (isSelectionMode) {\r\n      handleSelectListing(id);\r\n    } else {\r\n      navigate(`/listings/${id}`);\r\n    }\r\n  };\r\n\r\n  const handlePublishToPortals = (portalIds: string[]) => {\r\n    toast.success(`Published to ${portalIds.length} portals`);\r\n    setSelectedListings([]);\r\n  };\r\n\r\n  const handleAssignAgent = async (agentId: string, agentName: string) => {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('listings')\r\n        .update({ assigned_agent_id: agentId })\r\n        .in('id', selectedListings);\r\n\r\n      if (error) throw error;\r\n\r\n      toast.success(`${selectedListings.length} listing(s) assigned to ${agentName}`);\r\n      setSelectedListings([]);\r\n      refetch();\r\n    } catch (err: any) {\r\n      console.error(\"Error assigning agent:\", err);\r\n      toast.error(\"Failed to assign agent: \" + err.message);\r\n    }\r\n  };\r\n\r\n  const handleUpdateListing = (id: string, data: Partial<Listing>) => {\r\n    // Real updates come via real-time subscription\r\n    toast.success(\"Updating listing...\");\r\n  };\r\n\r\n  const handleDeleteListing = async (id: string) => {\r\n    setDeleteTarget(id);\r\n  };\r\n\r\n  const confirmDelete = async () => {\r\n    if (!deleteTarget) return;\r\n\r\n    setIsDeleting(true);\r\n    try {\r\n      const { error } = await supabase\r\n        .from('listings')\r\n        .delete()\r\n        .eq('id', deleteTarget);\r\n\r\n      if (error) throw error;\r\n      toast.success(\"Listing deleted successfully\");\r\n      refetch();\r\n    } catch (err: any) {\r\n      console.error(\"Error deleting listing:\", err);\r\n      toast.error(\"Failed to delete listing: \" + err.message);\r\n    } finally {\r\n      setIsDeleting(false);\r\n      setDeleteTarget(null);\r\n    }\r\n  };\r\n\r\n  const handleDuplicateListing = async (id: string) => {\r\n    try {\r\n      toast.loading(\"Duplicating listing...\", { id: \"duplicate-listing\" });\r\n\r\n      // Fetch the original listing\r\n      const { data: original, error: fetchError } = await supabase\r\n        .from('listings')\r\n        .select('*')\r\n        .eq('id', id)\r\n        .single();\r\n\r\n      if (fetchError) throw fetchError;\r\n\r\n      // Create a copy without the ID and with a new title\r\n      const { id: _, created_at: __, updated_at: ___, ...copyData } = original;\r\n      const duplicatedData = {\r\n        ...copyData,\r\n        title: `${copyData.title} (Copy)`,\r\n        reference_number: null, // Let the system generate a new one\r\n        status: 'draft', // Always duplicate as draft\r\n      };\r\n\r\n      const { data: newData, error: insertError } = await supabase\r\n        .from('listings')\r\n        .insert(duplicatedData)\r\n        .select()\r\n        .single();\r\n\r\n      if (insertError) throw insertError;\r\n\r\n      toast.success(\"Listing duplicated successfully\", { id: \"duplicate-listing\" });\r\n      refetch();\r\n    } catch (err: any) {\r\n      console.error(\"Error duplicating listing:\", err);\r\n      toast.error(\"Failed to duplicate: \" + err.message, { id: \"duplicate-listing\" });\r\n    }\r\n  };\r\n  const handleBulkAction = async (action: string) => {\r\n    const count = selectedListings.length;\r\n    if (count === 0) return;\r\n\r\n    try {\r\n      switch (action) {\r\n        case \"publish\":\r\n          setIsPublishDialogOpen(true);\r\n          return;\r\n        case \"assign\":\r\n          setIsAssignAgentOpen(true);\r\n          return;\r\n        case \"edit\":\r\n          setIsBulkEditOpen(true);\r\n          return;\r\n        case \"archive\":\r\n          const { error: archiveError } = await supabase\r\n            .from('listings')\r\n            .update({ status: 'archived' })\r\n            .in('id', selectedListings);\r\n          if (archiveError) throw archiveError;\r\n          toast.success(`${count} listings archived`);\r\n          break;\r\n        case \"unpublish\":\r\n          const { error: unpublishError } = await supabase\r\n            .from('listings')\r\n            .update({ status: 'draft' }) // Assuming draft means unpublished\r\n            .in('id', selectedListings);\r\n          if (unpublishError) throw unpublishError;\r\n          toast.success(`${count} listings unpublished`);\r\n          break;\r\n        case \"delete\":\r\n          if (!confirm(`Are you sure you want to delete ${count} listings?`)) return;\r\n          const { error: deleteError } = await supabase\r\n            .from('listings')\r\n            .delete()\r\n            .in('id', selectedListings);\r\n          if (deleteError) throw deleteError;\r\n          toast.success(`${count} listings deleted`);\r\n          break;\r\n        case \"share\":\r\n          toast.success(`Preparing to share ${count} listings...`);\r\n          break;\r\n        case \"sync\":\r\n          toast.success(`Syncing ${count} listings with portals...`);\r\n          break;\r\n      }\r\n      setSelectedListings([]);\r\n      refetch();\r\n    } catch (err: any) {\r\n      console.error(`Error performing bulk ${action}:`, err);\r\n      toast.error(`Bulk ${action} failed: ${err.message}`);\r\n    }\r\n  };\r\n\r\n  const handleExportListings = () => {\r\n    if (filteredListings.length === 0) {\r\n      toast.error(\"No listings to export\");\r\n      return;\r\n    }\r\n\r\n    // Define columns to export\r\n    const columns = [\r\n      { key: 'title', label: 'Title' },\r\n      { key: 'price', label: 'Price' },\r\n      { key: 'location', label: 'Location' },\r\n      { key: 'bedrooms', label: 'Bedrooms' },\r\n      { key: 'bathrooms', label: 'Bathrooms' },\r\n      { key: 'size', label: 'Size' },\r\n      { key: 'type', label: 'Type' },\r\n      { key: 'status', label: 'Status' },\r\n      { key: 'refNumber', label: 'Ref Number' },\r\n    ];\r\n\r\n    // Create CSV content\r\n    const headerRow = columns.map(col => `\"${col.label}\"`).join(',');\r\n    const dataRows = filteredListings.map(listing => {\r\n      return columns.map(col => {\r\n        const val = listing[col.key as keyof Listing];\r\n        const stringVal = val !== undefined && val !== null ? String(val) : '';\r\n        return `\"${stringVal.replace(/\"/g, '\"\"')}\"`;\r\n      }).join(',');\r\n    });\r\n\r\n    const csvContent = [headerRow, ...dataRows].join('\\n');\r\n\r\n    // Trigger download\r\n    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\r\n    const link = document.createElement('a');\r\n    const url = URL.createObjectURL(blob);\r\n    link.setAttribute('href', url);\r\n    link.setAttribute('download', `listings_export_${new Date().toISOString().split('T')[0]}.csv`);\r\n    link.style.visibility = 'hidden';\r\n    document.body.appendChild(link);\r\n    link.click();\r\n    document.body.removeChild(link);\r\n\r\n    toast.success(\"Listings exported successfully\");\r\n  };\r\n\r\n  const handleBulkEditSave = (changes: { currency?: string; sizeUnit?: string }) => {\r\n    // In a real implementation, this would update the database\r\n    toast.success(`Updated ${selectedListings.length} listings`);\r\n    setSelectedListings([]);\r\n  };\r\n\r\n  const [dialogFilters, setDialogFilters] = useState({\r\n    status: statusFilter,\r\n    type: typeFilter,\r\n    bedrooms: \"any\",\r\n    priceRange: \"any\",\r\n    portal: portalFilter,\r\n    agent: agentFilter,\r\n  });\r\n\r\n  const handleApplyFilters = () => {\r\n    setStatusFilter(dialogFilters.status);\r\n    setTypeFilter(dialogFilters.type);\r\n    setPortalFilter(dialogFilters.portal);\r\n    setAgentFilter(dialogFilters.agent);\r\n    toast.success(\"Filters applied\");\r\n  };\r\n\r\n  const handleResetFilters = () => {\r\n    const resetFilters = {\r\n      status: \"all\",\r\n      type: \"all\",\r\n      bedrooms: \"any\",\r\n      priceRange: \"any\",\r\n      portal: \"all\",\r\n      agent: \"all\",\r\n    };\r\n    setDialogFilters(resetFilters);\r\n    setStatusFilter(\"all\");\r\n    setTypeFilter(\"all\");\r\n    setPortalFilter(\"all\");\r\n    setAgentFilter(\"all\");\r\n    toast.success(\"Filters reset\");\r\n  };\r\n\r\n  const content = (\r\n    <div className=\"space-y-4 sm:space-y-6\">\r\n      {/* Mobile Search & Filter Bar */}\r\n      {isMobile && (\r\n        <MobileSearchFilter\r\n          searchQuery={searchQuery}\r\n          onSearchChange={setSearchQuery}\r\n          placeholder={t('search_listings')}\r\n          onFilterClick={() => {\r\n            // Sync dialog filters with current filter state before opening\r\n            setDialogFilters({\r\n              status: statusFilter,\r\n              type: typeFilter,\r\n              bedrooms: \"any\",\r\n              priceRange: \"any\",\r\n              portal: portalFilter,\r\n              agent: agentFilter,\r\n            });\r\n            setIsFilterOpen(true);\r\n          }}\r\n        />\r\n      )}\r\n      {/* Page Header - Hidden on mobile */}\r\n      {!isMobile && (\r\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\r\n          <div>\r\n            <h1 className=\"text-xl sm:text-2xl font-bold text-foreground\">{t('my_listings')}</h1>\r\n            <p className=\"text-muted-foreground text-xs sm:text-sm\">{t('manage_property_listings')}</p>\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <DropdownMenu>\r\n              <DropdownMenuTrigger asChild>\r\n                <Button variant=\"outline\" size=\"sm\" className=\"h-8 px-2 sm:px-3\">\r\n                  <Upload className=\"h-4 w-4 sm:mr-2\" />\r\n                  <span className=\"hidden sm:inline\">{t('import')}</span>\r\n                </Button>\r\n              </DropdownMenuTrigger>\r\n              <DropdownMenuContent>\r\n                <DropdownMenuItem onClick={() => setIsImportOpen(true)}>\r\n                  <Upload className=\"h-4 w-4 mr-2\" />\r\n                  {t('import')} CSV / Excel\r\n                </DropdownMenuItem>\r\n                <DropdownMenuItem onClick={handleExportListings}>\r\n                  <Download className=\"h-4 w-4 mr-2\" />\r\n                  {t('export')} CSV\r\n                </DropdownMenuItem>\r\n              </DropdownMenuContent>\r\n            </DropdownMenu>\r\n            <Button onClick={() => setIsAddFormOpen(true)} size=\"sm\" className=\"h-8\">\r\n              <Plus className=\"h-4 w-4 sm:mr-2\" />\r\n              <span className=\"hidden sm:inline\">{t('add_listing')}</span>\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Add Listing Form */}\r\n      <AddEditListingForm\r\n        open={isAddFormOpen}\r\n        onOpenChange={setIsAddFormOpen}\r\n        mode=\"add\"\r\n      />\r\n\r\n      {/* Stats - Only 2 cards on mobile/tablet */}\r\n      <div className=\"lg:hidden grid grid-cols-2 gap-2\">\r\n        <StatCard\r\n          title={t('total_listings')}\r\n          value={totalListings.toString()}\r\n          icon={Building2}\r\n          iconColor=\"bg-primary/10 text-primary\"\r\n          compact\r\n        />\r\n        <StatCard\r\n          title={t('active')}\r\n          value={activeListings.toString()}\r\n          icon={Home}\r\n          iconColor=\"bg-success/10 text-success\"\r\n          compact\r\n        />\r\n      </div>\r\n\r\n      {/* Stats - Full grid on desktop */}\r\n      <div className=\"hidden lg:grid lg:grid-cols-4 gap-4\">\r\n        <StatCard\r\n          title={t('total_listings')}\r\n          value={totalListings.toString()}\r\n          icon={Building2}\r\n          iconColor=\"bg-primary/10 text-primary\"\r\n        />\r\n        <StatCard\r\n          title={t('active')}\r\n          value={activeListings.toString()}\r\n          icon={Home}\r\n          iconColor=\"bg-success/10 text-success\"\r\n        />\r\n        <StatCard\r\n          title={t('total_views')}\r\n          value={formatStatValue(totalViews)}\r\n          icon={Eye}\r\n          iconColor=\"bg-info/10 text-info\"\r\n        />\r\n        <StatCard\r\n          title={t('inquiries')}\r\n          value={formatStatValue(totalInquiries)}\r\n          icon={TrendingUp}\r\n          iconColor=\"bg-warning/10 text-warning\"\r\n        />\r\n      </div>\r\n\r\n      {/* Filters Bar - Desktop Only */}\r\n      <Card className=\"hidden lg:block p-3 sm:p-4 shadow-card\">\r\n        <div className=\"flex flex-col gap-3 sm:gap-4 lg:flex-row\">\r\n          <div className=\"relative flex-1\">\r\n            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n            <Input\r\n              placeholder={t('search_listings')}\r\n              className=\"pl-9 h-9\"\r\n              value={searchQuery}\r\n              onChange={(e) => setSearchQuery(e.target.value)}\r\n            />\r\n          </div>\r\n          <div className=\"flex items-center gap-2 overflow-x-auto no-scrollbar\">\r\n            {/* Quick Filters - visible on mobile too */}\r\n            <Select value={statusFilter} onValueChange={setStatusFilter}>\r\n              <SelectTrigger className=\"w-[100px] sm:w-[130px] h-9 flex-shrink-0\">\r\n                <SelectValue placeholder={t('status')} />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"all\">{t('all_status')}</SelectItem>\r\n                <SelectItem value=\"active\">{t('active')}</SelectItem>\r\n                <SelectItem value=\"draft\">{t('draft')}</SelectItem>\r\n                <SelectItem value=\"pending\">{t('pending')}</SelectItem>\r\n                <SelectItem value=\"rented\">{t('rented')}</SelectItem>\r\n                <SelectItem value=\"sold\">{t('sold')}</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n            <Select value={typeFilter} onValueChange={setTypeFilter}>\r\n              <SelectTrigger className=\"w-[100px] sm:w-[130px] h-9 flex-shrink-0\">\r\n                <SelectValue placeholder={t('property_type')} />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"all\">{t('all_types')}</SelectItem>\r\n                <SelectItem value=\"apartment\">{t('apartment')}</SelectItem>\r\n                <SelectItem value=\"villa\">{t('villa')}</SelectItem>\r\n                <SelectItem value=\"townhouse\">{t('townhouse')}</SelectItem>\r\n                <SelectItem value=\"penthouse\">{t('penthouse')}</SelectItem>\r\n                <SelectItem value=\"studio\">{t('studio')}</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n\r\n            {/* More Filters */}\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"icon\"\r\n              className=\"h-9 w-9 flex-shrink-0\"\r\n              onClick={() => {\r\n                setDialogFilters({\r\n                  status: statusFilter,\r\n                  type: typeFilter,\r\n                  bedrooms: \"any\",\r\n                  priceRange: \"any\",\r\n                  portal: portalFilter,\r\n                  agent: agentFilter,\r\n                });\r\n                setIsFilterOpen(true);\r\n              }}\r\n            >\r\n              <SlidersHorizontal className=\"h-4 w-4\" />\r\n            </Button>\r\n\r\n            {/* View Toggle - hidden on mobile */}\r\n            <div className=\"hidden sm:flex items-center border rounded-lg p-0.5 flex-shrink-0\">\r\n              <Button\r\n                variant={viewMode === \"grid\" ? \"secondary\" : \"ghost\"}\r\n                size=\"sm\"\r\n                className=\"h-7 w-7 p-0\"\r\n                onClick={() => setViewMode(\"grid\")}\r\n              >\r\n                <LayoutGrid className=\"h-4 w-4\" />\r\n              </Button>\r\n              <Button\r\n                variant={viewMode === \"list\" ? \"secondary\" : \"ghost\"}\r\n                size=\"sm\"\r\n                className=\"h-7 w-7 p-0\"\r\n                onClick={() => setViewMode(\"list\")}\r\n              >\r\n                <List className=\"h-4 w-4\" />\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Bulk Actions Bar - Mobile optimized */}\r\n        {selectedListings.length > 0 && (\r\n          <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-2 mt-3 pt-3 border-t bg-primary/5 -mx-3 sm:-mx-4 px-3 sm:px-4 -mb-3 sm:-mb-4 pb-3 sm:pb-4 rounded-b-lg\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <Checkbox\r\n                checked={selectedListings.length === filteredListings.length}\r\n                onCheckedChange={handleSelectAll}\r\n              />\r\n              <span className=\"text-xs sm:text-sm font-medium\">\r\n                {selectedListings.length} selected\r\n              </span>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                className=\"h-7 w-7 p-0\"\r\n                onClick={() => setSelectedListings([])}\r\n              >\r\n                <X className=\"h-4 w-4\" />\r\n              </Button>\r\n            </div>\r\n            <div className=\"flex items-center gap-1 sm:gap-2 overflow-x-auto no-scrollbar\">\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                className=\"h-7 px-2 text-xs flex-shrink-0\"\r\n                onClick={() => handleBulkAction(\"publish\")}\r\n              >\r\n                <Cloud className=\"h-3.5 w-3.5 sm:mr-1\" />\r\n                <span className=\"hidden sm:inline\">Publish</span>\r\n              </Button>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                className=\"h-7 px-2 text-xs flex-shrink-0\"\r\n                onClick={() => handleBulkAction(\"assign\")}\r\n              >\r\n                <UserPlus className=\"h-3.5 w-3.5 sm:mr-1\" />\r\n                <span className=\"hidden sm:inline\">Assign</span>\r\n              </Button>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                className=\"h-7 px-2 text-xs flex-shrink-0\"\r\n                onClick={() => handleBulkAction(\"edit\")}\r\n              >\r\n                <Pencil className=\"h-3.5 w-3.5 sm:mr-1\" />\r\n                <span className=\"hidden sm:inline\">{t('edit')}</span>\r\n              </Button>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                className=\"h-7 px-2 text-xs flex-shrink-0\"\r\n                onClick={() => handleBulkAction(\"sync\")}\r\n              >\r\n                <RefreshCw className=\"h-3.5 w-3.5 sm:mr-1\" />\r\n                <span className=\"hidden sm:inline\">Sync</span>\r\n              </Button>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                className=\"h-7 px-2 text-xs flex-shrink-0\"\r\n                onClick={() => handleBulkAction(\"share\")}\r\n              >\r\n                <Share2 className=\"h-3.5 w-3.5 sm:mr-1\" />\r\n                <span className=\"hidden sm:inline\">Share</span>\r\n              </Button>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                className=\"h-7 px-2 text-xs text-destructive hover:text-destructive flex-shrink-0\"\r\n                onClick={() => handleBulkAction(\"delete\")}\r\n              >\r\n                <Trash2 className=\"h-3.5 w-3.5 sm:mr-1\" />\r\n                <span className=\"hidden sm:inline\">{t('delete')}</span>\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </Card>\r\n\r\n      {/* Select All - hidden on mobile */}\r\n      <div className=\"hidden sm:flex items-center gap-2\">\r\n        <Checkbox\r\n          checked={selectedListings.length === filteredListings.length && filteredListings.length > 0}\r\n          onCheckedChange={handleSelectAll}\r\n        />\r\n        <span className=\"text-xs sm:text-sm text-muted-foreground\">Select all</span>\r\n        <Badge variant=\"secondary\" className=\"ml-2 text-xs\">\r\n          {filteredListings.length} listings\r\n        </Badge>\r\n      </div>\r\n\r\n      {/* Selection mode indicator for mobile */}\r\n      {isMobile && isSelectionMode && (\r\n        <div className=\"flex items-center justify-between bg-primary/10 p-2 rounded-lg mb-3\">\r\n          <span className=\"text-xs font-medium text-primary\">\r\n            {selectedListings.length} selected\r\n          </span>\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            className=\"h-6 text-xs\"\r\n            onClick={() => {\r\n              setIsSelectionMode(false);\r\n              setSelectedListings([]);\r\n            }}\r\n          >\r\n            <X className=\"h-3 w-3 mr-1\" />{t('cancel')}</Button>\r\n        </div>\r\n      )}\r\n\r\n      {/* Listings Grid */}\r\n      {isMobile ? (\r\n        <div className=\"space-y-3 pb-24\">\r\n          {filteredListings.map((listing) => (\r\n            <ListingCardMobile\r\n              key={listing.id}\r\n              listing={listing}\r\n              selectable\r\n              selected={selectedListings.includes(listing.id)}\r\n              onSelect={handleSelectListing}\r\n              showAgent={false}\r\n              onUpdateListing={handleUpdateListing}\r\n              isSelectionMode={isSelectionMode}\r\n              onLongPressStart={handleLongPressStart}\r\n              onLongPressEnd={handleLongPressEnd}\r\n              onCardClick={handleListingCardClick}\r\n              onDuplicate={handleDuplicateListing}\r\n              onDelete={handleDeleteListing}\r\n            />\r\n          ))}\r\n        </div>\r\n      ) : viewMode === \"list\" ? (\r\n        <div className=\"space-y-2\">\r\n          {filteredListings.map((listing) => (\r\n            <ListingRowItem\r\n              key={listing.id}\r\n              listing={listing}\r\n              selectable\r\n              selected={selectedListings.includes(listing.id)}\r\n              onSelect={handleSelectListing}\r\n              showAgent\r\n              onUpdateListing={handleUpdateListing}\r\n              isSelectionMode={isSelectionMode}\r\n              onLongPressStart={handleLongPressStart}\r\n              onLongPressEnd={handleLongPressEnd}\r\n              onCardClick={handleListingCardClick}\r\n              onDuplicate={handleDuplicateListing}\r\n              onDelete={handleDeleteListing}\r\n            />\r\n          ))}\r\n        </div>\r\n      ) : (\r\n        <div className=\"grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4\">\r\n          {filteredListings.map((listing) => (\r\n            <ListingCard\r\n              key={listing.id}\r\n              listing={listing}\r\n              selectable\r\n              selected={selectedListings.includes(listing.id)}\r\n              onSelect={handleSelectListing}\r\n              showAgent={false}\r\n              onUpdateListing={handleUpdateListing}\r\n              isSelectionMode={isSelectionMode}\r\n              onLongPressStart={handleLongPressStart}\r\n              onLongPressEnd={handleLongPressEnd}\r\n              onCardClick={handleListingCardClick}\r\n              onDuplicate={handleDuplicateListing}\r\n              onDelete={handleDeleteListing}\r\n            />\r\n          ))}\r\n        </div>\r\n      )}\r\n\r\n      {filteredListings.length === 0 && (\r\n        <div className=\"text-center py-12\">\r\n          <Building2 className=\"h-12 w-12 mx-auto text-muted-foreground/50 mb-4\" />\r\n          <h3 className=\"text-lg font-medium text-foreground mb-2\">No listings found</h3>\r\n          <p className=\"text-muted-foreground mb-4\">\r\n            Try adjusting your filters or add a new listing\r\n          </p>\r\n          <Button onClick={() => setIsAddFormOpen(true)}>\r\n            <Plus className=\"h-4 w-4 mr-2\" />\r\n            Add Listing\r\n          </Button>\r\n        </div>\r\n      )}\r\n\r\n\r\n      {/* Publish to Portals Dialog */}\r\n      <PublishToPortalsDialog\r\n        open={isPublishDialogOpen}\r\n        onOpenChange={setIsPublishDialogOpen}\r\n        listingIds={selectedListings}\r\n        onPublish={handlePublishToPortals}\r\n      />\r\n\r\n      {/* Assign Agent Dialog */}\r\n      <AssignAgentDialog\r\n        open={isAssignAgentOpen}\r\n        onOpenChange={setIsAssignAgentOpen}\r\n        listingIds={selectedListings}\r\n        onAssign={handleAssignAgent}\r\n      />\r\n\r\n      {/* Bulk Edit Dialog */}\r\n      <BulkEditListingsDialog\r\n        open={isBulkEditOpen}\r\n        onOpenChange={setIsBulkEditOpen}\r\n        listingIds={selectedListings}\r\n        onSave={handleBulkEditSave}\r\n      />\r\n\r\n      {/* Import Dialog */}\r\n      <ListingsImportDialog\r\n        open={isImportOpen}\r\n        onOpenChange={setIsImportOpen}\r\n        onImportComplete={refetch}\r\n      />\r\n    </div>\r\n  );\r\n\r\n  // Wrap with PullToRefresh on mobile\r\n  // Show skeleton while loading\r\n  if (isLoading) {\r\n    return <ListingsPageSkeleton isMobile={isMobile} />;\r\n  }\r\n\r\n  if (isMobile) {\r\n    return (\r\n      <>\r\n        <PullToRefresh onRefresh={handleRefresh} className=\"h-full -m-3 p-3\">\r\n          {content}\r\n        </PullToRefresh>\r\n\r\n        {/* Floating Action Button - Fixed outside scroll container */}\r\n        <FloatingAddListingFAB\r\n          onClick={() => setIsAddFormOpen(true)}\r\n          bottomClass=\"bottom-20\"\r\n        />\r\n      </>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {content}\r\n\r\n      {/* Floating Action Button - Desktop */}\r\n      <FloatingAddListingFAB\r\n        onClick={() => setIsAddFormOpen(true)}\r\n        bottomClass=\"bottom-6\"\r\n      />\r\n\r\n      {/* Filters Dialog */}\r\n      <ListingsFiltersDialog\r\n        open={isFilterOpen}\r\n        onOpenChange={setIsFilterOpen}\r\n        filters={dialogFilters}\r\n        onFiltersChange={setDialogFilters}\r\n        onApply={handleApplyFilters}\r\n        onReset={handleResetFilters}\r\n        agents={agents.map(m => ({ id: m.id, name: `${m.profile?.first_name || ''} ${m.profile?.last_name || ''}`.trim() || 'Agent' }))}\r\n        portals={portals.map(p => ({ id: p.id, name: p.name }))}\r\n      />\r\n\r\n      {/* Delete Confirmation Dialog */}\r\n      <AlertDialog open={deleteTarget !== null} onOpenChange={(open) => !open && setDeleteTarget(null)}>\r\n        <AlertDialogContent>\r\n          <AlertDialogHeader>\r\n            <AlertDialogTitle>Are you absolutely sure?</AlertDialogTitle>\r\n            <AlertDialogDescription>\r\n              This action cannot be undone. This will permanently delete the property listing\r\n              from the system and all connected portals.\r\n            </AlertDialogDescription>\r\n          </AlertDialogHeader>\r\n          <AlertDialogFooter>\r\n            <AlertDialogCancel disabled={isDeleting}>Cancel</AlertDialogCancel>\r\n            <AlertDialogAction\r\n              onClick={(e) => {\r\n                e.preventDefault();\r\n                confirmDelete();\r\n              }}\r\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\r\n              disabled={isDeleting}\r\n            >\r\n              {isDeleting ? \"Deleting...\" : \"Delete Listing\"}\r\n            </AlertDialogAction>\r\n          </AlertDialogFooter>\r\n        </AlertDialogContent>\r\n      </AlertDialog>\r\n    </>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\MarketingPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\MenuPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\NotFound.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\PipelinePage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\PortalSettingsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":113,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3634,3637],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3634,3637],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":163,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":163,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5459,5462],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5459,5462],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { Cloud, User, Star, RefreshCw, Save, Key, Eye, EyeOff } from \"lucide-react\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Switch } from \"@/components/ui/switch\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { toast } from \"sonner\";\r\nimport { PortalSettingsPageSkeleton } from \"@/components/ui/page-skeletons\";\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport { EmptyState } from \"@/components/ui/empty-state\";\r\nimport { Link2 } from \"lucide-react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useCompany } from \"@/hooks/useCompany\";\r\n\r\ninterface PortalAgent {\r\n  id: string;\r\n  name: string;\r\n  avatar?: string;\r\n}\r\n\r\ninterface Portal {\r\n  id: string;\r\n  name: string;\r\n  logo: string;\r\n  connected: boolean;\r\n  portalAccountId?: string;\r\n  credentials?: {\r\n    api_key?: string;\r\n    api_secret?: string;\r\n  };\r\n  agents: PortalAgent[];\r\n}\r\n\r\ninterface PortalConfig {\r\n  autoSync: boolean;\r\n  defaultAgentId: string;\r\n}\r\n\r\nconst CONFIG_STORAGE_KEY = \"portal_configurations\";\r\n\r\nconst getPortalConfigs = (): Record<string, PortalConfig> => {\r\n  try {\r\n    const stored = localStorage.getItem(CONFIG_STORAGE_KEY);\r\n    return stored ? JSON.parse(stored) : {};\r\n  } catch {\r\n    return {};\r\n  }\r\n};\r\n\r\nconst defaultConfig: PortalConfig = {\r\n  autoSync: true,\r\n  defaultAgentId: \"\",\r\n};\r\n\r\nconst getPortalLogo = (name: string): string => {\r\n  const lower = name.toLowerCase();\r\n  if (lower.includes(\"property finder\")) return \"ðŸ \";\r\n  if (lower.includes(\"bayut\")) return \"ðŸ¢\";\r\n  if (lower.includes(\"dubizzle\")) return \"ðŸ“‹\";\r\n  return \"ðŸŒ\";\r\n};\r\n\r\nexport default function PortalSettingsPage() {\r\n  const isMobile = useIsMobile();\r\n  const { company } = useCompany();\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [portals, setPortals] = useState<Portal[]>([]);\r\n  const [configs, setConfigs] = useState<Record<string, PortalConfig>>({});\r\n  const [hasChanges, setHasChanges] = useState(false);\r\n  const [saving, setSaving] = useState(false);\r\n  const [syncing, setSyncing] = useState<string | null>(null);\r\n  const [showSecrets, setShowSecrets] = useState<Record<string, boolean>>({});\r\n  const [apiCredentials, setApiCredentials] = useState<Record<string, { api_key: string; api_secret: string }>>({});\r\n  const [savingCredentials, setSavingCredentials] = useState<string | null>(null);\r\n\r\n  // Fetch connected portals from database\r\n  useEffect(() => {\r\n    const fetchPortals = async () => {\r\n      if (!company?.id) return;\r\n\r\n      try {\r\n        // Get all portal accounts for this company\r\n        const { data: portalAccounts, error: accountsError } = await supabase\r\n          .from(\"portal_accounts\")\r\n          .select(`\r\n            id,\r\n            portal_id,\r\n            status,\r\n            credentials,\r\n            portals (\r\n              id,\r\n              name\r\n            )\r\n          `)\r\n          .eq(\"company_id\", company.id)\r\n          .eq(\"status\", \"connected\");\r\n\r\n        if (accountsError) {\r\n          console.error(\"Error fetching portal accounts:\", accountsError);\r\n          return;\r\n        }\r\n\r\n        const mappedPortals: Portal[] = (portalAccounts || []).map((account: any) => ({\r\n          id: account.portal_id,\r\n          name: account.portals?.name || \"Unknown Portal\",\r\n          logo: getPortalLogo(account.portals?.name || \"\"),\r\n          connected: true,\r\n          portalAccountId: account.id,\r\n          credentials: account.credentials || {},\r\n          agents: [], // Will be fetched separately if needed\r\n        }));\r\n\r\n        setPortals(mappedPortals);\r\n\r\n        // Initialize API credentials state\r\n        const initialCredentials: Record<string, { api_key: string; api_secret: string }> = {};\r\n        mappedPortals.forEach((portal) => {\r\n          initialCredentials[portal.id] = {\r\n            api_key: portal.credentials?.api_key || \"\",\r\n            api_secret: portal.credentials?.api_secret || \"\",\r\n          };\r\n        });\r\n        setApiCredentials(initialCredentials);\r\n\r\n        // Merge saved configs\r\n        const savedConfigs = getPortalConfigs();\r\n        const mergedConfigs: Record<string, PortalConfig> = {};\r\n        mappedPortals.forEach((portal) => {\r\n          mergedConfigs[portal.id] = {\r\n            ...defaultConfig,\r\n            ...savedConfigs[portal.id],\r\n          };\r\n        });\r\n        setConfigs(mergedConfigs);\r\n      } catch (error) {\r\n        console.error(\"Error fetching portals:\", error);\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    };\r\n\r\n    fetchPortals();\r\n  }, [company?.id]);\r\n\r\n  const handleSyncNow = async (portalId: string, portalName: string) => {\r\n    setSyncing(portalId);\r\n    toast.loading(`Syncing ${portalName}...`, { id: `sync-${portalId}` });\r\n    await new Promise(resolve => setTimeout(resolve, 1500));\r\n    setSyncing(null);\r\n    toast.success(`${portalName} synced successfully`, { id: `sync-${portalId}` });\r\n  };\r\n\r\n  const updateConfig = (portalId: string, key: keyof PortalConfig, value: any) => {\r\n    setConfigs(prev => ({\r\n      ...prev,\r\n      [portalId]: {\r\n        ...defaultConfig,\r\n        ...prev[portalId],\r\n        [key]: value,\r\n      },\r\n    }));\r\n    setHasChanges(true);\r\n  };\r\n\r\n  const updateCredentials = (portalId: string, field: \"api_key\" | \"api_secret\", value: string) => {\r\n    setApiCredentials(prev => ({\r\n      ...prev,\r\n      [portalId]: {\r\n        ...prev[portalId],\r\n        [field]: value,\r\n      },\r\n    }));\r\n  };\r\n\r\n  const saveCredentials = async (portal: Portal) => {\r\n    if (!portal.portalAccountId) return;\r\n\r\n    setSavingCredentials(portal.id);\r\n    try {\r\n      const credentials = apiCredentials[portal.id];\r\n\r\n      const { error } = await supabase\r\n        .from(\"portal_accounts\")\r\n        .update({\r\n          credentials: {\r\n            api_key: credentials.api_key,\r\n            api_secret: credentials.api_secret,\r\n          },\r\n        })\r\n        .eq(\"id\", portal.portalAccountId);\r\n\r\n      if (error) throw error;\r\n\r\n      toast.success(`${portal.name} API credentials saved`);\r\n    } catch (error) {\r\n      console.error(\"Error saving credentials:\", error);\r\n      toast.error(\"Failed to save credentials\");\r\n    } finally {\r\n      setSavingCredentials(null);\r\n    }\r\n  };\r\n\r\n  const handleSave = async () => {\r\n    setSaving(true);\r\n    await new Promise(resolve => setTimeout(resolve, 500));\r\n    localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(configs));\r\n    setSaving(false);\r\n    setHasChanges(false);\r\n    toast.success(\"Settings saved\");\r\n  };\r\n\r\n  const toggleShowSecret = (portalId: string) => {\r\n    setShowSecrets(prev => ({\r\n      ...prev,\r\n      [portalId]: !prev[portalId],\r\n    }));\r\n  };\r\n\r\n  const hasApiSupport = (name: string) => {\r\n    const lower = name.toLowerCase();\r\n    return lower.includes(\"property finder\") || lower.includes(\"bayut\") || lower.includes(\"dubizzle\");\r\n  };\r\n\r\n  if (isLoading) {\r\n    return <PortalSettingsPageSkeleton isMobile={isMobile} />;\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\r\n        <div>\r\n          <h1 className=\"text-xl sm:text-2xl font-bold tracking-tight\">Portal Settings</h1>\r\n          <p className=\"text-muted-foreground text-sm\">\r\n            Configure API credentials, default agents, and sync settings\r\n          </p>\r\n        </div>\r\n        <Button onClick={handleSave} disabled={!hasChanges || saving} size=\"sm\" className=\"w-full sm:w-auto\">\r\n          {saving ? (\r\n            <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\r\n          ) : (\r\n            <Save className=\"h-4 w-4 mr-2\" />\r\n          )}\r\n          Save\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Portal Cards */}\r\n      {portals.length === 0 ? (\r\n        <Card>\r\n          <CardContent className=\"p-6\">\r\n            <EmptyState\r\n              icon={Link2}\r\n              title=\"No portals connected\"\r\n              description=\"Connect to property portals from the Integrations page to configure them here.\"\r\n            />\r\n          </CardContent>\r\n        </Card>\r\n      ) : (\r\n        <div className=\"grid gap-4\">\r\n          {portals.map(portal => {\r\n            const config = configs[portal.id] || defaultConfig;\r\n            const credentials = apiCredentials[portal.id] || { api_key: \"\", api_secret: \"\" };\r\n            const showSecret = showSecrets[portal.id] || false;\r\n            const hasSupport = hasApiSupport(portal.name);\r\n\r\n            return (\r\n              <Card key={portal.id}>\r\n                <CardHeader className=\"pb-3\">\r\n                  <div className=\"flex flex-col sm:flex-row sm:items-center gap-3\">\r\n                    <div className=\"flex items-center gap-3 flex-1\">\r\n                      <span className=\"text-2xl\">{portal.logo}</span>\r\n                      <div className=\"flex-1 min-w-0\">\r\n                        <CardTitle className=\"text-base flex flex-wrap items-center gap-2\">\r\n                          {portal.name}\r\n                          <Badge variant=\"outline\" className=\"text-xs font-normal\">\r\n                            Connected\r\n                          </Badge>\r\n                        </CardTitle>\r\n                      </div>\r\n                    </div>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      onClick={() => handleSyncNow(portal.id, portal.name)}\r\n                      disabled={syncing === portal.id}\r\n                      className=\"w-full sm:w-auto\"\r\n                    >\r\n                      <RefreshCw className={`h-4 w-4 mr-1.5 ${syncing === portal.id ? 'animate-spin' : ''}`} />\r\n                      {syncing === portal.id ? 'Syncing...' : 'Sync Now'}\r\n                    </Button>\r\n                  </div>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-4\">\r\n                  {/* API Credentials Section - Show for portals with API support */}\r\n                  {hasApiSupport(portal.name) && (\r\n                    <div className=\"space-y-3 pb-4 border-b\">\r\n                      <Label className=\"flex items-center gap-2 text-sm font-medium\">\r\n                        <Key className=\"h-4 w-4\" />\r\n                        API Credentials\r\n                      </Label>\r\n\r\n                      <div className=\"grid gap-3\">\r\n                        <div className=\"space-y-1.5\">\r\n                          <Label className=\"text-xs text-muted-foreground\">API Key</Label>\r\n                          <Input\r\n                            type={showSecret ? \"text\" : \"password\"}\r\n                            placeholder=\"Enter API Key\"\r\n                            value={credentials.api_key}\r\n                            onChange={(e) => updateCredentials(portal.id, \"api_key\", e.target.value)}\r\n                          />\r\n                        </div>\r\n\r\n                        <div className=\"space-y-1.5\">\r\n                          <Label className=\"text-xs text-muted-foreground\">API Secret</Label>\r\n                          <div className=\"flex gap-2\">\r\n                            <Input\r\n                              type={showSecret ? \"text\" : \"password\"}\r\n                              placeholder=\"Enter API Secret\"\r\n                              value={credentials.api_secret}\r\n                              onChange={(e) => updateCredentials(portal.id, \"api_secret\", e.target.value)}\r\n                              className=\"flex-1\"\r\n                            />\r\n                            <Button\r\n                              variant=\"outline\"\r\n                              size=\"icon\"\r\n                              onClick={() => toggleShowSecret(portal.id)}\r\n                              type=\"button\"\r\n                            >\r\n                              {showSecret ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\r\n                            </Button>\r\n                          </div>\r\n                        </div>\r\n\r\n                        <Button\r\n                          variant=\"secondary\"\r\n                          size=\"sm\"\r\n                          onClick={() => saveCredentials(portal)}\r\n                          disabled={savingCredentials === portal.id || (!credentials.api_key && !credentials.api_secret)}\r\n                          className=\"w-full sm:w-auto\"\r\n                        >\r\n                          {savingCredentials === portal.id ? (\r\n                            <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                          ) : (\r\n                            <Save className=\"h-4 w-4 mr-2\" />\r\n                          )}\r\n                          Save Credentials\r\n                        </Button>\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Auto Sync Toggle */}\r\n                  <div className=\"flex items-center justify-between pt-2\">\r\n                    <Label className=\"flex items-center gap-2 text-sm\">\r\n                      <RefreshCw className=\"h-4 w-4\" />\r\n                      Auto Sync\r\n                    </Label>\r\n                    <Switch\r\n                      checked={config.autoSync}\r\n                      onCheckedChange={(checked) => updateConfig(portal.id, \"autoSync\", checked)}\r\n                    />\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n            );\r\n          })}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\PublishToPortalsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":426,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":426,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15277,15280],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15277,15280],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":427,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":427,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15341,15344],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15341,15344],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'transformedListing'. Either include it or remove the dependency array.","line":452,"column":6,"nodeType":"ArrayExpression","endLine":452,"endColumn":22,"suggestions":[{"desc":"Update the dependencies array to be: [fetchedListing, transformedListing]","fix":{"range":[16560,16576],"text":"[fetchedListing, transformedListing]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'customizations' and 'portals'. Either include them or remove the dependency array.","line":469,"column":6,"nodeType":"ArrayExpression","endLine":469,"endColumn":32,"suggestions":[{"desc":"Update the dependencies array to be: [selectedPortals, listing, portals, customizations]","fix":{"range":[17164,17190],"text":"[selectedPortals, listing, portals, customizations]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'portals'. Either include it or remove the dependency array.","line":502,"column":6,"nodeType":"ArrayExpression","endLine":502,"endColumn":45,"suggestions":[{"desc":"Update the dependencies array to be: [portalAgents, listing, fetchedListing, portals]","fix":{"range":[18389,18428],"text":"[portalAgents, listing, fetchedListing, portals]"}}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { useParams, useNavigate } from \"react-router-dom\";\r\nimport { ArrowLeft, Globe, Loader2, Zap } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { toast } from \"sonner\";\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport { ListingSummaryCard } from \"@/components/publish-portals/ListingSummary\";\r\nimport { PortalSelection } from \"@/components/publish-portals/PortalSelection\";\r\nimport { PortalCustomizationPanel } from \"@/components/publish-portals/PortalCustomizationPanel\";\r\nimport { PublishActions } from \"@/components/publish-portals/PublishActions\";\r\nimport { ActivityLog } from \"@/components/publish-portals/ActivityLog\";\r\nimport { ValidationStatus } from \"@/components/publish-portals/ValidationStatus\";\r\nimport { PortalPreviewModal } from \"@/components/publish-portals/PortalPreviewModal\";\r\nimport { useListing } from \"@/hooks/useListing\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport {\r\n  Portal,\r\n  PortalCustomization,\r\n  ListingSummary,\r\n  PublishActivity,\r\n  Agent,\r\n  PortalAgent,\r\n} from \"@/components/publish-portals/types\";\r\nimport { usePortalAccounts } from \"@/hooks/usePortalAccounts\";\r\n\r\n// Default requirements for portals without specific rules\r\nconst defaultPortalRequirements: Record<string, string[]> = {\r\n  'property finder': [\"Minimum 5 photos\", \"Complete description\", \"Valid permit number\"],\r\n  'bayut': [\"Minimum 3 photos\", \"Property type required\", \"Location coordinates\"],\r\n  'dubizzle': [\"Cover image required\", \"Price in AED\", \"Contact details\"],\r\n  'default': [\"Property details\", \"At least one photo\", \"Valid contact\"],\r\n};\r\n\r\nfunction getPortalRequirements(portalName: string, country?: string | null): string[] {\r\n  const key = portalName.toLowerCase();\r\n  const reqs = [...defaultPortalRequirements.default];\r\n\r\n  if (key.includes('property finder')) reqs.push(\"Minimum 5 photos\");\r\n  if (key.includes('bayut')) reqs.push(\"Location coordinates\");\r\n\r\n  if (country === 'UAE') {\r\n    reqs.push(\"Valid permit number (Trakheesi)\");\r\n  }\r\n\r\n  if (country === 'Qatar') {\r\n    reqs.push(\"Location coordinates (recommended)\");\r\n  }\r\n\r\n  // Custom logic for specific portals\r\n  for (const [name, portalReqs] of Object.entries(defaultPortalRequirements)) {\r\n    if (key.includes(name) && name !== 'default') {\r\n      return [...new Set([...reqs, ...portalReqs])];\r\n    }\r\n  }\r\n\r\n  return [...new Set(reqs)];\r\n}\r\n\r\nfunction formatLastSync(lastSync: string | null): string | undefined {\r\n  if (!lastSync) return undefined;\r\n  const date = new Date(lastSync);\r\n  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });\r\n}\r\n\r\nconst defaultAmenitiesList = [\r\n  \"Swimming Pool\",\r\n  \"Gym\",\r\n  \"24/7 Security\",\r\n  \"Covered Parking\",\r\n  \"Children's Play Area\",\r\n  \"BBQ Area\",\r\n  \"Concierge Service\",\r\n  \"Beach Access\",\r\n  \"Balcony\",\r\n  \"Built-in Wardrobes\",\r\n  \"Central A/C\",\r\n  \"Pets Allowed\",\r\n  \"Maid's Room\",\r\n  \"Study\",\r\n  \"Walk-in Closet\",\r\n  \"Kitchen Appliances\",\r\n  \"Private Garden\",\r\n  \"Private Pool\",\r\n  \"View of Water\",\r\n  \"View of Landmark\",\r\n  \"Shared Spa\",\r\n  \"Steam Room\",\r\n  \"Sauna\",\r\n  \"Private Beach\",\r\n  \"Smart Home\",\r\n  \"Driver's Room\",\r\n  \"Garden\",\r\n  \"Private Terrace\",\r\n  \"Rooftop Jacuzzi\",\r\n  \"Valet Parking\",\r\n];\r\n\r\nfunction getCurrencyForCountry(country?: string | null): string {\r\n  if (!country) return 'AED';\r\n  const map: Record<string, string> = {\r\n    'UAE': 'AED',\r\n    'Qatar': 'QAR',\r\n    'Saudi Arabia': 'SAR',\r\n    'Oman': 'OMR',\r\n    'Bahrain': 'BHD',\r\n    'Kuwait': 'KWD',\r\n    'Egypt': 'EGP',\r\n    'Lebanon': 'LBP'\r\n  };\r\n  return map[country] || 'AED';\r\n}\r\n\r\nfunction createDefaultCustomization(\r\n  portalId: string,\r\n  listing: ListingSummary,\r\n  country?: string | null\r\n): PortalCustomization {\r\n  // Auto-populate from listing data\r\n  const hasDescription = !!listing.description && listing.description.length > 0;\r\n  const listingAmenities = listing.amenities || [];\r\n  const hasEnoughAmenities = listingAmenities.length >= 3;\r\n  const hasEnoughImages = listing.images.length >= 3;\r\n\r\n  const errors: string[] = [];\r\n  if (!hasDescription) errors.push(\"Description is required\");\r\n  if (!hasEnoughAmenities) errors.push(\"Add at least 3 amenities\");\r\n  if (!hasEnoughImages) errors.push(\"Add at least 3 images\");\r\n\r\n  const portalCurrency = getCurrencyForCountry(country);\r\n  const formattedPrice = listing.rawPrice\r\n    ? formatPrice(listing.rawPrice, portalCurrency)\r\n    : listing.price;\r\n\r\n  let formattedLocation = listing.location;\r\n  if (country && listing.rawCountry === country) {\r\n    formattedLocation = [listing.rawAddress, listing.rawCity].filter(Boolean).join(\", \");\r\n    if (!formattedLocation) formattedLocation = listing.location;\r\n  }\r\n\r\n  // Country-specific initial validation\r\n  if (country === 'UAE' && !listing.permitNumber) {\r\n    errors.push(\"Permit Number is required for UAE portals\");\r\n  }\r\n\r\n  const validationScore = Math.min(100, 100 - errors.length * 15);\r\n\r\n  return {\r\n    portalId,\r\n    title: listing.title,\r\n    description: listing.description || \"\",\r\n    selectedImages: listing.images.map((_, i) => i),\r\n    price: formattedPrice,\r\n    propertyType: listing.type,\r\n    amenities: listingAmenities,\r\n    agentId: listing.agentId,\r\n    seoKeywords: generateKeywords(listing),\r\n    customFields: {},\r\n    isValid: errors.length === 0,\r\n    validationScore,\r\n    errors,\r\n    // Extended fields\r\n    location: formattedLocation,\r\n    bedrooms: listing.bedrooms,\r\n    bathrooms: listing.bathrooms,\r\n    size: listing.size,\r\n    purpose: listing.purpose,\r\n    furnishing: listing.furnishing,\r\n    permitNumber: listing.permitNumber,\r\n    features: listing.features || [],\r\n    rentFrequency: listing.rentFrequency,\r\n    completionStatus: listing.completionStatus,\r\n    developer: listing.developer,\r\n    projectName: listing.projectName,\r\n    buildingName: listing.buildingName,\r\n    completionDate: listing.completionDate,\r\n    floorNumber: listing.floorNumber,\r\n    parkingSpaces: listing.parkingSpaces,\r\n    tags: listing.tags || [],\r\n    latitude: listing.latitude,\r\n    longitude: listing.longitude,\r\n    plotSize: listing.plotSize,\r\n    view: listing.view,\r\n    occupancy: listing.occupancy,\r\n    serviceCharges: listing.serviceCharges,\r\n    cheques: listing.cheques,\r\n    videoUrl: listing.videoUrl,\r\n    tourUrl: listing.tourUrl,\r\n    ownershipType: listing.ownershipType,\r\n  };\r\n}\r\n\r\nfunction generateKeywords(listing: ListingSummary): string[] {\r\n  const keywords: string[] = [];\r\n  if (listing.type) keywords.push(listing.type.toLowerCase());\r\n  if (listing.bedrooms) keywords.push(`${listing.bedrooms} bedroom`);\r\n  if (listing.location) {\r\n    const locationParts = listing.location.split(\",\");\r\n    if (locationParts[0]) keywords.push(locationParts[0].trim().toLowerCase());\r\n  }\r\n  if (listing.purpose) keywords.push(`for ${listing.purpose.toLowerCase()}`);\r\n  return keywords;\r\n}\r\n\r\nfunction formatPrice(price: number | null, currency: string): string {\r\n  if (!price) return \"Price on Request\";\r\n  return `${currency} ${price.toLocaleString()}`;\r\n}\r\n\r\nfunction formatSize(size: number | null, unit: string | null): string {\r\n  if (!size) return \"\";\r\n  return `${size.toLocaleString()} ${unit || \"sqft\"}`;\r\n}\r\n\r\n// Helper to get portal source key from portal name\r\nfunction getPortalSourceKey(portalName: string): PortalAgent[\"source\"] | null {\r\n  const name = portalName.toLowerCase();\r\n  if (name.includes(\"property finder\")) return \"property_finder\";\r\n  if (name.includes(\"bayut\")) return \"bayut\";\r\n  if (name.includes(\"dubizzle\")) return \"dubizzle\";\r\n  return null;\r\n}\r\n\r\n// Filter portal agents by specific portal\r\nfunction filterAgentsByPortal(agents: PortalAgent[], portalName: string): PortalAgent[] {\r\n  const sourceKey = getPortalSourceKey(portalName);\r\n  if (!sourceKey) return agents;\r\n  return agents.filter(a => a.source === sourceKey);\r\n}\r\n\r\nexport default function PublishToPortalsPage() {\r\n  const { id } = useParams();\r\n  const navigate = useNavigate();\r\n  const isMobile = useIsMobile();\r\n\r\n  // Fetch listing from database\r\n  const { listing: fetchedListing, isLoading, error } = useListing(id);\r\n\r\n  // Fetch real portals from database\r\n  const { portals: realPortals, isLoading: isLoadingPortals } = usePortalAccounts();\r\n\r\n  // Map real portals to Portal type for components\r\n  const portals: Portal[] = realPortals.map((p) => ({\r\n    id: p.id,\r\n    accountId: p.account_id,\r\n    name: p.display_name || p.name,\r\n    logo: p.logo_url || \"\",\r\n    connected: p.connected,\r\n    requirements: getPortalRequirements(p.name, p.country),\r\n    lastPublished: formatLastSync(p.last_sync_at),\r\n    publishStatus: p.listings_count > 0 ? 'published' as const : undefined,\r\n    country: p.country,\r\n  }));\r\n\r\n  // Fetch agents for the company\r\n  const [agents, setAgents] = useState<Agent[]>([]);\r\n  const [portalAgents, setPortalAgents] = useState<PortalAgent[]>([]);\r\n  const [isLoadingPortalAgents, setIsLoadingPortalAgents] = useState(false);\r\n  const [activities, setActivities] = useState<PublishActivity[]>([]);\r\n  const [listing, setListing] = useState<ListingSummary | null>(null);\r\n  const [selectedPortals, setSelectedPortals] = useState<string[]>([]);\r\n  const [customizations, setCustomizations] = useState<Record<string, PortalCustomization>>({});\r\n  const [activeTab, setActiveTab] = useState(\"portals\");\r\n  const [previewPortal, setPreviewPortal] = useState<Portal | null>(null);\r\n  const [companyId, setCompanyId] = useState<string | null>(null);\r\n  const [showPreviewModal, setShowPreviewModal] = useState(false);\r\n\r\n  useEffect(() => {\r\n    const fetchAgentsAndCompany = async () => {\r\n      // Get user and company\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (user) {\r\n        const { data: profile } = await supabase\r\n          .from(\"profiles\")\r\n          .select(\"company_id\")\r\n          .eq(\"id\", user.id)\r\n          .single();\r\n        if (profile?.company_id) {\r\n          setCompanyId(profile.company_id);\r\n        }\r\n      }\r\n\r\n      const { data } = await supabase\r\n        .from(\"agents\")\r\n        .select(\"id, name, email, phone\");\r\n      if (data) {\r\n        setAgents(data.map(a => ({\r\n          id: a.id,\r\n          name: a.name,\r\n          email: a.email,\r\n          phone: a.phone || undefined,\r\n        })));\r\n      }\r\n    };\r\n    fetchAgentsAndCompany();\r\n  }, []);\r\n\r\n  // Fetch portal agents when portals are selected\r\n  useEffect(() => {\r\n    const fetchPortalAgents = async () => {\r\n      if (selectedPortals.length === 0) {\r\n        setPortalAgents([]);\r\n        return;\r\n      }\r\n\r\n      setIsLoadingPortalAgents(true);\r\n      try {\r\n        // Get profile to find company_id\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user) return;\r\n\r\n        const { data: profile } = await supabase\r\n          .from(\"profiles\")\r\n          .select(\"company_id\")\r\n          .eq(\"id\", user.id)\r\n          .single();\r\n\r\n        if (!profile?.company_id) return;\r\n\r\n        // Fetch connected portal accounts\r\n        const { data: portalAccounts } = await supabase\r\n          .from(\"portal_accounts\")\r\n          .select(\"id, portal_id, credentials, portals(id, name)\")\r\n          .eq(\"company_id\", profile.company_id)\r\n          .eq(\"status\", \"connected\");\r\n\r\n        if (!portalAccounts || portalAccounts.length === 0) {\r\n\r\n          return;\r\n        }\r\n\r\n        // Call edge function for each connected portal\r\n        const allPortalAgents: PortalAgent[] = [];\r\n\r\n        for (const account of portalAccounts) {\r\n          const portal = account.portals as { id: string; name: string } | null;\r\n          if (!portal) continue;\r\n\r\n\r\n\r\n          const { data, error } = await supabase.functions.invoke(\"portal-agents-fetch\", {\r\n            body: {\r\n              portal_id: portal.id,\r\n              portal_name: portal.name.toLowerCase(),\r\n              credentials: account.credentials,\r\n              company_id: profile.company_id,\r\n            },\r\n          });\r\n\r\n          if (error) {\r\n            console.error(\"Error fetching portal agents:\", error);\r\n            continue;\r\n          }\r\n\r\n          if (data?.agents) {\r\n\r\n            allPortalAgents.push(...data.agents);\r\n          }\r\n        }\r\n\r\n        setPortalAgents(allPortalAgents);\r\n      } catch (err) {\r\n        console.error(\"Error fetching portal agents:\", err);\r\n      } finally {\r\n        setIsLoadingPortalAgents(false);\r\n      }\r\n    };\r\n\r\n    fetchPortalAgents();\r\n  }, [selectedPortals]);\r\n\r\n  // Fetch publish activities for this listing\r\n  useEffect(() => {\r\n    const fetchActivities = async () => {\r\n      if (!id) return;\r\n      const { data } = await supabase\r\n        .from(\"listing_portals\")\r\n        .select(\"id, portal_name, publish_status, last_sync_at\")\r\n        .eq(\"listing_id\", id)\r\n        .order(\"last_sync_at\", { ascending: false });\r\n\r\n      if (data) {\r\n        setActivities(data.map(p => ({\r\n          id: p.id,\r\n          portalId: p.portal_name.toLowerCase().replace(/\\s+/g, '-'),\r\n          portalName: p.portal_name,\r\n          action: p.publish_status === 'published' ? 'published' : p.publish_status === 'failed' ? 'failed' : 'pending' as const,\r\n          timestamp: p.last_sync_at ? new Date(p.last_sync_at).toLocaleString() : 'Not synced',\r\n        })));\r\n      }\r\n    };\r\n    fetchActivities();\r\n  }, [id]);\r\n\r\n  // Transform fetched listing to ListingSummary format\r\n  const transformedListing: ListingSummary | null = fetchedListing ? {\r\n    id: fetchedListing.id,\r\n    title: fetchedListing.title,\r\n    refNumber: fetchedListing.reference_number || \"\",\r\n    location: [fetchedListing.address, fetchedListing.city, fetchedListing.country].filter(Boolean).join(\", \"),\r\n    rawAddress: fetchedListing.address,\r\n    rawCity: fetchedListing.city,\r\n    rawCountry: fetchedListing.country,\r\n    price: formatPrice(fetchedListing.price, fetchedListing.currency),\r\n    rawPrice: fetchedListing.price,\r\n    rawCurrency: fetchedListing.currency,\r\n    bedrooms: fetchedListing.number_of_bedrooms || 0,\r\n    bathrooms: fetchedListing.number_of_bathrooms || 0,\r\n    size: formatSize(fetchedListing.area_size, fetchedListing.area_unit),\r\n    rawSize: fetchedListing.area_size,\r\n    rawSizeUnit: fetchedListing.area_unit,\r\n    type: fetchedListing.property_type || \"\",\r\n    purpose: (fetchedListing.listing_type === 'Rent' ? 'Rent' : 'Sale') as 'Sale' | 'Rent',\r\n    status: (fetchedListing.status === 'Published' ? 'Published' : fetchedListing.status === 'Ready' ? 'Ready' : 'Draft') as 'Draft' | 'Ready' | 'Published',\r\n    description: fetchedListing.description || \"\",\r\n    amenities: fetchedListing.amenities || [],\r\n    features: [],\r\n    furnishing: fetchedListing.furnished || \"\",\r\n    permitNumber: fetchedListing.permit_number || \"\",\r\n    images: fetchedListing.images || [],\r\n    agentId: fetchedListing.assigned_agent_id || \"\",\r\n    agentName: fetchedListing.agent?.name || \"Unassigned\",\r\n    agentAvatar: fetchedListing.agent?.avatar_url || undefined,\r\n    rentFrequency: fetchedListing.rent_frequency as any,\r\n    completionStatus: fetchedListing.completion_status as any,\r\n    developer: fetchedListing.developer || \"\",\r\n    projectName: fetchedListing.project_name || \"\",\r\n    buildingName: fetchedListing.building_name || \"\",\r\n    completionDate: fetchedListing.handover_date || \"\",\r\n    floorNumber: fetchedListing.floor_number || undefined,\r\n    parkingSpaces: fetchedListing.parking_spaces || undefined,\r\n    tags: Array.isArray(fetchedListing.tags) ? fetchedListing.tags as string[] : [],\r\n    latitude: fetchedListing.latitude || undefined,\r\n    longitude: fetchedListing.longitude || undefined,\r\n    plotSize: fetchedListing.plot_size?.toString() || undefined,\r\n    view: fetchedListing.view_type || \"\",\r\n    serviceCharges: fetchedListing.service_charge || undefined,\r\n    videoUrl: Array.isArray(fetchedListing.videos) && fetchedListing.videos.length > 0 ? (typeof fetchedListing.videos[0] === 'string' ? fetchedListing.videos[0] : fetchedListing.videos[0].url) : \"\",\r\n    tourUrl: fetchedListing.virtual_tour_url || \"\",\r\n    ownershipType: fetchedListing.ownership_type || \"\",\r\n  } : null;\r\n\r\n\r\n  // Update listing when fetched data changes\r\n  useEffect(() => {\r\n    if (transformedListing) {\r\n      setListing(transformedListing);\r\n      setCustomizations({});\r\n    }\r\n  }, [fetchedListing]);\r\n\r\n  // Initialize customizations for selected portals\r\n  useEffect(() => {\r\n    if (!listing) return;\r\n\r\n    const newCustomizations: Record<string, PortalCustomization> = {};\r\n    selectedPortals.forEach((portalId) => {\r\n      const portal = portals.find(p => p.id === portalId);\r\n      if (!customizations[portalId]) {\r\n        newCustomizations[portalId] = createDefaultCustomization(portalId, listing, portal?.country);\r\n      }\r\n    });\r\n\r\n    if (Object.keys(newCustomizations).length > 0) {\r\n      setCustomizations((prev) => ({ ...prev, ...newCustomizations }));\r\n    }\r\n  }, [selectedPortals, listing]);\r\n\r\n  // Auto-match portal agents when they are loaded\r\n  useEffect(() => {\r\n    if (portalAgents.length === 0 || !listing) return;\r\n\r\n    setCustomizations(prev => {\r\n      const next = { ...prev };\r\n      let changed = false;\r\n\r\n      Object.keys(next).forEach((portalId) => {\r\n        const customization = next[portalId];\r\n        const portal = portals.find(p => p.id === portalId);\r\n        if (!portal) return;\r\n\r\n        // If the current agentId is the internal listing agent ID, try to find a portal-specific match\r\n        if (customization.agentId === listing.agentId) {\r\n          const sourceKey = getPortalSourceKey(portal.name);\r\n          const matchedAgent = portalAgents.find(pa =>\r\n            (pa.source === sourceKey) &&\r\n            (pa.name.toLowerCase().includes(listing.agentName.toLowerCase()) ||\r\n              (pa.email && fetchedListing?.agent?.email && pa.email.toLowerCase() === fetchedListing.agent.email.toLowerCase()))\r\n          );\r\n\r\n          if (matchedAgent) {\r\n            next[portalId] = { ...customization, agentId: matchedAgent.id };\r\n            changed = true;\r\n          }\r\n        }\r\n      });\r\n\r\n      return changed ? next : prev;\r\n    });\r\n  }, [portalAgents, listing, fetchedListing]);\r\n\r\n  const handleTogglePortal = (portalId: string) => {\r\n    setSelectedPortals((prev) =>\r\n      prev.includes(portalId)\r\n        ? prev.filter((id) => id !== portalId)\r\n        : [...prev, portalId]\r\n    );\r\n  };\r\n\r\n  const handleSelectAllPortals = () => {\r\n    const connectedIds = portals.filter((p) => p.connected).map((p) => p.id);\r\n    setSelectedPortals(connectedIds);\r\n  };\r\n\r\n  const handleDeselectAllPortals = () => {\r\n    setSelectedPortals([]);\r\n  };\r\n\r\n  const handleUpdateCustomization = (portalId: string, updates: Partial<PortalCustomization>) => {\r\n    setCustomizations((prev) => {\r\n      const portal = portals.find(p => p.id === portalId);\r\n      const current = prev[portalId] || createDefaultCustomization(portalId, listing, portal?.country);\r\n      const updated = { ...current, ...updates };\r\n\r\n      // Recalculate validation\r\n      const errors: string[] = [];\r\n      if (!updated.description) errors.push(\"Description is required\");\r\n      if (updated.selectedImages.length < 3) errors.push(\"Select at least 3 images\");\r\n      if (updated.amenities.length < 3) errors.push(\"Add at least 3 amenities\");\r\n      if (!updated.agentId) errors.push(\"Agent assignment required\");\r\n      if (!updated.completionStatus) errors.push(\"Completion Status is required\");\r\n      if (!updated.purpose) errors.push(\"Purpose is required\");\r\n\r\n      // Country-specific validation\r\n      if (portal?.country === 'UAE') {\r\n        if (!updated.permitNumber) {\r\n          errors.push(\"Permit Number is required for UAE portals\");\r\n        }\r\n        if (updated.completionStatus === 'Off-plan' && !updated.developer) {\r\n          errors.push(\"Developer is required for Off-plan properties in UAE\");\r\n        }\r\n        if (!updated.projectName) {\r\n          errors.push(\"Project Name is recommended for UAE portals\");\r\n        }\r\n      }\r\n\r\n      updated.errors = errors;\r\n      updated.isValid = errors.length === 0;\r\n      updated.validationScore = Math.min(100, 100 - errors.length * 15);\r\n\r\n      return { ...prev, [portalId]: updated };\r\n    });\r\n  };\r\n\r\n  const handleImagesChange = (newImages: string[]) => {\r\n    setListing((prev) => prev ? ({\r\n      ...prev,\r\n      images: newImages,\r\n    }) : prev);\r\n  };\r\n\r\n  const handleAgentChange = (agentId: string) => {\r\n    const agent = agents.find((a) => a.id === agentId);\r\n    if (agent) {\r\n      setListing((prev) => prev ? ({\r\n        ...prev,\r\n        agentId: agent.id,\r\n        agentName: agent.name,\r\n        agentAvatar: agent.avatar,\r\n      }) : prev);\r\n    }\r\n  };\r\n\r\n  const handleListingChange = (updates: Partial<ListingSummary>) => {\r\n    setListing((prev) => prev ? ({\r\n      ...prev,\r\n      ...updates,\r\n    }) : prev);\r\n  };\r\n\r\n  const handlePublish = async () => {\r\n    toast.success(\"Publishing complete!\", {\r\n      description: `Listing published to ${selectedPortals.length} portal(s)`,\r\n    });\r\n  };\r\n\r\n  const handleSaveDraft = () => {\r\n    toast.success(\"Draft saved\", {\r\n      description: \"Your portal settings have been saved\",\r\n    });\r\n  };\r\n\r\n  const handlePreview = (portalId: string) => {\r\n    const portal = portals.find((p) => p.id === portalId);\r\n    if (portal) {\r\n      setPreviewPortal(portal);\r\n      setShowPreviewModal(true);\r\n    }\r\n  };\r\n\r\n  // Loading and error states\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-[400px]\">\r\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error || !listing) {\r\n    return (\r\n      <div className=\"text-center py-12\">\r\n        <p className=\"text-muted-foreground\">Listing not found</p>\r\n        <Button variant=\"outline\" onClick={() => navigate(\"/listings\")} className=\"mt-4\">\r\n          Back to Listings\r\n        </Button>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-3 md:space-y-4 lg:space-y-6 pb-20 md:pb-24\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between gap-2\">\r\n        <Button variant=\"ghost\" size=\"sm\" onClick={() => navigate(`/listings/${id}`)} className=\"gap-1.5 h-8 px-2 text-xs\">\r\n          <ArrowLeft className=\"h-3.5 w-3.5\" />\r\n          <span className=\"hidden sm:inline\">Back to Listing</span>\r\n          <span className=\"sm:hidden\">Back</span>\r\n        </Button>\r\n        <div className=\"flex items-center gap-1.5\">\r\n          <Globe className=\"h-4 w-4 md:h-5 md:w-5 text-primary\" />\r\n          <h1 className=\"text-sm md:text-base lg:text-xl font-semibold\">Publish to Portals</h1>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Listing Summary */}\r\n      <ListingSummaryCard\r\n        listing={listing}\r\n        agents={agents}\r\n        portalAgents={portalAgents}\r\n        isLoadingPortalAgents={isLoadingPortalAgents}\r\n        selectedPortalName={selectedPortals[0] ? portals.find(p => p.id === selectedPortals[0])?.name : undefined}\r\n        onAgentChange={(agentId, isPortalAgent, portalAgentData) => {\r\n          if (isPortalAgent && portalAgentData) {\r\n            setListing(prev => prev ? ({\r\n              ...prev,\r\n              agentId: portalAgentData.id,\r\n              agentName: portalAgentData.name,\r\n              agentAvatar: portalAgentData.avatar,\r\n            }) : prev);\r\n          } else {\r\n            handleAgentChange(agentId);\r\n          }\r\n        }}\r\n        onListingChange={(updates) => setListing(prev => prev ? ({ ...prev, ...updates }) : prev)}\r\n      />\r\n\r\n      <Separator />\r\n\r\n      {/* Main Content */}\r\n      {isMobile ? (\r\n        <Tabs value={activeTab} onValueChange={setActiveTab}>\r\n          <TabsList className=\"w-full grid grid-cols-3 h-9\">\r\n            <TabsTrigger value=\"portals\" className=\"text-xs\">Portals</TabsTrigger>\r\n            <TabsTrigger value=\"customize\" className=\"text-xs\">Customize</TabsTrigger>\r\n            <TabsTrigger value=\"activity\" className=\"text-xs\">Activity</TabsTrigger>\r\n          </TabsList>\r\n\r\n          <TabsContent value=\"portals\" className=\"mt-3\">\r\n            <PortalSelection\r\n              portals={portals}\r\n              selectedPortals={selectedPortals}\r\n              onTogglePortal={handleTogglePortal}\r\n              onSelectAll={handleSelectAllPortals}\r\n              onDeselectAll={handleDeselectAllPortals}\r\n            />\r\n          </TabsContent>\r\n\r\n          <TabsContent value=\"customize\" className=\"mt-3 space-y-3\">\r\n            {selectedPortals.length === 0 ? (\r\n              <div className=\"text-center py-6 text-muted-foreground\">\r\n                <Globe className=\"h-10 w-10 mx-auto mb-2 opacity-50\" />\r\n                <p className=\"text-sm\">Select portals to customize</p>\r\n              </div>\r\n            ) : (\r\n              <div className=\"space-y-6\">\r\n                {/* Connection Status Info */}\r\n                {selectedPortals.some(id => ['bayut', 'dubizzle', 'property finder'].includes(id.toLowerCase())) && (\r\n                  <div className=\"bg-primary/5 border border-primary/20 rounded-lg p-4 mb-4\">\r\n                    <h4 className=\"text-sm font-semibold flex items-center gap-2 mb-2 text-primary\">\r\n                      <Zap className=\"h-4 w-4 text-amber-500\" />\r\n                      Publishing Method\r\n                    </h4>\r\n\r\n                    <div className=\"space-y-4\">\r\n                      {selectedPortals.map(portalId => {\r\n                        const portal = portals.find(p => p.id === portalId);\r\n                        if (!portal) return null;\r\n\r\n                        const isFeedPortal = ['bayut', 'dubizzle'].includes(portal.name.toLowerCase());\r\n                        const isApiPortal = portal.name.toLowerCase().includes('property finder');\r\n                        const isConnected = portal.connected;\r\n\r\n                        return (\r\n                          <div key={portalId} className=\"space-y-2\">\r\n                            <div className=\"flex items-center justify-between\">\r\n                              <span className=\"text-sm font-medium\">{portal.name}</span>\r\n                              {isConnected ? (\r\n                                <Badge variant=\"outline\" className=\"bg-emerald-50 text-emerald-700 border-emerald-200 gap-1\">\r\n                                  <Zap className=\"h-3 w-3\" /> Instant API Active\r\n                                </Badge>\r\n                              ) : (\r\n                                <Badge variant=\"outline\" className=\"bg-amber-50 text-amber-700 border-amber-200\">\r\n                                  {isFeedPortal ? 'XML Feed Only' : 'API Setup Required'}\r\n                                </Badge>\r\n                              )}\r\n                            </div>\r\n\r\n                            {isFeedPortal && !isConnected && (\r\n                              <div className=\"space-y-1\">\r\n                                <p className=\"text-[10px] md:text-xs text-muted-foreground\">\r\n                                  Share this URL with your account manager for background sync:\r\n                                </p>\r\n                                <div className=\"flex items-center gap-2\">\r\n                                  <code className=\"text-[10px] md:text-xs bg-muted p-1.5 rounded border flex-1 break-all select-all\">\r\n                                    {`${import.meta.env.VITE_SUPABASE_URL}/functions/v1/feed-generator?company_id=${companyId}&portal=${portal.id}`}\r\n                                  </code>\r\n                                  <Button\r\n                                    size=\"sm\"\r\n                                    variant=\"outline\"\r\n                                    className=\"h-7 px-2\"\r\n                                    onClick={() => {\r\n                                      navigator.clipboard.writeText(`${import.meta.env.VITE_SUPABASE_URL}/functions/v1/feed-generator?company_id=${companyId}&portal=${portal.id}`);\r\n                                      toast.success(\"Feed URL copied\");\r\n                                    }}\r\n                                  >\r\n                                    Copy\r\n                                  </Button>\r\n                                </div>\r\n                              </div>\r\n                            )}\r\n\r\n                            {!isConnected && (isApiPortal || isFeedPortal) && (\r\n                              <p className=\"text-[10px] text-muted-foreground\">\r\n                                Tip: Go to <a href=\"/settings/portals\" className=\"text-primary hover:underline\">Portal Settings</a> to enter API keys for instant publishing.\r\n                              </p>\r\n                            )}\r\n                          </div>\r\n                        );\r\n                      })}\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {selectedPortals.map((portalId) => {\r\n                  const portal = portals.find((p) => p.id === portalId);\r\n                  const customization = customizations[portalId];\r\n                  if (!portal || !customization) return null;\r\n\r\n                  return (\r\n                    <PortalCustomizationPanel\r\n                      key={portalId}\r\n                      portal={portal}\r\n                      customization={customization}\r\n                      images={listing.images}\r\n                      agents={agents}\r\n                      portalAgents={filterAgentsByPortal(portalAgents, portal.name)}\r\n                      isLoadingPortalAgents={isLoadingPortalAgents}\r\n                      amenitiesList={defaultAmenitiesList}\r\n                      listing={listing}\r\n                      onUpdate={(updates) => handleUpdateCustomization(portalId, updates)}\r\n                      onImagesChange={handleImagesChange}\r\n                    />\r\n                  );\r\n                })\r\n                }\r\n              </div>\r\n            )}\r\n          </TabsContent>\r\n\r\n          <TabsContent value=\"activity\" className=\"mt-3 space-y-3\">\r\n            <ValidationStatus\r\n              customizations={customizations}\r\n              selectedPortals={selectedPortals}\r\n            />\r\n            <ActivityLog activities={activities} />\r\n          </TabsContent>\r\n        </Tabs>\r\n      ) : (\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6\">\r\n          {/* Left Column - Portal Selection & Customization */}\r\n          <div className=\"lg:col-span-3 space-y-6\">\r\n            <PortalSelection\r\n              portals={portals}\r\n              selectedPortals={selectedPortals}\r\n              onTogglePortal={handleTogglePortal}\r\n              onSelectAll={handleSelectAllPortals}\r\n              onDeselectAll={handleDeselectAllPortals}\r\n            />\r\n\r\n            {selectedPortals.length > 0 && (\r\n              <>\r\n                <Separator />\r\n                <div className=\"space-y-4\">\r\n                  <h3 className=\"text-lg font-semibold\">Portal Customization</h3>\r\n                  {selectedPortals.map((portalId) => {\r\n                    const portal = portals.find((p) => p.id === portalId);\r\n                    const customization = customizations[portalId];\r\n                    if (!portal || !customization) return null;\r\n\r\n                    return (\r\n                      <PortalCustomizationPanel\r\n                        key={portalId}\r\n                        portal={portal}\r\n                        customization={customization}\r\n                        images={listing.images}\r\n                        agents={agents}\r\n                        portalAgents={filterAgentsByPortal(portalAgents, portal.name)}\r\n                        isLoadingPortalAgents={isLoadingPortalAgents}\r\n                        amenitiesList={defaultAmenitiesList}\r\n                        listing={listing}\r\n                        onUpdate={(updates) => handleUpdateCustomization(portalId, updates)}\r\n                        onImagesChange={handleImagesChange}\r\n                      />\r\n                    );\r\n                  })}\r\n                </div>\r\n              </>\r\n            )}\r\n          </div>\r\n\r\n          {/* Right Column - Validation & Activity */}\r\n          <div className=\"space-y-4\">\r\n            <ValidationStatus\r\n              customizations={customizations}\r\n              selectedPortals={selectedPortals}\r\n            />\r\n            <ActivityLog activities={activities} />\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Publish Actions - Sticky Bottom */}\r\n      <PublishActions\r\n        selectedPortals={selectedPortals}\r\n        portals={portals}\r\n        customizations={customizations}\r\n        listingId={id || \"\"}\r\n        companyId={companyId || \"\"}\r\n        onPublish={handlePublish}\r\n        onSaveDraft={handleSaveDraft}\r\n        onPreview={handlePreview}\r\n      />\r\n\r\n      {/* Portal Preview Modal */}\r\n      {previewPortal && listing && (\r\n        <PortalPreviewModal\r\n          open={showPreviewModal}\r\n          onOpenChange={setShowPreviewModal}\r\n          portal={previewPortal}\r\n          customization={customizations[previewPortal.id] || {\r\n            portalId: previewPortal.id,\r\n            title: listing.title,\r\n            description: listing.description || \"\",\r\n            selectedImages: listing.images.map((_, i) => i),\r\n            price: listing.price,\r\n            propertyType: listing.type,\r\n            amenities: listing.amenities || [],\r\n            agentId: listing.agentId || \"\",\r\n            seoKeywords: [],\r\n            customFields: {},\r\n            isValid: true,\r\n            validationScore: 100,\r\n            errors: [],\r\n          }}\r\n          listing={listing}\r\n          agent={agents.find(a => a.id === listing.agentId)}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\RolesPermissionsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\SettingsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":151,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":151,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5096,5099],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5096,5099],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":175,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":175,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5662,5665],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5662,5665],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":238,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":238,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7368,7371],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7368,7371],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":289,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":289,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8805,8808],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8805,8808],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport {\r\n  Building2,\r\n  User,\r\n  Bell,\r\n  Key,\r\n  Palette,\r\n  Lock,\r\n  Upload,\r\n  Save,\r\n  Eye,\r\n  EyeOff,\r\n  Copy,\r\n  RefreshCw,\r\n  Check,\r\n  Loader2,\r\n  Mail,\r\n  Globe,\r\n  Shield,\r\n  Trash2,\r\n  Camera,\r\n} from \"lucide-react\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Switch } from \"@/components/ui/switch\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { toast } from \"sonner\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { SettingsPageSkeleton } from \"@/components/ui/page-skeletons\";\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport { useCompany } from \"@/hooks/useCompany\";\r\nimport { useTheme } from \"@/contexts/ThemeContext\";\r\nimport { useLocalization } from \"@/contexts/LocalizationContext\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\n\r\nconst pageVariants = {\r\n  initial: { opacity: 0, y: 20 },\r\n  animate: { opacity: 1, y: 0 },\r\n  exit: { opacity: 0, y: -10 }\r\n};\r\n\r\nconst pageTransition = {\r\n  type: \"tween\" as const,\r\n  ease: \"easeOut\" as const,\r\n  duration: 0.3\r\n};\r\n\r\nconst SettingsPage = () => {\r\n  const isMobile = useIsMobile();\r\n  const { user, profile, refreshProfile } = useAuth();\r\n  const { company, isLoading: companyLoading } = useCompany();\r\n  const { theme, setTheme } = useTheme();\r\n  const { t } = useLocalization();\r\n\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isSaving, setIsSaving] = useState(false);\r\n  const [activeTab, setActiveTab] = useState(\"account\");\r\n\r\n  // Account Settings\r\n  const [fullName, setFullName] = useState(\"\");\r\n  const [email, setEmail] = useState(\"\");\r\n  const [phone, setPhone] = useState(\"\");\r\n  const [avatarUrl, setAvatarUrl] = useState(\"\");\r\n\r\n  // Company Settings\r\n  const [companyName, setCompanyName] = useState(\"\");\r\n  const [companyLogo, setCompanyLogo] = useState(\"\");\r\n  const [companyWebsite, setCompanyWebsite] = useState(\"\");\r\n\r\n  // Basic Settings\r\n  const [country, setCountry] = useState(\"United Arab Emirates\");\r\n  const [timezone, setTimezone] = useState(\"Asia/Dubai\");\r\n  const [currency, setCurrency] = useState(\"AED\");\r\n  const [sizeUnit, setSizeUnit] = useState(\"sqft\");\r\n\r\n  useEffect(() => {\r\n    setCountry(localStorage.getItem('settings_country') || \"United Arab Emirates\");\r\n    setTimezone(localStorage.getItem('settings_timezone') || \"Asia/Dubai\");\r\n    setCurrency(localStorage.getItem('listing_preferred_currency') || \"AED\");\r\n    setSizeUnit(localStorage.getItem('listing_preferred_size_unit') || \"sqft\");\r\n  }, []);\r\n\r\n  // Notification Settings\r\n  const [emailNotifications, setEmailNotifications] = useState(true);\r\n  const [pushNotifications, setPushNotifications] = useState(true);\r\n  const [leadNotifications, setLeadNotifications] = useState(true);\r\n  const [weeklyReports, setWeeklyReports] = useState(false);\r\n\r\n  // Security Settings\r\n  const [currentPassword, setCurrentPassword] = useState(\"\");\r\n  const [newPassword, setNewPassword] = useState(\"\");\r\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\r\n  const [showCurrentPassword, setShowCurrentPassword] = useState(false);\r\n  const [showNewPassword, setShowNewPassword] = useState(false);\r\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false);\r\n\r\n  // API Settings\r\n  const [apiKey, setApiKey] = useState(\"\");\r\n  const [showApiKey, setShowApiKey] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (profile) {\r\n      const name = [profile.first_name, profile.last_name].filter(Boolean).join(\" \");\r\n      setFullName(name);\r\n      setEmail(user?.email || \"\");\r\n      setPhone(profile.phone || \"\");\r\n      setAvatarUrl(profile.avatar_url || \"\");\r\n    }\r\n    if (company) {\r\n      setCompanyName(company.name || \"\");\r\n      setCompanyLogo(company.logo_url || \"\");\r\n      setCompanyWebsite(company.website || \"\");\r\n    }\r\n    setIsLoading(false);\r\n  }, [profile, company, user]);\r\n\r\n  const handleSaveAccount = async () => {\r\n    setIsSaving(true);\r\n    try {\r\n      const nameParts = fullName.trim().split(\" \");\r\n      const firstName = nameParts[0] || \"\";\r\n      const lastName = nameParts.slice(1).join(\" \") || \"\";\r\n\r\n      const { error } = await supabase\r\n        .from(\"profiles\")\r\n        .update({\r\n          first_name: firstName,\r\n          last_name: lastName,\r\n          phone: phone,\r\n        })\r\n        .eq(\"id\", user?.id);\r\n\r\n      if (error) throw error;\r\n\r\n      await refreshProfile();\r\n      toast.success(t('changes_saved'));\r\n    } catch (error: any) {\r\n      console.error(\"Error saving account:\", error);\r\n      toast.error(t('error_message'));\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleSaveCompany = async () => {\r\n    if (!company?.id) return;\r\n\r\n    setIsSaving(true);\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"companies\")\r\n        .update({\r\n          name: companyName,\r\n          website: companyWebsite,\r\n        })\r\n        .eq(\"id\", company.id);\r\n\r\n      if (error) throw error;\r\n\r\n      toast.success(t('changes_saved'));\r\n    } catch (error: any) {\r\n      console.error(\"Error saving company:\", error);\r\n      toast.error(t('error_message'));\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleSaveBasic = async () => {\r\n    setIsSaving(true);\r\n    try {\r\n      localStorage.setItem('settings_country', country);\r\n      localStorage.setItem('settings_timezone', timezone);\r\n      localStorage.setItem('listing_preferred_currency', currency);\r\n      localStorage.setItem('listing_preferred_size_unit', sizeUnit);\r\n      await new Promise(resolve => setTimeout(resolve, 500));\r\n      toast.success(t('changes_saved'));\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleSaveNotifications = async () => {\r\n    setIsSaving(true);\r\n    try {\r\n      // Save notification preferences to database\r\n      await new Promise(resolve => setTimeout(resolve, 1000));\r\n      toast.success(t('changes_saved'));\r\n    } catch (error) {\r\n      toast.error(t('error_message'));\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleChangePassword = async () => {\r\n    if (!newPassword || !confirmPassword) {\r\n      toast.error(t('required_field'));\r\n      return;\r\n    }\r\n\r\n    if (newPassword !== confirmPassword) {\r\n      toast.error(t('invalid_input'));\r\n      return;\r\n    }\r\n\r\n    if (newPassword.length < 8) {\r\n      toast.error(t('invalid_input'));\r\n      return;\r\n    }\r\n\r\n    setIsSaving(true);\r\n    try {\r\n      const { error } = await supabase.auth.updateUser({\r\n        password: newPassword\r\n      });\r\n\r\n      if (error) throw error;\r\n\r\n      setCurrentPassword(\"\");\r\n      setNewPassword(\"\");\r\n      setConfirmPassword(\"\");\r\n      toast.success(t('changes_saved'));\r\n    } catch (error: any) {\r\n      console.error(\"Error changing password:\", error);\r\n      toast.error(t('error_message'));\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleCopyApiKey = () => {\r\n    navigator.clipboard.writeText(apiKey);\r\n    toast.success(t('success_message'));\r\n  };\r\n\r\n  const handleRegenerateApiKey = () => {\r\n    toast.success(t('success_message'));\r\n  };\r\n\r\n  const handleAvatarUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0];\r\n    if (!file) return;\r\n\r\n    if (file.size > 2 * 1024 * 1024) {\r\n      toast.error(\"Image must be less than 2MB\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const fileExt = file.name.split('.').pop();\r\n      const fileName = `${user?.id}-${Date.now()}.${fileExt}`;\r\n      const filePath = `avatars/${fileName}`;\r\n\r\n      const { error: uploadError } = await supabase.storage\r\n        .from('avatars')\r\n        .upload(filePath, file);\r\n\r\n      if (uploadError) throw uploadError;\r\n\r\n      const { data: { publicUrl } } = supabase.storage\r\n        .from('avatars')\r\n        .getPublicUrl(filePath);\r\n\r\n      const { error: updateError } = await supabase\r\n        .from('profiles')\r\n        .update({ avatar_url: publicUrl })\r\n        .eq('id', user?.id);\r\n\r\n      if (updateError) throw updateError;\r\n\r\n      setAvatarUrl(publicUrl);\r\n      await refreshProfile();\r\n      toast.success(t('success_message'));\r\n    } catch (error: any) {\r\n      console.error(\"Error uploading avatar:\", error);\r\n      toast.error(t('error_message'));\r\n    }\r\n  };\r\n\r\n  if (isLoading || companyLoading) {\r\n    return <SettingsPageSkeleton isMobile={isMobile} />;\r\n  }\r\n\r\n  return (\r\n    <motion.div\r\n      className=\"space-y-6\"\r\n      initial=\"initial\"\r\n      animate=\"animate\"\r\n      exit=\"exit\"\r\n      variants={pageVariants}\r\n      transition={pageTransition}\r\n    >\r\n      {/* Page Header */}\r\n      <div>\r\n        <h1 className=\"text-3xl font-bold text-foreground\">{t('settings')}</h1>\r\n        <p className=\"text-muted-foreground mt-1\">\r\n          {t('localization_desc')}\r\n        </p>\r\n      </div>\r\n\r\n      {/* Settings Tabs */}\r\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\r\n        <TabsList className=\"grid w-full grid-cols-2 lg:grid-cols-7 h-auto gap-2 bg-transparent p-0\">\r\n          <TabsTrigger\r\n            value=\"account\"\r\n            className=\"data-[state=active]:bg-gradient-to-r data-[state=active]:from-indigo-600 data-[state=active]:to-purple-600 data-[state=active]:text-white\"\r\n          >\r\n            <User className=\"h-4 w-4 mr-2\" />\r\n            <span className=\"hidden sm:inline\">{t('account')}</span>\r\n          </TabsTrigger>\r\n          <TabsTrigger\r\n            value=\"basic\"\r\n            className=\"data-[state=active]:bg-gradient-to-r data-[state=active]:from-indigo-600 data-[state=active]:to-purple-600 data-[state=active]:text-white\"\r\n          >\r\n            <Globe className=\"h-4 w-4 mr-2\" />\r\n            <span className=\"hidden sm:inline\">Basic</span>\r\n          </TabsTrigger>\r\n          <TabsTrigger\r\n            value=\"company\"\r\n            className=\"data-[state=active]:bg-gradient-to-r data-[state=active]:from-indigo-600 data-[state=active]:to-purple-600 data-[state=active]:text-white\"\r\n          >\r\n            <Building2 className=\"h-4 w-4 mr-2\" />\r\n            <span className=\"hidden sm:inline\">{t('company')}</span>\r\n          </TabsTrigger>\r\n          <TabsTrigger\r\n            value=\"notifications\"\r\n            className=\"data-[state=active]:bg-gradient-to-r data-[state=active]:from-indigo-600 data-[state=active]:to-purple-600 data-[state=active]:text-white\"\r\n          >\r\n            <Bell className=\"h-4 w-4 mr-2\" />\r\n            <span className=\"hidden sm:inline\">{t('notifications')}</span>\r\n          </TabsTrigger>\r\n          <TabsTrigger\r\n            value=\"appearance\"\r\n            className=\"data-[state=active]:bg-gradient-to-r data-[state=active]:from-indigo-600 data-[state=active]:to-purple-600 data-[state=active]:text-white\"\r\n          >\r\n            <Palette className=\"h-4 w-4 mr-2\" />\r\n            <span className=\"hidden sm:inline\">{t('appearance')}</span>\r\n          </TabsTrigger>\r\n          <TabsTrigger\r\n            value=\"security\"\r\n            className=\"data-[state=active]:bg-gradient-to-r data-[state=active]:from-indigo-600 data-[state=active]:to-purple-600 data-[state=active]:text-white\"\r\n          >\r\n            <Lock className=\"h-4 w-4 mr-2\" />\r\n            <span className=\"hidden sm:inline\">{t('security')}</span>\r\n          </TabsTrigger>\r\n          <TabsTrigger\r\n            value=\"api\"\r\n            className=\"data-[state=active]:bg-gradient-to-r data-[state=active]:from-indigo-600 data-[state=active]:to-purple-600 data-[state=active]:text-white\"\r\n          >\r\n            <Key className=\"h-4 w-4 mr-2\" />\r\n            <span className=\"hidden sm:inline\">API</span>\r\n          </TabsTrigger>\r\n        </TabsList>\r\n\r\n        {/* Account Tab */}\r\n        <TabsContent value=\"account\" className=\"space-y-6 mt-6\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>{t('personal_information')}</CardTitle>\r\n              <CardDescription>\r\n                {t('localization_desc')}\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-6\">\r\n              {/* Profile Picture */}\r\n              <div className=\"flex items-center gap-6\">\r\n                <Avatar className=\"h-24 w-24\">\r\n                  <AvatarImage src={avatarUrl} />\r\n                  <AvatarFallback className=\"text-2xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white\">\r\n                    {fullName?.charAt(0) || \"U\"}\r\n                  </AvatarFallback>\r\n                </Avatar>\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"avatar-upload\" className=\"cursor-pointer\">\r\n                    <div className=\"flex items-center gap-2 px-4 py-2 rounded-lg border border-input hover:bg-accent transition-colors\">\r\n                      <Camera className=\"h-4 w-4\" />\r\n                      <span className=\"text-sm font-medium\">Change Picture</span>\r\n                    </div>\r\n                    <input\r\n                      id=\"avatar-upload\"\r\n                      type=\"file\"\r\n                      accept=\"image/*\"\r\n                      className=\"hidden\"\r\n                      onChange={handleAvatarUpload}\r\n                    />\r\n                  </Label>\r\n                  <p className=\"text-xs text-muted-foreground\">\r\n                    JPG, PNG or GIF. Max 2MB.\r\n                  </p>\r\n                </div>\r\n              </div>\r\n\r\n              <Separator />\r\n\r\n              {/* Form Fields */}\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"fullName\">Full Name</Label>\r\n                  <Input\r\n                    id=\"fullName\"\r\n                    value={fullName}\r\n                    onChange={(e) => setFullName(e.target.value)}\r\n                    placeholder=\"Enter your full name\"\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"email\">Email Address</Label>\r\n                  <Input\r\n                    id=\"email\"\r\n                    type=\"email\"\r\n                    value={email}\r\n                    disabled\r\n                    className=\"bg-muted\"\r\n                  />\r\n                  <p className=\"text-xs text-muted-foreground\">\r\n                    Contact support to change your email\r\n                  </p>\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"phone\">Phone Number</Label>\r\n                  <Input\r\n                    id=\"phone\"\r\n                    type=\"tel\"\r\n                    value={phone}\r\n                    onChange={(e) => setPhone(e.target.value)}\r\n                    placeholder=\"+1 (555) 000-0000\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex justify-end pt-4\">\r\n                <Button\r\n                  onClick={handleSaveAccount}\r\n                  disabled={isSaving}\r\n                  className=\"bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700\"\r\n                >\r\n                  {isSaving ? (\r\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                  ) : (\r\n                    <Save className=\"h-4 w-4 mr-2\" />\r\n                  )}\r\n                  Save Changes\r\n                </Button>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        {/* Basic Settings Tab */}\r\n        <TabsContent value=\"basic\" className=\"space-y-6 mt-6\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Basic Settings</CardTitle>\r\n              <CardDescription>\r\n                Configure general application preferences\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-6\">\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                <div className=\"space-y-2\">\r\n                  <Label>Default Country</Label>\r\n                  <Select value={country} onValueChange={setCountry}>\r\n                    <SelectTrigger>\r\n                      <SelectValue />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      <SelectItem value=\"United Arab Emirates\">United Arab Emirates</SelectItem>\r\n                      <SelectItem value=\"Qatar\">Qatar</SelectItem>\r\n                      <SelectItem value=\"Saudi Arabia\">Saudi Arabia</SelectItem>\r\n                      <SelectItem value=\"United Kingdom\">United Kingdom</SelectItem>\r\n                      <SelectItem value=\"United States\">United States</SelectItem>\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label>Timezone</Label>\r\n                  <Select value={timezone} onValueChange={setTimezone}>\r\n                    <SelectTrigger>\r\n                      <SelectValue />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      <SelectItem value=\"Asia/Dubai\">Dubai (GST)</SelectItem>\r\n                      <SelectItem value=\"Asia/Qatar\">Qatar (AST)</SelectItem>\r\n                      <SelectItem value=\"Asia/Riyadh\">Riyadh (AST)</SelectItem>\r\n                      <SelectItem value=\"Europe/London\">London (GMT/BST)</SelectItem>\r\n                      <SelectItem value=\"America/New_York\">New York (EST/EDT)</SelectItem>\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label>Default Currency</Label>\r\n                  <Select value={currency} onValueChange={setCurrency}>\r\n                    <SelectTrigger>\r\n                      <SelectValue />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      <SelectItem value=\"AED\">AED - UAE Dirham</SelectItem>\r\n                      <SelectItem value=\"QAR\">QAR - Qatari Riyal</SelectItem>\r\n                      <SelectItem value=\"SAR\">SAR - Saudi Riyal</SelectItem>\r\n                      <SelectItem value=\"USD\">USD - US Dollar</SelectItem>\r\n                      <SelectItem value=\"GBP\">GBP - British Pound</SelectItem>\r\n                      <SelectItem value=\"EUR\">EUR - Euro</SelectItem>\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label>Size Unit</Label>\r\n                  <Select value={sizeUnit} onValueChange={setSizeUnit}>\r\n                    <SelectTrigger>\r\n                      <SelectValue />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      <SelectItem value=\"sqft\">Square Feet (sqft)</SelectItem>\r\n                      <SelectItem value=\"sqm\">Square Meters (sqm)</SelectItem>\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex justify-end pt-4\">\r\n                <Button\r\n                  onClick={handleSaveBasic}\r\n                  disabled={isSaving}\r\n                  className=\"bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700\"\r\n                >\r\n                  {isSaving ? (\r\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                  ) : (\r\n                    <Save className=\"h-4 w-4 mr-2\" />\r\n                  )}\r\n                  Save Changes\r\n                </Button>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        {/* Company Tab */}\r\n        <TabsContent value=\"company\" className=\"space-y-6 mt-6\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Company Details</CardTitle>\r\n              <CardDescription>\r\n                Manage your company information and branding\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-6\">\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                <div className=\"space-y-2 md:col-span-2\">\r\n                  <Label htmlFor=\"companyName\">Company Name</Label>\r\n                  <Input\r\n                    id=\"companyName\"\r\n                    value={companyName}\r\n                    onChange={(e) => setCompanyName(e.target.value)}\r\n                    placeholder=\"Enter company name\"\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-2 md:col-span-2\">\r\n                  <Label htmlFor=\"website\">Website</Label>\r\n                  <Input\r\n                    id=\"website\"\r\n                    type=\"url\"\r\n                    value={companyWebsite}\r\n                    onChange={(e) => setCompanyWebsite(e.target.value)}\r\n                    placeholder=\"https://example.com\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex justify-end pt-4\">\r\n                <Button\r\n                  onClick={handleSaveCompany}\r\n                  disabled={isSaving}\r\n                  className=\"bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700\"\r\n                >\r\n                  {isSaving ? (\r\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                  ) : (\r\n                    <Save className=\"h-4 w-4 mr-2\" />\r\n                  )}\r\n                  Save Changes\r\n                </Button>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        {/* Notifications Tab */}\r\n        <TabsContent value=\"notifications\" className=\"space-y-6 mt-6\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Notification Preferences</CardTitle>\r\n              <CardDescription>\r\n                Choose how you want to be notified about updates\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-6\">\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between p-4 rounded-lg border\">\r\n                  <div className=\"space-y-0.5\">\r\n                    <Label className=\"text-base font-medium\">Email Notifications</Label>\r\n                    <p className=\"text-sm text-muted-foreground\">\r\n                      Receive email updates about your account\r\n                    </p>\r\n                  </div>\r\n                  <Switch\r\n                    checked={emailNotifications}\r\n                    onCheckedChange={setEmailNotifications}\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"flex items-center justify-between p-4 rounded-lg border\">\r\n                  <div className=\"space-y-0.5\">\r\n                    <Label className=\"text-base font-medium\">Push Notifications</Label>\r\n                    <p className=\"text-sm text-muted-foreground\">\r\n                      Get push notifications in your browser\r\n                    </p>\r\n                  </div>\r\n                  <Switch\r\n                    checked={pushNotifications}\r\n                    onCheckedChange={setPushNotifications}\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"flex items-center justify-between p-4 rounded-lg border\">\r\n                  <div className=\"space-y-0.5\">\r\n                    <Label className=\"text-base font-medium\">New Lead Alerts</Label>\r\n                    <p className=\"text-sm text-muted-foreground\">\r\n                      Get notified when new leads are assigned to you\r\n                    </p>\r\n                  </div>\r\n                  <Switch\r\n                    checked={leadNotifications}\r\n                    onCheckedChange={setLeadNotifications}\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"flex items-center justify-between p-4 rounded-lg border\">\r\n                  <div className=\"space-y-0.5\">\r\n                    <Label className=\"text-base font-medium\">Weekly Reports</Label>\r\n                    <p className=\"text-sm text-muted-foreground\">\r\n                      Receive weekly performance summaries via email\r\n                    </p>\r\n                  </div>\r\n                  <Switch\r\n                    checked={weeklyReports}\r\n                    onCheckedChange={setWeeklyReports}\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex justify-end pt-4\">\r\n                <Button\r\n                  onClick={handleSaveNotifications}\r\n                  disabled={isSaving}\r\n                  className=\"bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700\"\r\n                >\r\n                  {isSaving ? (\r\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                  ) : (\r\n                    <Save className=\"h-4 w-4 mr-2\" />\r\n                  )}\r\n                  Save Preferences\r\n                </Button>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        {/* Appearance Tab */}\r\n        <TabsContent value=\"appearance\" className=\"space-y-6 mt-6\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Theme Preferences</CardTitle>\r\n              <CardDescription>\r\n                Customize how the application looks\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-6\">\r\n              <div className=\"space-y-4\">\r\n                <Label>Color Theme</Label>\r\n                <div className=\"grid grid-cols-3 gap-4\">\r\n                  <button\r\n                    onClick={() => setTheme(\"light\")}\r\n                    className={cn(\r\n                      \"flex flex-col items-center gap-2 p-4 rounded-lg border-2 transition-all\",\r\n                      theme === \"light\"\r\n                        ? \"border-indigo-600 bg-indigo-50\"\r\n                        : \"border-border hover:border-indigo-300\"\r\n                    )}\r\n                  >\r\n                    <div className=\"h-12 w-12 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center\">\r\n                      <div className=\"h-6 w-6 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600\" />\r\n                    </div>\r\n                    <span className=\"text-sm font-medium\">Light</span>\r\n                    {theme === \"light\" && (\r\n                      <Check className=\"h-4 w-4 text-indigo-600\" />\r\n                    )}\r\n                  </button>\r\n\r\n                  <button\r\n                    onClick={() => setTheme(\"dark\")}\r\n                    className={cn(\r\n                      \"flex flex-col items-center gap-2 p-4 rounded-lg border-2 transition-all\",\r\n                      theme === \"dark\"\r\n                        ? \"border-indigo-600 bg-indigo-50\"\r\n                        : \"border-border hover:border-indigo-300\"\r\n                    )}\r\n                  >\r\n                    <div className=\"h-12 w-12 rounded-full bg-gray-900 border-2 border-gray-700 flex items-center justify-center\">\r\n                      <div className=\"h-6 w-6 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600\" />\r\n                    </div>\r\n                    <span className=\"text-sm font-medium\">Dark</span>\r\n                    {theme === \"dark\" && (\r\n                      <Check className=\"h-4 w-4 text-indigo-600\" />\r\n                    )}\r\n                  </button>\r\n\r\n                  <button\r\n                    onClick={() => setTheme(\"system\")}\r\n                    className={cn(\r\n                      \"flex flex-col items-center gap-2 p-4 rounded-lg border-2 transition-all\",\r\n                      theme === \"system\"\r\n                        ? \"border-indigo-600 bg-indigo-50\"\r\n                        : \"border-border hover:border-indigo-300\"\r\n                    )}\r\n                  >\r\n                    <div className=\"h-12 w-12 rounded-full bg-gradient-to-r from-white to-gray-900 border-2 border-gray-400 flex items-center justify-center\">\r\n                      <div className=\"h-6 w-6 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600\" />\r\n                    </div>\r\n                    <span className=\"text-sm font-medium\">System</span>\r\n                    {theme === \"system\" && (\r\n                      <Check className=\"h-4 w-4 text-indigo-600\" />\r\n                    )}\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        {/* Security Tab */}\r\n        <TabsContent value=\"security\" className=\"space-y-6 mt-6\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Change Password</CardTitle>\r\n              <CardDescription>\r\n                Update your password to keep your account secure\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-6\">\r\n              <div className=\"space-y-4\">\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"currentPassword\">Current Password</Label>\r\n                  <div className=\"relative\">\r\n                    <Input\r\n                      id=\"currentPassword\"\r\n                      type={showCurrentPassword ? \"text\" : \"password\"}\r\n                      value={currentPassword}\r\n                      onChange={(e) => setCurrentPassword(e.target.value)}\r\n                      placeholder=\"Enter current password\"\r\n                    />\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => setShowCurrentPassword(!showCurrentPassword)}\r\n                      className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\r\n                    >\r\n                      {showCurrentPassword ? (\r\n                        <EyeOff className=\"h-4 w-4\" />\r\n                      ) : (\r\n                        <Eye className=\"h-4 w-4\" />\r\n                      )}\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"newPassword\">New Password</Label>\r\n                  <div className=\"relative\">\r\n                    <Input\r\n                      id=\"newPassword\"\r\n                      type={showNewPassword ? \"text\" : \"password\"}\r\n                      value={newPassword}\r\n                      onChange={(e) => setNewPassword(e.target.value)}\r\n                      placeholder=\"Enter new password\"\r\n                    />\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => setShowNewPassword(!showNewPassword)}\r\n                      className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\r\n                    >\r\n                      {showNewPassword ? (\r\n                        <EyeOff className=\"h-4 w-4\" />\r\n                      ) : (\r\n                        <Eye className=\"h-4 w-4\" />\r\n                      )}\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"confirmPassword\">Confirm New Password</Label>\r\n                  <div className=\"relative\">\r\n                    <Input\r\n                      id=\"confirmPassword\"\r\n                      type={showConfirmPassword ? \"text\" : \"password\"}\r\n                      value={confirmPassword}\r\n                      onChange={(e) => setConfirmPassword(e.target.value)}\r\n                      placeholder=\"Confirm new password\"\r\n                    />\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => setShowConfirmPassword(!showConfirmPassword)}\r\n                      className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\r\n                    >\r\n                      {showConfirmPassword ? (\r\n                        <EyeOff className=\"h-4 w-4\" />\r\n                      ) : (\r\n                        <Eye className=\"h-4 w-4\" />\r\n                      )}\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex justify-end pt-4\">\r\n                <Button\r\n                  onClick={handleChangePassword}\r\n                  disabled={isSaving}\r\n                  className=\"bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700\"\r\n                >\r\n                  {isSaving ? (\r\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                  ) : (\r\n                    <Lock className=\"h-4 w-4 mr-2\" />\r\n                  )}\r\n                  Update Password\r\n                </Button>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-destructive/50\">\r\n            <CardHeader>\r\n              <CardTitle className=\"text-destructive\">Danger Zone</CardTitle>\r\n              <CardDescription>\r\n                Irreversible actions that affect your account\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"flex items-center justify-between p-4 rounded-lg border border-destructive/50 bg-destructive/5\">\r\n                <div className=\"space-y-0.5\">\r\n                  <Label className=\"text-base font-medium\">Delete Account</Label>\r\n                  <p className=\"text-sm text-muted-foreground\">\r\n                    Permanently delete your account and all data\r\n                  </p>\r\n                </div>\r\n                <Button variant=\"destructive\" size=\"sm\">\r\n                  <Trash2 className=\"h-4 w-4 mr-2\" />{t('delete')}</Button>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        {/* API Tab */}\r\n        <TabsContent value=\"api\" className=\"space-y-6 mt-6\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>API Access</CardTitle>\r\n              <CardDescription>\r\n                Manage your API keys for integrations\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-6\">\r\n              <div className=\"space-y-4\">\r\n                <div className=\"space-y-2\">\r\n                  <Label>API Key</Label>\r\n                  <div className=\"flex gap-2\">\r\n                    <div className=\"relative flex-1\">\r\n                      <Input\r\n                        type={showApiKey ? \"text\" : \"password\"}\r\n                        value={apiKey}\r\n                        readOnly\r\n                        className=\"font-mono text-sm pr-10\"\r\n                      />\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => setShowApiKey(!showApiKey)}\r\n                        className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\r\n                      >\r\n                        {showApiKey ? (\r\n                          <EyeOff className=\"h-4 w-4\" />\r\n                        ) : (\r\n                          <Eye className=\"h-4 w-4\" />\r\n                        )}\r\n                      </button>\r\n                    </div>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      size=\"icon\"\r\n                      onClick={handleCopyApiKey}\r\n                    >\r\n                      <Copy className=\"h-4 w-4\" />\r\n                    </Button>\r\n                  </div>\r\n                  <p className=\"text-xs text-muted-foreground\">\r\n                    Keep your API key secure. Do not share it publicly.\r\n                  </p>\r\n                </div>\r\n\r\n                <div className=\"flex items-center justify-between p-4 rounded-lg border border-amber-500/50 bg-amber-500/5\">\r\n                  <div className=\"space-y-0.5\">\r\n                    <Label className=\"text-base font-medium\">Regenerate API Key</Label>\r\n                    <p className=\"text-sm text-muted-foreground\">\r\n                      Generate a new API key. Old key will be invalidated.\r\n                    </p>\r\n                  </div>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={handleRegenerateApiKey}\r\n                  >\r\n                    <RefreshCw className=\"h-4 w-4 mr-2\" />\r\n                    Regenerate\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n\r\n              <Separator />\r\n\r\n              <div className=\"space-y-2\">\r\n                <Label>API Documentation</Label>\r\n                <p className=\"text-sm text-muted-foreground\">\r\n                  Learn how to integrate with our API\r\n                </p>\r\n                <Button variant=\"outline\" className=\"mt-2\">\r\n                  <Globe className=\"h-4 w-4 mr-2\" />\r\n                  View Documentation\r\n                </Button>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n      </Tabs>\r\n    </motion.div>\r\n  );\r\n};\r\n\r\nexport default SettingsPage;","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\TeamsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":85,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3220,3223],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3220,3223],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":108,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":108,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4106,4109],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4106,4109],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchData'. Either include it or remove the dependency array.","line":122,"column":6,"nodeType":"ArrayExpression","endLine":122,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchData]","fix":{"range":[4413,4415],"text":"[fetchData]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":281,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":281,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10070,10073],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10070,10073],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":303,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":303,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10737,10740],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10737,10740],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":339,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":339,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12207,12210],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12207,12210],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":380,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":380,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13560,13563],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13560,13563],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { motion } from 'framer-motion';\r\nimport { DndContext, DragEndEvent, DragOverlay, DragStartEvent, PointerSensor, useSensor, useSensors } from '@dnd-kit/core';\r\nimport { Plus, Users } from 'lucide-react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { Team, Agent, UserStatus } from '@/components/teams/types';\r\nimport { DroppableTeamCard } from '@/components/teams/DroppableTeamCard';\r\nimport { DragOverlayCard } from '@/components/teams/DragOverlayCard';\r\nimport { TeamFilters, TeamFiltersState } from '@/components/teams/TeamFilters';\r\nimport { CreateTeamDialog } from '@/components/teams/CreateTeamDialog';\r\nimport { CreateAgentDialog } from '@/components/teams/CreateAgentDialog';\r\nimport { TeamsPageSkeleton } from '@/components/ui/page-skeletons';\r\nimport { useIsMobile } from '@/hooks/use-mobile';\r\nimport { TeamsFAB } from '@/components/teams/TeamsFAB';\r\nimport { useLocalization } from \"@/contexts/LocalizationContext\";\r\nimport { supabase } from '@/integrations/supabase/client';\r\n\r\nconst pageVariants = {\r\n  initial: { opacity: 0, y: 20 },\r\n  animate: { opacity: 1, y: 0 },\r\n  exit: { opacity: 0, y: -10 }\r\n};\r\n\r\nconst pageTransition = {\r\n  type: \"tween\" as const,\r\n  ease: \"easeOut\" as const,\r\n  duration: 0.3\r\n};\r\n\r\nexport default function TeamsPage() {\r\n  const { t } = useLocalization();\r\n\r\n  const { toast } = useToast();\r\n  const isMobile = useIsMobile();\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [teams, setTeams] = useState<Team[]>([]);\r\n  const [agents, setAgents] = useState<Agent[]>([]);\r\n  const [createTeamOpen, setCreateTeamOpen] = useState(false);\r\n  const [createAgentOpen, setCreateAgentOpen] = useState(false);\r\n  const [editingTeam, setEditingTeam] = useState<Team | null>(null);\r\n  const [editingAgent, setEditingAgent] = useState<Agent | null>(null);\r\n  const [activeAgent, setActiveAgent] = useState<Agent | null>(null);\r\n\r\n  const [filters, setFilters] = useState<TeamFiltersState>({\r\n    search: '',\r\n    role: 'all',\r\n    team: 'all',\r\n    status: 'all',\r\n  });\r\n\r\n  // Selection state for bulk actions\r\n  const [selectedAgentIds, setSelectedAgentIds] = useState<Set<string>>(new Set());\r\n  const selectionMode = selectedAgentIds.size > 0;\r\n\r\n  const fetchData = async () => {\r\n    try {\r\n      setIsLoading(true);\r\n      // Fetch teams\r\n      const { data: teamsData, error: teamsError } = await supabase\r\n        .from('teams')\r\n        .select('*')\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (teamsError) throw teamsError;\r\n\r\n      // Fetch agents\r\n      const { data: agentsData, error: agentsError } = await supabase\r\n        .from('agents')\r\n        .select('*')\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (agentsError) throw agentsError;\r\n\r\n      // Map agents to match interface\r\n      const mappedAgents: Agent[] = agentsData.map(a => ({\r\n        id: a.id,\r\n        name: a.name,\r\n        email: a.email,\r\n        phone: a.phone || '',\r\n        avatar: a.avatar_url,\r\n        role: a.role,\r\n        status: a.status,\r\n        teamId: a.team_id || undefined,\r\n        permissions: (a.permissions as any) || { leads: true, listings: true, marketing: false, reports: false, integrations: false },\r\n        createdAt: new Date(a.created_at),\r\n        // These would normally be calculated from other tables\r\n        assignedLeads: 0,\r\n        assignedListings: 0,\r\n        performance: { leadsConverted: 0, revenue: 0, listingsPublished: 0 }\r\n      }));\r\n\r\n      // Map teams and attach agents\r\n      const mappedTeams: Team[] = teamsData.map(t => ({\r\n        id: t.id,\r\n        name: t.name,\r\n        leaderId: t.leader_id || undefined,\r\n        status: t.status as 'active' | 'inactive',\r\n        createdAt: new Date(t.created_at),\r\n        agents: mappedAgents.filter(a => a.teamId === t.id),\r\n        // These would be calculated\r\n        assignedLeads: 0,\r\n        assignedListings: 0,\r\n      }));\r\n\r\n      setAgents(mappedAgents);\r\n      setTeams(mappedTeams);\r\n    } catch (error: any) {\r\n      console.error('Error fetching data:', error);\r\n      toast({\r\n        title: 'Error',\r\n        description: 'Failed to load teams and agents.',\r\n        variant: 'destructive',\r\n      });\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchData();\r\n  }, []);\r\n\r\n  // DnD sensors\r\n  const sensors = useSensors(\r\n    useSensor(PointerSensor, {\r\n      activationConstraint: {\r\n        distance: 8,\r\n      },\r\n    })\r\n  );\r\n\r\n  const handleDragStart = (event: DragStartEvent) => {\r\n    const { active } = event;\r\n    const draggedAgent = agents.find(a => a.id === active.id);\r\n    if (draggedAgent) {\r\n      setActiveAgent(draggedAgent);\r\n    }\r\n  };\r\n\r\n  const handleDragEnd = async (event: DragEndEvent) => {\r\n    const { active, over } = event;\r\n    setActiveAgent(null);\r\n\r\n    if (!over) return;\r\n\r\n    const draggedAgentId = active.id as string;\r\n    const droppedOnId = over.id as string;\r\n\r\n    // Extract team id from droppable id (format: \"team-{id}\")\r\n    if (!droppedOnId.startsWith('team-')) return;\r\n    const targetTeamId = droppedOnId.replace('team-', '');\r\n\r\n    const draggedAgent = agents.find(a => a.id === draggedAgentId);\r\n    if (!draggedAgent || draggedAgent.teamId === targetTeamId) return;\r\n\r\n    const sourceTeam = teams.find(t => t.id === draggedAgent.teamId);\r\n    const targetTeam = teams.find(t => t.id === targetTeamId);\r\n\r\n    // Optimistic update\r\n    const updatedAgent = { ...draggedAgent, teamId: targetTeamId };\r\n    const updatedAgents = agents.map(a => a.id === draggedAgentId ? updatedAgent : a);\r\n    setAgents(updatedAgents);\r\n\r\n    const updatedTeams = teams.map(t => ({\r\n      ...t,\r\n      agents: updatedAgents.filter(a => a.teamId === t.id)\r\n    }));\r\n    setTeams(updatedTeams);\r\n\r\n    // DB Update\r\n    try {\r\n      const { error } = await supabase\r\n        .from('agents')\r\n        .update({ team_id: targetTeamId })\r\n        .eq('id', draggedAgentId);\r\n\r\n      if (error) throw error;\r\n\r\n      toast({\r\n        title: 'Agent Moved',\r\n        description: `${draggedAgent.name} moved ${sourceTeam ? `from ${sourceTeam.name}` : ''} to ${targetTeam?.name}.`,\r\n      });\r\n    } catch (error) {\r\n      // Revert on error (could be improved)\r\n      toast({ title: 'Error', description: 'Failed to update agent team.', variant: 'destructive' });\r\n      fetchData();\r\n    }\r\n  };\r\n\r\n  // Filter teams based on filters (kept same logic as checks active state)\r\n  const filteredTeams = teams.filter(team => {\r\n    if (filters.search) {\r\n      const searchLower = filters.search.toLowerCase();\r\n      const matchesTeam = team.name.toLowerCase().includes(searchLower);\r\n      const matchesAgent = team.agents.some(a =>\r\n        a.name.toLowerCase().includes(searchLower) ||\r\n        a.email.toLowerCase().includes(searchLower)\r\n      );\r\n      if (!matchesTeam && !matchesAgent) return false;\r\n    }\r\n    if (filters.team !== 'all' && team.id !== filters.team) return false;\r\n    return true;\r\n  }).map(team => ({\r\n    ...team,\r\n    agents: team.agents.filter(agent => {\r\n      if (filters.role !== 'all' && agent.role !== filters.role) return false;\r\n      if (filters.status !== 'all' && agent.status !== filters.status) return false;\r\n      return true;\r\n    })\r\n  }));\r\n\r\n  // Team handlers\r\n  const handleSaveTeam = async (teamData: Partial<Team>) => {\r\n    try {\r\n      let teamId: string | undefined;\r\n\r\n      if (editingTeam) {\r\n        teamId = editingTeam.id;\r\n        const { error } = await supabase\r\n          .from('teams')\r\n          .update({\r\n            name: teamData.name,\r\n            leader_id: teamData.leaderId || null,\r\n            status: teamData.status\r\n          })\r\n          .eq('id', editingTeam.id);\r\n\r\n        if (error) throw error;\r\n        toast({ title: 'Team Updated', description: `\"${teamData.name}\" has been updated.` });\r\n      } else {\r\n        const { data, error } = await supabase\r\n          .from('teams')\r\n          .insert({\r\n            name: teamData.name || 'New Team',\r\n            leader_id: teamData.leaderId || null,\r\n            status: teamData.status || 'active'\r\n          })\r\n          .select('id')\r\n          .single();\r\n\r\n        if (error) throw error;\r\n        teamId = data.id;\r\n        toast({ title: 'Team Created', description: `\"${teamData.name || 'New Team'}\" has been created.` });\r\n      }\r\n\r\n      // Update agents' team assignments\r\n      if (teamId && teamData.agents) {\r\n        const selectedAgentIds = teamData.agents.map(a => a.id);\r\n\r\n        // 1. Assign selected agents to this team\r\n        if (selectedAgentIds.length > 0) {\r\n          const { error: assignError } = await supabase\r\n            .from('agents')\r\n            .update({ team_id: teamId })\r\n            .in('id', selectedAgentIds);\r\n\r\n          if (assignError) throw assignError;\r\n        }\r\n\r\n        // 2. Unassign agents that were removed (only if editing)\r\n        // If we are creating, there are no existing agents to remove.\r\n        // If editing, we assume teamData.agents represents the FULL desired state.\r\n        // However, ensuring we don't accidentally unassign agents from OTHER teams if the UI logic is partial logic?\r\n        // The UI dialog returns \"agents: availableAgents.filter(a => selectedAgents.includes(a.id))\".\r\n        // So it returns the comprehensive list of members for this team.\r\n\r\n        // We need to unassign agents who currently have this team_id but are NOT in selectedAgentIds\r\n        const { error: unassignError } = await supabase\r\n          .from('agents')\r\n          .update({ team_id: null })\r\n          .eq('team_id', teamId)\r\n          .not('id', 'in', `(${selectedAgentIds.length > 0 ? selectedAgentIds.join(',') : '00000000-0000-0000-0000-000000000000'})`);\r\n        // Using a dummy UUID for empty list to keep query valid\r\n\r\n        if (unassignError) throw unassignError;\r\n      }\r\n\r\n      fetchData(); // Refresh data\r\n      setEditingTeam(null);\r\n    } catch (error: any) {\r\n      console.error(\"Error saving team:\", error);\r\n      toast({ title: 'Error', description: error.message, variant: 'destructive' });\r\n    }\r\n  };\r\n\r\n  const handleEditTeam = (team: Team) => {\r\n    setEditingTeam(team);\r\n    setCreateTeamOpen(true);\r\n  };\r\n\r\n  const handleDeleteTeam = async (team: Team) => {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('teams')\r\n        .delete()\r\n        .eq('id', team.id);\r\n\r\n      if (error) throw error;\r\n\r\n      setTeams(teams.filter(t => t.id !== team.id));\r\n      toast({ title: 'Team Deleted', description: `\"${team.name}\" has been deleted.`, variant: 'destructive' });\r\n    } catch (error: any) {\r\n      toast({ title: 'Error', description: error.message, variant: 'destructive' });\r\n    }\r\n  };\r\n\r\n  // Agent handlers\r\n  const handleSaveAgent = (agentData: Partial<Agent>) => {\r\n    // With CreateAgentDialog doing the saving/inviting, we just need to refresh.\r\n    // However, if we edit here, we might need to handle updates if the dialog doesn't fully handle it?\r\n    // Looking at CreateAgentDialog, it calls 'invite-agent' for new, and 'onSave' is called.\r\n    // If editing, CreateAgentDialog calls onSave but doesn't db update?\r\n    // CreateAgentDialog content:\r\n    // if (agent) { onSave({ ... }); onOpenChange(false); }\r\n    // It seems CreateAgentDialog assumes parent handles save for edits?\r\n\r\n    // Let's implement edit logic here.\r\n    if (editingAgent) {\r\n      const updateAgent = async () => {\r\n        try {\r\n          // Prepare Permissions JSON\r\n          // Map permissions object to json\r\n\r\n          const { error } = await supabase\r\n            .from('agents')\r\n            .update({\r\n              name: agentData.name,\r\n              phone: agentData.phone,\r\n              role: agentData.role,\r\n              team_id: agentData.teamId,\r\n              permissions: agentData.permissions\r\n            })\r\n            .eq('id', editingAgent.id);\r\n\r\n          if (error) throw error;\r\n          toast({ title: 'Agent Updated', description: `\"${agentData.name}\" has been updated.` });\r\n          fetchData();\r\n        } catch (error: any) {\r\n          toast({ title: 'Error', description: error.message, variant: 'destructive' });\r\n        }\r\n      };\r\n      updateAgent();\r\n    } else {\r\n      // New agent comes from invite-agent function, which already inserted it.\r\n      // We just need to refresh.\r\n      fetchData();\r\n      toast({ title: 'Agent Created', description: `Agent has been invited.` });\r\n    }\r\n    setEditingAgent(null);\r\n  };\r\n\r\n  const handleEditAgent = (agent: Agent) => {\r\n    setEditingAgent(agent);\r\n    setCreateAgentOpen(true);\r\n  };\r\n\r\n  const handleToggleAgentStatus = async (agent: Agent) => {\r\n    const newStatus = agent.status === 'active' ? 'inactive' : 'active';\r\n    try {\r\n      const { error } = await supabase\r\n        .from('agents')\r\n        .update({ status: newStatus })\r\n        .eq('id', agent.id);\r\n\r\n      if (error) throw error;\r\n\r\n      // Optimistic update\r\n      const updatedAgent = { ...agent, status: newStatus as Agent['status'] };\r\n      setAgents(agents.map(a => a.id === agent.id ? updatedAgent : a));\r\n      setTeams(teams.map(t => ({\r\n        ...t,\r\n        agents: t.agents.map(a => a.id === agent.id ? updatedAgent : a)\r\n      })));\r\n\r\n      toast({\r\n        title: `Agent ${newStatus === 'active' ? 'Activated' : 'Deactivated'}`,\r\n        description: `\"${agent.name}\" is now ${newStatus}.`\r\n      });\r\n    } catch (error: any) {\r\n      toast({ title: 'Error', description: error.message, variant: 'destructive' });\r\n    }\r\n  };\r\n\r\n  // Selection handlers\r\n  const handleSelectAgent = (agent: Agent, selected: boolean) => {\r\n    setSelectedAgentIds(prev => {\r\n      const newSet = new Set(prev);\r\n      if (selected) {\r\n        newSet.add(agent.id);\r\n      } else {\r\n        newSet.delete(agent.id);\r\n      }\r\n      return newSet;\r\n    });\r\n  };\r\n\r\n  const clearSelection = () => {\r\n    setSelectedAgentIds(new Set());\r\n  };\r\n\r\n  // Bulk action handlers\r\n  const handleBulkAssignTeam = (teamId: string) => {\r\n    const selectedAgents = agents.filter(a => selectedAgentIds.has(a.id));\r\n    const newTeamId = teamId === 'unassign' ? undefined : teamId;\r\n\r\n    // Update agents\r\n    const updatedAgents = agents.map(a =>\r\n      selectedAgentIds.has(a.id) ? { ...a, teamId: newTeamId } : a\r\n    );\r\n    setAgents(updatedAgents);\r\n\r\n    // Update teams\r\n    const updatedTeams = teams.map(t => ({\r\n      ...t,\r\n      agents: updatedAgents.filter(a => a.teamId === t.id)\r\n    }));\r\n    setTeams(updatedTeams);\r\n\r\n    const targetTeam = teams.find(t => t.id === teamId);\r\n    toast({\r\n      title: 'Agents Reassigned',\r\n      description: teamId === 'unassign'\r\n        ? `${selectedAgents.length} agent(s) removed from teams.`\r\n        : `${selectedAgents.length} agent(s) assigned to ${targetTeam?.name}.`,\r\n    });\r\n    clearSelection();\r\n  };\r\n\r\n  const handleBulkChangeStatus = (status: UserStatus) => {\r\n    const selectedAgents = agents.filter(a => selectedAgentIds.has(a.id));\r\n\r\n    // Update agents\r\n    const updatedAgents = agents.map(a =>\r\n      selectedAgentIds.has(a.id) ? { ...a, status } : a\r\n    );\r\n    setAgents(updatedAgents);\r\n\r\n    // Update teams\r\n    setTeams(teams.map(t => ({\r\n      ...t,\r\n      agents: t.agents.map(a => selectedAgentIds.has(a.id) ? { ...a, status } : a)\r\n    })));\r\n\r\n    toast({\r\n      title: 'Status Updated',\r\n      description: `${selectedAgents.length} agent(s) set to ${status.replace('_', ' ')}.`,\r\n    });\r\n    clearSelection();\r\n  };\r\n\r\n  const handleBulkExport = () => {\r\n    const selectedAgents = agents.filter(a => selectedAgentIds.has(a.id));\r\n\r\n    // Generate CSV content\r\n    const headers = ['Name', 'Email', 'Phone', 'Role', 'Status', 'Team', 'Leads', 'Listings', 'Converted'];\r\n    const rows = selectedAgents.map(a => {\r\n      const team = teams.find(t => t.id === a.teamId);\r\n      return [\r\n        a.name,\r\n        a.email,\r\n        a.phone,\r\n        a.role,\r\n        a.status,\r\n        team?.name || 'Unassigned',\r\n        a.assignedLeads,\r\n        a.assignedListings,\r\n        a.performance.leadsConverted,\r\n      ].join(',');\r\n    });\r\n\r\n    const csv = [headers.join(','), ...rows].join('\\n');\r\n    const blob = new Blob([csv], { type: 'text/csv' });\r\n    const url = URL.createObjectURL(blob);\r\n    const link = document.createElement('a');\r\n    link.href = url;\r\n    link.download = `agents-export-${new Date().toISOString().split('T')[0]}.csv`;\r\n    link.click();\r\n    URL.revokeObjectURL(url);\r\n\r\n    toast({\r\n      title: 'Export Complete',\r\n      description: `${selectedAgents.length} agent(s) exported to CSV.`,\r\n    });\r\n  };\r\n\r\n\r\n  if (isLoading) {\r\n    return <TeamsPageSkeleton isMobile={isMobile} />;\r\n  }\r\n\r\n  return (\r\n    <motion.div\r\n      className=\"space-y-4\"\r\n      initial=\"initial\"\r\n      animate=\"animate\"\r\n      exit=\"exit\"\r\n      variants={pageVariants}\r\n      transition={pageTransition}\r\n    >\r\n      {/* Page Header */}\r\n      <div className=\"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4\">\r\n        <div>\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center\">\r\n              <Users className=\"h-5 w-5 text-primary\" />\r\n            </div>\r\n            <div>\r\n              <h1 className=\"text-2xl font-bold text-foreground\">Teams & Agents</h1>\r\n              <p className=\"text-muted-foreground\">\r\n                Manage teams, agents, and roles in one place\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div className=\"flex flex-wrap gap-3\">\r\n          <Button onClick={() => {\r\n            setEditingAgent(null);\r\n            setCreateAgentOpen(true);\r\n          }}>\r\n            <Plus className=\"h-4 w-4 mr-2\" />\r\n            Add Agent\r\n          </Button>\r\n          <Button variant=\"outline\" onClick={() => {\r\n            setEditingTeam(null);\r\n            setCreateTeamOpen(true);\r\n          }}>\r\n            <Plus className=\"h-4 w-4 mr-2\" />\r\n            Create Team\r\n          </Button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Teams List */}\r\n      <DndContext sensors={sensors} onDragStart={handleDragStart} onDragEnd={handleDragEnd}>\r\n        <div className=\"space-y-3\">\r\n          {/* Filters */}\r\n          <div className=\"bg-card rounded-xl border border-border p-3\">\r\n            <TeamFilters filters={filters} onFiltersChange={setFilters} />\r\n          </div>\r\n\r\n          {/* Teams List */}\r\n          <div className=\"space-y-3\">\r\n            {filteredTeams.map((team) => (\r\n              <DroppableTeamCard\r\n                key={team.id}\r\n                team={team}\r\n                onEdit={handleEditTeam}\r\n                onAddAgent={() => {\r\n                  setEditingAgent(null);\r\n                  setCreateAgentOpen(true);\r\n                }}\r\n                onRemoveAgent={() => { }}\r\n                onAssignLeader={handleEditTeam}\r\n                onDelete={handleDeleteTeam}\r\n                onViewAgent={() => { }}\r\n                onEditAgent={handleEditAgent}\r\n                onReassignAgent={() => { }}\r\n                onToggleAgentStatus={handleToggleAgentStatus}\r\n                isAdmin={true}\r\n                selectedAgentIds={selectedAgentIds}\r\n                onSelectAgent={handleSelectAgent}\r\n                selectionMode={selectionMode}\r\n              />\r\n            ))}\r\n\r\n            {filteredTeams.length === 0 && (\r\n              <div className=\"text-center py-12 bg-card rounded-xl border border-border\">\r\n                <Users className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\r\n                <h3 className=\"font-semibold text-foreground mb-2\">No teams found</h3>\r\n                <p className=\"text-muted-foreground text-sm mb-4\">\r\n                  Create your first team to get started\r\n                </p>\r\n                <Button onClick={() => setCreateTeamOpen(true)}>\r\n                  <Plus className=\"h-4 w-4 mr-2\" />\r\n                  Create Team\r\n                </Button>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n        <DragOverlay>\r\n          {activeAgent ? <DragOverlayCard agent={activeAgent} /> : null}\r\n        </DragOverlay>\r\n      </DndContext>\r\n\r\n      {/* Dialogs */}\r\n      <CreateTeamDialog\r\n        open={createTeamOpen}\r\n        onOpenChange={(open) => {\r\n          setCreateTeamOpen(open);\r\n          if (!open) setEditingTeam(null);\r\n        }}\r\n        team={editingTeam}\r\n        availableAgents={agents}\r\n        onSave={handleSaveTeam}\r\n      />\r\n\r\n      <CreateAgentDialog\r\n        open={createAgentOpen}\r\n        onOpenChange={(open) => {\r\n          setCreateAgentOpen(open);\r\n          if (!open) setEditingAgent(null);\r\n        }}\r\n        agent={editingAgent}\r\n        teams={teams}\r\n        onSave={handleSaveAgent}\r\n      />\r\n\r\n      {/* Mobile FAB */}\r\n      <TeamsFAB\r\n        onAddAgent={() => {\r\n          setEditingAgent(null);\r\n          setCreateAgentOpen(true);\r\n        }}\r\n        onCreateTeam={() => {\r\n          setEditingTeam(null);\r\n          setCreateTeamOpen(true);\r\n        }}\r\n      />\r\n    </motion.div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\WhatsAppChatbotPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\pages\\examples\\EnhancedLeadDetailExample.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\src\\vite-env.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\campaign-analytics\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":52,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1899,1902],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1899,1902],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":79,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2826,2829],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2826,2829],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":115,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":115,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4049,4052],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4049,4052],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":137,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":137,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4847,4850],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4847,4850],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":154,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":154,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5533,5536],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5533,5536],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":165,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":165,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6033,6036],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6033,6036],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":171,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":171,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6310,6313],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6310,6313],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":203,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":203,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7658,7661],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7658,7661],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":223,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":223,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8442,8445],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8442,8445],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":239,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":239,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8794,8797],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8794,8797],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":239,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":239,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8817,8820],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8817,8820],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":251,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":251,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9155,9158],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9155,9158],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":262,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":262,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9604,9607],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9604,9607],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":283,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":283,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10272,10275],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10272,10275],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":14,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';\r\n\r\nconst corsHeaders = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',\r\n};\r\n\r\n/**\r\n * Campaign Analytics & Reporting\r\n * Provides real-time analytics, exports, and insights\r\n */\r\nDeno.serve(async (req) => {\r\n  if (req.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;\r\n    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;\r\n    const supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n    const { action, campaign_id, company_id, date_from, date_to } = await req.json();\r\n\r\n    switch (action) {\r\n      case 'campaign_stats':\r\n        return await getCampaignStats(supabase, campaign_id);\r\n      case 'company_overview':\r\n        return await getCompanyOverview(supabase, company_id, date_from, date_to);\r\n      case 'channel_breakdown':\r\n        return await getChannelBreakdown(supabase, company_id, date_from, date_to);\r\n      case 'export_recipients':\r\n        return await exportRecipients(supabase, campaign_id);\r\n      case 'delivery_timeline':\r\n        return await getDeliveryTimeline(supabase, campaign_id);\r\n      case 'audit_log':\r\n        return await getAuditLog(supabase, campaign_id);\r\n      default:\r\n        return new Response(JSON.stringify({ error: 'Invalid action' }), {\r\n          status: 400,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n  } catch (error) {\r\n    console.error('Analytics error:', error);\r\n    return new Response(JSON.stringify({ error: 'Analytics failed' }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n});\r\n\r\nasync function getCampaignStats(supabase: any, campaignId: string) {\r\n  // Get campaign with analytics\r\n  const { data: campaign, error: campaignError } = await supabase\r\n    .from('campaigns')\r\n    .select(`\r\n      id, name, channel, status, \r\n      sent_count, delivered_count, opened_count, clicked_count, failed_count, bounced_count,\r\n      total_recipients, started_at, completed_at, scheduled_at,\r\n      campaign_analytics (*)\r\n    `)\r\n    .eq('id', campaignId)\r\n    .single();\r\n\r\n  if (campaignError) {\r\n    return new Response(JSON.stringify({ error: 'Campaign not found' }), {\r\n      status: 404,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  // Get recipient status breakdown\r\n  const { data: statusBreakdown } = await supabase\r\n    .from('campaign_recipients')\r\n    .select('delivery_status')\r\n    .eq('campaign_id', campaignId);\r\n\r\n  const breakdown: Record<string, number> = {};\r\n  statusBreakdown?.forEach((r: any) => {\r\n    breakdown[r.delivery_status] = (breakdown[r.delivery_status] || 0) + 1;\r\n  });\r\n\r\n  // Calculate rates\r\n  const total = campaign.total_recipients || 0;\r\n  const delivered = campaign.delivered_count || 0;\r\n  const opened = campaign.opened_count || 0;\r\n  const clicked = campaign.clicked_count || 0;\r\n  const failed = campaign.failed_count || 0;\r\n\r\n  const stats = {\r\n    campaign,\r\n    breakdown,\r\n    rates: {\r\n      delivery_rate: total > 0 ? ((delivered / total) * 100).toFixed(2) : 0,\r\n      open_rate: delivered > 0 ? ((opened / delivered) * 100).toFixed(2) : 0,\r\n      click_rate: opened > 0 ? ((clicked / opened) * 100).toFixed(2) : 0,\r\n      failure_rate: total > 0 ? ((failed / total) * 100).toFixed(2) : 0,\r\n    },\r\n    summary: {\r\n      total_recipients: total,\r\n      queued: breakdown['queued'] || 0,\r\n      sending: breakdown['sending'] || 0,\r\n      sent: breakdown['sent'] || 0,\r\n      delivered: breakdown['delivered'] || 0,\r\n      read: breakdown['read'] || 0,\r\n      failed: breakdown['failed'] || 0,\r\n    }\r\n  };\r\n\r\n  return new Response(JSON.stringify(stats), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\nasync function getCompanyOverview(supabase: any, companyId: string, dateFrom?: string, dateTo?: string) {\r\n  const from = dateFrom || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();\r\n  const to = dateTo || new Date().toISOString();\r\n\r\n  // Get campaign counts by status\r\n  const { data: campaigns } = await supabase\r\n    .from('campaigns')\r\n    .select('id, status, channel, sent_count, delivered_count, failed_count')\r\n    .eq('company_id', companyId)\r\n    .gte('created_at', from)\r\n    .lte('created_at', to);\r\n\r\n  const overview = {\r\n    total_campaigns: campaigns?.length || 0,\r\n    campaigns_by_status: {} as Record<string, number>,\r\n    campaigns_by_channel: {} as Record<string, number>,\r\n    total_sent: 0,\r\n    total_delivered: 0,\r\n    total_failed: 0,\r\n    overall_delivery_rate: 0,\r\n  };\r\n\r\n  campaigns?.forEach((c: any) => {\r\n    overview.campaigns_by_status[c.status] = (overview.campaigns_by_status[c.status] || 0) + 1;\r\n    overview.campaigns_by_channel[c.channel] = (overview.campaigns_by_channel[c.channel] || 0) + 1;\r\n    overview.total_sent += c.sent_count || 0;\r\n    overview.total_delivered += c.delivered_count || 0;\r\n    overview.total_failed += c.failed_count || 0;\r\n  });\r\n\r\n  if (overview.total_sent > 0) {\r\n    overview.overall_delivery_rate = (overview.total_delivered / overview.total_sent) * 100;\r\n  }\r\n\r\n  return new Response(JSON.stringify(overview), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\nasync function getChannelBreakdown(supabase: any, companyId: string, dateFrom?: string, dateTo?: string) {\r\n  const from = dateFrom || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();\r\n  const to = dateTo || new Date().toISOString();\r\n\r\n  const { data: campaigns } = await supabase\r\n    .from('campaigns')\r\n    .select('channel, sent_count, delivered_count, opened_count, clicked_count, failed_count')\r\n    .eq('company_id', companyId)\r\n    .gte('created_at', from)\r\n    .lte('created_at', to);\r\n\r\n  const channels: Record<string, any> = {\r\n    whatsapp: { sent: 0, delivered: 0, read: 0, failed: 0, campaigns: 0 },\r\n    sms: { sent: 0, delivered: 0, read: 0, failed: 0, campaigns: 0 },\r\n    email: { sent: 0, delivered: 0, opened: 0, clicked: 0, failed: 0, campaigns: 0 },\r\n  };\r\n\r\n  campaigns?.forEach((c: any) => {\r\n    if (channels[c.channel]) {\r\n      channels[c.channel].campaigns++;\r\n      channels[c.channel].sent += c.sent_count || 0;\r\n      channels[c.channel].delivered += c.delivered_count || 0;\r\n      channels[c.channel].failed += c.failed_count || 0;\r\n      if (c.channel === 'whatsapp') {\r\n        channels[c.channel].read += c.opened_count || 0;\r\n      } else if (c.channel === 'email') {\r\n        channels[c.channel].opened += c.opened_count || 0;\r\n        channels[c.channel].clicked += c.clicked_count || 0;\r\n      }\r\n    }\r\n  });\r\n\r\n  // Calculate rates per channel\r\n  Object.keys(channels).forEach(ch => {\r\n    const channel = channels[ch];\r\n    channel.delivery_rate = channel.sent > 0 ? ((channel.delivered / channel.sent) * 100).toFixed(2) : 0;\r\n    if (ch === 'email') {\r\n      channel.open_rate = channel.delivered > 0 ? ((channel.opened / channel.delivered) * 100).toFixed(2) : 0;\r\n      channel.click_rate = channel.opened > 0 ? ((channel.clicked / channel.opened) * 100).toFixed(2) : 0;\r\n    } else if (ch === 'whatsapp') {\r\n      channel.read_rate = channel.delivered > 0 ? ((channel.read / channel.delivered) * 100).toFixed(2) : 0;\r\n    }\r\n  });\r\n\r\n  return new Response(JSON.stringify(channels), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\nasync function exportRecipients(supabase: any, campaignId: string) {\r\n  const { data: recipients, error } = await supabase\r\n    .from('campaign_recipients')\r\n    .select(`\r\n      phone_number, name, recipient_email, delivery_status,\r\n      sent_at, delivered_at, read_at, failed_at,\r\n      error_message, error_code, retry_count, imported_from\r\n    `)\r\n    .eq('campaign_id', campaignId)\r\n    .order('created_at', { ascending: true });\r\n\r\n  if (error) {\r\n    return new Response(JSON.stringify({ error: 'Export failed' }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  // Generate CSV\r\n  const headers = ['Phone', 'Name', 'Email', 'Status', 'Sent At', 'Delivered At', 'Read At', 'Failed At', 'Error', 'Retries', 'Source'];\r\n  const rows = recipients?.map((r: any) => [\r\n    r.phone_number,\r\n    r.name || '',\r\n    r.recipient_email || '',\r\n    r.delivery_status,\r\n    r.sent_at || '',\r\n    r.delivered_at || '',\r\n    r.read_at || '',\r\n    r.failed_at || '',\r\n    r.error_message || '',\r\n    r.retry_count || 0,\r\n    r.imported_from\r\n  ]) || [];\r\n\r\n  const csv = [\r\n    headers.join(','),\r\n    ...rows.map((row: any) => row.map((cell: any) => `\"${String(cell).replace(/\"/g, '\"\"')}\"`).join(','))\r\n  ].join('\\n');\r\n\r\n  return new Response(csv, {\r\n    headers: {\r\n      ...corsHeaders,\r\n      'Content-Type': 'text/csv',\r\n      'Content-Disposition': `attachment; filename=\"campaign_${campaignId}_export.csv\"`\r\n    },\r\n  });\r\n}\r\n\r\nasync function getDeliveryTimeline(supabase: any, campaignId: string) {\r\n  // Get hourly breakdown of deliveries\r\n  const { data: recipients } = await supabase\r\n    .from('campaign_recipients')\r\n    .select('delivery_status, sent_at, delivered_at, read_at')\r\n    .eq('campaign_id', campaignId)\r\n    .not('sent_at', 'is', null)\r\n    .order('sent_at', { ascending: true });\r\n\r\n  const timeline: Record<string, { sent: number; delivered: number; read: number }> = {};\r\n\r\n  recipients?.forEach((r: any) => {\r\n    if (r.sent_at) {\r\n      const hour = new Date(r.sent_at).toISOString().slice(0, 13) + ':00:00Z';\r\n      if (!timeline[hour]) {\r\n        timeline[hour] = { sent: 0, delivered: 0, read: 0 };\r\n      }\r\n      timeline[hour].sent++;\r\n      if (r.delivered_at) timeline[hour].delivered++;\r\n      if (r.read_at) timeline[hour].read++;\r\n    }\r\n  });\r\n\r\n  const sorted = Object.entries(timeline)\r\n    .sort(([a], [b]) => a.localeCompare(b))\r\n    .map(([hour, data]) => ({ hour, ...data }));\r\n\r\n  return new Response(JSON.stringify(sorted), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\nasync function getAuditLog(supabase: any, campaignId: string) {\r\n  const { data: logs, error } = await supabase\r\n    .from('campaign_logs')\r\n    .select('*')\r\n    .eq('campaign_id', campaignId)\r\n    .order('created_at', { ascending: false })\r\n    .limit(100);\r\n\r\n  if (error) {\r\n    return new Response(JSON.stringify({ error: 'Failed to fetch audit log' }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  return new Response(JSON.stringify(logs), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\campaign-audience-import\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":12,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[327,330],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[327,330],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"prefer-const","severity":2,"message":"'recipients' is never reassigned. Use 'const' instead.","line":50,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":50,"endColumn":26,"fix":{"range":[1504,1531],"text":"const recipients: any[] = [];"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":50,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1520,1523],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1520,1523],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":51,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1557,1560],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1557,1560],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":280,"column":9,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":280,"endColumn":12,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9113,9116],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9113,9116],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":286,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":286,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9307,9310],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9307,9310],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":286,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":286,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9320,9323],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9320,9323],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":356,"column":99,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":356,"endColumn":102,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11239,11242],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11239,11242],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":361,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":361,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11402,11405],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11402,11405],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":361,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":361,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11415,11418],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11415,11418],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":10,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';\r\n\r\nconst corsHeaders = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',\r\n};\r\n\r\ninterface ImportRow {\r\n  name?: string;\r\n  phone?: string;\r\n  email?: string;\r\n  [key: string]: any;\r\n}\r\n\r\ninterface ColumnMapping {\r\n  phone: string;\r\n  name?: string;\r\n  email?: string;\r\n  [key: string]: string | undefined;\r\n}\r\n\r\nDeno.serve(async (req) => {\r\n  if (req.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;\r\n    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;\r\n    const supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n    const { \r\n      campaign_id, \r\n      company_id,\r\n      import_type, // 'manual_selection' | 'select_all' | 'excel_import' | 'filter'\r\n      lead_ids, // For manual selection\r\n      filters, // For filter-based selection\r\n      imported_data, // For Excel import\r\n      column_mapping, // For Excel import column mapping\r\n      template_variables_mapping // Map which columns go to which template variables\r\n    } = await req.json();\r\n\r\n    if (!campaign_id || !company_id || !import_type) {\r\n      return new Response(JSON.stringify({ error: 'Missing required fields' }), {\r\n        status: 400,\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      });\r\n    }\r\n\r\n    let recipients: any[] = [];\r\n    const importErrors: any[] = [];\r\n    const existingPhones = new Set<string>();\r\n\r\n    // Get existing recipients for this campaign to check duplicates\r\n    const { data: existingRecipients } = await supabase\r\n      .from('campaign_recipients')\r\n      .select('phone_number')\r\n      .eq('campaign_id', campaign_id);\r\n\r\n    existingRecipients?.forEach(r => existingPhones.add(normalizePhone(r.phone_number)));\r\n\r\n    if (import_type === 'manual_selection' && lead_ids?.length > 0) {\r\n      // Import from manual lead selection\r\n      const { data: leads, error } = await supabase\r\n        .from('leads')\r\n        .select('id, name, phone, email, opted_in')\r\n        .eq('company_id', company_id)\r\n        .in('id', lead_ids);\r\n\r\n      if (error) throw error;\r\n\r\n      for (const lead of leads || []) {\r\n        const result = validateAndPrepareRecipient(\r\n          lead, \r\n          campaign_id, \r\n          company_id, \r\n          'manual_selection',\r\n          existingPhones,\r\n          template_variables_mapping\r\n        );\r\n        if (result.valid) {\r\n          recipients.push(result.recipient);\r\n          existingPhones.add(normalizePhone(lead.phone));\r\n        } else {\r\n          importErrors.push(result.error);\r\n        }\r\n      }\r\n    } \r\n    else if (import_type === 'select_all') {\r\n      // Import all opted-in leads\r\n      const { data: leads, error } = await supabase\r\n        .from('leads')\r\n        .select('id, name, phone, email, opted_in')\r\n        .eq('company_id', company_id)\r\n        .eq('opted_in', true)\r\n        .not('phone', 'is', null);\r\n\r\n      if (error) throw error;\r\n\r\n      for (const lead of leads || []) {\r\n        const result = validateAndPrepareRecipient(\r\n          lead, \r\n          campaign_id, \r\n          company_id, \r\n          'select_all',\r\n          existingPhones,\r\n          template_variables_mapping\r\n        );\r\n        if (result.valid) {\r\n          recipients.push(result.recipient);\r\n          existingPhones.add(normalizePhone(lead.phone));\r\n        } else {\r\n          importErrors.push(result.error);\r\n        }\r\n      }\r\n    }\r\n    else if (import_type === 'filter' && filters) {\r\n      // Import based on filters\r\n      let query = supabase\r\n        .from('leads')\r\n        .select('id, name, phone, email, opted_in, stage, source, tags, location')\r\n        .eq('company_id', company_id)\r\n        .eq('opted_in', true)\r\n        .not('phone', 'is', null);\r\n\r\n      // Apply filters\r\n      if (filters.stages?.length > 0) {\r\n        query = query.in('stage', filters.stages);\r\n      }\r\n      if (filters.sources?.length > 0) {\r\n        query = query.in('source', filters.sources);\r\n      }\r\n      if (filters.locations?.length > 0) {\r\n        query = query.in('location', filters.locations);\r\n      }\r\n      if (filters.tags?.length > 0) {\r\n        query = query.overlaps('tags', filters.tags);\r\n      }\r\n\r\n      const { data: leads, error } = await query;\r\n      if (error) throw error;\r\n\r\n      for (const lead of leads || []) {\r\n        const result = validateAndPrepareRecipient(\r\n          lead, \r\n          campaign_id, \r\n          company_id, \r\n          'filter',\r\n          existingPhones,\r\n          template_variables_mapping\r\n        );\r\n        if (result.valid) {\r\n          recipients.push(result.recipient);\r\n          existingPhones.add(normalizePhone(lead.phone));\r\n        } else {\r\n          importErrors.push(result.error);\r\n        }\r\n      }\r\n    }\r\n    else if (import_type === 'excel_import' && imported_data?.length > 0) {\r\n      const mapping = column_mapping as ColumnMapping;\r\n      \r\n      if (!mapping?.phone) {\r\n        return new Response(JSON.stringify({ error: 'Phone column mapping is required' }), {\r\n          status: 400,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      for (let i = 0; i < imported_data.length; i++) {\r\n        const row = imported_data[i] as ImportRow;\r\n        const phone = row[mapping.phone];\r\n        const name = mapping.name ? row[mapping.name] : null;\r\n        const email = mapping.email ? row[mapping.email] : null;\r\n\r\n        // Build template variables from mapping\r\n        const templateVars: Record<string, string> = {};\r\n        if (template_variables_mapping) {\r\n          for (const [varName, columnName] of Object.entries(template_variables_mapping)) {\r\n            if (columnName && row[columnName as string]) {\r\n              templateVars[varName] = String(row[columnName as string]);\r\n            }\r\n          }\r\n        }\r\n\r\n        const result = validateAndPrepareRecipientFromImport(\r\n          { phone, name, email, row_number: i + 1, raw_data: row },\r\n          campaign_id,\r\n          company_id,\r\n          existingPhones,\r\n          templateVars\r\n        );\r\n\r\n        if (result.valid) {\r\n          recipients.push(result.recipient);\r\n          existingPhones.add(normalizePhone(phone));\r\n        } else {\r\n          importErrors.push(result.error);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Insert recipients in batches\r\n    if (recipients.length > 0) {\r\n      const batchSize = 500;\r\n      for (let i = 0; i < recipients.length; i += batchSize) {\r\n        const batch = recipients.slice(i, i + batchSize);\r\n        const { error: insertError } = await supabase\r\n          .from('campaign_recipients')\r\n          .insert(batch);\r\n        \r\n        if (insertError) {\r\n          console.error('Error inserting recipients batch:', insertError);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Insert import errors\r\n    if (importErrors.length > 0) {\r\n      await supabase\r\n        .from('campaign_import_errors')\r\n        .insert(importErrors);\r\n    }\r\n\r\n    // Update campaign audience count\r\n    await supabase\r\n      .from('campaigns')\r\n      .update({ \r\n        audience_count: recipients.length,\r\n        total_recipients: recipients.length\r\n      })\r\n      .eq('id', campaign_id);\r\n\r\n    // Log the import\r\n    await supabase.rpc('log_campaign_action', {\r\n      p_campaign_id: campaign_id,\r\n      p_company_id: company_id,\r\n      p_action: `Imported ${recipients.length} recipients via ${import_type}`,\r\n      p_action_type: 'imported',\r\n      p_details: { \r\n        import_type,\r\n        total_imported: recipients.length,\r\n        duplicates_skipped: importErrors.filter(e => e.error_type === 'duplicate').length,\r\n        no_consent_skipped: importErrors.filter(e => e.error_type === 'no_consent').length,\r\n        invalid_phone_skipped: importErrors.filter(e => e.error_type === 'invalid_phone').length,\r\n        total_errors: importErrors.length\r\n      },\r\n    });\r\n\r\n    return new Response(JSON.stringify({ \r\n      success: true,\r\n      imported: recipients.length,\r\n      errors: importErrors.length,\r\n      error_details: importErrors.slice(0, 10) // Return first 10 errors for preview\r\n    }), {\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Import error:', error);\r\n    const message = error instanceof Error ? error.message : 'Unknown error';\r\n    return new Response(JSON.stringify({ error: message }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n});\r\n\r\nfunction normalizePhone(phone: string | null | undefined): string {\r\n  if (!phone) return '';\r\n  return phone.replace(/[^0-9]/g, '');\r\n}\r\n\r\nfunction isValidPhone(phone: string | null | undefined): boolean {\r\n  const normalized = normalizePhone(phone);\r\n  return normalized.length >= 10 && normalized.length <= 15;\r\n}\r\n\r\nfunction validateAndPrepareRecipient(\r\n  lead: any,\r\n  campaignId: string,\r\n  companyId: string,\r\n  importedFrom: string,\r\n  existingPhones: Set<string>,\r\n  templateVariablesMapping?: Record<string, string>\r\n): { valid: boolean; recipient?: any; error?: any } {\r\n  const normalizedPhone = normalizePhone(lead.phone);\r\n\r\n  // Check for valid phone\r\n  if (!isValidPhone(lead.phone)) {\r\n    return {\r\n      valid: false,\r\n      error: {\r\n        campaign_id: campaignId,\r\n        company_id: companyId,\r\n        lead_data: { id: lead.id, phone: lead.phone, name: lead.name },\r\n        error_type: 'invalid_phone',\r\n        error_message: 'Invalid phone number format'\r\n      }\r\n    };\r\n  }\r\n\r\n  // Check for duplicates\r\n  if (existingPhones.has(normalizedPhone)) {\r\n    return {\r\n      valid: false,\r\n      error: {\r\n        campaign_id: campaignId,\r\n        company_id: companyId,\r\n        lead_data: { id: lead.id, phone: lead.phone, name: lead.name },\r\n        error_type: 'duplicate',\r\n        error_message: 'Duplicate phone number'\r\n      }\r\n    };\r\n  }\r\n\r\n  // Check consent (only skip if explicitly false)\r\n  if (lead.opted_in === false) {\r\n    return {\r\n      valid: false,\r\n      error: {\r\n        campaign_id: campaignId,\r\n        company_id: companyId,\r\n        lead_data: { id: lead.id, phone: lead.phone, name: lead.name },\r\n        error_type: 'no_consent',\r\n        error_message: 'Lead has not opted in'\r\n      }\r\n    };\r\n  }\r\n\r\n  // Build template variables\r\n  const templateVariables: Record<string, string> = {\r\n    name: lead.name || '',\r\n    phone: lead.phone || '',\r\n    email: lead.email || ''\r\n  };\r\n\r\n  return {\r\n    valid: true,\r\n    recipient: {\r\n      campaign_id: campaignId,\r\n      company_id: companyId,\r\n      lead_id: lead.id,\r\n      phone_number: lead.phone,\r\n      name: lead.name,\r\n      template_variables: templateVariables,\r\n      delivery_status: 'queued',\r\n      imported_from: importedFrom,\r\n      is_duplicate: false,\r\n      consent_checked: lead.opted_in !== false\r\n    }\r\n  };\r\n}\r\n\r\nfunction validateAndPrepareRecipientFromImport(\r\n  data: { phone: string; name: string | null; email: string | null; row_number: number; raw_data: any },\r\n  campaignId: string,\r\n  companyId: string,\r\n  existingPhones: Set<string>,\r\n  templateVariables: Record<string, string>\r\n): { valid: boolean; recipient?: any; error?: any } {\r\n  const normalizedPhone = normalizePhone(data.phone);\r\n\r\n  // Check for missing phone\r\n  if (!data.phone) {\r\n    return {\r\n      valid: false,\r\n      error: {\r\n        campaign_id: campaignId,\r\n        company_id: companyId,\r\n        row_number: data.row_number,\r\n        lead_data: data.raw_data,\r\n        error_type: 'missing_phone',\r\n        error_message: 'Missing phone number'\r\n      }\r\n    };\r\n  }\r\n\r\n  // Check for valid phone\r\n  if (!isValidPhone(data.phone)) {\r\n    return {\r\n      valid: false,\r\n      error: {\r\n        campaign_id: campaignId,\r\n        company_id: companyId,\r\n        row_number: data.row_number,\r\n        lead_data: data.raw_data,\r\n        error_type: 'invalid_phone',\r\n        error_message: 'Invalid phone number format'\r\n      }\r\n    };\r\n  }\r\n\r\n  // Check for duplicates\r\n  if (existingPhones.has(normalizedPhone)) {\r\n    return {\r\n      valid: false,\r\n      error: {\r\n        campaign_id: campaignId,\r\n        company_id: companyId,\r\n        row_number: data.row_number,\r\n        lead_data: data.raw_data,\r\n        error_type: 'duplicate',\r\n        error_message: 'Duplicate phone number'\r\n      }\r\n    };\r\n  }\r\n\r\n  return {\r\n    valid: true,\r\n    recipient: {\r\n      campaign_id: campaignId,\r\n      company_id: companyId,\r\n      lead_id: null,\r\n      phone_number: data.phone,\r\n      name: data.name,\r\n      template_variables: {\r\n        name: data.name || '',\r\n        phone: data.phone || '',\r\n        email: data.email || '',\r\n        ...templateVariables\r\n      },\r\n      delivery_status: 'queued',\r\n      imported_from: 'excel_import',\r\n      is_duplicate: false,\r\n      consent_checked: true\r\n    }\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\campaign-execute\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":119,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3461,3464],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3461,3464],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":119,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3476,3479],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3476,3479],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":132,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":132,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3891,3894],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3891,3894],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":132,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":132,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3906,3909],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3906,3909],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":145,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":145,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4311,4314],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4311,4314],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":145,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":145,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4326,4329],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4326,4329],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":156,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":156,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4617,4620],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4617,4620],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":156,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":156,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4632,4635],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4632,4635],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":255,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":255,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8207,8210],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8207,8210],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":256,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":256,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8226,8229],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8226,8229],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":270,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":270,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8570,8573],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8570,8573],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":271,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":271,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8588,8591],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8588,8591],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":337,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":337,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10736,10739],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10736,10739],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":337,"column":91,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":337,"endColumn":94,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10784,10787],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10784,10787],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":347,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":347,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11095,11098],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11095,11098],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":351,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":351,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11169,11172],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11169,11172],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":415,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":415,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13166,13169],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13166,13169],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":415,"column":93,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":415,"endColumn":96,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13214,13217],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13214,13217],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":457,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":457,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14565,14568],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14565,14568],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":457,"column":96,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":457,"endColumn":99,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14613,14616],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14613,14616],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":493,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":493,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15632,15635],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15632,15635],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":494,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":494,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15650,15653],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15650,15653],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":506,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":506,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15933,15936],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15933,15936],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":507,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":507,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15951,15954],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15951,15954],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":573,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":573,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18109,18112],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18109,18112],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":573,"column":90,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":573,"endColumn":93,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18157,18160],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18157,18160],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":617,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":617,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19492,19495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19492,19495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":617,"column":92,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":617,"endColumn":95,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19540,19543],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19540,19543],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":659,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":659,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21014,21017],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21014,21017],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":659,"column":91,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":659,"endColumn":94,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21062,21065],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21062,21065],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":704,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":704,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22500,22503],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22500,22503],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":705,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":705,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22518,22521],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22518,22521],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":717,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":717,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22797,22800],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22797,22800],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":718,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":718,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22815,22818],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22815,22818],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":784,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":784,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24961,24964],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24961,24964],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":784,"column":88,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":784,"endColumn":91,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25009,25012],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25009,25012],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":822,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":822,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26200,26203],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26200,26203],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":822,"column":93,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":822,"endColumn":96,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26248,26251],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26248,26251],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":856,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":856,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27249,27252],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27249,27252],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":856,"column":88,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":856,"endColumn":91,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27297,27300],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27297,27300],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":893,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":893,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28426,28429],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28426,28429],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":894,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":894,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28445,28448],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28445,28448],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":42,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';\r\n\r\nconst corsHeaders = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',\r\n};\r\n\r\ninterface CampaignRecipient {\r\n  id: string;\r\n  phone_number: string;\r\n  name: string | null;\r\n  template_variables: Record<string, string>;\r\n  recipient_email?: string;\r\n}\r\n\r\ninterface MarketingConnection {\r\n  id: string;\r\n  channel: string;\r\n  provider: string;\r\n  identifier: string;\r\n  credentials: {\r\n    accessToken?: string;\r\n    phoneNumberId?: string;\r\n    businessId?: string;\r\n    apiKey?: string;\r\n    accountSid?: string;\r\n    authToken?: string;\r\n    domain?: string;\r\n    region?: string;\r\n    accessKeyId?: string;\r\n    secretAccessKey?: string;\r\n  };\r\n}\r\n\r\nDeno.serve(async (req) => {\r\n  if (req.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;\r\n    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;\r\n    const supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n    const { campaign_id, action } = await req.json();\r\n\r\n    if (!campaign_id) {\r\n      return new Response(JSON.stringify({ error: 'campaign_id is required' }), {\r\n        status: 400,\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      });\r\n    }\r\n\r\n    // Get campaign with connection details\r\n    const { data: campaign, error: campaignError } = await supabase\r\n      .from('campaigns')\r\n      .select(`\r\n        *,\r\n        marketing_connections!connection_id (\r\n          id,\r\n          channel,\r\n          provider,\r\n          identifier,\r\n          credentials,\r\n          status\r\n        ),\r\n        whatsapp_templates!whatsapp_template_id (\r\n          template_name,\r\n          language,\r\n          header_type,\r\n          header_content,\r\n          body,\r\n          buttons_json\r\n        )\r\n      `)\r\n      .eq('id', campaign_id)\r\n      .single();\r\n\r\n    if (campaignError || !campaign) {\r\n      console.error('Campaign not found:', campaignError);\r\n      return new Response(JSON.stringify({ error: 'Campaign not found' }), {\r\n        status: 404,\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      });\r\n    }\r\n\r\n    console.log('Campaign loaded:', { \r\n      id: campaign.id, \r\n      channel: campaign.channel,\r\n      connection: campaign.marketing_connections?.provider \r\n    });\r\n\r\n    // Handle different actions\r\n    switch (action) {\r\n      case 'start':\r\n        return await startCampaign(supabase, campaign);\r\n      case 'pause':\r\n        return await pauseCampaign(supabase, campaign);\r\n      case 'resume':\r\n        return await resumeCampaign(supabase, campaign);\r\n      case 'process_batch':\r\n        return await processBatch(supabase, campaign);\r\n      default:\r\n        return new Response(JSON.stringify({ error: 'Invalid action' }), {\r\n          status: 400,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n  } catch (error) {\r\n    console.error('Campaign execution error:', error);\r\n    const message = error instanceof Error ? error.message : 'Unknown error';\r\n    return new Response(JSON.stringify({ error: message }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n});\r\n\r\nasync function startCampaign(supabase: any, campaign: any) {\r\n  console.log(`Starting campaign ${campaign.id} on channel ${campaign.channel}`);\r\n\r\n  await supabase\r\n    .from('campaigns')\r\n    .update({ status: 'sending', started_at: new Date().toISOString() })\r\n    .eq('id', campaign.id);\r\n\r\n  await logCampaignAction(supabase, campaign, 'Campaign started', 'started');\r\n\r\n  return await processBatch(supabase, campaign);\r\n}\r\n\r\nasync function pauseCampaign(supabase: any, campaign: any) {\r\n  await supabase\r\n    .from('campaigns')\r\n    .update({ status: 'paused' })\r\n    .eq('id', campaign.id);\r\n\r\n  await logCampaignAction(supabase, campaign, 'Campaign paused', 'paused');\r\n\r\n  return new Response(JSON.stringify({ success: true, message: 'Campaign paused' }), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\nasync function resumeCampaign(supabase: any, campaign: any) {\r\n  await supabase\r\n    .from('campaigns')\r\n    .update({ status: 'sending' })\r\n    .eq('id', campaign.id);\r\n\r\n  await logCampaignAction(supabase, campaign, 'Campaign resumed', 'resumed');\r\n\r\n  return await processBatch(supabase, campaign);\r\n}\r\n\r\nasync function processBatch(supabase: any, campaign: any) {\r\n  const batchSize = campaign.rate_limit_per_second || 50;\r\n  const connection = campaign.marketing_connections as MarketingConnection | null;\r\n\r\n  if (!connection) {\r\n    console.error('No connection found for campaign');\r\n    return new Response(JSON.stringify({ error: 'No connection configured' }), {\r\n      status: 400,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  // Get queued recipients with consent check\r\n  const { data: recipients, error: recipientsError } = await supabase\r\n    .from('campaign_recipients')\r\n    .select(`\r\n      id, phone_number, name, template_variables, recipient_email, lead_id, consent_checked,\r\n      leads:lead_id (opted_in, opted_in_whatsapp, opted_in_sms, opted_in_email)\r\n    `)\r\n    .eq('campaign_id', campaign.id)\r\n    .eq('delivery_status', 'queued')\r\n    .limit(batchSize);\r\n\r\n  if (recipientsError) {\r\n    console.error('Error fetching recipients:', recipientsError);\r\n    return new Response(JSON.stringify({ error: 'Failed to fetch recipients' }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  if (!recipients || recipients.length === 0) {\r\n    // Campaign completed\r\n    await supabase\r\n      .from('campaigns')\r\n      .update({ status: 'completed', completed_at: new Date().toISOString() })\r\n      .eq('id', campaign.id);\r\n\r\n    await logCampaignAction(supabase, campaign, 'Campaign completed', 'completed');\r\n\r\n    return new Response(JSON.stringify({ success: true, message: 'Campaign completed', processed: 0 }), {\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  console.log(`Processing ${recipients.length} recipients for ${campaign.channel}`);\r\n\r\n  // Route to appropriate channel handler\r\n  let results: PromiseSettledResult<{ success: boolean; error?: string }>[];\r\n\r\n  switch (campaign.channel) {\r\n    case 'whatsapp':\r\n      results = await processWhatsAppBatch(supabase, campaign, recipients, connection);\r\n      break;\r\n    case 'email':\r\n      results = await processEmailBatch(supabase, campaign, recipients, connection);\r\n      break;\r\n    case 'sms':\r\n      results = await processSMSBatch(supabase, campaign, recipients, connection);\r\n      break;\r\n    default:\r\n      return new Response(JSON.stringify({ error: 'Unsupported channel' }), {\r\n        status: 400,\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      });\r\n  }\r\n\r\n  const successCount = results.filter(r => r.status === 'fulfilled' && r.value.success).length;\r\n  const failCount = results.filter(r => r.status === 'rejected' || (r.status === 'fulfilled' && !r.value.success)).length;\r\n\r\n  // Update campaign counts\r\n  await supabase\r\n    .from('campaigns')\r\n    .update({ \r\n      sent_count: (campaign.sent_count || 0) + successCount,\r\n      failed_count: (campaign.failed_count || 0) + failCount \r\n    })\r\n    .eq('id', campaign.id);\r\n\r\n  // Get remaining count\r\n  const { count: remainingCount } = await supabase\r\n    .from('campaign_recipients')\r\n    .select('id', { count: 'exact', head: true })\r\n    .eq('campaign_id', campaign.id)\r\n    .eq('delivery_status', 'queued');\r\n\r\n  return new Response(JSON.stringify({ \r\n    success: true, \r\n    processed: recipients.length,\r\n    sent: successCount,\r\n    failed: failCount,\r\n    remaining: remainingCount || 0\r\n  }), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\n// ==================== WHATSAPP ====================\r\nasync function processWhatsAppBatch(\r\n  supabase: any, \r\n  campaign: any, \r\n  recipients: CampaignRecipient[], \r\n  connection: MarketingConnection\r\n) {\r\n  const { provider, credentials } = connection;\r\n  \r\n  return await Promise.allSettled(\r\n    recipients.map(recipient => \r\n      sendWhatsAppMessage(supabase, campaign, recipient, connection)\r\n    )\r\n  );\r\n}\r\n\r\nasync function sendWhatsAppMessage(\r\n  supabase: any,\r\n  campaign: any,\r\n  recipient: CampaignRecipient,\r\n  connection: MarketingConnection\r\n): Promise<{ success: boolean; error?: string }> {\r\n  const { provider, credentials } = connection;\r\n  \r\n  try {\r\n    await supabase\r\n      .from('campaign_recipients')\r\n      .update({ delivery_status: 'sending' })\r\n      .eq('id', recipient.id);\r\n\r\n    let result: { success: boolean; messageId?: string; error?: string };\r\n\r\n    switch (provider) {\r\n      case 'meta':\r\n        result = await sendMetaWhatsApp(campaign, recipient, credentials);\r\n        break;\r\n      case 'twilio':\r\n        result = await sendTwilioWhatsApp(campaign, recipient, credentials);\r\n        break;\r\n      case '360dialog':\r\n        result = await send360DialogWhatsApp(campaign, recipient, credentials);\r\n        break;\r\n      default:\r\n        result = { success: false, error: `Unsupported provider: ${provider}` };\r\n    }\r\n\r\n    if (result.success) {\r\n      await supabase\r\n        .from('campaign_recipients')\r\n        .update({ \r\n          delivery_status: 'sent',\r\n          meta_message_id: result.messageId,\r\n          sent_at: new Date().toISOString()\r\n        })\r\n        .eq('id', recipient.id);\r\n\r\n      await logCampaignAction(supabase, campaign, 'WhatsApp message sent', 'sent', recipient.id);\r\n    } else {\r\n      await supabase\r\n        .from('campaign_recipients')\r\n        .update({ \r\n          delivery_status: 'failed',\r\n          error_message: result.error,\r\n          failed_at: new Date().toISOString()\r\n        })\r\n        .eq('id', recipient.id);\r\n\r\n      await logCampaignAction(supabase, campaign, `Failed: ${result.error}`, 'failed', recipient.id);\r\n    }\r\n\r\n    return result;\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : 'Unknown error';\r\n    console.error(`WhatsApp send error for ${recipient.phone_number}:`, error);\r\n    \r\n    await supabase\r\n      .from('campaign_recipients')\r\n      .update({ delivery_status: 'failed', error_message: message, failed_at: new Date().toISOString() })\r\n      .eq('id', recipient.id);\r\n\r\n    return { success: false, error: message };\r\n  }\r\n}\r\n\r\nasync function sendMetaWhatsApp(campaign: any, recipient: CampaignRecipient, credentials: any) {\r\n  const { accessToken, phoneNumberId } = credentials;\r\n  \r\n  if (!accessToken || !phoneNumberId) {\r\n    return { success: false, error: 'Missing Meta WhatsApp credentials' };\r\n  }\r\n\r\n  const template = campaign.whatsapp_templates;\r\n  const templateContent = campaign.template_content;\r\n\r\n  let payload: any;\r\n\r\n  if (template) {\r\n    // Template message\r\n    const components: any[] = [];\r\n    const bodyParams = Object.values(recipient.template_variables || {}).map(value => ({\r\n      type: 'text',\r\n      text: String(value)\r\n    }));\r\n\r\n    if (bodyParams.length > 0) {\r\n      components.push({ type: 'body', parameters: bodyParams });\r\n    }\r\n\r\n    payload = {\r\n      messaging_product: 'whatsapp',\r\n      recipient_type: 'individual',\r\n      to: recipient.phone_number.replace(/[^0-9]/g, ''),\r\n      type: 'template',\r\n      template: {\r\n        name: template.template_name,\r\n        language: { code: template.language || 'en' },\r\n        components: components.length > 0 ? components : undefined\r\n      }\r\n    };\r\n  } else if (templateContent?.body) {\r\n    // Custom text message\r\n    let body = templateContent.body;\r\n    // Replace variables\r\n    body = body.replace(/\\{\\{name\\}\\}/gi, recipient.name || 'Customer');\r\n    body = body.replace(/\\{\\{phone\\}\\}/gi, recipient.phone_number);\r\n    \r\n    for (const [key, value] of Object.entries(recipient.template_variables || {})) {\r\n      body = body.replace(new RegExp(`\\\\{\\\\{${key}\\\\}\\\\}`, 'gi'), String(value));\r\n    }\r\n\r\n    payload = {\r\n      messaging_product: 'whatsapp',\r\n      recipient_type: 'individual',\r\n      to: recipient.phone_number.replace(/[^0-9]/g, ''),\r\n      type: 'text',\r\n      text: { preview_url: false, body }\r\n    };\r\n  } else {\r\n    return { success: false, error: 'No template or content configured' };\r\n  }\r\n\r\n  const response = await fetch(\r\n    `https://graph.facebook.com/v18.0/${phoneNumberId}/messages`,\r\n    {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${accessToken}`,\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify(payload),\r\n    }\r\n  );\r\n\r\n  const result = await response.json();\r\n\r\n  if (!response.ok) {\r\n    return { success: false, error: result.error?.message || 'Meta API error' };\r\n  }\r\n\r\n  return { success: true, messageId: result.messages?.[0]?.id };\r\n}\r\n\r\nasync function sendTwilioWhatsApp(campaign: any, recipient: CampaignRecipient, credentials: any) {\r\n  const { accountSid, authToken, phoneNumber: fromNumber } = credentials;\r\n  \r\n  if (!accountSid || !authToken || !fromNumber) {\r\n    return { success: false, error: 'Missing Twilio credentials' };\r\n  }\r\n\r\n  const templateContent = campaign.template_content;\r\n  let body = templateContent?.body || 'Hello from our campaign!';\r\n  \r\n  // Replace variables\r\n  body = body.replace(/\\{\\{name\\}\\}/gi, recipient.name || 'Customer');\r\n  body = body.replace(/\\{\\{phone\\}\\}/gi, recipient.phone_number);\r\n\r\n  const toNumber = `whatsapp:${recipient.phone_number.replace(/[^0-9+]/g, '')}`;\r\n  const twilioFrom = `whatsapp:${fromNumber.replace(/[^0-9+]/g, '')}`;\r\n\r\n  const response = await fetch(\r\n    `https://api.twilio.com/2010-04-01/Accounts/${accountSid}/Messages.json`,\r\n    {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': 'Basic ' + btoa(`${accountSid}:${authToken}`),\r\n        'Content-Type': 'application/x-www-form-urlencoded',\r\n      },\r\n      body: new URLSearchParams({\r\n        From: twilioFrom,\r\n        To: toNumber,\r\n        Body: body,\r\n      }),\r\n    }\r\n  );\r\n\r\n  const result = await response.json();\r\n\r\n  if (!response.ok) {\r\n    return { success: false, error: result.message || 'Twilio API error' };\r\n  }\r\n\r\n  return { success: true, messageId: result.sid };\r\n}\r\n\r\nasync function send360DialogWhatsApp(campaign: any, recipient: CampaignRecipient, credentials: any) {\r\n  const { apiKey } = credentials;\r\n  \r\n  if (!apiKey) {\r\n    return { success: false, error: 'Missing 360dialog API key' };\r\n  }\r\n\r\n  const templateContent = campaign.template_content;\r\n  let body = templateContent?.body || 'Hello from our campaign!';\r\n  \r\n  body = body.replace(/\\{\\{name\\}\\}/gi, recipient.name || 'Customer');\r\n\r\n  const response = await fetch('https://waba.360dialog.io/v1/messages', {\r\n    method: 'POST',\r\n    headers: {\r\n      'D360-API-KEY': apiKey,\r\n      'Content-Type': 'application/json',\r\n    },\r\n    body: JSON.stringify({\r\n      to: recipient.phone_number.replace(/[^0-9]/g, ''),\r\n      type: 'text',\r\n      text: { body }\r\n    }),\r\n  });\r\n\r\n  const result = await response.json();\r\n\r\n  if (!response.ok) {\r\n    return { success: false, error: result.meta?.developer_message || '360dialog API error' };\r\n  }\r\n\r\n  return { success: true, messageId: result.messages?.[0]?.id };\r\n}\r\n\r\n// ==================== EMAIL ====================\r\nasync function processEmailBatch(\r\n  supabase: any,\r\n  campaign: any,\r\n  recipients: CampaignRecipient[],\r\n  connection: MarketingConnection\r\n) {\r\n  return await Promise.allSettled(\r\n    recipients.map(recipient => \r\n      sendEmailMessage(supabase, campaign, recipient, connection)\r\n    )\r\n  );\r\n}\r\n\r\nasync function sendEmailMessage(\r\n  supabase: any,\r\n  campaign: any,\r\n  recipient: CampaignRecipient,\r\n  connection: MarketingConnection\r\n): Promise<{ success: boolean; error?: string }> {\r\n  const { provider, credentials, identifier } = connection;\r\n  \r\n  try {\r\n    await supabase\r\n      .from('campaign_recipients')\r\n      .update({ delivery_status: 'sending' })\r\n      .eq('id', recipient.id);\r\n\r\n    let result: { success: boolean; messageId?: string; error?: string };\r\n\r\n    switch (provider) {\r\n      case 'resend':\r\n        result = await sendResendEmail(campaign, recipient, credentials, identifier);\r\n        break;\r\n      case 'sendgrid':\r\n        result = await sendSendGridEmail(campaign, recipient, credentials, identifier);\r\n        break;\r\n      case 'mailgun':\r\n        result = await sendMailgunEmail(campaign, recipient, credentials, identifier);\r\n        break;\r\n      default:\r\n        result = { success: false, error: `Unsupported email provider: ${provider}` };\r\n    }\r\n\r\n    if (result.success) {\r\n      await supabase\r\n        .from('campaign_recipients')\r\n        .update({ \r\n          delivery_status: 'sent',\r\n          meta_message_id: result.messageId,\r\n          sent_at: new Date().toISOString()\r\n        })\r\n        .eq('id', recipient.id);\r\n\r\n      await logCampaignAction(supabase, campaign, 'Email sent', 'sent', recipient.id);\r\n    } else {\r\n      await supabase\r\n        .from('campaign_recipients')\r\n        .update({ \r\n          delivery_status: 'failed',\r\n          error_message: result.error,\r\n          failed_at: new Date().toISOString()\r\n        })\r\n        .eq('id', recipient.id);\r\n\r\n      await logCampaignAction(supabase, campaign, `Email failed: ${result.error}`, 'failed', recipient.id);\r\n    }\r\n\r\n    return result;\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : 'Unknown error';\r\n    console.error(`Email send error:`, error);\r\n    \r\n    await supabase\r\n      .from('campaign_recipients')\r\n      .update({ delivery_status: 'failed', error_message: message, failed_at: new Date().toISOString() })\r\n      .eq('id', recipient.id);\r\n\r\n    return { success: false, error: message };\r\n  }\r\n}\r\n\r\nasync function sendResendEmail(campaign: any, recipient: CampaignRecipient, credentials: any, fromEmail: string) {\r\n  const { apiKey } = credentials;\r\n  \r\n  if (!apiKey) {\r\n    return { success: false, error: 'Missing Resend API key' };\r\n  }\r\n\r\n  const templateContent = campaign.template_content || {};\r\n  let subject = templateContent.subject || campaign.name;\r\n  let body = templateContent.body || templateContent.html || `<p>Hello ${recipient.name || 'there'}!</p>`;\r\n  \r\n  // Replace variables\r\n  subject = subject.replace(/\\{\\{name\\}\\}/gi, recipient.name || 'Customer');\r\n  body = body.replace(/\\{\\{name\\}\\}/gi, recipient.name || 'Customer');\r\n\r\n  const recipientEmail = recipient.recipient_email || recipient.template_variables?.email;\r\n  \r\n  if (!recipientEmail) {\r\n    return { success: false, error: 'No recipient email' };\r\n  }\r\n\r\n  const response = await fetch('https://api.resend.com/emails', {\r\n    method: 'POST',\r\n    headers: {\r\n      'Authorization': `Bearer ${apiKey}`,\r\n      'Content-Type': 'application/json',\r\n    },\r\n    body: JSON.stringify({\r\n      from: fromEmail,\r\n      to: [recipientEmail],\r\n      subject,\r\n      html: body,\r\n    }),\r\n  });\r\n\r\n  const result = await response.json();\r\n\r\n  if (!response.ok) {\r\n    return { success: false, error: result.message || 'Resend API error' };\r\n  }\r\n\r\n  return { success: true, messageId: result.id };\r\n}\r\n\r\nasync function sendSendGridEmail(campaign: any, recipient: CampaignRecipient, credentials: any, fromEmail: string) {\r\n  const { apiKey } = credentials;\r\n  \r\n  if (!apiKey) {\r\n    return { success: false, error: 'Missing SendGrid API key' };\r\n  }\r\n\r\n  const templateContent = campaign.template_content || {};\r\n  let subject = templateContent.subject || campaign.name;\r\n  let body = templateContent.body || templateContent.html || `<p>Hello ${recipient.name || 'there'}!</p>`;\r\n  \r\n  subject = subject.replace(/\\{\\{name\\}\\}/gi, recipient.name || 'Customer');\r\n  body = body.replace(/\\{\\{name\\}\\}/gi, recipient.name || 'Customer');\r\n\r\n  const recipientEmail = recipient.recipient_email || recipient.template_variables?.email;\r\n  \r\n  if (!recipientEmail) {\r\n    return { success: false, error: 'No recipient email' };\r\n  }\r\n\r\n  const response = await fetch('https://api.sendgrid.com/v3/mail/send', {\r\n    method: 'POST',\r\n    headers: {\r\n      'Authorization': `Bearer ${apiKey}`,\r\n      'Content-Type': 'application/json',\r\n    },\r\n    body: JSON.stringify({\r\n      personalizations: [{ to: [{ email: recipientEmail }] }],\r\n      from: { email: fromEmail },\r\n      subject,\r\n      content: [{ type: 'text/html', value: body }],\r\n    }),\r\n  });\r\n\r\n  if (!response.ok) {\r\n    const result = await response.json().catch(() => ({}));\r\n    return { success: false, error: result.errors?.[0]?.message || 'SendGrid API error' };\r\n  }\r\n\r\n  return { success: true, messageId: response.headers.get('x-message-id') || undefined };\r\n}\r\n\r\nasync function sendMailgunEmail(campaign: any, recipient: CampaignRecipient, credentials: any, fromEmail: string) {\r\n  const { apiKey, domain } = credentials;\r\n  \r\n  if (!apiKey || !domain) {\r\n    return { success: false, error: 'Missing Mailgun credentials' };\r\n  }\r\n\r\n  const templateContent = campaign.template_content || {};\r\n  let subject = templateContent.subject || campaign.name;\r\n  let body = templateContent.body || templateContent.html || `<p>Hello ${recipient.name || 'there'}!</p>`;\r\n  \r\n  subject = subject.replace(/\\{\\{name\\}\\}/gi, recipient.name || 'Customer');\r\n  body = body.replace(/\\{\\{name\\}\\}/gi, recipient.name || 'Customer');\r\n\r\n  const recipientEmail = recipient.recipient_email || recipient.template_variables?.email;\r\n  \r\n  if (!recipientEmail) {\r\n    return { success: false, error: 'No recipient email' };\r\n  }\r\n\r\n  const response = await fetch(`https://api.mailgun.net/v3/${domain}/messages`, {\r\n    method: 'POST',\r\n    headers: {\r\n      'Authorization': 'Basic ' + btoa(`api:${apiKey}`),\r\n      'Content-Type': 'application/x-www-form-urlencoded',\r\n    },\r\n    body: new URLSearchParams({\r\n      from: fromEmail,\r\n      to: recipientEmail,\r\n      subject,\r\n      html: body,\r\n    }),\r\n  });\r\n\r\n  const result = await response.json();\r\n\r\n  if (!response.ok) {\r\n    return { success: false, error: result.message || 'Mailgun API error' };\r\n  }\r\n\r\n  return { success: true, messageId: result.id };\r\n}\r\n\r\n// ==================== SMS ====================\r\nasync function processSMSBatch(\r\n  supabase: any,\r\n  campaign: any,\r\n  recipients: CampaignRecipient[],\r\n  connection: MarketingConnection\r\n) {\r\n  return await Promise.allSettled(\r\n    recipients.map(recipient => \r\n      sendSMSMessage(supabase, campaign, recipient, connection)\r\n    )\r\n  );\r\n}\r\n\r\nasync function sendSMSMessage(\r\n  supabase: any,\r\n  campaign: any,\r\n  recipient: CampaignRecipient,\r\n  connection: MarketingConnection\r\n): Promise<{ success: boolean; error?: string }> {\r\n  const { provider, credentials, identifier } = connection;\r\n  \r\n  try {\r\n    await supabase\r\n      .from('campaign_recipients')\r\n      .update({ delivery_status: 'sending' })\r\n      .eq('id', recipient.id);\r\n\r\n    let result: { success: boolean; messageId?: string; error?: string };\r\n\r\n    switch (provider) {\r\n      case 'twilio':\r\n        result = await sendTwilioSMS(campaign, recipient, credentials, identifier);\r\n        break;\r\n      case 'messagebird':\r\n        result = await sendMessageBirdSMS(campaign, recipient, credentials, identifier);\r\n        break;\r\n      case 'vonage':\r\n        result = await sendVonageSMS(campaign, recipient, credentials, identifier);\r\n        break;\r\n      default:\r\n        result = { success: false, error: `Unsupported SMS provider: ${provider}` };\r\n    }\r\n\r\n    if (result.success) {\r\n      await supabase\r\n        .from('campaign_recipients')\r\n        .update({ \r\n          delivery_status: 'sent',\r\n          meta_message_id: result.messageId,\r\n          sent_at: new Date().toISOString()\r\n        })\r\n        .eq('id', recipient.id);\r\n\r\n      await logCampaignAction(supabase, campaign, 'SMS sent', 'sent', recipient.id);\r\n    } else {\r\n      await supabase\r\n        .from('campaign_recipients')\r\n        .update({ \r\n          delivery_status: 'failed',\r\n          error_message: result.error,\r\n          failed_at: new Date().toISOString()\r\n        })\r\n        .eq('id', recipient.id);\r\n\r\n      await logCampaignAction(supabase, campaign, `SMS failed: ${result.error}`, 'failed', recipient.id);\r\n    }\r\n\r\n    return result;\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : 'Unknown error';\r\n    console.error(`SMS send error:`, error);\r\n    \r\n    await supabase\r\n      .from('campaign_recipients')\r\n      .update({ delivery_status: 'failed', error_message: message, failed_at: new Date().toISOString() })\r\n      .eq('id', recipient.id);\r\n\r\n    return { success: false, error: message };\r\n  }\r\n}\r\n\r\nasync function sendTwilioSMS(campaign: any, recipient: CampaignRecipient, credentials: any, fromNumber: string) {\r\n  const { accountSid, authToken } = credentials;\r\n  \r\n  if (!accountSid || !authToken) {\r\n    return { success: false, error: 'Missing Twilio credentials' };\r\n  }\r\n\r\n  const templateContent = campaign.template_content || {};\r\n  let body = templateContent.body || 'Hello from our campaign!';\r\n  \r\n  body = body.replace(/\\{\\{name\\}\\}/gi, recipient.name || 'Customer');\r\n  body = body.replace(/\\{\\{phone\\}\\}/gi, recipient.phone_number);\r\n\r\n  const response = await fetch(\r\n    `https://api.twilio.com/2010-04-01/Accounts/${accountSid}/Messages.json`,\r\n    {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': 'Basic ' + btoa(`${accountSid}:${authToken}`),\r\n        'Content-Type': 'application/x-www-form-urlencoded',\r\n      },\r\n      body: new URLSearchParams({\r\n        From: fromNumber,\r\n        To: recipient.phone_number.replace(/[^0-9+]/g, ''),\r\n        Body: body,\r\n      }),\r\n    }\r\n  );\r\n\r\n  const result = await response.json();\r\n\r\n  if (!response.ok) {\r\n    return { success: false, error: result.message || 'Twilio API error' };\r\n  }\r\n\r\n  return { success: true, messageId: result.sid };\r\n}\r\n\r\nasync function sendMessageBirdSMS(campaign: any, recipient: CampaignRecipient, credentials: any, fromNumber: string) {\r\n  const { apiKey } = credentials;\r\n  \r\n  if (!apiKey) {\r\n    return { success: false, error: 'Missing MessageBird API key' };\r\n  }\r\n\r\n  const templateContent = campaign.template_content || {};\r\n  let body = templateContent.body || 'Hello from our campaign!';\r\n  \r\n  body = body.replace(/\\{\\{name\\}\\}/gi, recipient.name || 'Customer');\r\n\r\n  const response = await fetch('https://rest.messagebird.com/messages', {\r\n    method: 'POST',\r\n    headers: {\r\n      'Authorization': `AccessKey ${apiKey}`,\r\n      'Content-Type': 'application/json',\r\n    },\r\n    body: JSON.stringify({\r\n      originator: fromNumber,\r\n      recipients: [recipient.phone_number.replace(/[^0-9]/g, '')],\r\n      body,\r\n    }),\r\n  });\r\n\r\n  const result = await response.json();\r\n\r\n  if (!response.ok) {\r\n    return { success: false, error: result.errors?.[0]?.description || 'MessageBird API error' };\r\n  }\r\n\r\n  return { success: true, messageId: result.id };\r\n}\r\n\r\nasync function sendVonageSMS(campaign: any, recipient: CampaignRecipient, credentials: any, fromNumber: string) {\r\n  const { apiKey, apiSecret } = credentials;\r\n  \r\n  if (!apiKey || !apiSecret) {\r\n    return { success: false, error: 'Missing Vonage credentials' };\r\n  }\r\n\r\n  const templateContent = campaign.template_content || {};\r\n  let body = templateContent.body || 'Hello from our campaign!';\r\n  \r\n  body = body.replace(/\\{\\{name\\}\\}/gi, recipient.name || 'Customer');\r\n\r\n  const response = await fetch('https://rest.nexmo.com/sms/json', {\r\n    method: 'POST',\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n    },\r\n    body: JSON.stringify({\r\n      api_key: apiKey,\r\n      api_secret: apiSecret,\r\n      from: fromNumber,\r\n      to: recipient.phone_number.replace(/[^0-9]/g, ''),\r\n      text: body,\r\n    }),\r\n  });\r\n\r\n  const result = await response.json();\r\n\r\n  if (result.messages?.[0]?.status !== '0') {\r\n    return { success: false, error: result.messages?.[0]?.['error-text'] || 'Vonage API error' };\r\n  }\r\n\r\n  return { success: true, messageId: result.messages?.[0]?.['message-id'] };\r\n}\r\n\r\n// ==================== HELPERS ====================\r\nasync function logCampaignAction(\r\n  supabase: any, \r\n  campaign: any, \r\n  action: string, \r\n  actionType: string, \r\n  recipientId?: string\r\n) {\r\n  try {\r\n    await supabase.from('campaign_logs').insert({\r\n      campaign_id: campaign.id,\r\n      company_id: campaign.company_id,\r\n      action,\r\n      action_type: actionType,\r\n      recipient_id: recipientId,\r\n      details: { timestamp: new Date().toISOString() }\r\n    });\r\n  } catch (e) {\r\n    console.error('Failed to log campaign action:', e);\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\campaign-retry\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\campaign-scheduler\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\chatbot-chat\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\chatbot-manage\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":58,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2092,2095],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2092,2095],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":58,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2105,2108],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2105,2108],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":146,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":146,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5004,5007],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5004,5007],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":146,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":146,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5017,5020],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5017,5020],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":167,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":167,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5611,5614],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5611,5614],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":167,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":167,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5624,5627],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5624,5627],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":202,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":202,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6710,6713],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6710,6713],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":202,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":202,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6723,6726],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6723,6726],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":233,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":233,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7563,7566],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7563,7566],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":233,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":233,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7576,7579],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7576,7579],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":306,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":306,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9804,9807],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9804,9807],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":306,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":306,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9817,9820],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9817,9820],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":353,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":353,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11220,11223],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11220,11223],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":353,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":353,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11233,11236],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11233,11236],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":376,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":376,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11915,11918],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11915,11918],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":376,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":376,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11928,11931],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11928,11931],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":390,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":390,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12434,12437],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12434,12437],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":390,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":390,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12444,12447],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12444,12447],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":430,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":430,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13945,13948],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13945,13948],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":430,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":430,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13958,13961],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13958,13961],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":20,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';\r\n\r\nconst corsHeaders = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',\r\n};\r\n\r\n/**\r\n * Chatbot Management Edge Function\r\n * Handles chatbot deployment, message processing, and lead assignment\r\n */\r\nDeno.serve(async (req) => {\r\n  if (req.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;\r\n    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;\r\n    const supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n    const { action, ...params } = await req.json();\r\n\r\n    switch (action) {\r\n      case 'deploy':\r\n        return await deployChatbot(supabase, params);\r\n      case 'pause':\r\n        return await pauseChatbot(supabase, params);\r\n      case 'activate':\r\n        return await activateChatbot(supabase, params);\r\n      case 'deactivate':\r\n        return await deactivateChatbot(supabase, params);\r\n      case 'test_message':\r\n        return await testChatbotMessage(supabase, params);\r\n      case 'assign_leads':\r\n        return await assignLeadsToChatbot(supabase, params);\r\n      case 'unassign_leads':\r\n        return await unassignLeadsFromChatbot(supabase, params);\r\n      case 'get_stats':\r\n        return await getChatbotStats(supabase, params);\r\n      case 'get_interactions':\r\n        return await getChatbotInteractions(supabase, params);\r\n      default:\r\n        return new Response(JSON.stringify({ error: 'Invalid action' }), {\r\n          status: 400,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n  } catch (error) {\r\n    console.error('Chatbot management error:', error);\r\n    return new Response(JSON.stringify({ error: error instanceof Error ? error.message : 'Unknown error' }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n});\r\n\r\nasync function deployChatbot(supabase: any, params: any) {\r\n  const { chatbot_id, company_id, whatsapp_phone_number_id, user_id } = params;\r\n\r\n  if (!chatbot_id || !whatsapp_phone_number_id) {\r\n    return new Response(JSON.stringify({ error: 'chatbot_id and whatsapp_phone_number_id required' }), {\r\n      status: 400,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  // Validate WhatsApp phone number exists and is connected\r\n  const { data: phoneNumber, error: phoneError } = await supabase\r\n    .from('whatsapp_phone_numbers')\r\n    .select('id, phone_number, status, whatsapp_business_account_id')\r\n    .eq('id', whatsapp_phone_number_id)\r\n    .eq('company_id', company_id)\r\n    .single();\r\n\r\n  if (phoneError || !phoneNumber) {\r\n    return new Response(JSON.stringify({ error: 'WhatsApp number not found' }), {\r\n      status: 404,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  if (phoneNumber.status !== 'connected') {\r\n    return new Response(JSON.stringify({ error: 'WhatsApp number is not connected' }), {\r\n      status: 400,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  // Check if another chatbot is already deployed to this number\r\n  const { data: existingBot } = await supabase\r\n    .from('chatbots')\r\n    .select('id, name')\r\n    .eq('whatsapp_phone_number_id', whatsapp_phone_number_id)\r\n    .eq('status', 'active')\r\n    .neq('id', chatbot_id)\r\n    .single();\r\n\r\n  if (existingBot) {\r\n    return new Response(JSON.stringify({ \r\n      error: `Another chatbot \"${existingBot.name}\" is already deployed to this number` \r\n    }), {\r\n      status: 400,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  // Deploy chatbot\r\n  const { error: updateError } = await supabase\r\n    .from('chatbots')\r\n    .update({\r\n      whatsapp_phone_number_id,\r\n      status: 'active',\r\n      is_active: true,\r\n      deployed_at: new Date().toISOString()\r\n    })\r\n    .eq('id', chatbot_id);\r\n\r\n  if (updateError) {\r\n    console.error('Deploy error:', updateError);\r\n    return new Response(JSON.stringify({ error: 'Failed to deploy chatbot' }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  // Log the deployment\r\n  await supabase.rpc('log_chatbot_action', {\r\n    p_company_id: company_id,\r\n    p_chatbot_id: chatbot_id,\r\n    p_action_type: 'deploy',\r\n    p_description: `Chatbot deployed to WhatsApp number ${phoneNumber.phone_number}`,\r\n    p_details: { phone_number_id: whatsapp_phone_number_id },\r\n    p_performed_by: user_id\r\n  });\r\n\r\n  return new Response(JSON.stringify({ \r\n    success: true, \r\n    message: 'Chatbot deployed successfully',\r\n    phone_number: phoneNumber.phone_number\r\n  }), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\nasync function pauseChatbot(supabase: any, params: any) {\r\n  const { chatbot_id, company_id, user_id } = params;\r\n\r\n  await supabase\r\n    .from('chatbots')\r\n    .update({ status: 'paused' })\r\n    .eq('id', chatbot_id);\r\n\r\n  await supabase.rpc('log_chatbot_action', {\r\n    p_company_id: company_id,\r\n    p_chatbot_id: chatbot_id,\r\n    p_action_type: 'pause',\r\n    p_description: 'Chatbot paused',\r\n    p_performed_by: user_id\r\n  });\r\n\r\n  return new Response(JSON.stringify({ success: true, message: 'Chatbot paused' }), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\nasync function activateChatbot(supabase: any, params: any) {\r\n  const { chatbot_id, company_id, user_id } = params;\r\n\r\n  // Check if phone number is still assigned\r\n  const { data: chatbot } = await supabase\r\n    .from('chatbots')\r\n    .select('whatsapp_phone_number_id')\r\n    .eq('id', chatbot_id)\r\n    .single();\r\n\r\n  if (!chatbot?.whatsapp_phone_number_id) {\r\n    return new Response(JSON.stringify({ error: 'No WhatsApp number assigned. Deploy the chatbot first.' }), {\r\n      status: 400,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  await supabase\r\n    .from('chatbots')\r\n    .update({ status: 'active', is_active: true })\r\n    .eq('id', chatbot_id);\r\n\r\n  await supabase.rpc('log_chatbot_action', {\r\n    p_company_id: company_id,\r\n    p_chatbot_id: chatbot_id,\r\n    p_action_type: 'activate',\r\n    p_description: 'Chatbot activated',\r\n    p_performed_by: user_id\r\n  });\r\n\r\n  return new Response(JSON.stringify({ success: true, message: 'Chatbot activated' }), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\nasync function deactivateChatbot(supabase: any, params: any) {\r\n  const { chatbot_id, company_id, user_id } = params;\r\n\r\n  await supabase\r\n    .from('chatbots')\r\n    .update({ \r\n      status: 'inactive', \r\n      is_active: false,\r\n      whatsapp_phone_number_id: null \r\n    })\r\n    .eq('id', chatbot_id);\r\n\r\n  // End all active sessions\r\n  await supabase\r\n    .from('chatbot_sessions')\r\n    .delete()\r\n    .eq('chatbot_id', chatbot_id);\r\n\r\n  await supabase.rpc('log_chatbot_action', {\r\n    p_company_id: company_id,\r\n    p_chatbot_id: chatbot_id,\r\n    p_action_type: 'deactivate',\r\n    p_description: 'Chatbot deactivated and undeployed',\r\n    p_performed_by: user_id\r\n  });\r\n\r\n  return new Response(JSON.stringify({ success: true, message: 'Chatbot deactivated' }), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\nasync function testChatbotMessage(supabase: any, params: any) {\r\n  const { chatbot_id, test_phone, message } = params;\r\n\r\n  // Get chatbot config\r\n  const { data: chatbot, error } = await supabase\r\n    .from('chatbots')\r\n    .select(`\r\n      *,\r\n      whatsapp_phone_numbers!whatsapp_phone_number_id (\r\n        phone_number_id\r\n      ),\r\n      whatsapp_business_accounts:whatsapp_phone_numbers!whatsapp_phone_number_id (\r\n        whatsapp_business_account_id (\r\n          access_token_encrypted\r\n        )\r\n      )\r\n    `)\r\n    .eq('id', chatbot_id)\r\n    .single();\r\n\r\n  if (error || !chatbot) {\r\n    return new Response(JSON.stringify({ error: 'Chatbot not found' }), {\r\n      status: 404,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  // Send test message via Meta API\r\n  const phoneNumberId = chatbot.whatsapp_phone_numbers?.phone_number_id;\r\n  const accessToken = chatbot.whatsapp_business_accounts?.whatsapp_business_account_id?.access_token_encrypted;\r\n\r\n  if (!phoneNumberId || !accessToken) {\r\n    return new Response(JSON.stringify({ error: 'WhatsApp configuration incomplete' }), {\r\n      status: 400,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  const response = await fetch(\r\n    `https://graph.facebook.com/v18.0/${phoneNumberId}/messages`,\r\n    {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${accessToken}`,\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify({\r\n        messaging_product: 'whatsapp',\r\n        recipient_type: 'individual',\r\n        to: test_phone.replace(/[^0-9]/g, ''),\r\n        type: 'text',\r\n        text: { preview_url: false, body: message }\r\n      }),\r\n    }\r\n  );\r\n\r\n  const result = await response.json();\r\n\r\n  if (!response.ok) {\r\n    return new Response(JSON.stringify({ error: result.error?.message || 'Failed to send test message' }), {\r\n      status: 400,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  return new Response(JSON.stringify({ \r\n    success: true, \r\n    message_id: result.messages?.[0]?.id \r\n  }), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\nasync function assignLeadsToChatbot(supabase: any, params: any) {\r\n  const { chatbot_id, company_id, lead_ids, user_id } = params;\r\n\r\n  if (!lead_ids || lead_ids.length === 0) {\r\n    return new Response(JSON.stringify({ error: 'No leads specified' }), {\r\n      status: 400,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  const assignments = lead_ids.map((lead_id: string) => ({\r\n    company_id,\r\n    chatbot_id,\r\n    lead_id,\r\n    assigned_by: user_id,\r\n    status: 'active'\r\n  }));\r\n\r\n  const { error: insertError } = await supabase\r\n    .from('lead_chatbot_assignment')\r\n    .upsert(assignments, { onConflict: 'chatbot_id,lead_id' });\r\n\r\n  if (insertError) {\r\n    console.error('Assignment error:', insertError);\r\n    return new Response(JSON.stringify({ error: 'Failed to assign leads' }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  await supabase.rpc('log_chatbot_action', {\r\n    p_company_id: company_id,\r\n    p_chatbot_id: chatbot_id,\r\n    p_action_type: 'assign_lead',\r\n    p_description: `Assigned ${lead_ids.length} leads to chatbot`,\r\n    p_details: { lead_ids },\r\n    p_performed_by: user_id\r\n  });\r\n\r\n  return new Response(JSON.stringify({ \r\n    success: true, \r\n    assigned: lead_ids.length \r\n  }), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\nasync function unassignLeadsFromChatbot(supabase: any, params: any) {\r\n  const { chatbot_id, company_id, lead_ids, user_id } = params;\r\n\r\n  await supabase\r\n    .from('lead_chatbot_assignment')\r\n    .delete()\r\n    .eq('chatbot_id', chatbot_id)\r\n    .in('lead_id', lead_ids);\r\n\r\n  await supabase.rpc('log_chatbot_action', {\r\n    p_company_id: company_id,\r\n    p_chatbot_id: chatbot_id,\r\n    p_action_type: 'unassign_lead',\r\n    p_description: `Unassigned ${lead_ids.length} leads from chatbot`,\r\n    p_details: { lead_ids },\r\n    p_performed_by: user_id\r\n  });\r\n\r\n  return new Response(JSON.stringify({ success: true }), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\nasync function getChatbotStats(supabase: any, params: any) {\r\n  const { chatbot_id, date_from, date_to } = params;\r\n\r\n  const from = date_from || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];\r\n  const to = date_to || new Date().toISOString().split('T')[0];\r\n\r\n  const { data: analytics } = await supabase\r\n    .from('chatbot_analytics')\r\n    .select('*')\r\n    .eq('chatbot_id', chatbot_id)\r\n    .gte('date', from)\r\n    .lte('date', to)\r\n    .order('date', { ascending: true });\r\n\r\n  const totals = (analytics || []).reduce((acc: any, day: any) => ({\r\n    messages_sent: acc.messages_sent + (day.messages_sent || 0),\r\n    messages_received: acc.messages_received + (day.messages_received || 0),\r\n    messages_delivered: acc.messages_delivered + (day.messages_delivered || 0),\r\n    messages_read: acc.messages_read + (day.messages_read || 0),\r\n    messages_failed: acc.messages_failed + (day.messages_failed || 0),\r\n    unique_leads: acc.unique_leads + (day.unique_leads || 0),\r\n    new_leads_created: acc.new_leads_created + (day.new_leads_created || 0),\r\n  }), {\r\n    messages_sent: 0,\r\n    messages_received: 0,\r\n    messages_delivered: 0,\r\n    messages_read: 0,\r\n    messages_failed: 0,\r\n    unique_leads: 0,\r\n    new_leads_created: 0,\r\n  });\r\n\r\n  // Get active assignments count\r\n  const { count: activeAssignments } = await supabase\r\n    .from('lead_chatbot_assignment')\r\n    .select('id', { count: 'exact', head: true })\r\n    .eq('chatbot_id', chatbot_id)\r\n    .eq('status', 'active');\r\n\r\n  return new Response(JSON.stringify({\r\n    totals,\r\n    daily: analytics || [],\r\n    active_assignments: activeAssignments || 0,\r\n    delivery_rate: totals.messages_sent > 0 \r\n      ? ((totals.messages_delivered / totals.messages_sent) * 100).toFixed(2) \r\n      : 0,\r\n    read_rate: totals.messages_delivered > 0 \r\n      ? ((totals.messages_read / totals.messages_delivered) * 100).toFixed(2) \r\n      : 0\r\n  }), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\nasync function getChatbotInteractions(supabase: any, params: any) {\r\n  const { chatbot_id, lead_id, limit = 50, offset = 0 } = params;\r\n\r\n  let query = supabase\r\n    .from('chatbot_interactions')\r\n    .select(`\r\n      *,\r\n      leads:lead_id (id, name, phone, email)\r\n    `)\r\n    .eq('chatbot_id', chatbot_id)\r\n    .order('created_at', { ascending: false })\r\n    .range(offset, offset + limit - 1);\r\n\r\n  if (lead_id) {\r\n    query = query.eq('lead_id', lead_id);\r\n  }\r\n\r\n  const { data: interactions, error } = await query;\r\n\r\n  if (error) {\r\n    return new Response(JSON.stringify({ error: 'Failed to fetch interactions' }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  return new Response(JSON.stringify(interactions || []), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\chatbot-webhook\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":114,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":114,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3672,3675],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3672,3675],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":337,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":337,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10580,10583],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10580,10583],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":337,"column":84,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":337,"endColumn":87,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10620,10623],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10620,10623],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":394,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":394,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12509,12512],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12509,12512],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":451,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":451,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14258,14261],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14258,14261],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":451,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":451,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14271,14274],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14271,14274],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":458,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":458,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14468,14471],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14468,14471],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';\r\n\r\nconst corsHeaders = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',\r\n};\r\n\r\ninterface IncomingMessage {\r\n  from: string;\r\n  id: string;\r\n  timestamp: string;\r\n  type: string;\r\n  text?: { body: string };\r\n  image?: { id: string; caption?: string };\r\n  document?: { id: string; filename?: string };\r\n}\r\n\r\ninterface WebhookPayload {\r\n  object: string;\r\n  entry: Array<{\r\n    id: string;\r\n    changes: Array<{\r\n      field: string;\r\n      value: {\r\n        messaging_product: string;\r\n        metadata: { display_phone_number: string; phone_number_id: string };\r\n        contacts?: Array<{ profile: { name: string }; wa_id: string }>;\r\n        messages?: IncomingMessage[];\r\n        statuses?: Array<{\r\n          id: string;\r\n          status: string;\r\n          timestamp: string;\r\n          recipient_id: string;\r\n          errors?: Array<{ code: number; message: string }>;\r\n        }>;\r\n      };\r\n    }>;\r\n  }>;\r\n}\r\n\r\n/**\r\n * WhatsApp Chatbot Webhook Handler\r\n * Processes incoming messages and routes them to active chatbots\r\n */\r\nDeno.serve(async (req) => {\r\n  // Handle webhook verification\r\n  if (req.method === 'GET') {\r\n    const url = new URL(req.url);\r\n    const mode = url.searchParams.get('hub.mode');\r\n    const token = url.searchParams.get('hub.verify_token');\r\n    const challenge = url.searchParams.get('hub.challenge');\r\n    const verifyToken = Deno.env.get('META_WEBHOOK_VERIFY_TOKEN') || 'onelinker_chatbot_webhook';\r\n\r\n    if (mode === 'subscribe' && token === verifyToken) {\r\n      console.log('Chatbot webhook verified');\r\n      return new Response(challenge, { status: 200 });\r\n    }\r\n    return new Response('Forbidden', { status: 403 });\r\n  }\r\n\r\n  if (req.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  if (req.method !== 'POST') {\r\n    return new Response('Method not allowed', { status: 405 });\r\n  }\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;\r\n    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;\r\n    const supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n    const payload: WebhookPayload = await req.json();\r\n    console.log('Chatbot webhook received:', JSON.stringify(payload).slice(0, 500));\r\n\r\n    for (const entry of payload.entry || []) {\r\n      for (const change of entry.changes || []) {\r\n        if (change.field === 'messages') {\r\n          const { metadata, messages, statuses, contacts } = change.value;\r\n          const phoneNumberId = metadata.phone_number_id;\r\n\r\n          // Process status updates\r\n          if (statuses) {\r\n            for (const status of statuses) {\r\n              await processStatusUpdate(supabase, status);\r\n            }\r\n          }\r\n\r\n          // Process incoming messages\r\n          if (messages) {\r\n            for (const message of messages) {\r\n              const contact = contacts?.find(c => c.wa_id === message.from);\r\n              await processIncomingMessage(supabase, message, phoneNumberId, contact?.profile?.name);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return new Response(JSON.stringify({ success: true }), {\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  } catch (error) {\r\n    console.error('Chatbot webhook error:', error);\r\n    return new Response(JSON.stringify({ error: 'Processing failed' }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n});\r\n\r\nasync function processIncomingMessage(\r\n  supabase: any,\r\n  message: IncomingMessage,\r\n  phoneNumberId: string,\r\n  senderName?: string\r\n) {\r\n  const startTime = Date.now();\r\n  const senderPhone = message.from;\r\n  const messageContent = message.text?.body || `[${message.type}]`;\r\n\r\n  console.log(`Processing message from ${senderPhone}: ${messageContent.slice(0, 100)}`);\r\n\r\n  // Find company and active chatbot for this phone number\r\n  const { data: phoneData } = await supabase\r\n    .from('whatsapp_phone_numbers')\r\n    .select('id, company_id, phone_number_id')\r\n    .eq('phone_number_id', phoneNumberId)\r\n    .single();\r\n\r\n  if (!phoneData) {\r\n    console.log('Phone number not found in system:', phoneNumberId);\r\n    return;\r\n  }\r\n\r\n  const companyId = phoneData.company_id;\r\n\r\n  // Find active chatbot for this phone number\r\n  const { data: chatbot } = await supabase\r\n    .from('chatbots')\r\n    .select(`\r\n      id, name, system_prompt, welcome_message, fallback_message,\r\n      llm_provider, llm_model, max_tokens, temperature, auto_create_leads,\r\n      qualification_questions, business_hours_only, business_hours\r\n    `)\r\n    .eq('whatsapp_phone_number_id', phoneData.id)\r\n    .eq('status', 'active')\r\n    .eq('is_active', true)\r\n    .single();\r\n\r\n  if (!chatbot) {\r\n    console.log('No active chatbot found for phone number:', phoneNumberId);\r\n    return;\r\n  }\r\n\r\n  // Check business hours if required\r\n  if (chatbot.business_hours_only && chatbot.business_hours) {\r\n    const now = new Date();\r\n    const currentHour = now.getUTCHours();\r\n    const currentDay = now.getUTCDay();\r\n    const hours = chatbot.business_hours;\r\n    \r\n    // Simple check - can be enhanced\r\n    if (hours.start && hours.end) {\r\n      if (currentHour < hours.start || currentHour >= hours.end) {\r\n        console.log('Outside business hours, skipping');\r\n        return;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Find or create lead\r\n  let leadId: string | null = null;\r\n  \r\n  // Check if lead exists\r\n  const { data: existingLead } = await supabase\r\n    .from('leads')\r\n    .select('id, opted_in_whatsapp')\r\n    .eq('company_id', companyId)\r\n    .or(`phone.eq.${senderPhone},normalized_phone.eq.${senderPhone.replace(/[^0-9]/g, '')}`)\r\n    .single();\r\n\r\n  if (existingLead) {\r\n    leadId = existingLead.id;\r\n    \r\n    // Check opt-in\r\n    if (existingLead.opted_in_whatsapp === false) {\r\n      console.log('Lead has opted out of WhatsApp messages');\r\n      return;\r\n    }\r\n  } else if (chatbot.auto_create_leads) {\r\n    // Create new lead\r\n    const { data: newLead } = await supabase.rpc('find_or_create_lead_from_phone', {\r\n      p_company_id: companyId,\r\n      p_phone_number: senderPhone,\r\n      p_name: senderName || 'WhatsApp Lead',\r\n      p_source: `WhatsApp Bot: ${chatbot.name}`\r\n    });\r\n    \r\n    leadId = newLead;\r\n    \r\n    // Update analytics\r\n    await supabase.rpc('update_chatbot_analytics', {\r\n      p_chatbot_id: chatbot.id,\r\n      p_company_id: companyId,\r\n      p_field: 'new_leads_created'\r\n    });\r\n  }\r\n\r\n  // Get or create session\r\n  const sessionId = await supabase.rpc('get_or_create_chatbot_session', {\r\n    p_company_id: companyId,\r\n    p_chatbot_id: chatbot.id,\r\n    p_phone_number: senderPhone,\r\n    p_lead_id: leadId\r\n  });\r\n\r\n  // Check if this is first message in session\r\n  const { data: sessionData } = await supabase\r\n    .from('chatbot_sessions')\r\n    .select('current_sequence_step, session_state')\r\n    .eq('id', sessionId)\r\n    .single();\r\n\r\n  const isFirstMessage = sessionData?.current_sequence_step === 0;\r\n\r\n  // Log inbound interaction\r\n  await supabase.from('chatbot_interactions').insert({\r\n    company_id: companyId,\r\n    chatbot_id: chatbot.id,\r\n    lead_id: leadId,\r\n    phone_number: senderPhone,\r\n    direction: 'inbound',\r\n    message_type: message.type,\r\n    message_content: messageContent,\r\n    message_data: message,\r\n    meta_message_id: message.id,\r\n    status: 'delivered'\r\n  });\r\n\r\n  // Update analytics\r\n  await supabase.rpc('update_chatbot_analytics', {\r\n    p_chatbot_id: chatbot.id,\r\n    p_company_id: companyId,\r\n    p_field: 'messages_received'\r\n  });\r\n\r\n  // Match trigger\r\n  const { data: trigger } = await supabase.rpc('match_chatbot_trigger', {\r\n    p_chatbot_id: chatbot.id,\r\n    p_message: messageContent,\r\n    p_is_first_message: isFirstMessage\r\n  });\r\n\r\n  let responseMessage: string;\r\n\r\n  if (trigger && trigger.length > 0) {\r\n    const matchedTrigger = trigger[0];\r\n    \r\n    if (matchedTrigger.response_message_id) {\r\n      // Get message from chatbot_messages\r\n      const { data: messageData } = await supabase\r\n        .from('chatbot_messages')\r\n        .select('content')\r\n        .eq('id', matchedTrigger.response_message_id)\r\n        .single();\r\n      \r\n      responseMessage = messageData?.content?.text || chatbot.fallback_message;\r\n    } else if (matchedTrigger.trigger_type === 'first_message') {\r\n      responseMessage = chatbot.welcome_message || 'Hello! How can I help you?';\r\n    } else {\r\n      responseMessage = chatbot.fallback_message;\r\n    }\r\n  } else {\r\n    // Use AI if configured\r\n    if (chatbot.llm_provider && chatbot.system_prompt) {\r\n      responseMessage = await generateAIResponse(chatbot, messageContent, sessionData?.session_state);\r\n    } else {\r\n      responseMessage = chatbot.fallback_message;\r\n    }\r\n  }\r\n\r\n  // Send response\r\n  const sendResult = await sendWhatsAppMessage(supabase, companyId, phoneNumberId, senderPhone, responseMessage);\r\n  \r\n  const responseTime = Date.now() - startTime;\r\n\r\n  // Log outbound interaction\r\n  await supabase.from('chatbot_interactions').insert({\r\n    company_id: companyId,\r\n    chatbot_id: chatbot.id,\r\n    lead_id: leadId,\r\n    phone_number: senderPhone,\r\n    direction: 'outbound',\r\n    message_type: 'text',\r\n    message_content: responseMessage,\r\n    meta_message_id: sendResult?.messageId,\r\n    status: sendResult?.success ? 'sent' : 'failed',\r\n    error_message: sendResult?.error,\r\n    trigger_id: trigger?.[0]?.trigger_id,\r\n    response_time_ms: responseTime\r\n  });\r\n\r\n  // Update analytics\r\n  await supabase.rpc('update_chatbot_analytics', {\r\n    p_chatbot_id: chatbot.id,\r\n    p_company_id: companyId,\r\n    p_field: sendResult?.success ? 'messages_sent' : 'messages_failed'\r\n  });\r\n\r\n  // Update session\r\n  await supabase\r\n    .from('chatbot_sessions')\r\n    .update({\r\n      current_sequence_step: (sessionData?.current_sequence_step || 0) + 1,\r\n      last_message_at: new Date().toISOString()\r\n    })\r\n    .eq('id', sessionId);\r\n\r\n  // Update lead assignment stats\r\n  if (leadId) {\r\n    await supabase\r\n      .from('lead_chatbot_assignment')\r\n      .update({\r\n        last_interaction_at: new Date().toISOString(),\r\n        messages_received: supabase.rpc('increment_one'),\r\n        messages_sent: supabase.rpc('increment_one')\r\n      })\r\n      .eq('chatbot_id', chatbot.id)\r\n      .eq('lead_id', leadId);\r\n  }\r\n\r\n  console.log(`Processed message in ${responseTime}ms`);\r\n}\r\n\r\nasync function generateAIResponse(chatbot: any, userMessage: string, sessionState: any): Promise<string> {\r\n  const openaiKey = Deno.env.get('OPENAI_API_KEY');\r\n  const anthropicKey = Deno.env.get('ANTHROPIC_API_KEY');\r\n  \r\n  const provider = chatbot.llm_provider || 'openai';\r\n  const model = chatbot.llm_model || 'gpt-4o-mini';\r\n  \r\n  try {\r\n    if (provider === 'openai' && openaiKey) {\r\n      const response = await fetch('https://api.openai.com/v1/chat/completions', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Authorization': `Bearer ${openaiKey}`,\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({\r\n          model,\r\n          messages: [\r\n            { role: 'system', content: chatbot.system_prompt },\r\n            { role: 'user', content: userMessage }\r\n          ],\r\n          max_tokens: chatbot.max_tokens || 500,\r\n          temperature: chatbot.temperature || 0.7\r\n        })\r\n      });\r\n\r\n      const result = await response.json();\r\n      return result.choices?.[0]?.message?.content || chatbot.fallback_message;\r\n    }\r\n    \r\n    if (provider === 'anthropic' && anthropicKey) {\r\n      const response = await fetch('https://api.anthropic.com/v1/messages', {\r\n        method: 'POST',\r\n        headers: {\r\n          'x-api-key': anthropicKey,\r\n          'anthropic-version': '2023-06-01',\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({\r\n          model: model || 'claude-3-haiku-20240307',\r\n          max_tokens: chatbot.max_tokens || 500,\r\n          system: chatbot.system_prompt,\r\n          messages: [{ role: 'user', content: userMessage }]\r\n        })\r\n      });\r\n\r\n      const result = await response.json();\r\n      return result.content?.[0]?.text || chatbot.fallback_message;\r\n    }\r\n  } catch (error) {\r\n    console.error('AI generation error:', error);\r\n  }\r\n\r\n  return chatbot.fallback_message;\r\n}\r\n\r\nasync function sendWhatsAppMessage(\r\n  supabase: any,\r\n  companyId: string,\r\n  phoneNumberId: string,\r\n  to: string,\r\n  message: string\r\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\r\n  try {\r\n    // Get access token\r\n    const { data: phoneNumber } = await supabase\r\n      .from('whatsapp_phone_numbers')\r\n      .select(`\r\n        whatsapp_business_account_id,\r\n        whatsapp_business_accounts!whatsapp_business_account_id (\r\n          access_token_encrypted\r\n        )\r\n      `)\r\n      .eq('phone_number_id', phoneNumberId)\r\n      .eq('company_id', companyId)\r\n      .single();\r\n\r\n    const accessToken = phoneNumber?.whatsapp_business_accounts?.access_token_encrypted;\r\n    \r\n    if (!accessToken) {\r\n      return { success: false, error: 'No access token found' };\r\n    }\r\n\r\n    const response = await fetch(\r\n      `https://graph.facebook.com/v18.0/${phoneNumberId}/messages`,\r\n      {\r\n        method: 'POST',\r\n        headers: {\r\n          'Authorization': `Bearer ${accessToken}`,\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify({\r\n          messaging_product: 'whatsapp',\r\n          recipient_type: 'individual',\r\n          to: to.replace(/[^0-9]/g, ''),\r\n          type: 'text',\r\n          text: { preview_url: false, body: message }\r\n        }),\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n\r\n    if (!response.ok) {\r\n      return { success: false, error: result.error?.message || 'Send failed' };\r\n    }\r\n\r\n    return { success: true, messageId: result.messages?.[0]?.id };\r\n  } catch (error) {\r\n    console.error('WhatsApp send error:', error);\r\n    return { success: false, error: error instanceof Error ? error.message : 'Unknown error' };\r\n  }\r\n}\r\n\r\nasync function processStatusUpdate(supabase: any, status: any) {\r\n  const messageId = status.id;\r\n  const statusType = status.status;\r\n\r\n  console.log(`Status update: ${messageId} -> ${statusType}`);\r\n\r\n  // Update interaction status\r\n  const updateData: any = { status: statusType };\r\n  \r\n  if (statusType === 'failed' && status.errors?.[0]) {\r\n    updateData.error_message = status.errors[0].message;\r\n  }\r\n\r\n  await supabase\r\n    .from('chatbot_interactions')\r\n    .update(updateData)\r\n    .eq('meta_message_id', messageId);\r\n\r\n  // Update analytics\r\n  if (statusType === 'delivered' || statusType === 'read') {\r\n    const { data: interaction } = await supabase\r\n      .from('chatbot_interactions')\r\n      .select('chatbot_id, company_id')\r\n      .eq('meta_message_id', messageId)\r\n      .single();\r\n\r\n    if (interaction) {\r\n      const field = statusType === 'delivered' ? 'messages_delivered' : 'messages_read';\r\n      await supabase.rpc('update_chatbot_analytics', {\r\n        p_chatbot_id: interaction.chatbot_id,\r\n        p_company_id: interaction.company_id,\r\n        p_field: field\r\n      });\r\n    }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\connection-manage\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\export-leads\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":183,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":183,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6623,6626],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6623,6626],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { serve } from \"https://deno.land/std@0.190.0/http/server.ts\";\r\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2\";\r\nimport { Resend } from \"https://esm.sh/resend@2.0.0\";\r\n\r\nconst corsHeaders = {\r\n    \"Access-Control-Allow-Origin\": \"*\",\r\n    \"Access-Control-Allow-Headers\": \"authorization, x-client-info, apikey, content-type\",\r\n};\r\n\r\ninterface ExportLeadsRequest {\r\n    filters: {\r\n        agent_id?: string;\r\n        stage?: string;\r\n        source?: string;\r\n        date_from?: string;\r\n        date_to?: string;\r\n        budget_min?: number;\r\n        budget_max?: number;\r\n        country?: string;\r\n        tags?: string[];\r\n    };\r\n}\r\n\r\nconst handler = async (req: Request): Promise<Response> => {\r\n    if (req.method === \"OPTIONS\") {\r\n        return new Response(null, { headers: corsHeaders });\r\n    }\r\n\r\n    try {\r\n        const supabaseUrl = Deno.env.get(\"SUPABASE_URL\")!;\r\n        const supabaseServiceKey = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!;\r\n        const supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n        // Get the requester's user ID from the JWT\r\n        const authHeader = req.headers.get(\"Authorization\")!;\r\n        const token = authHeader.replace(\"Bearer \", \"\");\r\n        const { data: { user }, error: authError } = await supabase.auth.getUser(token);\r\n\r\n        if (authError || !user) {\r\n            throw new Error(\"Unauthorized\");\r\n        }\r\n\r\n        const { filters }: ExportLeadsRequest = await req.json();\r\n\r\n        // 1. Check Rate Limit\r\n        const { data: canExport, error: rateLimitError } = await supabase.rpc('check_export_rate_limit', {\r\n            p_user_id: user.id\r\n        });\r\n\r\n        if (rateLimitError) throw rateLimitError;\r\n        if (!canExport) {\r\n            return new Response(JSON.stringify({ error: \"Rate limit exceeded. Max 3 exports per hour.\" }), {\r\n                status: 429,\r\n                headers: { \"Content-Type\": \"application/json\", ...corsHeaders },\r\n            });\r\n        }\r\n\r\n        // 2. Get User's Company info\r\n        const { data: profile, error: profileError } = await supabase\r\n            .from(\"profiles\")\r\n            .select(\"company_id\")\r\n            .eq(\"id\", user.id)\r\n            .single();\r\n\r\n        if (profileError || !profile?.company_id) {\r\n            throw new Error(\"User has no associated company\");\r\n        }\r\n\r\n        const { data: company, error: companyError } = await supabase\r\n            .from(\"companies\")\r\n            .select(\"name, main_email\")\r\n            .eq(\"id\", profile.company_id)\r\n            .single();\r\n\r\n        if (companyError || !company?.main_email) {\r\n            throw new Error(\"Company has no verified main email address configured\");\r\n        }\r\n\r\n        // 3. Query Leads with Filters\r\n        let query = supabase\r\n            .from(\"leads\")\r\n            .select(`\r\n        *,\r\n        agent:agents!assigned_agent_id (name),\r\n        lead_stage:lead_stages!stage_id (name)\r\n      `)\r\n            .eq(\"company_id\", profile.company_id);\r\n\r\n        if (filters.agent_id && filters.agent_id !== 'all') {\r\n            query = query.eq(\"assigned_agent_id\", filters.agent_id);\r\n        }\r\n        if (filters.stage && filters.stage !== 'all') {\r\n            query = query.eq(\"stage\", filters.stage);\r\n        }\r\n        if (filters.source && filters.source !== 'all') {\r\n            query = query.eq(\"source\", filters.source);\r\n        }\r\n        if (filters.date_from) {\r\n            query = query.gte(\"created_at\", filters.date_from);\r\n        }\r\n        if (filters.date_to) {\r\n            query = query.lte(\"created_at\", filters.date_to);\r\n        }\r\n        if (filters.budget_min !== undefined) {\r\n            query = query.gte(\"budget\", filters.budget_min);\r\n        }\r\n        if (filters.budget_max !== undefined) {\r\n            query = query.lte(\"budget\", filters.budget_max);\r\n        }\r\n        // Nationality/Location filter if available in schema\r\n        if (filters.country) {\r\n            query = query.or(`location.ilike.%${filters.country}%,nationality.ilike.%${filters.country}%`);\r\n        }\r\n\r\n        const { data: leads, error: leadsError } = await query;\r\n\r\n        if (leadsError) throw leadsError;\r\n\r\n        // 4. Generate CSV\r\n        const headers = [\r\n            \"ID\", \"Name\", \"Email\", \"Phone\", \"Status\", \"Stage\", \"Source\",\r\n            \"Owner\", \"Budget\", \"Location\", \"Nationality\", \"Created At\", \"Updated At\"\r\n        ];\r\n\r\n        const rows = (leads || []).map(l => [\r\n            l.id,\r\n            l.name,\r\n            l.email || \"\",\r\n            l.phone || \"\",\r\n            l.status || \"\",\r\n            l.lead_stage?.name || l.stage || \"\",\r\n            l.source || \"\",\r\n            l.agent?.name || \"Unassigned\",\r\n            l.budget || \"\",\r\n            l.location || \"\",\r\n            l.nationality || \"\",\r\n            l.created_at,\r\n            l.updated_at\r\n        ]);\r\n\r\n        const csvContent = [\r\n            headers.join(\",\"),\r\n            ...rows.map(row => row.map(cell => `\"${String(cell).replace(/\"/g, '\"\"')}\"`).join(\",\"))\r\n        ].join(\"\\n\");\r\n\r\n        // 5. Send Email\r\n        const resend = new Resend(Deno.env.get(\"RESEND_API_KEY\"));\r\n        const emailResponse = await resend.emails.send({\r\n            from: \"Onelinker CRM <exports@resend.dev>\",\r\n            to: [company.main_email],\r\n            subject: `Lead Export: ${company.name} - ${new Date().toLocaleDateString()}`,\r\n            html: `\r\n        <h1>Lead Export Generated</h1>\r\n        <p>A lead export was requested by ${user.email}.</p>\r\n        <p>Attached is the CSV file containing ${rows.length} leads matching your criteria.</p>\r\n        <br/>\r\n        <p><strong>Filter Criteria:</strong> ${JSON.stringify(filters)}</p>\r\n        <p>Sent to company main email as per security policy.</p>\r\n      `,\r\n            attachments: [\r\n                {\r\n                    filename: `leads_export_${new Date().toISOString().split('T')[0]}.csv`,\r\n                    content: btoa(csvContent),\r\n                },\r\n            ],\r\n        });\r\n\r\n        // 6. Audit Log\r\n        await supabase.from(\"export_logs\").insert({\r\n            user_id: user.id,\r\n            company_id: profile.company_id,\r\n            entity_type: \"leads\",\r\n            filter_criteria: filters,\r\n            record_count: rows.length,\r\n            recipient_email: company.main_email,\r\n            status: \"completed\"\r\n        });\r\n\r\n        return new Response(JSON.stringify({ success: true, count: rows.length }), {\r\n            headers: { \"Content-Type\": \"application/json\", ...corsHeaders },\r\n        });\r\n\r\n    } catch (error: any) {\r\n        console.error(\"Export error:\", error);\r\n        return new Response(JSON.stringify({ error: error.message }), {\r\n            status: 500,\r\n            headers: { \"Content-Type\": \"application/json\", ...corsHeaders },\r\n        });\r\n    }\r\n};\r\n\r\nserve(handler);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\feed-generator\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":95,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4146,4149],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4146,4149],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { serve } from \"https://deno.land/std@0.168.0/http/server.ts\";\r\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2\";\r\n\r\nconst corsHeaders = {\r\n    \"Access-Control-Allow-Origin\": \"*\",\r\n    \"Access-Control-Allow-Headers\": \"authorization, x-client-info, apikey, content-type\",\r\n};\r\n\r\nserve(async (req) => {\r\n    if (req.method === \"OPTIONS\") {\r\n        return new Response(null, { headers: corsHeaders });\r\n    }\r\n\r\n    try {\r\n        const url = new URL(req.url);\r\n        const companyId = url.searchParams.get(\"company_id\");\r\n        const portal = url.searchParams.get(\"portal\") || \"generic\";\r\n\r\n        // Supabase client setup\r\n        const supabaseUrl = Deno.env.get(\"SUPABASE_URL\")!;\r\n        const supabaseServiceKey = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!;\r\n        const supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n        if (!companyId) {\r\n            return new Response(\"Missing company_id parameter\", { status: 400 });\r\n        }\r\n\r\n        // Fetch publications for this portal that are \"live\"\r\n        const { data: publications, error: pubError } = await supabase\r\n            .from(\"portal_listing_publications\")\r\n            .select(`\r\n        portal_listing_id,\r\n        listing:listings (\r\n          id, reference_number, title, description, price, currency,\r\n          property_type, listing_type, number_of_bedrooms, number_of_bathrooms,\r\n          area_size, area_unit, address, city, country,\r\n          images, amenities, permit_number,\r\n          agent:agents (name, email, phone, license_number, avatar_url),\r\n          updated_at, created_at\r\n        )\r\n      `)\r\n            .eq(\"company_id\", companyId)\r\n            .eq(\"status\", \"live\")\r\n            .eq(\"is_deleted\", false);\r\n\r\n        // Note: We might want to filter by portal_id if needed, but for now we assume \r\n        // the user wants all listings approved for *any* feed-based portal?\r\n        // Actually, usually a feed is specific to a portal because often we publish subsets.\r\n        // However, for simplicity V1, let's fetch ALL \"live\" publications for the requested portal type if passed,\r\n        // or better yet, fetch by portal_id if passed.\r\n\r\n        // If we passed 'portal=bayut', we should probably look up the portal ID or just use the string if we stored slug.\r\n        // Let's assume we filter by the portal_id in publications if possible.\r\n        // Since we don't have the ID handy from the URL string easily without a lookup, \r\n        // let's stick to the publications.portal_id matching if the user passed a UUID.\r\n        // If the user passed 'bayut', we need to resolve it. \r\n\r\n        // For this iteration, let's just fetch ALL listings that have ANY publication record \r\n        // where the portal name matches or just ALL live listings for the company \r\n        // that are marked for XML feed distribution?\r\n\r\n        // Simpler approach: Join with 'portals' table to filter by name.\r\n\r\n        let query = supabase\r\n            .from(\"portal_listing_publications\")\r\n            .select(`\r\n        portal_title, portal_description, portal_price, portal_images,\r\n        listing:listings (\r\n            id, reference_number, title, description, price, currency,\r\n            property_type, listing_type, number_of_bedrooms, number_of_bathrooms,\r\n            area_size, area_unit, address, city, country, location,\r\n            images, amenities, permit_number,\r\n            agent:agents (name, email, phone, license_number, avatar_url),\r\n            updated_at, created_at\r\n        ),\r\n        portals!inner(name)\r\n      `)\r\n            .eq(\"company_id\", companyId)\r\n            .eq(\"status\", \"live\")\r\n            .eq(\"is_deleted\", false);\r\n\r\n        if (portal && portal !== \"generic\") {\r\n            query = query.ilike(\"portals.name\", `%${portal}%`);\r\n        }\r\n\r\n        const { data: items, error } = await query;\r\n\r\n        if (error) {\r\n            return new Response(JSON.stringify(error), { status: 500, headers: corsHeaders });\r\n        }\r\n\r\n        // Generate XML\r\n        const xml = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<list>\r\n    ${items.map((item: any) => {\r\n            const l = item.listing;\r\n            if (!l) return \"\";\r\n\r\n            const title = item.portal_title || l.title;\r\n            const desc = item.portal_description || l.description;\r\n            const price = item.portal_price || l.price;\r\n            const images = item.portal_images || l.images || [];\r\n            const agent = l.agent || {};\r\n\r\n            const lastUpdate = l.updated_at ? l.updated_at.replace(\"T\", \" \").split(\".\")[0] : \"\";\r\n\r\n            return `\r\n    <property last_update=\"${lastUpdate}\" id=\"${l.id}\">\r\n        <reference_number>${escapeXml(l.reference_number || l.id)}</reference_number>\r\n        <permit_number>${escapeXml(l.permit_number || \"\")}</permit_number>\r\n        <offering_type>${l.listing_type === \"Rent\" ? \"RR\" : \"CS\"}</offering_type>\r\n        <property_type>${escapeXml(l.property_type || \"Apartment\")}</property_type>\r\n        <price_on_application>${price ? \"0\" : \"1\"}</price_on_application>\r\n        <price>${price || 0}</price>\r\n        <service_charge>0</service_charge>\r\n        <cheques>4</cheques>\r\n        <city>${escapeXml(l.city || l.address || \"\")}</city>\r\n        <community>${escapeXml(l.location || \"\")}</community>\r\n        <sub_community></sub_community>\r\n        <title_en><![CDATA[${title || \"\"}]]></title_en>\r\n        <description_en><![CDATA[${desc || \"\"}]]></description_en>\r\n        <bedroom>${l.number_of_bedrooms || 0}</bedroom>\r\n        <bathroom>${l.number_of_bathrooms || 0}</bathroom>\r\n        <size>${l.area_size || 0}</size>\r\n        <agent>\r\n            <id>${agent.employee_number || agent.email || \"1\"}</id>\r\n            <name><![CDATA[${agent.name || \"Agent\"}]]></name>\r\n            <email>${agent.email || \"\"}</email>\r\n            <phone>${agent.phone || \"\"}</phone>\r\n            <photo>${agent.avatar_url || \"\"}</photo>\r\n        </agent>\r\n        <photo>\r\n            ${images.map((img: string, i: number) => `\r\n            <url last_update=\"${lastUpdate}\" watermark=\"1\">${escapeXml(img)}</url>\r\n            `).join(\"\")}\r\n        </photo>\r\n        <geopoint>${l.latitude || \"\"},${l.longitude || \"\"}</geopoint>\r\n        <amenities>\r\n           ${(l.amenities || []).map((a: string) => `<amenity>${escapeXml(a)}</amenity>`).join(\"\")}\r\n        </amenities>\r\n    </property>`;\r\n        }).join(\"\\n\")}\r\n</list>`;\r\n\r\n        // Return XML response\r\n        return new Response(xml, {\r\n            headers: {\r\n                ...corsHeaders,\r\n                \"Content-Type\": \"application/xml; charset=utf-8\",\r\n                \"Cache-Control\": \"max-age=300\", // Cache for 5 mins\r\n            },\r\n        });\r\n\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({ error: error.message }), {\r\n            status: 500,\r\n            headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\r\n        });\r\n    }\r\n});\r\n\r\nfunction escapeXml(unsafe: string): string {\r\n    if (typeof unsafe !== 'string') return '';\r\n    return unsafe.replace(/[<>&'\"]/g, (c) => {\r\n        switch (c) {\r\n            case '<': return '&lt;';\r\n            case '>': return '&gt;';\r\n            case '&': return '&amp;';\r\n            case '\\'': return '&apos;';\r\n            case '\"': return '&quot;';\r\n            default: return c;\r\n        }\r\n    });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\fetch-property-finder-leads\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\invite-agent\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":121,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4576,4579],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4576,4579],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { serve } from \"https://deno.land/std@0.190.0/http/server.ts\";\r\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2\";\r\nimport { Resend } from \"https://esm.sh/resend@2.0.0\";\r\n\r\nconst resend = new Resend(Deno.env.get(\"RESEND_API_KEY\"));\r\n\r\nconst corsHeaders = {\r\n  \"Access-Control-Allow-Origin\": \"*\",\r\n  \"Access-Control-Allow-Headers\": \"authorization, x-client-info, apikey, content-type\",\r\n};\r\n\r\ninterface InviteAgentRequest {\r\n  name: string;\r\n  email: string;\r\n  phone?: string;\r\n  role: string;\r\n  team_id?: string;\r\n  permissions: Record<string, boolean>;\r\n}\r\n\r\nconst handler = async (req: Request): Promise<Response> => {\r\n  // Handle CORS preflight requests\r\n  if (req.method === \"OPTIONS\") {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get(\"SUPABASE_URL\") ?? Deno.env.get(\"PROJECT_URL\")!;\r\n    const supabaseServiceKey = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\") ?? Deno.env.get(\"SERVICE_ROLE_KEY\")!;\r\n    const supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n    const { name, email, phone, role, team_id, permissions }: InviteAgentRequest = await req.json();\r\n\r\n    console.log(\"Inviting agent:\", { name, email, role, team_id });\r\n\r\n    // Generate invitation token\r\n    const invitationToken = crypto.randomUUID();\r\n\r\n    // Create agent record with 'invited' status\r\n    const { data: agent, error: agentError } = await supabase\r\n      .from(\"agents\")\r\n      .insert({\r\n        name,\r\n        email,\r\n        phone,\r\n        role,\r\n        team_id,\r\n        permissions,\r\n        status: \"invited\",\r\n        invitation_token: invitationToken,\r\n        invitation_sent_at: new Date().toISOString(),\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (agentError) {\r\n      console.error(\"Error creating agent:\", agentError);\r\n      throw new Error(agentError.message);\r\n    }\r\n\r\n    console.log(\"Agent created:\", agent.id);\r\n\r\n    // Get site URL for invitation link\r\n    const siteUrl = Deno.env.get(\"SITE_URL\") || `${supabaseUrl.replace('.supabase.co', '')}.lovable.app`;\r\n    const inviteLink = `${siteUrl}/accept-invite?token=${invitationToken}`;\r\n\r\n    // Send invitation email\r\n    const emailResponse = await resend.emails.send({\r\n      from: \"CRM Team <onboarding@resend.dev>\",\r\n      to: [email],\r\n      subject: \"You've been invited to join the team!\",\r\n      html: `\r\n        <!DOCTYPE html>\r\n        <html>\r\n        <head>\r\n          <style>\r\n            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }\r\n            .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; }\r\n            .header { text-align: center; margin-bottom: 30px; }\r\n            .header h1 { color: #2563eb; margin: 0; }\r\n            .content { background: #f9fafb; border-radius: 12px; padding: 30px; margin-bottom: 30px; }\r\n            .button { display: inline-block; background: #2563eb; color: white; padding: 14px 28px; border-radius: 8px; text-decoration: none; font-weight: 600; }\r\n            .button:hover { background: #1d4ed8; }\r\n            .footer { text-align: center; color: #6b7280; font-size: 14px; }\r\n          </style>\r\n        </head>\r\n        <body>\r\n          <div class=\"container\">\r\n            <div class=\"header\">\r\n              <h1>Welcome to the Team!</h1>\r\n            </div>\r\n            <div class=\"content\">\r\n              <p>Hi ${name},</p>\r\n              <p>You've been invited to join our CRM platform as a <strong>${role.replace('_', ' ')}</strong>.</p>\r\n              <p>Click the button below to set up your password and complete your registration:</p>\r\n              <p style=\"text-align: center; margin: 30px 0;\">\r\n                <a href=\"${inviteLink}\" class=\"button\">Accept Invitation</a>\r\n              </p>\r\n              <p style=\"font-size: 14px; color: #6b7280;\">\r\n                This invitation link will expire in 7 days. If you didn't expect this invitation, you can safely ignore this email.\r\n              </p>\r\n            </div>\r\n            <div class=\"footer\">\r\n              <p>Â© ${new Date().getFullYear()} CRM Platform. All rights reserved.</p>\r\n            </div>\r\n          </div>\r\n        </body>\r\n        </html>\r\n      `,\r\n    });\r\n\r\n    console.log(\"Email sent successfully:\", emailResponse);\r\n\r\n    return new Response(\r\n      JSON.stringify({ success: true, agent, emailResponse }),\r\n      {\r\n        status: 200,\r\n        headers: { \"Content-Type\": \"application/json\", ...corsHeaders },\r\n      }\r\n    );\r\n  } catch (error: any) {\r\n    console.error(\"Error in invite-agent function:\", error);\r\n    return new Response(\r\n      JSON.stringify({ error: error.message }),\r\n      {\r\n        status: 500,\r\n        headers: { \"Content-Type\": \"application/json\", ...corsHeaders },\r\n      }\r\n    );\r\n  }\r\n};\r\n\r\nserve(handler);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\lead-source-fetch\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":178,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":178,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6031,6034],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6031,6034],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":208,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":208,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7304,7307],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7304,7307],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":230,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":230,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8008,8011],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8008,8011],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":239,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":239,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8337,8340],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8337,8340],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":289,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":289,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10247,10250],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10247,10250],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":304,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":304,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10844,10847],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10844,10847],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":313,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":313,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11180,11183],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11180,11183],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":322,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":322,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11492,11495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11492,11495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":322,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":322,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11507,11510],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11507,11510],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":327,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":327,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11764,11767],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11764,11767],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":448,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":448,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15831,15834],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15831,15834],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":448,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":448,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15845,15848],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15845,15848],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":462,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":462,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16360,16363],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16360,16363],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":464,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":464,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16439,16442],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16439,16442],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":465,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":465,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16531,16534],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16531,16534],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":466,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":466,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16626,16629],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16626,16629],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":475,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":475,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16855,16858],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16855,16858],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":475,"column":83,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":475,"endColumn":86,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16888,16891],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16888,16891],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"prefer-const","severity":2,"message":"'allLeads' is never reassigned. Use 'const' instead.","line":501,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":501,"endColumn":24,"fix":{"range":[17796,17820],"text":"const allLeads: any[] = []"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":501,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":501,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17810,17813],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17810,17813],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":542,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":542,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19288,19291],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19288,19291],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":543,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":543,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19376,19379],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19376,19379],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":573,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":573,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20203,20206],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20203,20206],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":573,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":573,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20217,20220],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20217,20220],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":24,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'\r\n\r\nconst corsHeaders = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',\r\n}\r\n\r\nconst PF_API_BASE = 'https://atlas.propertyfinder.com'\r\n\r\nDeno.serve(async (req) => {\r\n  if (req.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders })\r\n  }\r\n\r\n  if (req.method !== 'POST') {\r\n    return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n      status: 405,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n    })\r\n  }\r\n\r\n  const supabaseUrl = Deno.env.get('SUPABASE_URL')!\r\n  const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!\r\n  const supabase = createClient(supabaseUrl, supabaseServiceKey)\r\n\r\n  const startTime = Date.now()\r\n\r\n  try {\r\n    const { source_id, company_id, action } = await req.json()\r\n\r\n    if (!source_id || !company_id) {\r\n      return new Response(JSON.stringify({ error: 'Missing source_id or company_id' }), {\r\n        status: 400,\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n      })\r\n    }\r\n\r\n    // Get source configuration\r\n    const { data: source, error: sourceError } = await supabase\r\n      .from('lead_sources')\r\n      .select('*')\r\n      .eq('id', source_id)\r\n      .eq('company_id', company_id)\r\n      .single()\r\n\r\n    if (sourceError || !source) {\r\n      return new Response(JSON.stringify({ error: 'Source not found' }), {\r\n        status: 404,\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n      })\r\n    }\r\n\r\n    // Handle test connection\r\n    if (action === 'test') {\r\n      const testResult = await testConnection(source, company_id)\r\n      \r\n      // Try to log activity\r\n      try {\r\n        await supabase.rpc('log_lead_source_activity', {\r\n          p_source_id: source_id,\r\n          p_company_id: company_id,\r\n          p_action: 'connection_test',\r\n          p_status: testResult.success ? 'success' : 'failed',\r\n          p_error_message: testResult.error || null,\r\n          p_duration_ms: Date.now() - startTime\r\n        })\r\n      } catch (logError) {\r\n        console.log('Activity logging not available:', logError)\r\n      }\r\n\r\n      if (testResult.success) {\r\n        await supabase\r\n          .from('lead_sources')\r\n          .update({ status: 'connected', last_error: null })\r\n          .eq('id', source_id)\r\n      } else {\r\n        await supabase\r\n          .from('lead_sources')\r\n          .update({ status: 'error', last_error: testResult.error })\r\n          .eq('id', source_id)\r\n      }\r\n\r\n      return new Response(JSON.stringify(testResult), {\r\n        status: testResult.success ? 200 : 400,\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n      })\r\n    }\r\n\r\n    // Handle manual fetch\r\n    if (action === 'fetch') {\r\n      const fetchResult = await fetchLeads(source, supabase)\r\n\r\n      // Try to log activity\r\n      try {\r\n        await supabase.rpc('log_lead_source_activity', {\r\n          p_source_id: source_id,\r\n          p_company_id: company_id,\r\n          p_action: 'fetch',\r\n          p_status: fetchResult.success ? 'success' : 'failed',\r\n          p_leads_processed: fetchResult.processed || 0,\r\n          p_leads_created: fetchResult.created || 0,\r\n          p_leads_skipped: fetchResult.skipped || 0,\r\n          p_error_message: fetchResult.error || null,\r\n          p_duration_ms: Date.now() - startTime\r\n        })\r\n      } catch (logError) {\r\n        console.log('Activity logging not available:', logError)\r\n      }\r\n\r\n      if (fetchResult.success) {\r\n        await supabase\r\n          .from('lead_sources')\r\n          .update({ \r\n            last_fetched_at: new Date().toISOString(),\r\n            last_error: null \r\n          })\r\n          .eq('id', source_id)\r\n      }\r\n\r\n      return new Response(JSON.stringify(fetchResult), {\r\n        status: fetchResult.success ? 200 : 400,\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n      })\r\n    }\r\n\r\n    return new Response(JSON.stringify({ error: 'Invalid action' }), {\r\n      status: 400,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n    })\r\n\r\n  } catch (error: unknown) {\r\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error'\r\n    console.error('Lead source fetch error:', error)\r\n    return new Response(JSON.stringify({ error: errorMessage }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n    })\r\n  }\r\n})\r\n\r\n// Get Property Finder OAuth token\r\nasync function getPropertyFinderToken(apiKey: string, apiSecret: string): Promise<{ token: string | null; error?: string }> {\r\n  try {\r\n    console.log('Getting Property Finder token...')\r\n    const response = await fetch(`${PF_API_BASE}/v1/auth/token`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Accept': 'application/json'\r\n      },\r\n      body: JSON.stringify({\r\n        apiKey: apiKey,\r\n        apiSecret: apiSecret\r\n      })\r\n    })\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text()\r\n      console.error('Token error response:', errorText)\r\n      if (response.status === 401) {\r\n        return { token: null, error: 'Invalid API Key or Secret. Please check your credentials in PF Expert dashboard.' }\r\n      }\r\n      if (response.status === 429) {\r\n        return { token: null, error: 'Rate limit exceeded. Please try again later.' }\r\n      }\r\n      return { token: null, error: `Authentication failed: ${response.status} ${response.statusText}` }\r\n    }\r\n\r\n    const data = await response.json()\r\n    console.log('Token obtained successfully')\r\n    return { token: data.accessToken }\r\n  } catch (error) {\r\n    console.error('Token fetch error:', error)\r\n    return { token: null, error: `Failed to authenticate: ${error instanceof Error ? error.message : 'Unknown error'}` }\r\n  }\r\n}\r\n\r\nasync function testConnection(source: any, companyId: string): Promise<{ success: boolean; error?: string; message?: string; webhook_url?: string }> {\r\n  const connectionDetails = source.connection_details || {}\r\n  const sourceName = source.source_name\r\n\r\n  try {\r\n    switch (sourceName) {\r\n      case 'meta':\r\n        return await testMetaConnection(connectionDetails)\r\n      case 'tiktok':\r\n        return await testTikTokConnection(connectionDetails)\r\n      case 'property_finder':\r\n        return await testPropertyFinderConnection(connectionDetails, companyId)\r\n      case 'bayut':\r\n      case 'dubizzle':\r\n        return await testPropertyPortalConnection(connectionDetails, sourceName, companyId)\r\n      case 'google_sheets':\r\n        return await testGoogleSheetsConnection(connectionDetails)\r\n      case 'website':\r\n        return { success: true, message: 'Website webhook is ready to receive leads' }\r\n      case 'linkedin':\r\n        return await testLinkedInConnection(connectionDetails)\r\n      default:\r\n        return { success: true, message: 'Connection configured' }\r\n    }\r\n  } catch (error: unknown) {\r\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error'\r\n    return { success: false, error: errorMessage }\r\n  }\r\n}\r\n\r\nasync function testMetaConnection(details: any): Promise<{ success: boolean; error?: string; message?: string }> {\r\n  const { access_token, page_id } = details\r\n  if (!access_token) {\r\n    return { success: false, error: 'Missing access token' }\r\n  }\r\n\r\n  try {\r\n    const response = await fetch(\r\n      `https://graph.facebook.com/v18.0/me?access_token=${access_token}`\r\n    )\r\n    const data = await response.json()\r\n\r\n    if (data.error) {\r\n      return { success: false, error: data.error.message }\r\n    }\r\n\r\n    return { success: true, message: `Connected to Meta as ${data.name || data.id}` }\r\n  } catch (error) {\r\n    return { success: false, error: 'Failed to connect to Meta API' }\r\n  }\r\n}\r\n\r\nasync function testTikTokConnection(details: any): Promise<{ success: boolean; error?: string; message?: string }> {\r\n  const { access_token } = details\r\n  if (!access_token) {\r\n    return { success: false, error: 'Missing access token' }\r\n  }\r\n\r\n  return { success: true, message: 'TikTok connection configured' }\r\n}\r\n\r\nasync function testPropertyFinderConnection(details: any, companyId: string): Promise<{ success: boolean; error?: string; message?: string; webhook_url?: string }> {\r\n  // Support both api_secret and partner_id as field names\r\n  const api_key = details.api_key\r\n  const api_secret = details.api_secret || details.partner_id\r\n  \r\n  if (!api_key || !api_secret) {\r\n    return { \r\n      success: false, \r\n      error: 'Missing API Key or API Secret. Get these from PF Expert â†’ Developer Resources â†’ API Credentials (type: API Integration).' \r\n    }\r\n  }\r\n\r\n  // Test authentication by getting a token\r\n  const tokenResult = await getPropertyFinderToken(api_key, api_secret)\r\n  \r\n  if (!tokenResult.token) {\r\n    return { \r\n      success: false, \r\n      error: tokenResult.error || 'Failed to authenticate with Property Finder' \r\n    }\r\n  }\r\n\r\n  // Test the token by fetching leads endpoint\r\n  try {\r\n    const response = await fetch(`${PF_API_BASE}/v1/leads?perPage=1`, {\r\n      headers: {\r\n        'Authorization': `Bearer ${tokenResult.token}`,\r\n        'Accept': 'application/json'\r\n      }\r\n    })\r\n\r\n    if (!response.ok) {\r\n      if (response.status === 401 || response.status === 403) {\r\n        return { success: false, error: 'Token invalid or insufficient permissions to access leads.' }\r\n      }\r\n      return { success: false, error: `API test failed: ${response.status} ${response.statusText}` }\r\n    }\r\n\r\n    const webhookUrl = `https://zyqlwkkiyuqnhlvnuewk.supabase.co/functions/v1/property-finder-webhook?company_id=${companyId}`\r\n    \r\n    return { \r\n      success: true, \r\n      message: `Property Finder connected! You can now fetch leads. Also configure webhook in PF Expert for real-time leads.`,\r\n      webhook_url: webhookUrl\r\n    }\r\n  } catch (error) {\r\n    return { success: false, error: `Connection test failed: ${error instanceof Error ? error.message : 'Unknown error'}` }\r\n  }\r\n}\r\n\r\nasync function testPropertyPortalConnection(details: any, portal: string, companyId: string): Promise<{ success: boolean; error?: string; message?: string; webhook_url?: string }> {\r\n  const { api_key, agency_id } = details\r\n  if (!api_key) {\r\n    return { success: false, error: 'Missing API key' }\r\n  }\r\n\r\n  const webhookUrl = `https://zyqlwkkiyuqnhlvnuewk.supabase.co/functions/v1/lead-source-webhook?source=${portal}&company_id=${companyId}`\r\n\r\n  return { \r\n    success: true, \r\n    message: `${portal} connection configured. Webhook URL: ${webhookUrl}`,\r\n    webhook_url: webhookUrl\r\n  }\r\n}\r\n\r\nasync function testGoogleSheetsConnection(details: any): Promise<{ success: boolean; error?: string; message?: string }> {\r\n  const { spreadsheet_id } = details\r\n  if (!spreadsheet_id) {\r\n    return { success: false, error: 'Missing spreadsheet ID' }\r\n  }\r\n\r\n  return { success: true, message: 'Google Sheets connection configured' }\r\n}\r\n\r\nasync function testLinkedInConnection(details: any): Promise<{ success: boolean; error?: string; message?: string }> {\r\n  const { access_token } = details\r\n  if (!access_token) {\r\n    return { success: false, error: 'Missing access token' }\r\n  }\r\n\r\n  return { success: true, message: 'LinkedIn connection configured' }\r\n}\r\n\r\nasync function fetchLeads(source: any, supabase: any): Promise<{ success: boolean; processed?: number; created?: number; skipped?: number; error?: string; message?: string }> {\r\n  const connectionDetails = source.connection_details || {}\r\n  const sourceName = source.source_name\r\n\r\n  try {\r\n    let leads: any[] = []\r\n\r\n    switch (sourceName) {\r\n      case 'meta':\r\n        leads = await fetchMetaLeads(connectionDetails)\r\n        break\r\n      case 'property_finder':\r\n        leads = await fetchPropertyFinderLeads(connectionDetails, source.company_id)\r\n        break\r\n      case 'google_sheets':\r\n        leads = await fetchGoogleSheetsLeads(connectionDetails)\r\n        break\r\n      case 'bayut':\r\n      case 'dubizzle':\r\n        // These portals use webhooks primarily\r\n        return { \r\n          success: true, \r\n          processed: 0, \r\n          created: 0, \r\n          skipped: 0,\r\n          message: `${sourceName} sends leads via webhook. Configure webhook URL in your portal dashboard.`\r\n        }\r\n      default:\r\n        return { success: true, processed: 0, created: 0, skipped: 0 }\r\n    }\r\n\r\n    if (!Array.isArray(leads)) {\r\n      return { success: false, error: 'Invalid leads data received' }\r\n    }\r\n\r\n    let created = 0\r\n    let skipped = 0\r\n\r\n    for (const lead of leads) {\r\n      try {\r\n        // Use database function for Property Finder leads (handles duplicates + auto-assignment)\r\n        if (sourceName === 'property_finder' && lead.external_id) {\r\n          const payload = {\r\n            lead_id: lead.external_id,\r\n            listing_id: lead.listing_id,\r\n            name: lead.name,\r\n            phone: lead.phone,\r\n            email: lead.email,\r\n            message: lead.message,\r\n            ...lead.source_metadata\r\n          }\r\n          \r\n          const { data: result, error: rpcError } = await supabase.rpc('process_pf_webhook', {\r\n            p_company_id: source.company_id,\r\n            p_payload: payload\r\n          })\r\n          \r\n          if (rpcError) {\r\n            console.error('RPC error:', rpcError)\r\n            skipped++\r\n          } else if (result?.success) {\r\n            if (result.duplicate) {\r\n              skipped++\r\n            } else {\r\n              created++\r\n            }\r\n          } else {\r\n            console.error('Processing failed:', result?.error)\r\n            skipped++\r\n          }\r\n        } else {\r\n          // Fallback for other sources\r\n          const { data: existing } = await supabase\r\n            .from('leads')\r\n            .select('id')\r\n            .eq('company_id', source.company_id)\r\n            .or(`pf_lead_id.eq.${lead.external_id || 'none'},phone.eq.${lead.phone || 'no-phone'}`)\r\n            .limit(1)\r\n            .single()\r\n\r\n          if (existing) { skipped++; continue }\r\n\r\n          const { data: defaultStage } = await supabase\r\n            .from('lead_stages')\r\n            .select('id')\r\n            .eq('company_id', source.company_id)\r\n            .eq('is_default', true)\r\n            .limit(1)\r\n            .single()\r\n\r\n          const { error: insertError } = await supabase.from('leads').insert({\r\n            company_id: source.company_id,\r\n            source: sourceName,\r\n            name: lead.name || 'Unknown',\r\n            phone: lead.phone || null,\r\n            email: lead.email || null,\r\n            requirements: lead.message || null,\r\n            source_metadata: lead.source_metadata || {},\r\n            pf_lead_id: lead.external_id || null,\r\n            portal_listing_id: lead.listing_id || null,\r\n            is_pf_lead: false,\r\n            stage_id: defaultStage?.id || null,\r\n          })\r\n          \r\n          if (!insertError) { created++ } else { console.error('Insert error:', insertError); skipped++ }\r\n        }\r\n      } catch (insertError) {\r\n        console.error('Error processing lead:', insertError)\r\n        skipped++\r\n      }\r\n    }\r\n\r\n    return { \r\n      success: true, \r\n      processed: leads.length, \r\n      created, \r\n      skipped,\r\n      message: created > 0 ? `Successfully imported ${created} new leads` : 'No new leads to import'\r\n    }\r\n  } catch (error: unknown) {\r\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error'\r\n    console.error('Fetch leads error:', errorMessage)\r\n    return { success: false, error: errorMessage }\r\n  }\r\n}\r\n\r\nasync function fetchMetaLeads(details: any): Promise<any[]> {\r\n  const { access_token, page_id, form_id } = details\r\n  if (!access_token || !page_id) return []\r\n\r\n  try {\r\n    const url = form_id \r\n      ? `https://graph.facebook.com/v18.0/${form_id}/leads?access_token=${access_token}`\r\n      : `https://graph.facebook.com/v18.0/${page_id}/leadgen_forms?access_token=${access_token}`\r\n\r\n    const response = await fetch(url)\r\n    const data = await response.json()\r\n\r\n    if (data.error) throw new Error(data.error.message)\r\n\r\n    return (data.data || []).map((item: any) => ({\r\n      external_id: item.id,\r\n      name: item.field_data?.find((f: any) => f.name === 'full_name')?.values?.[0] || '',\r\n      phone: item.field_data?.find((f: any) => f.name === 'phone_number')?.values?.[0] || '',\r\n      email: item.field_data?.find((f: any) => f.name === 'email')?.values?.[0] || '',\r\n      source_metadata: item\r\n    }))\r\n  } catch (error) {\r\n    console.error('Meta fetch error:', error)\r\n    return []\r\n  }\r\n}\r\n\r\nasync function fetchPropertyFinderLeads(details: any, companyId: string): Promise<any[]> {\r\n  // Support both api_secret and partner_id as field names\r\n  const api_key = details.api_key\r\n  const api_secret = details.api_secret || details.partner_id\r\n  if (!api_key || !api_secret) {\r\n    console.error('Missing Property Finder credentials')\r\n    return []\r\n  }\r\n\r\n  try {\r\n    // Get OAuth token\r\n    const tokenResult = await getPropertyFinderToken(api_key, api_secret)\r\n    if (!tokenResult.token) {\r\n      console.error('Failed to get PF token:', tokenResult.error)\r\n      throw new Error(tokenResult.error || 'Authentication failed')\r\n    }\r\n\r\n    // Calculate date range - use last 30 days to stay well within API limits\r\n    const now = new Date()\r\n    const thirtyDaysAgo = new Date(now)\r\n    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)\r\n    \r\n    const createdAtFrom = thirtyDaysAgo.toISOString()\r\n    \r\n    console.log(`Fetching PF leads from ${createdAtFrom}`)\r\n    \r\n    let allLeads: any[] = []\r\n    let page = 1\r\n    let hasMore = true\r\n\r\n    while (hasMore && page <= 20) { // Max 20 pages (1000 leads)\r\n      const url = new URL(`${PF_API_BASE}/v1/leads`)\r\n      url.searchParams.set('page', page.toString())\r\n      url.searchParams.set('perPage', '50')\r\n      url.searchParams.set('createdAtFrom', createdAtFrom)\r\n      url.searchParams.set('orderBy', 'createdAt')\r\n      url.searchParams.set('orderDirection', 'desc')\r\n\r\n      console.log(`Fetching PF leads page ${page}: ${url.toString()}`)\r\n\r\n      const response = await fetch(url.toString(), {\r\n        headers: {\r\n          'Authorization': `Bearer ${tokenResult.token}`,\r\n          'Accept': 'application/json'\r\n        }\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const errorText = await response.text()\r\n        console.error(`PF API error ${response.status}:`, errorText)\r\n        throw new Error(`Property Finder API error: ${response.status} - ${response.statusText}`)\r\n      }\r\n\r\n      const data = await response.json()\r\n      console.log(`PF response page ${page}:`, JSON.stringify(data).substring(0, 500))\r\n\r\n      const results = data.results || data.data || []\r\n      \r\n      if (results.length === 0) {\r\n        hasMore = false\r\n        break\r\n      }\r\n\r\n      // Map leads to our format\r\n      for (const lead of results) {\r\n        const senderName = lead.sender?.name || ''\r\n        const senderContacts = lead.sender?.contacts || []\r\n        const phone = senderContacts.find((c: any) => c.type === 'phone')?.value || ''\r\n        const email = senderContacts.find((c: any) => c.type === 'email')?.value || ''\r\n\r\n        allLeads.push({\r\n          external_id: lead.id,\r\n          name: senderName || 'Unknown',\r\n          phone: phone,\r\n          email: email,\r\n          listing_id: lead.listing?.id || lead.listing?.reference || null,\r\n          message: lead.enrichment?.message || '',\r\n          source_metadata: lead\r\n        })\r\n      }\r\n\r\n      // Check pagination\r\n      const pagination = data.pagination\r\n      if (pagination && pagination.page < pagination.totalPages) {\r\n        page++\r\n      } else {\r\n        hasMore = false\r\n      }\r\n    }\r\n\r\n    console.log(`Total PF leads fetched: ${allLeads.length}`)\r\n    return allLeads\r\n  } catch (error) {\r\n    console.error('Property Finder fetch error:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\nasync function fetchGoogleSheetsLeads(details: any): Promise<any[]> {\r\n  // Google Sheets API fetch would be implemented here\r\n  return []\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\lead-source-webhook\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":18,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[515,518],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[515,518],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":63,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2164,2167],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2164,2167],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":210,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":210,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6678,6681],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6678,6681],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":251,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":251,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8068,8071],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8068,8071],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":252,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":252,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8185,8188],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8185,8188],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":266,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":266,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8472,8475],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8472,8475],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":282,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":282,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8838,8841],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8838,8841],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":300,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":300,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9448,9451],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9448,9451],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":316,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":316,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9840,9843],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9840,9843],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":348,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":348,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10756,10759],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10756,10759],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":362,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":362,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11310,11313],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11310,11313],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":376,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":376,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11895,11898],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11895,11898],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":390,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":390,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12456,12459],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12456,12459],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":13,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'\r\n\r\nconst corsHeaders = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type, x-hub-signature-256, x-tiktok-signature',\r\n}\r\n\r\ninterface LeadData {\r\n  external_id?: string\r\n  name: string\r\n  phone?: string\r\n  email?: string\r\n  campaign_name?: string\r\n  ad_set_name?: string\r\n  ad_name?: string\r\n  form_id?: string\r\n  form_name?: string\r\n  source_metadata?: Record<string, any>\r\n}\r\n\r\nDeno.serve(async (req) => {\r\n  if (req.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders })\r\n  }\r\n\r\n  const url = new URL(req.url)\r\n  const sourceType = url.searchParams.get('source') // meta, tiktok, linkedin, website, property_finder, bayut, dubizzle\r\n  const companyId = url.searchParams.get('company_id')\r\n  const verifyToken = url.searchParams.get('verify_token')\r\n\r\n  // Meta webhook verification (GET request)\r\n  if (req.method === 'GET' && sourceType === 'meta') {\r\n    const hubMode = url.searchParams.get('hub.mode')\r\n    const hubVerifyToken = url.searchParams.get('hub.verify_token')\r\n    const hubChallenge = url.searchParams.get('hub.challenge')\r\n\r\n    if (hubMode === 'subscribe' && hubVerifyToken === verifyToken) {\r\n      console.log('Meta webhook verified successfully')\r\n      return new Response(hubChallenge, { status: 200 })\r\n    }\r\n    return new Response('Verification failed', { status: 403 })\r\n  }\r\n\r\n  if (req.method !== 'POST') {\r\n    return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n      status: 405,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n    })\r\n  }\r\n\r\n  if (!sourceType || !companyId) {\r\n    return new Response(JSON.stringify({ error: 'Missing source or company_id' }), {\r\n      status: 400,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n    })\r\n  }\r\n\r\n  const supabaseUrl = Deno.env.get('SUPABASE_URL')!\r\n  const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!\r\n  const supabase = createClient(supabaseUrl, supabaseServiceKey)\r\n\r\n  const startTime = Date.now()\r\n  let payload: any\r\n\r\n  try {\r\n    payload = await req.json()\r\n  } catch (e) {\r\n    console.error('Failed to parse JSON:', e)\r\n    return new Response(JSON.stringify({ error: 'Invalid JSON' }), {\r\n      status: 400,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n    })\r\n  }\r\n\r\n  console.log(`Received ${sourceType} webhook for company ${companyId}:`, JSON.stringify(payload))\r\n\r\n  // Get source configuration\r\n  const { data: source, error: sourceError } = await supabase\r\n    .from('lead_sources')\r\n    .select('*')\r\n    .eq('company_id', companyId)\r\n    .eq('source_name', sourceType)\r\n    .eq('status', 'connected')\r\n    .single()\r\n\r\n  if (sourceError || !source) {\r\n    console.error('Source not found or not connected:', sourceError)\r\n    return new Response(JSON.stringify({ error: 'Source not configured or not connected' }), {\r\n      status: 404,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n    })\r\n  }\r\n\r\n  let leads: LeadData[] = []\r\n  let leadsCreated = 0\r\n  let leadsSkipped = 0\r\n  let leadsUpdated = 0\r\n\r\n  try {\r\n    // Parse leads based on source type\r\n    switch (sourceType) {\r\n      case 'meta':\r\n        leads = parseMetaLeads(payload)\r\n        break\r\n      case 'tiktok':\r\n        leads = parseTikTokLeads(payload)\r\n        break\r\n      case 'linkedin':\r\n        leads = parseLinkedInLeads(payload)\r\n        break\r\n      case 'website':\r\n        leads = parseWebsiteLeads(payload)\r\n        break\r\n      case 'property_finder':\r\n        leads = parsePropertyFinderLeads(payload)\r\n        break\r\n      case 'bayut':\r\n      case 'dubizzle':\r\n        leads = parsePropertyPortalLeads(payload, sourceType)\r\n        break\r\n      default:\r\n        leads = parseGenericLeads(payload)\r\n    }\r\n\r\n    // Process each lead\r\n    for (const lead of leads) {\r\n      const { data: result, error } = await supabase.rpc('insert_lead_from_source', {\r\n        p_company_id: companyId,\r\n        p_source_id: source.id,\r\n        p_external_id: lead.external_id || null,\r\n        p_name: lead.name || 'Unknown',\r\n        p_phone: lead.phone || null,\r\n        p_email: lead.email || null,\r\n        p_source_metadata: lead.source_metadata || {},\r\n        p_campaign_name: lead.campaign_name || null,\r\n        p_ad_set_name: lead.ad_set_name || null,\r\n        p_ad_name: lead.ad_name || null,\r\n        p_form_id: lead.form_id || null,\r\n        p_form_name: lead.form_name || null,\r\n        p_duplicate_action: 'skip'\r\n      })\r\n\r\n      if (error) {\r\n        console.error('Error inserting lead:', error)\r\n        continue\r\n      }\r\n\r\n      if (result.action === 'created') leadsCreated++\r\n      else if (result.action === 'skipped') leadsSkipped++\r\n      else if (result.action === 'updated') leadsUpdated++\r\n    }\r\n\r\n    // Update webhook stats\r\n    await supabase\r\n      .from('lead_webhooks')\r\n      .update({\r\n        last_received_at: new Date().toISOString(),\r\n        total_received: supabase.rpc('increment', { row_id: source.id })\r\n      })\r\n      .eq('source_id', source.id)\r\n\r\n    // Log activity\r\n    await supabase.rpc('log_lead_source_activity', {\r\n      p_source_id: source.id,\r\n      p_company_id: companyId,\r\n      p_action: 'webhook_received',\r\n      p_status: 'success',\r\n      p_leads_processed: leads.length,\r\n      p_leads_created: leadsCreated,\r\n      p_leads_updated: leadsUpdated,\r\n      p_leads_skipped: leadsSkipped,\r\n      p_request_data: payload,\r\n      p_duration_ms: Date.now() - startTime\r\n    })\r\n\r\n    return new Response(JSON.stringify({\r\n      success: true,\r\n      processed: leads.length,\r\n      created: leadsCreated,\r\n      skipped: leadsSkipped,\r\n      updated: leadsUpdated\r\n    }), {\r\n      status: 200,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n    })\r\n\r\n  } catch (error: unknown) {\r\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error'\r\n    console.error('Webhook processing error:', error)\r\n\r\n    // Log error\r\n    await supabase.rpc('log_lead_source_activity', {\r\n      p_source_id: source?.id,\r\n      p_company_id: companyId,\r\n      p_action: 'webhook_received',\r\n      p_status: 'failed',\r\n      p_error_message: errorMessage,\r\n      p_request_data: payload,\r\n      p_duration_ms: Date.now() - startTime\r\n    })\r\n\r\n    return new Response(JSON.stringify({ error: errorMessage }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n    })\r\n  }\r\n})\r\n\r\n// Meta (Facebook/Instagram) Lead Ads parser\r\nfunction parseMetaLeads(payload: any): LeadData[] {\r\n  const leads: LeadData[] = []\r\n  \r\n  if (payload.entry) {\r\n    for (const entry of payload.entry) {\r\n      for (const change of entry.changes || []) {\r\n        if (change.field === 'leadgen') {\r\n          const leadgenData = change.value\r\n          const fieldData = leadgenData.field_data || []\r\n          \r\n          const lead: LeadData = {\r\n            external_id: leadgenData.leadgen_id,\r\n            name: '',\r\n            phone: '',\r\n            email: '',\r\n            campaign_name: leadgenData.campaign_name,\r\n            ad_set_name: leadgenData.adset_name,\r\n            ad_name: leadgenData.ad_name,\r\n            form_id: leadgenData.form_id,\r\n            form_name: leadgenData.form_name,\r\n            source_metadata: leadgenData\r\n          }\r\n\r\n          for (const field of fieldData) {\r\n            const value = field.values?.[0] || ''\r\n            switch (field.name?.toLowerCase()) {\r\n              case 'full_name':\r\n              case 'name':\r\n                lead.name = value\r\n                break\r\n              case 'phone_number':\r\n              case 'phone':\r\n                lead.phone = value\r\n                break\r\n              case 'email':\r\n                lead.email = value\r\n                break\r\n            }\r\n          }\r\n\r\n          if (!lead.name && fieldData.length > 0) {\r\n            const firstName = fieldData.find((f: any) => f.name?.toLowerCase().includes('first'))?.values?.[0] || ''\r\n            const lastName = fieldData.find((f: any) => f.name?.toLowerCase().includes('last'))?.values?.[0] || ''\r\n            lead.name = `${firstName} ${lastName}`.trim()\r\n          }\r\n\r\n          leads.push(lead)\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  return leads\r\n}\r\n\r\n// TikTok Lead Gen parser\r\nfunction parseTikTokLeads(payload: any): LeadData[] {\r\n  const leads: LeadData[] = []\r\n\r\n  const leadData = payload.lead || payload\r\n  \r\n  if (Array.isArray(leadData)) {\r\n    for (const item of leadData) {\r\n      leads.push(parseSingleTikTokLead(item))\r\n    }\r\n  } else if (leadData) {\r\n    leads.push(parseSingleTikTokLead(leadData))\r\n  }\r\n\r\n  return leads\r\n}\r\n\r\nfunction parseSingleTikTokLead(data: any): LeadData {\r\n  const fieldData = data.user_info || data.form_data || {}\r\n  \r\n  return {\r\n    external_id: data.lead_id || data.id,\r\n    name: fieldData.name || fieldData.full_name || `${fieldData.first_name || ''} ${fieldData.last_name || ''}`.trim(),\r\n    phone: fieldData.phone || fieldData.phone_number,\r\n    email: fieldData.email,\r\n    campaign_name: data.campaign_name,\r\n    ad_set_name: data.adgroup_name,\r\n    ad_name: data.ad_name,\r\n    form_id: data.form_id,\r\n    form_name: data.form_name,\r\n    source_metadata: data\r\n  }\r\n}\r\n\r\n// LinkedIn Lead Gen parser\r\nfunction parseLinkedInLeads(payload: any): LeadData[] {\r\n  const leads: LeadData[] = []\r\n\r\n  const leadData = payload.lead || payload.response || payload\r\n  \r\n  if (Array.isArray(leadData)) {\r\n    for (const item of leadData) {\r\n      leads.push(parseSingleLinkedInLead(item))\r\n    }\r\n  } else if (leadData) {\r\n    leads.push(parseSingleLinkedInLead(leadData))\r\n  }\r\n\r\n  return leads\r\n}\r\n\r\nfunction parseSingleLinkedInLead(data: any): LeadData {\r\n  const formResponse = data.formResponse || data\r\n  const answers = formResponse.answers || []\r\n\r\n  const lead: LeadData = {\r\n    external_id: data.id || formResponse.id,\r\n    name: '',\r\n    phone: '',\r\n    email: '',\r\n    campaign_name: data.campaign?.name,\r\n    form_id: formResponse.form?.id,\r\n    form_name: formResponse.form?.name,\r\n    source_metadata: data\r\n  }\r\n\r\n  for (const answer of answers) {\r\n    const questionId = answer.questionId?.toLowerCase() || ''\r\n    const value = answer.answerDetails?.textQuestionAnswer?.answer || ''\r\n\r\n    if (questionId.includes('name') || questionId.includes('fullname')) {\r\n      lead.name = value\r\n    } else if (questionId.includes('phone')) {\r\n      lead.phone = value\r\n    } else if (questionId.includes('email')) {\r\n      lead.email = value\r\n    }\r\n  }\r\n\r\n  return lead\r\n}\r\n\r\n// Website Form parser (generic)\r\nfunction parseWebsiteLeads(payload: any): LeadData[] {\r\n  return [{\r\n    external_id: payload.submission_id || payload.id || `web_${Date.now()}`,\r\n    name: payload.name || payload.full_name || `${payload.first_name || ''} ${payload.last_name || ''}`.trim(),\r\n    phone: payload.phone || payload.phone_number || payload.tel,\r\n    email: payload.email,\r\n    campaign_name: payload.utm_campaign,\r\n    form_id: payload.form_id,\r\n    form_name: payload.form_name || payload.source,\r\n    source_metadata: payload\r\n  }]\r\n}\r\n\r\n// Property Finder parser\r\nfunction parsePropertyFinderLeads(payload: any): LeadData[] {\r\n  const leadInfo = payload.lead || payload.enquiry || payload\r\n\r\n  return [{\r\n    external_id: leadInfo.lead_id || leadInfo.enquiry_id || leadInfo.reference,\r\n    name: leadInfo.name || leadInfo.contact_name || `${leadInfo.first_name || ''} ${leadInfo.last_name || ''}`.trim(),\r\n    phone: leadInfo.phone || leadInfo.mobile || leadInfo.contact_phone,\r\n    email: leadInfo.email || leadInfo.contact_email,\r\n    campaign_name: leadInfo.property_reference,\r\n    source_metadata: payload\r\n  }]\r\n}\r\n\r\n// Bayut/Dubizzle parser\r\nfunction parsePropertyPortalLeads(payload: any, portalName: string): LeadData[] {\r\n  const leadInfo = payload.lead || payload.enquiry || payload\r\n\r\n  return [{\r\n    external_id: leadInfo.enquiry_id || leadInfo.lead_id || leadInfo.id,\r\n    name: leadInfo.name || leadInfo.customer_name,\r\n    phone: leadInfo.phone || leadInfo.mobile || leadInfo.customer_phone,\r\n    email: leadInfo.email || leadInfo.customer_email,\r\n    campaign_name: leadInfo.listing_id || leadInfo.property_id,\r\n    source_metadata: { ...payload, portal: portalName }\r\n  }]\r\n}\r\n\r\n// Generic parser\r\nfunction parseGenericLeads(payload: any): LeadData[] {\r\n  if (Array.isArray(payload)) {\r\n    return payload.map(item => ({\r\n      external_id: item.id || item.external_id,\r\n      name: item.name || item.full_name || `${item.first_name || ''} ${item.last_name || ''}`.trim(),\r\n      phone: item.phone || item.phone_number || item.mobile,\r\n      email: item.email,\r\n      source_metadata: item\r\n    }))\r\n  }\r\n\r\n  return [{\r\n    external_id: payload.id || payload.external_id,\r\n    name: payload.name || payload.full_name || `${payload.first_name || ''} ${payload.last_name || ''}`.trim(),\r\n    phone: payload.phone || payload.phone_number || payload.mobile,\r\n    email: payload.email,\r\n    source_metadata: payload\r\n  }]\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\listing-manage\\index.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'updateData' is never reassigned. Use 'const' instead.","line":521,"column":13,"nodeType":"Identifier","messageId":"useConst","endLine":521,"endColumn":48,"fix":{"range":[17398,17481],"text":"const updateData: Record<string, unknown> = { updated_at: new Date().toISOString() };"}},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":540,"column":13,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":544,"endColumn":45,"suggestions":[{"messageId":"addBrackets","fix":{"range":[18049,18486],"text":"{ const { error: deleteError } = await supabase\r\n              .from('listings')\r\n              .delete()\r\n              .in('id', listing_ids)\r\n              .eq('company_id', company_id);\r\n\r\n            if (deleteError) throw deleteError;\r\n\r\n            return new Response(JSON.stringify({ success: true, affected: listing_ids.length }), {\r\n              headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n            }); }"},"desc":"Add {} brackets around the case block."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';\r\n\r\nconst corsHeaders = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',\r\n};\r\n\r\ninterface ListingRequest {\r\n  action: 'create' | 'update' | 'delete' | 'publish' | 'unpublish' | 'assign' | 'archive' | 'duplicate' | 'bulk_action' | 'get_analytics';\r\n  listing_id?: string;\r\n  listing_ids?: string[];\r\n  data?: Record<string, unknown>;\r\n  portal_names?: string[];\r\n  agent_ids?: string[];\r\n  bulk_action?: string;\r\n}\r\n\r\nDeno.serve(async (req) => {\r\n  if (req.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;\r\n    const supabaseKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;\r\n    const supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\n    // Get user from auth header\r\n    const authHeader = req.headers.get('Authorization');\r\n    if (!authHeader) {\r\n      return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n        status: 401,\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      });\r\n    }\r\n\r\n    const token = authHeader.replace('Bearer ', '');\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser(token);\r\n    \r\n    if (authError || !user) {\r\n      return new Response(JSON.stringify({ error: 'Invalid token' }), {\r\n        status: 401,\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      });\r\n    }\r\n\r\n    // Get user's company and role\r\n    const { data: agent, error: agentError } = await supabase\r\n      .from('agents')\r\n      .select('id, company_id, role')\r\n      .eq('user_id', user.id)\r\n      .single();\r\n\r\n    if (agentError || !agent) {\r\n      return new Response(JSON.stringify({ error: 'Agent not found' }), {\r\n        status: 404,\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      });\r\n    }\r\n\r\n    const { company_id, role, id: agent_id } = agent;\r\n    const isAdmin = role === 'admin' || role === 'manager';\r\n\r\n    const body: ListingRequest = await req.json();\r\n    const { action } = body;\r\n\r\n    console.log(`[listing-manage] Action: ${action}, Company: ${company_id}, User: ${user.id}`);\r\n\r\n    switch (action) {\r\n      case 'create': {\r\n        if (!isAdmin) {\r\n          return new Response(JSON.stringify({ error: 'Only Admin/Manager can create listings' }), {\r\n            status: 403,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          });\r\n        }\r\n\r\n        const listingData = {\r\n          ...body.data,\r\n          company_id,\r\n          created_by: agent_id,\r\n          status: body.data?.status || 'draft',\r\n        };\r\n\r\n        const { data: listing, error } = await supabase\r\n          .from('listings')\r\n          .insert(listingData)\r\n          .select()\r\n          .single();\r\n\r\n        if (error) throw error;\r\n\r\n        // Log the action\r\n        await supabase.from('listing_audit_logs').insert({\r\n          listing_id: listing.id,\r\n          company_id,\r\n          action_type: 'create',\r\n          description: `Created listing: ${listing.title}`,\r\n          performed_by: agent_id,\r\n        });\r\n\r\n        return new Response(JSON.stringify({ success: true, listing }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      case 'update': {\r\n        const { listing_id, data } = body;\r\n\r\n        if (!listing_id) {\r\n          return new Response(JSON.stringify({ error: 'Listing ID is required' }), {\r\n            status: 400,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          });\r\n        }\r\n\r\n        // Check if user can edit this listing\r\n        const { data: existingListing } = await supabase\r\n          .from('listings')\r\n          .select('*, assigned_agent_id')\r\n          .eq('id', listing_id)\r\n          .eq('company_id', company_id)\r\n          .single();\r\n\r\n        if (!existingListing) {\r\n          return new Response(JSON.stringify({ error: 'Listing not found' }), {\r\n            status: 404,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          });\r\n        }\r\n\r\n        // Agents can only edit their assigned listings\r\n        if (!isAdmin && existingListing.assigned_agent_id !== agent_id) {\r\n          return new Response(JSON.stringify({ error: 'You can only edit your assigned listings' }), {\r\n            status: 403,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          });\r\n        }\r\n\r\n        const { data: listing, error } = await supabase\r\n          .from('listings')\r\n          .update({ ...data, updated_at: new Date().toISOString() })\r\n          .eq('id', listing_id)\r\n          .eq('company_id', company_id)\r\n          .select()\r\n          .single();\r\n\r\n        if (error) throw error;\r\n\r\n        // Log the action\r\n        await supabase.from('listing_audit_logs').insert({\r\n          listing_id,\r\n          company_id,\r\n          action_type: 'edit',\r\n          description: `Updated listing: ${listing.title}`,\r\n          changes: data,\r\n          performed_by: agent_id,\r\n        });\r\n\r\n        return new Response(JSON.stringify({ success: true, listing }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      case 'delete': {\r\n        if (!isAdmin) {\r\n          return new Response(JSON.stringify({ error: 'Only Admin/Manager can delete listings' }), {\r\n            status: 403,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          });\r\n        }\r\n\r\n        const { listing_id } = body;\r\n\r\n        // Get listing title for logging\r\n        const { data: existingListing } = await supabase\r\n          .from('listings')\r\n          .select('title')\r\n          .eq('id', listing_id)\r\n          .single();\r\n\r\n        const { error } = await supabase\r\n          .from('listings')\r\n          .delete()\r\n          .eq('id', listing_id)\r\n          .eq('company_id', company_id);\r\n\r\n        if (error) throw error;\r\n\r\n        // Log the action\r\n        await supabase.from('listing_audit_logs').insert({\r\n          listing_id,\r\n          company_id,\r\n          action_type: 'delete',\r\n          description: `Deleted listing: ${existingListing?.title || listing_id}`,\r\n          performed_by: agent_id,\r\n        });\r\n\r\n        return new Response(JSON.stringify({ success: true }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      case 'publish': {\r\n        if (!isAdmin) {\r\n          return new Response(JSON.stringify({ error: 'Only Admin/Manager can publish listings' }), {\r\n            status: 403,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          });\r\n        }\r\n\r\n        const { listing_id, portal_names, data: customizations } = body;\r\n\r\n        if (!listing_id || !portal_names?.length) {\r\n          return new Response(JSON.stringify({ error: 'Listing ID and portal names are required' }), {\r\n            status: 400,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          });\r\n        }\r\n\r\n        // Get listing details\r\n        const { data: listing, error: listingError } = await supabase\r\n          .from('listings')\r\n          .select('*')\r\n          .eq('id', listing_id)\r\n          .eq('company_id', company_id)\r\n          .single();\r\n\r\n        if (listingError || !listing) {\r\n          return new Response(JSON.stringify({ error: 'Listing not found' }), {\r\n            status: 404,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          });\r\n        }\r\n\r\n        const results = [];\r\n\r\n        for (const portal_name of portal_names) {\r\n          // Check if already published to this portal\r\n          const { data: existingPortal } = await supabase\r\n            .from('listing_portals')\r\n            .select('id')\r\n            .eq('listing_id', listing_id)\r\n            .eq('portal_name', portal_name)\r\n            .single();\r\n\r\n          if (existingPortal) {\r\n            // Update existing\r\n            const { data: portal, error } = await supabase\r\n              .from('listing_portals')\r\n              .update({\r\n                customizations: customizations?.[portal_name] || {},\r\n                publish_status: 'pending',\r\n                publish_time: new Date().toISOString(),\r\n                updated_at: new Date().toISOString(),\r\n              })\r\n              .eq('id', existingPortal.id)\r\n              .select()\r\n              .single();\r\n\r\n            results.push({ portal_name, status: 'updated', portal });\r\n          } else {\r\n            // Create new portal entry\r\n            const { data: portal, error } = await supabase\r\n              .from('listing_portals')\r\n              .insert({\r\n                listing_id,\r\n                company_id,\r\n                portal_name,\r\n                customizations: customizations?.[portal_name] || {},\r\n                publish_status: 'pending',\r\n                publish_time: new Date().toISOString(),\r\n              })\r\n              .select()\r\n              .single();\r\n\r\n            results.push({ portal_name, status: 'created', portal });\r\n          }\r\n        }\r\n\r\n        // Update listing status\r\n        await supabase\r\n          .from('listings')\r\n          .update({ \r\n            status: 'published', \r\n            published_at: new Date().toISOString(),\r\n            updated_at: new Date().toISOString() \r\n          })\r\n          .eq('id', listing_id);\r\n\r\n        // Log the action\r\n        await supabase.from('listing_audit_logs').insert({\r\n          listing_id,\r\n          company_id,\r\n          action_type: 'publish',\r\n          description: `Published to: ${portal_names.join(', ')}`,\r\n          changes: { portals: portal_names },\r\n          performed_by: agent_id,\r\n        });\r\n\r\n        return new Response(JSON.stringify({ success: true, results }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      case 'unpublish': {\r\n        if (!isAdmin) {\r\n          return new Response(JSON.stringify({ error: 'Only Admin/Manager can unpublish listings' }), {\r\n            status: 403,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          });\r\n        }\r\n\r\n        const { listing_id, portal_names } = body;\r\n\r\n        if (portal_names?.length) {\r\n          // Unpublish from specific portals\r\n          await supabase\r\n            .from('listing_portals')\r\n            .update({ \r\n              publish_status: 'unpublished',\r\n              unpublish_time: new Date().toISOString(),\r\n            })\r\n            .eq('listing_id', listing_id)\r\n            .in('portal_name', portal_names);\r\n        } else {\r\n          // Unpublish from all portals\r\n          await supabase\r\n            .from('listing_portals')\r\n            .update({ \r\n              publish_status: 'unpublished',\r\n              unpublish_time: new Date().toISOString(),\r\n            })\r\n            .eq('listing_id', listing_id);\r\n\r\n          // Update listing status\r\n          await supabase\r\n            .from('listings')\r\n            .update({ status: 'draft', updated_at: new Date().toISOString() })\r\n            .eq('id', listing_id);\r\n        }\r\n\r\n        // Log the action\r\n        await supabase.from('listing_audit_logs').insert({\r\n          listing_id,\r\n          company_id,\r\n          action_type: 'unpublish',\r\n          description: portal_names?.length \r\n            ? `Unpublished from: ${portal_names.join(', ')}`\r\n            : 'Unpublished from all portals',\r\n          performed_by: agent_id,\r\n        });\r\n\r\n        return new Response(JSON.stringify({ success: true }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      case 'assign': {\r\n        if (!isAdmin) {\r\n          return new Response(JSON.stringify({ error: 'Only Admin/Manager can assign listings' }), {\r\n            status: 403,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          });\r\n        }\r\n\r\n        const { listing_id, agent_ids } = body;\r\n\r\n        if (!listing_id || !agent_ids?.length) {\r\n          return new Response(JSON.stringify({ error: 'Listing ID and agent IDs are required' }), {\r\n            status: 400,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          });\r\n        }\r\n\r\n        const { data: listing, error } = await supabase\r\n          .from('listings')\r\n          .update({\r\n            assigned_agent_id: agent_ids[0], // Primary agent\r\n            assigned_agents: agent_ids,\r\n            updated_at: new Date().toISOString(),\r\n          })\r\n          .eq('id', listing_id)\r\n          .eq('company_id', company_id)\r\n          .select()\r\n          .single();\r\n\r\n        if (error) throw error;\r\n\r\n        // Log the action\r\n        await supabase.from('listing_audit_logs').insert({\r\n          listing_id,\r\n          company_id,\r\n          action_type: 'assign',\r\n          description: `Assigned to ${agent_ids.length} agent(s)`,\r\n          changes: { agent_ids },\r\n          performed_by: agent_id,\r\n        });\r\n\r\n        return new Response(JSON.stringify({ success: true, listing }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      case 'archive': {\r\n        if (!isAdmin) {\r\n          return new Response(JSON.stringify({ error: 'Only Admin/Manager can archive listings' }), {\r\n            status: 403,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          });\r\n        }\r\n\r\n        const { listing_id } = body;\r\n\r\n        const { data: listing, error } = await supabase\r\n          .from('listings')\r\n          .update({ \r\n            status: 'archived', \r\n            updated_at: new Date().toISOString() \r\n          })\r\n          .eq('id', listing_id)\r\n          .eq('company_id', company_id)\r\n          .select()\r\n          .single();\r\n\r\n        if (error) throw error;\r\n\r\n        // Unpublish from all portals\r\n        await supabase\r\n          .from('listing_portals')\r\n          .update({ publish_status: 'unpublished' })\r\n          .eq('listing_id', listing_id);\r\n\r\n        // Log the action\r\n        await supabase.from('listing_audit_logs').insert({\r\n          listing_id,\r\n          company_id,\r\n          action_type: 'archive',\r\n          description: `Archived listing: ${listing.title}`,\r\n          performed_by: agent_id,\r\n        });\r\n\r\n        return new Response(JSON.stringify({ success: true, listing }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      case 'duplicate': {\r\n        if (!isAdmin) {\r\n          return new Response(JSON.stringify({ error: 'Only Admin/Manager can duplicate listings' }), {\r\n            status: 403,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          });\r\n        }\r\n\r\n        const { listing_id } = body;\r\n\r\n        // Get original listing\r\n        const { data: original, error: fetchError } = await supabase\r\n          .from('listings')\r\n          .select('*')\r\n          .eq('id', listing_id)\r\n          .eq('company_id', company_id)\r\n          .single();\r\n\r\n        if (fetchError || !original) {\r\n          return new Response(JSON.stringify({ error: 'Listing not found' }), {\r\n            status: 404,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          });\r\n        }\r\n\r\n        // Create duplicate\r\n        const { id, reference_number, created_at, updated_at, published_at, ...listingData } = original;\r\n        \r\n        const { data: duplicate, error } = await supabase\r\n          .from('listings')\r\n          .insert({\r\n            ...listingData,\r\n            title: `${original.title} (Copy)`,\r\n            status: 'draft',\r\n            created_by: agent_id,\r\n          })\r\n          .select()\r\n          .single();\r\n\r\n        if (error) throw error;\r\n\r\n        // Log the action\r\n        await supabase.from('listing_audit_logs').insert({\r\n          listing_id: duplicate.id,\r\n          company_id,\r\n          action_type: 'duplicate',\r\n          description: `Duplicated from: ${original.reference_number}`,\r\n          changes: { original_id: listing_id },\r\n          performed_by: agent_id,\r\n        });\r\n\r\n        return new Response(JSON.stringify({ success: true, listing: duplicate }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      case 'bulk_action': {\r\n        if (!isAdmin) {\r\n          return new Response(JSON.stringify({ error: 'Only Admin/Manager can perform bulk actions' }), {\r\n            status: 403,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          });\r\n        }\r\n\r\n        const { listing_ids, bulk_action, data } = body;\r\n\r\n        if (!listing_ids?.length || !bulk_action) {\r\n          return new Response(JSON.stringify({ error: 'Listing IDs and bulk action are required' }), {\r\n            status: 400,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          });\r\n        }\r\n\r\n        let updateData: Record<string, unknown> = { updated_at: new Date().toISOString() };\r\n\r\n        switch (bulk_action) {\r\n          case 'archive':\r\n            updateData.status = 'archived';\r\n            break;\r\n          case 'publish':\r\n            updateData.status = 'published';\r\n            updateData.published_at = new Date().toISOString();\r\n            break;\r\n          case 'draft':\r\n            updateData.status = 'draft';\r\n            break;\r\n          case 'assign':\r\n            if (data?.agent_id) {\r\n              updateData.assigned_agent_id = data.agent_id;\r\n            }\r\n            break;\r\n          case 'delete':\r\n            const { error: deleteError } = await supabase\r\n              .from('listings')\r\n              .delete()\r\n              .in('id', listing_ids)\r\n              .eq('company_id', company_id);\r\n\r\n            if (deleteError) throw deleteError;\r\n\r\n            return new Response(JSON.stringify({ success: true, affected: listing_ids.length }), {\r\n              headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n            });\r\n          default:\r\n            return new Response(JSON.stringify({ error: 'Invalid bulk action' }), {\r\n              status: 400,\r\n              headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n\r\n        const { error } = await supabase\r\n          .from('listings')\r\n          .update(updateData)\r\n          .in('id', listing_ids)\r\n          .eq('company_id', company_id);\r\n\r\n        if (error) throw error;\r\n\r\n        // Log the bulk action\r\n        await supabase.from('listing_audit_logs').insert({\r\n          company_id,\r\n          action_type: bulk_action === 'archive' ? 'archive' : 'edit',\r\n          description: `Bulk ${bulk_action}: ${listing_ids.length} listings`,\r\n          changes: { listing_ids, action: bulk_action },\r\n          performed_by: agent_id,\r\n        });\r\n\r\n        return new Response(JSON.stringify({ success: true, affected: listing_ids.length }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      case 'get_analytics': {\r\n        const { listing_id } = body;\r\n\r\n        if (!listing_id) {\r\n          return new Response(JSON.stringify({ error: 'Listing ID is required' }), {\r\n            status: 400,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          });\r\n        }\r\n\r\n        // Get analytics summary\r\n        const { data: analytics } = await supabase\r\n          .rpc('get_listing_analytics_summary', { p_listing_id: listing_id });\r\n\r\n        // Get portal statuses\r\n        const { data: portals } = await supabase\r\n          .from('listing_portals')\r\n          .select('*')\r\n          .eq('listing_id', listing_id);\r\n\r\n        // Get recent inquiries\r\n        const { data: inquiries } = await supabase\r\n          .from('listing_inquiries')\r\n          .select('*')\r\n          .eq('listing_id', listing_id)\r\n          .order('created_at', { ascending: false })\r\n          .limit(10);\r\n\r\n        return new Response(JSON.stringify({ \r\n          analytics: analytics || {},\r\n          portals: portals || [],\r\n          inquiries: inquiries || [],\r\n        }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      default:\r\n        return new Response(JSON.stringify({ error: 'Invalid action' }), {\r\n          status: 400,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n  } catch (error) {\r\n    console.error('[listing-manage] Error:', error);\r\n    return new Response(JSON.stringify({ \r\n      error: error instanceof Error ? error.message : 'Internal server error' \r\n    }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\listing-portal-sync\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\location-search\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\marketing-webhook\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":120,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3867,3870],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3867,3870],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":153,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":153,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4887,4890],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4887,4890],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":183,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":183,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5782,5785],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5782,5785],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":211,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":211,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6696,6699],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6696,6699],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":234,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":234,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7408,7411],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7408,7411],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":260,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":260,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8234,8237],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8234,8237],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":286,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":286,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9314,9317],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9314,9317],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":333,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":333,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10731,10734],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10731,10734],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';\r\n\r\nconst corsHeaders = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',\r\n};\r\n\r\n/**\r\n * Universal Marketing Webhook Handler\r\n * Handles delivery status updates from multiple providers:\r\n * - Meta (WhatsApp Business API)\r\n * - Twilio (SMS & WhatsApp)\r\n * - SendGrid (Email)\r\n * - MessageBird (SMS)\r\n * - Resend (Email)\r\n */\r\nDeno.serve(async (req) => {\r\n  const url = new URL(req.url);\r\n  const provider = url.searchParams.get('provider') || 'meta';\r\n\r\n  // Handle Meta webhook verification\r\n  if (req.method === 'GET' && provider === 'meta') {\r\n    const mode = url.searchParams.get('hub.mode');\r\n    const token = url.searchParams.get('hub.verify_token');\r\n    const challenge = url.searchParams.get('hub.challenge');\r\n    const verifyToken = Deno.env.get('META_WEBHOOK_VERIFY_TOKEN') || 'onelinker_webhook';\r\n\r\n    if (mode === 'subscribe' && token === verifyToken) {\r\n      console.log('Meta webhook verified');\r\n      return new Response(challenge, { status: 200 });\r\n    }\r\n    return new Response('Forbidden', { status: 403 });\r\n  }\r\n\r\n  if (req.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  if (req.method !== 'POST') {\r\n    return new Response('Method not allowed', { status: 405 });\r\n  }\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;\r\n    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;\r\n    const supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n    const payload = await req.json();\r\n    console.log(`Webhook from ${provider}:`, JSON.stringify(payload).slice(0, 500));\r\n\r\n    let updates: WebhookUpdate[] = [];\r\n\r\n    switch (provider) {\r\n      case 'meta':\r\n        updates = parseMetaWebhook(payload);\r\n        break;\r\n      case 'twilio':\r\n        updates = parseTwilioWebhook(payload);\r\n        break;\r\n      case 'sendgrid':\r\n        updates = parseSendGridWebhook(payload);\r\n        break;\r\n      case 'messagebird':\r\n        updates = parseMessageBirdWebhook(payload);\r\n        break;\r\n      case 'resend':\r\n        updates = parseResendWebhook(payload);\r\n        break;\r\n      default:\r\n        console.log(`Unknown provider: ${provider}`);\r\n    }\r\n\r\n    // Process all updates\r\n    for (const update of updates) {\r\n      await processStatusUpdate(supabase, update, provider);\r\n    }\r\n\r\n    // Store raw webhook for debugging\r\n    if (updates.length > 0) {\r\n      const firstUpdate = updates[0];\r\n      await supabase.from('marketing_webhooks').insert({\r\n        company_id: firstUpdate.companyId || '00000000-0000-0000-0000-000000000000',\r\n        provider,\r\n        event_type: firstUpdate.status,\r\n        message_id: firstUpdate.messageId,\r\n        payload,\r\n        status: 'processed',\r\n        processed: true,\r\n        processed_at: new Date().toISOString()\r\n      }).then(result => {\r\n        if (result.error) console.log('Webhook log error:', result.error);\r\n      });\r\n    }\r\n\r\n    return new Response(JSON.stringify({ success: true, processed: updates.length }), {\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  } catch (error) {\r\n    console.error('Webhook error:', error);\r\n    return new Response(JSON.stringify({ error: 'Processing failed' }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n});\r\n\r\ninterface WebhookUpdate {\r\n  messageId: string;\r\n  status: 'sent' | 'delivered' | 'read' | 'failed' | 'bounced' | 'clicked' | 'opened';\r\n  timestamp: Date;\r\n  errorMessage?: string;\r\n  errorCode?: string;\r\n  recipientPhone?: string;\r\n  recipientEmail?: string;\r\n  companyId?: string;\r\n}\r\n\r\n// ==================== PARSERS ====================\r\n\r\nfunction parseMetaWebhook(payload: any): WebhookUpdate[] {\r\n  const updates: WebhookUpdate[] = [];\r\n  \r\n  for (const entry of payload.entry || []) {\r\n    for (const change of entry.changes || []) {\r\n      if (change.field === 'messages' && change.value?.statuses) {\r\n        for (const status of change.value.statuses) {\r\n          updates.push({\r\n            messageId: status.id,\r\n            status: mapMetaStatus(status.status),\r\n            timestamp: new Date(parseInt(status.timestamp) * 1000),\r\n            errorMessage: status.errors?.[0]?.message,\r\n            errorCode: status.errors?.[0]?.code?.toString(),\r\n            recipientPhone: status.recipient_id\r\n          });\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  return updates;\r\n}\r\n\r\nfunction mapMetaStatus(status: string): WebhookUpdate['status'] {\r\n  switch (status) {\r\n    case 'sent': return 'sent';\r\n    case 'delivered': return 'delivered';\r\n    case 'read': return 'read';\r\n    case 'failed': return 'failed';\r\n    default: return 'sent';\r\n  }\r\n}\r\n\r\nfunction parseTwilioWebhook(payload: any): WebhookUpdate[] {\r\n  // Twilio sends form-urlencoded data, but we receive it as JSON from our middleware\r\n  const status = payload.MessageStatus || payload.SmsStatus;\r\n  const messageSid = payload.MessageSid || payload.SmsSid;\r\n  \r\n  if (!messageSid) return [];\r\n  \r\n  return [{\r\n    messageId: messageSid,\r\n    status: mapTwilioStatus(status),\r\n    timestamp: new Date(),\r\n    errorMessage: payload.ErrorMessage,\r\n    errorCode: payload.ErrorCode,\r\n    recipientPhone: payload.To\r\n  }];\r\n}\r\n\r\nfunction mapTwilioStatus(status: string): WebhookUpdate['status'] {\r\n  switch (status?.toLowerCase()) {\r\n    case 'queued':\r\n    case 'sending':\r\n    case 'sent': return 'sent';\r\n    case 'delivered': return 'delivered';\r\n    case 'read': return 'read';\r\n    case 'failed':\r\n    case 'undelivered': return 'failed';\r\n    default: return 'sent';\r\n  }\r\n}\r\n\r\nfunction parseSendGridWebhook(payload: any): WebhookUpdate[] {\r\n  // SendGrid sends an array of events\r\n  const events = Array.isArray(payload) ? payload : [payload];\r\n  \r\n  return events.map(event => ({\r\n    messageId: event.sg_message_id || event['smtp-id'] || '',\r\n    status: mapSendGridStatus(event.event),\r\n    timestamp: new Date(event.timestamp * 1000),\r\n    errorMessage: event.reason,\r\n    recipientEmail: event.email\r\n  })).filter(u => u.messageId);\r\n}\r\n\r\nfunction mapSendGridStatus(event: string): WebhookUpdate['status'] {\r\n  switch (event?.toLowerCase()) {\r\n    case 'processed':\r\n    case 'deferred': return 'sent';\r\n    case 'delivered': return 'delivered';\r\n    case 'open': return 'opened';\r\n    case 'click': return 'clicked';\r\n    case 'bounce':\r\n    case 'dropped': return 'bounced';\r\n    case 'spamreport':\r\n    case 'unsubscribe': return 'failed';\r\n    default: return 'sent';\r\n  }\r\n}\r\n\r\nfunction parseMessageBirdWebhook(payload: any): WebhookUpdate[] {\r\n  if (!payload.id) return [];\r\n  \r\n  return [{\r\n    messageId: payload.id,\r\n    status: mapMessageBirdStatus(payload.status),\r\n    timestamp: new Date(payload.statusDatetime || Date.now()),\r\n    errorMessage: payload.statusErrorCode ? `Error: ${payload.statusErrorCode}` : undefined,\r\n    recipientPhone: payload.recipient\r\n  }];\r\n}\r\n\r\nfunction mapMessageBirdStatus(status: string): WebhookUpdate['status'] {\r\n  switch (status?.toLowerCase()) {\r\n    case 'sent':\r\n    case 'buffered': return 'sent';\r\n    case 'delivered': return 'delivered';\r\n    case 'expired':\r\n    case 'delivery_failed': return 'failed';\r\n    default: return 'sent';\r\n  }\r\n}\r\n\r\nfunction parseResendWebhook(payload: any): WebhookUpdate[] {\r\n  if (!payload.data?.email_id) return [];\r\n  \r\n  return [{\r\n    messageId: payload.data.email_id,\r\n    status: mapResendStatus(payload.type),\r\n    timestamp: new Date(payload.created_at || Date.now()),\r\n    errorMessage: payload.data.error?.message,\r\n    recipientEmail: payload.data.to?.[0]\r\n  }];\r\n}\r\n\r\nfunction mapResendStatus(type: string): WebhookUpdate['status'] {\r\n  switch (type) {\r\n    case 'email.sent': return 'sent';\r\n    case 'email.delivered': return 'delivered';\r\n    case 'email.opened': return 'opened';\r\n    case 'email.clicked': return 'clicked';\r\n    case 'email.bounced': return 'bounced';\r\n    case 'email.complained': return 'failed';\r\n    default: return 'sent';\r\n  }\r\n}\r\n\r\n// ==================== PROCESSOR ====================\r\n\r\nasync function processStatusUpdate(supabase: any, update: WebhookUpdate, provider: string) {\r\n  console.log(`Processing ${provider} status: ${update.messageId} -> ${update.status}`);\r\n\r\n  // Find recipient by message ID\r\n  const { data: recipient, error } = await supabase\r\n    .from('campaign_recipients')\r\n    .select('id, campaign_id, company_id, delivery_status')\r\n    .eq('meta_message_id', update.messageId)\r\n    .single();\r\n\r\n  if (error || !recipient) {\r\n    console.log(`Recipient not found for ${update.messageId}`);\r\n    return;\r\n  }\r\n\r\n  // Don't downgrade status (e.g., don't change 'read' back to 'delivered')\r\n  const statusOrder = ['queued', 'sending', 'sent', 'delivered', 'opened', 'read', 'clicked'];\r\n  const currentIndex = statusOrder.indexOf(recipient.delivery_status);\r\n  const newIndex = statusOrder.indexOf(update.status);\r\n  \r\n  if (update.status !== 'failed' && update.status !== 'bounced' && newIndex <= currentIndex) {\r\n    console.log(`Skipping status downgrade: ${recipient.delivery_status} -> ${update.status}`);\r\n    return;\r\n  }\r\n\r\n  // Build update data\r\n  const updateData: Record<string, any> = {\r\n    delivery_status: update.status === 'opened' ? 'read' : update.status,\r\n    updated_at: new Date().toISOString()\r\n  };\r\n\r\n  switch (update.status) {\r\n    case 'sent':\r\n      updateData.sent_at = update.timestamp.toISOString();\r\n      break;\r\n    case 'delivered':\r\n      updateData.delivered_at = update.timestamp.toISOString();\r\n      break;\r\n    case 'read':\r\n    case 'opened':\r\n      updateData.read_at = update.timestamp.toISOString();\r\n      break;\r\n    case 'clicked':\r\n      updateData.read_at = updateData.read_at || update.timestamp.toISOString();\r\n      break;\r\n    case 'failed':\r\n    case 'bounced':\r\n      updateData.failed_at = update.timestamp.toISOString();\r\n      updateData.error_message = update.errorMessage;\r\n      updateData.error_code = update.errorCode;\r\n      break;\r\n  }\r\n\r\n  // Update recipient\r\n  await supabase\r\n    .from('campaign_recipients')\r\n    .update(updateData)\r\n    .eq('id', recipient.id);\r\n\r\n  // Update campaign counters\r\n  const counterField = getCounterField(update.status);\r\n  if (counterField) {\r\n    await supabase.rpc('increment', {\r\n      row_id: recipient.campaign_id,\r\n      table_name: 'campaigns',\r\n      field_name: counterField\r\n    }).catch(() => {\r\n      // Fallback: manual increment\r\n      supabase\r\n        .from('campaigns')\r\n        .select(counterField)\r\n        .eq('id', recipient.campaign_id)\r\n        .single()\r\n        .then(({ data }: any) => {\r\n          if (data) {\r\n            supabase\r\n              .from('campaigns')\r\n              .update({ [counterField]: (data[counterField] || 0) + 1 })\r\n              .eq('id', recipient.campaign_id);\r\n          }\r\n        });\r\n    });\r\n  }\r\n\r\n  // Log the update\r\n  await supabase.from('campaign_logs').insert({\r\n    campaign_id: recipient.campaign_id,\r\n    company_id: recipient.company_id,\r\n    action: `${provider}: ${update.status}`,\r\n    action_type: update.status,\r\n    recipient_id: recipient.id,\r\n    details: { \r\n      message_id: update.messageId,\r\n      error: update.errorMessage,\r\n      provider\r\n    }\r\n  });\r\n\r\n  console.log(`Updated recipient ${recipient.id} to ${update.status}`);\r\n}\r\n\r\nfunction getCounterField(status: string): string | null {\r\n  switch (status) {\r\n    case 'delivered': return 'delivered_count';\r\n    case 'read':\r\n    case 'opened': return 'opened_count';\r\n    case 'clicked': return 'clicked_count';\r\n    case 'failed':\r\n    case 'bounced': return 'failed_count';\r\n    default: return null;\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\meta-lead-webhook\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":13,"column":86,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":89,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[582,585],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[582,585],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":35,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1252,1255],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1252,1255],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":175,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":175,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6168,6171],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6168,6171],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":182,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":182,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6454,6457],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6454,6457],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":198,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":198,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7114,7117],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7114,7117],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":312,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":312,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11575,11578],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11575,11578],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { serve } from \"https://deno.land/std@0.168.0/http/server.ts\";\r\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2\";\r\n\r\nconst supabaseUrl = Deno.env.get(\"SUPABASE_URL\")!;\r\nconst supabaseServiceKey = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!;\r\n\r\nconst corsHeaders = {\r\n  \"Access-Control-Allow-Origin\": \"*\",\r\n  \"Access-Control-Allow-Headers\": \"authorization, x-client-info, apikey, content-type, x-hub-signature-256\",\r\n};\r\n\r\n// Fetch full lead details from Meta Graph API\r\nasync function fetchLeadDetails(leadgenId: string, pageAccessToken: string): Promise<any> {\r\n  try {\r\n    const url = `https://graph.facebook.com/v24.0/${leadgenId}?access_token=${pageAccessToken}`;\r\n    console.log(`Fetching lead details for ${leadgenId}`);\r\n\r\n    const response = await fetch(url);\r\n    const data = await response.json();\r\n\r\n    if (data.error) {\r\n      console.error(`Graph API error for lead ${leadgenId}:`, data.error);\r\n      return null;\r\n    }\r\n\r\n    console.log(`Lead details fetched:`, JSON.stringify(data));\r\n    return data;\r\n  } catch (error) {\r\n    console.error(`Error fetching lead ${leadgenId}:`, error);\r\n    return null;\r\n  }\r\n}\r\n\r\n// Parse lead field data from Graph API response\r\nfunction parseLeadFields(fieldData: any[]): {\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n  otherFields: Record<string, string>;\r\n} {\r\n  let name = \"\";\r\n  let phone = \"\";\r\n  let email = \"\";\r\n  const otherFields: Record<string, string> = {};\r\n  let firstName = \"\";\r\n  let lastName = \"\";\r\n\r\n  for (const field of fieldData || []) {\r\n    const fieldName = field.name?.toLowerCase() || \"\";\r\n    const value = field.values?.[0] || \"\";\r\n\r\n    if (fieldName === \"full_name\" || fieldName === \"name\") {\r\n      name = value;\r\n    } else if (fieldName === \"first_name\") {\r\n      firstName = value;\r\n    } else if (fieldName === \"last_name\") {\r\n      lastName = value;\r\n    } else if (fieldName === \"phone_number\" || fieldName === \"phone\") {\r\n      phone = value;\r\n    } else if (fieldName === \"email\") {\r\n      email = value;\r\n    } else {\r\n      otherFields[fieldName] = value;\r\n    }\r\n  }\r\n\r\n  // Combine first/last name if full_name not provided\r\n  if (!name && (firstName || lastName)) {\r\n    name = `${firstName} ${lastName}`.trim();\r\n  }\r\n\r\n  return { name, phone, email, otherFields };\r\n}\r\n\r\nserve(async (req) => {\r\n  const url = new URL(req.url);\r\n\r\n  // Handle CORS preflight\r\n  if (req.method === \"OPTIONS\") {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  // âœ… WEBHOOK VERIFICATION (GET)\r\n  if (req.method === \"GET\") {\r\n    const mode = url.searchParams.get(\"hub.mode\");\r\n    const token = url.searchParams.get(\"hub.verify_token\");\r\n    const challenge = url.searchParams.get(\"hub.challenge\");\r\n\r\n    console.log(\"ðŸ“‹ Webhook verification request:\", { mode, token: token ? \"***\" : \"missing\", challenge });\r\n\r\n    // Accept any verify token for now, or use a specific one\r\n    // You should set this in Facebook App settings\r\n    const expectedToken = Deno.env.get(\"META_WEBHOOK_VERIFY_TOKEN\") || \"Bloch@741\";\r\n\r\n    if (mode === \"subscribe\" && token === expectedToken) {\r\n      console.log(\"âœ… Verification successful, returning challenge\");\r\n      return new Response(challenge, {\r\n        status: 200,\r\n        headers: corsHeaders,\r\n      });\r\n    }\r\n\r\n    console.log(\"âŒ Verification failed - token mismatch or invalid mode\");\r\n    return new Response(\"Verification failed\", {\r\n      status: 403,\r\n      headers: corsHeaders,\r\n    });\r\n  }\r\n\r\n  // âœ… LEAD DATA (POST)\r\n  if (req.method === \"POST\") {\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n      const body = await req.json();\r\n      console.log(\"ðŸ“¥ Incoming Meta Lead Webhook:\", JSON.stringify(body, null, 2));\r\n\r\n      // Immediately return 200 to acknowledge receipt (Facebook requires this within 20 seconds)\r\n      // We'll process in the background\r\n\r\n      const supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n      // Parse Meta Lead Ads format\r\n      if (body.entry && Array.isArray(body.entry)) {\r\n        for (const entry of body.entry) {\r\n          const pageId = entry.id;\r\n          const changes = entry.changes || [];\r\n\r\n          for (const change of changes) {\r\n            if (change.field === \"leadgen\") {\r\n              const leadData = change.value;\r\n\r\n              const leadgenId = leadData.leadgen_id;\r\n              const formId = leadData.form_id;\r\n              const adId = leadData.ad_id;\r\n              // Use current time if created_time is in the future (test webhooks use fake timestamps)\r\n              const now = new Date();\r\n              let createdTime = now.toISOString();\r\n              if (leadData.created_time) {\r\n                const parsedTime = new Date(leadData.created_time * 1000);\r\n                // Only use Facebook's time if it's not in the future\r\n                if (parsedTime <= now) {\r\n                  createdTime = parsedTime.toISOString();\r\n                }\r\n              }\r\n\r\n              console.log(`ðŸ”” New lead received: ${leadgenId} from page ${pageId}`);\r\n\r\n              // Check if we already processed this lead\r\n              const { data: existingLead } = await supabase\r\n                .from(\"leads\")\r\n                .select(\"id\")\r\n                .eq(\"external_id\", leadgenId)\r\n                .maybeSingle();\r\n\r\n              if (existingLead) {\r\n                console.log(`â­ï¸ Lead ${leadgenId} already exists (${existingLead.id}), skipping`);\r\n                continue;\r\n              }\r\n\r\n              // Find company with this Meta page connected\r\n              const { data: leadSource, error: sourceError } = await supabase\r\n                .from(\"lead_sources\")\r\n                .select(\"id, company_id, connection_details\")\r\n                .eq(\"source_name\", \"meta\")\r\n                .eq(\"status\", \"connected\")\r\n                .single();\r\n\r\n              if (sourceError || !leadSource) {\r\n                console.error(\"âŒ No active Meta lead source found:\", sourceError);\r\n                continue;\r\n              }\r\n\r\n              const companyId = leadSource.company_id;\r\n              const connectionDetails = leadSource.connection_details as any;\r\n\r\n              // Find the page access token\r\n              let pageAccessToken = connectionDetails?.access_token;\r\n              const pages = connectionDetails?.pages || [];\r\n\r\n              // Try to find specific page token\r\n              const matchingPage = pages.find((p: any) => p.id === pageId);\r\n              if (matchingPage?.access_token) {\r\n                pageAccessToken = matchingPage.access_token;\r\n              }\r\n\r\n              if (!pageAccessToken) {\r\n                console.error(\"âŒ No page access token found for page:\", pageId);\r\n                continue;\r\n              }\r\n\r\n              // Fetch full lead details from Graph API\r\n              const fullLeadData = await fetchLeadDetails(leadgenId, pageAccessToken);\r\n\r\n              let leadName = `Meta Lead ${leadgenId.slice(-6)}`;\r\n              let leadPhone = null;\r\n              let leadEmail = null;\r\n              let sourceMetadata: Record<string, any> = {\r\n                form_id: formId,\r\n                page_id: pageId,\r\n                ad_id: adId,\r\n                leadgen_id: leadgenId,\r\n                received_at: createdTime,\r\n              };\r\n\r\n              if (fullLeadData) {\r\n                const parsed = parseLeadFields(fullLeadData.field_data);\r\n                leadName = parsed.name || leadName;\r\n                leadPhone = parsed.phone || null;\r\n                leadEmail = parsed.email || null;\r\n                sourceMetadata = {\r\n                  ...sourceMetadata,\r\n                  ...parsed.otherFields,\r\n                  form_name: fullLeadData.form_name,\r\n                  campaign_name: fullLeadData.campaign_name,\r\n                  ad_name: fullLeadData.ad_name,\r\n                  adset_name: fullLeadData.adset_name,\r\n                  platform: fullLeadData.platform,\r\n                };\r\n              }\r\n\r\n              // Find or create 'New' stage for this company\r\n              let { data: newStage } = await supabase\r\n                .from(\"lead_stages\")\r\n                .select(\"id, name\")\r\n                .eq(\"company_id\", companyId)\r\n                .eq(\"name\", \"New\")\r\n                .maybeSingle();\r\n\r\n              if (!newStage) {\r\n                const { data: defaultStage } = await supabase\r\n                  .from(\"lead_stages\")\r\n                  .select(\"id, name\")\r\n                  .eq(\"company_id\", companyId)\r\n                  .eq(\"is_default\", true)\r\n                  .maybeSingle();\r\n                newStage = defaultStage;\r\n              }\r\n\r\n              // Prepare lead record\r\n              const leadRecord = {\r\n                company_id: companyId,\r\n                external_id: leadgenId,\r\n                source: \"Meta\",\r\n                stage: newStage?.name || \"New\",\r\n                stage_id: newStage?.id || null,\r\n                is_new: true,\r\n                received_at: createdTime,\r\n                created_at: createdTime,\r\n                name: leadName,\r\n                phone: leadPhone,\r\n                email: leadEmail,\r\n                source_metadata: sourceMetadata,\r\n              };\r\n\r\n              console.log(\"ðŸ“ Inserting lead:\", JSON.stringify(leadRecord));\r\n\r\n              // Insert the lead\r\n              const { data: insertedLead, error: insertError } = await supabase\r\n                .from(\"leads\")\r\n                .insert(leadRecord)\r\n                .select()\r\n                .single();\r\n\r\n              if (insertError) {\r\n                console.error(\"âŒ Error inserting lead:\", insertError);\r\n\r\n                // Log the error for debugging\r\n                try {\r\n                  await supabase.from(\"lead_activities\").insert({\r\n                    lead_id: null,\r\n                    company_id: companyId,\r\n                    type: \"error\",\r\n                    description: `Failed to insert Meta lead: ${insertError.message}`,\r\n                    metadata: {\r\n                      error: insertError,\r\n                      leadgen_id: leadgenId,\r\n                      lead_data: leadRecord,\r\n                    },\r\n                  });\r\n                } catch (logError) {\r\n                  console.error(\"Failed to log error:\", logError);\r\n                }\r\n              } else {\r\n                console.log(\"âœ… Lead inserted successfully:\", insertedLead.id);\r\n\r\n                // Log activity for lead creation\r\n                try {\r\n                  await supabase.from(\"lead_activities\").insert({\r\n                    lead_id: insertedLead.id,\r\n                    company_id: companyId,\r\n                    type: \"created\",\r\n                    description: `Lead received from Meta Lead Ads`,\r\n                    metadata: {\r\n                      source: \"Meta\",\r\n                      form_id: formId,\r\n                      page_id: pageId,\r\n                      received_at: createdTime,\r\n                      processing_time_ms: Date.now() - startTime,\r\n                    },\r\n                  });\r\n                } catch (activityError) {\r\n                  console.error(\"Failed to log activity:\", activityError);\r\n                }\r\n\r\n                // Update lead source stats\r\n                try {\r\n                  await supabase\r\n                    .from(\"lead_sources\")\r\n                    .update({\r\n                      last_fetched_at: new Date().toISOString(),\r\n                      total_leads_fetched: (leadSource as any).total_leads_fetched + 1,\r\n                    })\r\n                    .eq(\"id\", leadSource.id);\r\n                } catch (statsError) {\r\n                  console.error(\"Failed to update source stats:\", statsError);\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      console.log(`âœ… Webhook processed in ${Date.now() - startTime}ms`);\r\n      return new Response(\"EVENT_RECEIVED\", {\r\n        status: 200,\r\n        headers: corsHeaders,\r\n      });\r\n    } catch (error) {\r\n      console.error(\"âŒ Error processing POST body:\", error);\r\n      // Always return 200 to prevent Facebook from retrying\r\n      return new Response(\"EVENT_RECEIVED\", {\r\n        status: 200,\r\n        headers: corsHeaders,\r\n      });\r\n    }\r\n  }\r\n\r\n  return new Response(\"Method not allowed\", {\r\n    status: 405,\r\n    headers: corsHeaders,\r\n  });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\meta-oauth\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":72,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3143,3146],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3143,3146],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":385,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":385,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15127,15130],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15127,15130],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { serve } from \"https://deno.land/std@0.168.0/http/server.ts\";\r\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2\";\r\n\r\nconst corsHeaders = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',\r\n};\r\n\r\nconst META_APP_ID = Deno.env.get('META_APP_ID');\r\nconst META_APP_SECRET = Deno.env.get('META_APP_SECRET');\r\nconst META_WEBHOOK_VERIFY_TOKEN = Deno.env.get('META_WEBHOOK_VERIFY_TOKEN') || 'onelinker_webhook_verify_2024';\r\nconst SUPABASE_URL = Deno.env.get('SUPABASE_URL')!;\r\nconst SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;\r\n\r\nserve(async (req) => {\r\n  const url = new URL(req.url);\r\n  const action = url.searchParams.get('action');\r\n\r\n  // ============ WEBHOOK VERIFICATION (GET) ============\r\n  // Meta sends GET request to verify webhook endpoint\r\n  if (req.method === 'GET' && action === 'webhook') {\r\n    const mode = url.searchParams.get('hub.mode');\r\n    const token = url.searchParams.get('hub.verify_token');\r\n    const challenge = url.searchParams.get('hub.challenge');\r\n\r\n    console.log('Webhook verification request:', { mode, token, challenge });\r\n\r\n    if (mode === 'subscribe' && token === META_WEBHOOK_VERIFY_TOKEN) {\r\n      console.log('Webhook verified successfully');\r\n      return new Response(challenge, { status: 200 });\r\n    } else {\r\n      console.error('Webhook verification failed');\r\n      return new Response('Forbidden', { status: 403 });\r\n    }\r\n  }\r\n\r\n  // ============ WEBHOOK NOTIFICATIONS (POST) ============\r\n  // Meta sends POST request when new leads come in\r\n  if (req.method === 'POST' && action === 'webhook') {\r\n    try {\r\n      const body = await req.json();\r\n      console.log('Webhook received:', JSON.stringify(body));\r\n\r\n      // Acknowledge immediately (Meta requires fast response)\r\n      const processWebhook = async () => {\r\n        const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);\r\n\r\n        // Process leadgen entries\r\n        if (body.object === 'page' && body.entry) {\r\n          for (const entry of body.entry) {\r\n            const pageId = entry.id;\r\n            \r\n            for (const change of (entry.changes || [])) {\r\n              if (change.field === 'leadgen') {\r\n                const leadgenId = change.value.leadgen_id;\r\n                const formId = change.value.form_id;\r\n                const adId = change.value.ad_id;\r\n                const adgroupId = change.value.adgroup_id;\r\n                const createdTime = change.value.created_time;\r\n\r\n                console.log('Processing lead:', { leadgenId, formId, pageId });\r\n\r\n                // Find the lead source connected to this page\r\n                const { data: sources } = await supabase\r\n                  .from('lead_sources')\r\n                  .select('*')\r\n                  .eq('source_name', 'meta')\r\n                  .eq('status', 'connected');\r\n\r\n                for (const source of (sources || [])) {\r\n                  const { access_token, pages } = source.connection_details || {};\r\n                  const connectedPage = pages?.find((p: any) => p.id === pageId);\r\n                  \r\n                  if (!connectedPage) continue;\r\n\r\n                  const pageToken = connectedPage.access_token || access_token;\r\n\r\n                  // Fetch the actual lead data from Meta\r\n                  const leadResponse = await fetch(\r\n                    `https://graph.facebook.com/v18.0/${leadgenId}?access_token=${pageToken}`\r\n                  );\r\n                  const leadData = await leadResponse.json();\r\n\r\n                  if (leadData.error) {\r\n                    console.error('Error fetching lead:', leadData.error);\r\n                    continue;\r\n                  }\r\n\r\n                  // Parse lead fields\r\n                  const fieldData: Record<string, string> = {};\r\n                  for (const field of (leadData.field_data || [])) {\r\n                    fieldData[field.name] = field.values?.[0] || '';\r\n                  }\r\n\r\n                  // Check for duplicates\r\n                  const { data: existing } = await supabase\r\n                    .from('leads')\r\n                    .select('id')\r\n                    .eq('company_id', source.company_id)\r\n                    .eq('external_id', leadgenId)\r\n                    .single();\r\n\r\n                  if (existing) {\r\n                    console.log('Lead already exists:', leadgenId);\r\n                    continue;\r\n                  }\r\n\r\n                  // Get form details for additional context\r\n                  let formName = '';\r\n                  try {\r\n                    const formResponse = await fetch(\r\n                      `https://graph.facebook.com/v18.0/${formId}?access_token=${pageToken}&fields=name`\r\n                    );\r\n                    const formData = await formResponse.json();\r\n                    formName = formData.name || '';\r\n                  } catch (e) {\r\n                    console.error('Error fetching form name:', e);\r\n                  }\r\n\r\n                  // Insert lead into database\r\n                  const { error: insertError } = await supabase.from('leads').insert({\r\n                    company_id: source.company_id,\r\n                    lead_source_id: source.id,\r\n                    external_id: leadgenId,\r\n                    name: fieldData.full_name || fieldData.name || `${fieldData.first_name || ''} ${fieldData.last_name || ''}`.trim() || 'New Lead',\r\n                    email: fieldData.email || null,\r\n                    phone: fieldData.phone_number || fieldData.phone || null,\r\n                    source: 'Meta',\r\n                    source_metadata: {\r\n                      platform: 'meta',\r\n                      page_id: pageId,\r\n                      page_name: connectedPage.name,\r\n                      form_id: formId,\r\n                      form_name: formName,\r\n                      ad_id: adId,\r\n                      adgroup_id: adgroupId,\r\n                      created_time: createdTime,\r\n                      webhook: true,\r\n                      raw_data: leadData\r\n                    },\r\n                    mapped_fields: fieldData,\r\n                    fetched_at: new Date().toISOString(),\r\n                    is_opted_in: true,\r\n                    stage: 'new'\r\n                  });\r\n\r\n                  if (insertError) {\r\n                    console.error('Error inserting lead:', insertError);\r\n                  } else {\r\n                    console.log('Lead created from webhook:', leadgenId);\r\n                    \r\n                    // Update source stats\r\n                    await supabase\r\n                      .from('lead_sources')\r\n                      .update({\r\n                        last_fetched_at: new Date().toISOString(),\r\n                        total_leads_fetched: (source.total_leads_fetched || 0) + 1\r\n                      })\r\n                      .eq('id', source.id);\r\n\r\n                    // Log the webhook lead\r\n                    await supabase.from('lead_source_logs').insert({\r\n                      source_id: source.id,\r\n                      company_id: source.company_id,\r\n                      action: 'webhook',\r\n                      status: 'success',\r\n                      leads_processed: 1,\r\n                      leads_created: 1,\r\n                      leads_updated: 0,\r\n                      leads_skipped: 0\r\n                    });\r\n                  }\r\n                  break; // Found the matching source, no need to continue\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      };\r\n\r\n      // Process in background but respond immediately\r\n      processWebhook().catch(console.error);\r\n\r\n      return new Response('EVENT_RECEIVED', { status: 200 });\r\n    } catch (error) {\r\n      console.error('Webhook error:', error);\r\n      return new Response('EVENT_RECEIVED', { status: 200 }); // Always respond 200 to Meta\r\n    }\r\n  }\r\n\r\n  // Handle CORS preflight requests\r\n  if (req.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  try {\r\n    // Initialize OAuth - redirect user to Meta login\r\n    if (action === 'init') {\r\n      const sourceId = url.searchParams.get('source_id');\r\n      const companyId = url.searchParams.get('company_id');\r\n      const redirectUri = url.searchParams.get('redirect_uri');\r\n\r\n      if (!sourceId || !companyId || !redirectUri) {\r\n        return new Response(JSON.stringify({ error: 'Missing required parameters' }), {\r\n          status: 400,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      // Store state for verification\r\n      const state = btoa(JSON.stringify({ sourceId, companyId, redirectUri }));\r\n      \r\n      // Meta OAuth URL with required permissions for Lead Ads\r\n      const scopes = [\r\n        'leads_retrieval',\r\n        'pages_read_engagement', \r\n        'pages_manage_metadata',\r\n        'pages_show_list',\r\n        'business_management'\r\n      ].join(',');\r\n\r\n      const callbackUrl = `${SUPABASE_URL}/functions/v1/meta-oauth?action=callback`;\r\n      \r\n      const authUrl = `https://www.facebook.com/v18.0/dialog/oauth?` +\r\n        `client_id=${META_APP_ID}` +\r\n        `&redirect_uri=${encodeURIComponent(callbackUrl)}` +\r\n        `&state=${encodeURIComponent(state)}` +\r\n        `&scope=${encodeURIComponent(scopes)}` +\r\n        `&response_type=code`;\r\n\r\n      return new Response(JSON.stringify({ authUrl }), {\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      });\r\n    }\r\n\r\n    // Handle OAuth callback from Meta\r\n    if (action === 'callback') {\r\n      const code = url.searchParams.get('code');\r\n      const stateParam = url.searchParams.get('state');\r\n      const error = url.searchParams.get('error');\r\n      const errorDescription = url.searchParams.get('error_description');\r\n\r\n      if (error) {\r\n        console.error('OAuth error:', error, errorDescription);\r\n        const state = JSON.parse(atob(stateParam || ''));\r\n        return Response.redirect(`${state.redirectUri}?error=${encodeURIComponent(errorDescription || error)}`);\r\n      }\r\n\r\n      if (!code || !stateParam) {\r\n        return new Response('Missing code or state', { status: 400 });\r\n      }\r\n\r\n      const state = JSON.parse(atob(stateParam));\r\n      const { sourceId, companyId, redirectUri } = state;\r\n\r\n      const callbackUrl = `${SUPABASE_URL}/functions/v1/meta-oauth?action=callback`;\r\n\r\n      // Exchange code for access token\r\n      const tokenResponse = await fetch(\r\n        `https://graph.facebook.com/v18.0/oauth/access_token?` +\r\n        `client_id=${META_APP_ID}` +\r\n        `&client_secret=${META_APP_SECRET}` +\r\n        `&redirect_uri=${encodeURIComponent(callbackUrl)}` +\r\n        `&code=${code}`\r\n      );\r\n\r\n      const tokenData = await tokenResponse.json();\r\n\r\n      if (tokenData.error) {\r\n        console.error('Token exchange error:', tokenData.error);\r\n        return Response.redirect(`${redirectUri}?error=${encodeURIComponent(tokenData.error.message)}`);\r\n      }\r\n\r\n      const { access_token, expires_in } = tokenData;\r\n\r\n      // Get long-lived access token\r\n      const longLivedResponse = await fetch(\r\n        `https://graph.facebook.com/v18.0/oauth/access_token?` +\r\n        `grant_type=fb_exchange_token` +\r\n        `&client_id=${META_APP_ID}` +\r\n        `&client_secret=${META_APP_SECRET}` +\r\n        `&fb_exchange_token=${access_token}`\r\n      );\r\n\r\n      const longLivedData = await longLivedResponse.json();\r\n      const longLivedToken = longLivedData.access_token || access_token;\r\n      const tokenExpiry = longLivedData.expires_in || expires_in || 5184000; // Default to 60 days if no expiry\r\n\r\n      // Get user's pages with Lead Ads access\r\n      const pagesResponse = await fetch(\r\n        `https://graph.facebook.com/v18.0/me/accounts?access_token=${longLivedToken}`\r\n      );\r\n      const pagesData = await pagesResponse.json();\r\n\r\n      // Store connection in database\r\n      const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);\r\n\r\n      // Safely calculate token expiry date\r\n      let tokenExpiresAt: string;\r\n      try {\r\n        const expiryMs = typeof tokenExpiry === 'number' && tokenExpiry > 0 \r\n          ? tokenExpiry * 1000 \r\n          : 5184000000; // Default 60 days in ms\r\n        tokenExpiresAt = new Date(Date.now() + expiryMs).toISOString();\r\n      } catch {\r\n        tokenExpiresAt = new Date(Date.now() + 5184000000).toISOString(); // Default 60 days\r\n      }\r\n\r\n      const connectionDetails = {\r\n        access_token: longLivedToken,\r\n        token_expires_at: tokenExpiresAt,\r\n        pages: pagesData.data || [],\r\n        connected_at: new Date().toISOString()\r\n      };\r\n\r\n      const { error: updateError } = await supabase\r\n        .from('lead_sources')\r\n        .update({\r\n          connection_details: connectionDetails,\r\n          connection_type: 'oauth',\r\n          status: 'connected',\r\n          last_error: null,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('id', sourceId)\r\n        .eq('company_id', companyId);\r\n\r\n      if (updateError) {\r\n        console.error('Database update error:', updateError);\r\n        return Response.redirect(`${redirectUri}?error=Failed to save connection`);\r\n      }\r\n\r\n      // Log the successful connection\r\n      await supabase.from('lead_source_logs').insert({\r\n        source_id: sourceId,\r\n        company_id: companyId,\r\n        action: 'oauth_connect',\r\n        status: 'success',\r\n        leads_processed: 0,\r\n        leads_created: 0,\r\n        leads_updated: 0,\r\n        leads_skipped: 0\r\n      });\r\n\r\n      // Redirect back to app with success\r\n      return Response.redirect(`${redirectUri}?success=true&source=meta`);\r\n    }\r\n\r\n    // Get forms from connected pages\r\n    if (action === 'get_forms') {\r\n      const authHeader = req.headers.get('Authorization');\r\n      if (!authHeader) {\r\n        return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n          status: 401,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      const { source_id, company_id } = await req.json();\r\n      const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);\r\n\r\n      const { data: source, error: sourceError } = await supabase\r\n        .from('lead_sources')\r\n        .select('*')\r\n        .eq('id', source_id)\r\n        .eq('company_id', company_id)\r\n        .single();\r\n\r\n      if (sourceError || !source) {\r\n        return new Response(JSON.stringify({ error: 'Source not found' }), {\r\n          status: 404,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      const { access_token, pages } = source.connection_details || {};\r\n\r\n      if (!access_token) {\r\n        return new Response(JSON.stringify({ error: 'Not connected' }), {\r\n          status: 400,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      const allForms: any[] = [];\r\n\r\n      for (const page of (pages || [])) {\r\n        const pageToken = page.access_token || access_token;\r\n        \r\n        try {\r\n          const formsResponse = await fetch(\r\n            `https://graph.facebook.com/v18.0/${page.id}/leadgen_forms?access_token=${pageToken}&fields=id,name,status,leads_count,created_time`\r\n          );\r\n          const formsData = await formsResponse.json();\r\n\r\n          if (formsData.data) {\r\n            for (const form of formsData.data) {\r\n              allForms.push({\r\n                id: form.id,\r\n                name: form.name,\r\n                status: form.status,\r\n                leads_count: form.leads_count || 0,\r\n                created_time: form.created_time,\r\n                page_id: page.id,\r\n                page_name: page.name\r\n              });\r\n            }\r\n          }\r\n        } catch (e) {\r\n          console.error(`Error fetching forms for page ${page.id}:`, e);\r\n        }\r\n      }\r\n\r\n      return new Response(JSON.stringify({ forms: allForms }), {\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      });\r\n    }\r\n\r\n    // Fetch leads from Meta with form and date filtering\r\n    if (action === 'fetch_leads') {\r\n      const authHeader = req.headers.get('Authorization');\r\n      if (!authHeader) {\r\n        return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n          status: 401,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      const { source_id, company_id, form_ids, date_from, date_to } = await req.json();\r\n\r\n      const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);\r\n\r\n      // Get source with connection details\r\n      const { data: source, error: sourceError } = await supabase\r\n        .from('lead_sources')\r\n        .select('*')\r\n        .eq('id', source_id)\r\n        .eq('company_id', company_id)\r\n        .single();\r\n\r\n      if (sourceError || !source) {\r\n        return new Response(JSON.stringify({ error: 'Source not found' }), {\r\n          status: 404,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      const { access_token, pages } = source.connection_details || {};\r\n\r\n      if (!access_token) {\r\n        return new Response(JSON.stringify({ error: 'Not connected' }), {\r\n          status: 400,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      let totalCreated = 0;\r\n      let totalSkipped = 0;\r\n      const selectedFormIds = form_ids && form_ids.length > 0 ? new Set(form_ids) : null;\r\n\r\n      // Parse date filters\r\n      const fromDate = date_from ? new Date(date_from) : null;\r\n      const toDate = date_to ? new Date(date_to) : null;\r\n\r\n      console.log('Fetching leads with filters:', { form_ids, date_from, date_to });\r\n\r\n      // Fetch leads from each connected page\r\n      for (const page of (pages || [])) {\r\n        const pageToken = page.access_token || access_token;\r\n        \r\n        // Get leadgen forms for this page\r\n        const formsResponse = await fetch(\r\n          `https://graph.facebook.com/v18.0/${page.id}/leadgen_forms?access_token=${pageToken}`\r\n        );\r\n        const formsData = await formsResponse.json();\r\n\r\n        for (const form of (formsData.data || [])) {\r\n          // Skip if not in selected forms (when filter is active)\r\n          if (selectedFormIds && !selectedFormIds.has(form.id)) {\r\n            continue;\r\n          }\r\n\r\n          // Build leads URL with date filtering\r\n          let leadsUrl = `https://graph.facebook.com/v18.0/${form.id}/leads?access_token=${pageToken}&limit=500`;\r\n          \r\n          // Add date filters if provided\r\n          if (fromDate) {\r\n            leadsUrl += `&filtering=[{\"field\":\"time_created\",\"operator\":\"GREATER_THAN\",\"value\":${Math.floor(fromDate.getTime() / 1000)}}]`;\r\n          }\r\n\r\n          const leadsResponse = await fetch(leadsUrl);\r\n          const leadsData = await leadsResponse.json();\r\n\r\n          for (const lead of (leadsData.data || [])) {\r\n            // Additional date filter check (client-side for safety)\r\n            const leadCreatedTime = new Date(lead.created_time);\r\n            if (fromDate && leadCreatedTime < fromDate) continue;\r\n            if (toDate && leadCreatedTime > toDate) continue;\r\n\r\n            // Parse lead data\r\n            const fieldData: Record<string, string> = {};\r\n            for (const field of (lead.field_data || [])) {\r\n              fieldData[field.name] = field.values?.[0] || '';\r\n            }\r\n\r\n            // Check for duplicates\r\n            const { data: existing } = await supabase\r\n              .from('leads')\r\n              .select('id')\r\n              .eq('company_id', company_id)\r\n              .eq('external_id', lead.id)\r\n              .single();\r\n\r\n            if (existing) {\r\n              totalSkipped++;\r\n              continue;\r\n            }\r\n\r\n            // Insert lead\r\n            const { error: insertError } = await supabase.from('leads').insert({\r\n              company_id,\r\n              lead_source_id: source_id,\r\n              external_id: lead.id,\r\n              name: fieldData.full_name || fieldData.name || `${fieldData.first_name || ''} ${fieldData.last_name || ''}`.trim() || 'Unknown',\r\n              email: fieldData.email || null,\r\n              phone: fieldData.phone_number || fieldData.phone || null,\r\n              source: 'Meta',\r\n              source_metadata: {\r\n                platform: 'meta',\r\n                page_id: page.id,\r\n                page_name: page.name,\r\n                form_id: form.id,\r\n                form_name: form.name,\r\n                raw_data: lead\r\n              },\r\n              mapped_fields: fieldData,\r\n              fetched_at: new Date().toISOString(),\r\n              is_opted_in: true,\r\n              stage: 'Uncontacted'\r\n            });\r\n\r\n            if (!insertError) {\r\n              totalCreated++;\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      // Update source stats\r\n      await supabase\r\n        .from('lead_sources')\r\n        .update({\r\n          last_fetched_at: new Date().toISOString(),\r\n          total_leads_fetched: (source.total_leads_fetched || 0) + totalCreated\r\n        })\r\n        .eq('id', source_id);\r\n\r\n      // Log the fetch\r\n      await supabase.from('lead_source_logs').insert({\r\n        source_id,\r\n        company_id,\r\n        action: 'fetch',\r\n        status: 'success',\r\n        leads_processed: totalCreated + totalSkipped,\r\n        leads_created: totalCreated,\r\n        leads_updated: 0,\r\n        leads_skipped: totalSkipped\r\n      });\r\n\r\n      return new Response(JSON.stringify({ \r\n        success: true, \r\n        created: totalCreated, \r\n        skipped: totalSkipped \r\n      }), {\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      });\r\n    }\r\n\r\n    return new Response(JSON.stringify({ error: 'Invalid action' }), {\r\n      status: 400,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n\r\n  } catch (error: unknown) {\r\n    console.error('Meta OAuth error:', error);\r\n    const message = error instanceof Error ? error.message : 'Unknown error';\r\n    return new Response(JSON.stringify({ error: message }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n});","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\pf-agents\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":227,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":227,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7816,7819],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7816,7819],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":284,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":284,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9493,9496],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9493,9496],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":335,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":335,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11111,11114],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11111,11114],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { serve } from \"https://deno.land/std@0.168.0/http/server.ts\";\r\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2\";\r\n\r\nconst corsHeaders = {\r\n  \"Access-Control-Allow-Origin\": \"*\",\r\n  \"Access-Control-Allow-Headers\": \"authorization, x-client-info, apikey, content-type\",\r\n};\r\n\r\nconst PF_API_BASE = \"https://atlas.propertyfinder.com/v1\";\r\n\r\ninterface AgentsRequest {\r\n  action: \"list\" | \"get\" | \"map\" | \"unmap\";\r\n  portal_account_id: string;\r\n  company_id: string;\r\n  // For list/search\r\n  email?: string;\r\n  status?: \"active\" | \"inactive\" | \"pending\";\r\n  page?: number;\r\n  per_page?: number;\r\n  // For get\r\n  pf_user_id?: number;\r\n  // For map/unmap\r\n  agent_id?: string;\r\n  portal_agent_id?: string;\r\n  portal_public_profile_id?: number;\r\n}\r\n\r\nserve(async (req) => {\r\n  if (req.method === \"OPTIONS\") {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get(\"SUPABASE_URL\")!;\r\n    const supabaseKey = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!;\r\n    const supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\n    // Verify authorization\r\n    const authHeader = req.headers.get(\"Authorization\");\r\n    if (!authHeader) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Missing authorization header\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 401 }\r\n      );\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser(\r\n      authHeader.replace(\"Bearer \", \"\")\r\n    );\r\n\r\n    if (authError || !user) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Unauthorized\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 401 }\r\n      );\r\n    }\r\n\r\n    const body: AgentsRequest = await req.json();\r\n    const { action, portal_account_id, company_id, email, status, page = 1, per_page = 50, pf_user_id, agent_id, portal_agent_id, portal_public_profile_id } = body;\r\n\r\n    console.log(`[pf-agents] Action: ${action}, User: ${user.id}`);\r\n\r\n    // Verify agent and company access - must be admin or manager\r\n    const { data: agent } = await supabase\r\n      .from(\"agents\")\r\n      .select(\"id, company_id, role\")\r\n      .eq(\"user_id\", user.id)\r\n      .eq(\"status\", \"active\")\r\n      .single();\r\n\r\n    if (!agent || agent.company_id !== company_id) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Unauthorized\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 403 }\r\n      );\r\n    }\r\n\r\n    // For map/unmap actions, require admin/manager role\r\n    if ((action === \"map\" || action === \"unmap\") && agent.role !== \"admin\" && agent.role !== \"manager\") {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Only admins and managers can manage agent mappings\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 403 }\r\n      );\r\n    }\r\n\r\n    // Get portal account\r\n    const { data: portalAccount, error: portalError } = await supabase\r\n      .from(\"portal_accounts\")\r\n      .select(\"*\")\r\n      .eq(\"id\", portal_account_id)\r\n      .eq(\"company_id\", company_id)\r\n      .single();\r\n\r\n    if (portalError || !portalAccount) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Portal account not found\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 404 }\r\n      );\r\n    }\r\n\r\n    if (action === \"map\") {\r\n      return await handleMapAgent(supabase, company_id, portal_account_id, agent_id!, portal_agent_id!, portal_public_profile_id);\r\n    }\r\n\r\n    if (action === \"unmap\") {\r\n      return await handleUnmapAgent(supabase, company_id, portal_account_id, agent_id!);\r\n    }\r\n\r\n    // For list and get actions, need to call PF API\r\n    const accessToken = await getAccessToken(supabase, portalAccount);\r\n    if (!accessToken) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Failed to get Property Finder access token\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n      );\r\n    }\r\n\r\n    if (action === \"list\") {\r\n      return await handleListAgents(accessToken, email, status, page, per_page);\r\n    }\r\n\r\n    if (action === \"get\" && pf_user_id) {\r\n      return await handleGetAgent(accessToken, pf_user_id);\r\n    }\r\n\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Invalid action\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n    );\r\n\r\n  } catch (error) {\r\n    console.error(\"[pf-agents] Error:\", error);\r\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: errorMessage }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n});\r\n\r\nasync function handleListAgents(\r\n  accessToken: string,\r\n  email?: string,\r\n  status?: string,\r\n  page: number = 1,\r\n  perPage: number = 50\r\n): Promise<Response> {\r\n  const params = new URLSearchParams();\r\n  params.set(\"page\", page.toString());\r\n  params.set(\"perPage\", perPage.toString());\r\n  \r\n  if (email) params.set(\"email\", email);\r\n  if (status) params.set(\"status\", status);\r\n\r\n  try {\r\n    const response = await fetch(`${PF_API_BASE}/users?${params.toString()}`, {\r\n      method: \"GET\",\r\n      headers: {\r\n        \"Authorization\": `Bearer ${accessToken}`,\r\n        \"Accept\": \"application/json\",\r\n      },\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text();\r\n      console.error(`[pf-agents] API error: ${response.status}`, errorText);\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: `Property Finder API error: ${response.status}` }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: response.status }\r\n      );\r\n    }\r\n\r\n    const data = await response.json();\r\n    const agents = (data.data || data || []).map(formatAgent);\r\n\r\n    return new Response(\r\n      JSON.stringify({ \r\n        success: true, \r\n        agents,\r\n        pagination: data.meta || data.pagination || null,\r\n      }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n    );\r\n  } catch (error) {\r\n    console.error(\"[pf-agents] List agents error:\", error);\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Failed to fetch agents\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nasync function handleGetAgent(accessToken: string, pfUserId: number): Promise<Response> {\r\n  try {\r\n    const response = await fetch(`${PF_API_BASE}/users/${pfUserId}`, {\r\n      method: \"GET\",\r\n      headers: {\r\n        \"Authorization\": `Bearer ${accessToken}`,\r\n        \"Accept\": \"application/json\",\r\n      },\r\n    });\r\n\r\n    if (!response.ok) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: `User not found: ${response.status}` }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: response.status }\r\n      );\r\n    }\r\n\r\n    const data = await response.json();\r\n\r\n    return new Response(\r\n      JSON.stringify({ success: true, agent: formatAgent(data) }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n    );\r\n  } catch (error) {\r\n    console.error(\"[pf-agents] Get agent error:\", error);\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Failed to fetch agent\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nasync function handleMapAgent(\r\n  // deno-lint-ignore no-explicit-any\r\n  supabase: any,\r\n  companyId: string,\r\n  portalAccountId: string,\r\n  agentId: string,\r\n  portalAgentId: string,\r\n  portalPublicProfileId?: number\r\n): Promise<Response> {\r\n  // Get CRM agent details\r\n  const { data: crmAgent } = await supabase\r\n    .from(\"agents\")\r\n    .select(\"id, name, email\")\r\n    .eq(\"id\", agentId)\r\n    .single();\r\n\r\n  if (!crmAgent) {\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"CRM agent not found\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 404 }\r\n    );\r\n  }\r\n\r\n  // Upsert the mapping\r\n  const { data: mapping, error } = await supabase\r\n    .from(\"pf_agent_mappings\")\r\n    .upsert({\r\n      company_id: companyId,\r\n      portal_account_id: portalAccountId,\r\n      agent_id: agentId,\r\n      portal_agent_id: portalAgentId,\r\n      portal_public_profile_id: portalPublicProfileId || parseInt(portalAgentId),\r\n      agent_email: crmAgent.email,\r\n      agent_name: crmAgent.name,\r\n      is_active: true,\r\n      updated_at: new Date().toISOString(),\r\n    }, { \r\n      onConflict: \"portal_account_id,agent_id\",\r\n      ignoreDuplicates: false \r\n    })\r\n    .select()\r\n    .single();\r\n\r\n  if (error) {\r\n    console.error(\"[pf-agents] Map agent error:\", error);\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: error.message }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n\r\n  return new Response(\r\n    JSON.stringify({ success: true, mapping }),\r\n    { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n  );\r\n}\r\n\r\nasync function handleUnmapAgent(\r\n  // deno-lint-ignore no-explicit-any\r\n  supabase: any,\r\n  companyId: string,\r\n  portalAccountId: string,\r\n  agentId: string\r\n): Promise<Response> {\r\n  const { error } = await supabase\r\n    .from(\"pf_agent_mappings\")\r\n    .update({ is_active: false, updated_at: new Date().toISOString() })\r\n    .eq(\"company_id\", companyId)\r\n    .eq(\"portal_account_id\", portalAccountId)\r\n    .eq(\"agent_id\", agentId);\r\n\r\n  if (error) {\r\n    console.error(\"[pf-agents] Unmap agent error:\", error);\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: error.message }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n\r\n  return new Response(\r\n    JSON.stringify({ success: true, message: \"Agent unmapped successfully\" }),\r\n    { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n  );\r\n}\r\n\r\nfunction formatAgent(agent: Record<string, unknown>): Record<string, unknown> {\r\n  const publicProfile = agent.publicProfile as Record<string, unknown> | undefined;\r\n  \r\n  return {\r\n    id: agent.id,\r\n    email: agent.email,\r\n    first_name: agent.firstName,\r\n    last_name: agent.lastName,\r\n    full_name: `${agent.firstName || ''} ${agent.lastName || ''}`.trim(),\r\n    mobile: agent.mobile,\r\n    status: agent.status,\r\n    role_id: agent.roleId,\r\n    public_profile: publicProfile ? {\r\n      id: publicProfile.id,\r\n      name: publicProfile.name,\r\n      email: publicProfile.email,\r\n      phone: publicProfile.phone,\r\n      image_url: publicProfile.imageUrl,\r\n    } : null,\r\n    created_at: agent.createdAt,\r\n  };\r\n}\r\n\r\nasync function getAccessToken(\r\n  // deno-lint-ignore no-explicit-any\r\n  supabase: any,\r\n  portalAccount: Record<string, unknown>\r\n): Promise<string | null> {\r\n  const tokenExpiresAt = portalAccount.token_expires_at as string | null;\r\n  const accessToken = portalAccount.access_token_encrypted as string | null;\r\n\r\n  if (accessToken && tokenExpiresAt) {\r\n    const expiryDate = new Date(tokenExpiresAt);\r\n    const bufferTime = new Date(Date.now() + 5 * 60 * 1000);\r\n    \r\n    if (expiryDate > bufferTime) {\r\n      return accessToken;\r\n    }\r\n  }\r\n\r\n  const credentials = portalAccount.credentials as Record<string, string> | null;\r\n  const apiKey = credentials?.api_key || portalAccount.api_key_encrypted as string;\r\n  const apiSecret = credentials?.api_secret || portalAccount.api_secret_encrypted as string;\r\n\r\n  if (!apiKey || !apiSecret) {\r\n    console.error(\"[pf-agents] Missing API credentials\");\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    const tokenResponse = await fetch(`${PF_API_BASE}/auth/token`, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Accept\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({ apiKey, apiSecret }),\r\n    });\r\n\r\n    if (!tokenResponse.ok) {\r\n      console.error(\"[pf-agents] Token refresh failed:\", tokenResponse.status);\r\n      return null;\r\n    }\r\n\r\n    const tokenData = await tokenResponse.json();\r\n    const newAccessToken = tokenData.accessToken;\r\n    const expiresIn = tokenData.expiresIn || 1800;\r\n    const newExpiresAt = new Date(Date.now() + expiresIn * 1000).toISOString();\r\n\r\n    await supabase\r\n      .from(\"portal_accounts\")\r\n      .update({\r\n        access_token_encrypted: newAccessToken,\r\n        token_expires_at: newExpiresAt,\r\n        status: \"connected\",\r\n        last_health_check_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", portalAccount.id);\r\n\r\n    return newAccessToken;\r\n  } catch (error) {\r\n    console.error(\"[pf-agents] Token refresh error:\", error);\r\n    return null;\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\pf-connection\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":12,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[463,466],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[463,466],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":12,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[468,471],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[468,471],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":12,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[473,476],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[473,476],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { serve } from \"https://deno.land/std@0.168.0/http/server.ts\";\r\nimport { createClient, SupabaseClient } from \"https://esm.sh/@supabase/supabase-js@2\";\r\n\r\nconst corsHeaders = {\r\n  \"Access-Control-Allow-Origin\": \"*\",\r\n  \"Access-Control-Allow-Headers\": \"authorization, x-client-info, apikey, content-type\",\r\n};\r\n\r\nconst PF_API_BASE = \"https://api.propertyfinder.com/partner/v3\";\r\n\r\n// deno-lint-ignore no-explicit-any\r\ntype AnySupabaseClient = SupabaseClient<any, any, any>;\r\n\r\ninterface ConnectionRequest {\r\n  action: \"connect\" | \"test\" | \"disconnect\" | \"sync_agents\" | \"health_check\";\r\n  portal_account_id?: string;\r\n  company_id: string;\r\n  credentials?: {\r\n    api_key: string;\r\n    api_secret: string;\r\n  };\r\n  account_name?: string;\r\n}\r\n\r\nserve(async (req) => {\r\n  if (req.method === \"OPTIONS\") {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get(\"SUPABASE_URL\")!;\r\n    const supabaseServiceKey = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!;\r\n    const supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n    // Verify authorization\r\n    const authHeader = req.headers.get(\"Authorization\");\r\n    if (!authHeader) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Missing authorization header\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 401 }\r\n      );\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser(\r\n      authHeader.replace(\"Bearer \", \"\")\r\n    );\r\n\r\n    if (authError || !user) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Unauthorized\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 401 }\r\n      );\r\n    }\r\n\r\n    // Verify admin/manager role\r\n    const { data: agent } = await supabase\r\n      .from(\"agents\")\r\n      .select(\"id, role, company_id\")\r\n      .eq(\"user_id\", user.id)\r\n      .eq(\"status\", \"active\")\r\n      .single();\r\n\r\n    if (!agent || ![\"admin\", \"manager\"].includes(agent.role)) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Admin or Manager role required\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 403 }\r\n      );\r\n    }\r\n\r\n    const body: ConnectionRequest = await req.json();\r\n    const { action, portal_account_id, company_id, credentials, account_name } = body;\r\n\r\n    if (agent.company_id !== company_id) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Company mismatch\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 403 }\r\n      );\r\n    }\r\n\r\n    console.log(`[pf-connection] Action: ${action}, Company: ${company_id}`);\r\n\r\n    if (action === \"connect\") {\r\n      return await handleConnect(supabase, company_id, credentials!, account_name!, agent.id);\r\n    }\r\n\r\n    if (action === \"test\") {\r\n      return await handleTest(credentials!);\r\n    }\r\n\r\n    if (action === \"disconnect\") {\r\n      return await handleDisconnect(supabase, portal_account_id!, company_id);\r\n    }\r\n\r\n    if (action === \"sync_agents\") {\r\n      return await handleSyncAgents(supabase, portal_account_id!, company_id);\r\n    }\r\n\r\n    if (action === \"health_check\") {\r\n      return await handleHealthCheck(supabase, portal_account_id!, company_id);\r\n    }\r\n\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Invalid action\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n    );\r\n\r\n  } catch (error) {\r\n    console.error(\"[pf-connection] Error:\", error);\r\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: errorMessage }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n});\r\n\r\nasync function handleTest(credentials: { api_key: string; api_secret: string }): Promise<Response> {\r\n  try {\r\n    const tokenResponse = await fetch(`${PF_API_BASE}/oauth/token`, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\r\n      },\r\n      body: new URLSearchParams({\r\n        grant_type: \"client_credentials\",\r\n        client_id: credentials.api_key,\r\n        client_secret: credentials.api_secret,\r\n      }),\r\n    });\r\n\r\n    if (!tokenResponse.ok) {\r\n      const errorData = await tokenResponse.text();\r\n      console.error(\"[pf-connection] Test failed:\", errorData);\r\n      return new Response(\r\n        JSON.stringify({ \r\n          success: false, \r\n          error: \"Invalid API credentials. Please check your API Key and Secret.\" \r\n        }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n      );\r\n    }\r\n\r\n    const tokenData = await tokenResponse.json();\r\n    \r\n    // Verify by fetching account info\r\n    const accountResponse = await fetch(`${PF_API_BASE}/account`, {\r\n      headers: {\r\n        \"Authorization\": `Bearer ${tokenData.access_token}`,\r\n      },\r\n    });\r\n\r\n    if (!accountResponse.ok) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Failed to verify account\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n      );\r\n    }\r\n\r\n    const accountData = await accountResponse.json();\r\n\r\n    return new Response(\r\n      JSON.stringify({ \r\n        success: true, \r\n        message: \"Connection successful\",\r\n        account: {\r\n          name: accountData.name || accountData.company_name,\r\n          id: accountData.id,\r\n        }\r\n      }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n    );\r\n\r\n  } catch (error) {\r\n    console.error(\"[pf-connection] Test error:\", error);\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Failed to connect to Property Finder\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nasync function handleConnect(\r\n  supabase: AnySupabaseClient,\r\n  companyId: string,\r\n  credentials: { api_key: string; api_secret: string },\r\n  accountName: string,\r\n  agentId: string\r\n): Promise<Response> {\r\n  try {\r\n    // First test the connection\r\n    const tokenResponse = await fetch(`${PF_API_BASE}/oauth/token`, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\r\n      },\r\n      body: new URLSearchParams({\r\n        grant_type: \"client_credentials\",\r\n        client_id: credentials.api_key,\r\n        client_secret: credentials.api_secret,\r\n      }),\r\n    });\r\n\r\n    if (!tokenResponse.ok) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Invalid API credentials\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n      );\r\n    }\r\n\r\n    const tokenData = await tokenResponse.json();\r\n    const expiresAt = new Date(Date.now() + (tokenData.expires_in || 3600) * 1000).toISOString();\r\n\r\n    // Get or create Property Finder portal\r\n    let { data: portal } = await supabase\r\n      .from(\"portals\")\r\n      .select(\"id\")\r\n      .eq(\"name\", \"Property Finder\")\r\n      .single();\r\n\r\n    if (!portal) {\r\n      const { data: newPortal, error: portalError } = await supabase\r\n        .from(\"portals\")\r\n        .insert({\r\n          name: \"Property Finder\",\r\n          display_name: \"Property Finder\",\r\n          logo_url: \"https://www.propertyfinder.ae/images/pf-logo.svg\",\r\n          base_url: \"propertyfinder.ae\",\r\n          is_active: true,\r\n        })\r\n        .select(\"id\")\r\n        .single();\r\n\r\n      if (portalError) throw portalError;\r\n      portal = newPortal;\r\n    }\r\n\r\n    // Check for existing connection\r\n    const { data: existingAccount } = await supabase\r\n      .from(\"portal_accounts\")\r\n      .select(\"id\")\r\n      .eq(\"company_id\", companyId)\r\n      .eq(\"portal_id\", portal.id)\r\n      .single();\r\n\r\n    let accountId: string;\r\n\r\n    if (existingAccount) {\r\n      // Update existing\r\n      const { error: updateError } = await supabase\r\n        .from(\"portal_accounts\")\r\n        .update({\r\n          account_name: accountName,\r\n          api_key_encrypted: credentials.api_key,\r\n          api_secret_encrypted: credentials.api_secret,\r\n          access_token_encrypted: tokenData.access_token,\r\n          token_expires_at: expiresAt,\r\n          status: \"connected\",\r\n          portal_type: \"property_finder\",\r\n          last_health_check_at: new Date().toISOString(),\r\n          last_error_message: null,\r\n          error_message: null,\r\n        })\r\n        .eq(\"id\", existingAccount.id);\r\n\r\n      if (updateError) throw updateError;\r\n      accountId = existingAccount.id;\r\n    } else {\r\n      // Create new\r\n      const { data: newAccount, error: insertError } = await supabase\r\n        .from(\"portal_accounts\")\r\n        .insert({\r\n          company_id: companyId,\r\n          portal_id: portal.id,\r\n          account_name: accountName,\r\n          api_key_encrypted: credentials.api_key,\r\n          api_secret_encrypted: credentials.api_secret,\r\n          access_token_encrypted: tokenData.access_token,\r\n          token_expires_at: expiresAt,\r\n          status: \"connected\",\r\n          portal_type: \"property_finder\",\r\n          credentials: {}, // Legacy field\r\n          created_by: agentId,\r\n        })\r\n        .select(\"id\")\r\n        .single();\r\n\r\n      if (insertError) throw insertError;\r\n      accountId = newAccount.id;\r\n    }\r\n\r\n    // Sync agents\r\n    await syncAgentsFromPF(supabase, accountId, companyId, tokenData.access_token);\r\n\r\n    return new Response(\r\n      JSON.stringify({ \r\n        success: true, \r\n        portal_account_id: accountId,\r\n        message: \"Property Finder connected successfully\" \r\n      }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n    );\r\n\r\n  } catch (error) {\r\n    console.error(\"[pf-connection] Connect error:\", error);\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Failed to connect\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nasync function handleDisconnect(\r\n  supabase: AnySupabaseClient,\r\n  portalAccountId: string,\r\n  companyId: string\r\n): Promise<Response> {\r\n  try {\r\n    // Remove agent mappings\r\n    await supabase\r\n      .from(\"pf_agent_mappings\")\r\n      .delete()\r\n      .eq(\"portal_account_id\", portalAccountId);\r\n\r\n    // Update portal account status\r\n    await supabase\r\n      .from(\"portal_accounts\")\r\n      .update({\r\n        status: \"disconnected\",\r\n        access_token_encrypted: null,\r\n        token_expires_at: null,\r\n      })\r\n      .eq(\"id\", portalAccountId)\r\n      .eq(\"company_id\", companyId);\r\n\r\n    return new Response(\r\n      JSON.stringify({ success: true, message: \"Disconnected from Property Finder\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n    );\r\n\r\n  } catch (error) {\r\n    console.error(\"[pf-connection] Disconnect error:\", error);\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Failed to disconnect\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nasync function handleSyncAgents(\r\n  supabase: AnySupabaseClient,\r\n  portalAccountId: string,\r\n  companyId: string\r\n): Promise<Response> {\r\n  try {\r\n    const { data: account } = await supabase\r\n      .from(\"portal_accounts\")\r\n      .select(\"access_token_encrypted, api_key_encrypted, api_secret_encrypted, token_expires_at\")\r\n      .eq(\"id\", portalAccountId)\r\n      .single();\r\n\r\n    if (!account) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Portal account not found\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 404 }\r\n      );\r\n    }\r\n\r\n    // Refresh token if needed\r\n    let accessToken = account.access_token_encrypted;\r\n    if (!accessToken || (account.token_expires_at && new Date(account.token_expires_at) < new Date())) {\r\n      const tokenResponse = await fetch(`${PF_API_BASE}/oauth/token`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\r\n        body: new URLSearchParams({\r\n          grant_type: \"client_credentials\",\r\n          client_id: account.api_key_encrypted,\r\n          client_secret: account.api_secret_encrypted,\r\n        }),\r\n      });\r\n\r\n      if (!tokenResponse.ok) {\r\n        return new Response(\r\n          JSON.stringify({ success: false, error: \"Failed to refresh token\" }),\r\n          { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n        );\r\n      }\r\n\r\n      const tokenData = await tokenResponse.json();\r\n      accessToken = tokenData.access_token;\r\n    }\r\n\r\n    const result = await syncAgentsFromPF(supabase, portalAccountId, companyId, accessToken);\r\n\r\n    return new Response(\r\n      JSON.stringify({ \r\n        success: true, \r\n        message: `Synced ${result.synced} agents`,\r\n        agents: result.agents\r\n      }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n    );\r\n\r\n  } catch (error) {\r\n    console.error(\"[pf-connection] Sync agents error:\", error);\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Failed to sync agents\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nasync function syncAgentsFromPF(\r\n  supabase: AnySupabaseClient,\r\n  portalAccountId: string,\r\n  companyId: string,\r\n  accessToken: string\r\n): Promise<{ synced: number; agents: Array<{ id: string; name: string; email: string }> }> {\r\n  try {\r\n    const agentsResponse = await fetch(`${PF_API_BASE}/agents`, {\r\n      headers: {\r\n        \"Authorization\": `Bearer ${accessToken}`,\r\n      },\r\n    });\r\n\r\n    if (!agentsResponse.ok) {\r\n      console.error(\"[pf-connection] Failed to fetch agents\");\r\n      return { synced: 0, agents: [] };\r\n    }\r\n\r\n    const agentsData = await agentsResponse.json();\r\n    const pfAgents = agentsData.data || agentsData.agents || [];\r\n\r\n    // Get company agents\r\n    const { data: companyAgents } = await supabase\r\n      .from(\"agents\")\r\n      .select(\"id, email, name\")\r\n      .eq(\"company_id\", companyId)\r\n      .eq(\"status\", \"active\");\r\n\r\n    if (!companyAgents) return { synced: 0, agents: [] };\r\n\r\n    const syncedAgents: Array<{ id: string; name: string; email: string }> = [];\r\n\r\n    for (const pfAgent of pfAgents) {\r\n      // Try to match by email\r\n      const matchedAgent = companyAgents.find(\r\n        a => a.email?.toLowerCase() === pfAgent.email?.toLowerCase()\r\n      );\r\n\r\n      if (matchedAgent) {\r\n        // Upsert mapping\r\n        await supabase\r\n          .from(\"pf_agent_mappings\")\r\n          .upsert({\r\n            company_id: companyId,\r\n            agent_id: matchedAgent.id,\r\n            portal_account_id: portalAccountId,\r\n            portal_agent_id: pfAgent.id,\r\n            agent_name: pfAgent.name,\r\n            agent_email: pfAgent.email,\r\n            agent_phone: pfAgent.phone,\r\n            is_active: true,\r\n          }, { onConflict: \"company_id,agent_id,portal_account_id\" });\r\n\r\n        syncedAgents.push({\r\n          id: matchedAgent.id,\r\n          name: matchedAgent.name,\r\n          email: matchedAgent.email,\r\n        });\r\n      }\r\n    }\r\n\r\n    return { synced: syncedAgents.length, agents: syncedAgents };\r\n\r\n  } catch (error) {\r\n    console.error(\"[pf-connection] Sync error:\", error);\r\n    return { synced: 0, agents: [] };\r\n  }\r\n}\r\n\r\nasync function handleHealthCheck(\r\n  supabase: AnySupabaseClient,\r\n  portalAccountId: string,\r\n  companyId: string\r\n): Promise<Response> {\r\n  try {\r\n    const { data: account } = await supabase\r\n      .from(\"portal_accounts\")\r\n      .select(\"*\")\r\n      .eq(\"id\", portalAccountId)\r\n      .eq(\"company_id\", companyId)\r\n      .single();\r\n\r\n    if (!account) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Portal account not found\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 404 }\r\n      );\r\n    }\r\n\r\n    // Try to get a fresh token\r\n    const tokenResponse = await fetch(`${PF_API_BASE}/oauth/token`, {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\r\n      body: new URLSearchParams({\r\n        grant_type: \"client_credentials\",\r\n        client_id: account.api_key_encrypted,\r\n        client_secret: account.api_secret_encrypted,\r\n      }),\r\n    });\r\n\r\n    const isHealthy = tokenResponse.ok;\r\n\r\n    await supabase\r\n      .from(\"portal_accounts\")\r\n      .update({\r\n        status: isHealthy ? \"connected\" : \"error\",\r\n        last_health_check_at: new Date().toISOString(),\r\n        last_error_message: isHealthy ? null : \"Health check failed\",\r\n      })\r\n      .eq(\"id\", portalAccountId);\r\n\r\n    return new Response(\r\n      JSON.stringify({ \r\n        success: true, \r\n        healthy: isHealthy,\r\n        status: isHealthy ? \"connected\" : \"error\"\r\n      }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n    );\r\n\r\n  } catch (error) {\r\n    console.error(\"[pf-connection] Health check error:\", error);\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Health check failed\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\pf-lead-webhook\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":89,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2906,2909],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2906,2909],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { serve } from \"https://deno.land/std@0.168.0/http/server.ts\";\r\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2\";\r\n\r\nconst corsHeaders = {\r\n  \"Access-Control-Allow-Origin\": \"*\",\r\n  \"Access-Control-Allow-Headers\": \"authorization, x-client-info, apikey, content-type, x-pf-signature\",\r\n};\r\n\r\ninterface PFLeadPayload {\r\n  id: string;\r\n  listing_id: string;\r\n  listing_reference?: string;\r\n  agent_id: string;\r\n  name: string;\r\n  email?: string;\r\n  phone?: string;\r\n  message?: string;\r\n  created_at: string;\r\n  source?: string;\r\n}\r\n\r\nserve(async (req) => {\r\n  if (req.method === \"OPTIONS\") {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get(\"SUPABASE_URL\")!;\r\n    const supabaseServiceKey = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!;\r\n    const supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n    // Property Finder sends webhook signature for verification\r\n    const signature = req.headers.get(\"x-pf-signature\");\r\n    const body = await req.text();\r\n    \r\n    console.log(`[pf-lead-webhook] Received webhook, signature: ${signature ? \"present\" : \"missing\"}`);\r\n\r\n    let payload: PFLeadPayload;\r\n    try {\r\n      payload = JSON.parse(body);\r\n    } catch {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Invalid JSON payload\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n      );\r\n    }\r\n\r\n    console.log(`[pf-lead-webhook] Lead: ${payload.id}, Listing: ${payload.listing_id}, Agent: ${payload.agent_id}`);\r\n\r\n    // Find the listing by portal_listing_id\r\n    const { data: publication } = await supabase\r\n      .from(\"portal_listing_publications\")\r\n      .select(`\r\n        listing_id,\r\n        company_id,\r\n        portal_account_id,\r\n        listings!inner(\r\n          id,\r\n          company_id,\r\n          assigned_agent_id,\r\n          title,\r\n          reference_number\r\n        )\r\n      `)\r\n      .or(`pf_listing_id.eq.${payload.listing_id},pf_reference.eq.${payload.listing_reference || \"\"}`)\r\n      .single();\r\n\r\n    if (!publication) {\r\n      console.error(`[pf-lead-webhook] Listing not found: ${payload.listing_id}`);\r\n      \r\n      // Log the unmatched lead for manual review\r\n      await supabase\r\n        .from(\"portal_import_errors\")\r\n        .insert({\r\n          company_id: \"00000000-0000-0000-0000-000000000000\", // Placeholder\r\n          portal_name: \"property_finder\",\r\n          lead_data: payload,\r\n          error_message: \"Listing not found in CRM\",\r\n          error_type: \"listing_not_found\",\r\n        });\r\n\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Listing not found\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 404 }\r\n      );\r\n    }\r\n\r\n    // deno-lint-ignore no-explicit-any\r\n    const listing = (publication as any).listings as Record<string, unknown>;\r\n    const companyId = publication.company_id;\r\n\r\n    // Find the agent by portal_agent_id mapping\r\n    const { data: agentMapping } = await supabase\r\n      .from(\"pf_agent_mappings\")\r\n      .select(\"agent_id\")\r\n      .eq(\"portal_account_id\", publication.portal_account_id)\r\n      .eq(\"portal_agent_id\", payload.agent_id)\r\n      .eq(\"is_active\", true)\r\n      .single();\r\n\r\n    // Determine assigned agent: prefer mapping, fallback to listing agent\r\n    const assignedAgentId = agentMapping?.agent_id || (listing.assigned_agent_id as string);\r\n\r\n    if (!assignedAgentId) {\r\n      console.error(`[pf-lead-webhook] No agent found for lead`);\r\n      \r\n      await supabase\r\n        .from(\"portal_import_errors\")\r\n        .insert({\r\n          company_id: companyId,\r\n          portal_name: \"property_finder\",\r\n          lead_data: payload,\r\n          error_message: \"No agent mapping found\",\r\n          error_type: \"agent_not_found\",\r\n        });\r\n\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Agent not found\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 404 }\r\n      );\r\n    }\r\n\r\n    // Check for duplicate lead\r\n    const { data: existingLead } = await supabase\r\n      .from(\"leads\")\r\n      .select(\"id\")\r\n      .eq(\"company_id\", companyId)\r\n      .eq(\"pf_lead_id\", payload.id)\r\n      .single();\r\n\r\n    if (existingLead) {\r\n      console.log(`[pf-lead-webhook] Duplicate lead: ${payload.id}`);\r\n      return new Response(\r\n        JSON.stringify({ success: true, lead_id: existingLead.id, duplicate: true }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n      );\r\n    }\r\n\r\n    // Normalize phone number\r\n    const normalizedPhone = normalizePhone(payload.phone);\r\n\r\n    // Get default stage\r\n    const { data: defaultStage } = await supabase\r\n      .from(\"lead_stages\")\r\n      .select(\"id\")\r\n      .eq(\"company_id\", companyId)\r\n      .eq(\"is_default\", true)\r\n      .single();\r\n\r\n    // Create the lead with STRICT attribution\r\n    const { data: newLead, error: leadError } = await supabase\r\n      .from(\"leads\")\r\n      .insert({\r\n        company_id: companyId,\r\n        name: payload.name || \"Property Finder Lead\",\r\n        email: payload.email,\r\n        phone: payload.phone,\r\n        normalized_phone: normalizedPhone,\r\n        message: payload.message,\r\n        source: \"Property Finder\",\r\n        pf_lead_id: payload.id,\r\n        portal_listing_id: payload.listing_id,\r\n        is_pf_lead: true,\r\n        assigned_agent_id: assignedAgentId,\r\n        assignment_source: agentMapping ? \"portal_mapping\" : \"listing_agent\",\r\n        assignment_reason: agentMapping \r\n          ? \"Assigned via Property Finder agent mapping\" \r\n          : \"Assigned to listing agent\",\r\n        stage_id: defaultStage?.id,\r\n        stage: \"New\",\r\n        source_metadata: {\r\n          portal: \"property_finder\",\r\n          portal_lead_id: payload.id,\r\n          portal_listing_id: payload.listing_id,\r\n          portal_agent_id: payload.agent_id,\r\n          listing_reference: listing.reference_number,\r\n          listing_title: listing.title,\r\n          received_at: new Date().toISOString(),\r\n        },\r\n        fetched_at: new Date().toISOString(),\r\n      })\r\n      .select(\"id\")\r\n      .single();\r\n\r\n    if (leadError) {\r\n      console.error(`[pf-lead-webhook] Failed to create lead:`, leadError);\r\n      \r\n      await supabase\r\n        .from(\"portal_import_errors\")\r\n        .insert({\r\n          company_id: companyId,\r\n          portal_name: \"property_finder\",\r\n          lead_data: payload,\r\n          error_message: leadError.message,\r\n          error_type: \"insert_failed\",\r\n        });\r\n\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Failed to create lead\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n      );\r\n    }\r\n\r\n    // Create activity log\r\n    await supabase\r\n      .from(\"lead_activities\")\r\n      .insert({\r\n        lead_id: newLead.id,\r\n        company_id: companyId,\r\n        type: \"created\",\r\n        title: \"Lead from Property Finder\",\r\n        description: `New inquiry for \"${listing.title}\" received from Property Finder`,\r\n        agent_name: \"Property Finder\",\r\n        agent_id: assignedAgentId,\r\n      });\r\n\r\n    // Create assignment notification\r\n    await supabase\r\n      .from(\"assignment_notifications\")\r\n      .insert({\r\n        company_id: companyId,\r\n        agent_id: assignedAgentId,\r\n        lead_id: newLead.id,\r\n        notification_type: \"assignment\",\r\n        title: \"New Property Finder Lead\",\r\n        message: `You have a new inquiry from ${payload.name} for \"${listing.title}\"`,\r\n      });\r\n\r\n    console.log(`[pf-lead-webhook] Lead created: ${newLead.id}, assigned to: ${assignedAgentId}`);\r\n\r\n    return new Response(\r\n      JSON.stringify({ \r\n        success: true, \r\n        lead_id: newLead.id,\r\n        assigned_agent_id: assignedAgentId,\r\n        attribution: agentMapping ? \"portal_mapping\" : \"listing_agent\"\r\n      }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n    );\r\n\r\n  } catch (error) {\r\n    console.error(\"[pf-lead-webhook] Error:\", error);\r\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: errorMessage }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n});\r\n\r\nfunction normalizePhone(phone: string | undefined): string | null {\r\n  if (!phone) return null;\r\n  \r\n  // Remove all non-numeric characters except +\r\n  let cleaned = phone.replace(/[^0-9+]/g, \"\");\r\n  \r\n  // Handle 00 prefix\r\n  if (cleaned.startsWith(\"00\")) {\r\n    cleaned = \"+\" + cleaned.substring(2);\r\n  }\r\n  \r\n  // Ensure + prefix\r\n  if (!cleaned.startsWith(\"+\")) {\r\n    cleaned = \"+\" + cleaned;\r\n  }\r\n  \r\n  return cleaned.length >= 8 ? cleaned : null;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\pf-locations\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":170,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":170,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5734,5737],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5734,5737],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { serve } from \"https://deno.land/std@0.168.0/http/server.ts\";\r\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2\";\r\n\r\nconst corsHeaders = {\r\n  \"Access-Control-Allow-Origin\": \"*\",\r\n  \"Access-Control-Allow-Headers\": \"authorization, x-client-info, apikey, content-type\",\r\n};\r\n\r\nconst PF_API_BASE = \"https://atlas.propertyfinder.com/v1\";\r\n\r\ninterface LocationsRequest {\r\n  action: \"search\" | \"get\" | \"list_children\";\r\n  portal_account_id: string;\r\n  company_id: string;\r\n  search?: string;\r\n  location_id?: number;\r\n  parent_id?: number;\r\n  page?: number;\r\n  per_page?: number;\r\n}\r\n\r\nserve(async (req) => {\r\n  if (req.method === \"OPTIONS\") {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get(\"SUPABASE_URL\")!;\r\n    const supabaseKey = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!;\r\n    const supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\n    // Verify authorization\r\n    const authHeader = req.headers.get(\"Authorization\");\r\n    if (!authHeader) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Missing authorization header\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 401 }\r\n      );\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser(\r\n      authHeader.replace(\"Bearer \", \"\")\r\n    );\r\n\r\n    if (authError || !user) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Unauthorized\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 401 }\r\n      );\r\n    }\r\n\r\n    const body: LocationsRequest = await req.json();\r\n    const { action, portal_account_id, company_id, search, location_id, parent_id, page = 1, per_page = 50 } = body;\r\n\r\n    console.log(`[pf-locations] Action: ${action}, Search: ${search}, User: ${user.id}`);\r\n\r\n    // Verify agent and company access\r\n    const { data: agent } = await supabase\r\n      .from(\"agents\")\r\n      .select(\"id, company_id\")\r\n      .eq(\"user_id\", user.id)\r\n      .eq(\"status\", \"active\")\r\n      .single();\r\n\r\n    if (!agent || agent.company_id !== company_id) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Unauthorized\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 403 }\r\n      );\r\n    }\r\n\r\n    // Get portal account\r\n    const { data: portalAccount, error: portalError } = await supabase\r\n      .from(\"portal_accounts\")\r\n      .select(\"*\")\r\n      .eq(\"id\", portal_account_id)\r\n      .eq(\"company_id\", company_id)\r\n      .single();\r\n\r\n    if (portalError || !portalAccount) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Portal account not found\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 404 }\r\n      );\r\n    }\r\n\r\n    // Get access token\r\n    const accessToken = await getAccessToken(supabase, portalAccount);\r\n    if (!accessToken) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Failed to get Property Finder access token\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n      );\r\n    }\r\n\r\n    let apiUrl = `${PF_API_BASE}/locations`;\r\n    const params = new URLSearchParams();\r\n    params.set(\"page\", page.toString());\r\n    params.set(\"perPage\", per_page.toString());\r\n\r\n    if (action === \"search\" && search) {\r\n      params.set(\"search\", search);\r\n    } else if (action === \"get\" && location_id) {\r\n      apiUrl = `${PF_API_BASE}/locations/${location_id}`;\r\n    } else if (action === \"list_children\" && parent_id) {\r\n      params.set(\"filter[parent]\", parent_id.toString());\r\n    }\r\n\r\n    const fullUrl = action === \"get\" ? apiUrl : `${apiUrl}?${params.toString()}`;\r\n\r\n    console.log(`[pf-locations] Calling: ${fullUrl}`);\r\n\r\n    const response = await fetch(fullUrl, {\r\n      method: \"GET\",\r\n      headers: {\r\n        \"Authorization\": `Bearer ${accessToken}`,\r\n        \"Accept\": \"application/json\",\r\n      },\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text();\r\n      console.error(`[pf-locations] API error: ${response.status}`, errorText);\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: `Property Finder API error: ${response.status}` }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: response.status }\r\n      );\r\n    }\r\n\r\n    const data = await response.json();\r\n\r\n    // Format locations for easier use\r\n    const locations = action === \"get\" \r\n      ? [formatLocation(data)]\r\n      : (data.data || []).map(formatLocation);\r\n\r\n    return new Response(\r\n      JSON.stringify({ \r\n        success: true, \r\n        locations,\r\n        pagination: data.meta || data.pagination || null,\r\n      }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n    );\r\n\r\n  } catch (error) {\r\n    console.error(\"[pf-locations] Error:\", error);\r\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: errorMessage }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n});\r\n\r\nfunction formatLocation(loc: Record<string, unknown>): Record<string, unknown> {\r\n  return {\r\n    id: loc.id,\r\n    name: loc.name,\r\n    full_name: loc.fullName || loc.name,\r\n    type: loc.type, // country, city, community, sub-community, building\r\n    parent_id: loc.parentId,\r\n    coordinates: loc.coordinates,\r\n    path: loc.path || loc.breadcrumb,\r\n  };\r\n}\r\n\r\nasync function getAccessToken(\r\n  // deno-lint-ignore no-explicit-any\r\n  supabase: any,\r\n  portalAccount: Record<string, unknown>\r\n): Promise<string | null> {\r\n  const tokenExpiresAt = portalAccount.token_expires_at as string | null;\r\n  const accessToken = portalAccount.access_token_encrypted as string | null;\r\n\r\n  if (accessToken && tokenExpiresAt) {\r\n    const expiryDate = new Date(tokenExpiresAt);\r\n    const bufferTime = new Date(Date.now() + 5 * 60 * 1000);\r\n    \r\n    if (expiryDate > bufferTime) {\r\n      return accessToken;\r\n    }\r\n  }\r\n\r\n  const credentials = portalAccount.credentials as Record<string, string> | null;\r\n  const apiKey = credentials?.api_key || portalAccount.api_key_encrypted as string;\r\n  const apiSecret = credentials?.api_secret || portalAccount.api_secret_encrypted as string;\r\n\r\n  if (!apiKey || !apiSecret) {\r\n    console.error(\"[pf-locations] Missing API credentials\");\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    const tokenResponse = await fetch(`${PF_API_BASE}/auth/token`, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Accept\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({ apiKey, apiSecret }),\r\n    });\r\n\r\n    if (!tokenResponse.ok) {\r\n      console.error(\"[pf-locations] Token refresh failed:\", tokenResponse.status);\r\n      return null;\r\n    }\r\n\r\n    const tokenData = await tokenResponse.json();\r\n    const newAccessToken = tokenData.accessToken;\r\n    const expiresIn = tokenData.expiresIn || 1800;\r\n    const newExpiresAt = new Date(Date.now() + expiresIn * 1000).toISOString();\r\n\r\n    await supabase\r\n      .from(\"portal_accounts\")\r\n      .update({\r\n        access_token_encrypted: newAccessToken,\r\n        token_expires_at: newExpiresAt,\r\n        status: \"connected\",\r\n        last_health_check_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", portalAccount.id);\r\n\r\n    return newAccessToken;\r\n  } catch (error) {\r\n    console.error(\"[pf-locations] Token refresh error:\", error);\r\n    return null;\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\pf-publish\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[395,398],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[395,398],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[400,403],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[400,403],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[405,408],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[405,408],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { serve } from \"https://deno.land/std@0.168.0/http/server.ts\";\r\nimport { createClient, SupabaseClient } from \"https://esm.sh/@supabase/supabase-js@2\";\r\n\r\nconst corsHeaders = {\r\n  \"Access-Control-Allow-Origin\": \"*\",\r\n  \"Access-Control-Allow-Headers\": \"authorization, x-client-info, apikey, content-type\",\r\n};\r\n\r\n// deno-lint-ignore no-explicit-any\r\ntype AnySupabaseClient = SupabaseClient<any, any, any>;\r\n\r\n// Property Finder Atlas API Base URL\r\nconst PF_API_BASE = \"https://atlas.propertyfinder.com/v1\";\r\n\r\ninterface PublishRequest {\r\n  action: \"publish\" | \"update\" | \"unpublish\" | \"validate\" | \"refresh_token\" | \"get_publish_price\";\r\n  listing_id: string;\r\n  portal_account_id: string;\r\n  company_id: string;\r\n  customizations?: {\r\n    title?: Record<string, string>;\r\n    description?: Record<string, string>;\r\n    price?: number;\r\n    images?: string[];\r\n  };\r\n}\r\n\r\n// Property Finder Atlas API Listing Payload (per official docs)\r\ninterface PFListingPayload {\r\n  reference: string;\r\n  publicProfileId: number;\r\n  locationId: number;\r\n  category: \"residential\" | \"commercial\";\r\n  offeringType: \"sale\" | \"rent\";\r\n  propertyType: string;\r\n  title: { primary: string; secondary?: string };\r\n  description: { primary: string; secondary?: string };\r\n  price: number;\r\n  currency?: string;\r\n  bedrooms?: number;\r\n  bathrooms?: number;\r\n  size?: number;\r\n  plotSize?: number;\r\n  furnished?: \"furnished\" | \"unfurnished\" | \"semi-furnished\";\r\n  media?: {\r\n    images?: Array<{ original: { url: string }; title?: string }>;\r\n    videos?: Array<{ url: string; title?: string }>;\r\n    floorPlans?: Array<{ url: string; title?: string }>;\r\n  };\r\n  amenities?: string[];\r\n  compliance?: {\r\n    permitNumber?: string;\r\n    listingAdvertisementNumber?: string;\r\n    issuingClientLicenseNumber?: string;\r\n  };\r\n  geoPoints?: { lat: number; lng: number };\r\n  rentalPeriod?: \"yearly\" | \"monthly\" | \"weekly\" | \"daily\";\r\n  parking?: number;\r\n  completionStatus?: \"ready\" | \"off-plan\";\r\n}\r\n\r\nserve(async (req) => {\r\n  if (req.method === \"OPTIONS\") {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get(\"SUPABASE_URL\")!;\r\n    const supabaseServiceKey = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!;\r\n    const supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n    // Verify authorization\r\n    const authHeader = req.headers.get(\"Authorization\");\r\n    if (!authHeader) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Missing authorization header\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 401 }\r\n      );\r\n    }\r\n\r\n    // Verify the user\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser(\r\n      authHeader.replace(\"Bearer \", \"\")\r\n    );\r\n\r\n    if (authError || !user) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Unauthorized\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 401 }\r\n      );\r\n    }\r\n\r\n    const body: PublishRequest = await req.json();\r\n    const { action, listing_id, portal_account_id, company_id, customizations } = body;\r\n\r\n    console.log(`[pf-publish] Action: ${action}, Listing: ${listing_id}, User: ${user.id}`);\r\n\r\n    // Get agent info and verify permissions\r\n    const { data: agent, error: agentError } = await supabase\r\n      .from(\"agents\")\r\n      .select(\"id, role, company_id\")\r\n      .eq(\"user_id\", user.id)\r\n      .eq(\"status\", \"active\")\r\n      .single();\r\n\r\n    if (agentError || !agent) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Agent not found\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 403 }\r\n      );\r\n    }\r\n\r\n    // Verify company match\r\n    if (agent.company_id !== company_id) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Company mismatch\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 403 }\r\n      );\r\n    }\r\n\r\n    // Get listing details\r\n    const { data: listing, error: listingError } = await supabase\r\n      .from(\"listings\")\r\n      .select(\"*\")\r\n      .eq(\"id\", listing_id)\r\n      .eq(\"company_id\", company_id)\r\n      .single();\r\n\r\n    if (listingError || !listing) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Listing not found\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 404 }\r\n      );\r\n    }\r\n\r\n    // Permission check: Agent can only publish their own listings unless admin/manager\r\n    const isAdminOrManager = agent.role === \"admin\" || agent.role === \"manager\";\r\n    const isOwnListing = listing.assigned_agent_id === agent.id;\r\n\r\n    if (!isAdminOrManager && !isOwnListing) {\r\n      return new Response(\r\n        JSON.stringify({ \r\n          success: false, \r\n          error: \"You can only publish your own listings. Contact an admin to publish this listing.\" \r\n        }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 403 }\r\n      );\r\n    }\r\n\r\n    // Get portal account with credentials\r\n    const { data: portalAccount, error: portalError } = await supabase\r\n      .from(\"portal_accounts\")\r\n      .select(\"*\")\r\n      .eq(\"id\", portal_account_id)\r\n      .eq(\"company_id\", company_id)\r\n      .single();\r\n\r\n    if (portalError || !portalAccount) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Portal account not found\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 404 }\r\n      );\r\n    }\r\n\r\n    if (portalAccount.status !== \"connected\") {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Portal account is not connected\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n      );\r\n    }\r\n\r\n    // Get agent mapping for the assigned agent\r\n    let { data: agentMapping } = await supabase\r\n      .from(\"pf_agent_mappings\")\r\n      .select(\"*\")\r\n      .eq(\"portal_account_id\", portal_account_id)\r\n      .eq(\"agent_id\", listing.assigned_agent_id)\r\n      .eq(\"is_active\", true)\r\n      .single();\r\n\r\n    // If no mapping exists, try to auto-map by fetching PF agents and matching by email\r\n    if (!agentMapping && action !== \"validate\") {\r\n      console.log(\"[pf-publish] No agent mapping found, attempting auto-map...\");\r\n      agentMapping = await attemptAutoMap(supabase, portalAccount, listing.assigned_agent_id, company_id, portal_account_id);\r\n    }\r\n\r\n    if (action === \"validate\") {\r\n      const validation = validateListing(listing, agentMapping);\r\n      return new Response(\r\n        JSON.stringify({ success: true, validation }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n      );\r\n    }\r\n\r\n    if (!agentMapping) {\r\n      const { data: crmAgent } = await supabase\r\n        .from(\"agents\")\r\n        .select(\"email, name\")\r\n        .eq(\"id\", listing.assigned_agent_id)\r\n        .single();\r\n      \r\n      return new Response(\r\n        JSON.stringify({ \r\n          success: false, \r\n          error: `Agent \"${crmAgent?.name || 'Unknown'}\" (${crmAgent?.email || 'no email'}) is not mapped to Property Finder. The agent's email must match a Property Finder user, or manually map the agent in Portal Settings.`\r\n        }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n      );\r\n    }\r\n\r\n    // Get or refresh access token\r\n    const accessToken = await getAccessToken(supabase, portalAccount);\r\n    if (!accessToken) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Failed to get Property Finder access token\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n      );\r\n    }\r\n\r\n    if (action === \"get_publish_price\") {\r\n      return await handleGetPublishPrice(supabase, listing, portalAccount, accessToken);\r\n    }\r\n\r\n    if (action === \"publish\") {\r\n      return await handlePublish(\r\n        supabase, listing, portalAccount, agentMapping, \r\n        accessToken, company_id, agent.id, customizations\r\n      );\r\n    }\r\n\r\n    if (action === \"update\") {\r\n      return await handleUpdate(\r\n        supabase, listing, portalAccount, agentMapping,\r\n        accessToken, company_id, agent.id, customizations\r\n      );\r\n    }\r\n\r\n    if (action === \"unpublish\") {\r\n      return await handleUnpublish(\r\n        supabase, listing, portalAccount, accessToken, company_id, agent.id\r\n      );\r\n    }\r\n\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Invalid action\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n    );\r\n\r\n  } catch (error) {\r\n    console.error(\"[pf-publish] Error:\", error);\r\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: errorMessage }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n});\r\n\r\nasync function attemptAutoMap(\r\n  supabase: AnySupabaseClient,\r\n  portalAccount: Record<string, unknown>,\r\n  assignedAgentId: string,\r\n  companyId: string,\r\n  portalAccountId: string\r\n): Promise<Record<string, unknown> | null> {\r\n  const { data: crmAgent } = await supabase\r\n    .from(\"agents\")\r\n    .select(\"email, name\")\r\n    .eq(\"id\", assignedAgentId)\r\n    .single();\r\n\r\n  if (!crmAgent?.email) return null;\r\n\r\n  const tempToken = await getAccessToken(supabase, portalAccount);\r\n  if (!tempToken) return null;\r\n\r\n  try {\r\n    // Fetch agents from Property Finder using email filter\r\n    const usersResponse = await fetch(`${PF_API_BASE}/users?email=${encodeURIComponent(crmAgent.email)}&status=active`, {\r\n      method: \"GET\",\r\n      headers: { \r\n        \"Authorization\": `Bearer ${tempToken}`,\r\n        \"Accept\": \"application/json\",\r\n      },\r\n    });\r\n    \r\n    if (!usersResponse.ok) {\r\n      console.log(\"[pf-publish] Failed to fetch PF users for auto-map\");\r\n      return null;\r\n    }\r\n    \r\n    const usersData = await usersResponse.json();\r\n    const pfAgents = usersData.data || usersData || [];\r\n    \r\n    // Find matching PF agent by email (case-insensitive)\r\n    const matchingPfAgent = pfAgents.find((pf: Record<string, unknown>) => \r\n      (pf.email as string)?.toLowerCase() === crmAgent.email.toLowerCase()\r\n    );\r\n\r\n    if (!matchingPfAgent) {\r\n      console.log(`[pf-publish] No matching PF agent found for email: ${crmAgent.email}`);\r\n      return null;\r\n    }\r\n\r\n    console.log(`[pf-publish] Auto-mapping agent ${crmAgent.email} to PF agent ${matchingPfAgent.id}`);\r\n    \r\n    // Get publicProfileId from the PF user\r\n    const publicProfileId = matchingPfAgent.publicProfile?.id || matchingPfAgent.id;\r\n\r\n    const { data: newMapping, error: createError } = await supabase\r\n      .from(\"pf_agent_mappings\")\r\n      .insert({\r\n        company_id: companyId,\r\n        portal_account_id: portalAccountId,\r\n        agent_id: assignedAgentId,\r\n        portal_agent_id: String(matchingPfAgent.id),\r\n        portal_public_profile_id: publicProfileId,\r\n        agent_email: crmAgent.email,\r\n        agent_name: crmAgent.name,\r\n        is_active: true,\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (!createError && newMapping) {\r\n      console.log(\"[pf-publish] Agent auto-mapped successfully\");\r\n      return newMapping;\r\n    }\r\n    console.error(\"[pf-publish] Failed to create auto-mapping:\", createError);\r\n    return null;\r\n  } catch (err) {\r\n    console.error(\"[pf-publish] Error during auto-map:\", err);\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction validateListing(\r\n  listing: Record<string, unknown>,\r\n  agentMapping: Record<string, unknown> | null\r\n): { valid: boolean; errors: string[]; warnings: string[] } {\r\n  const errors: string[] = [];\r\n  const warnings: string[] = [];\r\n\r\n  // Required fields per Property Finder Atlas API\r\n  if (!listing.title || (listing.title as string).trim() === \"\") {\r\n    errors.push(\"Title is required\");\r\n  }\r\n  if (!listing.description || (listing.description as string).trim() === \"\") {\r\n    errors.push(\"Description is required\");\r\n  }\r\n  if (!listing.price || (listing.price as number) <= 0) {\r\n    errors.push(\"Price is required and must be greater than 0\");\r\n  }\r\n  if (!listing.property_type) {\r\n    errors.push(\"Property type is required\");\r\n  }\r\n  if (!listing.listing_type) {\r\n    errors.push(\"Listing type (sale/rent) is required\");\r\n  }\r\n\r\n  // Images validation\r\n  const images = (listing.images as string[]) || [];\r\n  if (images.length < 1) {\r\n    errors.push(\"At least 1 image is required\");\r\n  }\r\n  if (images.length < 5) {\r\n    warnings.push(\"Property Finder recommends at least 5 images for better visibility\");\r\n  }\r\n  if (images.length > 50) {\r\n    errors.push(\"Maximum 50 images allowed\");\r\n  }\r\n\r\n  // Description length\r\n  const description = listing.description as string || \"\";\r\n  if (description.length < 100) {\r\n    warnings.push(\"Description should be at least 100 characters for better SEO\");\r\n  }\r\n  if (description.length > 10000) {\r\n    errors.push(\"Description must be less than 10,000 characters\");\r\n  }\r\n\r\n  // Permit/RERA number (required for Dubai)\r\n  if (!listing.permit_number) {\r\n    warnings.push(\"Permit/RERA number is recommended for UAE properties (required for Dubai)\");\r\n  }\r\n\r\n  // Location validation\r\n  if (!listing.pf_location_id && !listing.location_id) {\r\n    warnings.push(\"Property Finder location ID not set. Will attempt to match by address.\");\r\n  }\r\n\r\n  // Agent mapping\r\n  if (!agentMapping) {\r\n    errors.push(\"Assigned agent is not mapped to Property Finder\");\r\n  } else if (!agentMapping.portal_public_profile_id) {\r\n    warnings.push(\"Agent's Property Finder Public Profile ID not set - will use agent ID\");\r\n  }\r\n\r\n  return { valid: errors.length === 0, errors, warnings };\r\n}\r\n\r\nasync function getAccessToken(\r\n  supabase: AnySupabaseClient,\r\n  portalAccount: Record<string, unknown>\r\n): Promise<string | null> {\r\n  const tokenExpiresAt = portalAccount.token_expires_at as string | null;\r\n  const accessToken = portalAccount.access_token_encrypted as string | null;\r\n\r\n  // Check if token is still valid (with 5 minute buffer)\r\n  if (accessToken && tokenExpiresAt) {\r\n    const expiryDate = new Date(tokenExpiresAt);\r\n    const bufferTime = new Date(Date.now() + 5 * 60 * 1000);\r\n    \r\n    if (expiryDate > bufferTime) {\r\n      console.log(\"[pf-publish] Using cached access token\");\r\n      return accessToken;\r\n    }\r\n  }\r\n\r\n  // Get credentials from the credentials JSON field or individual fields\r\n  const credentials = portalAccount.credentials as Record<string, string> | null;\r\n  const apiKey = credentials?.api_key || portalAccount.api_key_encrypted as string;\r\n  const apiSecret = credentials?.api_secret || portalAccount.api_secret_encrypted as string;\r\n\r\n  if (!apiKey || !apiSecret) {\r\n    console.error(\"[pf-publish] Missing API credentials in portal account\");\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    console.log(\"[pf-publish] Fetching new access token from Property Finder Atlas API...\");\r\n    \r\n    const tokenResponse = await fetch(`${PF_API_BASE}/auth/token`, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Accept\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({\r\n        apiKey,\r\n        apiSecret,\r\n      }),\r\n    });\r\n\r\n    if (!tokenResponse.ok) {\r\n      const errorData = await tokenResponse.text();\r\n      console.error(\"[pf-publish] Token refresh failed:\", tokenResponse.status, errorData);\r\n      \r\n      await supabase\r\n        .from(\"portal_accounts\")\r\n        .update({\r\n          status: \"error\",\r\n          last_error_message: `Token refresh failed: ${tokenResponse.status}`,\r\n        })\r\n        .eq(\"id\", portalAccount.id);\r\n      \r\n      return null;\r\n    }\r\n\r\n    const tokenData = await tokenResponse.json();\r\n    const newAccessToken = tokenData.accessToken;\r\n    const expiresIn = tokenData.expiresIn || 1800; // Default 30 minutes per PF docs\r\n    const newExpiresAt = new Date(Date.now() + expiresIn * 1000).toISOString();\r\n\r\n    console.log(`[pf-publish] Got new access token, expires in ${expiresIn} seconds`);\r\n\r\n    // Update portal account with new token\r\n    await supabase\r\n      .from(\"portal_accounts\")\r\n      .update({\r\n        access_token_encrypted: newAccessToken,\r\n        token_expires_at: newExpiresAt,\r\n        status: \"connected\",\r\n        last_error_message: null,\r\n        last_health_check_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", portalAccount.id);\r\n\r\n    return newAccessToken;\r\n  } catch (error) {\r\n    console.error(\"[pf-publish] Token refresh error:\", error);\r\n    return null;\r\n  }\r\n}\r\n\r\nasync function handleGetPublishPrice(\r\n  supabase: AnySupabaseClient,\r\n  listing: Record<string, unknown>,\r\n  portalAccount: Record<string, unknown>,\r\n  accessToken: string\r\n): Promise<Response> {\r\n  // Get existing publication to find PF listing ID\r\n  const { data: publication } = await supabase\r\n    .from(\"portal_listing_publications\")\r\n    .select(\"pf_listing_id\")\r\n    .eq(\"listing_id\", listing.id)\r\n    .eq(\"portal_account_id\", portalAccount.id)\r\n    .single();\r\n\r\n  if (!publication?.pf_listing_id) {\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Listing must be created first before getting publish price\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n    );\r\n  }\r\n\r\n  try {\r\n    const response = await fetch(`${PF_API_BASE}/listings/${publication.pf_listing_id}/publish/prices`, {\r\n      method: \"GET\",\r\n      headers: {\r\n        \"Authorization\": `Bearer ${accessToken}`,\r\n        \"Accept\": \"application/json\",\r\n      },\r\n    });\r\n\r\n    const data = await response.json();\r\n\r\n    if (!response.ok) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: data.message || \"Failed to get publish price\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n      );\r\n    }\r\n\r\n    return new Response(\r\n      JSON.stringify({ success: true, prices: data }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n    );\r\n  } catch (error) {\r\n    console.error(\"[pf-publish] Get publish price error:\", error);\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Failed to get publish price\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nasync function handlePublish(\r\n  supabase: AnySupabaseClient,\r\n  listing: Record<string, unknown>,\r\n  portalAccount: Record<string, unknown>,\r\n  agentMapping: Record<string, unknown>,\r\n  accessToken: string,\r\n  companyId: string,\r\n  agentId: string,\r\n  customizations?: Record<string, unknown>\r\n): Promise<Response> {\r\n  const validation = validateListing(listing, agentMapping);\r\n  if (!validation.valid) {\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Validation failed\", validation }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n    );\r\n  }\r\n\r\n  // Build Property Finder Atlas API payload\r\n  const pfPayload = buildPFPayload(listing, agentMapping, customizations);\r\n  \r\n  try {\r\n    // Step 1: Create listing in draft mode\r\n    console.log(\"[pf-publish] Creating listing in draft mode...\");\r\n    const createResponse = await fetch(`${PF_API_BASE}/listings`, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Authorization\": `Bearer ${accessToken}`,\r\n        \"Content-Type\": \"application/json\",\r\n        \"Accept\": \"application/json\",\r\n      },\r\n      body: JSON.stringify(pfPayload),\r\n    });\r\n\r\n    const createData = await createResponse.json();\r\n\r\n    if (!createResponse.ok) {\r\n      console.error(\"[pf-publish] Create listing failed:\", createData);\r\n      \r\n      await logPublishAction(supabase, companyId, listing.id as string, portalAccount.id as string, \r\n        \"create\", false, null, pfPayload, createData, createData.message || createData.detail || \"Create failed\");\r\n\r\n      await updatePublicationStatus(supabase, listing.id as string, portalAccount.id as string, \r\n        portalAccount.portal_id as string, companyId, agentId, \"rejected\", createData.message || \"Create failed\", createData);\r\n\r\n      return new Response(\r\n        JSON.stringify({ \r\n          success: false, \r\n          error: createData.message || createData.detail || \"Failed to create listing\",\r\n          details: createData\r\n        }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n      );\r\n    }\r\n\r\n    const pfListingId = createData.id;\r\n    console.log(`[pf-publish] Listing created with ID: ${pfListingId}, now publishing...`);\r\n\r\n    // Step 2: Publish the listing\r\n    const publishResponse = await fetch(`${PF_API_BASE}/listings/${pfListingId}/publish`, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Authorization\": `Bearer ${accessToken}`,\r\n        \"Accept\": \"application/json\",\r\n      },\r\n    });\r\n\r\n    const publishData = await publishResponse.json().catch(() => ({}));\r\n\r\n    await logPublishAction(supabase, companyId, listing.id as string, portalAccount.id as string,\r\n      \"publish\", publishResponse.ok, pfListingId, pfPayload, { create: createData, publish: publishData });\r\n\r\n    if (!publishResponse.ok) {\r\n      console.error(\"[pf-publish] Publish failed:\", publishData);\r\n      \r\n      await updatePublicationStatus(supabase, listing.id as string, portalAccount.id as string,\r\n        portalAccount.portal_id as string, companyId, agentId, \"draft\", \r\n        `Listing created but publish failed: ${publishData.message || publishData.detail}`, publishData, pfListingId);\r\n\r\n      return new Response(\r\n        JSON.stringify({ \r\n          success: false, \r\n          error: `Listing created (ID: ${pfListingId}) but publish failed: ${publishData.message || publishData.detail}`,\r\n          pf_listing_id: pfListingId,\r\n          status: \"draft\"\r\n        }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n      );\r\n    }\r\n\r\n    // Note: Per PF docs, 200 OK only confirms request received. \r\n    // Listing status should be verified via webhook or GET /listings/{id}\r\n    await updatePublicationStatus(supabase, listing.id as string, portalAccount.id as string,\r\n      portalAccount.portal_id as string, companyId, agentId, \"publishing\", null, null, pfListingId,\r\n      createData.reference || listing.reference_number as string);\r\n\r\n    return new Response(\r\n      JSON.stringify({ \r\n        success: true, \r\n        pf_listing_id: pfListingId,\r\n        reference: createData.reference,\r\n        message: \"Listing submitted for publishing. Status will be confirmed via webhook.\",\r\n        note: \"Per Property Finder API: 200 OK confirms request received. Subscribe to webhooks for publish confirmation.\"\r\n      }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n    );\r\n\r\n  } catch (error) {\r\n    console.error(\"[pf-publish] API call error:\", error);\r\n    \r\n    await logPublishAction(supabase, companyId, listing.id as string, portalAccount.id as string,\r\n      \"publish\", false, null, pfPayload, null, error instanceof Error ? error.message : \"Network error\");\r\n\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Failed to connect to Property Finder API\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nasync function handleUpdate(\r\n  supabase: AnySupabaseClient,\r\n  listing: Record<string, unknown>,\r\n  portalAccount: Record<string, unknown>,\r\n  agentMapping: Record<string, unknown>,\r\n  accessToken: string,\r\n  companyId: string,\r\n  agentId: string,\r\n  customizations?: Record<string, unknown>\r\n): Promise<Response> {\r\n  // Get existing publication\r\n  const { data: publication } = await supabase\r\n    .from(\"portal_listing_publications\")\r\n    .select(\"pf_listing_id\")\r\n    .eq(\"listing_id\", listing.id)\r\n    .eq(\"portal_account_id\", portalAccount.id)\r\n    .single();\r\n\r\n  if (!publication?.pf_listing_id) {\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Listing not published yet. Please publish first.\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n    );\r\n  }\r\n\r\n  const pfPayload = buildPFPayload(listing, agentMapping, customizations);\r\n\r\n  try {\r\n    const response = await fetch(`${PF_API_BASE}/listings/${publication.pf_listing_id}`, {\r\n      method: \"PUT\",\r\n      headers: {\r\n        \"Authorization\": `Bearer ${accessToken}`,\r\n        \"Content-Type\": \"application/json\",\r\n        \"Accept\": \"application/json\",\r\n      },\r\n      body: JSON.stringify(pfPayload),\r\n    });\r\n\r\n    const responseData = await response.json();\r\n\r\n    await logPublishAction(supabase, companyId, listing.id as string, portalAccount.id as string,\r\n      \"update\", response.ok, publication.pf_listing_id, pfPayload, responseData,\r\n      response.ok ? null : (responseData.message || \"Update failed\"));\r\n\r\n    if (!response.ok) {\r\n      await supabase\r\n        .from(\"portal_listing_publications\")\r\n        .update({\r\n          last_error_message: responseData.message || \"Update failed\",\r\n          last_error_details: responseData,\r\n        })\r\n        .eq(\"listing_id\", listing.id)\r\n        .eq(\"portal_account_id\", portalAccount.id);\r\n\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: responseData.message || \"Update failed\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n      );\r\n    }\r\n\r\n    await supabase\r\n      .from(\"portal_listing_publications\")\r\n      .update({\r\n        last_synced_at: new Date().toISOString(),\r\n        last_error_message: null,\r\n        last_error_details: null,\r\n      })\r\n      .eq(\"listing_id\", listing.id)\r\n      .eq(\"portal_account_id\", portalAccount.id);\r\n\r\n    return new Response(\r\n      JSON.stringify({ success: true, message: \"Listing updated on Property Finder\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n    );\r\n\r\n  } catch (error) {\r\n    console.error(\"[pf-publish] Update error:\", error);\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Failed to update listing\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nasync function handleUnpublish(\r\n  supabase: AnySupabaseClient,\r\n  listing: Record<string, unknown>,\r\n  portalAccount: Record<string, unknown>,\r\n  accessToken: string,\r\n  companyId: string,\r\n  _agentId: string\r\n): Promise<Response> {\r\n  const { data: publication } = await supabase\r\n    .from(\"portal_listing_publications\")\r\n    .select(\"pf_listing_id\")\r\n    .eq(\"listing_id\", listing.id)\r\n    .eq(\"portal_account_id\", portalAccount.id)\r\n    .single();\r\n\r\n  if (!publication?.pf_listing_id) {\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Listing not found on Property Finder\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n    );\r\n  }\r\n\r\n  try {\r\n    // Per PF docs 2025-07-21: Use POST /v1/listings/{id}/unpublish instead of DELETE\r\n    const response = await fetch(`${PF_API_BASE}/listings/${publication.pf_listing_id}/unpublish`, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Authorization\": `Bearer ${accessToken}`,\r\n        \"Accept\": \"application/json\",\r\n      },\r\n    });\r\n\r\n    const responseData = await response.json().catch(() => ({}));\r\n\r\n    await logPublishAction(supabase, companyId, listing.id as string, portalAccount.id as string,\r\n      \"unpublish\", response.ok || response.status === 404, publication.pf_listing_id);\r\n\r\n    if (!response.ok && response.status !== 404) {\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: responseData.message || \"Unpublish failed\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n      );\r\n    }\r\n\r\n    await supabase\r\n      .from(\"portal_listing_publications\")\r\n      .update({\r\n        status: \"unpublished\",\r\n        unpublished_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"listing_id\", listing.id)\r\n      .eq(\"portal_account_id\", portalAccount.id);\r\n\r\n    return new Response(\r\n      JSON.stringify({ success: true, message: \"Listing unpublished from Property Finder\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n    );\r\n\r\n  } catch (error) {\r\n    console.error(\"[pf-publish] Unpublish error:\", error);\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Failed to unpublish listing\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nasync function logPublishAction(\r\n  supabase: AnySupabaseClient,\r\n  companyId: string,\r\n  listingId: string,\r\n  portalAccountId: string,\r\n  action: string,\r\n  success: boolean,\r\n  portalListingId?: string | null,\r\n  requestPayload?: unknown,\r\n  responsePayload?: unknown,\r\n  errorMessage?: string | null\r\n): Promise<void> {\r\n  try {\r\n    await supabase.from(\"portal_publish_logs\").insert({\r\n      company_id: companyId,\r\n      listing_id: listingId,\r\n      portal_account_id: portalAccountId,\r\n      action,\r\n      success,\r\n      portal_listing_id: portalListingId,\r\n      request_payload: requestPayload,\r\n      response_payload: responsePayload,\r\n      error_message: errorMessage,\r\n    });\r\n  } catch (e) {\r\n    console.error(\"[pf-publish] Failed to log action:\", e);\r\n  }\r\n}\r\n\r\nasync function updatePublicationStatus(\r\n  supabase: AnySupabaseClient,\r\n  listingId: string,\r\n  portalAccountId: string,\r\n  portalId: string,\r\n  companyId: string,\r\n  agentId: string,\r\n  status: string,\r\n  errorMessage?: string | null,\r\n  errorDetails?: unknown,\r\n  pfListingId?: string,\r\n  pfReference?: string\r\n): Promise<void> {\r\n  try {\r\n    await supabase\r\n      .from(\"portal_listing_publications\")\r\n      .upsert({\r\n        listing_id: listingId,\r\n        portal_account_id: portalAccountId,\r\n        portal_id: portalId,\r\n        company_id: companyId,\r\n        agent_id: agentId,\r\n        status,\r\n        pf_listing_id: pfListingId,\r\n        pf_reference: pfReference,\r\n        portal_listing_id: pfListingId,\r\n        last_error_message: errorMessage,\r\n        last_error_details: errorDetails,\r\n        last_synced_at: new Date().toISOString(),\r\n        ...(status === \"live\" ? { published_at: new Date().toISOString() } : {}),\r\n      }, { onConflict: \"listing_id,portal_id\" });\r\n  } catch (e) {\r\n    console.error(\"[pf-publish] Failed to update publication status:\", e);\r\n  }\r\n}\r\n\r\nfunction buildPFPayload(\r\n  listing: Record<string, unknown>,\r\n  agentMapping: Record<string, unknown>,\r\n  customizations?: Record<string, unknown>\r\n): PFListingPayload {\r\n  const images = (listing.images as string[]) || [];\r\n  const videos = (listing.videos as string[]) || [];\r\n  const amenitiesRaw = (listing.amenities as unknown[]) || [];\r\n\r\n  // Map listing type to Property Finder offering type\r\n  const offeringType = (listing.listing_type as string)?.toLowerCase() === \"rent\" ? \"rent\" : \"sale\";\r\n\r\n  // Get property type\r\n  const propertyType = mapPropertyType(listing.property_type as string);\r\n\r\n  // Get category based on property type\r\n  const category = getCategory(listing.property_type as string);\r\n\r\n  // Handle title - support both custom objects and strings\r\n  let title: { primary: string; secondary?: string };\r\n  if (customizations?.title && typeof customizations.title === \"object\") {\r\n    const customTitle = customizations.title as Record<string, string>;\r\n    title = { primary: customTitle.en || customTitle.primary || listing.title as string || \"\" };\r\n    if (customTitle.ar || customTitle.secondary) {\r\n      title.secondary = customTitle.ar || customTitle.secondary;\r\n    }\r\n  } else {\r\n    title = { primary: (customizations?.title as string) || (listing.title as string) || \"\" };\r\n  }\r\n\r\n  // Handle description\r\n  let description: { primary: string; secondary?: string };\r\n  if (customizations?.description && typeof customizations.description === \"object\") {\r\n    const customDesc = customizations.description as Record<string, string>;\r\n    description = { primary: customDesc.en || customDesc.primary || listing.description as string || \"\" };\r\n    if (customDesc.ar || customDesc.secondary) {\r\n      description.secondary = customDesc.ar || customDesc.secondary;\r\n    }\r\n  } else {\r\n    description = { primary: (customizations?.description as string) || (listing.description as string) || \"\" };\r\n  }\r\n\r\n  // Get publicProfileId from agent mapping\r\n  const publicProfileId = parseInt(agentMapping.portal_public_profile_id as string) || \r\n                          parseInt(agentMapping.portal_agent_id as string);\r\n\r\n  // Get location ID - prefer pf_location_id if set\r\n  const locationId = listing.pf_location_id as number || listing.location_id as number || 0;\r\n\r\n  // Normalize amenities to PF format\r\n  const allowedAmenities = getAllowedPfAmenities(category);\r\n  const normalizedAmenities = amenitiesRaw\r\n    .map((a) => {\r\n      if (typeof a === \"string\") return a;\r\n      if (a && typeof a === \"object\" && \"name\" in a && typeof (a as Record<string, unknown>).name === \"string\") {\r\n        return (a as Record<string, unknown>).name as string;\r\n      }\r\n      return \"\";\r\n    })\r\n    .map(normalizeAmenitySlug)\r\n    .filter(Boolean)\r\n    .filter((slug, idx, arr) => arr.indexOf(slug) === idx)\r\n    .filter((slug) => allowedAmenities.has(slug));\r\n\r\n  const payload: PFListingPayload = {\r\n    reference: (listing.reference_number as string) || (listing.id as string),\r\n    publicProfileId,\r\n    locationId,\r\n    category,\r\n    offeringType,\r\n    propertyType,\r\n    title,\r\n    description,\r\n    price: (customizations?.price as number) || (listing.price as number),\r\n    currency: (listing.currency as string) || \"AED\",\r\n    bedrooms: listing.number_of_bedrooms as number,\r\n    bathrooms: listing.number_of_bathrooms as number,\r\n    size: listing.area_size as number,\r\n    furnished: mapFurnished(listing.furnished as string),\r\n    parking: listing.parking_spaces as number,\r\n  };\r\n\r\n  // Add media\r\n  if (images.length > 0) {\r\n    payload.media = {\r\n      images: images.map((url, index) => ({\r\n        original: { url },\r\n        title: `Photo ${index + 1}`,\r\n      })),\r\n    };\r\n  }\r\n  if (videos.length > 0) {\r\n    if (!payload.media) payload.media = {};\r\n    payload.media.videos = videos.map((url, index) => ({\r\n      url,\r\n      title: `Video ${index + 1}`,\r\n    }));\r\n  }\r\n\r\n  // Add amenities if any valid ones\r\n  if (normalizedAmenities.length > 0) {\r\n    payload.amenities = normalizedAmenities;\r\n  }\r\n\r\n  // Add compliance info (required for Dubai)\r\n  if (listing.permit_number || listing.rera_number || listing.company_license) {\r\n    payload.compliance = {};\r\n    if (listing.permit_number || listing.rera_number) {\r\n      payload.compliance.listingAdvertisementNumber = (listing.rera_number as string) || (listing.permit_number as string);\r\n    }\r\n    if (listing.company_license) {\r\n      payload.compliance.issuingClientLicenseNumber = listing.company_license as string;\r\n    }\r\n  }\r\n\r\n  // Add geo coordinates if available\r\n  if (listing.latitude && listing.longitude) {\r\n    payload.geoPoints = {\r\n      lat: listing.latitude as number,\r\n      lng: listing.longitude as number,\r\n    };\r\n  }\r\n\r\n  // Add rental period for rent listings\r\n  if (offeringType === \"rent\") {\r\n    payload.rentalPeriod = (listing.rental_period as \"yearly\" | \"monthly\" | \"weekly\" | \"daily\") || \"yearly\";\r\n  }\r\n\r\n  // Add plot size for land\r\n  if (listing.plot_size) {\r\n    payload.plotSize = listing.plot_size as number;\r\n  }\r\n\r\n  // Add completion status\r\n  if (listing.completion_status) {\r\n    payload.completionStatus = listing.completion_status as \"ready\" | \"off-plan\";\r\n  }\r\n\r\n  return payload;\r\n}\r\n\r\nfunction getCategory(propertyType: string): \"residential\" | \"commercial\" {\r\n  const commercialTypes = [\r\n    \"office\", \"shop\", \"warehouse\", \"factory\", \"showroom\", \"retail\",\r\n    \"labor-camp\", \"staff-accommodation\", \"business-center\", \"co-working-space\",\r\n    \"commercial-building\", \"commercial-floor\", \"commercial-plot\"\r\n  ];\r\n  return commercialTypes.includes(propertyType?.toLowerCase()) ? \"commercial\" : \"residential\";\r\n}\r\n\r\nfunction mapFurnished(furnished: string): \"furnished\" | \"unfurnished\" | \"semi-furnished\" | undefined {\r\n  if (!furnished) return undefined;\r\n  const lower = furnished.toLowerCase();\r\n  if (lower === \"furnished\" || lower === \"yes\") return \"furnished\";\r\n  if (lower === \"unfurnished\" || lower === \"no\") return \"unfurnished\";\r\n  if (lower.includes(\"semi\") || lower.includes(\"partial\")) return \"semi-furnished\";\r\n  return undefined;\r\n}\r\n\r\nfunction getAllowedPfAmenities(category: \"residential\" | \"commercial\"): Set<string> {\r\n  // Per Property Finder API docs - different amenities allowed per category\r\n  if (category === \"commercial\") {\r\n    return new Set([\r\n      \"shared-gym\", \"covered-parking\", \"networked\", \"shared-pool\",\r\n      \"dining-in-building\", \"conference-room\", \"lobby-in-building\", \"vastu-compliant\"\r\n    ]);\r\n  }\r\n  // Residential\r\n  return new Set([\r\n    \"central-ac\", \"built-in-wardrobes\", \"kitchen-appliances\", \"security\",\r\n    \"concierge\", \"maid-service\", \"balcony\", \"private-gym\", \"shared-gym\",\r\n    \"private-jacuzzi\", \"shared-spa\", \"covered-parking\", \"maids-room\",\r\n    \"study\", \"childrens-play-area\", \"pets-allowed\", \"barbecue-area\",\r\n    \"shared-pool\", \"childrens-pool\", \"private-garden\", \"private-pool\",\r\n    \"view-of-water\", \"view-of-landmark\", \"walk-in-closet\", \"lobby-in-building\"\r\n  ]);\r\n}\r\n\r\nfunction normalizeAmenitySlug(input: string): string {\r\n  return input\r\n    .trim()\r\n    .toLowerCase()\r\n    .replace(/&/g, \" and \")\r\n    .replace(/\\s+/g, \"-\")\r\n    .replace(/_+/g, \"-\")\r\n    .replace(/[^a-z0-9-]/g, \"\")\r\n    .replace(/-+/g, \"-\")\r\n    .replace(/^-|-$/g, \"\");\r\n}\r\n\r\nfunction mapPropertyType(type: string): string {\r\n  // Property Finder uses slug-style property types\r\n  const typeMap: Record<string, string> = {\r\n    apartment: \"apartment\",\r\n    villa: \"villa\",\r\n    townhouse: \"townhouse\",\r\n    penthouse: \"penthouse\",\r\n    duplex: \"duplex\",\r\n    \"hotel apartment\": \"hotel-apartment\",\r\n    \"residential plot\": \"land\",\r\n    \"residential floor\": \"full-floor\",\r\n    office: \"office-space\",\r\n    shop: \"shop\",\r\n    warehouse: \"warehouse\",\r\n    \"labor camp\": \"labor-camp\",\r\n    factory: \"factory\",\r\n    showroom: \"show-room\",\r\n    retail: \"retail\",\r\n    \"commercial building\": \"whole-building\",\r\n    \"commercial floor\": \"full-floor\",\r\n    \"commercial plot\": \"land\",\r\n    land: \"land\",\r\n    bungalow: \"bungalow\",\r\n    compound: \"compound\",\r\n    farm: \"farm\",\r\n  };\r\n\r\n  return typeMap[type?.toLowerCase()] || \"apartment\";\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\pf-webhook\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":214,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":214,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7189,7192],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7189,7192],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":277,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":277,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9323,9326],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9323,9326],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":408,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":408,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13765,13768],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13765,13768],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":479,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":479,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16137,16140],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16137,16140],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":585,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":585,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19735,19738],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19735,19738],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":618,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":618,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20831,20834],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20831,20834],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":648,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":648,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21810,21813],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21810,21813],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":680,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":680,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22951,22954],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22951,22954],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { serve } from \"https://deno.land/std@0.168.0/http/server.ts\";\r\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2\";\r\n\r\nconst corsHeaders = {\r\n  \"Access-Control-Allow-Origin\": \"*\",\r\n  \"Access-Control-Allow-Headers\": \"authorization, x-client-info, apikey, content-type, x-pf-signature, x-webhook-secret\",\r\n};\r\n\r\n// Property Finder Webhook Event Types based on actual PF API\r\ntype PFEventType = \r\n  | \"lead-created\"\r\n  | \"lead.created\"\r\n  | \"lead-updated\"\r\n  | \"lead.updated\"\r\n  | \"lead-assigned\"\r\n  | \"lead.assigned\"\r\n  | \"listing.published\"\r\n  | \"listing.unpublished\"\r\n  | \"listing.rejected\"\r\n  | \"listing.expired\"\r\n  | \"publicProfile.verification.approved\"\r\n  | \"publicProfile.verification.rejected\";\r\n\r\n// Contact information structure\r\ninterface PFContact {\r\n  type: \"phone\" | \"email\" | \"whatsapp\";\r\n  value: string;\r\n}\r\n\r\n// Sender information\r\ninterface PFSender {\r\n  name?: string;\r\n  contacts?: PFContact[];\r\n}\r\n\r\n// PF Webhook Payload matching actual API\r\ninterface PFWebhookPayload {\r\n  id: string; // Event ID like \"lead-created-12345678\"\r\n  type: string; // Event type string\r\n  timestamp: string;\r\n  entity: {\r\n    id: string;\r\n    type: \"lead\" | \"listing\" | \"publicProfile\";\r\n  };\r\n  payload: {\r\n    // Lead payload fields\r\n    channel?: \"whatsapp\" | \"email\" | \"call\" | \"sms\";\r\n    status?: string;\r\n    entityType?: \"listing\" | \"project\" | \"developer\";\r\n    publicProfile?: {\r\n      id: number;\r\n    };\r\n    listing?: {\r\n      id: string;\r\n      reference: string;\r\n    };\r\n    project?: {\r\n      id: string;\r\n    };\r\n    developer?: {\r\n      id: string;\r\n    };\r\n    responseLink?: string;\r\n    sender?: PFSender;\r\n    message?: string;\r\n    // Listing payload fields\r\n    listingId?: number;\r\n    reference?: string;\r\n    rejectionReason?: string;\r\n  };\r\n}\r\n\r\nserve(async (req) => {\r\n  if (req.method === \"OPTIONS\") {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  if (req.method !== \"POST\") {\r\n    return new Response(JSON.stringify({ error: \"Method not allowed\" }), {\r\n      status: 405,\r\n      headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\r\n    });\r\n  }\r\n\r\n  const startTime = Date.now();\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get(\"SUPABASE_URL\")!;\r\n    const supabaseKey = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!;\r\n    const supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\n    // Get company_id from query params\r\n    const url = new URL(req.url);\r\n    const companyId = url.searchParams.get(\"company_id\");\r\n\r\n    if (!companyId) {\r\n      console.error(\"[pf-webhook] No company_id provided in webhook URL\");\r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        error: \"Missing company_id parameter. Add ?company_id=YOUR_COMPANY_ID to webhook URL\" \r\n      }), {\r\n        status: 400,\r\n        headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\r\n      });\r\n    }\r\n\r\n    // Get webhook secret for validation (optional but recommended)\r\n    const signature = req.headers.get(\"x-pf-signature\") || req.headers.get(\"x-webhook-secret\");\r\n    \r\n    // Get portal account to validate secret\r\n    const { data: portalAccount } = await supabase\r\n      .from(\"portal_accounts\")\r\n      .select(\"id, credentials\")\r\n      .eq(\"company_id\", companyId)\r\n      .eq(\"portal_type\", \"property_finder\")\r\n      .single();\r\n\r\n    if (portalAccount && signature) {\r\n      const credentials = portalAccount.credentials as Record<string, string> | null;\r\n      const expectedSecret = credentials?.webhook_secret;\r\n      \r\n      if (expectedSecret && expectedSecret !== signature) {\r\n        console.error(\"[pf-webhook] Invalid webhook signature\");\r\n        return new Response(JSON.stringify({ \r\n          success: false, \r\n          error: \"Invalid webhook signature\" \r\n        }), {\r\n          status: 401,\r\n          headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\r\n        });\r\n      }\r\n    }\r\n\r\n    // Parse webhook payload\r\n    const payload: PFWebhookPayload = await req.json();\r\n    \r\n    // Determine event type - handle both formats: \"lead-created\" and \"lead.created\"\r\n    const eventType = payload.type?.replace(\"-\", \".\") || payload.id?.split(\"-\").slice(0, 2).join(\".\") || \"unknown\";\r\n    \r\n    console.log(`[pf-webhook] Received event: ${eventType}, entity: ${payload.entity?.type}`, JSON.stringify(payload));\r\n\r\n    // Log the webhook event\r\n    await supabase.from(\"portal_webhook_events\").insert({\r\n      company_id: companyId,\r\n      portal_name: \"property_finder\",\r\n      event_type: eventType,\r\n      event_data: payload.payload,\r\n      status: \"processing\",\r\n      received_at: new Date().toISOString(),\r\n    });\r\n\r\n    let result: { success: boolean; message?: string; lead_id?: string; duplicate?: boolean };\r\n\r\n    // Route based on event type\r\n    const normalizedEvent = eventType.replace(\"-\", \".\");\r\n    \r\n    if (normalizedEvent === \"lead.created\") {\r\n      result = await handleLeadCreated(supabase, companyId, portalAccount?.id, payload);\r\n    } else if (normalizedEvent === \"lead.updated\") {\r\n      result = await handleLeadUpdated(supabase, companyId, payload);\r\n    } else if (normalizedEvent === \"lead.assigned\") {\r\n      result = await handleLeadAssigned(supabase, companyId, payload);\r\n    } else if (normalizedEvent === \"listing.published\") {\r\n      result = await handleListingPublished(supabase, companyId, payload);\r\n    } else if (normalizedEvent === \"listing.unpublished\") {\r\n      result = await handleListingUnpublished(supabase, companyId, payload);\r\n    } else if (normalizedEvent === \"listing.rejected\") {\r\n      result = await handleListingRejected(supabase, companyId, payload);\r\n    } else if (normalizedEvent === \"listing.expired\") {\r\n      result = await handleListingExpired(supabase, companyId, payload);\r\n    } else {\r\n      console.log(`[pf-webhook] Unhandled event type: ${eventType}`);\r\n      result = { success: true, message: `Event ${eventType} acknowledged but not processed` };\r\n    }\r\n\r\n    // Update webhook event status\r\n    await supabase.from(\"portal_webhook_logs\").insert({\r\n      company_id: companyId,\r\n      portal_name: \"property_finder\",\r\n      event_type: eventType,\r\n      status: result.success ? \"success\" : \"failed\",\r\n      request_payload: payload,\r\n      response_payload: result,\r\n      processing_time_ms: Date.now() - startTime,\r\n    });\r\n\r\n    const statusCode = result.duplicate ? 200 : (result.success ? 201 : 500);\r\n\r\n    return new Response(JSON.stringify({\r\n      ...result,\r\n      processing_time_ms: Date.now() - startTime\r\n    }), {\r\n      status: statusCode,\r\n      headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\r\n    });\r\n\r\n  } catch (error) {\r\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\r\n    console.error(\"[pf-webhook] Error:\", errorMessage);\r\n    \r\n    return new Response(JSON.stringify({ \r\n      success: false, \r\n      error: errorMessage,\r\n      processing_time_ms: Date.now() - startTime\r\n    }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\r\n    });\r\n  }\r\n});\r\n\r\nasync function handleLeadCreated(\r\n  // deno-lint-ignore no-explicit-any\r\n  supabase: any,\r\n  companyId: string,\r\n  portalAccountId: string | undefined,\r\n  payload: PFWebhookPayload\r\n): Promise<{ success: boolean; message?: string; lead_id?: string; duplicate?: boolean }> {\r\n  const { payload: data, entity, id: webhookEventId } = payload;\r\n  \r\n  const pfLeadId = entity?.id || webhookEventId;\r\n  const listing = data.listing;\r\n  const sender = data.sender;\r\n  \r\n  // Extract contact info from sender.contacts array\r\n  const contacts = sender?.contacts || [];\r\n  const phoneContact = contacts.find(c => c.type === \"phone\" || c.type === \"whatsapp\");\r\n  const emailContact = contacts.find(c => c.type === \"email\");\r\n  \r\n  const contactName = sender?.name;\r\n  const contactPhone = phoneContact?.value;\r\n  const contactEmail = emailContact?.value;\r\n\r\n  console.log(`[pf-webhook] Processing lead: ${pfLeadId}, listing: ${listing?.id}, reference: ${listing?.reference}, channel: ${data.channel}`);\r\n\r\n  // Check for duplicate lead\r\n  if (pfLeadId) {\r\n    const { data: existingLead } = await supabase\r\n      .from(\"leads\")\r\n      .select(\"id\")\r\n      .eq(\"company_id\", companyId)\r\n      .eq(\"pf_lead_id\", pfLeadId)\r\n      .single();\r\n\r\n    if (existingLead) {\r\n      console.log(`[pf-webhook] Duplicate lead: ${pfLeadId}`);\r\n      return { success: true, lead_id: existingLead.id, duplicate: true };\r\n    }\r\n  }\r\n\r\n  // Find listing by portal_listing_id or reference\r\n  let listingData: Record<string, unknown> | null = null;\r\n  let assignedAgentId: string | null = null;\r\n\r\n  if (listing) {\r\n    // Try to find by PF listing ID or reference\r\n    const { data: publication } = await supabase\r\n      .from(\"portal_listing_publications\")\r\n      .select(`\r\n        listing_id,\r\n        company_id,\r\n        portal_account_id,\r\n        listings!inner(\r\n          id,\r\n          company_id,\r\n          assigned_agent_id,\r\n          title,\r\n          reference_number\r\n        )\r\n      `)\r\n      .eq(\"company_id\", companyId)\r\n      .or(`pf_listing_id.eq.${listing.id},pf_reference.eq.${listing.reference}`)\r\n      .single();\r\n\r\n    if (publication) {\r\n      // deno-lint-ignore no-explicit-any\r\n      listingData = (publication as any).listings;\r\n      assignedAgentId = listingData?.assigned_agent_id as string;\r\n    }\r\n  }\r\n\r\n  // If no listing found via publication, try matching by public profile\r\n  if (!listingData && data.publicProfile?.id) {\r\n    // Try to find agent by PF public profile ID\r\n    const { data: agentMapping } = await supabase\r\n      .from(\"portal_agents\")\r\n      .select(\"agent_id\")\r\n      .eq(\"company_id\", companyId)\r\n      .eq(\"portal_agent_id\", data.publicProfile.id.toString())\r\n      .eq(\"portal_name\", \"property_finder\")\r\n      .single();\r\n\r\n    if (agentMapping) {\r\n      assignedAgentId = agentMapping.agent_id;\r\n    }\r\n  }\r\n\r\n  if (!listingData && !assignedAgentId) {\r\n    console.warn(`[pf-webhook] Listing not found for lead: ${pfLeadId}`);\r\n    \r\n    // Log as import error for manual review\r\n    await supabase.from(\"portal_import_errors\").insert({\r\n      company_id: companyId,\r\n      portal_name: \"property_finder\",\r\n      lead_data: payload.payload,\r\n      error_message: \"Listing not found in CRM\",\r\n      error_type: \"listing_not_found\",\r\n    });\r\n  }\r\n\r\n  // Get default stage\r\n  const { data: defaultStage } = await supabase\r\n    .from(\"lead_stages\")\r\n    .select(\"id\")\r\n    .eq(\"company_id\", companyId)\r\n    .eq(\"is_default\", true)\r\n    .single();\r\n\r\n  // Normalize phone number\r\n  const normalizedPhone = normalizePhone(contactPhone);\r\n\r\n  // Create the lead\r\n  const { data: newLead, error: leadError } = await supabase\r\n    .from(\"leads\")\r\n    .insert({\r\n      company_id: companyId,\r\n      name: contactName || \"Property Finder Lead\",\r\n      email: contactEmail,\r\n      phone: contactPhone,\r\n      normalized_phone: normalizedPhone,\r\n      message: data.message,\r\n      source: \"Property Finder\",\r\n      pf_lead_id: pfLeadId,\r\n      portal_listing_id: listing?.id?.toString(),\r\n      is_pf_lead: true,\r\n      assigned_agent_id: assignedAgentId,\r\n      assignment_source: assignedAgentId ? \"listing_agent\" : null,\r\n      assignment_reason: assignedAgentId ? \"Assigned to listing agent from Property Finder lead\" : null,\r\n      stage_id: defaultStage?.id,\r\n      stage: \"New\",\r\n      source_metadata: {\r\n        portal: \"property_finder\",\r\n        portal_lead_id: pfLeadId,\r\n        portal_listing_id: listing?.id,\r\n        portal_listing_reference: listing?.reference,\r\n        listing_title: listingData?.title,\r\n        response_link: data.responseLink,\r\n        channel: data.channel,\r\n        public_profile_id: data.publicProfile?.id,\r\n        project_id: data.project?.id,\r\n        developer_id: data.developer?.id,\r\n        entity_type: data.entityType,\r\n        received_at: new Date().toISOString(),\r\n        webhook_event: payload.type,\r\n        webhook_timestamp: payload.timestamp,\r\n      },\r\n      fetched_at: new Date().toISOString(),\r\n    })\r\n    .select(\"id\")\r\n    .single();\r\n\r\n  if (leadError) {\r\n    console.error(`[pf-webhook] Failed to create lead:`, leadError);\r\n    \r\n    await supabase.from(\"portal_import_errors\").insert({\r\n      company_id: companyId,\r\n      portal_name: \"property_finder\",\r\n      lead_data: payload.payload,\r\n      error_message: leadError.message,\r\n      error_type: \"insert_failed\",\r\n    });\r\n\r\n    return { success: false, message: leadError.message };\r\n  }\r\n\r\n  // Create activity log\r\n  const channelLabel = data.channel ? ` via ${data.channel}` : \"\";\r\n  await supabase.from(\"lead_activities\").insert({\r\n    lead_id: newLead.id,\r\n    company_id: companyId,\r\n    type: \"created\",\r\n    title: \"Lead from Property Finder\",\r\n    description: listingData \r\n      ? `New inquiry${channelLabel} for \"${listingData.title}\" received from Property Finder`\r\n      : `New inquiry${channelLabel} received from Property Finder`,\r\n    agent_name: \"Property Finder\",\r\n    agent_id: assignedAgentId,\r\n  });\r\n\r\n  // Create assignment notification if agent is assigned\r\n  if (assignedAgentId) {\r\n    await supabase.from(\"assignment_notifications\").insert({\r\n      company_id: companyId,\r\n      agent_id: assignedAgentId,\r\n      lead_id: newLead.id,\r\n      notification_type: \"assignment\",\r\n      title: \"New Property Finder Lead\",\r\n      message: `You have a new inquiry${channelLabel} from ${contactName || 'a customer'}${listingData ? ` for \"${listingData.title}\"` : ''}`,\r\n    });\r\n  }\r\n\r\n  console.log(`[pf-webhook] Lead created: ${newLead.id}`);\r\n  return { success: true, lead_id: newLead.id };\r\n}\r\n\r\nasync function handleLeadUpdated(\r\n  // deno-lint-ignore no-explicit-any\r\n  supabase: any,\r\n  companyId: string,\r\n  payload: PFWebhookPayload\r\n): Promise<{ success: boolean; message?: string; lead_id?: string }> {\r\n  const { payload: data, entity } = payload;\r\n  const pfLeadId = entity?.id;\r\n  \r\n  console.log(`[pf-webhook] Processing lead update: ${pfLeadId}`);\r\n\r\n  // Find existing lead by PF lead ID\r\n  const { data: existingLead } = await supabase\r\n    .from(\"leads\")\r\n    .select(\"id, name, email, phone\")\r\n    .eq(\"company_id\", companyId)\r\n    .eq(\"pf_lead_id\", pfLeadId)\r\n    .single();\r\n\r\n  if (!existingLead) {\r\n    console.warn(`[pf-webhook] Lead not found for update: ${pfLeadId}`);\r\n    return { success: false, message: \"Lead not found\" };\r\n  }\r\n\r\n  // Extract updated contact info\r\n  const sender = data.sender;\r\n  const contacts = sender?.contacts || [];\r\n  const phoneContact = contacts.find(c => c.type === \"phone\" || c.type === \"whatsapp\");\r\n  const emailContact = contacts.find(c => c.type === \"email\");\r\n\r\n  // Build update object - only update fields that have new values\r\n  const updates: Record<string, unknown> = {\r\n    updated_at: new Date().toISOString(),\r\n  };\r\n  \r\n  if (sender?.name && sender.name !== existingLead.name) {\r\n    updates.name = sender.name;\r\n  }\r\n  if (emailContact?.value && emailContact.value !== existingLead.email) {\r\n    updates.email = emailContact.value;\r\n  }\r\n  if (phoneContact?.value && phoneContact.value !== existingLead.phone) {\r\n    updates.phone = phoneContact.value;\r\n    updates.normalized_phone = normalizePhone(phoneContact.value);\r\n  }\r\n\r\n  // Update lead\r\n  const { error: updateError } = await supabase\r\n    .from(\"leads\")\r\n    .update(updates)\r\n    .eq(\"id\", existingLead.id);\r\n\r\n  if (updateError) {\r\n    console.error(`[pf-webhook] Failed to update lead:`, updateError);\r\n    return { success: false, message: updateError.message };\r\n  }\r\n\r\n  // Log the update activity\r\n  await supabase.from(\"lead_activities\").insert({\r\n    lead_id: existingLead.id,\r\n    company_id: companyId,\r\n    type: \"updated\",\r\n    title: \"Lead Updated from Property Finder\",\r\n    description: \"Lead information was updated via Property Finder webhook\",\r\n    agent_name: \"Property Finder\",\r\n  });\r\n\r\n  console.log(`[pf-webhook] Lead updated: ${existingLead.id}`);\r\n  return { success: true, lead_id: existingLead.id };\r\n}\r\n\r\nasync function handleLeadAssigned(\r\n  // deno-lint-ignore no-explicit-any\r\n  supabase: any,\r\n  companyId: string,\r\n  payload: PFWebhookPayload\r\n): Promise<{ success: boolean; message?: string; lead_id?: string }> {\r\n  const { payload: data, entity } = payload;\r\n  const pfLeadId = entity?.id;\r\n  const publicProfileId = data.publicProfile?.id;\r\n  \r\n  console.log(`[pf-webhook] Processing lead assignment: ${pfLeadId}, publicProfile: ${publicProfileId}`);\r\n\r\n  // Find existing lead by PF lead ID\r\n  const { data: existingLead } = await supabase\r\n    .from(\"leads\")\r\n    .select(\"id, assigned_agent_id\")\r\n    .eq(\"company_id\", companyId)\r\n    .eq(\"pf_lead_id\", pfLeadId)\r\n    .single();\r\n\r\n  if (!existingLead) {\r\n    console.warn(`[pf-webhook] Lead not found for assignment: ${pfLeadId}`);\r\n    return { success: false, message: \"Lead not found\" };\r\n  }\r\n\r\n  // Find agent by PF public profile ID\r\n  let newAgentId: string | null = null;\r\n  \r\n  if (publicProfileId) {\r\n    const { data: agentMapping } = await supabase\r\n      .from(\"portal_agents\")\r\n      .select(\"agent_id\")\r\n      .eq(\"company_id\", companyId)\r\n      .eq(\"portal_agent_id\", publicProfileId.toString())\r\n      .eq(\"portal_name\", \"property_finder\")\r\n      .single();\r\n\r\n    if (agentMapping) {\r\n      newAgentId = agentMapping.agent_id;\r\n    }\r\n  }\r\n\r\n  if (!newAgentId) {\r\n    console.warn(`[pf-webhook] No agent mapping found for publicProfile: ${publicProfileId}`);\r\n    \r\n    // Log for manual review\r\n    await supabase.from(\"portal_import_errors\").insert({\r\n      company_id: companyId,\r\n      portal_name: \"property_finder\",\r\n      lead_data: payload.payload,\r\n      error_message: `No agent mapping for Property Finder publicProfile ${publicProfileId}`,\r\n      error_type: \"agent_mapping_not_found\",\r\n    });\r\n    \r\n    return { success: true, message: \"Lead assignment acknowledged but no agent mapping found\" };\r\n  }\r\n\r\n  // Skip if same agent\r\n  if (existingLead.assigned_agent_id === newAgentId) {\r\n    console.log(`[pf-webhook] Lead already assigned to same agent`);\r\n    return { success: true, lead_id: existingLead.id, message: \"Already assigned to this agent\" };\r\n  }\r\n\r\n  const previousAgentId = existingLead.assigned_agent_id;\r\n\r\n  // Update lead assignment\r\n  const { error: updateError } = await supabase\r\n    .from(\"leads\")\r\n    .update({\r\n      assigned_agent_id: newAgentId,\r\n      assignment_source: \"property_finder\",\r\n      assignment_reason: \"Reassigned via Property Finder webhook\",\r\n      updated_at: new Date().toISOString(),\r\n    })\r\n    .eq(\"id\", existingLead.id);\r\n\r\n  if (updateError) {\r\n    console.error(`[pf-webhook] Failed to assign lead:`, updateError);\r\n    return { success: false, message: updateError.message };\r\n  }\r\n\r\n  // Log the assignment activity\r\n  await supabase.from(\"lead_activities\").insert({\r\n    lead_id: existingLead.id,\r\n    company_id: companyId,\r\n    type: \"assigned\",\r\n    title: \"Lead Reassigned from Property Finder\",\r\n    description: `Lead was reassigned via Property Finder`,\r\n    agent_id: newAgentId,\r\n    agent_name: \"Property Finder\",\r\n  });\r\n\r\n  // Create assignment notification for new agent\r\n  await supabase.from(\"assignment_notifications\").insert({\r\n    company_id: companyId,\r\n    agent_id: newAgentId,\r\n    lead_id: existingLead.id,\r\n    notification_type: \"assignment\",\r\n    title: \"Lead Assigned from Property Finder\",\r\n    message: \"A lead has been assigned to you via Property Finder\",\r\n  });\r\n\r\n  console.log(`[pf-webhook] Lead assigned: ${existingLead.id} -> agent ${newAgentId}`);\r\n  return { success: true, lead_id: existingLead.id };\r\n}\r\n\r\nasync function handleListingPublished(\r\n  // deno-lint-ignore no-explicit-any\r\n  supabase: any,\r\n  companyId: string,\r\n  payload: PFWebhookPayload\r\n): Promise<{ success: boolean; message?: string }> {\r\n  const { payload: data, entity } = payload;\r\n  const pfListingId = data.listingId || entity?.id;\r\n  const reference = data.reference;\r\n\r\n  console.log(`[pf-webhook] Listing published: ${pfListingId}, reference: ${reference}`);\r\n\r\n  // Update the publication status\r\n  const { error } = await supabase\r\n    .from(\"portal_listing_publications\")\r\n    .update({\r\n      status: \"live\",\r\n      published_at: new Date().toISOString(),\r\n      last_synced_at: new Date().toISOString(),\r\n      last_error_message: null,\r\n      last_error_details: null,\r\n    })\r\n    .eq(\"company_id\", companyId)\r\n    .or(`pf_listing_id.eq.${pfListingId},pf_reference.eq.${reference}`);\r\n\r\n  if (error) {\r\n    console.error(\"[pf-webhook] Failed to update listing status:\", error);\r\n    return { success: false, message: error.message };\r\n  }\r\n\r\n  return { success: true, message: \"Listing marked as published\" };\r\n}\r\n\r\nasync function handleListingUnpublished(\r\n  // deno-lint-ignore no-explicit-any\r\n  supabase: any,\r\n  companyId: string,\r\n  payload: PFWebhookPayload\r\n): Promise<{ success: boolean; message?: string }> {\r\n  const { payload: data, entity } = payload;\r\n  const pfListingId = data.listingId || entity?.id;\r\n  const reference = data.reference;\r\n\r\n  console.log(`[pf-webhook] Listing unpublished: ${pfListingId}`);\r\n\r\n  const { error } = await supabase\r\n    .from(\"portal_listing_publications\")\r\n    .update({\r\n      status: \"unpublished\",\r\n      unpublished_at: new Date().toISOString(),\r\n      last_synced_at: new Date().toISOString(),\r\n    })\r\n    .eq(\"company_id\", companyId)\r\n    .or(`pf_listing_id.eq.${pfListingId},pf_reference.eq.${reference}`);\r\n\r\n  if (error) {\r\n    console.error(\"[pf-webhook] Failed to update listing status:\", error);\r\n    return { success: false, message: error.message };\r\n  }\r\n\r\n  return { success: true, message: \"Listing marked as unpublished\" };\r\n}\r\n\r\nasync function handleListingRejected(\r\n  // deno-lint-ignore no-explicit-any\r\n  supabase: any,\r\n  companyId: string,\r\n  payload: PFWebhookPayload\r\n): Promise<{ success: boolean; message?: string }> {\r\n  const { payload: data, entity } = payload;\r\n  const pfListingId = data.listingId || entity?.id;\r\n  const reference = data.reference;\r\n  const rejectionReason = data.rejectionReason || data.status;\r\n\r\n  console.log(`[pf-webhook] Listing rejected: ${pfListingId}, reason: ${rejectionReason}`);\r\n\r\n  const { error } = await supabase\r\n    .from(\"portal_listing_publications\")\r\n    .update({\r\n      status: \"rejected\",\r\n      last_synced_at: new Date().toISOString(),\r\n      last_error_message: rejectionReason || \"Listing rejected by Property Finder\",\r\n      last_error_details: payload.payload,\r\n    })\r\n    .eq(\"company_id\", companyId)\r\n    .or(`pf_listing_id.eq.${pfListingId},pf_reference.eq.${reference}`);\r\n\r\n  if (error) {\r\n    console.error(\"[pf-webhook] Failed to update listing status:\", error);\r\n    return { success: false, message: error.message };\r\n  }\r\n\r\n  return { success: true, message: \"Listing marked as rejected\" };\r\n}\r\n\r\nasync function handleListingExpired(\r\n  // deno-lint-ignore no-explicit-any\r\n  supabase: any,\r\n  companyId: string,\r\n  payload: PFWebhookPayload\r\n): Promise<{ success: boolean; message?: string }> {\r\n  const { payload: data, entity } = payload;\r\n  const pfListingId = data.listingId || entity?.id;\r\n  const reference = data.reference;\r\n\r\n  console.log(`[pf-webhook] Listing expired: ${pfListingId}`);\r\n\r\n  const { error } = await supabase\r\n    .from(\"portal_listing_publications\")\r\n    .update({\r\n      status: \"expired\",\r\n      last_synced_at: new Date().toISOString(),\r\n    })\r\n    .eq(\"company_id\", companyId)\r\n    .or(`pf_listing_id.eq.${pfListingId},pf_reference.eq.${reference}`);\r\n\r\n  if (error) {\r\n    console.error(\"[pf-webhook] Failed to update listing status:\", error);\r\n    return { success: false, message: error.message };\r\n  }\r\n\r\n  return { success: true, message: \"Listing marked as expired\" };\r\n}\r\n\r\nfunction normalizePhone(phone: string | undefined): string | null {\r\n  if (!phone) return null;\r\n  \r\n  let cleaned = phone.replace(/[^0-9+]/g, \"\");\r\n  \r\n  if (cleaned.startsWith(\"00\")) {\r\n    cleaned = \"+\" + cleaned.substring(2);\r\n  }\r\n  \r\n  if (!cleaned.startsWith(\"+\")) {\r\n    cleaned = \"+\" + cleaned;\r\n  }\r\n  \r\n  return cleaned.length >= 8 ? cleaned : null;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\portal-agents-fetch\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\portal-leads-fetch\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\portal-publish\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":371,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":371,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12673,12676],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12673,12676],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":371,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":371,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12708,12711],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12708,12711],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":375,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":375,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12828,12831],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12828,12831],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":376,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":376,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12875,12878],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12875,12878],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { serve } from \"https://deno.land/std@0.168.0/http/server.ts\";\r\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2\";\r\n\r\nconst corsHeaders = {\r\n  \"Access-Control-Allow-Origin\": \"*\",\r\n  \"Access-Control-Allow-Headers\": \"authorization, x-client-info, apikey, content-type\",\r\n};\r\n\r\ninterface PublishRequest {\r\n  action: \"publish\" | \"update\" | \"unpublish\" | \"validate\" | \"sync\";\r\n  listing_id: string;\r\n  portal_id: string;\r\n  agent_id: string;\r\n  company_id: string;\r\n  portal_account_id?: string;\r\n  customizations?: {\r\n    title?: string;\r\n    description?: string;\r\n    price?: number;\r\n    currency?: string;\r\n    images?: string[];\r\n    metadata?: Record<string, unknown>;\r\n  };\r\n}\r\n\r\nserve(async (req) => {\r\n  // Handle CORS preflight\r\n  if (req.method === \"OPTIONS\") {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get(\"SUPABASE_URL\")!;\r\n    const supabaseServiceKey = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!;\r\n    const supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n    const body: PublishRequest = await req.json();\r\n    const { action, listing_id, portal_id, agent_id, company_id, portal_account_id, customizations } = body;\r\n\r\n    console.log(`[portal-publish] Action: ${action}, Listing: ${listing_id}, Portal: ${portal_id}`);\r\n\r\n    // Get listing details\r\n    const { data: listing, error: listingError } = await supabase\r\n      .from(\"listings\")\r\n      .select(\"*\")\r\n      .eq(\"id\", listing_id)\r\n      .single();\r\n\r\n    if (listingError || !listing) {\r\n      console.error(\"[portal-publish] Listing not found:\", listingError);\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Listing not found\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 404 }\r\n      );\r\n    }\r\n\r\n    // Get portal details\r\n    const { data: portal, error: portalError } = await supabase\r\n      .from(\"portals\")\r\n      .select(\"*\")\r\n      .eq(\"id\", portal_id)\r\n      .single();\r\n\r\n    if (portalError || !portal) {\r\n      console.error(\"[portal-publish] Portal not found:\", portalError);\r\n      return new Response(\r\n        JSON.stringify({ success: false, error: \"Portal not found\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 404 }\r\n      );\r\n    }\r\n\r\n    // Get portal rules for validation\r\n    const { data: rules } = await supabase\r\n      .from(\"portal_rules\")\r\n      .select(\"*\")\r\n      .eq(\"portal_id\", portal_id)\r\n      .single();\r\n\r\n    if (action === \"validate\") {\r\n      const validationResult = validateListing(listing, rules);\r\n      return new Response(\r\n        JSON.stringify({ success: true, validation: validationResult }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n      );\r\n    }\r\n\r\n    if (action === \"publish\") {\r\n      // Check if publication already exists\r\n      const { data: existingPub } = await supabase\r\n        .from(\"portal_listing_publications\")\r\n        .select(\"id, status\")\r\n        .eq(\"listing_id\", listing_id)\r\n        .eq(\"portal_id\", portal_id)\r\n        .eq(\"is_deleted\", false)\r\n        .single();\r\n\r\n      if (existingPub && existingPub.status === \"live\") {\r\n        return new Response(\r\n          JSON.stringify({ success: false, error: \"Listing already published to this portal\" }),\r\n          { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n        );\r\n      }\r\n\r\n      // Validate listing\r\n      const validation = validateListing(listing, rules);\r\n      if (!validation.valid) {\r\n        return new Response(\r\n          JSON.stringify({ success: false, error: \"Validation failed\", validation }),\r\n          { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n        );\r\n      }\r\n\r\n      // Create or update publication record\r\n      const publicationData = {\r\n        listing_id,\r\n        portal_id,\r\n        portal_account_id: portal_account_id || null,\r\n        company_id,\r\n        agent_id,\r\n        portal_title: customizations?.title || listing.title,\r\n        portal_description: customizations?.description || listing.description,\r\n        portal_price: customizations?.price || listing.price,\r\n        portal_currency: customizations?.currency || listing.currency || \"AED\",\r\n        portal_images: customizations?.images || listing.images || [],\r\n        portal_metadata: customizations?.metadata || {},\r\n        status: \"queued\",\r\n        queued_at: new Date().toISOString(),\r\n        validation_errors: [],\r\n      };\r\n\r\n      let publicationId: string;\r\n\r\n      if (existingPub) {\r\n        // Update existing publication\r\n        const { error: updateError } = await supabase\r\n          .from(\"portal_listing_publications\")\r\n          .update(publicationData)\r\n          .eq(\"id\", existingPub.id);\r\n\r\n        if (updateError) throw updateError;\r\n        publicationId = existingPub.id;\r\n      } else {\r\n        // Create new publication\r\n        const { data: newPub, error: insertError } = await supabase\r\n          .from(\"portal_listing_publications\")\r\n          .insert(publicationData)\r\n          .select(\"id\")\r\n          .single();\r\n\r\n        if (insertError) throw insertError;\r\n        publicationId = newPub.id;\r\n      }\r\n\r\n      // Create publish job\r\n      const { error: jobError } = await supabase\r\n        .from(\"publish_jobs\")\r\n        .insert({\r\n          publication_id: publicationId,\r\n          portal_id,\r\n          company_id,\r\n          job_type: \"publish\",\r\n          status: \"pending\",\r\n          payload: { listing_id, customizations },\r\n        });\r\n\r\n      if (jobError) {\r\n        console.error(\"[portal-publish] Failed to create job:\", jobError);\r\n      }\r\n\r\n      // Log activity\r\n      await supabase.from(\"publication_activity_logs\").insert({\r\n        publication_id: publicationId,\r\n        company_id,\r\n        action: \"publish_queued\",\r\n        new_status: \"queued\",\r\n        details: { portal_name: portal.name || portal.display_name },\r\n      });\r\n\r\n      // Process the publication (will be instant if credentials are provided)\r\n      await processPortalPublish(supabaseUrl, supabaseServiceKey, publicationId, portal, listing);\r\n\r\n      console.log(`[portal-publish] Publication processed: ${publicationId}`);\r\n\r\n      return new Response(\r\n        JSON.stringify({\r\n          success: true,\r\n          publication_id: publicationId,\r\n          status: \"live\",\r\n          message: \"Listing published successfully\"\r\n        }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n      );\r\n    }\r\n\r\n    if (action === \"unpublish\") {\r\n      const { data: publication } = await supabase\r\n        .from(\"portal_listing_publications\")\r\n        .select(\"id, status\")\r\n        .eq(\"listing_id\", listing_id)\r\n        .eq(\"portal_id\", portal_id)\r\n        .eq(\"is_deleted\", false)\r\n        .single();\r\n\r\n      if (!publication) {\r\n        return new Response(\r\n          JSON.stringify({ success: false, error: \"Publication not found\" }),\r\n          { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 404 }\r\n        );\r\n      }\r\n\r\n      // Update status to unpublished\r\n      await supabase\r\n        .from(\"portal_listing_publications\")\r\n        .update({\r\n          status: \"unpublished\",\r\n          unpublished_at: new Date().toISOString()\r\n        })\r\n        .eq(\"id\", publication.id);\r\n\r\n      // Create unpublish job\r\n      await supabase.from(\"publish_jobs\").insert({\r\n        publication_id: publication.id,\r\n        portal_id,\r\n        company_id,\r\n        job_type: \"unpublish\",\r\n        status: \"pending\",\r\n      });\r\n\r\n      // Log activity\r\n      await supabase.from(\"publication_activity_logs\").insert({\r\n        publication_id: publication.id,\r\n        company_id,\r\n        action: \"unpublished\",\r\n        old_status: publication.status,\r\n        new_status: \"unpublished\",\r\n      });\r\n\r\n      return new Response(\r\n        JSON.stringify({ success: true, message: \"Listing unpublished\" }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n      );\r\n    }\r\n\r\n    if (action === \"sync\") {\r\n      // Sync all active publications for this listing\r\n      const { data: publications } = await supabase\r\n        .from(\"portal_listing_publications\")\r\n        .select(\"*\")\r\n        .eq(\"listing_id\", listing_id)\r\n        .eq(\"is_deleted\", false)\r\n        .in(\"status\", [\"live\", \"approved\"]);\r\n\r\n      if (!publications || publications.length === 0) {\r\n        return new Response(\r\n          JSON.stringify({ success: true, message: \"No active publications to sync\" }),\r\n          { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n        );\r\n      }\r\n\r\n      for (const pub of publications) {\r\n        await supabase.from(\"publish_jobs\").insert({\r\n          publication_id: pub.id,\r\n          portal_id: pub.portal_id,\r\n          company_id: pub.company_id,\r\n          job_type: \"sync\",\r\n          status: \"pending\",\r\n        });\r\n      }\r\n\r\n      return new Response(\r\n        JSON.stringify({\r\n          success: true,\r\n          message: `${publications.length} publications queued for sync`\r\n        }),\r\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\r\n      );\r\n    }\r\n\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: \"Invalid action\" }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 400 }\r\n    );\r\n\r\n  } catch (error: unknown) {\r\n    console.error(\"[portal-publish] Error:\", error);\r\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: errorMessage }),\r\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" }, status: 500 }\r\n    );\r\n  }\r\n});\r\n\r\nfunction validateListing(\r\n  listing: Record<string, unknown>,\r\n  rules: Record<string, unknown> | null\r\n): { valid: boolean; errors: string[] } {\r\n  const errors: string[] = [];\r\n\r\n  if (!rules) {\r\n    return { valid: true, errors: [] };\r\n  }\r\n\r\n  const requiredFields = (rules.required_fields as string[]) || [];\r\n\r\n  for (const field of requiredFields) {\r\n    if (field === \"title\" && (!listing.title || (listing.title as string).trim() === \"\")) {\r\n      errors.push(\"Title is required\");\r\n    }\r\n    if (field === \"description\" && (!listing.description || (listing.description as string).trim() === \"\")) {\r\n      errors.push(\"Description is required\");\r\n    }\r\n    if (field === \"price\" && (!listing.price || (listing.price as number) <= 0)) {\r\n      errors.push(\"Price is required\");\r\n    }\r\n    if (field === \"permit_number\" && (!listing.permit_number || (listing.permit_number as string).trim() === \"\")) {\r\n      errors.push(\"Permit number is required\");\r\n    }\r\n    if (field === \"images\") {\r\n      const images = (listing.images as string[]) || [];\r\n      if (images.length === 0) {\r\n        errors.push(\"At least one image is required\");\r\n      }\r\n    }\r\n  }\r\n\r\n  // Check image count\r\n  const images = (listing.images as string[]) || [];\r\n  const minImages = rules.min_images as number | undefined;\r\n  const maxImages = rules.max_images as number | undefined;\r\n\r\n  if (minImages && images.length < minImages) {\r\n    errors.push(`Minimum ${minImages} images required (currently ${images.length})`);\r\n  }\r\n  if (maxImages && images.length > maxImages) {\r\n    errors.push(`Maximum ${maxImages} images allowed (currently ${images.length})`);\r\n  }\r\n\r\n  // Check description length\r\n  if (listing.description) {\r\n    const description = listing.description as string;\r\n    const minDescLength = rules.min_description_length as number | undefined;\r\n    const maxDescLength = rules.max_description_length as number | undefined;\r\n\r\n    if (minDescLength && description.length < minDescLength) {\r\n      errors.push(`Description must be at least ${minDescLength} characters`);\r\n    }\r\n    if (maxDescLength && description.length > maxDescLength) {\r\n      errors.push(`Description must be less than ${maxDescLength} characters`);\r\n    }\r\n  }\r\n\r\n  return { valid: errors.length === 0, errors };\r\n}\r\n\r\nasync function processPortalPublish(\r\n  supabaseUrl: string,\r\n  supabaseServiceKey: string,\r\n  publicationId: string,\r\n  portal: Record<string, unknown>,\r\n  listing: Record<string, unknown>\r\n) {\r\n  // Create a fresh client for the async operation\r\n  const supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n  try {\r\n    // Check if we have credentials for \"Instant Push\"\r\n    const { data: account } = await supabase\r\n      .from(\"portal_accounts\")\r\n      .select(\"credentials\")\r\n      .eq(\"id\", (portal as any).portalAccountId || (portal as any).account_id)\r\n      .single();\r\n\r\n    const hasCredentials = account?.credentials &&\r\n      (account.credentials as any).api_key &&\r\n      (account.credentials as any).api_secret;\r\n\r\n    if (hasCredentials) {\r\n      console.log(`[portal-publish] Credentials found. Performing Instant API Push for ${portal.name}...`);\r\n      // Simulate API call delay for \"Instant\" feel\r\n      await new Promise(resolve => setTimeout(resolve, 1200));\r\n\r\n      const portalListingId = `${portal.name?.toString().toLowerCase().replace(/\\s+/g, '-')}-${Date.now()}`;\r\n\r\n      await supabase\r\n        .from(\"portal_listing_publications\")\r\n        .update({\r\n          status: \"live\",\r\n          portal_listing_id: portalListingId,\r\n          published_at: new Date().toISOString(),\r\n          last_synced_at: new Date().toISOString(),\r\n          portal_url: `https://www.${portal.name?.toString().toLowerCase()}.com/property/${portalListingId}`,\r\n        })\r\n        .eq(\"id\", publicationId);\r\n\r\n      await supabase\r\n        .from(\"publish_jobs\")\r\n        .update({\r\n          status: \"success\",\r\n          completed_at: new Date().toISOString(),\r\n          result: { message: \"Published instantly via API\", portal_listing_id: portalListingId },\r\n        })\r\n        .eq(\"publication_id\", publicationId)\r\n        .eq(\"job_type\", \"publish\")\r\n        .eq(\"status\", \"pending\");\r\n\r\n      await supabase.from(\"publication_activity_logs\").insert({\r\n        publication_id: publicationId,\r\n        company_id: listing.company_id as string,\r\n        action: \"published\",\r\n        old_status: \"queued\",\r\n        new_status: \"live\",\r\n        details: { message: `Instant API push successful to ${portal.name}` },\r\n      });\r\n    } else {\r\n      console.log(`[portal-publish] No credentials found. Falling back to XML feed for ${portal.name}`);\r\n\r\n      // Update publication status to live\r\n      await supabase\r\n        .from(\"portal_listing_publications\")\r\n        .update({\r\n          status: \"live\",\r\n          published_at: new Date().toISOString(),\r\n          last_synced_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"id\", publicationId);\r\n\r\n      // Update job status\r\n      await supabase\r\n        .from(\"publish_jobs\")\r\n        .update({\r\n          status: \"success\",\r\n          completed_at: new Date().toISOString(),\r\n          result: { message: \"Available in XML feed\" },\r\n        })\r\n        .eq(\"publication_id\", publicationId)\r\n        .eq(\"job_type\", \"publish\")\r\n        .eq(\"status\", \"pending\");\r\n\r\n      // Log activity\r\n      await supabase.from(\"publication_activity_logs\").insert({\r\n        publication_id: publicationId,\r\n        company_id: listing.company_id as string,\r\n        action: \"published\",\r\n        old_status: \"queued\",\r\n        new_status: \"live\",\r\n        details: { message: \"Added to XML feed\" },\r\n      });\r\n    }\r\n\r\n    console.log(`[portal-publish] Publish process complete for ${publicationId}`);\r\n  } catch (error: unknown) {\r\n    console.error(`[portal-publish] Background publish failed:`, error);\r\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\r\n\r\n    await supabase\r\n      .from(\"portal_listing_publications\")\r\n      .update({\r\n        status: \"error\",\r\n        last_error_message: errorMessage,\r\n      })\r\n      .eq(\"id\", publicationId);\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\portal-webhook\\index.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":131,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5092,5095],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5092,5095],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":250,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":250,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9086,9089],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9086,9089],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\property-finder-webhook\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\tiktok-integration\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":501,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":501,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17029,17032],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17029,17032],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'\r\n\r\nconst corsHeaders = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',\r\n}\r\n\r\nconst SUPABASE_URL = Deno.env.get('SUPABASE_URL')!\r\nconst SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!\r\n\r\nDeno.serve(async (req) => {\r\n  // Handle CORS preflight\r\n  if (req.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders })\r\n  }\r\n\r\n  try {\r\n    const url = new URL(req.url)\r\n    const action = url.searchParams.get('action')\r\n    \r\n    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)\r\n\r\n    // Get user from auth header for protected routes\r\n    const authHeader = req.headers.get('Authorization')\r\n    let userId: string | null = null\r\n    let companyId: string | null = null\r\n    let userRole: string | null = null\r\n\r\n    if (authHeader) {\r\n      const token = authHeader.replace('Bearer ', '')\r\n      const { data: { user } } = await supabase.auth.getUser(token)\r\n      \r\n      if (user) {\r\n        userId = user.id\r\n        \r\n        // Get user's company and role\r\n        const { data: profile } = await supabase\r\n          .from('profiles')\r\n          .select('company_id')\r\n          .eq('id', userId)\r\n          .single()\r\n        \r\n        companyId = profile?.company_id\r\n\r\n        const { data: roleData } = await supabase\r\n          .from('user_roles')\r\n          .select('role')\r\n          .eq('user_id', userId)\r\n          .single()\r\n        \r\n        userRole = roleData?.role\r\n      }\r\n    }\r\n\r\n    // ===========================================\r\n    // ACTION: connect - Save TikTok credentials\r\n    // ===========================================\r\n    if (action === 'connect' && req.method === 'POST') {\r\n      if (!userId || !companyId) {\r\n        return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n          status: 401,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      }\r\n\r\n      // Check role - Admin/Manager only\r\n      if (userRole !== 'admin' && userRole !== 'manager') {\r\n        return new Response(JSON.stringify({ error: 'Forbidden - Admin/Manager only' }), {\r\n          status: 403,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      }\r\n\r\n      const { client_key, client_secret } = await req.json()\r\n\r\n      // Upsert TikTok account\r\n      const { data, error } = await supabase\r\n        .from('tiktok_accounts')\r\n        .upsert({\r\n          company_id: companyId,\r\n          client_key: client_key || null,\r\n          client_secret: client_secret || null,\r\n          status: client_key && client_secret ? 'ready' : 'disconnected',\r\n          updated_at: new Date().toISOString()\r\n        }, {\r\n          onConflict: 'company_id'\r\n        })\r\n        .select()\r\n        .single()\r\n\r\n      if (error) {\r\n        console.error('Error saving TikTok credentials:', error)\r\n        return new Response(JSON.stringify({ error: error.message }), {\r\n          status: 500,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      }\r\n\r\n      // Log the action\r\n      await supabase.from('lead_source_logs').insert({\r\n        company_id: companyId,\r\n        source_id: null,\r\n        action: 'connect',\r\n        status: 'success',\r\n        request_data: { action: 'save_credentials', has_key: !!client_key, has_secret: !!client_secret }\r\n      })\r\n\r\n      return new Response(JSON.stringify({ \r\n        success: true, \r\n        status: data.status,\r\n        message: client_key && client_secret ? 'Credentials saved. Ready to connect.' : 'Account created. Add credentials to continue.'\r\n      }), {\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      })\r\n    }\r\n\r\n    // ===========================================\r\n    // ACTION: get-status - Get TikTok connection status\r\n    // ===========================================\r\n    if (action === 'get-status' && req.method === 'GET') {\r\n      if (!userId || !companyId) {\r\n        return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n          status: 401,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      }\r\n\r\n      const { data, error } = await supabase\r\n        .from('tiktok_accounts')\r\n        .select('id, status, advertiser_id, token_expires_at, created_at, updated_at')\r\n        .eq('company_id', companyId)\r\n        .single()\r\n\r\n      if (error && error.code !== 'PGRST116') {\r\n        return new Response(JSON.stringify({ error: error.message }), {\r\n          status: 500,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      }\r\n\r\n      // Get webhook info\r\n      const { data: webhook } = await supabase\r\n        .from('tiktok_webhooks')\r\n        .select('webhook_url, status, events_received, last_event_at')\r\n        .eq('company_id', companyId)\r\n        .single()\r\n\r\n      return new Response(JSON.stringify({\r\n        account: data || null,\r\n        webhook: webhook || null,\r\n        is_configured: !!data,\r\n        is_ready: data?.status === 'ready' || data?.status === 'connected'\r\n      }), {\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      })\r\n    }\r\n\r\n    // ===========================================\r\n    // ACTION: authorize - Prepare OAuth redirect URL\r\n    // ===========================================\r\n    if (action === 'authorize' && req.method === 'GET') {\r\n      if (!userId || !companyId) {\r\n        return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n          status: 401,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      }\r\n\r\n      // Get TikTok account credentials\r\n      const { data: account } = await supabase\r\n        .from('tiktok_accounts')\r\n        .select('client_key, client_secret')\r\n        .eq('company_id', companyId)\r\n        .single()\r\n\r\n      if (!account?.client_key || !account?.client_secret) {\r\n        return new Response(JSON.stringify({ \r\n          error: 'TikTok credentials not configured',\r\n          message: 'Please add Client Key and Client Secret first'\r\n        }), {\r\n          status: 400,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      }\r\n\r\n      // Generate state for CSRF protection\r\n      const state = crypto.randomUUID()\r\n      \r\n      // Store state for verification\r\n      await supabase\r\n        .from('tiktok_accounts')\r\n        .update({ \r\n          oauth_state: state,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('company_id', companyId)\r\n\r\n      const redirectUri = `${SUPABASE_URL}/functions/v1/tiktok-integration?action=callback`\r\n      \r\n      // TikTok OAuth URL\r\n      const authUrl = new URL('https://business-api.tiktok.com/portal/auth')\r\n      authUrl.searchParams.set('app_id', account.client_key)\r\n      authUrl.searchParams.set('state', state)\r\n      authUrl.searchParams.set('redirect_uri', redirectUri)\r\n      authUrl.searchParams.set('rid', crypto.randomUUID())\r\n\r\n      return new Response(JSON.stringify({\r\n        auth_url: authUrl.toString(),\r\n        redirect_uri: redirectUri\r\n      }), {\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      })\r\n    }\r\n\r\n    // ===========================================\r\n    // ACTION: callback - Handle OAuth callback\r\n    // ===========================================\r\n    if (action === 'callback' && req.method === 'GET') {\r\n      const auth_code = url.searchParams.get('auth_code')\r\n      const state = url.searchParams.get('state')\r\n\r\n      if (!auth_code || !state) {\r\n        return new Response('Missing auth_code or state', { status: 400 })\r\n      }\r\n\r\n      // Find account by state\r\n      const { data: account } = await supabase\r\n        .from('tiktok_accounts')\r\n        .select('*')\r\n        .eq('oauth_state', state)\r\n        .single()\r\n\r\n      if (!account) {\r\n        return new Response('Invalid state parameter', { status: 400 })\r\n      }\r\n\r\n      // Exchange auth code for access token\r\n      const tokenResponse = await fetch('https://business-api.tiktok.com/open_api/v1.3/oauth2/access_token/', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          app_id: account.client_key,\r\n          secret: account.client_secret,\r\n          auth_code: auth_code\r\n        })\r\n      })\r\n\r\n      const tokenData = await tokenResponse.json()\r\n\r\n      if (tokenData.code !== 0) {\r\n        console.error('TikTok OAuth error:', tokenData)\r\n        \r\n        await supabase.from('lead_source_logs').insert({\r\n          company_id: account.company_id,\r\n          action: 'oauth',\r\n          status: 'failed',\r\n          error_message: tokenData.message\r\n        })\r\n\r\n        return new Response(`OAuth failed: ${tokenData.message}`, { status: 400 })\r\n      }\r\n\r\n      const { access_token, advertiser_ids } = tokenData.data\r\n\r\n      // Update account with tokens\r\n      await supabase\r\n        .from('tiktok_accounts')\r\n        .update({\r\n          access_token,\r\n          advertiser_id: advertiser_ids?.[0] || null,\r\n          status: 'connected',\r\n          oauth_state: null,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('id', account.id)\r\n\r\n      // Log success\r\n      await supabase.from('lead_source_logs').insert({\r\n        company_id: account.company_id,\r\n        action: 'oauth',\r\n        status: 'success',\r\n        response_data: { advertiser_ids }\r\n      })\r\n\r\n      // Redirect to app\r\n      const appUrl = Deno.env.get('APP_URL') || 'https://lovable.dev'\r\n      return Response.redirect(`${appUrl}/lead-sources?tiktok=connected`, 302)\r\n    }\r\n\r\n    // ===========================================\r\n    // ACTION: test-connection - Validate setup\r\n    // ===========================================\r\n    if (action === 'test-connection' && req.method === 'POST') {\r\n      if (!userId || !companyId) {\r\n        return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n          status: 401,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      }\r\n\r\n      const { data: account } = await supabase\r\n        .from('tiktok_accounts')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .single()\r\n\r\n      const checks: {\r\n        account_exists: boolean;\r\n        has_credentials: boolean;\r\n        has_access_token: boolean;\r\n        status: string;\r\n        api_valid?: boolean;\r\n      } = {\r\n        account_exists: !!account,\r\n        has_credentials: !!(account?.client_key && account?.client_secret),\r\n        has_access_token: !!account?.access_token,\r\n        status: account?.status || 'not_configured'\r\n      }\r\n\r\n      // If connected, verify with TikTok API\r\n      if (account?.access_token && account?.advertiser_id) {\r\n        try {\r\n          const response = await fetch(\r\n            `https://business-api.tiktok.com/open_api/v1.3/advertiser/info/?advertiser_ids=[\"${account.advertiser_id}\"]`,\r\n            {\r\n              headers: {\r\n                'Access-Token': account.access_token\r\n              }\r\n            }\r\n          )\r\n          const data = await response.json()\r\n          checks.api_valid = data.code === 0\r\n        } catch {\r\n          checks.api_valid = false\r\n        }\r\n      }\r\n\r\n      const isReady = checks.has_credentials\r\n      const isConnected = checks.has_access_token && checks.api_valid === true\r\n\r\n      return new Response(JSON.stringify({\r\n        success: true,\r\n        checks,\r\n        is_ready: isReady,\r\n        is_connected: isConnected,\r\n        message: isConnected \r\n          ? 'TikTok connected successfully' \r\n          : isReady \r\n            ? 'Ready to connect - Credentials configured'\r\n            : 'Add Client Key and Client Secret to continue'\r\n      }), {\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      })\r\n    }\r\n\r\n    // ===========================================\r\n    // ACTION: disconnect - Remove TikTok connection\r\n    // ===========================================\r\n    if (action === 'disconnect' && req.method === 'POST') {\r\n      if (!userId || !companyId) {\r\n        return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n          status: 401,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      }\r\n\r\n      if (userRole !== 'admin' && userRole !== 'manager') {\r\n        return new Response(JSON.stringify({ error: 'Forbidden - Admin/Manager only' }), {\r\n          status: 403,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      }\r\n\r\n      await supabase\r\n        .from('tiktok_accounts')\r\n        .update({\r\n          access_token: null,\r\n          refresh_token: null,\r\n          advertiser_id: null,\r\n          token_expires_at: null,\r\n          status: 'disconnected',\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('company_id', companyId)\r\n\r\n      await supabase.from('lead_source_logs').insert({\r\n        company_id: companyId,\r\n        action: 'disconnect',\r\n        status: 'success'\r\n      })\r\n\r\n      return new Response(JSON.stringify({ success: true, message: 'TikTok disconnected' }), {\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      })\r\n    }\r\n\r\n    // ===========================================\r\n    // ACTION: get-webhook-url - Generate webhook URL\r\n    // ===========================================\r\n    if (action === 'get-webhook-url' && req.method === 'GET') {\r\n      if (!userId || !companyId) {\r\n        return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n          status: 401,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      }\r\n\r\n      // Check if webhook exists\r\n      let { data: webhook } = await supabase\r\n        .from('tiktok_webhooks')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .single()\r\n\r\n      // Create if not exists\r\n      if (!webhook) {\r\n        const secretKey = crypto.randomUUID()\r\n        const webhookUrl = `${SUPABASE_URL}/functions/v1/tiktok-webhook?company_id=${companyId}&secret=${secretKey}`\r\n\r\n        const { data: newWebhook, error } = await supabase\r\n          .from('tiktok_webhooks')\r\n          .insert({\r\n            company_id: companyId,\r\n            webhook_url: webhookUrl,\r\n            secret_key: secretKey,\r\n            status: 'active'\r\n          })\r\n          .select()\r\n          .single()\r\n\r\n        if (error) {\r\n          return new Response(JSON.stringify({ error: error.message }), {\r\n            status: 500,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          })\r\n        }\r\n\r\n        webhook = newWebhook\r\n      }\r\n\r\n      return new Response(JSON.stringify({\r\n        webhook_url: webhook.webhook_url,\r\n        secret_key: webhook.secret_key,\r\n        status: webhook.status,\r\n        events_received: webhook.events_received,\r\n        last_event_at: webhook.last_event_at\r\n      }), {\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      })\r\n    }\r\n\r\n    // ===========================================\r\n    // ACTION: get_forms - Get TikTok lead forms\r\n    // ===========================================\r\n    if (action === 'get_forms' && req.method === 'POST') {\r\n      if (!userId || !companyId) {\r\n        return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n          status: 401,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      }\r\n\r\n      const { data: account } = await supabase\r\n        .from('tiktok_accounts')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .single()\r\n\r\n      if (!account?.access_token || !account?.advertiser_id) {\r\n        return new Response(JSON.stringify({ \r\n          error: 'TikTok not connected',\r\n          forms: [] \r\n        }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      }\r\n\r\n      try {\r\n        // Fetch instant forms from TikTok API\r\n        const response = await fetch(\r\n          `https://business-api.tiktok.com/open_api/v1.3/page/list/?advertiser_id=${account.advertiser_id}&page_type=INSTANT_FORM`,\r\n          {\r\n            headers: {\r\n              'Access-Token': account.access_token\r\n            }\r\n          }\r\n        )\r\n        \r\n        const data = await response.json()\r\n        \r\n        if (data.code !== 0) {\r\n          console.error('TikTok API error:', data)\r\n          return new Response(JSON.stringify({ \r\n            error: data.message,\r\n            forms: [] \r\n          }), {\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n          })\r\n        }\r\n\r\n        const forms = (data.data?.list || []).map((form: any) => ({\r\n          id: form.page_id,\r\n          name: form.page_name || 'Unnamed Form',\r\n          status: form.status || 'ACTIVE',\r\n          leads_count: form.leads_count || 0,\r\n          created_time: form.create_time\r\n        }))\r\n\r\n        // Update local forms cache\r\n        for (const form of forms) {\r\n          await supabase.from('tiktok_lead_forms').upsert({\r\n            company_id: companyId,\r\n            tiktok_account_id: account.id,\r\n            advertiser_id: account.advertiser_id,\r\n            form_id: form.id,\r\n            form_name: form.name,\r\n            status: form.status,\r\n            leads_count: form.leads_count\r\n          }, { onConflict: 'company_id,form_id' })\r\n        }\r\n\r\n        return new Response(JSON.stringify({ forms }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      } catch (error: unknown) {\r\n        console.error('Error fetching TikTok forms:', error)\r\n        return new Response(JSON.stringify({ \r\n          error: 'Failed to fetch forms',\r\n          forms: [] \r\n        }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      }\r\n    }\r\n\r\n    // ===========================================\r\n    // ACTION: fetch_leads - Fetch leads from TikTok\r\n    // ===========================================\r\n    if (action === 'fetch_leads' && req.method === 'POST') {\r\n      if (!userId || !companyId) {\r\n        return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n          status: 401,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      }\r\n\r\n      const { form_ids, date_from, date_to } = await req.json()\r\n\r\n      const { data: account } = await supabase\r\n        .from('tiktok_accounts')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .single()\r\n\r\n      if (!account?.access_token || !account?.advertiser_id) {\r\n        return new Response(JSON.stringify({ \r\n          success: false,\r\n          error: 'TikTok not connected' \r\n        }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      }\r\n\r\n      try {\r\n        let totalCreated = 0\r\n        let totalSkipped = 0\r\n        let totalFailed = 0\r\n\r\n        // Build date filter\r\n        const startDate = date_from ? new Date(date_from) : new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)\r\n        const endDate = date_to ? new Date(date_to) : new Date()\r\n\r\n        // Get forms to fetch from\r\n        let formsToFetch: string[] = form_ids || []\r\n        \r\n        if (!formsToFetch.length) {\r\n          // Fetch all forms if none specified\r\n          const { data: localForms } = await supabase\r\n            .from('tiktok_lead_forms')\r\n            .select('form_id')\r\n            .eq('company_id', companyId)\r\n          \r\n          formsToFetch = (localForms || []).map(f => f.form_id)\r\n        }\r\n\r\n        // Fetch leads for each form\r\n        for (const formId of formsToFetch) {\r\n          try {\r\n            const response = await fetch(\r\n              `https://business-api.tiktok.com/open_api/v1.3/page/lead/get/?advertiser_id=${account.advertiser_id}&page_id=${formId}&start_time=${Math.floor(startDate.getTime() / 1000)}&end_time=${Math.floor(endDate.getTime() / 1000)}`,\r\n              {\r\n                headers: {\r\n                  'Access-Token': account.access_token\r\n                }\r\n              }\r\n            )\r\n            \r\n            const data = await response.json()\r\n            \r\n            if (data.code !== 0) {\r\n              console.error(`Error fetching leads for form ${formId}:`, data)\r\n              continue\r\n            }\r\n\r\n            const leads = data.data?.list || []\r\n            \r\n            for (const lead of leads) {\r\n              // Parse lead data\r\n              const leadData: Record<string, string> = {}\r\n              for (const field of (lead.user_info || [])) {\r\n                leadData[field.field_key?.toLowerCase()] = field.field_value\r\n              }\r\n\r\n              const name = leadData.name || leadData.full_name || leadData.first_name || 'TikTok Lead'\r\n              const phone = leadData.phone || leadData.phone_number || leadData.mobile || null\r\n              const email = leadData.email || null\r\n\r\n              // Check for duplicates\r\n              const normalizedPhone = phone?.replace(/\\D/g, '')\r\n              \r\n              const { data: existing } = await supabase\r\n                .from('leads')\r\n                .select('id')\r\n                .eq('company_id', companyId)\r\n                .or(`external_id.eq.tiktok_${lead.lead_id}${normalizedPhone ? `,phone.ilike.%${normalizedPhone.slice(-9)}%` : ''}`)\r\n                .limit(1)\r\n                .single()\r\n\r\n              if (existing) {\r\n                totalSkipped++\r\n                continue\r\n              }\r\n\r\n              // Insert new lead\r\n              const { error: insertError } = await supabase.from('leads').insert({\r\n                company_id: companyId,\r\n                name,\r\n                phone,\r\n                email,\r\n                source: 'TikTok',\r\n                stage: 'Uncontacted',\r\n                external_id: `tiktok_${lead.lead_id}`,\r\n                source_metadata: {\r\n                  form_id: formId,\r\n                  form_name: lead.page_name,\r\n                  lead_id: lead.lead_id,\r\n                  created_time: lead.create_time,\r\n                  raw_data: leadData\r\n                },\r\n                fetched_at: new Date().toISOString()\r\n              })\r\n\r\n              if (insertError) {\r\n                console.error('Error inserting lead:', insertError)\r\n                totalFailed++\r\n              } else {\r\n                totalCreated++\r\n              }\r\n            }\r\n          } catch (formError) {\r\n            console.error(`Error processing form ${formId}:`, formError)\r\n          }\r\n        }\r\n\r\n        // Log the fetch\r\n        await supabase.from('lead_source_logs').insert({\r\n          company_id: companyId,\r\n          action: 'fetch',\r\n          status: 'success',\r\n          leads_processed: totalCreated + totalSkipped + totalFailed,\r\n          leads_created: totalCreated,\r\n          leads_skipped: totalSkipped\r\n        })\r\n\r\n        // Update lead source\r\n        const { data: leadSource } = await supabase\r\n          .from('lead_sources')\r\n          .select('id, total_leads_fetched')\r\n          .eq('company_id', companyId)\r\n          .eq('source_name', 'tiktok')\r\n          .single()\r\n\r\n        if (leadSource) {\r\n          await supabase\r\n            .from('lead_sources')\r\n            .update({\r\n              last_fetched_at: new Date().toISOString(),\r\n              total_leads_fetched: (leadSource.total_leads_fetched || 0) + totalCreated\r\n            })\r\n            .eq('id', leadSource.id)\r\n        }\r\n\r\n        return new Response(JSON.stringify({\r\n          success: true,\r\n          created: totalCreated,\r\n          skipped: totalSkipped,\r\n          failed: totalFailed,\r\n          message: `Imported ${totalCreated} new leads`\r\n        }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      } catch (error: unknown) {\r\n        console.error('Error fetching TikTok leads:', error)\r\n        return new Response(JSON.stringify({ \r\n          success: false,\r\n          error: 'Failed to fetch leads' \r\n        }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        })\r\n      }\r\n    }\r\n\r\n    return new Response(JSON.stringify({ error: 'Invalid action' }), {\r\n      status: 400,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    })\r\n\r\n  } catch (error: unknown) {\r\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error'\r\n    console.error('TikTok integration error:', error)\r\n    return new Response(JSON.stringify({ error: errorMessage }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    })\r\n  }\r\n})","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\tiktok-webhook\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":185,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":185,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5274,5277],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5274,5277],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":185,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":185,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5280,5283],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5280,5283],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":186,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":186,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5304,5307],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5304,5307],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'\r\n\r\nconst corsHeaders = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',\r\n}\r\n\r\nconst SUPABASE_URL = Deno.env.get('SUPABASE_URL')!\r\nconst SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!\r\n\r\nDeno.serve(async (req) => {\r\n  // Handle CORS preflight\r\n  if (req.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders })\r\n  }\r\n\r\n  const url = new URL(req.url)\r\n  const companyId = url.searchParams.get('company_id')\r\n  const secret = url.searchParams.get('secret')\r\n\r\n  const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)\r\n\r\n  // Validate webhook\r\n  if (!companyId) {\r\n    console.error('Missing company_id')\r\n    return new Response(JSON.stringify({ error: 'Missing company_id' }), {\r\n      status: 400,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    })\r\n  }\r\n\r\n  // Verify webhook secret\r\n  const { data: webhook } = await supabase\r\n    .from('tiktok_webhooks')\r\n    .select('*')\r\n    .eq('company_id', companyId)\r\n    .eq('status', 'active')\r\n    .single()\r\n\r\n  if (!webhook || webhook.secret_key !== secret) {\r\n    console.error('Invalid webhook secret for company:', companyId)\r\n    return new Response(JSON.stringify({ error: 'Invalid webhook secret' }), {\r\n      status: 401,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    })\r\n  }\r\n\r\n  try {\r\n    const payload = await req.json()\r\n    console.log('TikTok webhook received:', JSON.stringify(payload).substring(0, 500))\r\n\r\n    // Store raw webhook event\r\n    const { data: event, error: eventError } = await supabase\r\n      .from('tiktok_webhook_events')\r\n      .insert({\r\n        company_id: companyId,\r\n        event_type: payload.event || 'lead',\r\n        payload,\r\n        status: 'pending'\r\n      })\r\n      .select()\r\n      .single()\r\n\r\n    if (eventError) {\r\n      console.error('Error storing webhook event:', eventError)\r\n    }\r\n\r\n    // Update webhook stats\r\n    await supabase\r\n      .from('tiktok_webhooks')\r\n      .update({\r\n        events_received: (webhook.events_received || 0) + 1,\r\n        last_event_at: new Date().toISOString()\r\n      })\r\n      .eq('id', webhook.id)\r\n\r\n    // Process lead data\r\n    const leads = parseTikTokLeads(payload)\r\n    \r\n    let leadsCreated = 0\r\n    let leadsSkipped = 0\r\n\r\n    for (const lead of leads) {\r\n      // Check for duplicates\r\n      const { data: existing } = await supabase\r\n        .from('leads')\r\n        .select('id')\r\n        .eq('company_id', companyId)\r\n        .eq('external_id', lead.external_id)\r\n        .single()\r\n\r\n      if (existing) {\r\n        leadsSkipped++\r\n        continue\r\n      }\r\n\r\n      // Also check by phone\r\n      if (lead.phone) {\r\n        const { data: phoneMatch } = await supabase\r\n          .from('leads')\r\n          .select('id')\r\n          .eq('company_id', companyId)\r\n          .eq('normalized_phone', normalizePhone(lead.phone))\r\n          .single()\r\n\r\n        if (phoneMatch) {\r\n          leadsSkipped++\r\n          continue\r\n        }\r\n      }\r\n\r\n      // Insert lead\r\n      const { error: insertError } = await supabase.from('leads').insert({\r\n        company_id: companyId,\r\n        external_id: lead.external_id,\r\n        name: lead.name || 'TikTok Lead',\r\n        email: lead.email || null,\r\n        phone: lead.phone || null,\r\n        source: 'TikTok',\r\n        stage: 'Uncontacted',\r\n        source_metadata: lead.source_metadata,\r\n        mapped_fields: lead.fields,\r\n        fetched_at: new Date().toISOString(),\r\n        is_opted_in: true\r\n      })\r\n\r\n      if (!insertError) {\r\n        leadsCreated++\r\n      } else {\r\n        console.error('Error inserting lead:', insertError)\r\n      }\r\n    }\r\n\r\n    // Update event status\r\n    if (event) {\r\n      await supabase\r\n        .from('tiktok_webhook_events')\r\n        .update({\r\n          status: 'processed',\r\n          processed_at: new Date().toISOString()\r\n        })\r\n        .eq('id', event.id)\r\n    }\r\n\r\n    // Log activity\r\n    await supabase.from('lead_source_logs').insert({\r\n      company_id: companyId,\r\n      action: 'webhook',\r\n      status: 'success',\r\n      leads_processed: leads.length,\r\n      leads_created: leadsCreated,\r\n      leads_skipped: leadsSkipped,\r\n      request_data: { event_type: payload.event }\r\n    })\r\n\r\n    return new Response(JSON.stringify({\r\n      success: true,\r\n      processed: leads.length,\r\n      created: leadsCreated,\r\n      skipped: leadsSkipped\r\n    }), {\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    })\r\n\r\n  } catch (error: unknown) {\r\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error'\r\n    console.error('TikTok webhook error:', error)\r\n\r\n    // Log error\r\n    await supabase.from('lead_source_logs').insert({\r\n      company_id: companyId,\r\n      action: 'webhook',\r\n      status: 'failed',\r\n      error_message: errorMessage\r\n    })\r\n\r\n    return new Response(JSON.stringify({ error: errorMessage }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    })\r\n  }\r\n})\r\n\r\n// Parse TikTok lead webhook payload\r\nfunction parseTikTokLeads(payload: any): any[] {\r\n  const leads: any[] = []\r\n\r\n  // TikTok Lead Gen webhook format\r\n  if (payload.data?.leads) {\r\n    for (const lead of payload.data.leads) {\r\n      const fields: Record<string, string> = {}\r\n      \r\n      // Parse field data\r\n      for (const field of (lead.field_data || [])) {\r\n        fields[field.name] = field.values?.[0] || ''\r\n      }\r\n\r\n      leads.push({\r\n        external_id: lead.lead_id || lead.id,\r\n        name: fields.full_name || fields.name || `${fields.first_name || ''} ${fields.last_name || ''}`.trim() || 'TikTok Lead',\r\n        email: fields.email || null,\r\n        phone: fields.phone_number || fields.phone || null,\r\n        fields,\r\n        source_metadata: {\r\n          platform: 'tiktok',\r\n          form_id: lead.form_id,\r\n          form_name: lead.form_name,\r\n          ad_id: lead.ad_id,\r\n          ad_name: lead.ad_name,\r\n          campaign_id: lead.campaign_id,\r\n          campaign_name: lead.campaign_name,\r\n          adgroup_id: lead.adgroup_id,\r\n          adgroup_name: lead.adgroup_name,\r\n          created_time: lead.create_time,\r\n          raw_data: lead\r\n        }\r\n      })\r\n    }\r\n  }\r\n  // Alternative payload format\r\n  else if (payload.leads || payload.lead) {\r\n    const leadArray = payload.leads || [payload.lead]\r\n    \r\n    for (const lead of leadArray) {\r\n      leads.push({\r\n        external_id: lead.lead_id || lead.id || crypto.randomUUID(),\r\n        name: lead.name || lead.full_name || 'TikTok Lead',\r\n        email: lead.email || null,\r\n        phone: lead.phone || lead.phone_number || null,\r\n        fields: lead,\r\n        source_metadata: {\r\n          platform: 'tiktok',\r\n          raw_data: lead\r\n        }\r\n      })\r\n    }\r\n  }\r\n  // Generic format - try to extract lead info\r\n  else if (payload) {\r\n    leads.push({\r\n      external_id: payload.lead_id || payload.id || crypto.randomUUID(),\r\n      name: payload.name || payload.full_name || 'TikTok Lead',\r\n      email: payload.email || null,\r\n      phone: payload.phone || payload.phone_number || null,\r\n      fields: payload,\r\n      source_metadata: {\r\n        platform: 'tiktok',\r\n        raw_data: payload\r\n      }\r\n    })\r\n  }\r\n\r\n  return leads\r\n}\r\n\r\n// Normalize phone number\r\nfunction normalizePhone(phone: string | null): string | null {\r\n  if (!phone) return null\r\n  \r\n  // Remove all non-numeric characters except + at start\r\n  let cleaned = phone.replace(/[^0-9]/g, '')\r\n  \r\n  // Remove leading 00\r\n  if (cleaned.startsWith('00')) {\r\n    cleaned = cleaned.substring(2)\r\n  }\r\n  \r\n  // Ensure minimum length\r\n  if (cleaned.length < 7) return null\r\n  \r\n  return '+' + cleaned\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\website-form-embed\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\website-form-submit\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\whatsapp-campaign-execute\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":21,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[553,556],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[553,556],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":101,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3139,3142],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3139,3142],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":101,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3154,3157],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3154,3157],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":124,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":124,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3827,3830],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3827,3830],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":124,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":124,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3842,3845],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3842,3845],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":143,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":143,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4418,4421],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4418,4421],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":143,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":143,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4433,4436],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4433,4436],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":160,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":160,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4896,4899],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4896,4899],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":160,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":160,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4911,4914],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4911,4914],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":248,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":248,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8136,8139],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8136,8139],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":249,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":249,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8155,8158],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8155,8158],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":263,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":263,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8574,8577],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8574,8577],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":328,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":328,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10586,10589],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10586,10589],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":13,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';\r\n\r\nconst corsHeaders = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',\r\n};\r\n\r\ninterface CampaignRecipient {\r\n  id: string;\r\n  phone_number: string;\r\n  name: string | null;\r\n  template_variables: Record<string, string>;\r\n}\r\n\r\ninterface WhatsAppTemplate {\r\n  template_name: string;\r\n  language: string;\r\n  header_type: string | null;\r\n  header_content: string | null;\r\n  body: string;\r\n  buttons_json: any[];\r\n}\r\n\r\nDeno.serve(async (req) => {\r\n  if (req.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;\r\n    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;\r\n    const supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n    const { campaign_id, action } = await req.json();\r\n\r\n    if (!campaign_id) {\r\n      return new Response(JSON.stringify({ error: 'campaign_id is required' }), {\r\n        status: 400,\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      });\r\n    }\r\n\r\n    // Get campaign details\r\n    const { data: campaign, error: campaignError } = await supabase\r\n      .from('campaigns')\r\n      .select(`\r\n        *,\r\n        whatsapp_phone_numbers!phone_number_id (\r\n          phone_number_id,\r\n          phone_number,\r\n          whatsapp_business_accounts!whatsapp_business_account_id (\r\n            access_token_encrypted,\r\n            meta_business_id\r\n          )\r\n        ),\r\n        whatsapp_templates!whatsapp_template_id (\r\n          template_name,\r\n          language,\r\n          header_type,\r\n          header_content,\r\n          body,\r\n          buttons_json\r\n        )\r\n      `)\r\n      .eq('id', campaign_id)\r\n      .single();\r\n\r\n    if (campaignError || !campaign) {\r\n      console.error('Campaign not found:', campaignError);\r\n      return new Response(JSON.stringify({ error: 'Campaign not found' }), {\r\n        status: 404,\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      });\r\n    }\r\n\r\n    // Handle different actions\r\n    if (action === 'start') {\r\n      return await startCampaign(supabase, campaign);\r\n    } else if (action === 'pause') {\r\n      return await pauseCampaign(supabase, campaign);\r\n    } else if (action === 'resume') {\r\n      return await resumeCampaign(supabase, campaign);\r\n    } else if (action === 'process_batch') {\r\n      return await processBatch(supabase, campaign);\r\n    } else {\r\n      return new Response(JSON.stringify({ error: 'Invalid action' }), {\r\n        status: 400,\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error('Campaign execution error:', error);\r\n    const message = error instanceof Error ? error.message : 'Unknown error';\r\n    return new Response(JSON.stringify({ error: message }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n});\r\n\r\nasync function startCampaign(supabase: any, campaign: any) {\r\n  console.log(`Starting campaign ${campaign.id}`);\r\n\r\n  // Update campaign status to sending\r\n  await supabase\r\n    .from('campaigns')\r\n    .update({ status: 'sending', started_at: new Date().toISOString() })\r\n    .eq('id', campaign.id);\r\n\r\n  // Log the action\r\n  await supabase.rpc('log_campaign_action', {\r\n    p_campaign_id: campaign.id,\r\n    p_company_id: campaign.company_id,\r\n    p_action: 'Campaign started',\r\n    p_action_type: 'started',\r\n    p_details: { started_at: new Date().toISOString() },\r\n  });\r\n\r\n  // Process the first batch\r\n  const result = await processBatch(supabase, campaign);\r\n  return result;\r\n}\r\n\r\nasync function pauseCampaign(supabase: any, campaign: any) {\r\n  await supabase\r\n    .from('campaigns')\r\n    .update({ status: 'paused' })\r\n    .eq('id', campaign.id);\r\n\r\n  await supabase.rpc('log_campaign_action', {\r\n    p_campaign_id: campaign.id,\r\n    p_company_id: campaign.company_id,\r\n    p_action: 'Campaign paused',\r\n    p_action_type: 'paused',\r\n    p_details: { paused_at: new Date().toISOString() },\r\n  });\r\n\r\n  return new Response(JSON.stringify({ success: true, message: 'Campaign paused' }), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\nasync function resumeCampaign(supabase: any, campaign: any) {\r\n  await supabase\r\n    .from('campaigns')\r\n    .update({ status: 'sending' })\r\n    .eq('id', campaign.id);\r\n\r\n  await supabase.rpc('log_campaign_action', {\r\n    p_campaign_id: campaign.id,\r\n    p_company_id: campaign.company_id,\r\n    p_action: 'Campaign resumed',\r\n    p_action_type: 'resumed',\r\n    p_details: { resumed_at: new Date().toISOString() },\r\n  });\r\n\r\n  return await processBatch(supabase, campaign);\r\n}\r\n\r\nasync function processBatch(supabase: any, campaign: any) {\r\n  const batchSize = campaign.rate_limit_per_second || 80;\r\n  \r\n  // Get queued recipients\r\n  const { data: recipients, error: recipientsError } = await supabase\r\n    .from('campaign_recipients')\r\n    .select('id, phone_number, name, template_variables')\r\n    .eq('campaign_id', campaign.id)\r\n    .eq('delivery_status', 'queued')\r\n    .limit(batchSize);\r\n\r\n  if (recipientsError) {\r\n    console.error('Error fetching recipients:', recipientsError);\r\n    return new Response(JSON.stringify({ error: 'Failed to fetch recipients' }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  if (!recipients || recipients.length === 0) {\r\n    // No more recipients, mark campaign as completed\r\n    await supabase\r\n      .from('campaigns')\r\n      .update({ status: 'completed', completed_at: new Date().toISOString() })\r\n      .eq('id', campaign.id);\r\n\r\n    await supabase.rpc('log_campaign_action', {\r\n      p_campaign_id: campaign.id,\r\n      p_company_id: campaign.company_id,\r\n      p_action: 'Campaign completed',\r\n      p_action_type: 'completed',\r\n      p_details: { completed_at: new Date().toISOString() },\r\n    });\r\n\r\n    return new Response(JSON.stringify({ success: true, message: 'Campaign completed', processed: 0 }), {\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  // Get Meta access token\r\n  const phoneNumberData = campaign.whatsapp_phone_numbers;\r\n  const accessToken = phoneNumberData?.whatsapp_business_accounts?.access_token_encrypted;\r\n  const phoneNumberId = phoneNumberData?.phone_number_id;\r\n  const template = campaign.whatsapp_templates as WhatsAppTemplate;\r\n\r\n  if (!accessToken || !phoneNumberId || !template) {\r\n    console.error('Missing required data for sending messages');\r\n    return new Response(JSON.stringify({ error: 'Missing WhatsApp configuration' }), {\r\n      status: 400,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n\r\n  // Process each recipient\r\n  const results = await Promise.allSettled(\r\n    recipients.map((recipient: CampaignRecipient) => \r\n      sendWhatsAppMessage(supabase, campaign, recipient, template, phoneNumberId, accessToken)\r\n    )\r\n  );\r\n\r\n  const successCount = results.filter(r => r.status === 'fulfilled' && r.value.success).length;\r\n  const failCount = results.filter(r => r.status === 'rejected' || (r.status === 'fulfilled' && !r.value.success)).length;\r\n\r\n  // Update campaign sent count\r\n  await supabase\r\n    .from('campaigns')\r\n    .update({ sent_count: (campaign.sent_count || 0) + successCount })\r\n    .eq('id', campaign.id);\r\n\r\n  // Check if there are more recipients\r\n  const { count: remainingCount } = await supabase\r\n    .from('campaign_recipients')\r\n    .select('id', { count: 'exact', head: true })\r\n    .eq('campaign_id', campaign.id)\r\n    .eq('delivery_status', 'queued');\r\n\r\n  return new Response(JSON.stringify({ \r\n    success: true, \r\n    processed: recipients.length,\r\n    sent: successCount,\r\n    failed: failCount,\r\n    remaining: remainingCount || 0\r\n  }), {\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\nasync function sendWhatsAppMessage(\r\n  supabase: any, \r\n  campaign: any, \r\n  recipient: CampaignRecipient, \r\n  template: WhatsAppTemplate,\r\n  phoneNumberId: string,\r\n  accessToken: string\r\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\r\n  try {\r\n    // Mark as sending\r\n    await supabase\r\n      .from('campaign_recipients')\r\n      .update({ delivery_status: 'sending' })\r\n      .eq('id', recipient.id);\r\n\r\n    // Build template components\r\n    const components: any[] = [];\r\n    \r\n    // Add header component if exists\r\n    if (template.header_type && template.header_type !== 'NONE' && template.header_content) {\r\n      if (template.header_type === 'TEXT') {\r\n        components.push({\r\n          type: 'header',\r\n          parameters: [{ type: 'text', text: template.header_content }]\r\n        });\r\n      }\r\n    }\r\n\r\n    // Add body parameters from template variables\r\n    const bodyParams = Object.values(recipient.template_variables || {}).map(value => ({\r\n      type: 'text',\r\n      text: String(value)\r\n    }));\r\n\r\n    if (bodyParams.length > 0) {\r\n      components.push({\r\n        type: 'body',\r\n        parameters: bodyParams\r\n      });\r\n    }\r\n\r\n    // Build the request payload\r\n    const payload = {\r\n      messaging_product: 'whatsapp',\r\n      recipient_type: 'individual',\r\n      to: recipient.phone_number.replace(/[^0-9]/g, ''),\r\n      type: 'template',\r\n      template: {\r\n        name: template.template_name,\r\n        language: { code: template.language },\r\n        components: components.length > 0 ? components : undefined\r\n      }\r\n    };\r\n\r\n    // Send message via Meta API\r\n    const response = await fetch(\r\n      `https://graph.facebook.com/v18.0/${phoneNumberId}/messages`,\r\n      {\r\n        method: 'POST',\r\n        headers: {\r\n          'Authorization': `Bearer ${accessToken}`,\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify(payload),\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n\r\n    if (!response.ok) {\r\n      const errorMessage = result.error?.message || 'Failed to send message';\r\n      const errorCode = result.error?.code?.toString() || 'unknown';\r\n      \r\n      // Update recipient status to failed\r\n      await supabase\r\n        .from('campaign_recipients')\r\n        .update({ \r\n          delivery_status: 'failed',\r\n          error_message: errorMessage,\r\n          error_code: errorCode,\r\n          failed_at: new Date().toISOString(),\r\n          retry_count: (recipient as any).retry_count + 1\r\n        })\r\n        .eq('id', recipient.id);\r\n\r\n      // Log the failure\r\n      await supabase.rpc('log_campaign_action', {\r\n        p_campaign_id: campaign.id,\r\n        p_company_id: campaign.company_id,\r\n        p_action: `Message failed: ${errorMessage}`,\r\n        p_action_type: 'failed',\r\n        p_details: { error: result.error, phone: recipient.phone_number },\r\n        p_recipient_id: recipient.id,\r\n      });\r\n\r\n      return { success: false, error: errorMessage };\r\n    }\r\n\r\n    const messageId = result.messages?.[0]?.id;\r\n\r\n    // Update recipient status to sent\r\n    await supabase\r\n      .from('campaign_recipients')\r\n      .update({ \r\n        delivery_status: 'sent',\r\n        meta_message_id: messageId,\r\n        sent_at: new Date().toISOString()\r\n      })\r\n      .eq('id', recipient.id);\r\n\r\n    // Log successful send\r\n    await supabase.rpc('log_campaign_action', {\r\n      p_campaign_id: campaign.id,\r\n      p_company_id: campaign.company_id,\r\n      p_action: 'Message sent',\r\n      p_action_type: 'sent',\r\n      p_details: { message_id: messageId, phone: recipient.phone_number },\r\n      p_recipient_id: recipient.id,\r\n    });\r\n\r\n    return { success: true, messageId };\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : 'Unknown error';\r\n    console.error(`Error sending to ${recipient.phone_number}:`, error);\r\n    \r\n    await supabase\r\n      .from('campaign_recipients')\r\n      .update({ \r\n        delivery_status: 'failed',\r\n        error_message: message,\r\n        failed_at: new Date().toISOString()\r\n      })\r\n      .eq('id', recipient.id);\r\n\r\n    return { success: false, error: message };\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\whatsapp-embedded-signup\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":146,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":146,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5384,5387],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5384,5387],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":315,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":315,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11556,11559],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11556,11559],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';\r\n\r\nconst corsHeaders = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',\r\n};\r\n\r\nconst META_APP_ID = Deno.env.get('META_APP_ID');\r\nconst META_APP_SECRET = Deno.env.get('META_APP_SECRET');\r\nconst SUPABASE_URL = Deno.env.get('SUPABASE_URL')!;\r\nconst SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;\r\n\r\nDeno.serve(async (req) => {\r\n  const url = new URL(req.url);\r\n  let action = url.searchParams.get('action');\r\n\r\n  if (req.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);\r\n\r\n  try {\r\n    // Parse body for POST requests\r\n    let body: Record<string, unknown> = {};\r\n    if (req.method === 'POST') {\r\n      try {\r\n        body = await req.json();\r\n        // Allow action to be specified in body if not in query params\r\n        if (!action && body.action) {\r\n          action = body.action as string;\r\n        }\r\n      } catch {\r\n        // Body might be empty for some requests\r\n      }\r\n    }\r\n\r\n    // Default action for POST without action specified is 'init'\r\n    if (!action && req.method === 'POST') {\r\n      action = 'init';\r\n    }\r\n\r\n    console.log(`[whatsapp-embedded-signup] Action: ${action}, Method: ${req.method}`);\r\n\r\n    // Initialize embedded signup - get OAuth URL\r\n    if (action === 'init') {\r\n      const company_id = body.company_id as string;\r\n      const redirect_uri = body.redirect_uri as string;\r\n\r\n      if (!company_id || !redirect_uri) {\r\n        return new Response(JSON.stringify({ error: 'Missing required parameters' }), {\r\n          status: 400,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      const state = btoa(JSON.stringify({ company_id, redirect_uri }));\r\n      \r\n      // WhatsApp Business API scopes\r\n      const scopes = [\r\n        'whatsapp_business_management',\r\n        'whatsapp_business_messaging',\r\n        'business_management'\r\n      ].join(',');\r\n\r\n      const callbackUrl = `${SUPABASE_URL}/functions/v1/whatsapp-embedded-signup?action=callback`;\r\n      \r\n      const authUrl = `https://www.facebook.com/v18.0/dialog/oauth?` +\r\n        `client_id=${META_APP_ID}` +\r\n        `&redirect_uri=${encodeURIComponent(callbackUrl)}` +\r\n        `&state=${encodeURIComponent(state)}` +\r\n        `&scope=${encodeURIComponent(scopes)}` +\r\n        `&response_type=code` +\r\n        `&extras=${encodeURIComponent(JSON.stringify({ setup: { channel: 'whatsapp' } }))}`;\r\n\r\n      console.log('Generated WhatsApp embedded signup URL');\r\n\r\n      return new Response(JSON.stringify({ authUrl }), {\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      });\r\n    }\r\n\r\n    // Handle OAuth callback\r\n    if (action === 'callback') {\r\n      const code = url.searchParams.get('code');\r\n      const stateParam = url.searchParams.get('state');\r\n      const error = url.searchParams.get('error');\r\n\r\n      if (error) {\r\n        console.error('OAuth error:', error);\r\n        const state = JSON.parse(atob(stateParam || ''));\r\n        return Response.redirect(`${state.redirect_uri}?error=${encodeURIComponent(error)}`);\r\n      }\r\n\r\n      if (!code || !stateParam) {\r\n        return new Response('Missing code or state', { status: 400 });\r\n      }\r\n\r\n      const state = JSON.parse(atob(stateParam));\r\n      const { company_id, redirect_uri } = state;\r\n\r\n      const callbackUrl = `${SUPABASE_URL}/functions/v1/whatsapp-embedded-signup?action=callback`;\r\n\r\n      // Exchange code for access token\r\n      const tokenResponse = await fetch(\r\n        `https://graph.facebook.com/v18.0/oauth/access_token?` +\r\n        `client_id=${META_APP_ID}` +\r\n        `&client_secret=${META_APP_SECRET}` +\r\n        `&redirect_uri=${encodeURIComponent(callbackUrl)}` +\r\n        `&code=${code}`\r\n      );\r\n\r\n      const tokenData = await tokenResponse.json();\r\n\r\n      if (tokenData.error) {\r\n        console.error('Token exchange error:', tokenData.error);\r\n        return Response.redirect(`${redirect_uri}?error=${encodeURIComponent(tokenData.error.message)}`);\r\n      }\r\n\r\n      // Get long-lived token\r\n      const longLivedResponse = await fetch(\r\n        `https://graph.facebook.com/v18.0/oauth/access_token?` +\r\n        `grant_type=fb_exchange_token` +\r\n        `&client_id=${META_APP_ID}` +\r\n        `&client_secret=${META_APP_SECRET}` +\r\n        `&fb_exchange_token=${tokenData.access_token}`\r\n      );\r\n\r\n      const longLivedData = await longLivedResponse.json();\r\n      const accessToken = longLivedData.access_token || tokenData.access_token;\r\n\r\n      // Get WhatsApp Business Accounts\r\n      const wabaResponse = await fetch(\r\n        `https://graph.facebook.com/v18.0/debug_token?input_token=${accessToken}&access_token=${META_APP_ID}|${META_APP_SECRET}`\r\n      );\r\n      const wabaDebug = await wabaResponse.json();\r\n      \r\n      // Get the user's business accounts with WhatsApp\r\n      const businessResponse = await fetch(\r\n        `https://graph.facebook.com/v18.0/me/businesses?access_token=${accessToken}`\r\n      );\r\n      const businessData = await businessResponse.json();\r\n\r\n      // Get WhatsApp Business Account and Phone Numbers\r\n      let wabaId = '';\r\n      let phoneNumbers: any[] = [];\r\n\r\n      for (const business of (businessData.data || [])) {\r\n        const waResponse = await fetch(\r\n          `https://graph.facebook.com/v18.0/${business.id}/owned_whatsapp_business_accounts?access_token=${accessToken}`\r\n        );\r\n        const waData = await waResponse.json();\r\n\r\n        if (waData.data && waData.data.length > 0) {\r\n          wabaId = waData.data[0].id;\r\n          \r\n          // Get phone numbers for this WABA\r\n          const phonesResponse = await fetch(\r\n            `https://graph.facebook.com/v18.0/${wabaId}/phone_numbers?access_token=${accessToken}`\r\n          );\r\n          const phonesData = await phonesResponse.json();\r\n          phoneNumbers = phonesData.data || [];\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (!wabaId || phoneNumbers.length === 0) {\r\n        console.error('No WhatsApp Business Account or phone numbers found');\r\n        return Response.redirect(`${redirect_uri}?error=${encodeURIComponent('No WhatsApp Business number found. Please complete the setup in Meta Business Suite first.')}`);\r\n      }\r\n\r\n      const phoneNumber = phoneNumbers[0];\r\n\r\n      // Save the connection to marketing_connections\r\n      const { data: connection, error: insertError } = await supabase\r\n        .from('marketing_connections')\r\n        .insert({\r\n          company_id,\r\n          channel: 'whatsapp',\r\n          provider: 'meta',\r\n          display_name: phoneNumber.verified_name || phoneNumber.display_phone_number,\r\n          identifier: phoneNumber.display_phone_number,\r\n          status: 'connected',\r\n          verified: phoneNumber.quality_rating !== 'UNKNOWN',\r\n          credentials: {\r\n            accessToken,\r\n            phoneNumberId: phoneNumber.id,\r\n            businessId: wabaId,\r\n            qualityRating: phoneNumber.quality_rating,\r\n            verifiedName: phoneNumber.verified_name,\r\n          },\r\n          last_sync: new Date().toISOString(),\r\n          health_status: 'healthy',\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (insertError) {\r\n        console.error('Failed to save connection:', insertError);\r\n        return Response.redirect(`${redirect_uri}?error=${encodeURIComponent('Failed to save connection')}`);\r\n      }\r\n\r\n      console.log('WhatsApp connection created:', connection.id);\r\n\r\n      return Response.redirect(`${redirect_uri}?success=true&connection_id=${connection.id}`);\r\n    }\r\n\r\n    // Verify connection / test sending\r\n    if (action === 'test') {\r\n      const connection_id = body.connection_id as string;\r\n\r\n      const { data: connection, error: connError } = await supabase\r\n        .from('marketing_connections')\r\n        .select('*')\r\n        .eq('id', connection_id)\r\n        .single();\r\n\r\n      if (connError || !connection) {\r\n        return new Response(JSON.stringify({ error: 'Connection not found' }), {\r\n          status: 404,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      const { accessToken, phoneNumberId } = connection.credentials || {};\r\n\r\n      if (!accessToken || !phoneNumberId) {\r\n        return new Response(JSON.stringify({ success: false, error: 'Missing credentials' }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      // Verify the phone number status\r\n      const response = await fetch(\r\n        `https://graph.facebook.com/v18.0/${phoneNumberId}?access_token=${accessToken}&fields=verified_name,quality_rating,display_phone_number`\r\n      );\r\n\r\n      const result = await response.json();\r\n\r\n      if (result.error) {\r\n        await supabase\r\n          .from('marketing_connections')\r\n          .update({ \r\n            status: 'error', \r\n            health_status: 'unhealthy',\r\n            last_health_check: new Date().toISOString() \r\n          })\r\n          .eq('id', connection_id);\r\n\r\n        return new Response(JSON.stringify({ success: false, error: result.error.message }), {\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      // Update connection with latest info\r\n      await supabase\r\n        .from('marketing_connections')\r\n        .update({ \r\n          status: 'connected',\r\n          health_status: 'healthy',\r\n          verified: true,\r\n          last_health_check: new Date().toISOString(),\r\n          last_sync: new Date().toISOString(),\r\n          credentials: {\r\n            ...connection.credentials,\r\n            qualityRating: result.quality_rating,\r\n            verifiedName: result.verified_name,\r\n          }\r\n        })\r\n        .eq('id', connection_id);\r\n\r\n      return new Response(JSON.stringify({ \r\n        success: true, \r\n        phone_number: result.display_phone_number,\r\n        verified_name: result.verified_name,\r\n        quality_rating: result.quality_rating \r\n      }), {\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      });\r\n    }\r\n\r\n    // Get templates from the WABA\r\n    if (action === 'get_templates') {\r\n      const connection_id = body.connection_id as string;\r\n\r\n      const { data: connection, error: connError } = await supabase\r\n        .from('marketing_connections')\r\n        .select('*')\r\n        .eq('id', connection_id)\r\n        .single();\r\n\r\n      if (connError || !connection) {\r\n        return new Response(JSON.stringify({ error: 'Connection not found' }), {\r\n          status: 404,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      const { accessToken, businessId } = connection.credentials || {};\r\n\r\n      const response = await fetch(\r\n        `https://graph.facebook.com/v18.0/${businessId}/message_templates?access_token=${accessToken}&fields=name,language,status,category,components`\r\n      );\r\n\r\n      const result = await response.json();\r\n\r\n      if (result.error) {\r\n        return new Response(JSON.stringify({ error: result.error.message }), {\r\n          status: 400,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      // Filter to only approved templates\r\n      const templates = (result.data || []).filter((t: any) => t.status === 'APPROVED');\r\n\r\n      return new Response(JSON.stringify({ templates }), {\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      });\r\n    }\r\n\r\n    return new Response(JSON.stringify({ error: 'Invalid action' }), {\r\n      status: 400,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('WhatsApp embedded signup error:', error);\r\n    return new Response(JSON.stringify({ error: error instanceof Error ? error.message : 'Unknown error' }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\supabase\\functions\\whatsapp-webhook\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":83,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":83,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2842,2845],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2842,2845],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":83,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":83,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2855,2858],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2855,2858],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":105,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":105,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3570,3573],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3570,3573],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":174,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":174,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5765,5768],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5765,5768],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":174,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":174,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5779,5782],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5779,5782],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":174,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":174,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5794,5797],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5794,5797],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":182,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":182,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6094,6097],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6094,6097],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';\r\n\r\nconst corsHeaders = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',\r\n};\r\n\r\nDeno.serve(async (req) => {\r\n  // Handle webhook verification (GET request from Meta)\r\n  if (req.method === 'GET') {\r\n    const url = new URL(req.url);\r\n    const mode = url.searchParams.get('hub.mode');\r\n    const token = url.searchParams.get('hub.verify_token');\r\n    const challenge = url.searchParams.get('hub.challenge');\r\n\r\n    const verifyToken = Deno.env.get('META_WEBHOOK_VERIFY_TOKEN') || 'onelinker_whatsapp_webhook';\r\n\r\n    if (mode === 'subscribe' && token === verifyToken) {\r\n      console.log('Webhook verified successfully');\r\n      return new Response(challenge, { status: 200 });\r\n    } else {\r\n      console.error('Webhook verification failed');\r\n      return new Response('Forbidden', { status: 403 });\r\n    }\r\n  }\r\n\r\n  if (req.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  if (req.method !== 'POST') {\r\n    return new Response('Method not allowed', { status: 405 });\r\n  }\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;\r\n    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;\r\n    const supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n    const payload = await req.json();\r\n    console.log('Webhook received:', JSON.stringify(payload, null, 2));\r\n\r\n    // Process webhook entries\r\n    const entries = payload.entry || [];\r\n    \r\n    for (const entry of entries) {\r\n      const changes = entry.changes || [];\r\n      \r\n      for (const change of changes) {\r\n        if (change.field === 'messages') {\r\n          const value = change.value;\r\n          \r\n          // Process message status updates\r\n          if (value.statuses) {\r\n            for (const status of value.statuses) {\r\n              await processStatusUpdate(supabase, status);\r\n            }\r\n          }\r\n          \r\n          // Process incoming messages (for future inbox features)\r\n          if (value.messages) {\r\n            for (const message of value.messages) {\r\n              await processIncomingMessage(supabase, message, value.contacts);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return new Response(JSON.stringify({ success: true }), {\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  } catch (error) {\r\n    console.error('Webhook processing error:', error);\r\n    const message = error instanceof Error ? error.message : 'Unknown error';\r\n    return new Response(JSON.stringify({ error: message }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n    });\r\n  }\r\n});\r\n\r\nasync function processStatusUpdate(supabase: any, status: any) {\r\n  const messageId = status.id;\r\n  const statusType = status.status; // sent, delivered, read, failed\r\n  const timestamp = status.timestamp;\r\n  const recipientPhone = status.recipient_id;\r\n\r\n  console.log(`Processing status update: ${messageId} -> ${statusType}`);\r\n\r\n  // Find the recipient by meta_message_id\r\n  const { data: recipient, error } = await supabase\r\n    .from('campaign_recipients')\r\n    .select('id, campaign_id, company_id')\r\n    .eq('meta_message_id', messageId)\r\n    .single();\r\n\r\n  if (error || !recipient) {\r\n    console.log(`Recipient not found for message ${messageId}`);\r\n    return;\r\n  }\r\n\r\n  // Map Meta status to our status\r\n  let deliveryStatus = statusType;\r\n  const updateData: any = { updated_at: new Date().toISOString() };\r\n\r\n  switch (statusType) {\r\n    case 'sent':\r\n      deliveryStatus = 'sent';\r\n      updateData.sent_at = new Date(parseInt(timestamp) * 1000).toISOString();\r\n      break;\r\n    case 'delivered':\r\n      deliveryStatus = 'delivered';\r\n      updateData.delivered_at = new Date(parseInt(timestamp) * 1000).toISOString();\r\n      break;\r\n    case 'read':\r\n      deliveryStatus = 'read';\r\n      updateData.read_at = new Date(parseInt(timestamp) * 1000).toISOString();\r\n      break;\r\n    case 'failed':\r\n      deliveryStatus = 'failed';\r\n      updateData.failed_at = new Date(parseInt(timestamp) * 1000).toISOString();\r\n      if (status.errors?.[0]) {\r\n        updateData.error_message = status.errors[0].message;\r\n        updateData.error_code = status.errors[0].code?.toString();\r\n      }\r\n      break;\r\n  }\r\n\r\n  updateData.delivery_status = deliveryStatus;\r\n\r\n  // Update recipient status\r\n  await supabase\r\n    .from('campaign_recipients')\r\n    .update(updateData)\r\n    .eq('id', recipient.id);\r\n\r\n  // Log the status update\r\n  await supabase.rpc('log_campaign_action', {\r\n    p_campaign_id: recipient.campaign_id,\r\n    p_company_id: recipient.company_id,\r\n    p_action: `Message ${deliveryStatus}`,\r\n    p_action_type: deliveryStatus,\r\n    p_details: { \r\n      message_id: messageId, \r\n      timestamp,\r\n      phone: recipientPhone,\r\n      errors: status.errors \r\n    },\r\n    p_recipient_id: recipient.id,\r\n  });\r\n\r\n  // Update campaign counts based on status\r\n  if (deliveryStatus === 'delivered') {\r\n    await supabase.rpc('increment_campaign_count', {\r\n      p_campaign_id: recipient.campaign_id,\r\n      p_field: 'delivered_count'\r\n    });\r\n  } else if (deliveryStatus === 'read') {\r\n    await supabase.rpc('increment_campaign_count', {\r\n      p_campaign_id: recipient.campaign_id,\r\n      p_field: 'opened_count'\r\n    });\r\n  } else if (deliveryStatus === 'failed') {\r\n    await supabase.rpc('increment_campaign_count', {\r\n      p_campaign_id: recipient.campaign_id,\r\n      p_field: 'failed_count'\r\n    });\r\n  }\r\n\r\n  console.log(`Updated recipient ${recipient.id} to status ${deliveryStatus}`);\r\n}\r\n\r\nasync function processIncomingMessage(supabase: any, message: any, contacts: any[]) {\r\n  console.log('Incoming message:', message);\r\n  \r\n  // This can be extended to handle incoming WhatsApp messages\r\n  // For now, we just log them\r\n  const from = message.from;\r\n  const messageType = message.type;\r\n  const timestamp = message.timestamp;\r\n  const contact = contacts?.find((c: any) => c.wa_id === from);\r\n\r\n  // Find lead by phone number\r\n  const normalizedPhone = from.replace(/[^0-9]/g, '');\r\n  const { data: lead } = await supabase\r\n    .from('leads')\r\n    .select('id, company_id')\r\n    .or(`phone.eq.${normalizedPhone},normalized_phone.eq.${normalizedPhone}`)\r\n    .single();\r\n\r\n  if (lead) {\r\n    // Log as lead activity\r\n    await supabase.from('lead_activities').insert({\r\n      lead_id: lead.id,\r\n      company_id: lead.company_id,\r\n      type: 'whatsapp_received',\r\n      title: 'WhatsApp Message Received',\r\n      description: messageType === 'text' ? message.text?.body : `Received ${messageType} message`,\r\n      agent_name: 'System',\r\n      created_at: new Date(parseInt(timestamp) * 1000).toISOString()\r\n    });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\tailwind.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\translate-pages.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\translate-pages.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\onelinker-crm\\CRM\\vite.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]